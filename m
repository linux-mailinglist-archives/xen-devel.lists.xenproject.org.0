Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id F1F62124A05
	for <lists+xen-devel@lfdr.de>; Wed, 18 Dec 2019 15:46:12 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ihaXi-0004c1-RQ; Wed, 18 Dec 2019 14:43:14 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=8BSL=2I=gmail.com=wei.liu.xen@srs-us1.protection.inumbo.net>)
 id 1ihaXg-0004b8-Qi
 for xen-devel@lists.xenproject.org; Wed, 18 Dec 2019 14:43:12 +0000
X-Inumbo-ID: a555c682-21a4-11ea-a1e1-bc764e2007e4
Received: from mail-wr1-x441.google.com (unknown [2a00:1450:4864:20::441])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id a555c682-21a4-11ea-a1e1-bc764e2007e4;
 Wed, 18 Dec 2019 14:42:42 +0000 (UTC)
Received: by mail-wr1-x441.google.com with SMTP id j42so2535911wrj.12
 for <xen-devel@lists.xenproject.org>; Wed, 18 Dec 2019 06:42:42 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=sender:from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=xgvjPlMwm29xJ6uZnTs5QusdsP0ROEFMExYoGH+1sMI=;
 b=eRw0xfctu0OTvIglKIo39rP7/4FZy6NVsz1FDtzB/lgtjIXCP1aEffr+5yFOs+HitZ
 cdq5/OhZ2buV2E69qSQ0fxSsNhibp/3W/oju5pZxp2XFI0XQCMGm/ZpEBPHA4jg2DuJo
 VKNiiN37IFQvbwNg5XYU87k7CbsYOX6Hbwham+0PEZtXV0n8YVqgCWd1XU8p6gET9ANm
 yLuRudGuepKvv3VtLIPg6atowxDE9zERFvOtZphX+X9HbZWaa8fWDV9tOE8PfvHrMcEu
 Ojqja6hF3OQjF3mdzgHKdrub7V64jrSg3GV6s7AgMCJO0i3MyjM5nw1LnaFyLA104lO3
 aqPQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:sender:from:to:cc:subject:date:message-id
 :in-reply-to:references:mime-version:content-transfer-encoding;
 bh=xgvjPlMwm29xJ6uZnTs5QusdsP0ROEFMExYoGH+1sMI=;
 b=ulquhfyzZLL35XgwvFay3BhNzrwaC3XFY8bc6Q98fqDdQBSUmIdCkcmJXGfR1yYmWG
 +GEZplp/smPP4chg5wQSPwUhvs3pPpTUTRXbf6pYwwdYGrJdZ/huSzS/VIxSSTiwNtgt
 YiQE5Fq7UNOrBaeKEbmePbbJUWAJSeaXiLV9ERc3LhOJnpa694zJSxAO0oKY2N6Zp51U
 q1t2UiB9A4HZ0GvUf6PmX4KAxEUhzLcR7oE0MkiaRn14uwgkWdfTqeJ80WFLJ7r0yIDQ
 SJSp8cBWA+p591ZyDh9Bwiyl5e8E2GinOb3d/JEWP+yGqwdK7iWIey5S8HXFO4JbdILu
 X4BA==
X-Gm-Message-State: APjAAAUMy8L5CXCG98kEqTjhjl0yEQcmbeZz02EZj7lh9eD2Izcaa8xK
 tzR7uLaxV+3duMYY21w7I0Pk+NT8
X-Google-Smtp-Source: APXvYqyJbwfAymplFqMpaeqZPw149s7ETAp8hGHW+jXe4j29khHnTo6iluuWBtSlMpx157KOforL+A==
X-Received: by 2002:a5d:5283:: with SMTP id c3mr3457407wrv.148.1576680161546; 
 Wed, 18 Dec 2019 06:42:41 -0800 (PST)
Received: from debian.mshome.net (38.163.200.146.dyn.plus.net.
 [146.200.163.38])
 by smtp.gmail.com with ESMTPSA id p17sm2724894wmk.30.2019.12.18.06.42.40
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Wed, 18 Dec 2019 06:42:41 -0800 (PST)
From: Wei Liu <wl@xen.org>
X-Google-Original-From: Wei Liu <liuwe@microsoft.com>
To: Xen Development List <xen-devel@lists.xenproject.org>
Date: Wed, 18 Dec 2019 14:42:33 +0000
Message-Id: <20191218144233.15372-7-liuwe@microsoft.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20191218144233.15372-1-liuwe@microsoft.com>
References: <20191218144233.15372-1-liuwe@microsoft.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2 6/6] x86: implement Hyper-V clock source
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Wei Liu <liuwe@microsoft.com>, Wei Liu <wl@xen.org>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Paul Durrant <pdurrant@amazon.com>,
 Michael Kelley <mikelley@microsoft.com>, Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SW1wbGVtZW50IGEgY2xvY2sgc291cmNlIHVzaW5nIEh5cGVyLVYncyByZWZlcmVuY2UgVFNDIHBh
Z2UuCgpTaWduZWQtb2ZmLWJ5OiBXZWkgTGl1IDxsaXV3ZUBtaWNyb3NvZnQuY29tPgotLS0KdjI6
CjEuIEFkZHJlc3MgSmFuJ3MgY29tbWVudHMuCgpSZWxldmFudCBzcGVjOgoKaHR0cHM6Ly9naXRo
dWIuY29tL01pY3Jvc29mdERvY3MvVmlydHVhbGl6YXRpb24tRG9jdW1lbnRhdGlvbi9yYXcvbGl2
ZS90bGZzL0h5cGVydmlzb3IlMjBUb3AlMjBMZXZlbCUyMEZ1bmN0aW9uYWwlMjBTcGVjaWZpY2F0
aW9uJTIwdjUuMEMucGRmCgpTZWN0aW9uIDEyLjYuCi0tLQogeGVuL2FyY2gveDg2L3RpbWUuYyB8
IDEwMSArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKwogMSBmaWxl
IGNoYW5nZWQsIDEwMSBpbnNlcnRpb25zKCspCgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L3Rp
bWUuYyBiL3hlbi9hcmNoL3g4Ni90aW1lLmMKaW5kZXggMjE2MTY5YTAyNS4uOGI5NmIyZTlhNSAx
MDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L3RpbWUuYworKysgYi94ZW4vYXJjaC94ODYvdGltZS5j
CkBAIC0zMSw2ICszMSw3IEBACiAjaW5jbHVkZSA8YXNtL3Byb2Nlc3Nvci5oPgogI2luY2x1ZGUg
PGFzbS9maXhtYXAuaD4KICNpbmNsdWRlIDxhc20vZ3Vlc3QuaD4KKyNpbmNsdWRlIDxhc20vZ3Vl
c3QvaHlwZXJ2LXRsZnMuaD4KICNpbmNsdWRlIDxhc20vbWMxNDY4MThydGMuaD4KICNpbmNsdWRl
IDxhc20vZGl2NjQuaD4KICNpbmNsdWRlIDxhc20vYWNwaS5oPgpAQCAtNjQ0LDYgKzY0NSwxMDMg
QEAgc3RhdGljIHN0cnVjdCBwbGF0Zm9ybV90aW1lc291cmNlIF9faW5pdGRhdGEgcGx0X3hlbl90
aW1lciA9CiB9OwogI2VuZGlmCiAKKyNpZmRlZiBDT05GSUdfSFlQRVJWX0dVRVNUCisvKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCisg
KiBIWVBFUi1WIFJFRkVSRU5DRSBUU0MKKyAqLworCitzdGF0aWMgc3RydWN0IG1zX2h5cGVydl90
c2NfcGFnZSAqaHlwZXJ2X3RzYzsKK3N0YXRpYyBzdHJ1Y3QgcGFnZV9pbmZvICpoeXBlcnZfdHNj
X3BhZ2U7CisKK3N0YXRpYyBpbnQ2NF90IF9faW5pdCBpbml0X2h5cGVydl90aW1lcihzdHJ1Y3Qg
cGxhdGZvcm1fdGltZXNvdXJjZSAqcHRzKQoreworICAgIHBhZGRyX3QgbWFkZHI7CisgICAgdWlu
dDY0X3QgdHNjX21zciwgZnJlcTsKKworICAgIGlmICggIShtc19oeXBlcnYuZmVhdHVyZXMgJiBI
Vl9NU1JfUkVGRVJFTkNFX1RTQ19BVkFJTEFCTEUpICkKKyAgICAgICAgcmV0dXJuIDA7CisKKyAg
ICBoeXBlcnZfdHNjX3BhZ2UgPSBhbGxvY19kb21oZWFwX3BhZ2UoTlVMTCwgMCk7CisgICAgaWYg
KCAhaHlwZXJ2X3RzY19wYWdlICkKKyAgICAgICAgcmV0dXJuIDA7CisKKyAgICBoeXBlcnZfdHNj
ID0gX19tYXBfZG9tYWluX3BhZ2VfZ2xvYmFsKGh5cGVydl90c2NfcGFnZSk7CisgICAgaWYgKCAh
aHlwZXJ2X3RzYyApCisgICAgeworICAgICAgICBmcmVlX2RvbWhlYXBfcGFnZShoeXBlcnZfdHNj
X3BhZ2UpOworICAgICAgICBoeXBlcnZfdHNjX3BhZ2UgPSBOVUxMOworICAgICAgICByZXR1cm4g
MDsKKyAgICB9CisKKyAgICBtYWRkciA9IHBhZ2VfdG9fbWFkZHIoaHlwZXJ2X3RzY19wYWdlKTsK
KworICAgIC8qCisgICAgICogUGVyIEh5cGVyLVYgVExGUzoKKyAgICAgKiAgIDEuIFJlYWQgZXhp
c3RpbmcgTVNSIHZhbHVlCisgICAgICogICAyLiBQcmVzZXJ2ZSBiaXRzIFsxMToxXQorICAgICAq
ICAgMy4gU2V0IGJpdHMgWzYzOjEyXSB0byBiZSBndWVzdCBwaHlzaWNhbCBhZGRyZXNzIG9mIHRz
YyBwYWdlCisgICAgICogICA0LiBTZXQgZW5hYmxlZCBiaXQgKDApCisgICAgICogICA1LiBXcml0
ZSBiYWNrIG5ldyBNU1IgdmFsdWUKKyAgICAgKi8KKyAgICByZG1zcmwoSFZfWDY0X01TUl9SRUZF
UkVOQ0VfVFNDLCB0c2NfbXNyKTsKKyAgICB0c2NfbXNyICY9IDB4ZmZlVUxMOworICAgIHRzY19t
c3IgfD0gIG1hZGRyIHwgMSAvKiBlbmFibGVkICovOworICAgIHdybXNybChIVl9YNjRfTVNSX1JF
RkVSRU5DRV9UU0MsIHRzY19tc3IpOworCisgICAgLyogR2V0IFRTQyBmcmVxdWVuY3kgZnJvbSBI
eXBlci1WICovCisgICAgcmRtc3JsKEhWX1g2NF9NU1JfVFNDX0ZSRVFVRU5DWSwgZnJlcSk7Cisg
ICAgcHRzLT5mcmVxdWVuY3kgPSBmcmVxOworCisgICAgcmV0dXJuIGZyZXE7Cit9CisKK3N0YXRp
YyBpbmxpbmUgdWludDY0X3QgcmVhZF9oeXBlcnZfdGltZXIodm9pZCkKK3sKKyAgICB1aW50NjRf
dCBzY2FsZSwgb2Zmc2V0LCByZXQsIHRzYzsKKyAgICB1aW50MzJfdCBzZXE7CisgICAgY29uc3Qg
c3RydWN0IG1zX2h5cGVydl90c2NfcGFnZSAqdHNjX3BhZ2UgPSBoeXBlcnZfdHNjOworCisgICAg
ZG8geworICAgICAgICBzZXEgPSB0c2NfcGFnZS0+dHNjX3NlcXVlbmNlOworCisgICAgICAgIC8q
IFNlcSAwIGlzIHNwZWNpYWwuIEl0IG1lYW5zIHRoZSBUU0MgZW5saWdodGVubWVudCBpcyBub3QK
KyAgICAgICAgICogYXZhaWxhYmxlIGF0IHRoZSBtb21lbnQuIFRoZSByZWZlcmVuY2UgdGltZSBj
YW4gb25seSBiZQorICAgICAgICAgKiBvYnRhaW5lZCBmcm9tIHRoZSBSZWZlcmVuY2UgQ291bnRl
ciBNU1IuCisgICAgICAgICAqLworICAgICAgICBpZiAoIHNlcSA9PSAwICkKKyAgICAgICAgewor
ICAgICAgICAgICAgcmRtc3JsKEhWX1g2NF9NU1JfVElNRV9SRUZfQ09VTlQsIHJldCk7CisgICAg
ICAgICAgICByZXR1cm4gcmV0OworICAgICAgICB9CisKKyAgICAgICAgLyogcmR0c2Nfb3JkZXJl
ZCBhbHJlYWR5IGNvbnRhaW5zIGEgbG9hZCBmZW5jZSAqLworICAgICAgICB0c2MgPSByZHRzY19v
cmRlcmVkKCk7CisgICAgICAgIHNjYWxlID0gdHNjX3BhZ2UtPnRzY19zY2FsZTsKKyAgICAgICAg
b2Zmc2V0ID0gdHNjX3BhZ2UtPnRzY19vZmZzZXQ7CisKKyAgICAgICAgc21wX3JtYigpOworCisg
ICAgfSB3aGlsZSAodHNjX3BhZ2UtPnRzY19zZXF1ZW5jZSAhPSBzZXEpOworCisgICAgLyogcmV0
ID0gKCh0c2MgKiBzY2FsZSkgPj4gNjQpICsgb2Zmc2V0OyAqLworICAgIGFzbSAoICJtdWwgJVtz
Y2FsZV07IGFkZCAlW29mZnNldF0sICVbcmV0XSIKKyAgICAgICAgICA6ICIrYSIgKHRzYyksIFty
ZXRdICI9ZCIgKHJldCkKKyAgICAgICAgICA6IFtzY2FsZV0gInJtIiAoc2NhbGUpLCBbb2Zmc2V0
XSAicm0iIChvZmZzZXQpICk7CisKKyAgICByZXR1cm4gcmV0OworfQorCitzdGF0aWMgc3RydWN0
IHBsYXRmb3JtX3RpbWVzb3VyY2UgX19pbml0ZGF0YSBwbHRfaHlwZXJ2X3RpbWVyID0KK3sKKyAg
ICAuaWQgPSAiaHlwZXJ2IiwKKyAgICAubmFtZSA9ICJIWVBFUi1WIFJFRkVSRU5DRSBUU0MiLAor
ICAgIC5yZWFkX2NvdW50ZXIgPSByZWFkX2h5cGVydl90aW1lciwKKyAgICAuaW5pdCA9IGluaXRf
aHlwZXJ2X3RpbWVyLAorICAgIC8qIFNlZSBUU0MgdGltZSBzb3VyY2UgZm9yIHdoeSBjb3VudGVy
X2JpdHMgaXMgc2V0IHRvIDYzICovCisgICAgLmNvdW50ZXJfYml0cyA9IDYzLAorfTsKKyNlbmRp
ZgorCiAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqCiAgKiBHRU5FUklDIFBMQVRGT1JNIFRJTUVSIElORlJBU1RSVUNUVVJFCiAgKi8K
QEAgLTc5Myw2ICs4OTEsOSBAQCBzdGF0aWMgdTY0IF9faW5pdCBpbml0X3BsYXRmb3JtX3RpbWVy
KHZvaWQpCiAgICAgc3RhdGljIHN0cnVjdCBwbGF0Zm9ybV90aW1lc291cmNlICogX19pbml0ZGF0
YSBwbHRfdGltZXJzW10gPSB7CiAjaWZkZWYgQ09ORklHX1hFTl9HVUVTVAogICAgICAgICAmcGx0
X3hlbl90aW1lciwKKyNlbmRpZgorI2lmZGVmIENPTkZJR19IWVBFUlZfR1VFU1QKKyAgICAgICAg
JnBsdF9oeXBlcnZfdGltZXIsCiAjZW5kaWYKICAgICAgICAgJnBsdF9ocGV0LCAmcGx0X3BtdGlt
ZXIsICZwbHRfcGl0CiAgICAgfTsKLS0gCjIuMjAuMQoKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVs
QGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1h
bi9saXN0aW5mby94ZW4tZGV2ZWw=

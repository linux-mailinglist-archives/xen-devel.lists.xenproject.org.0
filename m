Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 938582C462
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:35:59 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZQb-0005et-L5; Tue, 28 May 2019 10:33:57 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZQC-0004oz-GG
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:33:32 +0000
X-Inumbo-ID: 0650a5f4-8134-11e9-9f3b-f7dbe57e22c3
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 0650a5f4-8134-11e9-9f3b-f7dbe57e22c3;
 Tue, 28 May 2019 10:33:26 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 35673B00E;
 Tue, 28 May 2019 10:33:24 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:32:43 +0200
Message-Id: <20190528103313.1343-31-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 30/60] xen: switch from for_each_vcpu() to
 for_each_sched_unit()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlcmUgYXBwcm9wcmlhdGUgc3dpdGNoIGZyb20gZm9yX2VhY2hfdmNwdSgpIHRvIGZvcl9lYWNo
X3NjaGVkX3VuaXQoKQppbiBvcmRlciB0byBwcmVwYXJlIGNvcmUgc2NoZWR1bGluZy4KClNpZ25l
ZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tCiB4ZW4vY29tbW9u
L2RvbWFpbi5jICAgfCAgIDkgKystLS0KIHhlbi9jb21tb24vc2NoZWR1bGUuYyB8IDEwOSArKysr
KysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogMiBmaWxlcyBj
aGFuZ2VkLCA2MCBpbnNlcnRpb25zKCspLCA1OCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94
ZW4vY29tbW9uL2RvbWFpbi5jIGIveGVuL2NvbW1vbi9kb21haW4uYwppbmRleCAyZDM0MjdlYjBm
Li5mNTVmZjA2NTEzIDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL2RvbWFpbi5jCisrKyBiL3hlbi9j
b21tb24vZG9tYWluLmMKQEAgLTUwOSw3ICs1MDksNyBAQCB2b2lkIGRvbWFpbl91cGRhdGVfbm9k
ZV9hZmZpbml0eShzdHJ1Y3QgZG9tYWluICpkKQogICAgIGNwdW1hc2tfdmFyX3QgZG9tX2NwdW1h
c2ssIGRvbV9jcHVtYXNrX3NvZnQ7CiAgICAgY3B1bWFza190ICpkb21fYWZmaW5pdHk7CiAgICAg
Y29uc3QgY3B1bWFza190ICpvbmxpbmU7Ci0gICAgc3RydWN0IHZjcHUgKnY7CisgICAgc3RydWN0
IHNjaGVkX3VuaXQgKnVuaXQ7CiAgICAgdW5zaWduZWQgaW50IGNwdTsKIAogICAgIC8qIERvIHdl
IGhhdmUgdmNwdXMgYWxyZWFkeT8gSWYgbm90LCBubyBuZWVkIHRvIHVwZGF0ZSBub2RlLWFmZmlu
aXR5LiAqLwpAQCAtNTQyLDEyICs1NDIsMTEgQEAgdm9pZCBkb21haW5fdXBkYXRlX25vZGVfYWZm
aW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAgICogYW5kIHRoZSBmdWxsIG1hc2sgb2Yg
d2hlcmUgaXQgd291bGQgcHJlZmVyIHRvIHJ1biAodGhlIHVuaW9uIG9mCiAgICAgICAgICAqIHRo
ZSBzb2Z0IGFmZmluaXR5IG9mIGFsbCBpdHMgdmFyaW91cyB2Y3B1cykuIExldCdzIGJ1aWxkIHRo
ZW0uCiAgICAgICAgICAqLwotICAgICAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgICAg
IGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkKICAgICAgICAgewotICAgICAgICAgICAg
Y3B1bWFza19vcihkb21fY3B1bWFzaywgZG9tX2NwdW1hc2ssCi0gICAgICAgICAgICAgICAgICAg
ICAgIHYtPnNjaGVkX3VuaXQtPmNwdV9oYXJkX2FmZmluaXR5KTsKKyAgICAgICAgICAgIGNwdW1h
c2tfb3IoZG9tX2NwdW1hc2ssIGRvbV9jcHVtYXNrLCB1bml0LT5jcHVfaGFyZF9hZmZpbml0eSk7
CiAgICAgICAgICAgICBjcHVtYXNrX29yKGRvbV9jcHVtYXNrX3NvZnQsIGRvbV9jcHVtYXNrX3Nv
ZnQsCi0gICAgICAgICAgICAgICAgICAgICAgIHYtPnNjaGVkX3VuaXQtPmNwdV9zb2Z0X2FmZmlu
aXR5KTsKKyAgICAgICAgICAgICAgICAgICAgICAgdW5pdC0+Y3B1X3NvZnRfYWZmaW5pdHkpOwog
ICAgICAgICB9CiAgICAgICAgIC8qIEZpbHRlciBvdXQgbm9uLW9ubGluZSBjcHVzICovCiAgICAg
ICAgIGNwdW1hc2tfYW5kKGRvbV9jcHVtYXNrLCBkb21fY3B1bWFzaywgb25saW5lKTsKZGlmZiAt
LWdpdCBhL3hlbi9jb21tb24vc2NoZWR1bGUuYyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwppbmRl
eCAyNjY5MzJmZTI1Li42M2M5YzBhOGZiIDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkdWxl
LmMKKysrIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCkBAIC00MzMsMTYgKzQzMywxNyBAQCBzdGF0
aWMgdm9pZCBzY2hlZF9tb3ZlX2lycXMoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiBpbnQgc2No
ZWRfbW92ZV9kb21haW4oc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wgKmMpCiB7CiAg
ICAgc3RydWN0IHZjcHUgKnY7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAgICAgdW5z
aWduZWQgaW50IG5ld19wOwotICAgIHZvaWQgKip2Y3B1X3ByaXY7CisgICAgdm9pZCAqKnVuaXRf
cHJpdjsKICAgICB2b2lkICpkb21kYXRhOwotICAgIHZvaWQgKnZjcHVkYXRhOworICAgIHZvaWQg
KnVuaXRkYXRhOwogICAgIHN0cnVjdCBzY2hlZHVsZXIgKm9sZF9vcHM7CiAgICAgdm9pZCAqb2xk
X2RvbWRhdGE7CiAKLSAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgZm9yX2VhY2hfc2No
ZWRfdW5pdCAoIGQsIHVuaXQgKQogICAgIHsKLSAgICAgICAgaWYgKCB2LT5zY2hlZF91bml0LT5h
ZmZpbml0eV9icm9rZW4gKQorICAgICAgICBpZiAoIHVuaXQtPmFmZmluaXR5X2Jyb2tlbiApCiAg
ICAgICAgICAgICByZXR1cm4gLUVCVVNZOwogICAgIH0KIApAQCAtNDUwLDIyICs0NTEsMjEgQEAg
aW50IHNjaGVkX21vdmVfZG9tYWluKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpj
KQogICAgIGlmICggSVNfRVJSKGRvbWRhdGEpICkKICAgICAgICAgcmV0dXJuIFBUUl9FUlIoZG9t
ZGF0YSk7CiAKLSAgICB2Y3B1X3ByaXYgPSB4emFsbG9jX2FycmF5KHZvaWQgKiwgZC0+bWF4X3Zj
cHVzKTsKLSAgICBpZiAoIHZjcHVfcHJpdiA9PSBOVUxMICkKKyAgICB1bml0X3ByaXYgPSB4emFs
bG9jX2FycmF5KHZvaWQgKiwgZC0+bWF4X3ZjcHVzKTsKKyAgICBpZiAoIHVuaXRfcHJpdiA9PSBO
VUxMICkKICAgICB7CiAgICAgICAgIHNjaGVkX2ZyZWVfZG9tZGF0YShjLT5zY2hlZCwgZG9tZGF0
YSk7CiAgICAgICAgIHJldHVybiAtRU5PTUVNOwogICAgIH0KIAotICAgIGZvcl9lYWNoX3ZjcHUg
KCBkLCB2ICkKKyAgICBmb3JfZWFjaF9zY2hlZF91bml0ICggZCwgdW5pdCApCiAgICAgewotICAg
ICAgICB2Y3B1X3ByaXZbdi0+dmNwdV9pZF0gPSBzY2hlZF9hbGxvY192ZGF0YShjLT5zY2hlZCwg
di0+c2NoZWRfdW5pdCwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgZG9tZGF0YSk7Ci0gICAgICAgIGlmICggdmNwdV9wcml2W3YtPnZjcHVfaWRdID09
IE5VTEwgKQorICAgICAgICB1bml0X3ByaXZbdW5pdC0+dW5pdF9pZF0gPSBzY2hlZF9hbGxvY192
ZGF0YShjLT5zY2hlZCwgdW5pdCwgZG9tZGF0YSk7CisgICAgICAgIGlmICggdW5pdF9wcml2W3Vu
aXQtPnVuaXRfaWRdID09IE5VTEwgKQogICAgICAgICB7Ci0gICAgICAgICAgICBmb3JfZWFjaF92
Y3B1ICggZCwgdiApCi0gICAgICAgICAgICAgICAgeGZyZWUodmNwdV9wcml2W3YtPnZjcHVfaWRd
KTsKLSAgICAgICAgICAgIHhmcmVlKHZjcHVfcHJpdik7CisgICAgICAgICAgICBmb3JfZWFjaF9z
Y2hlZF91bml0ICggZCwgdW5pdCApCisgICAgICAgICAgICAgICAgeGZyZWUodW5pdF9wcml2W3Vu
aXQtPnVuaXRfaWRdKTsKKyAgICAgICAgICAgIHhmcmVlKHVuaXRfcHJpdik7CiAgICAgICAgICAg
ICBzY2hlZF9mcmVlX2RvbWRhdGEoYy0+c2NoZWQsIGRvbWRhdGEpOwogICAgICAgICAgICAgcmV0
dXJuIC1FTk9NRU07CiAgICAgICAgIH0KQEAgLTQ3NiwzMCArNDc2LDM1IEBAIGludCBzY2hlZF9t
b3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICBvbGRf
b3BzID0gZG9tX3NjaGVkdWxlcihkKTsKICAgICBvbGRfZG9tZGF0YSA9IGQtPnNjaGVkX3ByaXY7
CiAKLSAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgZm9yX2VhY2hfc2NoZWRfdW5pdCAo
IGQsIHVuaXQgKQogICAgIHsKLSAgICAgICAgc2NoZWRfcmVtb3ZlX3VuaXQob2xkX29wcywgdi0+
c2NoZWRfdW5pdCk7CisgICAgICAgIHNjaGVkX3JlbW92ZV91bml0KG9sZF9vcHMsIHVuaXQpOwog
ICAgIH0KIAogICAgIGQtPmNwdXBvb2wgPSBjOwogICAgIGQtPnNjaGVkX3ByaXYgPSBkb21kYXRh
OwogCiAgICAgbmV3X3AgPSBjcHVtYXNrX2ZpcnN0KGMtPmNwdV92YWxpZCk7Ci0gICAgZm9yX2Vh
Y2hfdmNwdSAoIGQsIHYgKQorICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkKICAg
ICB7CiAgICAgICAgIHNwaW5sb2NrX3QgKmxvY2s7CisgICAgICAgIHVuc2lnbmVkIGludCB1bml0
X3AgPSBuZXdfcDsKIAotICAgICAgICB2Y3B1ZGF0YSA9IHYtPnNjaGVkX3VuaXQtPnByaXY7Cisg
ICAgICAgIHVuaXRkYXRhID0gdW5pdC0+cHJpdjsKIAotICAgICAgICBtaWdyYXRlX3RpbWVyKCZ2
LT5wZXJpb2RpY190aW1lciwgbmV3X3ApOwotICAgICAgICBtaWdyYXRlX3RpbWVyKCZ2LT5zaW5n
bGVzaG90X3RpbWVyLCBuZXdfcCk7Ci0gICAgICAgIG1pZ3JhdGVfdGltZXIoJnYtPnBvbGxfdGlt
ZXIsIG5ld19wKTsKKyAgICAgICAgZm9yX2VhY2hfc2NoZWRfdW5pdF92Y3B1ICggdW5pdCwgdiAp
CisgICAgICAgIHsKKyAgICAgICAgICAgIG1pZ3JhdGVfdGltZXIoJnYtPnBlcmlvZGljX3RpbWVy
LCBuZXdfcCk7CisgICAgICAgICAgICBtaWdyYXRlX3RpbWVyKCZ2LT5zaW5nbGVzaG90X3RpbWVy
LCBuZXdfcCk7CisgICAgICAgICAgICBtaWdyYXRlX3RpbWVyKCZ2LT5wb2xsX3RpbWVyLCBuZXdf
cCk7CisgICAgICAgICAgICBuZXdfcCA9IGNwdW1hc2tfY3ljbGUobmV3X3AsIGMtPmNwdV92YWxp
ZCk7CisgICAgICAgIH0KIAotICAgICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2NrX2lycSh2
LT5zY2hlZF91bml0KTsKKyAgICAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5p
dCk7CiAKLSAgICAgICAgc2NoZWRfc2V0X2FmZmluaXR5KHYsICZjcHVtYXNrX2FsbCwgJmNwdW1h
c2tfYWxsKTsKKyAgICAgICAgc2NoZWRfc2V0X2FmZmluaXR5KHVuaXQtPnZjcHUsICZjcHVtYXNr
X2FsbCwgJmNwdW1hc2tfYWxsKTsKIAotICAgICAgICBzY2hlZF9zZXRfcmVzKHYtPnNjaGVkX3Vu
aXQsIGdldF9zY2hlZF9yZXMobmV3X3ApKTsKKyAgICAgICAgc2NoZWRfc2V0X3Jlcyh1bml0LCBn
ZXRfc2NoZWRfcmVzKHVuaXRfcCkpOwogICAgICAgICAvKgogICAgICAgICAgKiBXaXRoIHYtPnBy
b2Nlc3NvciBtb2RpZmllZCB3ZSBtdXN0IG5vdAogICAgICAgICAgKiAtIG1ha2UgYW55IGZ1cnRo
ZXIgY2hhbmdlcyBhc3N1bWluZyB3ZSBob2xkIHRoZSBzY2hlZHVsZXIgbG9jaywKQEAgLTUwNywx
NSArNTEyLDEzIEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1
Y3QgY3B1cG9vbCAqYykKICAgICAgICAgICovCiAgICAgICAgIHNwaW5fdW5sb2NrX2lycShsb2Nr
KTsKIAotICAgICAgICB2LT5zY2hlZF91bml0LT5wcml2ID0gdmNwdV9wcml2W3YtPnZjcHVfaWRd
OworICAgICAgICB1bml0LT5wcml2ID0gdW5pdF9wcml2W3VuaXQtPnVuaXRfaWRdOwogICAgICAg
ICBpZiAoICFkLT5pc19keWluZyApCi0gICAgICAgICAgICBzY2hlZF9tb3ZlX2lycXModi0+c2No
ZWRfdW5pdCk7Ci0KLSAgICAgICAgbmV3X3AgPSBjcHVtYXNrX2N5Y2xlKG5ld19wLCBjLT5jcHVf
dmFsaWQpOworICAgICAgICAgICAgc2NoZWRfbW92ZV9pcnFzKHVuaXQpOwogCi0gICAgICAgIHNj
aGVkX2luc2VydF91bml0KGMtPnNjaGVkLCB2LT5zY2hlZF91bml0KTsKKyAgICAgICAgc2NoZWRf
aW5zZXJ0X3VuaXQoYy0+c2NoZWQsIHVuaXQpOwogCi0gICAgICAgIHNjaGVkX2ZyZWVfdmRhdGEo
b2xkX29wcywgdmNwdWRhdGEpOworICAgICAgICBzY2hlZF9mcmVlX3ZkYXRhKG9sZF9vcHMsIHVu
aXRkYXRhKTsKICAgICB9CiAKICAgICBkb21haW5fdXBkYXRlX25vZGVfYWZmaW5pdHkoZCk7CkBA
IC01MjQsNyArNTI3LDcgQEAgaW50IHNjaGVkX21vdmVfZG9tYWluKHN0cnVjdCBkb21haW4gKmQs
IHN0cnVjdCBjcHVwb29sICpjKQogCiAgICAgc2NoZWRfZnJlZV9kb21kYXRhKG9sZF9vcHMsIG9s
ZF9kb21kYXRhKTsKIAotICAgIHhmcmVlKHZjcHVfcHJpdik7CisgICAgeGZyZWUodW5pdF9wcml2
KTsKIAogICAgIHJldHVybiAwOwogfQpAQCAtODI5LDE1ICs4MzIsMTQgQEAgdm9pZCB2Y3B1X2Zv
cmNlX3Jlc2NoZWR1bGUoc3RydWN0IHZjcHUgKnYpCiB2b2lkIHJlc3RvcmVfdmNwdV9hZmZpbml0
eShzdHJ1Y3QgZG9tYWluICpkKQogewogICAgIHVuc2lnbmVkIGludCBjcHUgPSBzbXBfcHJvY2Vz
c29yX2lkKCk7Ci0gICAgc3RydWN0IHZjcHUgKnY7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVu
aXQ7CiAKICAgICBBU1NFUlQoc3lzdGVtX3N0YXRlID09IFNZU19TVEFURV9yZXN1bWUpOwogCi0g
ICAgZm9yX2VhY2hfdmNwdSAoIGQsIHYgKQorICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1
bml0ICkKICAgICB7CiAgICAgICAgIHNwaW5sb2NrX3QgKmxvY2s7Ci0gICAgICAgIHVuc2lnbmVk
IGludCBvbGRfY3B1ID0gdi0+cHJvY2Vzc29yOwotICAgICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAq
dW5pdCA9IHYtPnNjaGVkX3VuaXQ7CisgICAgICAgIHVuc2lnbmVkIGludCBvbGRfY3B1ID0gc2No
ZWRfdW5pdF9jcHUodW5pdCk7CiAgICAgICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqcmVzOwog
CiAgICAgICAgIEFTU0VSVCghdW5pdF9ydW5uYWJsZSh1bml0KSk7CkBAIC04NTYsNyArODU4LDgg
QEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAg
ewogICAgICAgICAgICAgaWYgKCB1bml0LT5hZmZpbml0eV9icm9rZW4gKQogICAgICAgICAgICAg
ewotICAgICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh2LCB1bml0LT5jcHVfaGFyZF9h
ZmZpbml0eV9zYXZlZCwgTlVMTCk7CisgICAgICAgICAgICAgICAgc2NoZWRfc2V0X2FmZmluaXR5
KHVuaXQtPnZjcHUsIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5X3NhdmVkLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBOVUxMKTsKICAgICAgICAgICAgICAgICB1bml0LT5hZmZp
bml0eV9icm9rZW4gPSAwOwogICAgICAgICAgICAgICAgIGNwdW1hc2tfYW5kKGNwdW1hc2tfc2Ny
YXRjaF9jcHUoY3B1KSwgdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHksCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgY3B1cG9vbF9kb21haW5fY3B1bWFzayhkKSk7CkBAIC04NjQsOCArODY3LDgg
QEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKIAogICAgICAg
ICAgICAgaWYgKCBjcHVtYXNrX2VtcHR5KGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSkgKQogICAg
ICAgICAgICAgewotICAgICAgICAgICAgICAgIHByaW50ayhYRU5MT0dfREVCVUcgIkJyZWFraW5n
IGFmZmluaXR5IGZvciAlcHZcbiIsIHYpOwotICAgICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZp
bml0eSh2LCAmY3B1bWFza19hbGwsIE5VTEwpOworICAgICAgICAgICAgICAgIHByaW50ayhYRU5M
T0dfREVCVUcgIkJyZWFraW5nIGFmZmluaXR5IGZvciAlcHZcbiIsIHVuaXQtPnZjcHUpOworICAg
ICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh1bml0LT52Y3B1LCAmY3B1bWFza19hbGws
IE5VTEwpOwogICAgICAgICAgICAgICAgIGNwdW1hc2tfYW5kKGNwdW1hc2tfc2NyYXRjaF9jcHUo
Y3B1KSwgdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgY3B1cG9vbF9kb21haW5fY3B1bWFzayhkKSk7CiAgICAgICAgICAgICB9CkBAIC04NzUsMTIg
Kzg3OCwxMiBAQCB2b2lkIHJlc3RvcmVfdmNwdV9hZmZpbml0eShzdHJ1Y3QgZG9tYWluICpkKQog
ICAgICAgICBzY2hlZF9zZXRfcmVzKHVuaXQsIHJlcyk7CiAKICAgICAgICAgbG9jayA9IHVuaXRf
c2NoZWR1bGVfbG9ja19pcnEodW5pdCk7Ci0gICAgICAgIHJlcyA9IHNjaGVkX3BpY2tfcmVzb3Vy
Y2UodmNwdV9zY2hlZHVsZXIodiksIHVuaXQpOworICAgICAgICByZXMgPSBzY2hlZF9waWNrX3Jl
c291cmNlKHZjcHVfc2NoZWR1bGVyKHVuaXQtPnZjcHUpLCB1bml0KTsKICAgICAgICAgc2NoZWRf
c2V0X3Jlcyh1bml0LCByZXMpOwogICAgICAgICBzcGluX3VubG9ja19pcnEobG9jayk7CiAKLSAg
ICAgICAgaWYgKCBvbGRfY3B1ICE9IHYtPnByb2Nlc3NvciApCi0gICAgICAgICAgICBzY2hlZF9t
b3ZlX2lycXModi0+c2NoZWRfdW5pdCk7CisgICAgICAgIGlmICggb2xkX2NwdSAhPSBzY2hlZF91
bml0X2NwdSh1bml0KSApCisgICAgICAgICAgICBzY2hlZF9tb3ZlX2lycXModW5pdCk7CiAgICAg
fQogCiAgICAgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmluaXR5KGQpOwpAQCAtODk0LDcgKzg5Nyw2
IEBAIHZvaWQgcmVzdG9yZV92Y3B1X2FmZmluaXR5KHN0cnVjdCBkb21haW4gKmQpCiBpbnQgY3B1
X2Rpc2FibGVfc2NoZWR1bGVyKHVuc2lnbmVkIGludCBjcHUpCiB7CiAgICAgc3RydWN0IGRvbWFp
biAqZDsKLSAgICBzdHJ1Y3QgdmNwdSAqdjsKICAgICBzdHJ1Y3QgY3B1cG9vbCAqYzsKICAgICBj
cHVtYXNrX3Qgb25saW5lX2FmZmluaXR5OwogICAgIGludCByZXQgPSAwOwpAQCAtOTA1LDEwICs5
MDcsMTEgQEAgaW50IGNwdV9kaXNhYmxlX3NjaGVkdWxlcih1bnNpZ25lZCBpbnQgY3B1KQogCiAg
ICAgZm9yX2VhY2hfZG9tYWluX2luX2NwdXBvb2wgKCBkLCBjICkKICAgICB7Ci0gICAgICAgIGZv
cl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CisK
KyAgICAgICAgZm9yX2VhY2hfc2NoZWRfdW5pdCAoIGQsIHVuaXQgKQogICAgICAgICB7CiAgICAg
ICAgICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwotICAgICAgICAgICAgc3RydWN0IHNjaGVkX3Vu
aXQgKnVuaXQgPSB2LT5zY2hlZF91bml0OwogICAgICAgICAgICAgc3BpbmxvY2tfdCAqbG9jayA9
IHVuaXRfc2NoZWR1bGVfbG9ja19pcnFzYXZlKHVuaXQsICZmbGFncyk7CiAKICAgICAgICAgICAg
IGNwdW1hc2tfYW5kKCZvbmxpbmVfYWZmaW5pdHksIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5LCBj
LT5jcHVfdmFsaWQpOwpAQCAtOTIzLDE0ICs5MjYsMTQgQEAgaW50IGNwdV9kaXNhYmxlX3NjaGVk
dWxlcih1bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAg
ICAgICAgICAgICB9CiAKLSAgICAgICAgICAgICAgICBwcmludGsoWEVOTE9HX0RFQlVHICJCcmVh
a2luZyBhZmZpbml0eSBmb3IgJXB2XG4iLCB2KTsKKyAgICAgICAgICAgICAgICBwcmludGsoWEVO
TE9HX0RFQlVHICJCcmVha2luZyBhZmZpbml0eSBmb3IgJXB2XG4iLCB1bml0LT52Y3B1KTsKIAot
ICAgICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh2LCAmY3B1bWFza19hbGwsIE5VTEwp
OworICAgICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh1bml0LT52Y3B1LCAmY3B1bWFz
a19hbGwsIE5VTEwpOwogICAgICAgICAgICAgfQogCi0gICAgICAgICAgICBpZiAoIHYtPnByb2Nl
c3NvciAhPSBjcHUgKQorICAgICAgICAgICAgaWYgKCBzY2hlZF91bml0X2NwdSh1bml0KSAhPSBz
Y2hlZF9nZXRfcmVzb3VyY2VfY3B1KGNwdSkgKQogICAgICAgICAgICAgewotICAgICAgICAgICAg
ICAgIC8qIFRoZSB2Y3B1IGlzIG5vdCBvbiB0aGlzIGNwdSwgc28gd2UgY2FuIG1vdmUgb24uICov
CisgICAgICAgICAgICAgICAgLyogVGhlIHVuaXQgaXMgbm90IG9uIHRoaXMgY3B1LCBzbyB3ZSBj
YW4gbW92ZSBvbi4gKi8KICAgICAgICAgICAgICAgICB1bml0X3NjaGVkdWxlX3VubG9ja19pcnFy
ZXN0b3JlKGxvY2ssIGZsYWdzLCB1bml0KTsKICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAg
ICAgICAgICAgIH0KQEAgLTk0MywxNyArOTQ2LDE3IEBAIGludCBjcHVfZGlzYWJsZV9zY2hlZHVs
ZXIodW5zaWduZWQgaW50IGNwdSkKICAgICAgICAgICAgICAqICAqIHRoZSBzY2hlZHVsZXIgd2ls
bCBhbHdheXMgZmluZCBhIHN1aXRhYmxlIHNvbHV0aW9uLCBvcgogICAgICAgICAgICAgICogICAg
dGhpbmdzIHdvdWxkIGhhdmUgZmFpbGVkIGJlZm9yZSBnZXR0aW5nIGluIGhlcmUuCiAgICAgICAg
ICAgICAgKi8KLSAgICAgICAgICAgIHZjcHVfbWlncmF0ZV9zdGFydCh2KTsKKyAgICAgICAgICAg
IHZjcHVfbWlncmF0ZV9zdGFydCh1bml0LT52Y3B1KTsKICAgICAgICAgICAgIHVuaXRfc2NoZWR1
bGVfdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIHVuaXQpOwogCi0gICAgICAgICAgICB2
Y3B1X21pZ3JhdGVfZmluaXNoKHYpOworICAgICAgICAgICAgdmNwdV9taWdyYXRlX2ZpbmlzaCh1
bml0LT52Y3B1KTsKIAogICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAqIFRoZSBvbmx5IGNh
dmVhdCwgaW4gdGhpcyBjYXNlLCBpcyB0aGF0IGlmIGEgdmNwdSBhY3RpdmUgaW4KICAgICAgICAg
ICAgICAqIHRoZSBoeXBlcnZpc29yIGlzbid0IG1pZ3JhdGFibGUuIEluIHRoaXMgY2FzZSwgdGhl
IGNhbGxlcgogICAgICAgICAgICAgICogc2hvdWxkIHRyeSBhZ2FpbiBhZnRlciByZWxlYXNpbmcg
YW5kIHJlYXF1aXJpbmcgYWxsIGxvY2tzLgogICAgICAgICAgICAgICovCi0gICAgICAgICAgICBp
ZiAoIHYtPnByb2Nlc3NvciA9PSBjcHUgKQorICAgICAgICAgICAgaWYgKCBzY2hlZF91bml0X2Nw
dSh1bml0KSA9PSBzY2hlZF9nZXRfcmVzb3VyY2VfY3B1KGNwdSkgKQogICAgICAgICAgICAgICAg
IHJldCA9IC1FQUdBSU47CiAgICAgICAgIH0KICAgICB9CkBAIC05NjQsMTYgKzk2NywxNiBAQCBp
bnQgY3B1X2Rpc2FibGVfc2NoZWR1bGVyKHVuc2lnbmVkIGludCBjcHUpCiBzdGF0aWMgaW50IGNw
dV9kaXNhYmxlX3NjaGVkdWxlcl9jaGVjayh1bnNpZ25lZCBpbnQgY3B1KQogewogICAgIHN0cnVj
dCBkb21haW4gKmQ7Ci0gICAgc3RydWN0IHZjcHUgKnY7CiAgICAgc3RydWN0IGNwdXBvb2wgKmM7
CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAKICAgICBjID0gcGVyX2NwdShjcHVwb29s
LCBjcHUpOwogICAgIGlmICggYyA9PSBOVUxMICkKICAgICAgICAgcmV0dXJuIDA7CiAKICAgICBm
b3JfZWFjaF9kb21haW5faW5fY3B1cG9vbCAoIGQsIGMgKQotICAgICAgICBmb3JfZWFjaF92Y3B1
ICggZCwgdiApCi0gICAgICAgICAgICBpZiAoIHYtPnNjaGVkX3VuaXQtPmFmZmluaXR5X2Jyb2tl
biApCisgICAgICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkKKyAgICAgICAgICAg
IGlmICggdW5pdC0+YWZmaW5pdHlfYnJva2VuICkKICAgICAgICAgICAgICAgICByZXR1cm4gLUVB
RERSSU5VU0U7CiAKICAgICByZXR1cm4gMDsKLS0gCjIuMTYuNAoKCl9fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVu
LWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcv
bWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

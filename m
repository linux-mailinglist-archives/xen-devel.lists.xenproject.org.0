Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id AA7FD2C467
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:36:09 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZQC-0004ok-MN; Tue, 28 May 2019 10:33:32 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZQ6-0004dW-I9
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:33:26 +0000
X-Inumbo-ID: 05dc0bd3-8134-11e9-8980-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 05dc0bd3-8134-11e9-8980-bc764e045a96;
 Tue, 28 May 2019 10:33:25 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id B7AF8B04F;
 Tue, 28 May 2019 10:33:23 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:32:41 +0200
Message-Id: <20190528103313.1343-29-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 28/60] xen/sched: switch schedule() from vcpus
 to sched_units
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VXNlIHNjaGVkX3VuaXRzIGluc3RlYWQgb2YgdmNwdXMgaW4gc2NoZWR1bGUoKS4gVGhpcyBpbmNs
dWRlcyB0aGUKaW50cm9kdWN0aW9uIG9mIHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hhbmdlKCkgYXMg
YSByZXBsYWNlbWVudCBvZgp2Y3B1X3J1bnN0YXRlX2NoYW5nZSgpIGluIHNjaGVkdWxlKCkuCgpT
aWduZWQtb2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+Ci0tLQogeGVuL2Nv
bW1vbi9zY2hlZHVsZS5jIHwgNzAgKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0t
LS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNDAgaW5zZXJ0aW9ucygrKSwgMzAgZGVs
ZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1v
bi9zY2hlZHVsZS5jCmluZGV4IDJjMWJhMzJkODMuLjExZDFiNzNiZmMgMTAwNjQ0Ci0tLSBhL3hl
bi9jb21tb24vc2NoZWR1bGUuYworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTE5Miw2
ICsxOTIsMjAgQEAgc3RhdGljIGlubGluZSB2b2lkIHZjcHVfcnVuc3RhdGVfY2hhbmdlKAogICAg
IHYtPnJ1bnN0YXRlLnN0YXRlID0gbmV3X3N0YXRlOwogfQogCitzdGF0aWMgaW5saW5lIHZvaWQg
c2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2Uoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAg
Ym9vbCBydW5uaW5nLCBzX3RpbWVfdCBuZXdfZW50cnlfdGltZSkKK3sKKyAgICBzdHJ1Y3QgdmNw
dSAqdiA9IHVuaXQtPnZjcHU7CisKKyAgICBpZiAoIHJ1bm5pbmcgKQorICAgICAgICB2Y3B1X3J1
bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9ydW5uaW5nLCBuZXdfZW50cnlfdGltZSk7CisgICAg
ZWxzZQorICAgICAgICB2Y3B1X3J1bnN0YXRlX2NoYW5nZSh2LAorICAgICAgICAgICAgKCh2LT5w
YXVzZV9mbGFncyAmIFZQRl9ibG9ja2VkKSA/IFJVTlNUQVRFX2Jsb2NrZWQgOgorICAgICAgICAg
ICAgICh2Y3B1X3J1bm5hYmxlKHYpID8gUlVOU1RBVEVfcnVubmFibGUgOiBSVU5TVEFURV9vZmZs
aW5lKSksCisgICAgICAgICAgICBuZXdfZW50cnlfdGltZSk7Cit9CisKIHZvaWQgdmNwdV9ydW5z
dGF0ZV9nZXQoc3RydWN0IHZjcHUgKnYsIHN0cnVjdCB2Y3B1X3J1bnN0YXRlX2luZm8gKnJ1bnN0
YXRlKQogewogICAgIHNwaW5sb2NrX3QgKmxvY2sgPSBsaWtlbHkodiA9PSBjdXJyZW50KQpAQCAt
MTUzMSw3ICsxNTQ1LDcgQEAgc3RhdGljIHZvaWQgdmNwdV9wZXJpb2RpY190aW1lcl93b3JrKHN0
cnVjdCB2Y3B1ICp2KQogICovCiBzdGF0aWMgdm9pZCBzY2hlZHVsZSh2b2lkKQogewotICAgIHN0
cnVjdCB2Y3B1ICAgICAgICAgICpwcmV2ID0gY3VycmVudCwgKm5leHQgPSBOVUxMOworICAgIHN0
cnVjdCBzY2hlZF91bml0ICAgICpwcmV2ID0gY3VycmVudC0+c2NoZWRfdW5pdCwgKm5leHQgPSBO
VUxMOwogICAgIHNfdGltZV90ICAgICAgICAgICAgICBub3c7CiAgICAgc3RydWN0IHNjaGVkdWxl
ciAgICAgKnNjaGVkOwogICAgIHVuc2lnbmVkIGxvbmcgICAgICAgICp0YXNrbGV0X3dvcmsgPSAm
dGhpc19jcHUodGFza2xldF93b3JrX3RvX2RvKTsKQEAgLTE1NzUsOSArMTU4OSw5IEBAIHN0YXRp
YyB2b2lkIHNjaGVkdWxlKHZvaWQpCiAgICAgc2NoZWQgPSB0aGlzX2NwdShzY2hlZHVsZXIpOwog
ICAgIG5leHRfc2xpY2UgPSBzY2hlZC0+ZG9fc2NoZWR1bGUoc2NoZWQsIG5vdywgdGFza2xldF93
b3JrX3NjaGVkdWxlZCk7CiAKLSAgICBuZXh0ID0gbmV4dF9zbGljZS50YXNrLT52Y3B1OworICAg
IG5leHQgPSBuZXh0X3NsaWNlLnRhc2s7CiAKLSAgICBzZC0+Y3VyciA9IG5leHQtPnNjaGVkX3Vu
aXQ7CisgICAgc2QtPmN1cnIgPSBuZXh0OwogCiAgICAgaWYgKCBuZXh0X3NsaWNlLnRpbWUgPj0g
MCApIC8qIC12ZSBtZWFucyBubyBsaW1pdCAqLwogICAgICAgICBzZXRfdGltZXIoJnNkLT5zX3Rp
bWVyLCBub3cgKyBuZXh0X3NsaWNlLnRpbWUpOwpAQCAtMTU4Niw2MCArMTYwMCw1NiBAQCBzdGF0
aWMgdm9pZCBzY2hlZHVsZSh2b2lkKQogICAgIHsKICAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxv
Y2tfaXJxKGxvY2ssIGNwdSk7CiAgICAgICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5G
Q09OVCwKLSAgICAgICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQtPnZj
cHVfaWQsCi0gICAgICAgICAgICAgICAgIG5vdyAtIHByZXYtPnJ1bnN0YXRlLnN0YXRlX2VudHJ5
X3RpbWUsCisgICAgICAgICAgICAgICAgIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0LT51
bml0X2lkLAorICAgICAgICAgICAgICAgICBub3cgLSBwcmV2LT5zdGF0ZV9lbnRyeV90aW1lLAog
ICAgICAgICAgICAgICAgICBuZXh0X3NsaWNlLnRpbWUpOwotICAgICAgICB0cmFjZV9jb250aW51
ZV9ydW5uaW5nKG5leHQpOwotICAgICAgICByZXR1cm4gY29udGludWVfcnVubmluZyhwcmV2KTsK
KyAgICAgICAgdHJhY2VfY29udGludWVfcnVubmluZyhuZXh0LT52Y3B1KTsKKyAgICAgICAgcmV0
dXJuIGNvbnRpbnVlX3J1bm5pbmcocHJldi0+dmNwdSk7CiAgICAgfQogCiAgICAgVFJBQ0VfM0Qo
VFJDX1NDSEVEX1NXSVRDSF9JTkZQUkVWLAotICAgICAgICAgICAgIHByZXYtPmRvbWFpbi0+ZG9t
YWluX2lkLCBwcmV2LT52Y3B1X2lkLAotICAgICAgICAgICAgIG5vdyAtIHByZXYtPnJ1bnN0YXRl
LnN0YXRlX2VudHJ5X3RpbWUpOworICAgICAgICAgICAgIHByZXYtPmRvbWFpbi0+ZG9tYWluX2lk
LCBwcmV2LT51bml0X2lkLAorICAgICAgICAgICAgIG5vdyAtIHByZXYtPnN0YXRlX2VudHJ5X3Rp
bWUpOwogICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GTkVYVCwKLSAgICAgICAgICAg
ICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dmNwdV9pZCwKLSAgICAgICAgICAgICAo
bmV4dC0+cnVuc3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmFibGUpID8KLSAgICAgICAgICAg
ICAobm93IC0gbmV4dC0+cnVuc3RhdGUuc3RhdGVfZW50cnlfdGltZSkgOiAwLAorICAgICAgICAg
ICAgIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0LT51bml0X2lkLAorICAgICAgICAgICAg
IChuZXh0LT52Y3B1LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uYWJsZSkgPworICAg
ICAgICAgICAgIChub3cgLSBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lKSA6IDAsCiAgICAgICAgICAg
ICAgbmV4dF9zbGljZS50aW1lKTsKIAotICAgIEFTU0VSVChwcmV2LT5ydW5zdGF0ZS5zdGF0ZSA9
PSBSVU5TVEFURV9ydW5uaW5nKTsKKyAgICBBU1NFUlQocHJldi0+dmNwdS0+cnVuc3RhdGUuc3Rh
dGUgPT0gUlVOU1RBVEVfcnVubmluZyk7CiAKICAgICBUUkFDRV80RChUUkNfU0NIRURfU1dJVENI
LAotICAgICAgICAgICAgIHByZXYtPmRvbWFpbi0+ZG9tYWluX2lkLCBwcmV2LT52Y3B1X2lkLAot
ICAgICAgICAgICAgIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0LT52Y3B1X2lkKTsKKyAg
ICAgICAgICAgICBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKKyAgICAg
ICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCk7CiAKLSAgICB2
Y3B1X3J1bnN0YXRlX2NoYW5nZSgKLSAgICAgICAgcHJldiwKLSAgICAgICAgKChwcmV2LT5wYXVz
ZV9mbGFncyAmIFZQRl9ibG9ja2VkKSA/IFJVTlNUQVRFX2Jsb2NrZWQgOgotICAgICAgICAgKHZj
cHVfcnVubmFibGUocHJldikgPyBSVU5TVEFURV9ydW5uYWJsZSA6IFJVTlNUQVRFX29mZmxpbmUp
KSwKLSAgICAgICAgbm93KTsKLSAgICBwcmV2LT5zY2hlZF91bml0LT5sYXN0X3J1bl90aW1lID0g
bm93OworICAgIHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hhbmdlKHByZXYsIGZhbHNlLCBub3cpOwor
ICAgIHByZXYtPmxhc3RfcnVuX3RpbWUgPSBub3c7CiAKLSAgICBBU1NFUlQobmV4dC0+cnVuc3Rh
dGUuc3RhdGUgIT0gUlVOU1RBVEVfcnVubmluZyk7Ci0gICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2Uo
bmV4dCwgUlVOU1RBVEVfcnVubmluZywgbm93KTsKKyAgICBBU1NFUlQobmV4dC0+dmNwdS0+cnVu
c3RhdGUuc3RhdGUgIT0gUlVOU1RBVEVfcnVubmluZyk7CisgICAgc2NoZWRfdW5pdF9ydW5zdGF0
ZV9jaGFuZ2UobmV4dCwgdHJ1ZSwgbm93KTsKIAogICAgIC8qCiAgICAgICogTkIuIERvbid0IGFk
ZCBhbnkgdHJhY2UgcmVjb3JkcyBmcm9tIGhlcmUgdW50aWwgdGhlIGFjdHVhbCBjb250ZXh0CiAg
ICAgICogc3dpdGNoLCBlbHNlIGxvc3RfcmVjb3JkcyByZXN1bWUgd2lsbCBub3Qgd29yayBwcm9w
ZXJseS4KICAgICAgKi8KIAotICAgIEFTU0VSVCghbmV4dC0+c2NoZWRfdW5pdC0+aXNfcnVubmlu
Zyk7CisgICAgQVNTRVJUKCFuZXh0LT5pc19ydW5uaW5nKTsKKyAgICBuZXh0LT52Y3B1LT5pc19y
dW5uaW5nID0gMTsKICAgICBuZXh0LT5pc19ydW5uaW5nID0gMTsKLSAgICBuZXh0LT5zY2hlZF91
bml0LT5pc19ydW5uaW5nID0gMTsKLSAgICBuZXh0LT5zY2hlZF91bml0LT5zdGF0ZV9lbnRyeV90
aW1lID0gbm93OworICAgIG5leHQtPnN0YXRlX2VudHJ5X3RpbWUgPSBub3c7CiAKICAgICBwY3B1
X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKIAogICAgIFNDSEVEX1NUQVRfQ1JBTkso
c2NoZWRfY3R4KTsKIAotICAgIHN0b3BfdGltZXIoJnByZXYtPnBlcmlvZGljX3RpbWVyKTsKKyAg
ICBzdG9wX3RpbWVyKCZwcmV2LT52Y3B1LT5wZXJpb2RpY190aW1lcik7CiAKICAgICBpZiAoIG5l
eHRfc2xpY2UubWlncmF0ZWQgKQotICAgICAgICBzY2hlZF9tb3ZlX2lycXMobmV4dCk7CisgICAg
ICAgIHNjaGVkX21vdmVfaXJxcyhuZXh0LT52Y3B1KTsKIAotICAgIHZjcHVfcGVyaW9kaWNfdGlt
ZXJfd29yayhuZXh0KTsKKyAgICB2Y3B1X3BlcmlvZGljX3RpbWVyX3dvcmsobmV4dC0+dmNwdSk7
CiAKLSAgICBjb250ZXh0X3N3aXRjaChwcmV2LCBuZXh0KTsKKyAgICBjb250ZXh0X3N3aXRjaChw
cmV2LT52Y3B1LCBuZXh0LT52Y3B1KTsKIH0KIAogdm9pZCBjb250ZXh0X3NhdmVkKHN0cnVjdCB2
Y3B1ICpwcmV2KQotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVu
cHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZv
L3hlbi1kZXZlbA==

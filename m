Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 09EFE75F0D
	for <lists+xen-devel@lfdr.de>; Fri, 26 Jul 2019 08:28:57 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hqtg0-00039d-RB; Fri, 26 Jul 2019 06:26:00 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=6973=VX=suse.com=dfaggioli@srs-us1.protection.inumbo.net>)
 id 1hqtfz-00039P-J8
 for xen-devel@lists.xenproject.org; Fri, 26 Jul 2019 06:25:59 +0000
X-Inumbo-ID: 3a8deccd-af6e-11e9-8980-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 3a8deccd-af6e-11e9-8980-bc764e045a96;
 Fri, 26 Jul 2019 06:25:58 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 3B627AD31;
 Fri, 26 Jul 2019 06:25:57 +0000 (UTC)
From: Dario Faggioli <dfaggioli@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 26 Jul 2019 08:25:56 +0200
Message-ID: <156412235656.2385.13861979113936528474.stgit@Palanthas>
In-Reply-To: <156412188377.2385.12588508835559819141.stgit@Palanthas>
References: <156412188377.2385.12588508835559819141.stgit@Palanthas>
User-Agent: StGit/0.17.1-dirty
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2 2/4] xen: sched: deal with vCPUs being or
 becoming online or offline
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: George Dunlap <george.dunlap@eu.citrix.com>,
 Stefano Stabellini <sstabellini@kernel.org>,
 Roger Pau Monne <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SWYgYSB2Q1BVIGlzLCBvciBpcyBnb2luZywgb2ZmbGluZSB3ZSB3YW50IGl0IHRvIGJlIG5laXRo
ZXIKYXNzaWduZWQgdG8gYSBwQ1BVLCBub3IgaW4gdGhlIHdhaXQgbGlzdCwgc286Ci0gaWYgYW4g
b2ZmbGluZSB2Y3B1IGlzIGluc2VydGVkIChvciBtaWdyYXRlZCkgaXQgbXVzdCBub3QKICBnbyBv
biBhIHBDUFUsIG5vciBpbiB0aGUgd2FpdCBsaXN0OwotIGlmIGFuIG9mZmxpbmUgdmNwdSBpcyBy
ZW1vdmVkLCB3ZSBhcmUgc3VyZSB0aGF0IGl0IGlzCiAgbmVpdGhlciBvbiBhIHBDUFUgbm9yIGlu
IHRoZSB3YWl0IGxpc3QgYWxyZWFkeSwgc28gd2UKICBzaG91bGQganVzdCBiYWlsLCBhdm9pZGlu
ZyBkb2luZyBhbnkgZnVydGhlciBhY3Rpb247Ci0gaWYgYSB2Q1BVIGdvZXMgb2ZmbGluZSB3ZSBu
ZWVkIHRvIHJlbW92ZSBpdCBlaXRoZXIgZnJvbQogIGl0cyBwQ1BVIG9yIGZyb20gdGhlIHdhaXQg
bGlzdC4KClNpZ25lZC1vZmYtYnk6IERhcmlvIEZhZ2dpb2xpIDxkZmFnZ2lvbGlAc3VzZS5jb20+
Ci0tLQpDYzogR2VvcmdlIER1bmxhcCA8Z2VvcmdlLmR1bmxhcEBldS5jaXRyaXguY29tPgpDYzog
U3RlZmFubyBTdGFiZWxsaW5pIDxzc3RhYmVsbGluaUBrZXJuZWwub3JnPgpDYzogUm9nZXIgUGF1
IE1vbm5lIDxyb2dlci5wYXVAY2l0cml4LmNvbT4KLS0tCkNoYW5nZXMgZnJvbSB2MToKKiBpbXBy
b3ZlZCB3b3JkaW5nIGluIGNoYW5nZWxvZyBhbmQgY29tbWVudHMKKiB0aGlzIHBhdGNoIGlzIHRo
ZSByZXN1bHQgb2YgdGhlIG1lcmdlIG9mIHBhdGNoZXMgMiBhbmQgMyBmcm9tIHYxCi0tLQogeGVu
L2NvbW1vbi9zY2hlZF9udWxsLmMgfCAgIDgwICsrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKy0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNjYgaW5zZXJ0aW9ucygrKSwgMTQg
ZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZF9udWxsLmMgYi94ZW4v
Y29tbW9uL3NjaGVkX251bGwuYwppbmRleCBjNDdjMWI1YWFlLi4xMGU5NmYyMWRkIDEwMDY0NAot
LS0gYS94ZW4vY29tbW9uL3NjaGVkX251bGwuYworKysgYi94ZW4vY29tbW9uL3NjaGVkX251bGwu
YwpAQCAtMzM5LDYgKzMzOSw4IEBAIHN0YXRpYyB1bnNpZ25lZCBpbnQgcGlja19jcHUoc3RydWN0
IG51bGxfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3QgdmNwdSAqdikKIHN0YXRpYyB2b2lkIHZjcHVfYXNz
aWduKHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiwgc3RydWN0IHZjcHUgKnYsCiAgICAgICAgICAg
ICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgY3B1KQogeworICAgIEFTU0VSVChpc192Y3B1X29u
bGluZSh2KSk7CisKICAgICBwZXJfY3B1KG5wYywgY3B1KS52Y3B1ID0gdjsKICAgICB2LT5wcm9j
ZXNzb3IgPSBjcHU7CiAgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1LCAmcHJ2LT5jcHVzX2ZyZWUp
OwpAQCAtMzU4LDcgKzM2MCw4IEBAIHN0YXRpYyB2b2lkIHZjcHVfYXNzaWduKHN0cnVjdCBudWxs
X3ByaXZhdGUgKnBydiwgc3RydWN0IHZjcHUgKnYsCiAgICAgfQogfQogCi1zdGF0aWMgdm9pZCB2
Y3B1X2RlYXNzaWduKHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiwgc3RydWN0IHZjcHUgKnYpCisv
KiBSZXR1cm5zIHRydWUgaWYgYSBjcHUgd2FzIHRpY2tsZWQgKi8KK3N0YXRpYyBib29sIHZjcHVf
ZGVhc3NpZ24oc3RydWN0IG51bGxfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3QgdmNwdSAqdikKIHsKICAg
ICB1bnNpZ25lZCBpbnQgYnM7CiAgICAgdW5zaWduZWQgaW50IGNwdSA9IHYtPnByb2Nlc3NvcjsK
QEAgLTQwMywxMSArNDA2LDEzIEBAIHN0YXRpYyB2b2lkIHZjcHVfZGVhc3NpZ24oc3RydWN0IG51
bGxfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAgICAgICAgICB2Y3B1X2Fz
c2lnbihwcnYsIHd2Yy0+dmNwdSwgY3B1KTsKICAgICAgICAgICAgICAgICBjcHVfcmFpc2Vfc29m
dGlycShjcHUsIFNDSEVEVUxFX1NPRlRJUlEpOwogICAgICAgICAgICAgICAgIHNwaW5fdW5sb2Nr
KCZwcnYtPndhaXRxX2xvY2spOwotICAgICAgICAgICAgICAgIHJldHVybjsKKyAgICAgICAgICAg
ICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgIH0KICAgICAgICAgfQogICAgIH0KICAgICBz
cGluX3VubG9jaygmcHJ2LT53YWl0cV9sb2NrKTsKKworICAgIHJldHVybiBmYWxzZTsKIH0KIAog
LyogQ2hhbmdlIHRoZSBzY2hlZHVsZXIgb2YgY3B1IHRvIHVzIChudWxsKS4gKi8KQEAgLTQ0NSw4
ICs0NTAsMTQgQEAgc3RhdGljIHZvaWQgbnVsbF92Y3B1X2luc2VydChjb25zdCBzdHJ1Y3Qgc2No
ZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1ICp2KQogICAgIEFTU0VSVCghaXNfaWRsZV92Y3B1KHYp
KTsKIAogICAgIGxvY2sgPSB2Y3B1X3NjaGVkdWxlX2xvY2tfaXJxKHYpOwotIHJldHJ5OgogCisg
ICAgaWYgKCB1bmxpa2VseSghaXNfdmNwdV9vbmxpbmUodikpICkKKyAgICB7CisgICAgICAgIHZj
cHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCB2KTsKKyAgICAgICAgcmV0dXJuOworICAgIH0K
KworIHJldHJ5OgogICAgIGNwdSA9IHYtPnByb2Nlc3NvciA9IHBpY2tfY3B1KHBydiwgdik7CiAK
ICAgICBzcGluX3VubG9jayhsb2NrKTsKQEAgLTUwMCw2ICs1MTEsMTQgQEAgc3RhdGljIHZvaWQg
bnVsbF92Y3B1X3JlbW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1
ICp2KQogCiAgICAgbG9jayA9IHZjcHVfc2NoZWR1bGVfbG9ja19pcnEodik7CiAKKyAgICAvKiBJ
ZiBvZmZsaW5lLCB0aGUgdmNwdSBzaG91bGRuJ3QgYmUgYXNzaWduZWQsIG5vciBpbiB0aGUgd2Fp
dHF1ZXVlICovCisgICAgaWYgKCB1bmxpa2VseSghaXNfdmNwdV9vbmxpbmUodikpICkKKyAgICB7
CisgICAgICAgIEFTU0VSVChwZXJfY3B1KG5wYywgdi0+cHJvY2Vzc29yKS52Y3B1ICE9IHYpOwor
ICAgICAgICBBU1NFUlQobGlzdF9lbXB0eSgmbnZjLT53YWl0cV9lbGVtKSk7CisgICAgICAgIGdv
dG8gb3V0OworICAgIH0KKwogICAgIC8qIElmIHYgaXMgaW4gd2FpdHF1ZXVlLCBqdXN0IGdldCBp
dCBvdXQgb2YgdGhlcmUgYW5kIGJhaWwgKi8KICAgICBpZiAoIHVubGlrZWx5KCFsaXN0X2VtcHR5
KCZudmMtPndhaXRxX2VsZW0pKSApCiAgICAgewpAQCAtNTQ5LDExICs1NjgsMzMgQEAgc3RhdGlj
IHZvaWQgbnVsbF92Y3B1X3dha2UoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qg
dmNwdSAqdikKIAogc3RhdGljIHZvaWQgbnVsbF92Y3B1X3NsZWVwKGNvbnN0IHN0cnVjdCBzY2hl
ZHVsZXIgKm9wcywgc3RydWN0IHZjcHUgKnYpCiB7CisgICAgc3RydWN0IG51bGxfcHJpdmF0ZSAq
cHJ2ID0gbnVsbF9wcml2KG9wcyk7CisgICAgdW5zaWduZWQgaW50IGNwdSA9IHYtPnByb2Nlc3Nv
cjsKKyAgICBib29sIHRpY2tsZWQgPSBmYWxzZTsKKwogICAgIEFTU0VSVCghaXNfaWRsZV92Y3B1
KHYpKTsKIAorICAgIC8qIAorICAgICAqIENoZWNrIGlmIHRoZSB2Y3B1IGlzIGluIHRoZSBwcm9j
ZXNzIG9mIGJlaW5nIG9mZmxpbmVkLiBpZiB5ZXMsCisgICAgICogd2UgbmVlZCB0byByZW1vdmUg
aXQgZnJvbSBlaXRoZXIgaXRzIHBDUFUgb3IgdGhlIHdhaXRxdWV1ZS4KKyAgICAgKi8KKyAgICBp
ZiAoIHVubGlrZWx5KCFpc192Y3B1X29ubGluZSh2KSkgKQorICAgIHsKKyAgICAgICAgc3RydWN0
IG51bGxfdmNwdSAqbnZjID0gbnVsbF92Y3B1KHYpOworCisgICAgICAgIGlmICggdW5saWtlbHko
IWxpc3RfZW1wdHkoJm52Yy0+d2FpdHFfZWxlbSkpICkKKyAgICAgICAgeworICAgICAgICAgICAg
c3Bpbl9sb2NrKCZwcnYtPndhaXRxX2xvY2spOworICAgICAgICAgICAgbGlzdF9kZWxfaW5pdCgm
bnZjLT53YWl0cV9lbGVtKTsKKyAgICAgICAgICAgIHNwaW5fdW5sb2NrKCZwcnYtPndhaXRxX2xv
Y2spOworICAgICAgICB9CisgICAgICAgIGVsc2UgaWYgKCBwZXJfY3B1KG5wYywgY3B1KS52Y3B1
ID09IHYgKQorICAgICAgICAgICAgdGlja2xlZCA9IHZjcHVfZGVhc3NpZ24ocHJ2LCB2KTsKKyAg
ICB9CisKICAgICAvKiBJZiB2IGlzIG5vdCBhc3NpZ25lZCB0byBhIHBDUFUsIG9yIGlzIG5vdCBy
dW5uaW5nLCBubyBuZWVkIHRvIGJvdGhlciAqLwotICAgIGlmICggY3Vycl9vbl9jcHUodi0+cHJv
Y2Vzc29yKSA9PSB2ICkKLSAgICAgICAgY3B1X3JhaXNlX3NvZnRpcnEodi0+cHJvY2Vzc29yLCBT
Q0hFRFVMRV9TT0ZUSVJRKTsKKyAgICBpZiAoIGxpa2VseSghdGlja2xlZCAmJiBjdXJyX29uX2Nw
dShjcHUpID09IHYpICkKKyAgICAgICAgY3B1X3JhaXNlX3NvZnRpcnEoY3B1LCBTQ0hFRFVMRV9T
T0ZUSVJRKTsKIAogICAgIFNDSEVEX1NUQVRfQ1JBTksodmNwdV9zbGVlcCk7CiB9CkBAIC01ODks
MjQgKzYzMCwzNCBAQCBzdGF0aWMgdm9pZCBudWxsX3ZjcHVfbWlncmF0ZShjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1ICp2LAogICAgIH0KIAogICAgIC8qCi0gICAgICog
diBpcyBlaXRoZXIgYXNzaWduZWQgdG8gYSBwQ1BVLCBvciBpbiB0aGUgd2FpdHF1ZXVlLgotICAg
ICAqCi0gICAgICogSW4gdGhlIGZvcm1lciBjYXNlLCB0aGUgcENQVSB0byB3aGljaCBpdCB3YXMg
YXNzaWduZWQgd291bGQKLSAgICAgKiBiZWNvbWUgZnJlZSwgYW5kIHdlLCB0aGVyZWZvcmUsIHNo
b3VsZCBjaGVjayB3aGV0aGVyIHRoZXJlIGlzCi0gICAgICogYW55b25lIGluIHRoZSB3YWl0cXVl
dWUgdGhhdCBjYW4gYmUgYXNzaWduZWQgdG8gaXQuCi0gICAgICoKLSAgICAgKiBJbiB0aGUgbGF0
dGVyLCB0aGVyZSBpcyBqdXN0IG5vdGhpbmcgdG8gZG8uCisgICAgICogSWYgdiBpcyBhc3NpZ25l
ZCB0byBhIHBDUFUsIHRoZW4gc3VjaCBwQ1BVIGJlY29tZXMgZnJlZSwgYW5kIHdlCisgICAgICog
c2hvdWxkIGxvb2sgaW4gdGhlIHdhaXRxdWV1ZSBpZiBhbnlvbmUgZWxzZSBjYW4gYmUgYXNzaWdu
ZWQgdG8gaXQuCiAgICAgICovCi0gICAgaWYgKCBsaWtlbHkobGlzdF9lbXB0eSgmbnZjLT53YWl0
cV9lbGVtKSkgKQorICAgIGlmICggbGlrZWx5KHBlcl9jcHUobnBjLCB2LT5wcm9jZXNzb3IpLnZj
cHUgPT0gdikgKQogICAgIHsKICAgICAgICAgdmNwdV9kZWFzc2lnbihwcnYsIHYpOwogICAgICAg
ICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3JhdGVfcnVubmluZyk7CiAgICAgfQotICAgIGVsc2UKKyAg
ICBlbHNlIGlmICggIWxpc3RfZW1wdHkoJm52Yy0+d2FpdHFfZWxlbSkgKQogICAgICAgICBTQ0hF
RF9TVEFUX0NSQU5LKG1pZ3JhdGVfb25fcnVucSk7CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKG1p
Z3JhdGVkKTsKIAorICAgIC8qCisgICAgICogSWYgYSB2Y3B1IGlzIChnb2luZykgb2ZmbGluZSwg
d2Ugd2FudCBpdCB0byBiZSBuZWl0aGVyIGFzc2lnbmVkCisgICAgICogdG8gYSBwQ1BVLCBub3Ig
aW4gdGhlIHdhaXRxdWV1ZS4KKyAgICAgKgorICAgICAqIElmIGl0IHdhcyBvbiBhIGNwdSwgd2Un
dmUgcmVtb3ZlZCBpdCBmcm9tIHRoZXJlIGFib3ZlLiBJZiBpdCBpcworICAgICAqIGluIHRoZSB3
YWl0cXVldWUsIHdlIHJlbW92ZSBpdCBmcm9tIHRoZXJlIG5vdy4gQW5kIHRoZW4gd2UgYmFpbC4K
KyAgICAgKi8KKyAgICBpZiAoIHVubGlrZWx5KCFpc192Y3B1X29ubGluZSh2KSkgKQorICAgIHsK
KyAgICAgICAgc3Bpbl9sb2NrKCZwcnYtPndhaXRxX2xvY2spOworICAgICAgICBsaXN0X2RlbF9p
bml0KCZudmMtPndhaXRxX2VsZW0pOworICAgICAgICBzcGluX3VubG9jaygmcHJ2LT53YWl0cV9s
b2NrKTsKKyAgICAgICAgZ290byBvdXQ7CisgICAgfQorCiAgICAgLyoKICAgICAgKiBMZXQncyBu
b3cgY29uc2lkZXIgbmV3X2NwdSwgd2hpY2ggaXMgd2hlcmUgdiBpcyBiZWluZyBzZW50LiBJdCBj
YW4gYmUKICAgICAgKiBlaXRoZXIgZnJlZSwgb3IgaGF2ZSBhIHZDUFUgYWxyZWFkeSBhc3NpZ25l
ZCB0byBpdC4KQEAgLTY0Niw2ICs2OTcsNyBAQCBzdGF0aWMgdm9pZCBudWxsX3ZjcHVfbWlncmF0
ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1ICp2LAogICAgICAqIGF0
IGxlYXN0LiBJbiBjYXNlIG9mIHN1c3BlbmQsIGFueSB0ZW1wb3JhcnkgaW5jb25zaXN0ZW5jeSBj
YXVzZWQKICAgICAgKiBieSB0aGlzLCB3aWxsIGJlIGZpeGVkLXVwIGR1cmluZyByZXN1bWUuCiAg
ICAgICovCisgb3V0OgogICAgIHYtPnByb2Nlc3NvciA9IG5ld19jcHU7CiB9CiAKCgpfX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGlu
ZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnBy
b2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

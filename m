Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 655751773EF
	for <lists+xen-devel@lfdr.de>; Tue,  3 Mar 2020 11:21:59 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j94dj-0000zC-NZ; Tue, 03 Mar 2020 10:19:03 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=TLdZ=4U=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1j94dj-0000z5-3V
 for xen-devel@lists.xenproject.org; Tue, 03 Mar 2020 10:19:03 +0000
X-Inumbo-ID: 6703c2ec-5d38-11ea-902a-bc764e2007e4
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 6703c2ec-5d38-11ea-902a-bc764e2007e4;
 Tue, 03 Mar 2020 10:19:02 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id BA1A9ACB8;
 Tue,  3 Mar 2020 10:19:00 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <1e1ccd2a-526c-631b-7889-35f993b2005e@suse.com>
Message-ID: <80df5080-ed2f-60cb-a94d-15d856218d38@suse.com>
Date: Tue, 3 Mar 2020 11:19:00 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:68.0) Gecko/20100101
 Thunderbird/68.5.0
MIME-Version: 1.0
In-Reply-To: <1e1ccd2a-526c-631b-7889-35f993b2005e@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v5 3/4] x86/mm: use cache in guest_walk_tables()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>,
 Tim Deegan <tim@xen.org>, Wei Liu <wl@xen.org>, Paul Durrant <paul@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

RW11bGF0aW9uIHJlcXVpcmluZyBkZXZpY2UgbW9kZWwgYXNzaXN0YW5jZSB1c2VzIGEgZm9ybSBv
ZiBpbnN0cnVjdGlvbgpyZS1leGVjdXRpb24sIGFzc3VtaW5nIHRoYXQgdGhlIHNlY29uZCAoYW5k
IGFueSBmdXJ0aGVyKSBwYXNzIHRha2VzCmV4YWN0bHkgdGhlIHNhbWUgcGF0aC4gVGhpcyBpcyBh
IHZhbGlkIGFzc3VtcHRpb24gYXMgZmFyIGFzIHVzZSBvZiBDUFUKcmVnaXN0ZXJzIGdvZXMgKGFz
IHRob3NlIGNhbid0IGNoYW5nZSB3aXRob3V0IGFueSBvdGhlciBpbnN0cnVjdGlvbgpleGVjdXRp
bmcgaW4gYmV0d2VlbiBbMV0pLCBidXQgaXMgd3JvbmcgZm9yIG1lbW9yeSBhY2Nlc3Nlcy4gSW4K
cGFydGljdWxhciBpdCBoYXMgYmVlbiBvYnNlcnZlZCB0aGF0IFdpbmRvd3MgbWlnaHQgcGFnZSBv
dXQgYnVmZmVycwp1bmRlcm5lYXRoIGFuIGluc3RydWN0aW9uIGN1cnJlbnRseSB1bmRlciBlbXVs
YXRpb24gKGhpdHRpbmcgYmV0d2VlbiB0d28KcGFzc2VzKS4gSWYgdGhlIGZpcnN0IHBhc3MgdHJh
bnNsYXRlZCBhIGxpbmVhciBhZGRyZXNzIHN1Y2Nlc3NmdWxseSwgYW55CnN1YnNlcXVlbnQgcGFz
cyBuZWVkcyB0byBkbyBzbyB0b28sIHlpZWxkaW5nIHRoZSBleGFjdCBzYW1lIHRyYW5zbGF0aW9u
LgpUbyBndWFyYW50ZWUgdGhpcywgbGV2ZXJhZ2UgdGhlIGNhY2hpbmcgdGhhdCBub3cgYmFja3Mg
SFZNIGluc24KZW11bGF0aW9uLgoKWzFdIE90aGVyIHRoYW4gb24gYWN0dWFsIGhhcmR3YXJlLCBh
Y3Rpb25zIGxpa2UKICAgIFhFTl9ET01DVExfc2V0aHZtY29udGV4dCwgWEVOX0RPTUNUTF9zZXR2
Y3B1Y29udGV4dCwKICAgIFZDUFVPUF9pbml0aWFsaXNlLCBJTklULCBvciBTSVBJIGlzc3VlZCBh
Z2FpbnN0IHRoZSB2Q1BVIGNhbiBvY2N1cgogICAgd2hpbGUgdGhlIHZDUFUgaXMgYmxvY2tlZCB3
YWl0aW5nIGZvciBhIGRldmljZSBtb2RlbCB0byByZXR1cm4gZGF0YS4KICAgIEluIHN1Y2ggY2Fz
ZXMgZW11bGF0aW9uIG5vdyBnZXRzIGNhbmNlbGVkLCB0aG91Z2gsIGFuZCBoZW5jZSByZS0KICAg
IGV4ZWN1dGlvbiBjb3JyZWN0bmVzcyBpcyB1bmFmZmVjdGVkLgoKU2lnbmVkLW9mZi1ieTogSmFu
IEJldWxpY2ggPGpiZXVsaWNoQHN1c2UuY29tPgotLS0KdjU6IE1vdmUgaHZtZW11bF97cmVhZCx3
cml0ZX1fY2FjaGUoKSBzdHVicyBoZXJlLgp2NDogQWRqdXN0IGZvciBjYWNoZSBub3cgKGVsc2V3
aGVyZSkgYmVpbmcgdHJhbnNwYXJlbnQgdG8gY2FsbGVycy4KICAgIFByb3ZpZGUgaW5saW5lIHN0
dWJzIGZvciB0aGUgIUhWTSBjYXNlLgp2MjogRG9uJ3Qgd3JvbmdseSB1c2UgdG9wX2dmbiBmb3Ig
bm9uLXJvb3QgZ3BhIGNhbGN1bGF0aW9uLiBSZS13cml0ZQogICAgY2FjaGUgZW50cmllcyBhZnRl
ciBzZXR0aW5nIEEvRCBiaXRzIChhbiBhbHRlcm5hdGl2ZSB3b3VsZCBiZSB0bwogICAgc3VwcHJl
c3MgdGhlaXIgc2V0dGluZyB1cG9uIGNhY2hlIGhpdHMpLgoKLS0tIGEveGVuL2FyY2gveDg2L2h2
bS9lbXVsYXRlLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS9lbXVsYXRlLmMKQEAgLTI5NDAsNyAr
Mjk0MCw3IEBAIGJvb2wgaHZtZW11bF9yZWFkX2NhY2hlKGNvbnN0IHN0cnVjdCB2Y3AKICAgICB1
bnNpZ25lZCBpbnQgaTsKIAogICAgIC8qIENhY2hlIHVuYXZhaWxhYmxlPyAqLwotICAgIGlmICgg
Y2FjaGUtPm51bV9lbnRzID4gY2FjaGUtPm1heF9lbnRzICkKKyAgICBpZiAoICFpc19odm1fdmNw
dSh2KSB8fCBjYWNoZS0+bnVtX2VudHMgPiBjYWNoZS0+bWF4X2VudHMgKQogICAgICAgICByZXR1
cm4gZmFsc2U7CiAKICAgICB3aGlsZSAoIHNpemUgPiBzaXplb2YoY2FjaGUtPmVudHMtPmRhdGEp
ICkKQEAgLTI5NzIsNyArMjk3Miw3IEBAIHZvaWQgaHZtZW11bF93cml0ZV9jYWNoZShjb25zdCBz
dHJ1Y3QgdmMKICAgICB1bnNpZ25lZCBpbnQgaTsKIAogICAgIC8qIENhY2hlIHVuYXZhaWxhYmxl
PyAqLwotICAgIGlmICggY2FjaGUtPm51bV9lbnRzID4gY2FjaGUtPm1heF9lbnRzICkKKyAgICBp
ZiAoICFpc19odm1fdmNwdSh2KSB8fCBjYWNoZS0+bnVtX2VudHMgPiBjYWNoZS0+bWF4X2VudHMg
KQogICAgICAgICByZXR1cm47CiAKICAgICB3aGlsZSAoIHNpemUgPiBzaXplb2YoY2FjaGUtPmVu
dHMtPmRhdGEpICkKLS0tIGEveGVuL2FyY2gveDg2L21tL2d1ZXN0X3dhbGsuYworKysgYi94ZW4v
YXJjaC94ODYvbW0vZ3Vlc3Rfd2Fsay5jCkBAIC0zMSw2ICszMSw3IEBAIGFzbSgiLmZpbGUgXCIi
IF9fT0JKRUNUX0ZJTEVfXyAiXCIiKTsKICNpbmNsdWRlIDx4ZW4vc2NoZWQuaD4KICNpbmNsdWRl
IDxhc20vcGFnZS5oPgogI2luY2x1ZGUgPGFzbS9ndWVzdF9wdC5oPgorI2luY2x1ZGUgPGFzbS9o
dm0vZW11bGF0ZS5oPgogCiAvKgogICogTW9kaWZ5IGEgZ3Vlc3QgcGFnZXRhYmxlIGVudHJ5IHRv
IHNldCB0aGUgQWNjZXNzZWQgYW5kIERpcnR5IGJpdHMuCkBAIC04MCw5ICs4MSw5IEBAIHN0YXRp
YyBib29sIHNldF9hZF9iaXRzKGd1ZXN0X2ludHB0ZV90ICoKICAqIHJlcXVlc3RlZCB3YWxrLCB0
byBzZWUgd2hldGhlciB0aGUgYWNjZXNzIGlzIHBlcm1pdHRlZC4KICAqLwogYm9vbAotZ3Vlc3Rf
d2Fsa190YWJsZXMoc3RydWN0IHZjcHUgKnYsIHN0cnVjdCBwMm1fZG9tYWluICpwMm0sCi0gICAg
ICAgICAgICAgICAgICB1bnNpZ25lZCBsb25nIHZhLCB3YWxrX3QgKmd3LAotICAgICAgICAgICAg
ICAgICAgdWludDMyX3Qgd2FsaywgbWZuX3QgdG9wX21mbiwgdm9pZCAqdG9wX21hcCkKK2d1ZXN0
X3dhbGtfdGFibGVzKGNvbnN0IHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QgcDJtX2RvbWFpbiAqcDJt
LAorICAgICAgICAgICAgICAgICAgdW5zaWduZWQgbG9uZyB2YSwgd2Fsa190ICpndywgdWludDMy
X3Qgd2FsaywKKyAgICAgICAgICAgICAgICAgIGdmbl90IHRvcF9nZm4sIG1mbl90IHRvcF9tZm4s
IHZvaWQgKnRvcF9tYXApCiB7CiAgICAgc3RydWN0IGRvbWFpbiAqZCA9IHYtPmRvbWFpbjsKICAg
ICBndWVzdF9sMWVfdCAqbDFwID0gTlVMTDsKQEAgLTkwLDggKzkxLDEzIEBAIGd1ZXN0X3dhbGtf
dGFibGVzKHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QKICNpZiBHVUVTVF9QQUdJTkdfTEVWRUxTID49
IDQgLyogNjQtYml0IG9ubHkuLi4gKi8KICAgICBndWVzdF9sM2VfdCAqbDNwID0gTlVMTDsKICAg
ICBndWVzdF9sNGVfdCAqbDRwOworICAgIHBhZGRyX3QgbDRncGE7CisjZW5kaWYKKyNpZiBHVUVT
VF9QQUdJTkdfTEVWRUxTID49IDMgLyogUEFFIG9yIDY0Li4uICovCisgICAgcGFkZHJfdCBsM2dw
YTsKICNlbmRpZgogICAgIHVpbnQzMl90IGdmbGFncywgcmM7CisgICAgcGFkZHJfdCBsMWdwYSA9
IDAsIGwyZ3BhID0gMDsKICAgICB1bnNpZ25lZCBpbnQgbGVhZl9sZXZlbDsKICAgICBwMm1fcXVl
cnlfdCBxdCA9IFAyTV9BTExPQyB8IFAyTV9VTlNIQVJFOwogCkBAIC0xMzIsNyArMTM4LDEzIEBA
IGd1ZXN0X3dhbGtfdGFibGVzKHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QKICAgICAvKiBHZXQgdGhl
IGw0ZSBmcm9tIHRoZSB0b3AgbGV2ZWwgdGFibGUgYW5kIGNoZWNrIGl0cyBmbGFncyovCiAgICAg
Z3ctPmw0bWZuID0gdG9wX21mbjsKICAgICBsNHAgPSAoZ3Vlc3RfbDRlX3QgKikgdG9wX21hcDsK
LSAgICBndy0+bDRlID0gbDRwW2d1ZXN0X2w0X3RhYmxlX29mZnNldCh2YSldOworICAgIGw0Z3Bh
ID0gZ2ZuX3RvX2dhZGRyKHRvcF9nZm4pICsKKyAgICAgICAgICAgIGd1ZXN0X2w0X3RhYmxlX29m
ZnNldCh2YSkgKiBzaXplb2YoZ3ctPmw0ZSk7CisgICAgaWYgKCAhaHZtZW11bF9yZWFkX2NhY2hl
KHYsIGw0Z3BhLCAmZ3ctPmw0ZSwgc2l6ZW9mKGd3LT5sNGUpKSApCisgICAgeworICAgICAgICBn
dy0+bDRlID0gbDRwW2d1ZXN0X2w0X3RhYmxlX29mZnNldCh2YSldOworICAgICAgICBodm1lbXVs
X3dyaXRlX2NhY2hlKHYsIGw0Z3BhLCAmZ3ctPmw0ZSwgc2l6ZW9mKGd3LT5sNGUpKTsKKyAgICB9
CiAgICAgZ2ZsYWdzID0gZ3Vlc3RfbDRlX2dldF9mbGFncyhndy0+bDRlKTsKICAgICBpZiAoICEo
Z2ZsYWdzICYgX1BBR0VfUFJFU0VOVCkgKQogICAgICAgICBnb3RvIG91dDsKQEAgLTE2MSw3ICsx
NzMsMTMgQEAgZ3Vlc3Rfd2Fsa190YWJsZXMoc3RydWN0IHZjcHUgKnYsIHN0cnVjdAogICAgIH0K
IAogICAgIC8qIEdldCB0aGUgbDNlIGFuZCBjaGVjayBpdHMgZmxhZ3MqLwotICAgIGd3LT5sM2Ug
PSBsM3BbZ3Vlc3RfbDNfdGFibGVfb2Zmc2V0KHZhKV07CisgICAgbDNncGEgPSBnZm5fdG9fZ2Fk
ZHIoZ3Vlc3RfbDRlX2dldF9nZm4oZ3ctPmw0ZSkpICsKKyAgICAgICAgICAgIGd1ZXN0X2wzX3Rh
YmxlX29mZnNldCh2YSkgKiBzaXplb2YoZ3ctPmwzZSk7CisgICAgaWYgKCAhaHZtZW11bF9yZWFk
X2NhY2hlKHYsIGwzZ3BhLCAmZ3ctPmwzZSwgc2l6ZW9mKGd3LT5sM2UpKSApCisgICAgeworICAg
ICAgICBndy0+bDNlID0gbDNwW2d1ZXN0X2wzX3RhYmxlX29mZnNldCh2YSldOworICAgICAgICBo
dm1lbXVsX3dyaXRlX2NhY2hlKHYsIGwzZ3BhLCAmZ3ctPmwzZSwgc2l6ZW9mKGd3LT5sM2UpKTsK
KyAgICB9CiAgICAgZ2ZsYWdzID0gZ3Vlc3RfbDNlX2dldF9mbGFncyhndy0+bDNlKTsKICAgICBp
ZiAoICEoZ2ZsYWdzICYgX1BBR0VfUFJFU0VOVCkgKQogICAgICAgICBnb3RvIG91dDsKQEAgLTIx
Myw3ICsyMzEsMTQgQEAgZ3Vlc3Rfd2Fsa190YWJsZXMoc3RydWN0IHZjcHUgKnYsIHN0cnVjdAog
I2Vsc2UgLyogUEFFIG9ubHkuLi4gKi8KIAogICAgIC8qIEdldCB0aGUgbDNlIGFuZCBjaGVjayBp
dHMgZmxhZyAqLwotICAgIGd3LT5sM2UgPSAoKGd1ZXN0X2wzZV90ICopIHRvcF9tYXApW2d1ZXN0
X2wzX3RhYmxlX29mZnNldCh2YSldOworICAgIGwzZ3BhID0gZ2ZuX3RvX2dhZGRyKHRvcF9nZm4p
ICsgKCh1bnNpZ25lZCBsb25nKXRvcF9tYXAgJiB+UEFHRV9NQVNLKSArCisgICAgICAgICAgICBn
dWVzdF9sM190YWJsZV9vZmZzZXQodmEpICogc2l6ZW9mKGd3LT5sM2UpOworICAgIGlmICggIWh2
bWVtdWxfcmVhZF9jYWNoZSh2LCBsM2dwYSwgJmd3LT5sM2UsIHNpemVvZihndy0+bDNlKSkgKQor
ICAgIHsKKyAgICAgICAgZ3ctPmwzZSA9ICgoZ3Vlc3RfbDNlX3QgKil0b3BfbWFwKVtndWVzdF9s
M190YWJsZV9vZmZzZXQodmEpXTsKKyAgICAgICAgaHZtZW11bF93cml0ZV9jYWNoZSh2LCBsM2dw
YSwgJmd3LT5sM2UsIHNpemVvZihndy0+bDNlKSk7CisgICAgfQorCiAgICAgZ2ZsYWdzID0gZ3Vl
c3RfbDNlX2dldF9mbGFncyhndy0+bDNlKTsKICAgICBpZiAoICEoZ2ZsYWdzICYgX1BBR0VfUFJF
U0VOVCkgKQogICAgICAgICBnb3RvIG91dDsKQEAgLTIzOCwxOCArMjYzLDI0IEBAIGd1ZXN0X3dh
bGtfdGFibGVzKHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QKICAgICAgICAgZ290byBvdXQ7CiAgICAg
fQogCi0gICAgLyogR2V0IHRoZSBsMmUgKi8KLSAgICBndy0+bDJlID0gbDJwW2d1ZXN0X2wyX3Rh
YmxlX29mZnNldCh2YSldOworICAgIGwyZ3BhID0gZ2ZuX3RvX2dhZGRyKGd1ZXN0X2wzZV9nZXRf
Z2ZuKGd3LT5sM2UpKTsKIAogI2Vsc2UgLyogMzItYml0IG9ubHkuLi4gKi8KIAotICAgIC8qIEdl
dCBsMmUgZnJvbSB0aGUgdG9wIGxldmVsIHRhYmxlICovCiAgICAgZ3ctPmwybWZuID0gdG9wX21m
bjsKICAgICBsMnAgPSAoZ3Vlc3RfbDJlX3QgKikgdG9wX21hcDsKLSAgICBndy0+bDJlID0gbDJw
W2d1ZXN0X2wyX3RhYmxlX29mZnNldCh2YSldOworICAgIGwyZ3BhID0gZ2ZuX3RvX2dhZGRyKHRv
cF9nZm4pOwogCiAjZW5kaWYgLyogQWxsIGxldmVscy4uLiAqLwogCisgICAgLyogR2V0IHRoZSBs
MmUgKi8KKyAgICBsMmdwYSArPSBndWVzdF9sMl90YWJsZV9vZmZzZXQodmEpICogc2l6ZW9mKGd3
LT5sMmUpOworICAgIGlmICggIWh2bWVtdWxfcmVhZF9jYWNoZSh2LCBsMmdwYSwgJmd3LT5sMmUs
IHNpemVvZihndy0+bDJlKSkgKQorICAgIHsKKyAgICAgICAgZ3ctPmwyZSA9IGwycFtndWVzdF9s
Ml90YWJsZV9vZmZzZXQodmEpXTsKKyAgICAgICAgaHZtZW11bF93cml0ZV9jYWNoZSh2LCBsMmdw
YSwgJmd3LT5sMmUsIHNpemVvZihndy0+bDJlKSk7CisgICAgfQorCiAgICAgLyogQ2hlY2sgdGhl
IGwyZSBmbGFncy4gKi8KICAgICBnZmxhZ3MgPSBndWVzdF9sMmVfZ2V0X2ZsYWdzKGd3LT5sMmUp
OwogICAgIGlmICggIShnZmxhZ3MgJiBfUEFHRV9QUkVTRU5UKSApCkBAIC0zMzAsNyArMzYxLDE1
IEBAIGd1ZXN0X3dhbGtfdGFibGVzKHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QKICAgICAgICAgZ3ct
PnBmZWMgfD0gcmMgJiBQRkVDX3N5bnRoX21hc2s7CiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0K
LSAgICBndy0+bDFlID0gbDFwW2d1ZXN0X2wxX3RhYmxlX29mZnNldCh2YSldOworCisgICAgbDFn
cGEgPSBnZm5fdG9fZ2FkZHIoZ3Vlc3RfbDJlX2dldF9nZm4oZ3ctPmwyZSkpICsKKyAgICAgICAg
ICAgIGd1ZXN0X2wxX3RhYmxlX29mZnNldCh2YSkgKiBzaXplb2YoZ3ctPmwxZSk7CisgICAgaWYg
KCAhaHZtZW11bF9yZWFkX2NhY2hlKHYsIGwxZ3BhLCAmZ3ctPmwxZSwgc2l6ZW9mKGd3LT5sMWUp
KSApCisgICAgeworICAgICAgICBndy0+bDFlID0gbDFwW2d1ZXN0X2wxX3RhYmxlX29mZnNldCh2
YSldOworICAgICAgICBodm1lbXVsX3dyaXRlX2NhY2hlKHYsIGwxZ3BhLCAmZ3ctPmwxZSwgc2l6
ZW9mKGd3LT5sMWUpKTsKKyAgICB9CisKICAgICBnZmxhZ3MgPSBndWVzdF9sMWVfZ2V0X2ZsYWdz
KGd3LT5sMWUpOwogICAgIGlmICggIShnZmxhZ3MgJiBfUEFHRV9QUkVTRU5UKSApCiAgICAgICAg
IGdvdG8gb3V0OwpAQCAtNDQxLDIyICs0ODAsMzQgQEAgZ3Vlc3Rfd2Fsa190YWJsZXMoc3RydWN0
IHZjcHUgKnYsIHN0cnVjdAogICAgIGNhc2UgMToKICAgICAgICAgaWYgKCBzZXRfYWRfYml0cygm
bDFwW2d1ZXN0X2wxX3RhYmxlX29mZnNldCh2YSldLmwxLCAmZ3ctPmwxZS5sMSwKICAgICAgICAg
ICAgICAgICAgICAgICAgICAod2FsayAmIFBGRUNfd3JpdGVfYWNjZXNzKSkgKQorICAgICAgICB7
CiAgICAgICAgICAgICBwYWdpbmdfbWFya19kaXJ0eShkLCBndy0+bDFtZm4pOworICAgICAgICAg
ICAgaHZtZW11bF93cml0ZV9jYWNoZSh2LCBsMWdwYSwgJmd3LT5sMWUsIHNpemVvZihndy0+bDFl
KSk7CisgICAgICAgIH0KICAgICAgICAgLyogRmFsbHRocm91Z2ggKi8KICAgICBjYXNlIDI6CiAg
ICAgICAgIGlmICggc2V0X2FkX2JpdHMoJmwycFtndWVzdF9sMl90YWJsZV9vZmZzZXQodmEpXS5s
MiwgJmd3LT5sMmUubDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgKHdhbGsgJiBQRkVDX3dy
aXRlX2FjY2VzcykgJiYgbGVhZl9sZXZlbCA9PSAyKSApCisgICAgICAgIHsKICAgICAgICAgICAg
IHBhZ2luZ19tYXJrX2RpcnR5KGQsIGd3LT5sMm1mbik7CisgICAgICAgICAgICBodm1lbXVsX3dy
aXRlX2NhY2hlKHYsIGwyZ3BhLCAmZ3ctPmwyZSwgc2l6ZW9mKGd3LT5sMmUpKTsKKyAgICAgICAg
fQogICAgICAgICAvKiBGYWxsdGhyb3VnaCAqLwogI2lmIEdVRVNUX1BBR0lOR19MRVZFTFMgPT0g
NCAvKiA2NC1iaXQgb25seS4uLiAqLwogICAgIGNhc2UgMzoKICAgICAgICAgaWYgKCBzZXRfYWRf
Yml0cygmbDNwW2d1ZXN0X2wzX3RhYmxlX29mZnNldCh2YSldLmwzLCAmZ3ctPmwzZS5sMywKICAg
ICAgICAgICAgICAgICAgICAgICAgICAod2FsayAmIFBGRUNfd3JpdGVfYWNjZXNzKSAmJiBsZWFm
X2xldmVsID09IDMpICkKKyAgICAgICAgewogICAgICAgICAgICAgcGFnaW5nX21hcmtfZGlydHko
ZCwgZ3ctPmwzbWZuKTsKKyAgICAgICAgICAgIGh2bWVtdWxfd3JpdGVfY2FjaGUodiwgbDNncGEs
ICZndy0+bDNlLCBzaXplb2YoZ3ctPmwzZSkpOworICAgICAgICB9CiAKICAgICAgICAgaWYgKCBz
ZXRfYWRfYml0cygmbDRwW2d1ZXN0X2w0X3RhYmxlX29mZnNldCh2YSldLmw0LCAmZ3ctPmw0ZS5s
NCwKICAgICAgICAgICAgICAgICAgICAgICAgICBmYWxzZSkgKQorICAgICAgICB7CiAgICAgICAg
ICAgICBwYWdpbmdfbWFya19kaXJ0eShkLCBndy0+bDRtZm4pOworICAgICAgICAgICAgaHZtZW11
bF93cml0ZV9jYWNoZSh2LCBsNGdwYSwgJmd3LT5sNGUsIHNpemVvZihndy0+bDRlKSk7CisgICAg
ICAgIH0KICNlbmRpZgogICAgIH0KIAotLS0gYS94ZW4vYXJjaC94ODYvbW0vaGFwL2d1ZXN0X3dh
bGsuYworKysgYi94ZW4vYXJjaC94ODYvbW0vaGFwL2d1ZXN0X3dhbGsuYwpAQCAtOTEsNyArOTEs
OCBAQCB1bnNpZ25lZCBsb25nIGhhcF9wMm1fZ2FfdG9fZ2ZuKEdVRVNUX1BBCiAjaWYgR1VFU1Rf
UEFHSU5HX0xFVkVMUyA9PSAzCiAgICAgdG9wX21hcCArPSAoY3IzICYgfihQQUdFX01BU0sgfCAz
MSkpOwogI2VuZGlmCi0gICAgd2Fsa19vayA9IGd1ZXN0X3dhbGtfdGFibGVzKHYsIHAybSwgZ2Es
ICZndywgKnBmZWMsIHRvcF9tZm4sIHRvcF9tYXApOworICAgIHdhbGtfb2sgPSBndWVzdF93YWxr
X3RhYmxlcyh2LCBwMm0sIGdhLCAmZ3csICpwZmVjLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB0b3BfZ2ZuLCB0b3BfbWZuLCB0b3BfbWFwKTsKICAgICB1bm1hcF9kb21haW5fcGFn
ZSh0b3BfbWFwKTsKICAgICBwdXRfcGFnZSh0b3BfcGFnZSk7CiAKLS0tIGEveGVuL2FyY2gveDg2
L21tL3NoYWRvdy9tdWx0aS5jCisrKyBiL3hlbi9hcmNoL3g4Ni9tbS9zaGFkb3cvbXVsdGkuYwpA
QCAtMTc1LDkgKzE3NSwxMyBAQCBzdGF0aWMgaW5saW5lIGJvb2wKIHNoX3dhbGtfZ3Vlc3RfdGFi
bGVzKHN0cnVjdCB2Y3B1ICp2LCB1bnNpZ25lZCBsb25nIHZhLCB3YWxrX3QgKmd3LAogICAgICAg
ICAgICAgICAgICAgICAgdWludDMyX3QgcGZlYykKIHsKKyAgICBnZm5fdCByb290X2dmbiA9IF9n
Zm4ocGFnaW5nX21vZGVfZXh0ZXJuYWwodi0+ZG9tYWluKQorICAgICAgICAgICAgICAgICAgICAg
ICAgICA/IGNyM19wYSh2LT5hcmNoLmh2bS5ndWVzdF9jclszXSkgPj4gUEFHRV9TSElGVAorICAg
ICAgICAgICAgICAgICAgICAgICAgICA6IHBhZ2V0YWJsZV9nZXRfcGZuKHYtPmFyY2guZ3Vlc3Rf
dGFibGUpKTsKKwogI2lmIEdVRVNUX1BBR0lOR19MRVZFTFMgPT0gMyAvKiBQQUUgKi8KICAgICBy
ZXR1cm4gZ3Vlc3Rfd2Fsa190YWJsZXModiwgcDJtX2dldF9ob3N0cDJtKHYtPmRvbWFpbiksIHZh
LCBndywgcGZlYywKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSU5WQUxJRF9NRk4sIHYt
PmFyY2gucGFnaW5nLnNoYWRvdy5nbDNlKTsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
cm9vdF9nZm4sIElOVkFMSURfTUZOLCB2LT5hcmNoLnBhZ2luZy5zaGFkb3cuZ2wzZSk7CiAjZWxz
ZSAvKiAzMiBvciA2NCAqLwogICAgIGNvbnN0IHN0cnVjdCBkb21haW4gKmQgPSB2LT5kb21haW47
CiAgICAgbWZuX3Qgcm9vdF9tZm4gPSAodi0+YXJjaC5mbGFncyAmIFRGX2tlcm5lbF9tb2RlCkBA
IC0xODUsNyArMTg5LDcgQEAgc2hfd2Fsa19ndWVzdF90YWJsZXMoc3RydWN0IHZjcHUgKnYsIHVu
cwogICAgICAgICAgICAgICAgICAgICAgIDogcGFnZXRhYmxlX2dldF9tZm4odi0+YXJjaC5ndWVz
dF90YWJsZV91c2VyKSk7CiAgICAgdm9pZCAqcm9vdF9tYXAgPSBtYXBfZG9tYWluX3BhZ2Uocm9v
dF9tZm4pOwogICAgIGJvb2wgb2sgPSBndWVzdF93YWxrX3RhYmxlcyh2LCBwMm1fZ2V0X2hvc3Rw
Mm0oZCksIHZhLCBndywgcGZlYywKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9v
dF9tZm4sIHJvb3RfbWFwKTsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vdF9n
Zm4sIHJvb3RfbWZuLCByb290X21hcCk7CiAKICAgICB1bm1hcF9kb21haW5fcGFnZShyb290X21h
cCk7CiAKLS0tIGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9ndWVzdF9wdC5oCisrKyBiL3hlbi9pbmNs
dWRlL2FzbS14ODYvZ3Vlc3RfcHQuaApAQCAtNDI4LDggKzQyOCw5IEBAIHN0YXRpYyBpbmxpbmUg
dW5zaWduZWQgaW50IGd1ZXN0X3dhbGtfdG8KICNkZWZpbmUgZ3Vlc3Rfd2Fsa190YWJsZXMgR1BU
X1JFTkFNRShndWVzdF93YWxrX3RhYmxlcywgR1VFU1RfUEFHSU5HX0xFVkVMUykKIAogYm9vbAot
Z3Vlc3Rfd2Fsa190YWJsZXMoc3RydWN0IHZjcHUgKnYsIHN0cnVjdCBwMm1fZG9tYWluICpwMm0s
IHVuc2lnbmVkIGxvbmcgdmEsCi0gICAgICAgICAgICAgICAgICB3YWxrX3QgKmd3LCB1aW50MzJf
dCBwZmVjLCBtZm5fdCB0b3BfbWZuLCB2b2lkICp0b3BfbWFwKTsKK2d1ZXN0X3dhbGtfdGFibGVz
KGNvbnN0IHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QgcDJtX2RvbWFpbiAqcDJtLAorICAgICAgICAg
ICAgICAgICAgdW5zaWduZWQgbG9uZyB2YSwgd2Fsa190ICpndywgdWludDMyX3QgcGZlYywKKyAg
ICAgICAgICAgICAgICAgIGdmbl90IHRvcF9nZm4sIG1mbl90IHRvcF9tZm4sIHZvaWQgKnRvcF9t
YXApOwogCiAvKiBQcmV0dHktcHJpbnQgdGhlIGNvbnRlbnRzIG9mIGEgZ3Vlc3Qtd2FsayAqLwog
c3RhdGljIGlubGluZSB2b2lkIHByaW50X2d3KGNvbnN0IHdhbGtfdCAqZ3cpCi0tLSBhL3hlbi9p
bmNsdWRlL2FzbS14ODYvaHZtL2VtdWxhdGUuaAorKysgYi94ZW4vaW5jbHVkZS9hc20teDg2L2h2
bS9lbXVsYXRlLmgKQEAgLTEyOSw2ICsxMjksMTIgQEAgc3RhdGljIGlubGluZSBib29sIGh2bWVt
dWxfY2FjaGVfZGlzYWJsZQogewogICAgIHJldHVybiBodm1lbXVsX2NhY2hlX2Rpc2FibGUodikg
PT0gaHZtZW11bF9jYWNoZV9kaXNhYmxlKHYpOwogfQorI2Vsc2UKK3N0YXRpYyBpbmxpbmUgYm9v
bCBodm1lbXVsX3JlYWRfY2FjaGUoY29uc3Qgc3RydWN0IHZjcHUgKnYsIHBhZGRyX3QgZ3BhLAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpidWYsCisgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBzaXplKSB7IHJldHVy
biBmYWxzZTsgfQorc3RhdGljIGlubGluZSB2b2lkIGh2bWVtdWxfd3JpdGVfY2FjaGUoY29uc3Qg
c3RydWN0IHZjcHUgKnYsIHBhZGRyX3QgZ3BhLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgY29uc3Qgdm9pZCAqYnVmLCB1bnNpZ25lZCBpbnQgc2l6ZSkge30KICNlbmRp
ZgogCiB2b2lkIGh2bV9kdW1wX2VtdWxhdGlvbl9zdGF0ZShjb25zdCBjaGFyICpsb2dsdmwsIGNv
bnN0IGNoYXIgKnByZWZpeCwKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2pl
Y3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4t
ZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 315FB17608
	for <lists+xen-devel@lfdr.de>; Wed,  8 May 2019 12:33:29 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hOJoG-0000Xx-Cq; Wed, 08 May 2019 10:28:24 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=H56U=TI=citrix.com=prvs=024837179=ross.lagerwall@srs-us1.protection.inumbo.net>)
 id 1hOJoF-0000Xs-Je
 for xen-devel@lists.xenproject.org; Wed, 08 May 2019 10:28:23 +0000
X-Inumbo-ID: 00a5f9b8-717c-11e9-843c-bc764e045a96
Received: from SMTP03.CITRIX.COM (unknown [162.221.156.55])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 00a5f9b8-717c-11e9-843c-bc764e045a96;
 Wed, 08 May 2019 10:28:21 +0000 (UTC)
X-IronPort-AV: E=Sophos;i="5.60,445,1549929600"; d="scan'208";a="85259235"
From: Ross Lagerwall <ross.lagerwall@citrix.com>
To: Boris Ostrovsky <boris.ostrovsky@oracle.com>, Juergen Gross
 <jgross@suse.com>
Date: Wed, 8 May 2019 11:28:07 +0100
Message-ID: <20190508102807.7096-1-ross.lagerwall@citrix.com>
X-Mailer: git-send-email 2.17.2
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH] xenbus: Avoid deadlock during suspend due to
 open transactions
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: xen-devel@lists.xenproject.org, Ross Lagerwall <ross.lagerwall@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

RHVyaW5nIGEgc3VzcGVuZC9yZXN1bWUsIHRoZSB4ZW53YXRjaCB0aHJlYWQgd2FpdHMgZm9yIGFs
bCBvdXRzdGFuZGluZwp4ZW5zdG9yZSByZXF1ZXN0cyBhbmQgdHJhbnNhY3Rpb25zIHRvIGNvbXBs
ZXRlLiBUaGlzIGRvZXMgbm90IHdvcmsKY29ycmVjdGx5IGZvciB0cmFuc2FjdGlvbnMgc3RhcnRl
ZCBieSB1c2Vyc3BhY2UgYmVjYXVzZSBpdCB3YWl0cyBmb3IKdGhlbSB0byBjb21wbGV0ZSBhZnRl
ciBmcmVlemluZyB1c2Vyc3BhY2UgdGhyZWFkcyB3aGljaCBtZWFucyB0aGUKdHJhbnNhY3Rpb25z
IGhhcyBubyB3YXkgb2YgY29tcGxldGluZywgcmVzdWx0aW5nIGluIGEgZGVhZGxvY2suIFRoaXMg
aXMKdHJpdmlhbCB0byByZXByb2R1Y2UgYnkgcnVubmluZyB0aGlzIHNjcmlwdCBhbmQgdGhlbiBz
dXNwZW5kaW5nIHRoZSBWTToKCiAgICBpbXBvcnQgcHl4cywgdGltZQogICAgYyA9IHB5eHMuY2xp
ZW50LkNsaWVudCh4ZW5fYnVzX3BhdGg9Ii9kZXYveGVuL3hlbmJ1cyIpCiAgICBjLmNvbm5lY3Qo
KQogICAgYy50cmFuc2FjdGlvbigpCiAgICB0aW1lLnNsZWVwKDM2MDApCgpFdmVuIGlmIHRoaXMg
ZGVhZGxvY2sgd2VyZSByZXNvbHZlZCwgbWlzYmVoYXZpbmcgdXNlcnNwYWNlIHNob3VsZCBub3QK
cHJldmVudCBhIFZNIGZyb20gYmVpbmcgbWlncmF0ZWQuIFNvLCBpbnN0ZWFkIG9mIHdhaXRpbmcg
Zm9yIHRoZXNlCnRyYW5zYWN0aW9ucyB0byBjb21wbGV0ZSwgaWdub3JlIHRoZW0gZHVyaW5nIHN1
c3BlbmQgYW5kIG1hcmsgdGhlbSBhcwphYm9ydGVkIGR1cmluZyB0aGUgcmV0dXJuIHBhdGguIElm
IHRoZSBjYWxsZXIgY29tbWl0cyB0aGUgdHJhbnNhY3Rpb24sCnJldHVybiBFQUdBSU4gc28gdGhh
dCB0aGV5IHRyeSBhZ2Fpbi4gSWYgdGhlIGNhbGxlciBkaXNjYXJkcyB0aGUKdHJhbnNhY3Rpb24s
IHJldHVybiBPSyBzaW5jZSBubyBjaGFuZ2VzIHdlcmUgbWFkZSBhbnl3YXkuCgpUaGlzIG9ubHkg
YWZmZWN0cyB1c2VycyBvZiB0aGUgeGVuYnVzIGZpbGUgaW50ZXJmYWNlLiBJbi1rZXJuZWwgdXNl
cnMgb2YKeGVuYnVzIGFyZSBhc3N1bWVkIHRvIGJlIHdlbGwtYmVoYXZlZCBhbmQgY29tcGxldGUg
YWxsIHRyYW5zYWN0aW9ucwpiZWZvcmUgZnJlZXppbmcuCgpTaWduZWQtb2ZmLWJ5OiBSb3NzIExh
Z2Vyd2FsbCA8cm9zcy5sYWdlcndhbGxAY2l0cml4LmNvbT4KLS0tCiBkcml2ZXJzL3hlbi94ZW5i
dXMveGVuYnVzLmggICAgICAgICAgICAgIHwgIDIgKwogZHJpdmVycy94ZW4veGVuYnVzL3hlbmJ1
c19kZXZfZnJvbnRlbmQuYyB8IDYwICsrKysrKysrKysrKysrKysrKysrKysrKwogZHJpdmVycy94
ZW4veGVuYnVzL3hlbmJ1c194cy5jICAgICAgICAgICB8IDE2ICsrKysrKy0KIDMgZmlsZXMgY2hh
bmdlZCwgNzcgaW5zZXJ0aW9ucygrKSwgMSBkZWxldGlvbigtKQoKZGlmZiAtLWdpdCBhL2RyaXZl
cnMveGVuL3hlbmJ1cy94ZW5idXMuaCBiL2RyaXZlcnMveGVuL3hlbmJ1cy94ZW5idXMuaAppbmRl
eCAwOTI5ODExNzFkZjEuLmE5NzdlMTM5NjE0OSAxMDA2NDQKLS0tIGEvZHJpdmVycy94ZW4veGVu
YnVzL3hlbmJ1cy5oCisrKyBiL2RyaXZlcnMveGVuL3hlbmJ1cy94ZW5idXMuaApAQCAtMTMzLDQg
KzEzMyw2IEBAIHZvaWQgeGVuYnVzX3Jpbmdfb3BzX2luaXQodm9pZCk7CiBpbnQgeGVuYnVzX2Rl
dl9yZXF1ZXN0X2FuZF9yZXBseShzdHJ1Y3QgeHNkX3NvY2ttc2cgKm1zZywgdm9pZCAqcGFyKTsK
IHZvaWQgeGVuYnVzX2Rldl9xdWV1ZV9yZXBseShzdHJ1Y3QgeGJfcmVxX2RhdGEgKnJlcSk7CiAK
K3Vuc2lnbmVkIGludCB4ZW5idXNfZmlsZV9hYm9ydF90cmFucyhib29sIGFib3J0KTsKKwogI2Vu
ZGlmCmRpZmYgLS1naXQgYS9kcml2ZXJzL3hlbi94ZW5idXMveGVuYnVzX2Rldl9mcm9udGVuZC5j
IGIvZHJpdmVycy94ZW4veGVuYnVzL3hlbmJ1c19kZXZfZnJvbnRlbmQuYwppbmRleCAwNzgyZmYz
YzIyNzMuLjYyMzIxOGEyYTE2NSAxMDA2NDQKLS0tIGEvZHJpdmVycy94ZW4veGVuYnVzL3hlbmJ1
c19kZXZfZnJvbnRlbmQuYworKysgYi9kcml2ZXJzL3hlbi94ZW5idXMveGVuYnVzX2Rldl9mcm9u
dGVuZC5jCkBAIC02OSw2ICs2OSw3IEBACiBzdHJ1Y3QgeGVuYnVzX3RyYW5zYWN0aW9uX2hvbGRl
ciB7CiAJc3RydWN0IGxpc3RfaGVhZCBsaXN0OwogCXN0cnVjdCB4ZW5idXNfdHJhbnNhY3Rpb24g
aGFuZGxlOworCWJvb2wgYWJvcnRlZDsKIH07CiAKIC8qCkBAIC0xMTMsOCArMTE0LDQ5IEBAIHN0
cnVjdCB4ZW5idXNfZmlsZV9wcml2IHsKIAl3YWl0X3F1ZXVlX2hlYWRfdCByZWFkX3dhaXRxOwog
CiAJc3RydWN0IGtyZWYga3JlZjsKKworCXN0cnVjdCBsaXN0X2hlYWQgZmlsZV9saXN0OwogfTsK
IAorc3RhdGljIERFRklORV9TUElOTE9DSyhmaWxlX2xpc3RfbG9jayk7CitzdGF0aWMgTElTVF9I
RUFEKGZpbGVfbGlzdCk7CisKK3N0YXRpYyB2b2lkIHJlZ2lzdGVyX3hlbmJ1c19maWxlKHN0cnVj
dCB4ZW5idXNfZmlsZV9wcml2ICp1KQoreworCXNwaW5fbG9jaygmZmlsZV9saXN0X2xvY2spOwor
CWxpc3RfYWRkKCZ1LT5maWxlX2xpc3QsICZmaWxlX2xpc3QpOworCXNwaW5fdW5sb2NrKCZmaWxl
X2xpc3RfbG9jayk7Cit9CisKK3N0YXRpYyB2b2lkIHVucmVnaXN0ZXJfeGVuYnVzX2ZpbGUoc3Ry
dWN0IHhlbmJ1c19maWxlX3ByaXYgKnUpCit7CisJc3Bpbl9sb2NrKCZmaWxlX2xpc3RfbG9jayk7
CisJbGlzdF9kZWwoJnUtPmZpbGVfbGlzdCk7CisJc3Bpbl91bmxvY2soJmZpbGVfbGlzdF9sb2Nr
KTsKK30KKwordW5zaWduZWQgaW50IHhlbmJ1c19maWxlX2Fib3J0X3RyYW5zKGJvb2wgYWJvcnQp
Cit7CisJc3RydWN0IHhlbmJ1c19maWxlX3ByaXYgKnU7CisJc3RydWN0IHhlbmJ1c190cmFuc2Fj
dGlvbl9ob2xkZXIgKnRyYW5zOworCXVuc2lnbmVkIGludCBjb3VudCA9IDA7CisKKwlzcGluX2xv
Y2soJmZpbGVfbGlzdF9sb2NrKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5KHUsICZmaWxlX2xpc3Qs
IGZpbGVfbGlzdCkgeworCQltdXRleF9sb2NrKCZ1LT5tc2didWZmZXJfbXV0ZXgpOworCQlsaXN0
X2Zvcl9lYWNoX2VudHJ5KHRyYW5zLCAmdS0+dHJhbnNhY3Rpb25zLCBsaXN0KSB7CisJCQlpZiAo
IXRyYW5zLT5hYm9ydGVkKSB7CisJCQkJY291bnQrKzsKKwkJCQl0cmFucy0+YWJvcnRlZCA9IGFi
b3J0OworCQkJfQorCQl9CisJCW11dGV4X3VubG9jaygmdS0+bXNnYnVmZmVyX211dGV4KTsKKwl9
CisJc3Bpbl91bmxvY2soJmZpbGVfbGlzdF9sb2NrKTsKKworCXJldHVybiBjb3VudDsKK30KKwog
LyogUmVhZCBvdXQgYW55IHJhdyB4ZW5idXMgbWVzc2FnZXMgcXVldWVkIHVwLiAqLwogc3RhdGlj
IHNzaXplX3QgeGVuYnVzX2ZpbGVfcmVhZChzdHJ1Y3QgZmlsZSAqZmlscCwKIAkJCSAgICAgICBj
aGFyIF9fdXNlciAqdWJ1ZiwKQEAgLTMwNiw2ICszNDgsOCBAQCBzdGF0aWMgdm9pZCB4ZW5idXNf
ZmlsZV9mcmVlKHN0cnVjdCBrcmVmICprcmVmKQogCiAJdSA9IGNvbnRhaW5lcl9vZihrcmVmLCBz
dHJ1Y3QgeGVuYnVzX2ZpbGVfcHJpdiwga3JlZik7CiAKKwl1bnJlZ2lzdGVyX3hlbmJ1c19maWxl
KHUpOworCiAJLyoKIAkgKiBObyBuZWVkIGZvciBsb2NraW5nIGhlcmUgYmVjYXVzZSB0aGVyZSBh
cmUgbm8gb3RoZXIgdXNlcnMsCiAJICogYnkgZGVmaW5pdGlvbi4KQEAgLTQ0OSw2ICs0OTMsMjAg
QEAgc3RhdGljIGludCB4ZW5idXNfd3JpdGVfdHJhbnNhY3Rpb24odW5zaWduZWQgbXNnX3R5cGUs
CiAJCSAhKG1zZy0+aGRyLmxlbiA9PSAyICYmCiAJCSAgICghc3RyY21wKG1zZy0+Ym9keSwgIlQi
KSB8fCAhc3RyY21wKG1zZy0+Ym9keSwgIkYiKSkpKQogCQlyZXR1cm4geGVuYnVzX2NvbW1hbmRf
cmVwbHkodSwgWFNfRVJST1IsICJFSU5WQUwiKTsKKwllbHNlIGlmIChtc2dfdHlwZSA9PSBYU19U
UkFOU0FDVElPTl9FTkQpIHsKKwkJdHJhbnMgPSB4ZW5idXNfZ2V0X3RyYW5zYWN0aW9uKHUsIG1z
Zy0+aGRyLnR4X2lkKTsKKwkJaWYgKHRyYW5zICYmIHRyYW5zLT5hYm9ydGVkKSB7CisJCQlsaXN0
X2RlbCgmdHJhbnMtPmxpc3QpOworCQkJa2ZyZWUodHJhbnMpOworCQkJaWYgKCFzdHJjbXAobXNn
LT5ib2R5LCAiVCIpKQorCQkJCXJldHVybiB4ZW5idXNfY29tbWFuZF9yZXBseSh1LCBYU19FUlJP
UiwKKwkJCQkJCQkgICAgIkVBR0FJTiIpOworCQkJZWxzZQorCQkJCXJldHVybiB4ZW5idXNfY29t
bWFuZF9yZXBseSh1LAorCQkJCQkJCSAgICBYU19UUkFOU0FDVElPTl9FTkQsCisJCQkJCQkJICAg
ICJPSyIpOworCQl9CisJfQogCiAJcmMgPSB4ZW5idXNfZGV2X3JlcXVlc3RfYW5kX3JlcGx5KCZt
c2ctPmhkciwgdSk7CiAJaWYgKHJjICYmIHRyYW5zKSB7CkBAIC02NDAsNiArNjk4LDggQEAgc3Rh
dGljIGludCB4ZW5idXNfZmlsZV9vcGVuKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxl
ICpmaWxwKQogCiAJZmlscC0+cHJpdmF0ZV9kYXRhID0gdTsKIAorCXJlZ2lzdGVyX3hlbmJ1c19m
aWxlKHUpOworCiAJcmV0dXJuIDA7CiB9CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMveGVuL3hlbmJ1
cy94ZW5idXNfeHMuYyBiL2RyaXZlcnMveGVuL3hlbmJ1cy94ZW5idXNfeHMuYwppbmRleCA0OWEz
ODc0YWU2YmIuLjlhYmZmNjM1ZmMyMCAxMDA2NDQKLS0tIGEvZHJpdmVycy94ZW4veGVuYnVzL3hl
bmJ1c194cy5jCisrKyBiL2RyaXZlcnMveGVuL3hlbmJ1cy94ZW5idXNfeHMuYwpAQCAtOTUsMTIg
Kzk1LDIzIEBAIHN0YXRpYyBwaWRfdCB4ZW53YXRjaF9waWQ7CiBzdGF0aWMgREVGSU5FX01VVEVY
KHhlbndhdGNoX211dGV4KTsKIHN0YXRpYyBERUNMQVJFX1dBSVRfUVVFVUVfSEVBRCh3YXRjaF9l
dmVudHNfd2FpdHEpOwogCitzdGF0aWMgdW5zaWduZWQgaW50IHhzX3N0YXRlX2NvdW50X3VzZXJz
KHZvaWQpCit7CisJdW5zaWduZWQgaW50IGNvdW50OworCisJc3Bpbl9sb2NrKCZ4c19zdGF0ZV9s
b2NrKTsKKwljb3VudCA9IHhzX3N0YXRlX3VzZXJzIC0geGVuYnVzX2ZpbGVfYWJvcnRfdHJhbnMo
ZmFsc2UpOworCXNwaW5fdW5sb2NrKCZ4c19zdGF0ZV9sb2NrKTsKKworCXJldHVybiBjb3VudDsK
K30KKwogc3RhdGljIHZvaWQgeHNfc3VzcGVuZF9lbnRlcih2b2lkKQogewogCXNwaW5fbG9jaygm
eHNfc3RhdGVfbG9jayk7CiAJeHNfc3VzcGVuZF9hY3RpdmUrKzsKIAlzcGluX3VubG9jaygmeHNf
c3RhdGVfbG9jayk7Ci0Jd2FpdF9ldmVudCh4c19zdGF0ZV9leGl0X3dxLCB4c19zdGF0ZV91c2Vy
cyA9PSAwKTsKKwl3YWl0X2V2ZW50KHhzX3N0YXRlX2V4aXRfd3EsIHhzX3N0YXRlX2NvdW50X3Vz
ZXJzKCkgPT0gMCk7CiB9CiAKIHN0YXRpYyB2b2lkIHhzX3N1c3BlbmRfZXhpdCh2b2lkKQpAQCAt
ODM4LDYgKzg0OSw5IEBAIHZvaWQgeHNfcmVzdW1lKHZvaWQpCiAKIAltdXRleF91bmxvY2soJnhz
X3Jlc3BvbnNlX211dGV4KTsKIAorCXNwaW5fbG9jaygmeHNfc3RhdGVfbG9jayk7CisJeHNfc3Rh
dGVfdXNlcnMgLT0geGVuYnVzX2ZpbGVfYWJvcnRfdHJhbnModHJ1ZSk7CisJc3Bpbl91bmxvY2so
JnhzX3N0YXRlX2xvY2spOwogCXhzX3N1c3BlbmRfZXhpdCgpOwogCiAJLyogTm8gbmVlZCBmb3Ig
d2F0Y2hlc19sb2NrOiB0aGUgeHNfd2F0Y2hfcndzZW0gaXMgc3VmZmljaWVudC4gKi8KLS0gCjIu
MTcuMgoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhl
bi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBz
Oi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

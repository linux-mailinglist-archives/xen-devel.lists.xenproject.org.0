Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id CED3BB473E
	for <lists+xen-devel@lfdr.de>; Tue, 17 Sep 2019 08:16:51 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iA6lQ-0000t8-5U; Tue, 17 Sep 2019 06:15:00 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=+VJ/=XM=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1iA6lO-0000sm-EI
 for xen-devel@lists.xenproject.org; Tue, 17 Sep 2019 06:14:58 +0000
X-Inumbo-ID: 78cf2e12-d912-11e9-978d-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 78cf2e12-d912-11e9-978d-bc764e2007e4;
 Tue, 17 Sep 2019 06:14:57 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id B5DF0AC93;
 Tue, 17 Sep 2019 06:14:56 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <625c29ba-cfb8-88ee-eb15-5f2019198865@suse.com>
Message-ID: <8e2aae32-917c-8035-1aef-8b47c321e42b@suse.com>
Date: Tue, 17 Sep 2019 08:15:01 +0200
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.9.0
MIME-Version: 1.0
In-Reply-To: <625c29ba-cfb8-88ee-eb15-5f2019198865@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v2 4/9] x86/HVM: move NOFLUSH handling out of
 hvm_set_cr3()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Kevin Tian <kevin.tian@intel.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>, Wei Liu <wl@xen.org>,
 Paul Durrant <paul@xen.org>, George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Jun Nakajima <jun.nakajima@intel.com>,
 Boris Ostrovsky <boris.ostrovsky@oracle.com>,
 =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhlIGJpdCBpcyBtZWFuaW5nZnVsIG9ubHkgZm9yIE1PVi10by1DUjMgaW5zbnMsIG5vdCBhbnl3
aGVyZSBlbHNlLCBpbgpwYXJ0aWN1bGFyIG5vdCB3aGVuIGxvYWRpbmcgbmVzdGVkIGd1ZXN0IHN0
YXRlLgoKU2lnbmVkLW9mZi1ieTogSmFuIEJldWxpY2ggPGpiZXVsaWNoQHN1c2UuY29tPgoKLS0t
IGEveGVuL2FyY2gveDg2L2h2bS9lbXVsYXRlLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS9lbXVs
YXRlLmMKQEAgLTIwODAsNiArMjA4MCw4IEBAIHN0YXRpYyBpbnQgaHZtZW11bF93cml0ZV9jcigK
ICAgICBIVk1UUkFDRV9MT05HXzJEKENSX1dSSVRFLCByZWcsIFRSQ19QQVJfTE9ORyh2YWwpKTsK
ICAgICBzd2l0Y2ggKCByZWcgKQogICAgIHsKKyAgICAgICAgYm9vbCBub2ZsdXNoOworCiAgICAg
Y2FzZSAwOgogICAgICAgICByYyA9IGh2bV9zZXRfY3IwKHZhbCwgdHJ1ZSk7CiAgICAgICAgIGJy
ZWFrOwpAQCAtMjA5MCw3ICsyMDkyLDEwIEBAIHN0YXRpYyBpbnQgaHZtZW11bF93cml0ZV9jcigK
ICAgICAgICAgYnJlYWs7CiAKICAgICBjYXNlIDM6Ci0gICAgICAgIHJjID0gaHZtX3NldF9jcjMo
dmFsLCB0cnVlKTsKKyAgICAgICAgbm9mbHVzaCA9IGh2bV9wY2lkX2VuYWJsZWQoY3VycmVudCkg
JiYgKHZhbCAmIFg4Nl9DUjNfTk9GTFVTSCk7CisgICAgICAgIGlmICggbm9mbHVzaCApCisgICAg
ICAgICAgICB2YWwgJj0gflg4Nl9DUjNfTk9GTFVTSDsKKyAgICAgICAgcmMgPSBodm1fc2V0X2Ny
Myh2YWwsIG5vZmx1c2gsIHRydWUpOwogICAgICAgICBicmVhazsKIAogICAgIGNhc2UgNDoKLS0t
IGEveGVuL2FyY2gveDg2L2h2bS9odm0uYworKysgYi94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCkBA
IC0yMDU5LDEyICsyMDU5LDE3IEBAIGludCBodm1fbW92X3RvX2NyKHVuc2lnbmVkIGludCBjciwg
dW5zaWcKIAogICAgIHN3aXRjaCAoIGNyICkKICAgICB7CisgICAgICAgIGJvb2wgbm9mbHVzaDsK
KwogICAgIGNhc2UgMDoKICAgICAgICAgcmMgPSBodm1fc2V0X2NyMCh2YWwsIHRydWUpOwogICAg
ICAgICBicmVhazsKIAogICAgIGNhc2UgMzoKLSAgICAgICAgcmMgPSBodm1fc2V0X2NyMyh2YWws
IHRydWUpOworICAgICAgICBub2ZsdXNoID0gaHZtX3BjaWRfZW5hYmxlZChjdXJyKSAmJiAodmFs
ICYgWDg2X0NSM19OT0ZMVVNIKTsKKyAgICAgICAgaWYgKCBub2ZsdXNoICkKKyAgICAgICAgICAg
IHZhbCAmPSB+WDg2X0NSM19OT0ZMVVNIOworICAgICAgICByYyA9IGh2bV9zZXRfY3IzKHZhbCwg
bm9mbHVzaCwgdHJ1ZSk7CiAgICAgICAgIGJyZWFrOwogCiAgICAgY2FzZSA0OgpAQCAtMjI4Miwx
MiArMjI4NywxMSBAQCBpbnQgaHZtX3NldF9jcjAodW5zaWduZWQgbG9uZyB2YWx1ZSwgYm9vCiAg
ICAgcmV0dXJuIFg4NkVNVUxfT0tBWTsKIH0KIAotaW50IGh2bV9zZXRfY3IzKHVuc2lnbmVkIGxv
bmcgdmFsdWUsIGJvb2wgbWF5X2RlZmVyKQoraW50IGh2bV9zZXRfY3IzKHVuc2lnbmVkIGxvbmcg
dmFsdWUsIGJvb2wgbm9mbHVzaCwgYm9vbCBtYXlfZGVmZXIpCiB7CiAgICAgc3RydWN0IHZjcHUg
KnYgPSBjdXJyZW50OwogICAgIHN0cnVjdCBwYWdlX2luZm8gKnBhZ2U7CiAgICAgdW5zaWduZWQg
bG9uZyBvbGQgPSB2LT5hcmNoLmh2bS5ndWVzdF9jclszXTsKLSAgICBib29sIG5vZmx1c2ggPSBm
YWxzZTsKIAogICAgIGlmICggbWF5X2RlZmVyICYmIHVubGlrZWx5KHYtPmRvbWFpbi0+YXJjaC5t
b25pdG9yLndyaXRlX2N0cmxyZWdfZW5hYmxlZCAmCiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgbW9uaXRvcl9jdHJscmVnX2JpdG1hc2soVk1fRVZFTlRfWDg2X0NSMykpICkKQEAgLTIy
OTksMTcgKzIzMDMsMTIgQEAgaW50IGh2bV9zZXRfY3IzKHVuc2lnbmVkIGxvbmcgdmFsdWUsIGJv
bwogICAgICAgICAgICAgLyogVGhlIGFjdHVhbCB3cml0ZSB3aWxsIG9jY3VyIGluIGh2bV9kb19y
ZXN1bWUoKSwgaWYgcGVybWl0dGVkLiAqLwogICAgICAgICAgICAgdi0+YXJjaC52bV9ldmVudC0+
d3JpdGVfZGF0YS5kb193cml0ZS5jcjMgPSAxOwogICAgICAgICAgICAgdi0+YXJjaC52bV9ldmVu
dC0+d3JpdGVfZGF0YS5jcjMgPSB2YWx1ZTsKKyAgICAgICAgICAgIHYtPmFyY2gudm1fZXZlbnQt
PndyaXRlX2RhdGEuY3IzX25vZmx1c2ggPSBub2ZsdXNoOwogCiAgICAgICAgICAgICByZXR1cm4g
WDg2RU1VTF9PS0FZOwogICAgICAgICB9CiAgICAgfQogCi0gICAgaWYgKCBodm1fcGNpZF9lbmFi
bGVkKHYpICkgLyogQ2xlYXIgdGhlIG5vZmx1c2ggYml0LiAqLwotICAgIHsKLSAgICAgICAgbm9m
bHVzaCA9IHZhbHVlICYgWDg2X0NSM19OT0ZMVVNIOwotICAgICAgICB2YWx1ZSAmPSB+WDg2X0NS
M19OT0ZMVVNIOwotICAgIH0KLQogICAgIGlmICggaHZtX3BhZ2luZ19lbmFibGVkKHYpICYmICFw
YWdpbmdfbW9kZV9oYXAodi0+ZG9tYWluKSAmJgogICAgICAgICAgKHZhbHVlICE9IHYtPmFyY2gu
aHZtLmd1ZXN0X2NyWzNdKSApCiAgICAgewpAQCAtMzAwNCw3ICszMDAzLDcgQEAgdm9pZCBodm1f
dGFza19zd2l0Y2goCiAgICAgaWYgKCB0YXNrX3N3aXRjaF9sb2FkX3NlZyh4ODZfc2VnX2xkdHIs
IHRzcy5sZHQsIG5ld19jcGwsIDApICkKICAgICAgICAgZ290byBvdXQ7CiAKLSAgICByYyA9IGh2
bV9zZXRfY3IzKHRzcy5jcjMsIHRydWUpOworICAgIHJjID0gaHZtX3NldF9jcjModHNzLmNyMywg
ZmFsc2UsIHRydWUpOwogICAgIGlmICggcmMgPT0gWDg2RU1VTF9FWENFUFRJT04gKQogICAgICAg
ICBodm1faW5qZWN0X2h3X2V4Y2VwdGlvbihUUkFQX2dwX2ZhdWx0LCAwKTsKICAgICBpZiAoIHJj
ICE9IFg4NkVNVUxfT0tBWSApCi0tLSBhL3hlbi9hcmNoL3g4Ni9odm0vc3ZtL25lc3RlZHN2bS5j
CisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vc3ZtL25lc3RlZHN2bS5jCkBAIC0zMjQsNyArMzI0LDcg
QEAgc3RhdGljIGludCBuc3ZtX3ZjcHVfaG9zdHJlc3RvcmUoc3RydWN0CiAgICAgICAgIHYtPmFy
Y2guZ3Vlc3RfdGFibGUgPSBwYWdldGFibGVfbnVsbCgpOwogICAgICAgICAvKiBodm1fc2V0X2Ny
MygpIGJlbG93IHNldHMgdi0+YXJjaC5odm0uZ3Vlc3RfY3JbM10gZm9yIHVzLiAqLwogICAgIH0K
LSAgICByYyA9IGh2bV9zZXRfY3IzKG4xdm1jYi0+X2NyMywgdHJ1ZSk7CisgICAgcmMgPSBodm1f
c2V0X2NyMyhuMXZtY2ItPl9jcjMsIGZhbHNlLCB0cnVlKTsKICAgICBpZiAoIHJjID09IFg4NkVN
VUxfRVhDRVBUSU9OICkKICAgICAgICAgaHZtX2luamVjdF9od19leGNlcHRpb24oVFJBUF9ncF9m
YXVsdCwgMCk7CiAgICAgaWYgKHJjICE9IFg4NkVNVUxfT0tBWSkKQEAgLTU4NCw3ICs1ODQsNyBA
QCBzdGF0aWMgaW50IG5zdm1fdm1jYl9wcmVwYXJlNHZtcnVuKHN0cnVjCiAgICAgICAgIG5lc3Rl
ZHN2bV92bWNiX3NldF9uZXN0ZWRwMm0odiwgbnNfdm1jYiwgbjJ2bWNiKTsKIAogICAgICAgICAv
KiBodm1fc2V0X2NyMygpIGJlbG93IHNldHMgdi0+YXJjaC5odm0uZ3Vlc3RfY3JbM10gZm9yIHVz
LiAqLwotICAgICAgICByYyA9IGh2bV9zZXRfY3IzKG5zX3ZtY2ItPl9jcjMsIHRydWUpOworICAg
ICAgICByYyA9IGh2bV9zZXRfY3IzKG5zX3ZtY2ItPl9jcjMsIGZhbHNlLCB0cnVlKTsKICAgICAg
ICAgaWYgKCByYyA9PSBYODZFTVVMX0VYQ0VQVElPTiApCiAgICAgICAgICAgICBodm1faW5qZWN0
X2h3X2V4Y2VwdGlvbihUUkFQX2dwX2ZhdWx0LCAwKTsKICAgICAgICAgaWYgKHJjICE9IFg4NkVN
VUxfT0tBWSkKQEAgLTU5OCw3ICs1OTgsNyBAQCBzdGF0aWMgaW50IG5zdm1fdm1jYl9wcmVwYXJl
NHZtcnVuKHN0cnVjCiAgICAgICAgICAqIHdlIGFzc3VtZSBpdCBpbnRlcmNlcHRzIHBhZ2UgZmF1
bHRzLgogICAgICAgICAgKi8KICAgICAgICAgLyogaHZtX3NldF9jcjMoKSBiZWxvdyBzZXRzIHYt
PmFyY2guaHZtLmd1ZXN0X2NyWzNdIGZvciB1cy4gKi8KLSAgICAgICAgcmMgPSBodm1fc2V0X2Ny
Myhuc192bWNiLT5fY3IzLCB0cnVlKTsKKyAgICAgICAgcmMgPSBodm1fc2V0X2NyMyhuc192bWNi
LT5fY3IzLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgIGlmICggcmMgPT0gWDg2RU1VTF9FWENFUFRJ
T04gKQogICAgICAgICAgICAgaHZtX2luamVjdF9od19leGNlcHRpb24oVFJBUF9ncF9mYXVsdCwg
MCk7CiAgICAgICAgIGlmIChyYyAhPSBYODZFTVVMX09LQVkpCi0tLSBhL3hlbi9hcmNoL3g4Ni9o
dm0vdm1fZXZlbnQuYworKysgYi94ZW4vYXJjaC94ODYvaHZtL3ZtX2V2ZW50LmMKQEAgLTExMCw3
ICsxMTAsNyBAQCB2b2lkIGh2bV92bV9ldmVudF9kb19yZXN1bWUoc3RydWN0IHZjcHUKIAogICAg
IGlmICggdW5saWtlbHkody0+ZG9fd3JpdGUuY3IzKSApCiAgICAgewotICAgICAgICBpZiAoIGh2
bV9zZXRfY3IzKHctPmNyMywgZmFsc2UpID09IFg4NkVNVUxfRVhDRVBUSU9OICkKKyAgICAgICAg
aWYgKCBodm1fc2V0X2NyMyh3LT5jcjMsIHctPmNyM19ub2ZsdXNoLCBmYWxzZSkgPT0gWDg2RU1V
TF9FWENFUFRJT04gKQogICAgICAgICAgICAgaHZtX2luamVjdF9od19leGNlcHRpb24oVFJBUF9n
cF9mYXVsdCwgMCk7CiAKICAgICAgICAgdy0+ZG9fd3JpdGUuY3IzID0gMDsKLS0tIGEveGVuL2Fy
Y2gveDg2L2h2bS92bXgvdnZteC5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vdm14L3Z2bXguYwpA
QCAtMTAzMiw3ICsxMDMyLDcgQEAgc3RhdGljIHZvaWQgbG9hZF9zaGFkb3dfZ3Vlc3Rfc3RhdGUo
c3RydQogICAgIGlmICggcmMgPT0gWDg2RU1VTF9FWENFUFRJT04gKQogICAgICAgICBodm1faW5q
ZWN0X2h3X2V4Y2VwdGlvbihUUkFQX2dwX2ZhdWx0LCAwKTsKIAotICAgIHJjID0gaHZtX3NldF9j
cjMoZ2V0X3Z2bWNzKHYsIEdVRVNUX0NSMyksIHRydWUpOworICAgIHJjID0gaHZtX3NldF9jcjMo
Z2V0X3Z2bWNzKHYsIEdVRVNUX0NSMyksIGZhbHNlLCB0cnVlKTsKICAgICBpZiAoIHJjID09IFg4
NkVNVUxfRVhDRVBUSU9OICkKICAgICAgICAgaHZtX2luamVjdF9od19leGNlcHRpb24oVFJBUF9n
cF9mYXVsdCwgMCk7CiAKQEAgLTEyNDYsNyArMTI0Niw3IEBAIHN0YXRpYyB2b2lkIGxvYWRfdnZt
Y3NfaG9zdF9zdGF0ZShzdHJ1Y3QKICAgICBpZiAoIHJjID09IFg4NkVNVUxfRVhDRVBUSU9OICkK
ICAgICAgICAgaHZtX2luamVjdF9od19leGNlcHRpb24oVFJBUF9ncF9mYXVsdCwgMCk7CiAKLSAg
ICByYyA9IGh2bV9zZXRfY3IzKGdldF92dm1jcyh2LCBIT1NUX0NSMyksIHRydWUpOworICAgIHJj
ID0gaHZtX3NldF9jcjMoZ2V0X3Z2bWNzKHYsIEhPU1RfQ1IzKSwgZmFsc2UsIHRydWUpOwogICAg
IGlmICggcmMgPT0gWDg2RU1VTF9FWENFUFRJT04gKQogICAgICAgICBodm1faW5qZWN0X2h3X2V4
Y2VwdGlvbihUUkFQX2dwX2ZhdWx0LCAwKTsKIAotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2Rv
bWFpbi5oCisrKyBiL3hlbi9pbmNsdWRlL2FzbS14ODYvZG9tYWluLmgKQEAgLTI3NCw2ICsyNzQs
OCBAQCBzdHJ1Y3QgbW9uaXRvcl93cml0ZV9kYXRhIHsKICAgICAgICAgdW5zaWduZWQgaW50IGNy
NCA6IDE7CiAgICAgfSBkb193cml0ZTsKIAorICAgIGJvb2wgY3IzX25vZmx1c2g7CisKICAgICB1
aW50MzJfdCBtc3I7CiAgICAgdWludDY0X3QgdmFsdWU7CiAgICAgdWludDY0X3QgY3IwOwotLS0g
YS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9zdXBwb3J0LmgKKysrIGIveGVuL2luY2x1ZGUvYXNt
LXg4Ni9odm0vc3VwcG9ydC5oCkBAIC0xMzUsNyArMTM1LDcgQEAgdm9pZCBodm1fc2hhZG93X2hh
bmRsZV9jZChzdHJ1Y3QgdmNwdSAqdgogICovCiBpbnQgaHZtX3NldF9lZmVyKHVpbnQ2NF90IHZh
bHVlKTsKIGludCBodm1fc2V0X2NyMCh1bnNpZ25lZCBsb25nIHZhbHVlLCBib29sIG1heV9kZWZl
cik7Ci1pbnQgaHZtX3NldF9jcjModW5zaWduZWQgbG9uZyB2YWx1ZSwgYm9vbCBtYXlfZGVmZXIp
OworaW50IGh2bV9zZXRfY3IzKHVuc2lnbmVkIGxvbmcgdmFsdWUsIGJvb2wgbm9mbHVzaCwgYm9v
bCBtYXlfZGVmZXIpOwogaW50IGh2bV9zZXRfY3I0KHVuc2lnbmVkIGxvbmcgdmFsdWUsIGJvb2wg
bWF5X2RlZmVyKTsKIGludCBodm1fZGVzY3JpcHRvcl9hY2Nlc3NfaW50ZXJjZXB0KHVpbnQ2NF90
IGV4aXRfaW5mbywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ2NF90
IHZteF9leGl0X3F1YWxpZmljYXRpb24sCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMu
eGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL3hlbi1kZXZlbA==

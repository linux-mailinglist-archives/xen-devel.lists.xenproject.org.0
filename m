Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 3EEB31348FC
	for <lists+xen-devel@lfdr.de>; Wed,  8 Jan 2020 18:17:22 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ipEva-0001Dn-Is; Wed, 08 Jan 2020 17:15:30 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=uSPe=25=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1ipEvY-0001Cf-R8
 for xen-devel@lists.xenproject.org; Wed, 08 Jan 2020 17:15:28 +0000
X-Inumbo-ID: 5e92640d-323a-11ea-b85f-12813bfff9fa
Received: from mga14.intel.com (unknown [192.55.52.115])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 5e92640d-323a-11ea-b85f-12813bfff9fa;
 Wed, 08 Jan 2020 17:14:48 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga005.jf.intel.com ([10.7.209.41])
 by fmsmga103.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 08 Jan 2020 09:14:47 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,410,1571727600"; d="scan'208";a="395806160"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.251.132.23])
 by orsmga005.jf.intel.com with ESMTP; 08 Jan 2020 09:14:46 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Wed,  8 Jan 2020 09:14:12 -0800
Message-Id: <b816ff21d1156eeb5d68b35932ad23f4e5891bdb.1578503483.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1578503483.git.tamas.lengyel@intel.com>
References: <cover.1578503483.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v4 15/18] xen/mem_sharing: VM forking
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Stefano Stabellini <sstabellini@kernel.org>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tamas K Lengyel <tamas@tklengyel.com>,
 Jan Beulich <jbeulich@suse.com>, Julien Grall <julien@xen.org>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Vk0gZm9ya2luZyBpcyB0aGUgcHJvY2VzcyBvZiBjcmVhdGluZyBhIGRvbWFpbiB3aXRoIGFuIGVt
cHR5IG1lbW9yeSBzcGFjZSBhbmQgYQpwYXJlbnQgZG9tYWluIHNwZWNpZmllZCBmcm9tIHdoaWNo
IHRvIHBvcHVsYXRlIHRoZSBtZW1vcnkgd2hlbiBuZWNlc3NhcnkuIEZvcgp0aGUgbmV3IGRvbWFp
biB0byBiZSBmdW5jdGlvbmFsIHRoZSBWTSBzdGF0ZSBpcyBjb3BpZWQgb3ZlciBhcyBwYXJ0IG9m
IHRoZSBmb3JrCm9wZXJhdGlvbiAoSFZNIHBhcmFtcywgaGFwIGFsbG9jYXRpb24sIGV0YykuCgpT
aWduZWQtb2ZmLWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxAaW50ZWwuY29tPgot
LS0KIHhlbi9hcmNoL3g4Ni9odm0vaHZtLmMgICAgICAgICAgICB8ICAgMiArLQogeGVuL2FyY2gv
eDg2L21tL21lbV9zaGFyaW5nLmMgICAgIHwgMjA0ICsrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKwogeGVuL2FyY2gveDg2L21tL3AybS5jICAgICAgICAgICAgIHwgIDExICstCiB4ZW4vaW5j
bHVkZS9hc20teDg2L21lbV9zaGFyaW5nLmggfCAgMjAgKystCiB4ZW4vaW5jbHVkZS9wdWJsaWMv
bWVtb3J5LmggICAgICAgfCAgIDUgKwogeGVuL2luY2x1ZGUveGVuL3NjaGVkLmggICAgICAgICAg
IHwgICAxICsKIDYgZmlsZXMgY2hhbmdlZCwgMjM5IGluc2VydGlvbnMoKyksIDQgZGVsZXRpb25z
KC0pCgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2h2bS9odm0uYyBiL3hlbi9hcmNoL3g4Ni9o
dm0vaHZtLmMKaW5kZXggNWQyNGNlYjQ2OS4uMzI0MWUyYTVhYyAxMDA2NDQKLS0tIGEveGVuL2Fy
Y2gveDg2L2h2bS9odm0uYworKysgYi94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCkBAIC0xOTA5LDcg
KzE5MDksNyBAQCBpbnQgaHZtX2hhcF9uZXN0ZWRfcGFnZV9mYXVsdChwYWRkcl90IGdwYSwgdW5z
aWduZWQgbG9uZyBnbGEsCiAgICAgfQogI2VuZGlmCiAKLSAgICAvKiBTcHVyaW91cyBmYXVsdD8g
UG9EIGFuZCBsb2ctZGlydHkgYWxzbyB0YWtlIHRoaXMgcGF0aC4gKi8KKyAgICAvKiBTcHVyaW91
cyBmYXVsdD8gUG9ELCBsb2ctZGlydHkgYW5kIFZNIGZvcmtpbmcgYWxzbyB0YWtlIHRoaXMgcGF0
aC4gKi8KICAgICBpZiAoIHAybV9pc19yYW0ocDJtdCkgKQogICAgIHsKICAgICAgICAgcmMgPSAx
OwpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMgYi94ZW4vYXJjaC94
ODYvbW0vbWVtX3NoYXJpbmcuYwppbmRleCBlY2JlNDA1NDVkLi5kNTQ0ODAxNjgxIDEwMDY0NAot
LS0gYS94ZW4vYXJjaC94ODYvbW0vbWVtX3NoYXJpbmcuYworKysgYi94ZW4vYXJjaC94ODYvbW0v
bWVtX3NoYXJpbmcuYwpAQCAtMjIsMTEgKzIyLDEzIEBACiAKICNpbmNsdWRlIDx4ZW4vdHlwZXMu
aD4KICNpbmNsdWRlIDx4ZW4vZG9tYWluX3BhZ2UuaD4KKyNpbmNsdWRlIDx4ZW4vZXZlbnQuaD4K
ICNpbmNsdWRlIDx4ZW4vc3BpbmxvY2suaD4KICNpbmNsdWRlIDx4ZW4vcndsb2NrLmg+CiAjaW5j
bHVkZSA8eGVuL21tLmg+CiAjaW5jbHVkZSA8eGVuL2dyYW50X3RhYmxlLmg+CiAjaW5jbHVkZSA8
eGVuL3NjaGVkLmg+CisjaW5jbHVkZSA8eGVuL3NjaGVkLWlmLmg+CiAjaW5jbHVkZSA8eGVuL3Jj
dXBkYXRlLmg+CiAjaW5jbHVkZSA8eGVuL2d1ZXN0X2FjY2Vzcy5oPgogI2luY2x1ZGUgPHhlbi92
bV9ldmVudC5oPgpAQCAtMzYsNiArMzgsOSBAQAogI2luY2x1ZGUgPGFzbS9hbHRwMm0uaD4KICNp
bmNsdWRlIDxhc20vYXRvbWljLmg+CiAjaW5jbHVkZSA8YXNtL2V2ZW50Lmg+CisjaW5jbHVkZSA8
YXNtL2hhcC5oPgorI2luY2x1ZGUgPGFzbS9odm0vaHZtLmg+CisjaW5jbHVkZSA8YXNtL2h2bS9z
YXZlLmg+CiAjaW5jbHVkZSA8eHNtL3hzbS5oPgogCiAjaW5jbHVkZSAibW0tbG9ja3MuaCIKQEAg
LTE0MzMsNiArMTQzOCwxNzUgQEAgc3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfY29udHJv
bChzdHJ1Y3QgZG9tYWluICpkLCBib29sIGVuYWJsZSkKICAgICByZXR1cm4gMDsKIH0KIAorLyoK
KyAqIEZvcmtpbmcgYSBwYWdlIG9ubHkgZ2V0cyBjYWxsZWQgd2hlbiB0aGUgVk0gZmF1bHRzIGR1
ZSB0byBubyBlbnRyeSBiZWluZworICogaW4gdGhlIEVQVCBmb3IgdGhlIGFjY2Vzcy4gRGVwZW5k
aW5nIG9uIHRoZSB0eXBlIG9mIGFjY2VzcyB3ZSBlaXRoZXIKKyAqIHBvcHVsYXRlIHRoZSBwaHlz
bWFwIHdpdGggYSBzaGFyZWQgZW50cnkgZm9yIHJlYWQtb25seSBhY2Nlc3Mgb3IKKyAqIGZvcmsg
dGhlIHBhZ2UgaWYgaXRzIGEgd3JpdGUgYWNjZXNzLgorICoKKyAqIFRoZSBjbGllbnQgcDJtIGlz
IGFscmVhZHkgbG9ja2VkIHNvIHdlIG9ubHkgbmVlZCB0byBsb2NrCisgKiB0aGUgcGFyZW50J3Mg
aGVyZS4KKyAqLworaW50IG1lbV9zaGFyaW5nX2ZvcmtfcGFnZShzdHJ1Y3QgZG9tYWluICpkLCBn
Zm5fdCBnZm4sIGJvb2wgdW5zaGFyaW5nKQoreworICAgIGludCByYyA9IC1FTk9FTlQ7CisgICAg
c2hyX2hhbmRsZV90IGhhbmRsZTsKKyAgICBzdHJ1Y3QgZG9tYWluICpwYXJlbnQ7CisgICAgc3Ry
dWN0IHAybV9kb21haW4gKnAybTsKKyAgICB1bnNpZ25lZCBsb25nIGdmbl9sID0gZ2ZuX3goZ2Zu
KTsKKyAgICBtZm5fdCBtZm4sIG5ld19tZm47CisgICAgcDJtX3R5cGVfdCBwMm10OworICAgIHN0
cnVjdCBwYWdlX2luZm8gKnBhZ2U7CisKKyAgICBpZiAoICFtZW1fc2hhcmluZ19pc19mb3JrKGQp
ICkKKyAgICAgICAgcmV0dXJuIC1FTk9FTlQ7CisKKyAgICBwYXJlbnQgPSBkLT5wYXJlbnQ7CisK
KyAgICBpZiAoICF1bnNoYXJpbmcgKQorICAgIHsKKyAgICAgICAgLyogRm9yIHJlYWQtb25seSBh
Y2Nlc3NlcyB3ZSBqdXN0IGFkZCBhIHNoYXJlZCBlbnRyeSB0byB0aGUgcGh5c21hcCAqLworICAg
ICAgICB3aGlsZSAoIHBhcmVudCApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggIShyYyA9
IG5vbWluYXRlX3BhZ2UocGFyZW50LCBnZm4sIDAsICZoYW5kbGUpKSApCisgICAgICAgICAgICAg
ICAgYnJlYWs7CisKKyAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC0+cGFyZW50OworICAgICAg
ICB9CisKKyAgICAgICAgaWYgKCAhcmMgKQorICAgICAgICB7CisgICAgICAgICAgICAvKiBUaGUg
Y2xpZW50J3MgcDJtIGlzIGFscmVhZHkgbG9ja2VkICovCisgICAgICAgICAgICBzdHJ1Y3QgcDJt
X2RvbWFpbiAqcHAybSA9IHAybV9nZXRfaG9zdHAybShwYXJlbnQpOworCisgICAgICAgICAgICBw
Mm1fbG9jayhwcDJtKTsKKyAgICAgICAgICAgIHJjID0gYWRkX3RvX3BoeXNtYXAocGFyZW50LCBn
Zm5fbCwgaGFuZGxlLCBkLCBnZm5fbCwgZmFsc2UpOworICAgICAgICAgICAgcDJtX3VubG9jayhw
cDJtKTsKKworICAgICAgICAgICAgaWYgKCAhcmMgKQorICAgICAgICAgICAgICAgIHJldHVybiAw
OworICAgICAgICB9CisgICAgfQorCisgICAgLyoKKyAgICAgKiBJZiBpdCdzIGEgd3JpdGUgYWNj
ZXNzIChpZS4gdW5zaGFyaW5nKSBvciBpZiBhZGRpbmcgYSBzaGFyZWQgZW50cnkgdG8KKyAgICAg
KiB0aGUgcGh5c21hcCBmYWlsZWQgd2UnbGwgZm9yayB0aGUgcGFnZSBkaXJlY3RseS4KKyAgICAg
Ki8KKyAgICBwMm0gPSBwMm1fZ2V0X2hvc3RwMm0oZCk7CisgICAgcGFyZW50ID0gZC0+cGFyZW50
OworCisgICAgd2hpbGUgKCBwYXJlbnQgKQorICAgIHsKKyAgICAgICAgbWZuID0gZ2V0X2dmbl9x
dWVyeShwYXJlbnQsIGdmbl9sLCAmcDJtdCk7CisKKyAgICAgICAgaWYgKCBtZm5fdmFsaWQobWZu
KSAmJiBwMm1faXNfYW55X3JhbShwMm10KSApCisgICAgICAgICAgICBicmVhazsKKworICAgICAg
ICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworICAgICAgICBwYXJlbnQgPSBwYXJlbnQtPnBhcmVu
dDsKKyAgICB9CisKKyAgICBpZiAoICFwYXJlbnQgKQorICAgICAgICByZXR1cm4gLUVOT0VOVDsK
KworICAgIGlmICggIShwYWdlID0gYWxsb2NfZG9taGVhcF9wYWdlKGQsIDApKSApCisgICAgewor
ICAgICAgICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworICAgICAgICByZXR1cm4gLUVOT01FTTsK
KyAgICB9CisKKyAgICBuZXdfbWZuID0gcGFnZV90b19tZm4ocGFnZSk7CisgICAgY29weV9kb21h
aW5fcGFnZShuZXdfbWZuLCBtZm4pOworICAgIHNldF9ncGZuX2Zyb21fbWZuKG1mbl94KG5ld19t
Zm4pLCBnZm5fbCk7CisKKyAgICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworCisgICAgcmV0dXJu
IHAybS0+c2V0X2VudHJ5KHAybSwgZ2ZuLCBuZXdfbWZuLCBQQUdFX09SREVSXzRLLCBwMm1fcmFt
X3J3LAorICAgICAgICAgICAgICAgICAgICAgICAgICBwMm0tPmRlZmF1bHRfYWNjZXNzLCAtMSk7
Cit9CisKK3N0YXRpYyBpbnQgYnJpbmdfdXBfdmNwdXMoc3RydWN0IGRvbWFpbiAqY2QsIHN0cnVj
dCBjcHVwb29sICpjcHVwb29sKQoreworICAgIGludCByZXQ7CisgICAgdW5zaWduZWQgaW50IGk7
CisKKyAgICBpZiAoIChyZXQgPSBjcHVwb29sX21vdmVfZG9tYWluKGNkLCBjcHVwb29sKSkgKQor
ICAgICAgICByZXR1cm4gcmV0OworCisgICAgZm9yICggaSA9IDA7IGkgPCBjZC0+bWF4X3ZjcHVz
OyBpKysgKQorICAgIHsKKyAgICAgICAgaWYgKCBjZC0+dmNwdVtpXSApCisgICAgICAgICAgICBj
b250aW51ZTsKKworICAgICAgICBpZiAoICF2Y3B1X2NyZWF0ZShjZCwgaSkgKQorICAgICAgICAg
ICAgcmV0dXJuIC1FSU5WQUw7CisgICAgfQorCisgICAgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmlu
aXR5KGNkKTsKKyAgICByZXR1cm4gMDsKK30KKworc3RhdGljIGludCBmb3JrX2hhcF9hbGxvY2F0
aW9uKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkKQoreworICAgIGludCByYzsK
KyAgICBib29sIHByZWVtcHRlZDsKKyAgICB1bnNpZ25lZCBsb25nIG1iID0gaGFwX2dldF9hbGxv
Y2F0aW9uKGQpOworCisgICAgaWYgKCBtYiA9PSBoYXBfZ2V0X2FsbG9jYXRpb24oY2QpICkKKyAg
ICAgICAgcmV0dXJuIDA7CisKKyAgICBwYWdpbmdfbG9jayhjZCk7CisgICAgcmMgPSBoYXBfc2V0
X2FsbG9jYXRpb24oY2QsIG1iIDw8ICgyMCAtIFBBR0VfU0hJRlQpLCAmcHJlZW1wdGVkKTsKKyAg
ICBwYWdpbmdfdW5sb2NrKGNkKTsKKworICAgIGlmICggcmMgKQorICAgICAgICByZXR1cm4gcmM7
CisKKyAgICBpZiAoIHByZWVtcHRlZCApCisgICAgICAgIHJldHVybiAtRVJFU1RBUlQ7CisKKyAg
ICByZXR1cm4gMDsKK30KKworc3RhdGljIHZvaWQgZm9ya190c2Moc3RydWN0IGRvbWFpbiAqZCwg
c3RydWN0IGRvbWFpbiAqY2QpCit7CisgICAgdWludDMyX3QgdHNjX21vZGU7CisgICAgdWludDMy
X3QgZ3RzY19raHo7CisgICAgdWludDMyX3QgaW5jYXJuYXRpb247CisgICAgdWludDY0X3QgZWxh
cHNlZF9uc2VjOworCisgICAgdHNjX2dldF9pbmZvKGQsICZ0c2NfbW9kZSwgJmVsYXBzZWRfbnNl
YywgJmd0c2Nfa2h6LCAmaW5jYXJuYXRpb24pOworICAgIHRzY19zZXRfaW5mbyhjZCwgdHNjX21v
ZGUsIGVsYXBzZWRfbnNlYywgZ3RzY19raHosIGluY2FybmF0aW9uKTsKK30KKworc3RhdGljIGlu
dCBtZW1fc2hhcmluZ19mb3JrKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkKQor
eworICAgIGludCByYzsKKworICAgIGlmICggIWQtPmNvbnRyb2xsZXJfcGF1c2VfY291bnQgJiYK
KyAgICAgICAgIChyYyA9IGRvbWFpbl9wYXVzZV9ieV9zeXN0ZW1jb250cm9sbGVyKGQpKSApCisg
ICAgICAgIHJldHVybiByYzsKKworICAgIGNkLT5tYXhfcGFnZXMgPSBkLT5tYXhfcGFnZXM7Cisg
ICAgY2QtPm1heF92Y3B1cyA9IGQtPm1heF92Y3B1czsKKworICAgIC8qIHRoaXMgaXMgcHJlZW1w
dGlibGUgc28gaXQncyB0aGUgZmlyc3QgdG8gZ2V0IGRvbmUgKi8KKyAgICBpZiAoIChyYyA9IGZv
cmtfaGFwX2FsbG9jYXRpb24oZCwgY2QpKSApCisgICAgICAgIHJldHVybiByYzsKKworICAgIGlm
ICggKHJjID0gYnJpbmdfdXBfdmNwdXMoY2QsIGQtPmNwdXBvb2wpKSApCisgICAgICAgIHJldHVy
biByYzsKKworICAgIGlmICggKHJjID0gaHZtX2NvcHlfY29udGV4dF9hbmRfcGFyYW1zKGQsIGNk
KSkgKQorICAgICAgICByZXR1cm4gcmM7CisKKyAgICBmb3JrX3RzYyhkLCBjZCk7CisKKyAgICBj
ZC0+cGFyZW50ID0gZDsKKworICAgIHJldHVybiAwOworfQorCiBpbnQgbWVtX3NoYXJpbmdfbWVt
b3AoWEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5fbWVtX3NoYXJpbmdfb3BfdCkgYXJnKQogewog
ICAgIGludCByYzsKQEAgLTE3MDUsNiArMTg3OSwzNiBAQCBpbnQgbWVtX3NoYXJpbmdfbWVtb3Ao
WEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5fbWVtX3NoYXJpbmdfb3BfdCkgYXJnKQogICAgICAg
ICByYyA9IGRlYnVnX2dyZWYoZCwgbXNvLnUuZGVidWcudS5ncmVmKTsKICAgICAgICAgYnJlYWs7
CiAKKyAgICBjYXNlIFhFTk1FTV9zaGFyaW5nX29wX2Zvcms6CisgICAgeworICAgICAgICBzdHJ1
Y3QgZG9tYWluICpwZDsKKworICAgICAgICByYyA9IC1FSU5WQUw7CisgICAgICAgIGlmICggbXNv
LnUuZm9yay5fcGFkWzBdIHx8IG1zby51LmZvcmsuX3BhZFsxXSB8fAorICAgICAgICAgICAgIG1z
by51LmZvcmsuX3BhZFsyXSApCisgICAgICAgICAgICBnb3RvIG91dDsKKworICAgICAgICByYyA9
IHJjdV9sb2NrX2xpdmVfcmVtb3RlX2RvbWFpbl9ieV9pZChtc28udS5mb3JrLnBhcmVudF9kb21h
aW4sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZwZCk7
CisgICAgICAgIGlmICggcmMgKQorICAgICAgICAgICAgZ290byBvdXQ7CisKKyAgICAgICAgaWYg
KCAhbWVtX3NoYXJpbmdfZW5hYmxlZChwZCkgKQorICAgICAgICB7CisgICAgICAgICAgICBpZiAo
IChyYyA9IG1lbV9zaGFyaW5nX2NvbnRyb2wocGQsIHRydWUpKSApCisgICAgICAgICAgICAgICAg
Z290byBvdXQ7CisgICAgICAgIH0KKworICAgICAgICByYyA9IG1lbV9zaGFyaW5nX2ZvcmsocGQs
IGQpOworCisgICAgICAgIGlmICggcmMgPT0gLUVSRVNUQVJUICkKKyAgICAgICAgICAgIHJjID0g
aHlwZXJjYWxsX2NyZWF0ZV9jb250aW51YXRpb24oX19IWVBFUlZJU09SX21lbW9yeV9vcCwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImxoIiwgWEVOTUVN
X3NoYXJpbmdfb3AsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGFyZyk7CisgICAgICAgIHJjdV91bmxvY2tfZG9tYWluKHBkKTsKKyAgICAgICAgYnJlYWs7
CisgICAgfQorCiAgICAgZGVmYXVsdDoKICAgICAgICAgcmMgPSAtRU5PU1lTOwogICAgICAgICBi
cmVhazsKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9tbS9wMm0uYyBiL3hlbi9hcmNoL3g4Ni9t
bS9wMm0uYwppbmRleCBiYWVhNjMyYWNjLi44MWY3Njc5ZWMxIDEwMDY0NAotLS0gYS94ZW4vYXJj
aC94ODYvbW0vcDJtLmMKKysrIGIveGVuL2FyY2gveDg2L21tL3AybS5jCkBAIC01MDgsNiArNTA4
LDE0IEBAIG1mbl90IF9fZ2V0X2dmbl90eXBlX2FjY2VzcyhzdHJ1Y3QgcDJtX2RvbWFpbiAqcDJt
LCB1bnNpZ25lZCBsb25nIGdmbl9sLAogCiAgICAgbWZuID0gcDJtLT5nZXRfZW50cnkocDJtLCBn
Zm4sIHQsIGEsIHEsIHBhZ2Vfb3JkZXIsIE5VTEwpOwogCisgICAgLyogQ2hlY2sgaWYgd2UgbmVl
ZCB0byBmb3JrIHRoZSBwYWdlICovCisgICAgaWYgKCAocSAmIFAyTV9BTExPQykgJiYgcDJtX2lz
X2hvbGUoKnQpICYmCisgICAgICAgICAhbWVtX3NoYXJpbmdfZm9ya19wYWdlKHAybS0+ZG9tYWlu
LCBnZm4sICEhKHEgJiBQMk1fVU5TSEFSRSkpICkKKyAgICB7CisgICAgICAgIG1mbiA9IHAybS0+
Z2V0X2VudHJ5KHAybSwgZ2ZuLCB0LCBhLCBxLCBwYWdlX29yZGVyLCBOVUxMKTsKKyAgICB9CisK
KyAgICAvKiBDaGVjayBpZiB3ZSBuZWVkIHRvIHVuc2hhcmUgdGhlIHBhZ2UgKi8KICAgICBpZiAo
IChxICYgUDJNX1VOU0hBUkUpICYmIHAybV9pc19zaGFyZWQoKnQpICkKICAgICB7CiAgICAgICAg
IEFTU0VSVChwMm1faXNfaG9zdHAybShwMm0pKTsKQEAgLTU4NSw3ICs1OTMsOCBAQCBzdHJ1Y3Qg
cGFnZV9pbmZvICpwMm1fZ2V0X3BhZ2VfZnJvbV9nZm4oCiAgICAgICAgICAgICByZXR1cm4gcGFn
ZTsKIAogICAgICAgICAvKiBFcnJvciBwYXRoOiBub3QgYSBzdWl0YWJsZSBHRk4gYXQgYWxsICov
Ci0gICAgICAgIGlmICggIXAybV9pc19yYW0oKnQpICYmICFwMm1faXNfcGFnaW5nKCp0KSAmJiAh
cDJtX2lzX3BvZCgqdCkgKQorICAgICAgICBpZiAoICFwMm1faXNfcmFtKCp0KSAmJiAhcDJtX2lz
X3BhZ2luZygqdCkgJiYgIXAybV9pc19wb2QoKnQpICYmCisgICAgICAgICAgICAgIW1lbV9zaGFy
aW5nX2lzX2ZvcmsocDJtLT5kb21haW4pICkKICAgICAgICAgICAgIHJldHVybiBOVUxMOwogICAg
IH0KIApkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oIGIveGVu
L2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oCmluZGV4IGM5MTVmZDk3M2YuLmYxZjc4NTI5
NmYgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvbWVtX3NoYXJpbmcuaAorKysgYi94
ZW4vaW5jbHVkZS9hc20teDg2L21lbV9zaGFyaW5nLmgKQEAgLTI2LDggKzI2LDcgQEAKIAogI2lm
ZGVmIENPTkZJR19NRU1fU0hBUklORwogCi1zdHJ1Y3QgbWVtX3NoYXJpbmdfZG9tYWluCi17Citz
dHJ1Y3QgbWVtX3NoYXJpbmdfZG9tYWluIHsKICAgICBib29sIGVuYWJsZWQ7CiAKICAgICAvKgpA
QCAtNDAsNiArMzksOSBAQCBzdHJ1Y3QgbWVtX3NoYXJpbmdfZG9tYWluCiAjZGVmaW5lIG1lbV9z
aGFyaW5nX2VuYWJsZWQoZCkgXAogICAgIChoYXBfZW5hYmxlZChkKSAmJiAoZCktPmFyY2guaHZt
Lm1lbV9zaGFyaW5nLmVuYWJsZWQpCiAKKyNkZWZpbmUgbWVtX3NoYXJpbmdfaXNfZm9yayhkKSBc
CisgICAgKG1lbV9zaGFyaW5nX2VuYWJsZWQoZCkgJiYgISEoKGQpLT5wYXJlbnQpKQorCiAvKiBB
dWRpdGluZyBvZiBtZW1vcnkgc2hhcmluZyBjb2RlPyAqLwogI2lmbmRlZiBOREVCVUcKICNkZWZp
bmUgTUVNX1NIQVJJTkdfQVVESVQgMQpAQCAtODksNiArOTEsOSBAQCBzdGF0aWMgaW5saW5lIGlu
dCBtZW1fc2hhcmluZ191bnNoYXJlX3BhZ2Uoc3RydWN0IGRvbWFpbiAqZCwKICAgICByZXR1cm4g
cmM7CiB9CiAKK2ludCBtZW1fc2hhcmluZ19mb3JrX3BhZ2Uoc3RydWN0IGRvbWFpbiAqZCwgZ2Zu
X3QgZ2ZuLAorICAgICAgICAgICAgICAgICAgICAgICAgICBib29sIHVuc2hhcmluZyk7CisKIC8q
CiAgKiBJZiBjYWxsZWQgYnkgYSBmb3JlaWduIGRvbWFpbiwgcG9zc2libGUgZXJyb3JzIGFyZQog
ICogICAtRUJVU1kgLT4gcmluZyBmdWxsCkBAIC0xMTgsNiArMTIzLDcgQEAgaW50IHJlbGlucXVp
c2hfc2hhcmVkX3BhZ2VzKHN0cnVjdCBkb21haW4gKmQpOwogI2Vsc2UKIAogI2RlZmluZSBtZW1f
c2hhcmluZ19lbmFibGVkKGQpIGZhbHNlCisjZGVmaW5lIG1lbV9zaGFyaW5nX2lzX2ZvcmsocDJt
KSBmYWxzZQogCiBzdGF0aWMgaW5saW5lIHVuc2lnbmVkIGludCBtZW1fc2hhcmluZ19nZXRfbnJf
c2F2ZWRfbWZucyh2b2lkKQogewpAQCAtMTQyLDYgKzE0OCwxNiBAQCBzdGF0aWMgaW5saW5lIGlu
dCBtZW1fc2hhcmluZ19ub3RpZnlfZW5vbWVtKHN0cnVjdCBkb21haW4gKmQsIHVuc2lnbmVkIGxv
bmcgZ2ZuLAogICAgIHJldHVybiAtRU9QTk9UU1VQUDsKIH0KIAorc3RhdGljIGlubGluZSBpbnQg
bWVtX3NoYXJpbmdfZm9yayhzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgZG9tYWluICpjZCwgYm9v
bCB2Y3B1KQoreworICAgIHJldHVybiAtRU9QTk9UU1VQUDsKK30KKworc3RhdGljIGlubGluZSBp
bnQgbWVtX3NoYXJpbmdfZm9ya19wYWdlKHN0cnVjdCBkb21haW4gKmQsIGdmbl90IGdmbiwgYm9v
bCBsb2NrKQoreworICAgIHJldHVybiAtRU9QTk9UU1VQUDsKK30KKwogI2VuZGlmCiAKICNlbmRp
ZiAvKiBfX01FTV9TSEFSSU5HX0hfXyAqLwpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUvcHVibGlj
L21lbW9yeS5oIGIveGVuL2luY2x1ZGUvcHVibGljL21lbW9yeS5oCmluZGV4IGNmZGRhNmUyYTgu
LjkwYTNmNDQ5OGUgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3B1YmxpYy9tZW1vcnkuaAorKysg
Yi94ZW4vaW5jbHVkZS9wdWJsaWMvbWVtb3J5LmgKQEAgLTQ4Miw2ICs0ODIsNyBAQCBERUZJTkVf
WEVOX0dVRVNUX0hBTkRMRSh4ZW5fbWVtX2FjY2Vzc19vcF90KTsKICNkZWZpbmUgWEVOTUVNX3No
YXJpbmdfb3BfYWRkX3BoeXNtYXAgICAgICAgNgogI2RlZmluZSBYRU5NRU1fc2hhcmluZ19vcF9h
dWRpdCAgICAgICAgICAgICA3CiAjZGVmaW5lIFhFTk1FTV9zaGFyaW5nX29wX3JhbmdlX3NoYXJl
ICAgICAgIDgKKyNkZWZpbmUgWEVOTUVNX3NoYXJpbmdfb3BfZm9yayAgICAgICAgICAgICAgOQog
CiAjZGVmaW5lIFhFTk1FTV9TSEFSSU5HX09QX1NfSEFORExFX0lOVkFMSUQgICgtMTApCiAjZGVm
aW5lIFhFTk1FTV9TSEFSSU5HX09QX0NfSEFORExFX0lOVkFMSUQgICgtOSkKQEAgLTUzMiw2ICs1
MzMsMTAgQEAgc3RydWN0IHhlbl9tZW1fc2hhcmluZ19vcCB7CiAgICAgICAgICAgICAgICAgdWlu
dDMyX3QgZ3JlZjsgICAgIC8qIElOOiBncmVmIHRvIGRlYnVnICAgICAgICAgKi8KICAgICAgICAg
ICAgIH0gdTsKICAgICAgICAgfSBkZWJ1ZzsKKyAgICAgICAgc3RydWN0IG1lbV9zaGFyaW5nX29w
X2ZvcmsgeworICAgICAgICAgICAgZG9taWRfdCBwYXJlbnRfZG9tYWluOworICAgICAgICAgICAg
dWludDE2X3QgX3BhZFszXTsgICAgICAgICAgICAgICAgLyogTXVzdCBiZSBzZXQgdG8gMCAqLwor
ICAgICAgICB9IGZvcms7CiAgICAgfSB1OwogfTsKIHR5cGVkZWYgc3RydWN0IHhlbl9tZW1fc2hh
cmluZ19vcCB4ZW5fbWVtX3NoYXJpbmdfb3BfdDsKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hl
bi9zY2hlZC5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKaW5kZXggY2M5NDJhMzYyMS4uMTM1
Y2IyY2QyMiAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKKysrIGIveGVuL2lu
Y2x1ZGUveGVuL3NjaGVkLmgKQEAgLTUwNCw2ICs1MDQsNyBAQCBzdHJ1Y3QgZG9tYWluCiAgICAg
LyogTWVtb3J5IHNoYXJpbmcgc3VwcG9ydCAqLwogI2lmZGVmIENPTkZJR19NRU1fU0hBUklORwog
ICAgIHN0cnVjdCB2bV9ldmVudF9kb21haW4gKnZtX2V2ZW50X3NoYXJlOworICAgIHN0cnVjdCBk
b21haW4gKnBhcmVudDsgLyogVk0gZm9yayBwYXJlbnQgKi8KICNlbmRpZgogICAgIC8qIE1lbW9y
eSBwYWdpbmcgc3VwcG9ydCAqLwogI2lmZGVmIENPTkZJR19IQVNfTUVNX1BBR0lORwotLSAKMi4y
MC4xCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVu
LWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6
Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

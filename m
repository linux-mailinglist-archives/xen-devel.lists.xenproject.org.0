Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 25D72BFFB3
	for <lists+xen-devel@lfdr.de>; Fri, 27 Sep 2019 09:05:29 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDkG3-0003ax-FY; Fri, 27 Sep 2019 07:01:39 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Rbpq=XW=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iDkG1-0003Zk-Qw
 for xen-devel@lists.xenproject.org; Fri, 27 Sep 2019 07:01:37 +0000
X-Inumbo-ID: 90317e86-e0f4-11e9-bf31-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 90317e86-e0f4-11e9-bf31-bc764e2007e4;
 Fri, 27 Sep 2019 07:01:01 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id D66D1B173;
 Fri, 27 Sep 2019 07:00:59 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 27 Sep 2019 09:00:20 +0200
Message-Id: <20190927070050.12405-17-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190927070050.12405-1-jgross@suse.com>
References: <20190927070050.12405-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v4 16/46] xen/sched: make credit scheduler vcpu
 agnostic.
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U3dpdGNoIGNyZWRpdCBzY2hlZHVsZXIgY29tcGxldGVseSBmcm9tIHZjcHUgdG8gc2NoZWRfdW5p
dCB1c2FnZS4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4K
UmV2aWV3ZWQtYnk6IERhcmlvIEZhZ2dpb2xpIDxkZmFnZ2lvbGlAc3VzZS5jb20+Ci0tLQogeGVu
L2NvbW1vbi9zY2hlZF9jcmVkaXQuYyB8IDUwMyArKysrKysrKysrKysrKysrKysrKysrKy0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMjUwIGluc2VydGlvbnMoKyksIDI1
MyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jIGIv
eGVuL2NvbW1vbi9zY2hlZF9jcmVkaXQuYwppbmRleCA5NDA0Y2NmZDkwLi5lNzEwYjNjNmZhIDEw
MDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jCisrKyBiL3hlbi9jb21tb24vc2No
ZWRfY3JlZGl0LmMKQEAgLTcwLDEwICs3MCwxMCBAQAogICogaW5jb25zaXN0ZW50IHNldCBvZiBs
b2Nrcy4gVGhlcmVmb3JlIGF0b21pYy1zYWZlIGJpdCBvcGVyYXRpb25zIG11c3QKICAqIGJlIHVz
ZWQgZm9yIGFjY2Vzc2luZyBpdC4KICAqLwotI2RlZmluZSBDU0NIRURfRkxBR19WQ1BVX1BBUktF
RCAgICAweDAgIC8qIFZDUFUgb3ZlciBjYXBwZWQgY3JlZGl0cyAqLwotI2RlZmluZSBDU0NIRURf
RkxBR19WQ1BVX1lJRUxEICAgICAweDEgIC8qIFZDUFUgeWllbGRpbmcgKi8KLSNkZWZpbmUgQ1ND
SEVEX0ZMQUdfVkNQVV9NSUdSQVRJTkcgMHgyICAvKiBWQ1BVIG1heSBoYXZlIG1vdmVkIHRvIGEg
bmV3IHBjcHUgKi8KLSNkZWZpbmUgQ1NDSEVEX0ZMQUdfVkNQVV9QSU5ORUQgICAgMHg0ICAvKiBW
Q1BVIGNhbiBydW4gb25seSBvbiAxIHBjcHUgKi8KKyNkZWZpbmUgQ1NDSEVEX0ZMQUdfVU5JVF9Q
QVJLRUQgICAgMHgwICAvKiBVTklUIG92ZXIgY2FwcGVkIGNyZWRpdHMgKi8KKyNkZWZpbmUgQ1ND
SEVEX0ZMQUdfVU5JVF9ZSUVMRCAgICAgMHgxICAvKiBVTklUIHlpZWxkaW5nICovCisjZGVmaW5l
IENTQ0hFRF9GTEFHX1VOSVRfTUlHUkFUSU5HIDB4MiAgLyogVU5JVCBtYXkgaGF2ZSBtb3ZlZCB0
byBhIG5ldyBwY3B1ICovCisjZGVmaW5lIENTQ0hFRF9GTEFHX1VOSVRfUElOTkVEICAgIDB4NCAg
LyogVU5JVCBjYW4gcnVuIG9ubHkgb24gMSBwY3B1ICovCiAKIAogLyoKQEAgLTkxLDcgKzkxLDcg
QEAKIC8qCiAgKiBDU0NIRURfU1RBVFMKICAqCi0gKiBNYW5hZ2UgdmVyeSBiYXNpYyBwZXItdkNQ
VSBjb3VudGVycyBhbmQgc3RhdHMuCisgKiBNYW5hZ2UgdmVyeSBiYXNpYyBwZXItdW5pdCBjb3Vu
dGVycyBhbmQgc3RhdHMuCiAgKgogICogVXNlZnVsIGZvciBkZWJ1Z2dpbmcgbGl2ZSBzeXN0ZW1z
LiBUaGUgc3RhdHMgYXJlIGRpc3BsYXllZAogICogd2l0aCBydW5xIGR1bXBzICgncicgb24gdGhl
IFhlbiBjb25zb2xlKS4KQEAgLTEwMCwyMyArMTAwLDIzIEBACiAKICNkZWZpbmUgQ1NDSEVEX1NU
QVRTCiAKLSNkZWZpbmUgU0NIRURfVkNQVV9TVEFUU19SRVNFVChfVikgICAgICAgICAgICAgICAg
ICAgICAgXAorI2RlZmluZSBTQ0hFRF9VTklUX1NUQVRTX1JFU0VUKF9WKSAgICAgICAgICAgICAg
ICAgICAgICBcCiAgICAgZG8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIFwKICAgICB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgXAogICAgICAgICBtZW1zZXQoJihfViktPnN0YXRzLCAwLCBzaXplb2YoKF9W
KS0+c3RhdHMpKTsgICBcCiAgICAgfSB3aGlsZSAoIDAgKQogCi0jZGVmaW5lIFNDSEVEX1ZDUFVf
U1RBVF9DUkFOSyhfViwgX1gpICAgICAgICgoKF9WKS0+c3RhdHMuX1gpKyspCisjZGVmaW5lIFND
SEVEX1VOSVRfU1RBVF9DUkFOSyhfViwgX1gpICAgICAgICgoKF9WKS0+c3RhdHMuX1gpKyspCiAK
LSNkZWZpbmUgU0NIRURfVkNQVV9TVEFUX1NFVChfViwgX1gsIF9ZKSAgICAgKCgoX1YpLT5zdGF0
cy5fWCkgPSAoX1kpKQorI2RlZmluZSBTQ0hFRF9VTklUX1NUQVRfU0VUKF9WLCBfWCwgX1kpICAg
ICAoKChfViktPnN0YXRzLl9YKSA9IChfWSkpCiAKICNlbHNlIC8qICFTQ0hFRF9TVEFUUyAqLwog
CiAjdW5kZWYgQ1NDSEVEX1NUQVRTCiAKLSNkZWZpbmUgU0NIRURfVkNQVV9TVEFUU19SRVNFVChf
VikgICAgICAgICBkbyB7fSB3aGlsZSAoIDAgKQotI2RlZmluZSBTQ0hFRF9WQ1BVX1NUQVRfQ1JB
TksoX1YsIF9YKSAgICAgIGRvIHt9IHdoaWxlICggMCApCi0jZGVmaW5lIFNDSEVEX1ZDUFVfU1RB
VF9TRVQoX1YsIF9YLCBfWSkgICAgZG8ge30gd2hpbGUgKCAwICkKKyNkZWZpbmUgU0NIRURfVU5J
VF9TVEFUU19SRVNFVChfVikgICAgICAgICBkbyB7fSB3aGlsZSAoIDAgKQorI2RlZmluZSBTQ0hF
RF9VTklUX1NUQVRfQ1JBTksoX1YsIF9YKSAgICAgIGRvIHt9IHdoaWxlICggMCApCisjZGVmaW5l
IFNDSEVEX1VOSVRfU1RBVF9TRVQoX1YsIF9YLCBfWSkgICAgZG8ge30gd2hpbGUgKCAwICkKIAog
I2VuZGlmIC8qIFNDSEVEX1NUQVRTICovCiAKQEAgLTEyOCw3ICsxMjgsNyBAQAogI2RlZmluZSBU
UkNfQ1NDSEVEX1NDSEVEX1RBU0tMRVQgVFJDX1NDSEVEX0NMQVNTX0VWVChDU0NIRUQsIDEpCiAj
ZGVmaW5lIFRSQ19DU0NIRURfQUNDT1VOVF9TVEFSVCBUUkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hF
RCwgMikKICNkZWZpbmUgVFJDX0NTQ0hFRF9BQ0NPVU5UX1NUT1AgIFRSQ19TQ0hFRF9DTEFTU19F
VlQoQ1NDSEVELCAzKQotI2RlZmluZSBUUkNfQ1NDSEVEX1NUT0xFTl9WQ1BVICAgVFJDX1NDSEVE
X0NMQVNTX0VWVChDU0NIRUQsIDQpCisjZGVmaW5lIFRSQ19DU0NIRURfU1RPTEVOX1VOSVQgICBU
UkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hFRCwgNCkKICNkZWZpbmUgVFJDX0NTQ0hFRF9QSUNLRURf
Q1BVICAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoQ1NDSEVELCA1KQogI2RlZmluZSBUUkNfQ1NDSEVE
X1RJQ0tMRSAgICAgICAgVFJDX1NDSEVEX0NMQVNTX0VWVChDU0NIRUQsIDYpCiAjZGVmaW5lIFRS
Q19DU0NIRURfQk9PU1RfU1RBUlQgICBUUkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hFRCwgNykKQEAg
LTE1OCwxNSArMTU4LDE1IEBAIHN0cnVjdCBjc2NoZWRfcGNwdSB7CiB9OwogCiAvKgotICogVmly
dHVhbCBDUFUKKyAqIFZpcnR1YWwgVU5JVAogICovCiBzdHJ1Y3QgY3NjaGVkX3VuaXQgewogICAg
IHN0cnVjdCBsaXN0X2hlYWQgcnVucV9lbGVtOwotICAgIHN0cnVjdCBsaXN0X2hlYWQgYWN0aXZl
X3ZjcHVfZWxlbTsKKyAgICBzdHJ1Y3QgbGlzdF9oZWFkIGFjdGl2ZV91bml0X2VsZW07CiAKICAg
ICAvKiBVcC1wb2ludGVycyAqLwogICAgIHN0cnVjdCBjc2NoZWRfZG9tICpzZG9tOwotICAgIHN0
cnVjdCB2Y3B1ICp2Y3B1OworICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0OwogCiAgICAgc190
aW1lX3Qgc3RhcnRfdGltZTsgICAvKiBXaGVuIHdlIHdlcmUgc2NoZWR1bGVkICh1c2VkIGZvciBj
cmVkaXQpICovCiAgICAgdW5zaWduZWQgZmxhZ3M7CkBAIC0xOTQsMTAgKzE5NCwxMCBAQCBzdHJ1
Y3QgY3NjaGVkX3VuaXQgewogICogRG9tYWluCiAgKi8KIHN0cnVjdCBjc2NoZWRfZG9tIHsKLSAg
ICBzdHJ1Y3QgbGlzdF9oZWFkIGFjdGl2ZV92Y3B1OworICAgIHN0cnVjdCBsaXN0X2hlYWQgYWN0
aXZlX3VuaXQ7CiAgICAgc3RydWN0IGxpc3RfaGVhZCBhY3RpdmVfc2RvbV9lbGVtOwogICAgIHN0
cnVjdCBkb21haW4gKmRvbTsKLSAgICB1aW50MTZfdCBhY3RpdmVfdmNwdV9jb3VudDsKKyAgICB1
aW50MTZfdCBhY3RpdmVfdW5pdF9jb3VudDsKICAgICB1aW50MTZfdCB3ZWlnaHQ7CiAgICAgdWlu
dDE2X3QgY2FwOwogfTsKQEAgLTIxNyw3ICsyMTcsNyBAQCBzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUg
ewogCiAgICAgLyogUGVyaW9kIG9mIG1hc3RlciBhbmQgdGljayBpbiBtaWxsaXNlY29uZHMgKi8K
ICAgICB1bnNpZ25lZCBpbnQgdGlja19wZXJpb2RfdXMsIHRpY2tzX3Blcl90c2xpY2U7Ci0gICAg
c190aW1lX3QgcmF0ZWxpbWl0LCB0c2xpY2UsIHZjcHVfbWlncl9kZWxheTsKKyAgICBzX3RpbWVf
dCByYXRlbGltaXQsIHRzbGljZSwgdW5pdF9taWdyX2RlbGF5OwogCiAgICAgc3RydWN0IGxpc3Rf
aGVhZCBhY3RpdmVfc2RvbTsKICAgICB1aW50MzJfdCB3ZWlnaHQ7CkBAIC0yMzMsNyArMjMzLDcg
QEAgc3RhdGljIHZvaWQgY3NjaGVkX3RpY2sodm9pZCAqX2NwdSk7CiBzdGF0aWMgdm9pZCBjc2No
ZWRfYWNjdCh2b2lkICpkdW1teSk7CiAKIHN0YXRpYyBpbmxpbmUgaW50Ci1fX3ZjcHVfb25fcnVu
cShzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKK19fdW5pdF9vbl9ydW5xKHN0cnVjdCBjc2NoZWRf
dW5pdCAqc3ZjKQogewogICAgIHJldHVybiAhbGlzdF9lbXB0eSgmc3ZjLT5ydW5xX2VsZW0pOwog
fQpAQCAtMjQ0LDcgKzI0NCw3IEBAIF9fcnVucV9lbGVtKHN0cnVjdCBsaXN0X2hlYWQgKmVsZW0p
CiAgICAgcmV0dXJuIGxpc3RfZW50cnkoZWxlbSwgc3RydWN0IGNzY2hlZF91bml0LCBydW5xX2Vs
ZW0pOwogfQogCi0vKiBJcyB0aGUgZmlyc3QgZWxlbWVudCBvZiBjcHUncyBydW5xIChpZiBhbnkp
IGNwdSdzIGlkbGUgdmNwdT8gKi8KKy8qIElzIHRoZSBmaXJzdCBlbGVtZW50IG9mIGNwdSdzIHJ1
bnEgKGlmIGFueSkgY3B1J3MgaWRsZSB1bml0PyAqLwogc3RhdGljIGlubGluZSBib29sX3QgaXNf
cnVucV9pZGxlKHVuc2lnbmVkIGludCBjcHUpCiB7CiAgICAgLyoKQEAgLTI1Myw3ICsyNTMsNyBA
QCBzdGF0aWMgaW5saW5lIGJvb2xfdCBpc19ydW5xX2lkbGUodW5zaWduZWQgaW50IGNwdSkKICAg
ICBBU1NFUlQoc3Bpbl9pc19sb2NrZWQoZ2V0X3NjaGVkX3JlcyhjcHUpLT5zY2hlZHVsZV9sb2Nr
KSk7CiAKICAgICByZXR1cm4gbGlzdF9lbXB0eShSVU5RKGNwdSkpIHx8Ci0gICAgICAgICAgIGlz
X2lkbGVfdmNwdShfX3J1bnFfZWxlbShSVU5RKGNwdSktPm5leHQpLT52Y3B1KTsKKyAgICAgICAg
ICAgaXNfaWRsZV91bml0KF9fcnVucV9lbGVtKFJVTlEoY3B1KS0+bmV4dCktPnVuaXQpOwogfQog
CiBzdGF0aWMgaW5saW5lIHZvaWQKQEAgLTI3NSwxMSArMjc1LDExIEBAIGRlY19ucl9ydW5uYWJs
ZSh1bnNpZ25lZCBpbnQgY3B1KQogc3RhdGljIGlubGluZSB2b2lkCiBfX3J1bnFfaW5zZXJ0KHN0
cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewotICAgIHVuc2lnbmVkIGludCBjcHUgPSBzdmMtPnZj
cHUtPnByb2Nlc3NvcjsKKyAgICB1bnNpZ25lZCBpbnQgY3B1ID0gc2NoZWRfdW5pdF9tYXN0ZXIo
c3ZjLT51bml0KTsKICAgICBjb25zdCBzdHJ1Y3QgbGlzdF9oZWFkICogY29uc3QgcnVucSA9IFJV
TlEoY3B1KTsKICAgICBzdHJ1Y3QgbGlzdF9oZWFkICppdGVyOwogCi0gICAgQlVHX09OKCBfX3Zj
cHVfb25fcnVucShzdmMpICk7CisgICAgQlVHX09OKCBfX3VuaXRfb25fcnVucShzdmMpICk7CiAK
ICAgICBsaXN0X2Zvcl9lYWNoKCBpdGVyLCBydW5xICkKICAgICB7CkBAIC0yODgsMTAgKzI4OCwx
MCBAQCBfX3J1bnFfaW5zZXJ0KHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogICAgICAgICAgICAg
YnJlYWs7CiAgICAgfQogCi0gICAgLyogSWYgdGhlIHZjcHUgeWllbGRlZCwgdHJ5IHRvIHB1dCBp
dCBiZWhpbmQgb25lIGxvd2VyLXByaW9yaXR5Ci0gICAgICogcnVubmFibGUgdmNwdSBpZiB3ZSBj
YW4uICBUaGUgbmV4dCBydW5xX3NvcnQgd2lsbCBicmluZyBpdCBmb3J3YXJkCisgICAgLyogSWYg
dGhlIHVuaXQgeWllbGRlZCwgdHJ5IHRvIHB1dCBpdCBiZWhpbmQgb25lIGxvd2VyLXByaW9yaXR5
CisgICAgICogcnVubmFibGUgdW5pdCBpZiB3ZSBjYW4uICBUaGUgbmV4dCBydW5xX3NvcnQgd2ls
bCBicmluZyBpdCBmb3J3YXJkCiAgICAgICogd2l0aGluIDMwbXMgaWYgdGhlIHF1ZXVlIHRvbyBs
b25nLiAqLwotICAgIGlmICggdGVzdF9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9ZSUVMRCwgJnN2Yy0+
ZmxhZ3MpCisgICAgaWYgKCB0ZXN0X2JpdChDU0NIRURfRkxBR19VTklUX1lJRUxELCAmc3ZjLT5m
bGFncykKICAgICAgICAgICYmIF9fcnVucV9lbGVtKGl0ZXIpLT5wcmkgPiBDU0NIRURfUFJJX0lE
TEUgKQogICAgIHsKICAgICAgICAgaXRlcj1pdGVyLT5uZXh0OwpAQCAtMzA3LDIwICszMDcsMjAg
QEAgc3RhdGljIGlubGluZSB2b2lkCiBydW5xX2luc2VydChzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2
YykKIHsKICAgICBfX3J1bnFfaW5zZXJ0KHN2Yyk7Ci0gICAgaW5jX25yX3J1bm5hYmxlKHN2Yy0+
dmNwdS0+cHJvY2Vzc29yKTsKKyAgICBpbmNfbnJfcnVubmFibGUoc2NoZWRfdW5pdF9tYXN0ZXIo
c3ZjLT51bml0KSk7CiB9CiAKIHN0YXRpYyBpbmxpbmUgdm9pZAogX19ydW5xX3JlbW92ZShzdHJ1
Y3QgY3NjaGVkX3VuaXQgKnN2YykKIHsKLSAgICBCVUdfT04oICFfX3ZjcHVfb25fcnVucShzdmMp
ICk7CisgICAgQlVHX09OKCAhX191bml0X29uX3J1bnEoc3ZjKSApOwogICAgIGxpc3RfZGVsX2lu
aXQoJnN2Yy0+cnVucV9lbGVtKTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lkCiBydW5xX3JlbW92
ZShzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKIHsKLSAgICBkZWNfbnJfcnVubmFibGUoc3ZjLT52
Y3B1LT5wcm9jZXNzb3IpOworICAgIGRlY19ucl9ydW5uYWJsZShzY2hlZF91bml0X21hc3Rlcihz
dmMtPnVuaXQpKTsKICAgICBfX3J1bnFfcmVtb3ZlKHN2Yyk7CiB9CiAKQEAgLTMzMSw3ICszMzEs
NyBAQCBzdGF0aWMgdm9pZCBidXJuX2NyZWRpdHMoc3RydWN0IGNzY2hlZF91bml0ICpzdmMsIHNf
dGltZV90IG5vdykKICAgICB1bnNpZ25lZCBpbnQgY3JlZGl0czsKIAogICAgIC8qIEFzc2VydCBz
dmMgaXMgY3VycmVudCAqLwotICAgIEFTU0VSVCggc3ZjID09IENTQ0hFRF9VTklUKGN1cnJfb25f
Y3B1KHN2Yy0+dmNwdS0+cHJvY2Vzc29yKSkgKTsKKyAgICBBU1NFUlQoIHN2YyA9PSBDU0NIRURf
VU5JVChjdXJyX29uX2NwdShzY2hlZF91bml0X21hc3RlcihzdmMtPnVuaXQpKSkgKTsKIAogICAg
IGlmICggKGRlbHRhID0gbm93IC0gc3ZjLT5zdGFydF90aW1lKSA8PSAwICkKICAgICAgICAgcmV0
dXJuOwpAQCAtMzUxLDggKzM1MSw4IEBAIERFRklORV9QRVJfQ1BVKHVuc2lnbmVkIGludCwgbGFz
dF90aWNrbGVfY3B1KTsKIAogc3RhdGljIGlubGluZSB2b2lkIF9fcnVucV90aWNrbGUoc3RydWN0
IGNzY2hlZF91bml0ICpuZXcpCiB7Ci0gICAgdW5zaWduZWQgaW50IGNwdSA9IG5ldy0+dmNwdS0+
cHJvY2Vzc29yOwotICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0ID0gbmV3LT52Y3B1LT5zY2hl
ZF91bml0OworICAgIHVuc2lnbmVkIGludCBjcHUgPSBzY2hlZF91bml0X21hc3RlcihuZXctPnVu
aXQpOworICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0ID0gbmV3LT51bml0OwogICAgIHN0cnVj
dCBjc2NoZWRfdW5pdCAqIGNvbnN0IGN1ciA9IENTQ0hFRF9VTklUKGN1cnJfb25fY3B1KGNwdSkp
OwogICAgIHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2ID0gQ1NDSEVEX1BSSVYocGVyX2NwdShz
Y2hlZHVsZXIsIGNwdSkpOwogICAgIGNwdW1hc2tfdCBtYXNrLCBpZGxlX21hc2ssICpvbmxpbmU7
CkBAIC0zNjYsMTYgKzM2NiwxNiBAQCBzdGF0aWMgaW5saW5lIHZvaWQgX19ydW5xX3RpY2tsZShz
dHJ1Y3QgY3NjaGVkX3VuaXQgKm5ldykKICAgICBpZGxlcnNfZW1wdHkgPSBjcHVtYXNrX2VtcHR5
KCZpZGxlX21hc2spOwogCiAgICAgLyoKLSAgICAgKiBFeGNsdXNpdmUgcGlubmluZyBpcyB3aGVu
IGEgdmNwdSBoYXMgaGFyZC1hZmZpbml0eSB3aXRoIG9ubHkgb25lCi0gICAgICogY3B1LCBhbmQg
dGhlcmUgaXMgbm8gb3RoZXIgdmNwdSB0aGF0IGhhcyBoYXJkLWFmZmluaXR5IHdpdGggdGhhdAor
ICAgICAqIEV4Y2x1c2l2ZSBwaW5uaW5nIGlzIHdoZW4gYSB1bml0IGhhcyBoYXJkLWFmZmluaXR5
IHdpdGggb25seSBvbmUKKyAgICAgKiBjcHUsIGFuZCB0aGVyZSBpcyBubyBvdGhlciB1bml0IHRo
YXQgaGFzIGhhcmQtYWZmaW5pdHkgd2l0aCB0aGF0CiAgICAgICogc2FtZSBjcHUuIFRoaXMgaXMg
aW5mcmVxdWVudCwgYnV0IGlmIGl0IGhhcHBlbnMsIGlzIGZvciBhY2hpZXZpbmcKICAgICAgKiB0
aGUgbW9zdCBwb3NzaWJsZSBkZXRlcm1pbmlzbSwgYW5kIGxlYXN0IHBvc3NpYmxlIG92ZXJoZWFk
IGZvcgotICAgICAqIHRoZSB2Y3B1cyBpbiBxdWVzdGlvbi4KKyAgICAgKiB0aGUgdW5pdHMgaW4g
cXVlc3Rpb24uCiAgICAgICoKICAgICAgKiBUcnkgdG8gaWRlbnRpZnkgdGhlIHZhc3QgbWFqb3Jp
dHkgb2YgdGhlc2Ugc2l0dWF0aW9ucywgYW5kIGRlYWwKICAgICAgKiB3aXRoIHRoZW0gcXVpY2ts
eS4KICAgICAgKi8KLSAgICBpZiAoIHVubGlrZWx5KHRlc3RfYml0KENTQ0hFRF9GTEFHX1ZDUFVf
UElOTkVELCAmbmV3LT5mbGFncykgJiYKKyAgICBpZiAoIHVubGlrZWx5KHRlc3RfYml0KENTQ0hF
RF9GTEFHX1VOSVRfUElOTkVELCAmbmV3LT5mbGFncykgJiYKICAgICAgICAgICAgICAgICAgIGNw
dW1hc2tfdGVzdF9jcHUoY3B1LCAmaWRsZV9tYXNrKSkgKQogICAgIHsKICAgICAgICAgQVNTRVJU
KGNwdW1hc2tfY3ljbGUoY3B1LCB1bml0LT5jcHVfaGFyZF9hZmZpbml0eSkgPT0gY3B1KTsKQEAg
LTM4Niw3ICszODYsNyBAQCBzdGF0aWMgaW5saW5lIHZvaWQgX19ydW5xX3RpY2tsZShzdHJ1Y3Qg
Y3NjaGVkX3VuaXQgKm5ldykKIAogICAgIC8qCiAgICAgICogSWYgdGhlIHBjcHUgaXMgaWRsZSwg
b3IgdGhlcmUgYXJlIG5vIGlkbGVycyBhbmQgdGhlIG5ldwotICAgICAqIHZjcHUgaXMgYSBoaWdo
ZXIgcHJpb3JpdHkgdGhhbiB0aGUgb2xkIHZjcHUsIHJ1biBpdCBoZXJlLgorICAgICAqIHVuaXQg
aXMgYSBoaWdoZXIgcHJpb3JpdHkgdGhhbiB0aGUgb2xkIHVuaXQsIHJ1biBpdCBoZXJlLgogICAg
ICAqCiAgICAgICogSWYgdGhlcmUgYXJlIGlkbGUgY3B1cywgZmlyc3QgdHJ5IHRvIGZpbmQgb25l
IHN1aXRhYmxlIHRvIHJ1bgogICAgICAqIG5ldywgc28gd2UgY2FuIGF2b2lkIHByZWVtcHRpbmcg
Y3VyLiAgSWYgd2UgY2Fubm90IGZpbmQgYQpAQCAtNDA1LDcgKzQwNSw3IEBAIHN0YXRpYyBpbmxp
bmUgdm9pZCBfX3J1bnFfdGlja2xlKHN0cnVjdCBjc2NoZWRfdW5pdCAqbmV3KQogICAgIGVsc2Ug
aWYgKCAhaWRsZXJzX2VtcHR5ICkKICAgICB7CiAgICAgICAgIC8qCi0gICAgICAgICAqIFNvZnQg
YW5kIGhhcmQgYWZmaW5pdHkgYmFsYW5jaW5nIGxvb3AuIEZvciB2Y3B1cyB3aXRob3V0CisgICAg
ICAgICAqIFNvZnQgYW5kIGhhcmQgYWZmaW5pdHkgYmFsYW5jaW5nIGxvb3AuIEZvciB1bml0cyB3
aXRob3V0CiAgICAgICAgICAqIGEgdXNlZnVsIHNvZnQgYWZmaW5pdHksIGNvbnNpZGVyIGhhcmQg
YWZmaW5pdHkgb25seS4KICAgICAgICAgICovCiAgICAgICAgIGZvcl9lYWNoX2FmZmluaXR5X2Jh
bGFuY2Vfc3RlcCggYmFsYW5jZV9zdGVwICkKQEAgLTQ0OCwxMCArNDQ4LDEwIEBAIHN0YXRpYyBp
bmxpbmUgdm9pZCBfX3J1bnFfdGlja2xlKHN0cnVjdCBjc2NoZWRfdW5pdCAqbmV3KQogICAgICAg
ICAgICAgewogICAgICAgICAgICAgICAgIGlmICggY3B1bWFza19pbnRlcnNlY3RzKHVuaXQtPmNw
dV9oYXJkX2FmZmluaXR5LCAmaWRsZV9tYXNrKSApCiAgICAgICAgICAgICAgICAgewotICAgICAg
ICAgICAgICAgICAgICBTQ0hFRF9WQ1BVX1NUQVRfQ1JBTksoY3VyLCBraWNrZWRfYXdheSk7Ci0g
ICAgICAgICAgICAgICAgICAgIFNDSEVEX1ZDUFVfU1RBVF9DUkFOSyhjdXIsIG1pZ3JhdGVfcik7
CisgICAgICAgICAgICAgICAgICAgIFNDSEVEX1VOSVRfU1RBVF9DUkFOSyhjdXIsIGtpY2tlZF9h
d2F5KTsKKyAgICAgICAgICAgICAgICAgICAgU0NIRURfVU5JVF9TVEFUX0NSQU5LKGN1ciwgbWln
cmF0ZV9yKTsKICAgICAgICAgICAgICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyhtaWdyYXRlX2tp
Y2tlZF9hd2F5KTsKLSAgICAgICAgICAgICAgICAgICAgc2V0X2JpdChfVlBGX21pZ3JhdGluZywg
JmN1ci0+dmNwdS0+cGF1c2VfZmxhZ3MpOworICAgICAgICAgICAgICAgICAgICBzY2hlZF9zZXRf
cGF1c2VfZmxhZ3NfYXRvbWljKGN1ci0+dW5pdCwgX1ZQRl9taWdyYXRpbmcpOwogICAgICAgICAg
ICAgICAgIH0KICAgICAgICAgICAgICAgICAvKiBUaWNrbGUgY3B1IGFueXdheSwgdG8gbGV0IG5l
dyBwcmVlbXB0IGN1ci4gKi8KICAgICAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHRpY2ts
ZWRfYnVzeV9jcHUpOwpAQCAtNjA3LDcgKzYwNyw3IEBAIGluaXRfcGRhdGEoc3RydWN0IGNzY2hl
ZF9wcml2YXRlICpwcnYsIHN0cnVjdCBjc2NoZWRfcGNwdSAqc3BjLCBpbnQgY3B1KQogICAgIHNw
Yy0+aWRsZV9iaWFzID0gbnJfY3B1X2lkcyAtIDE7CiAKICAgICAvKiBTdGFydCBvZmYgaWRsaW5n
Li4uICovCi0gICAgQlVHX09OKCFpc19pZGxlX3ZjcHUoY3Vycl9vbl9jcHUoY3B1KS0+dmNwdV9s
aXN0KSk7CisgICAgQlVHX09OKCFpc19pZGxlX3VuaXQoY3Vycl9vbl9jcHUoY3B1KSkpOwogICAg
IGNwdW1hc2tfc2V0X2NwdShjcHUsIHBydi0+aWRsZXJzKTsKICAgICBzcGMtPm5yX3J1bm5hYmxl
ID0gMDsKIH0KQEAgLTYzMiw5ICs2MzIsOSBAQCBjc2NoZWRfc3dpdGNoX3NjaGVkKHN0cnVjdCBz
Y2hlZHVsZXIgKm5ld19vcHMsIHVuc2lnbmVkIGludCBjcHUsCiAgICAgc3RydWN0IGNzY2hlZF9w
cml2YXRlICpwcnYgPSBDU0NIRURfUFJJVihuZXdfb3BzKTsKICAgICBzdHJ1Y3QgY3NjaGVkX3Vu
aXQgKnN2YyA9IHZkYXRhOwogCi0gICAgQVNTRVJUKHN2YyAmJiBpc19pZGxlX3ZjcHUoc3ZjLT52
Y3B1KSk7CisgICAgQVNTRVJUKHN2YyAmJiBpc19pZGxlX3VuaXQoc3ZjLT51bml0KSk7CiAKLSAg
ICBpZGxlX3ZjcHVbY3B1XS0+c2NoZWRfdW5pdC0+cHJpdiA9IHZkYXRhOworICAgIHNjaGVkX2lk
bGVfdW5pdChjcHUpLT5wcml2ID0gdmRhdGE7CiAKICAgICAvKgogICAgICAqIFdlIGFyZSBob2xk
aW5nIHRoZSBydW5xdWV1ZSBsb2NrIGFscmVhZHkgKGl0J3MgYmVlbiB0YWtlbiBpbgpAQCAtNjUx
LDMzICs2NTEsMzMgQEAgY3NjaGVkX3N3aXRjaF9zY2hlZChzdHJ1Y3Qgc2NoZWR1bGVyICpuZXdf
b3BzLCB1bnNpZ25lZCBpbnQgY3B1LAogCiAjaWZuZGVmIE5ERUJVRwogc3RhdGljIGlubGluZSB2
b2lkCi1fX2NzY2hlZF92Y3B1X2NoZWNrKHN0cnVjdCB2Y3B1ICp2YykKK19fY3NjaGVkX3VuaXRf
Y2hlY2soc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAgc3RydWN0IGNzY2hlZF91bml0
ICogY29uc3Qgc3ZjID0gQ1NDSEVEX1VOSVQodmMtPnNjaGVkX3VuaXQpOworICAgIHN0cnVjdCBj
c2NoZWRfdW5pdCAqIGNvbnN0IHN2YyA9IENTQ0hFRF9VTklUKHVuaXQpOwogICAgIHN0cnVjdCBj
c2NoZWRfZG9tICogY29uc3Qgc2RvbSA9IHN2Yy0+c2RvbTsKIAotICAgIEJVR19PTiggc3ZjLT52
Y3B1ICE9IHZjICk7Ci0gICAgQlVHX09OKCBzZG9tICE9IENTQ0hFRF9ET00odmMtPmRvbWFpbikg
KTsKKyAgICBCVUdfT04oIHN2Yy0+dW5pdCAhPSB1bml0ICk7CisgICAgQlVHX09OKCBzZG9tICE9
IENTQ0hFRF9ET00odW5pdC0+ZG9tYWluKSApOwogICAgIGlmICggc2RvbSApCiAgICAgewotICAg
ICAgICBCVUdfT04oIGlzX2lkbGVfdmNwdSh2YykgKTsKLSAgICAgICAgQlVHX09OKCBzZG9tLT5k
b20gIT0gdmMtPmRvbWFpbiApOworICAgICAgICBCVUdfT04oIGlzX2lkbGVfdW5pdCh1bml0KSAp
OworICAgICAgICBCVUdfT04oIHNkb20tPmRvbSAhPSB1bml0LT5kb21haW4gKTsKICAgICB9CiAg
ICAgZWxzZQogICAgIHsKLSAgICAgICAgQlVHX09OKCAhaXNfaWRsZV92Y3B1KHZjKSApOworICAg
ICAgICBCVUdfT04oICFpc19pZGxlX3VuaXQodW5pdCkgKTsKICAgICB9CiAKICAgICBTQ0hFRF9T
VEFUX0NSQU5LKHVuaXRfY2hlY2spOwogfQotI2RlZmluZSBDU0NIRURfVkNQVV9DSEVDSyhfdmMp
ICAoX19jc2NoZWRfdmNwdV9jaGVjayhfdmMpKQorI2RlZmluZSBDU0NIRURfVU5JVF9DSEVDSyh1
bml0KSAgKF9fY3NjaGVkX3VuaXRfY2hlY2sodW5pdCkpCiAjZWxzZQotI2RlZmluZSBDU0NIRURf
VkNQVV9DSEVDSyhfdmMpCisjZGVmaW5lIENTQ0hFRF9VTklUX0NIRUNLKHVuaXQpCiAjZW5kaWYK
IAogLyoKLSAqIERlbGF5LCBpbiBtaWNyb3NlY29uZHMsIGJldHdlZW4gbWlncmF0aW9ucyBvZiBh
IFZDUFUgYmV0d2VlbiBQQ1BVcy4KLSAqIFRoaXMgcHJldmVudHMgcmFwaWQgZmx1dHRlcmluZyBv
ZiBhIFZDUFUgYmV0d2VlbiBDUFVzLCBhbmQgcmVkdWNlcyB0aGUKKyAqIERlbGF5LCBpbiBtaWNy
b3NlY29uZHMsIGJldHdlZW4gbWlncmF0aW9ucyBvZiBhIFVOSVQgYmV0d2VlbiBQQ1BVcy4KKyAq
IFRoaXMgcHJldmVudHMgcmFwaWQgZmx1dHRlcmluZyBvZiBhIFVOSVQgYmV0d2VlbiBDUFVzLCBh
bmQgcmVkdWNlcyB0aGUKICAqIGltcGxpY2l0IG92ZXJoZWFkcyBzdWNoIGFzIGNhY2hlLXdhcm1p
bmcuIDFtcyAoMTAwMCkgaGFzIGJlZW4gbWVhc3VyZWQKICAqIGFzIGEgZ29vZCB2YWx1ZS4KICAq
LwpAQCAtNjg4LDggKzY4OCw4IEBAIHN0YXRpYyBpbmxpbmUgYm9vbAogX19jc2NoZWRfdmNwdV9p
c19jYWNoZV9ob3QoY29uc3Qgc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBjb25zdCBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKIHsKLSAgICBi
b29sIGhvdCA9IHBydi0+dmNwdV9taWdyX2RlbGF5ICYmCi0gICAgICAgICAgICAgICAoTk9XKCkg
LSBzdmMtPmxhc3Rfc2NoZWRfdGltZSkgPCBwcnYtPnZjcHVfbWlncl9kZWxheTsKKyAgICBib29s
IGhvdCA9IHBydi0+dW5pdF9taWdyX2RlbGF5ICYmCisgICAgICAgICAgICAgICAoTk9XKCkgLSBz
dmMtPmxhc3Rfc2NoZWRfdGltZSkgPCBwcnYtPnVuaXRfbWlncl9kZWxheTsKIAogICAgIGlmICgg
aG90ICkKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0X2hvdCk7CkBAIC02OTgsMzcgKzY5
OCwzOSBAQCBfX2NzY2hlZF92Y3B1X2lzX2NhY2hlX2hvdChjb25zdCBzdHJ1Y3QgY3NjaGVkX3By
aXZhdGUgKnBydiwKIH0KIAogc3RhdGljIGlubGluZSBpbnQKLV9fY3NjaGVkX3ZjcHVfaXNfbWln
cmF0ZWFibGUoY29uc3Qgc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHN0cnVjdCB2Y3B1ICp2
YywKK19fY3NjaGVkX3VuaXRfaXNfbWlncmF0ZWFibGUoY29uc3Qgc3RydWN0IGNzY2hlZF9wcml2
YXRlICpwcnYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBzY2hlZF91bml0
ICp1bml0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgZGVzdF9jcHUsIGNwdW1h
c2tfdCAqbWFzaykKIHsKLSAgICBjb25zdCBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YyA9IENTQ0hF
RF9VTklUKHZjLT5zY2hlZF91bml0KTsKKyAgICBjb25zdCBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2
YyA9IENTQ0hFRF9VTklUKHVuaXQpOwogICAgIC8qCiAgICAgICogRG9uJ3QgcGljayB1cCB3b3Jr
IHRoYXQncyBob3Qgb24gcGVlciBQQ1BVLCBvciB0aGF0IGNhbid0IChvcgogICAgICAqIHdvdWxk
IHByZWZlciBub3QgdG8pIHJ1biBvbiBjcHUuCiAgICAgICoKLSAgICAgKiBUaGUgY2FsbGVyIGlz
IHN1cHBvc2VkIHRvIGhhdmUgYWxyZWFkeSBjaGVja2VkIHRoYXQgdmMgaXMgYWxzbworICAgICAq
IFRoZSBjYWxsZXIgaXMgc3VwcG9zZWQgdG8gaGF2ZSBhbHJlYWR5IGNoZWNrZWQgdGhhdCB1bml0
IGlzIGFsc28KICAgICAgKiBub3QgcnVubmluZy4KICAgICAgKi8KLSAgICBBU1NFUlQoIXZjLT5z
Y2hlZF91bml0LT5pc19ydW5uaW5nKTsKKyAgICBBU1NFUlQoIXVuaXQtPmlzX3J1bm5pbmcpOwog
CiAgICAgcmV0dXJuICFfX2NzY2hlZF92Y3B1X2lzX2NhY2hlX2hvdChwcnYsIHN2YykgJiYKICAg
ICAgICAgICAgY3B1bWFza190ZXN0X2NwdShkZXN0X2NwdSwgbWFzayk7CiB9CiAKIHN0YXRpYyBp
bnQKLV9jc2NoZWRfY3B1X3BpY2soY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qg
dmNwdSAqdmMsIGJvb2xfdCBjb21taXQpCitfY3NjaGVkX2NwdV9waWNrKGNvbnN0IHN0cnVjdCBz
Y2hlZHVsZXIgKm9wcywgY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAgICAgICAg
ICAgICAgIGJvb2xfdCBjb21taXQpCiB7Ci0gICAgLyogV2UgbXVzdCBhbHdheXMgdXNlIHZjLT5w
cm9jc3NvcidzIHNjcmF0Y2ggc3BhY2UgKi8KLSAgICBjcHVtYXNrX3QgKmNwdXMgPSBjcHVtYXNr
X3NjcmF0Y2hfY3B1KHZjLT5wcm9jZXNzb3IpOworICAgIGludCBjcHUgPSBzY2hlZF91bml0X21h
c3Rlcih1bml0KTsKKyAgICAvKiBXZSBtdXN0IGFsd2F5cyB1c2UgY3B1J3Mgc2NyYXRjaCBzcGFj
ZSAqLworICAgIGNwdW1hc2tfdCAqY3B1cyA9IGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KTsKICAg
ICBjcHVtYXNrX3QgaWRsZXJzOwotICAgIGNwdW1hc2tfdCAqb25saW5lID0gY3B1cG9vbF9kb21h
aW5fY3B1bWFzayh2Yy0+ZG9tYWluKTsKKyAgICBjcHVtYXNrX3QgKm9ubGluZSA9IGNwdXBvb2xf
ZG9tYWluX2NwdW1hc2sodW5pdC0+ZG9tYWluKTsKICAgICBzdHJ1Y3QgY3NjaGVkX3BjcHUgKnNw
YyA9IE5VTEw7Ci0gICAgaW50IGNwdSA9IHZjLT5wcm9jZXNzb3I7CiAgICAgaW50IGJhbGFuY2Vf
c3RlcDsKIAogICAgIGZvcl9lYWNoX2FmZmluaXR5X2JhbGFuY2Vfc3RlcCggYmFsYW5jZV9zdGVw
ICkKICAgICB7Ci0gICAgICAgIGFmZmluaXR5X2JhbGFuY2VfY3B1bWFzayh2Yy0+c2NoZWRfdW5p
dCwgYmFsYW5jZV9zdGVwLCBjcHVzKTsKKyAgICAgICAgYWZmaW5pdHlfYmFsYW5jZV9jcHVtYXNr
KHVuaXQsIGJhbGFuY2Vfc3RlcCwgY3B1cyk7CiAgICAgICAgIGNwdW1hc2tfYW5kKGNwdXMsIG9u
bGluZSwgY3B1cyk7CiAgICAgICAgIC8qCiAgICAgICAgICAqIFdlIHdhbnQgdG8gcGljayB1cCBh
IHBjcHUgYW1vbmcgdGhlIG9uZXMgdGhhdCBhcmUgb25saW5lIGFuZApAQCAtNzQ3LDEyICs3NDks
MTMgQEAgX2NzY2hlZF9jcHVfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVj
dCB2Y3B1ICp2YywgYm9vbF90IGNvbW1pdCkKICAgICAgICAgICogYmFsYW5jaW5nIHN0ZXAgYWxs
IHRvZ2V0aGVyLgogICAgICAgICAgKi8KICAgICAgICAgaWYgKCBiYWxhbmNlX3N0ZXAgPT0gQkFM
QU5DRV9TT0ZUX0FGRklOSVRZICYmCi0gICAgICAgICAgICAgKCFoYXNfc29mdF9hZmZpbml0eSh2
Yy0+c2NoZWRfdW5pdCkgfHwgY3B1bWFza19lbXB0eShjcHVzKSkgKQorICAgICAgICAgICAgICgh
aGFzX3NvZnRfYWZmaW5pdHkodW5pdCkgfHwgY3B1bWFza19lbXB0eShjcHVzKSkgKQogICAgICAg
ICAgICAgY29udGludWU7CiAKICAgICAgICAgLyogSWYgcHJlc2VudCwgcHJlZmVyIHZjJ3MgY3Vy
cmVudCBwcm9jZXNzb3IgKi8KLSAgICAgICAgY3B1ID0gY3B1bWFza190ZXN0X2NwdSh2Yy0+cHJv
Y2Vzc29yLCBjcHVzKQotICAgICAgICAgICAgICAgID8gdmMtPnByb2Nlc3NvciA6IGNwdW1hc2tf
Y3ljbGUodmMtPnByb2Nlc3NvciwgY3B1cyk7CisgICAgICAgIGNwdSA9IGNwdW1hc2tfdGVzdF9j
cHUoc2NoZWRfdW5pdF9tYXN0ZXIodW5pdCksIGNwdXMpCisgICAgICAgICAgICAgICAgPyBzY2hl
ZF91bml0X21hc3Rlcih1bml0KQorICAgICAgICAgICAgICAgIDogY3B1bWFza19jeWNsZShzY2hl
ZF91bml0X21hc3Rlcih1bml0KSwgY3B1cyk7CiAgICAgICAgIEFTU0VSVChjcHVtYXNrX3Rlc3Rf
Y3B1KGNwdSwgY3B1cykpOwogCiAgICAgICAgIC8qCkBAIC03NjQsMTUgKzc2NywxNSBAQCBfY3Nj
aGVkX2NwdV9waWNrKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHZjcHUgKnZj
LCBib29sX3QgY29tbWl0KQogICAgICAgICAgKiBXZSBnaXZlIHByZWZlcmVuY2UgdG8gdGhlIGlk
bGUgZXhlY3V0aW9uIHZlaGljbGUgd2l0aCB0aGUgbW9zdAogICAgICAgICAgKiBpZGxpbmcgbmVp
Z2hib3VycyBpbiBpdHMgZ3JvdXBpbmcuIFRoaXMgZGlzdHJpYnV0ZXMgd29yayBhY3Jvc3MKICAg
ICAgICAgICogZGlzdGluY3QgY29yZXMgZmlyc3QgYW5kIGd1YXJhbnRlZXMgd2UgZG9uJ3QgZG8g
c29tZXRoaW5nIHN0dXBpZAotICAgICAgICAgKiBsaWtlIHJ1biB0d28gVkNQVXMgb24gY28taHlw
ZXJ0aHJlYWRzIHdoaWxlIHRoZXJlIGFyZSBpZGxlIGNvcmVzCisgICAgICAgICAqIGxpa2UgcnVu
IHR3byBVTklUcyBvbiBjby1oeXBlcnRocmVhZHMgd2hpbGUgdGhlcmUgYXJlIGlkbGUgY29yZXMK
ICAgICAgICAgICogb3Igc29ja2V0cy4KICAgICAgICAgICoKICAgICAgICAgICogTm90aWNlIHRo
YXQsIHdoZW4gY29tcHV0aW5nIHRoZSAiaWRsZW5lc3MiIG9mIGNwdSwgd2UgbWF5IHdhbnQgdG8K
LSAgICAgICAgICogZGlzY291bnQgdmMuIFRoYXQgaXMsIGlmZiB2YyBpcyB0aGUgY3VycmVudGx5
IHJ1bm5pbmcgYW5kIHRoZSBvbmx5Ci0gICAgICAgICAqIHJ1bm5hYmxlIHZjcHUgb24gY3B1LCB3
ZSBhZGQgY3B1IHRvIHRoZSBpZGxlcnMuCisgICAgICAgICAqIGRpc2NvdW50IHVuaXQuIFRoYXQg
aXMsIGlmZiB1bml0IGlzIHRoZSBjdXJyZW50bHkgcnVubmluZyBhbmQgdGhlCisgICAgICAgICAq
IG9ubHkgcnVubmFibGUgdW5pdCBvbiBjcHUsIHdlIGFkZCBjcHUgdG8gdGhlIGlkbGVycy4KICAg
ICAgICAgICovCiAgICAgICAgIGNwdW1hc2tfYW5kKCZpZGxlcnMsICZjcHVfb25saW5lX21hcCwg
Q1NDSEVEX1BSSVYob3BzKS0+aWRsZXJzKTsKLSAgICAgICAgaWYgKCB2Yy0+cHJvY2Vzc29yID09
IGNwdSAmJiBpc19ydW5xX2lkbGUoY3B1KSApCisgICAgICAgIGlmICggc2NoZWRfdW5pdF9tYXN0
ZXIodW5pdCkgPT0gY3B1ICYmIGlzX3J1bnFfaWRsZShjcHUpICkKICAgICAgICAgICAgIF9fY3B1
bWFza19zZXRfY3B1KGNwdSwgJmlkbGVycyk7CiAgICAgICAgIGNwdW1hc2tfYW5kKGNwdXMsICZp
ZGxlcnMsIGNwdXMpOwogCkBAIC03ODIsNyArNzg1LDcgQEAgX2NzY2hlZF9jcHVfcGljayhjb25z
dCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1ICp2YywgYm9vbF90IGNvbW1pdCkK
ICAgICAgICAgICogQ1BVLCBhcyB3ZSBqdXN0ICYmLWVkIGl0IHdpdGggaWRsZXJzKS4gSW4gZmFj
dCwgaWYgd2UgYXJlIG9uIFNNVCwgYW5kCiAgICAgICAgICAqIGNwdSBwb2ludHMgdG8gYSBidXN5
IHRocmVhZCB3aXRoIGFuIGlkbGUgc2libGluZywgYm90aCB0aGUgdGhyZWFkcwogICAgICAgICAg
KiB3aWxsIGJlIGNvbnNpZGVyZWQgdGhlIHNhbWUsIGZyb20gdGhlICJpZGxlbmVzcyIgY2FsY3Vs
YXRpb24gcG9pbnQKLSAgICAgICAgICogb2YgdmlldyIsIHByZXZlbnRpbmcgdmNwdSBmcm9tIGJl
aW5nIG1vdmVkIHRvIHRoZSB0aHJlYWQgdGhhdCBpcworICAgICAgICAgKiBvZiB2aWV3IiwgcHJl
dmVudGluZyB1bml0IGZyb20gYmVpbmcgbW92ZWQgdG8gdGhlIHRocmVhZCB0aGF0IGlzCiAgICAg
ICAgICAqIGFjdHVhbGx5IGlkbGUuCiAgICAgICAgICAqCiAgICAgICAgICAqIE5vdGljZSB0aGF0
IGNwdW1hc2tfdGVzdF9jcHUoKSBpcyBxdWlja2VyIHRoYW4gY3B1bWFza19lbXB0eSgpLCBzbwpA
QCAtODQ4LDcgKzg1MSw4IEBAIF9jc2NoZWRfY3B1X3BpY2soY29uc3Qgc3RydWN0IHNjaGVkdWxl
ciAqb3BzLCBzdHJ1Y3QgdmNwdSAqdmMsIGJvb2xfdCBjb21taXQpCiAgICAgaWYgKCBjb21taXQg
JiYgc3BjICkKICAgICAgICBzcGMtPmlkbGVfYmlhcyA9IGNwdTsKIAotICAgIFRSQUNFXzNEKFRS
Q19DU0NIRURfUElDS0VEX0NQVSwgdmMtPmRvbWFpbi0+ZG9tYWluX2lkLCB2Yy0+dmNwdV9pZCwg
Y3B1KTsKKyAgICBUUkFDRV8zRChUUkNfQ1NDSEVEX1BJQ0tFRF9DUFUsIHVuaXQtPmRvbWFpbi0+
ZG9tYWluX2lkLCB1bml0LT51bml0X2lkLAorICAgICAgICAgICAgIGNwdSk7CiAKICAgICByZXR1
cm4gY3B1OwogfQpAQCAtODU2LDcgKzg2MCw2IEBAIF9jc2NoZWRfY3B1X3BpY2soY29uc3Qgc3Ry
dWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3QgdmNwdSAqdmMsIGJvb2xfdCBjb21taXQpCiBzdGF0
aWMgc3RydWN0IHNjaGVkX3Jlc291cmNlICoKIGNzY2hlZF9yZXNfcGljayhjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMsIGNvbnN0IHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQogewotICAgIHN0
cnVjdCB2Y3B1ICp2YyA9IHVuaXQtPnZjcHVfbGlzdDsKICAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQg
KnN2YyA9IENTQ0hFRF9VTklUKHVuaXQpOwogCiAgICAgLyoKQEAgLTg2NiwyNiArODY5LDI2IEBA
IGNzY2hlZF9yZXNfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIGNvbnN0IHN0cnVj
dCBzY2hlZF91bml0ICp1bml0KQogICAgICAqIGNzY2hlZF91bml0X3dha2UoKSAoc3RpbGwgY2Fs
bGVkIGZyb20gdmNwdV9taWdyYXRlKCkpIHdlIHdvbid0CiAgICAgICogZ2V0IGJvb3N0ZWQsIHdo
aWNoIHdlIGRvbid0IGRlc2VydmUgYXMgd2UgYXJlICJvbmx5IiBtaWdyYXRpbmcuCiAgICAgICov
Ci0gICAgc2V0X2JpdChDU0NIRURfRkxBR19WQ1BVX01JR1JBVElORywgJnN2Yy0+ZmxhZ3MpOwot
ICAgIHJldHVybiBnZXRfc2NoZWRfcmVzKF9jc2NoZWRfY3B1X3BpY2sob3BzLCB2YywgMSkpOwor
ICAgIHNldF9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9NSUdSQVRJTkcsICZzdmMtPmZsYWdzKTsKKyAg
ICByZXR1cm4gZ2V0X3NjaGVkX3JlcyhfY3NjaGVkX2NwdV9waWNrKG9wcywgdW5pdCwgMSkpOwog
fQogCiBzdGF0aWMgaW5saW5lIHZvaWQKLV9fY3NjaGVkX3ZjcHVfYWNjdF9zdGFydChzdHJ1Y3Qg
Y3NjaGVkX3ByaXZhdGUgKnBydiwgc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCitfX2NzY2hlZF91
bml0X2FjY3Rfc3RhcnQoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHN0cnVjdCBjc2NoZWRf
dW5pdCAqc3ZjKQogewogICAgIHN0cnVjdCBjc2NoZWRfZG9tICogY29uc3Qgc2RvbSA9IHN2Yy0+
c2RvbTsKICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwogCiAgICAgc3Bpbl9sb2NrX2lycXNhdmUo
JnBydi0+bG9jaywgZmxhZ3MpOwogCi0gICAgaWYgKCBsaXN0X2VtcHR5KCZzdmMtPmFjdGl2ZV92
Y3B1X2VsZW0pICkKKyAgICBpZiAoIGxpc3RfZW1wdHkoJnN2Yy0+YWN0aXZlX3VuaXRfZWxlbSkg
KQogICAgIHsKLSAgICAgICAgU0NIRURfVkNQVV9TVEFUX0NSQU5LKHN2Yywgc3RhdGVfYWN0aXZl
KTsKKyAgICAgICAgU0NIRURfVU5JVF9TVEFUX0NSQU5LKHN2Yywgc3RhdGVfYWN0aXZlKTsKICAg
ICAgICAgU0NIRURfU1RBVF9DUkFOSyhhY2N0X3VuaXRfYWN0aXZlKTsKIAotICAgICAgICBzZG9t
LT5hY3RpdmVfdmNwdV9jb3VudCsrOwotICAgICAgICBsaXN0X2FkZCgmc3ZjLT5hY3RpdmVfdmNw
dV9lbGVtLCAmc2RvbS0+YWN0aXZlX3ZjcHUpOwotICAgICAgICAvKiBNYWtlIHdlaWdodCBwZXIt
dmNwdSAqLworICAgICAgICBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCsrOworICAgICAgICBsaXN0
X2FkZCgmc3ZjLT5hY3RpdmVfdW5pdF9lbGVtLCAmc2RvbS0+YWN0aXZlX3VuaXQpOworICAgICAg
ICAvKiBNYWtlIHdlaWdodCBwZXItdW5pdCAqLwogICAgICAgICBwcnYtPndlaWdodCArPSBzZG9t
LT53ZWlnaHQ7CiAgICAgICAgIGlmICggbGlzdF9lbXB0eSgmc2RvbS0+YWN0aXZlX3Nkb21fZWxl
bSkgKQogICAgICAgICB7CkBAIC04OTQsNTYgKzg5Nyw1NiBAQCBfX2NzY2hlZF92Y3B1X2FjY3Rf
c3RhcnQoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHN0cnVjdCBjc2NoZWRfdW5pdCAqc3Zj
KQogICAgIH0KIAogICAgIFRSQUNFXzNEKFRSQ19DU0NIRURfQUNDT1VOVF9TVEFSVCwgc2RvbS0+
ZG9tLT5kb21haW5faWQsCi0gICAgICAgICAgICAgc3ZjLT52Y3B1LT52Y3B1X2lkLCBzZG9tLT5h
Y3RpdmVfdmNwdV9jb3VudCk7CisgICAgICAgICAgICAgc3ZjLT51bml0LT51bml0X2lkLCBzZG9t
LT5hY3RpdmVfdW5pdF9jb3VudCk7CiAKICAgICBzcGluX3VubG9ja19pcnFyZXN0b3JlKCZwcnYt
PmxvY2ssIGZsYWdzKTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lkCi1fX2NzY2hlZF92Y3B1X2Fj
Y3Rfc3RvcF9sb2NrZWQoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsCitfX2NzY2hlZF91bml0
X2FjY3Rfc3RvcF9sb2NrZWQoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsCiAgICAgc3RydWN0
IGNzY2hlZF91bml0ICpzdmMpCiB7CiAgICAgc3RydWN0IGNzY2hlZF9kb20gKiBjb25zdCBzZG9t
ID0gc3ZjLT5zZG9tOwogCi0gICAgQlVHX09OKCBsaXN0X2VtcHR5KCZzdmMtPmFjdGl2ZV92Y3B1
X2VsZW0pICk7CisgICAgQlVHX09OKCBsaXN0X2VtcHR5KCZzdmMtPmFjdGl2ZV91bml0X2VsZW0p
ICk7CiAKLSAgICBTQ0hFRF9WQ1BVX1NUQVRfQ1JBTksoc3ZjLCBzdGF0ZV9pZGxlKTsKKyAgICBT
Q0hFRF9VTklUX1NUQVRfQ1JBTksoc3ZjLCBzdGF0ZV9pZGxlKTsKICAgICBTQ0hFRF9TVEFUX0NS
QU5LKGFjY3RfdW5pdF9pZGxlKTsKIAogICAgIEJVR19PTiggcHJ2LT53ZWlnaHQgPCBzZG9tLT53
ZWlnaHQgKTsKLSAgICBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudC0tOwotICAgIGxpc3RfZGVsX2lu
aXQoJnN2Yy0+YWN0aXZlX3ZjcHVfZWxlbSk7CisgICAgc2RvbS0+YWN0aXZlX3VuaXRfY291bnQt
LTsKKyAgICBsaXN0X2RlbF9pbml0KCZzdmMtPmFjdGl2ZV91bml0X2VsZW0pOwogICAgIHBydi0+
d2VpZ2h0IC09IHNkb20tPndlaWdodDsKLSAgICBpZiAoIGxpc3RfZW1wdHkoJnNkb20tPmFjdGl2
ZV92Y3B1KSApCisgICAgaWYgKCBsaXN0X2VtcHR5KCZzZG9tLT5hY3RpdmVfdW5pdCkgKQogICAg
IHsKICAgICAgICAgbGlzdF9kZWxfaW5pdCgmc2RvbS0+YWN0aXZlX3Nkb21fZWxlbSk7CiAgICAg
fQogCiAgICAgVFJBQ0VfM0QoVFJDX0NTQ0hFRF9BQ0NPVU5UX1NUT1AsIHNkb20tPmRvbS0+ZG9t
YWluX2lkLAotICAgICAgICAgICAgIHN2Yy0+dmNwdS0+dmNwdV9pZCwgc2RvbS0+YWN0aXZlX3Zj
cHVfY291bnQpOworICAgICAgICAgICAgIHN2Yy0+dW5pdC0+dW5pdF9pZCwgc2RvbS0+YWN0aXZl
X3VuaXRfY291bnQpOwogfQogCiBzdGF0aWMgdm9pZAotY3NjaGVkX3ZjcHVfYWNjdChzdHJ1Y3Qg
Y3NjaGVkX3ByaXZhdGUgKnBydiwgdW5zaWduZWQgaW50IGNwdSkKK2NzY2hlZF91bml0X2FjY3Qo
c3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHVuc2lnbmVkIGludCBjcHUpCiB7CiAgICAgc3Ry
dWN0IHNjaGVkX3VuaXQgKmN1cnJ1bml0ID0gY3VycmVudC0+c2NoZWRfdW5pdDsKICAgICBzdHJ1
Y3QgY3NjaGVkX3VuaXQgKiBjb25zdCBzdmMgPSBDU0NIRURfVU5JVChjdXJydW5pdCk7CiAgICAg
Y29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzID0gcGVyX2NwdShzY2hlZHVsZXIsIGNwdSk7CiAK
LSAgICBBU1NFUlQoIGN1cnJlbnQtPnByb2Nlc3NvciA9PSBjcHUgKTsKKyAgICBBU1NFUlQoIHNj
aGVkX3VuaXRfbWFzdGVyKGN1cnJ1bml0KSA9PSBjcHUgKTsKICAgICBBU1NFUlQoIHN2Yy0+c2Rv
bSAhPSBOVUxMICk7Ci0gICAgQVNTRVJUKCAhaXNfaWRsZV92Y3B1KHN2Yy0+dmNwdSkgKTsKKyAg
ICBBU1NFUlQoICFpc19pZGxlX3VuaXQoc3ZjLT51bml0KSApOwogCiAgICAgLyoKLSAgICAgKiBJ
ZiB0aGlzIFZDUFUncyBwcmlvcml0eSB3YXMgYm9vc3RlZCB3aGVuIGl0IGxhc3QgYXdva2UsIHJl
c2V0IGl0LgotICAgICAqIElmIHRoZSBWQ1BVIGlzIGZvdW5kIGhlcmUsIHRoZW4gaXQncyBjb25z
dW1pbmcgYSBub24tbmVnbGlnZWFibGUKKyAgICAgKiBJZiB0aGlzIFVOSVQncyBwcmlvcml0eSB3
YXMgYm9vc3RlZCB3aGVuIGl0IGxhc3QgYXdva2UsIHJlc2V0IGl0LgorICAgICAqIElmIHRoZSBV
TklUIGlzIGZvdW5kIGhlcmUsIHRoZW4gaXQncyBjb25zdW1pbmcgYSBub24tbmVnbGlnZWFibGUK
ICAgICAgKiBhbW91bnQgb2YgQ1BVIHJlc291cmNlcyBhbmQgc2hvdWxkIG5vIGxvbmdlciBiZSBi
b29zdGVkLgogICAgICAqLwogICAgIGlmICggc3ZjLT5wcmkgPT0gQ1NDSEVEX1BSSV9UU19CT09T
VCApCiAgICAgewogICAgICAgICBzdmMtPnByaSA9IENTQ0hFRF9QUklfVFNfVU5ERVI7CiAgICAg
ICAgIFRSQUNFXzJEKFRSQ19DU0NIRURfQk9PU1RfRU5ELCBzdmMtPnNkb20tPmRvbS0+ZG9tYWlu
X2lkLAotICAgICAgICAgICAgICAgICBzdmMtPnZjcHUtPnZjcHVfaWQpOworICAgICAgICAgICAg
ICAgICBzdmMtPnVuaXQtPnVuaXRfaWQpOwogICAgIH0KIAogICAgIC8qCkBAIC05NTIsMTIgKzk1
NSwxMiBAQCBjc2NoZWRfdmNwdV9hY2N0KHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCB1bnNp
Z25lZCBpbnQgY3B1KQogICAgIGJ1cm5fY3JlZGl0cyhzdmMsIE5PVygpKTsKIAogICAgIC8qCi0g
ICAgICogUHV0IHRoaXMgVkNQVSBhbmQgZG9tYWluIGJhY2sgb24gdGhlIGFjdGl2ZSBsaXN0IGlm
IGl0IHdhcworICAgICAqIFB1dCB0aGlzIFVOSVQgYW5kIGRvbWFpbiBiYWNrIG9uIHRoZSBhY3Rp
dmUgbGlzdCBpZiBpdCB3YXMKICAgICAgKiBpZGxpbmcuCiAgICAgICovCi0gICAgaWYgKCBsaXN0
X2VtcHR5KCZzdmMtPmFjdGl2ZV92Y3B1X2VsZW0pICkKKyAgICBpZiAoIGxpc3RfZW1wdHkoJnN2
Yy0+YWN0aXZlX3VuaXRfZWxlbSkgKQogICAgIHsKLSAgICAgICAgX19jc2NoZWRfdmNwdV9hY2N0
X3N0YXJ0KHBydiwgc3ZjKTsKKyAgICAgICAgX19jc2NoZWRfdW5pdF9hY2N0X3N0YXJ0KHBydiwg
c3ZjKTsKICAgICB9CiAgICAgZWxzZQogICAgIHsKQEAgLTk3MCwxNSArOTczLDE1IEBAIGNzY2hl
ZF92Y3B1X2FjY3Qoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHVuc2lnbmVkIGludCBjcHUp
CiAgICAgICAgICAqIG1pZ3JhdGluZyBpdCB0byBydW4gZWxzZXdoZXJlIChzZWUgbXVsdGktY29y
ZSBhbmQgbXVsdGktdGhyZWFkCiAgICAgICAgICAqIHN1cHBvcnQgaW4gY3NjaGVkX3Jlc19waWNr
KCkpLgogICAgICAgICAgKi8KLSAgICAgICAgbmV3X2NwdSA9IF9jc2NoZWRfY3B1X3BpY2sob3Bz
LCBjdXJyZW50LCAwKTsKKyAgICAgICAgbmV3X2NwdSA9IF9jc2NoZWRfY3B1X3BpY2sob3BzLCBj
dXJydW5pdCwgMCk7CiAKICAgICAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2tfaXJxcmVzdG9yZShs
b2NrLCBmbGFncywgY3VycnVuaXQpOwogCiAgICAgICAgIGlmICggbmV3X2NwdSAhPSBjcHUgKQog
ICAgICAgICB7Ci0gICAgICAgICAgICBTQ0hFRF9WQ1BVX1NUQVRfQ1JBTksoc3ZjLCBtaWdyYXRl
X3IpOworICAgICAgICAgICAgU0NIRURfVU5JVF9TVEFUX0NSQU5LKHN2YywgbWlncmF0ZV9yKTsK
ICAgICAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksobWlncmF0ZV9ydW5uaW5nKTsKLSAgICAgICAg
ICAgIHNldF9iaXQoX1ZQRl9taWdyYXRpbmcsICZjdXJyZW50LT5wYXVzZV9mbGFncyk7CisgICAg
ICAgICAgICBzY2hlZF9zZXRfcGF1c2VfZmxhZ3NfYXRvbWljKGN1cnJ1bml0LCBfVlBGX21pZ3Jh
dGluZyk7CiAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICogQXMgd2UgYXJlIGFib3V0IHRv
IHRpY2tsZSBjcHUsIHdlIHNob3VsZCBjbGVhciBpdHMgYml0IGluCiAgICAgICAgICAgICAgKiBp
ZGxlcnMuIEJ1dCwgaWYgd2UgYXJlIGhlcmUsIGl0IG1lYW5zIHRoZXJlIGlzIHNvbWVvbmUgcnVu
bmluZwpAQCAtOTk1LDIxICs5OTgsMjAgQEAgc3RhdGljIHZvaWQgKgogY3NjaGVkX2FsbG9jX3Vk
YXRhKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQs
CiAgICAgICAgICAgICAgICAgICAgdm9pZCAqZGQpCiB7Ci0gICAgc3RydWN0IHZjcHUgKnZjID0g
dW5pdC0+dmNwdV9saXN0OwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjOwogCi0gICAgLyog
QWxsb2NhdGUgcGVyLVZDUFUgaW5mbyAqLworICAgIC8qIEFsbG9jYXRlIHBlci1VTklUIGluZm8g
Ki8KICAgICBzdmMgPSB4emFsbG9jKHN0cnVjdCBjc2NoZWRfdW5pdCk7CiAgICAgaWYgKCBzdmMg
PT0gTlVMTCApCiAgICAgICAgIHJldHVybiBOVUxMOwogCiAgICAgSU5JVF9MSVNUX0hFQUQoJnN2
Yy0+cnVucV9lbGVtKTsKLSAgICBJTklUX0xJU1RfSEVBRCgmc3ZjLT5hY3RpdmVfdmNwdV9lbGVt
KTsKKyAgICBJTklUX0xJU1RfSEVBRCgmc3ZjLT5hY3RpdmVfdW5pdF9lbGVtKTsKICAgICBzdmMt
PnNkb20gPSBkZDsKLSAgICBzdmMtPnZjcHUgPSB2YzsKLSAgICBzdmMtPnByaSA9IGlzX2lkbGVf
ZG9tYWluKHZjLT5kb21haW4pID8KKyAgICBzdmMtPnVuaXQgPSB1bml0OworICAgIHN2Yy0+cHJp
ID0gaXNfaWRsZV91bml0KHVuaXQpID8KICAgICAgICAgQ1NDSEVEX1BSSV9JRExFIDogQ1NDSEVE
X1BSSV9UU19VTkRFUjsKLSAgICBTQ0hFRF9WQ1BVX1NUQVRTX1JFU0VUKHN2Yyk7CisgICAgU0NI
RURfVU5JVF9TVEFUU19SRVNFVChzdmMpOwogICAgIFNDSEVEX1NUQVRfQ1JBTksodW5pdF9hbGxv
Yyk7CiAgICAgcmV0dXJuIHN2YzsKIH0KQEAgLTEwMTcsMjQgKzEwMTksMjEgQEAgY3NjaGVkX2Fs
bG9jX3VkYXRhKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQg
KnVuaXQsCiBzdGF0aWMgdm9pZAogY3NjaGVkX3VuaXRfaW5zZXJ0KGNvbnN0IHN0cnVjdCBzY2hl
ZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAgc3RydWN0IHZjcHUg
KnZjID0gdW5pdC0+dmNwdV9saXN0OwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjID0gdW5p
dC0+cHJpdjsKICAgICBzcGlubG9ja190ICpsb2NrOwogCi0gICAgQlVHX09OKCBpc19pZGxlX3Zj
cHUodmMpICk7CisgICAgQlVHX09OKCBpc19pZGxlX3VuaXQodW5pdCkgKTsKIAogICAgIC8qIGNz
Y2hlZF9yZXNfcGljaygpIGxvb2tzIGluIHZjLT5wcm9jZXNzb3IncyBydW5xLCBzbyB3ZSBuZWVk
IHRoZSBsb2NrLiAqLwogICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHVuaXQpOwog
Ci0gICAgdW5pdC0+cmVzID0gY3NjaGVkX3Jlc19waWNrKG9wcywgdW5pdCk7Ci0gICAgdmMtPnBy
b2Nlc3NvciA9IHVuaXQtPnJlcy0+bWFzdGVyX2NwdTsKKyAgICBzY2hlZF9zZXRfcmVzKHVuaXQs
IGNzY2hlZF9yZXNfcGljayhvcHMsIHVuaXQpKTsKIAogICAgIHNwaW5fdW5sb2NrX2lycShsb2Nr
KTsKIAogICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHVuaXQpOwogCi0gICAgaWYg
KCAhX192Y3B1X29uX3J1bnEoc3ZjKSAmJiB2Y3B1X3J1bm5hYmxlKHZjKSAmJgotICAgICAgICAg
IXZjLT5zY2hlZF91bml0LT5pc19ydW5uaW5nICkKKyAgICBpZiAoICFfX3VuaXRfb25fcnVucShz
dmMpICYmIHVuaXRfcnVubmFibGUodW5pdCkgJiYgIXVuaXQtPmlzX3J1bm5pbmcgKQogICAgICAg
ICBydW5xX2luc2VydChzdmMpOwogCiAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ss
IHVuaXQpOwpAQCAtMTA2MSwxOCArMTA2MCwxOCBAQCBjc2NoZWRfdW5pdF9yZW1vdmUoY29uc3Qg
c3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIAogICAgIFND
SEVEX1NUQVRfQ1JBTksodW5pdF9yZW1vdmUpOwogCi0gICAgQVNTRVJUKCFfX3ZjcHVfb25fcnVu
cShzdmMpKTsKKyAgICBBU1NFUlQoIV9fdW5pdF9vbl9ydW5xKHN2YykpOwogCi0gICAgaWYgKCB0
ZXN0X2FuZF9jbGVhcl9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9QQVJLRUQsICZzdmMtPmZsYWdzKSAp
CisgICAgaWYgKCB0ZXN0X2FuZF9jbGVhcl9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9QQVJLRUQsICZz
dmMtPmZsYWdzKSApCiAgICAgewogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfdW5wYXJr
KTsKLSAgICAgICAgdmNwdV91bnBhdXNlKHN2Yy0+dmNwdSk7CisgICAgICAgIHZjcHVfdW5wYXVz
ZShzdmMtPnVuaXQtPnZjcHVfbGlzdCk7CiAgICAgfQogCiAgICAgc3Bpbl9sb2NrX2lycSgmcHJ2
LT5sb2NrKTsKIAotICAgIGlmICggIWxpc3RfZW1wdHkoJnN2Yy0+YWN0aXZlX3ZjcHVfZWxlbSkg
KQotICAgICAgICBfX2NzY2hlZF92Y3B1X2FjY3Rfc3RvcF9sb2NrZWQocHJ2LCBzdmMpOworICAg
IGlmICggIWxpc3RfZW1wdHkoJnN2Yy0+YWN0aXZlX3VuaXRfZWxlbSkgKQorICAgICAgICBfX2Nz
Y2hlZF91bml0X2FjY3Rfc3RvcF9sb2NrZWQocHJ2LCBzdmMpOwogCiAgICAgc3Bpbl91bmxvY2tf
aXJxKCZwcnYtPmxvY2spOwogCkBAIC0xMDgyLDg2ICsxMDgxLDg1IEBAIGNzY2hlZF91bml0X3Jl
bW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hlZF91bml0ICp1bml0
KQogc3RhdGljIHZvaWQKIGNzY2hlZF91bml0X3NsZWVwKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIg
Km9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAgc3RydWN0IHZjcHUgKnZjID0g
dW5pdC0+dmNwdV9saXN0OwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqIGNvbnN0IHN2YyA9IENT
Q0hFRF9VTklUKHVuaXQpOwotICAgIHVuc2lnbmVkIGludCBjcHUgPSB2Yy0+cHJvY2Vzc29yOwor
ICAgIHVuc2lnbmVkIGludCBjcHUgPSBzY2hlZF91bml0X21hc3Rlcih1bml0KTsKIAogICAgIFND
SEVEX1NUQVRfQ1JBTksodW5pdF9zbGVlcCk7CiAKLSAgICBCVUdfT04oIGlzX2lkbGVfdmNwdSh2
YykgKTsKKyAgICBCVUdfT04oIGlzX2lkbGVfdW5pdCh1bml0KSApOwogCiAgICAgaWYgKCBjdXJy
X29uX2NwdShjcHUpID09IHVuaXQgKQogICAgIHsKICAgICAgICAgLyoKICAgICAgICAgICogV2Ug
YXJlIGFib3V0IHRvIHRpY2tsZSBjcHUsIHNvIHdlIHNob3VsZCBjbGVhciBpdHMgYml0IGluIGlk
bGVycy4KLSAgICAgICAgICogQnV0LCB3ZSBhcmUgaGVyZSBiZWNhdXNlIHZjIGlzIGdvaW5nIHRv
IHNsZWVwIHdoaWxlIHJ1bm5pbmcgb24gY3B1LAorICAgICAgICAgKiBCdXQsIHdlIGFyZSBoZXJl
IGJlY2F1c2UgdW5pdCBpcyBnb2luZyB0byBzbGVlcCB3aGlsZSBydW5uaW5nIG9uIGNwdSwKICAg
ICAgICAgICogc28gdGhlIGJpdCBtdXN0IGJlIHplcm8gYWxyZWFkeS4KICAgICAgICAgICovCiAg
ICAgICAgIEFTU0VSVCghY3B1bWFza190ZXN0X2NwdShjcHUsIENTQ0hFRF9QUklWKHBlcl9jcHUo
c2NoZWR1bGVyLCBjcHUpKS0+aWRsZXJzKSk7CiAgICAgICAgIGNwdV9yYWlzZV9zb2Z0aXJxKGNw
dSwgU0NIRURVTEVfU09GVElSUSk7CiAgICAgfQotICAgIGVsc2UgaWYgKCBfX3ZjcHVfb25fcnVu
cShzdmMpICkKKyAgICBlbHNlIGlmICggX191bml0X29uX3J1bnEoc3ZjKSApCiAgICAgICAgIHJ1
bnFfcmVtb3ZlKHN2Yyk7CiB9CiAKIHN0YXRpYyB2b2lkCiBjc2NoZWRfdW5pdF93YWtlKGNvbnN0
IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAg
c3RydWN0IHZjcHUgKnZjID0gdW5pdC0+dmNwdV9saXN0OwogICAgIHN0cnVjdCBjc2NoZWRfdW5p
dCAqIGNvbnN0IHN2YyA9IENTQ0hFRF9VTklUKHVuaXQpOwogICAgIGJvb2xfdCBtaWdyYXRpbmc7
CiAKLSAgICBCVUdfT04oIGlzX2lkbGVfdmNwdSh2YykgKTsKKyAgICBCVUdfT04oIGlzX2lkbGVf
dW5pdCh1bml0KSApOwogCi0gICAgaWYgKCB1bmxpa2VseShjdXJyX29uX2NwdSh2Yy0+cHJvY2Vz
c29yKSA9PSB1bml0KSApCisgICAgaWYgKCB1bmxpa2VseShjdXJyX29uX2NwdShzY2hlZF91bml0
X21hc3Rlcih1bml0KSkgPT0gdW5pdCkgKQogICAgIHsKICAgICAgICAgU0NIRURfU1RBVF9DUkFO
Syh1bml0X3dha2VfcnVubmluZyk7CiAgICAgICAgIHJldHVybjsKICAgICB9Ci0gICAgaWYgKCB1
bmxpa2VseShfX3ZjcHVfb25fcnVucShzdmMpKSApCisgICAgaWYgKCB1bmxpa2VseShfX3VuaXRf
b25fcnVucShzdmMpKSApCiAgICAgewogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfd2Fr
ZV9vbnJ1bnEpOwogICAgICAgICByZXR1cm47CiAgICAgfQogCi0gICAgaWYgKCBsaWtlbHkodmNw
dV9ydW5uYWJsZSh2YykpICkKKyAgICBpZiAoIGxpa2VseSh1bml0X3J1bm5hYmxlKHVuaXQpKSAp
CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodW5pdF93YWtlX3J1bm5hYmxlKTsKICAgICBlbHNl
CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodW5pdF93YWtlX25vdF9ydW5uYWJsZSk7CiAKICAg
ICAvKgotICAgICAqIFdlIHRlbXBvcmFybHkgYm9vc3QgdGhlIHByaW9yaXR5IG9mIGF3YWtpbmcg
VkNQVXMhCisgICAgICogV2UgdGVtcG9yYXJpbHkgYm9vc3QgdGhlIHByaW9yaXR5IG9mIGF3YWtp
bmcgVU5JVHMhCiAgICAgICoKLSAgICAgKiBJZiB0aGlzIFZDUFUgY29uc3VtZXMgYSBub24gbmVn
bGlnZWFibGUgYW1vdW50IG9mIENQVSwgaXQKKyAgICAgKiBJZiB0aGlzIFVOSVQgY29uc3VtZXMg
YSBub24gbmVnbGlnaWJsZSBhbW91bnQgb2YgQ1BVLCBpdAogICAgICAqIHdpbGwgZXZlbnR1YWxs
eSBmaW5kIGl0c2VsZiBpbiB0aGUgY3JlZGl0IGFjY291bnRpbmcgY29kZQogICAgICAqIHBhdGgg
d2hlcmUgaXRzIHByaW9yaXR5IHdpbGwgYmUgcmVzZXQgdG8gbm9ybWFsLgogICAgICAqCi0gICAg
ICogSWYgb24gdGhlIG90aGVyIGhhbmQgdGhlIFZDUFUgY29uc3VtZXMgbGl0dGxlIENQVSBhbmQg
aXMKKyAgICAgKiBJZiBvbiB0aGUgb3RoZXIgaGFuZCB0aGUgVU5JVCBjb25zdW1lcyBsaXR0bGUg
Q1BVIGFuZCBpcwogICAgICAqIGJsb2NraW5nIGFuZCBhd29rZW4gYSBsb3QgKGRvaW5nIEkvTyBm
b3IgZXhhbXBsZSksIGl0cwogICAgICAqIHByaW9yaXR5IHdpbGwgcmVtYWluIGJvb3N0ZWQsIG9w
dGltaXppbmcgaXQncyB3YWtlLXRvLXJ1bgogICAgICAqIGxhdGVuY2llcy4KICAgICAgKgotICAg
ICAqIFRoaXMgYWxsb3dzIHdha2UtdG8tcnVuIGxhdGVuY3kgc2Vuc2l0aXZlIFZDUFVzIHRvIHBy
ZWVtcHQKLSAgICAgKiBtb3JlIENQVSByZXNvdXJjZSBpbnRlbnNpdmUgVkNQVXMgd2l0aG91dCBp
bXBhY3Rpbmcgb3ZlcmFsbCAKKyAgICAgKiBUaGlzIGFsbG93cyB3YWtlLXRvLXJ1biBsYXRlbmN5
IHNlbnNpdGl2ZSBVTklUcyB0byBwcmVlbXB0CisgICAgICogbW9yZSBDUFUgcmVzb3VyY2UgaW50
ZW5zaXZlIFVOSVRzIHdpdGhvdXQgaW1wYWN0aW5nIG92ZXJhbGwKICAgICAgKiBzeXN0ZW0gZmFp
cm5lc3MuCiAgICAgICoKICAgICAgKiBUaGVyZSBhcmUgdHdvIGNhc2VzLCB3aGVuIHdlIGRvbid0
IHdhbnQgdG8gYm9vc3Q6Ci0gICAgICogIC0gVkNQVXMgdGhhdCBhcmUgd2FraW5nIHVwIGFmdGVy
IGEgbWlncmF0aW9uLCByYXRoZXIgdGhhbgorICAgICAqICAtIFVOSVRzIHRoYXQgYXJlIHdha2lu
ZyB1cCBhZnRlciBhIG1pZ3JhdGlvbiwgcmF0aGVyIHRoYW4KICAgICAgKiAgICBhZnRlciBoYXZp
bmcgYmxvY2s7Ci0gICAgICogIC0gVkNQVXMgb2YgY2FwcGVkIGRvbWFpbnMgdW5wYXVzaW5nIGFm
dGVyIGVhcm5pbmcgY3JlZGl0cworICAgICAqICAtIFVOSVRzIG9mIGNhcHBlZCBkb21haW5zIHVu
cGF1c2luZyBhZnRlciBlYXJuaW5nIGNyZWRpdHMKICAgICAgKiAgICB0aGV5IGhhZCBvdmVyc3Bl
bnQuCiAgICAgICovCi0gICAgbWlncmF0aW5nID0gdGVzdF9hbmRfY2xlYXJfYml0KENTQ0hFRF9G
TEFHX1ZDUFVfTUlHUkFUSU5HLCAmc3ZjLT5mbGFncyk7CisgICAgbWlncmF0aW5nID0gdGVzdF9h
bmRfY2xlYXJfYml0KENTQ0hFRF9GTEFHX1VOSVRfTUlHUkFUSU5HLCAmc3ZjLT5mbGFncyk7CiAK
ICAgICBpZiAoICFtaWdyYXRpbmcgJiYgc3ZjLT5wcmkgPT0gQ1NDSEVEX1BSSV9UU19VTkRFUiAm
JgotICAgICAgICAgIXRlc3RfYml0KENTQ0hFRF9GTEFHX1ZDUFVfUEFSS0VELCAmc3ZjLT5mbGFn
cykgKQorICAgICAgICAgIXRlc3RfYml0KENTQ0hFRF9GTEFHX1VOSVRfUEFSS0VELCAmc3ZjLT5m
bGFncykgKQogICAgIHsKLSAgICAgICAgVFJBQ0VfMkQoVFJDX0NTQ0hFRF9CT09TVF9TVEFSVCwg
dmMtPmRvbWFpbi0+ZG9tYWluX2lkLCB2Yy0+dmNwdV9pZCk7CisgICAgICAgIFRSQUNFXzJEKFRS
Q19DU0NIRURfQk9PU1RfU1RBUlQsIHVuaXQtPmRvbWFpbi0+ZG9tYWluX2lkLAorICAgICAgICAg
ICAgICAgICB1bml0LT51bml0X2lkKTsKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0X2Jv
b3N0KTsKICAgICAgICAgc3ZjLT5wcmkgPSBDU0NIRURfUFJJX1RTX0JPT1NUOwogICAgIH0KIAot
ICAgIC8qIFB1dCB0aGUgVkNQVSBvbiB0aGUgcnVucSBhbmQgdGlja2xlIENQVXMgKi8KKyAgICAv
KiBQdXQgdGhlIFVOSVQgb24gdGhlIHJ1bnEgYW5kIHRpY2tsZSBDUFVzICovCiAgICAgcnVucV9p
bnNlcnQoc3ZjKTsKICAgICBfX3J1bnFfdGlja2xlKHN2Yyk7CiB9CkBAIC0xMTcyLDcgKzExNzAs
NyBAQCBjc2NoZWRfdW5pdF95aWVsZChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVj
dCBzY2hlZF91bml0ICp1bml0KQogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqIGNvbnN0IHN2YyA9
IENTQ0hFRF9VTklUKHVuaXQpOwogCiAgICAgLyogTGV0IHRoZSBzY2hlZHVsZXIga25vdyB0aGF0
IHRoaXMgdmNwdSBpcyB0cnlpbmcgdG8geWllbGQgKi8KLSAgICBzZXRfYml0KENTQ0hFRF9GTEFH
X1ZDUFVfWUlFTEQsICZzdmMtPmZsYWdzKTsKKyAgICBzZXRfYml0KENTQ0hFRF9GTEFHX1VOSVRf
WUlFTEQsICZzdmMtPmZsYWdzKTsKIH0KIAogc3RhdGljIGludApAQCAtMTIwMSw4ICsxMTk5LDgg
QEAgY3NjaGVkX2RvbV9jbnRsKAogICAgICAgICB7CiAgICAgICAgICAgICBpZiAoICFsaXN0X2Vt
cHR5KCZzZG9tLT5hY3RpdmVfc2RvbV9lbGVtKSApCiAgICAgICAgICAgICB7Ci0gICAgICAgICAg
ICAgICAgcHJ2LT53ZWlnaHQgLT0gc2RvbS0+d2VpZ2h0ICogc2RvbS0+YWN0aXZlX3ZjcHVfY291
bnQ7Ci0gICAgICAgICAgICAgICAgcHJ2LT53ZWlnaHQgKz0gb3AtPnUuY3JlZGl0LndlaWdodCAq
IHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50OworICAgICAgICAgICAgICAgIHBydi0+d2VpZ2h0IC09
IHNkb20tPndlaWdodCAqIHNkb20tPmFjdGl2ZV91bml0X2NvdW50OworICAgICAgICAgICAgICAg
IHBydi0+d2VpZ2h0ICs9IG9wLT51LmNyZWRpdC53ZWlnaHQgKiBzZG9tLT5hY3RpdmVfdW5pdF9j
b3VudDsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIHNkb20tPndlaWdodCA9IG9wLT51LmNy
ZWRpdC53ZWlnaHQ7CiAgICAgICAgIH0KQEAgLTEyMzEsOSArMTIyOSw5IEBAIGNzY2hlZF9hZmZf
Y250bChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hlZF91bml0ICp1bml0
LAogCiAgICAgLyogQXJlIHdlIGJlY29taW5nIGV4Y2x1c2l2ZWx5IHBpbm5lZD8gKi8KICAgICBp
ZiAoIGNwdW1hc2tfd2VpZ2h0KGhhcmQpID09IDEgKQotICAgICAgICBzZXRfYml0KENTQ0hFRF9G
TEFHX1ZDUFVfUElOTkVELCAmc3ZjLT5mbGFncyk7CisgICAgICAgIHNldF9iaXQoQ1NDSEVEX0ZM
QUdfVU5JVF9QSU5ORUQsICZzdmMtPmZsYWdzKTsKICAgICBlbHNlCi0gICAgICAgIGNsZWFyX2Jp
dChDU0NIRURfRkxBR19WQ1BVX1BJTk5FRCwgJnN2Yy0+ZmxhZ3MpOworICAgICAgICBjbGVhcl9i
aXQoQ1NDSEVEX0ZMQUdfVU5JVF9QSU5ORUQsICZzdmMtPmZsYWdzKTsKIH0KIAogc3RhdGljIGlu
bGluZSB2b2lkCkBAIC0xMjc2LDE0ICsxMjc0LDE0IEBAIGNzY2hlZF9zeXNfY250bChjb25zdCBz
dHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiAgICAgICAgIGVsc2UgaWYgKCBwcnYtPnJhdGVsaW1pdCAm
JiAhcGFyYW1zLT5yYXRlbGltaXRfdXMgKQogICAgICAgICAgICAgcHJpbnRrKFhFTkxPR19JTkZP
ICJEaXNhYmxpbmcgY29udGV4dCBzd2l0Y2ggcmF0ZSBsaW1pdGluZ1xuIik7CiAgICAgICAgIHBy
di0+cmF0ZWxpbWl0ID0gTUlDUk9TRUNTKHBhcmFtcy0+cmF0ZWxpbWl0X3VzKTsKLSAgICAgICAg
cHJ2LT52Y3B1X21pZ3JfZGVsYXkgPSBNSUNST1NFQ1MocGFyYW1zLT52Y3B1X21pZ3JfZGVsYXlf
dXMpOworICAgICAgICBwcnYtPnVuaXRfbWlncl9kZWxheSA9IE1JQ1JPU0VDUyhwYXJhbXMtPnZj
cHVfbWlncl9kZWxheV91cyk7CiAgICAgICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnBydi0+
bG9jaywgZmxhZ3MpOwogCiAgICAgICAgIC8qIEZBTExUSFJVICovCiAgICAgY2FzZSBYRU5fU1lT
Q1RMX1NDSEVET1BfZ2V0aW5mbzoKICAgICAgICAgcGFyYW1zLT50c2xpY2VfbXMgPSBwcnYtPnRz
bGljZSAvIE1JTExJU0VDUygxKTsKICAgICAgICAgcGFyYW1zLT5yYXRlbGltaXRfdXMgPSBwcnYt
PnJhdGVsaW1pdCAvIE1JQ1JPU0VDUygxKTsKLSAgICAgICAgcGFyYW1zLT52Y3B1X21pZ3JfZGVs
YXlfdXMgPSBwcnYtPnZjcHVfbWlncl9kZWxheSAvIE1JQ1JPU0VDUygxKTsKKyAgICAgICAgcGFy
YW1zLT52Y3B1X21pZ3JfZGVsYXlfdXMgPSBwcnYtPnVuaXRfbWlncl9kZWxheSAvIE1JQ1JPU0VD
UygxKTsKICAgICAgICAgcmMgPSAwOwogICAgICAgICBicmVhazsKICAgICB9CkBAIC0xMzAxLDcg
KzEyOTksNyBAQCBjc2NoZWRfYWxsb2NfZG9tZGF0YShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpv
cHMsIHN0cnVjdCBkb21haW4gKmRvbSkKICAgICAgICAgcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7
CiAKICAgICAvKiBJbml0aWFsaXplIGNyZWRpdCBhbmQgd2VpZ2h0ICovCi0gICAgSU5JVF9MSVNU
X0hFQUQoJnNkb20tPmFjdGl2ZV92Y3B1KTsKKyAgICBJTklUX0xJU1RfSEVBRCgmc2RvbS0+YWN0
aXZlX3VuaXQpOwogICAgIElOSVRfTElTVF9IRUFEKCZzZG9tLT5hY3RpdmVfc2RvbV9lbGVtKTsK
ICAgICBzZG9tLT5kb20gPSBkb207CiAgICAgc2RvbS0+d2VpZ2h0ID0gQ1NDSEVEX0RFRkFVTFRf
V0VJR0hUOwpAQCAtMTMxOCw3ICsxMzE2LDcgQEAgY3NjaGVkX2ZyZWVfZG9tZGF0YShjb25zdCBz
dHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHZvaWQgKmRhdGEpCiAvKgogICogVGhpcyBpcyBhIE8obikg
b3B0aW1pemVkIHNvcnQgb2YgdGhlIHJ1bnEuCiAgKgotICogVGltZS1zaGFyZSBWQ1BVcyBjYW4g
b25seSBiZSBvbmUgb2YgdHdvIHByaW9yaXRpZXMsIFVOREVSIG9yIE9WRVIuIFdlIHdhbGsKKyAq
IFRpbWUtc2hhcmUgVU5JVHMgY2FuIG9ubHkgYmUgb25lIG9mIHR3byBwcmlvcml0aWVzLCBVTkRF
UiBvciBPVkVSLiBXZSB3YWxrCiAgKiB0aHJvdWdoIHRoZSBydW5xIGFuZCBtb3ZlIHVwIGFueSBV
TkRFUnMgdGhhdCBhcmUgcHJlY2VkZWQgYnkgT1ZFUlMuIFdlCiAgKiByZW1lbWJlciB0aGUgbGFz
dCBVTkRFUiB0byBtYWtlIHRoZSBtb3ZlIHVwIG9wZXJhdGlvbiBPKDEpLgogICovCkBAIC0xMzcx
LDcgKzEzNjksNyBAQCBjc2NoZWRfYWNjdCh2b2lkKiBkdW1teSkKIHsKICAgICBzdHJ1Y3QgY3Nj
aGVkX3ByaXZhdGUgKnBydiA9IGR1bW15OwogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7Ci0gICAg
c3RydWN0IGxpc3RfaGVhZCAqaXRlcl92Y3B1LCAqbmV4dF92Y3B1OworICAgIHN0cnVjdCBsaXN0
X2hlYWQgKml0ZXJfdW5pdCwgKm5leHRfdW5pdDsKICAgICBzdHJ1Y3QgbGlzdF9oZWFkICppdGVy
X3Nkb20sICpuZXh0X3Nkb207CiAgICAgc3RydWN0IGNzY2hlZF91bml0ICpzdmM7CiAgICAgc3Ry
dWN0IGNzY2hlZF9kb20gKnNkb207CkBAIC0xNDE4LDI2ICsxNDE2LDI2IEBAIGNzY2hlZF9hY2N0
KHZvaWQqIGR1bW15KQogICAgICAgICBzZG9tID0gbGlzdF9lbnRyeShpdGVyX3Nkb20sIHN0cnVj
dCBjc2NoZWRfZG9tLCBhY3RpdmVfc2RvbV9lbGVtKTsKIAogICAgICAgICBCVUdfT04oIGlzX2lk
bGVfZG9tYWluKHNkb20tPmRvbSkgKTsKLSAgICAgICAgQlVHX09OKCBzZG9tLT5hY3RpdmVfdmNw
dV9jb3VudCA9PSAwICk7CisgICAgICAgIEJVR19PTiggc2RvbS0+YWN0aXZlX3VuaXRfY291bnQg
PT0gMCApOwogICAgICAgICBCVUdfT04oIHNkb20tPndlaWdodCA9PSAwICk7Ci0gICAgICAgIEJV
R19PTiggKHNkb20tPndlaWdodCAqIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50KSA+IHdlaWdodF9s
ZWZ0ICk7CisgICAgICAgIEJVR19PTiggKHNkb20tPndlaWdodCAqIHNkb20tPmFjdGl2ZV91bml0
X2NvdW50KSA+IHdlaWdodF9sZWZ0ICk7CiAKLSAgICAgICAgd2VpZ2h0X2xlZnQgLT0gKCBzZG9t
LT53ZWlnaHQgKiBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudCApOworICAgICAgICB3ZWlnaHRfbGVm
dCAtPSAoIHNkb20tPndlaWdodCAqIHNkb20tPmFjdGl2ZV91bml0X2NvdW50ICk7CiAKICAgICAg
ICAgLyoKICAgICAgICAgICogQSBkb21haW4ncyBmYWlyIHNoYXJlIGlzIGNvbXB1dGVkIHVzaW5n
IGl0cyB3ZWlnaHQgaW4gY29tcGV0aXRpb24KICAgICAgICAgICogd2l0aCB0aGF0IG9mIGFsbCBv
dGhlciBhY3RpdmUgZG9tYWlucy4KICAgICAgICAgICoKLSAgICAgICAgICogQXQgbW9zdCwgYSBk
b21haW4gY2FuIHVzZSBjcmVkaXRzIHRvIHJ1biBhbGwgaXRzIGFjdGl2ZSBWQ1BVcworICAgICAg
ICAgKiBBdCBtb3N0LCBhIGRvbWFpbiBjYW4gdXNlIGNyZWRpdHMgdG8gcnVuIGFsbCBpdHMgYWN0
aXZlIFVOSVRzCiAgICAgICAgICAqIGZvciBvbmUgZnVsbCBhY2NvdW50aW5nIHBlcmlvZC4gV2Ug
YWxsb3cgYSBkb21haW4gdG8gZWFybiBtb3JlCiAgICAgICAgICAqIG9ubHkgd2hlbiB0aGUgc3lz
dGVtLXdpZGUgY3JlZGl0IGJhbGFuY2UgaXMgbmVnYXRpdmUuCiAgICAgICAgICAqLwotICAgICAg
ICBjcmVkaXRfcGVhayA9IHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50ICogcHJ2LT5jcmVkaXRzX3Bl
cl90c2xpY2U7CisgICAgICAgIGNyZWRpdF9wZWFrID0gc2RvbS0+YWN0aXZlX3VuaXRfY291bnQg
KiBwcnYtPmNyZWRpdHNfcGVyX3RzbGljZTsKICAgICAgICAgaWYgKCBwcnYtPmNyZWRpdF9iYWxh
bmNlIDwgMCApCiAgICAgICAgIHsKICAgICAgICAgICAgIGNyZWRpdF9wZWFrICs9ICggKCAtcHJ2
LT5jcmVkaXRfYmFsYW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogc2RvbS0+
d2VpZ2h0Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiBzZG9tLT5hY3RpdmVfdmNw
dV9jb3VudCkgKworICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogc2RvbS0+YWN0aXZl
X3VuaXRfY291bnQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHdlaWdodF90b3Rh
bCAtIDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApIC8gd2VpZ2h0X3RvdGFsOwogICAg
ICAgICB9CkBAIC0xNDQ4LDE0ICsxNDQ2LDE0IEBAIGNzY2hlZF9hY2N0KHZvaWQqIGR1bW15KQog
ICAgICAgICAgICAgaWYgKCBjcmVkaXRfY2FwIDwgY3JlZGl0X3BlYWsgKQogICAgICAgICAgICAg
ICAgIGNyZWRpdF9wZWFrID0gY3JlZGl0X2NhcDsKIAotICAgICAgICAgICAgLyogRklYTUUgLS0g
c2V0IGNhcCBwZXItdmNwdSBhcyB3ZWxsLi4uPyAqLwotICAgICAgICAgICAgY3JlZGl0X2NhcCA9
ICggY3JlZGl0X2NhcCArICggc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQgLSAxICkKLSAgICAgICAg
ICAgICAgICAgICAgICAgICApIC8gc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQ7CisgICAgICAgICAg
ICAvKiBGSVhNRSAtLSBzZXQgY2FwIHBlci11bml0IGFzIHdlbGwuLi4/ICovCisgICAgICAgICAg
ICBjcmVkaXRfY2FwID0gKCBjcmVkaXRfY2FwICsgKCBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCAt
IDEgKQorICAgICAgICAgICAgICAgICAgICAgICAgICkgLyBzZG9tLT5hY3RpdmVfdW5pdF9jb3Vu
dDsKICAgICAgICAgfQogCiAgICAgICAgIGNyZWRpdF9mYWlyID0gKCAoIGNyZWRpdF90b3RhbAog
ICAgICAgICAgICAgICAgICAgICAgICAgICAqIHNkb20tPndlaWdodAotICAgICAgICAgICAgICAg
ICAgICAgICAgICAqIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50ICkKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgKiBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCApCiAgICAgICAgICAgICAgICAgICAg
ICAgICArICh3ZWlnaHRfdG90YWwgLSAxKQogICAgICAgICAgICAgICAgICAgICAgICkgLyB3ZWln
aHRfdG90YWw7CiAKQEAgLTE0ODksMTQgKzE0ODcsMTQgQEAgY3NjaGVkX2FjY3Qodm9pZCogZHVt
bXkpCiAgICAgICAgICAgICBjcmVkaXRfZmFpciA9IGNyZWRpdF9wZWFrOwogICAgICAgICB9CiAK
LSAgICAgICAgLyogQ29tcHV0ZSBmYWlyIHNoYXJlIHBlciBWQ1BVICovCi0gICAgICAgIGNyZWRp
dF9mYWlyID0gKCBjcmVkaXRfZmFpciArICggc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQgLSAxICkK
LSAgICAgICAgICAgICAgICAgICAgICApIC8gc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQ7CisgICAg
ICAgIC8qIENvbXB1dGUgZmFpciBzaGFyZSBwZXIgVU5JVCAqLworICAgICAgICBjcmVkaXRfZmFp
ciA9ICggY3JlZGl0X2ZhaXIgKyAoIHNkb20tPmFjdGl2ZV91bml0X2NvdW50IC0gMSApCisgICAg
ICAgICAgICAgICAgICAgICAgKSAvIHNkb20tPmFjdGl2ZV91bml0X2NvdW50OwogCiAKLSAgICAg
ICAgbGlzdF9mb3JfZWFjaF9zYWZlKCBpdGVyX3ZjcHUsIG5leHRfdmNwdSwgJnNkb20tPmFjdGl2
ZV92Y3B1ICkKKyAgICAgICAgbGlzdF9mb3JfZWFjaF9zYWZlKCBpdGVyX3VuaXQsIG5leHRfdW5p
dCwgJnNkb20tPmFjdGl2ZV91bml0ICkKICAgICAgICAgewotICAgICAgICAgICAgc3ZjID0gbGlz
dF9lbnRyeShpdGVyX3ZjcHUsIHN0cnVjdCBjc2NoZWRfdW5pdCwgYWN0aXZlX3ZjcHVfZWxlbSk7
CisgICAgICAgICAgICBzdmMgPSBsaXN0X2VudHJ5KGl0ZXJfdW5pdCwgc3RydWN0IGNzY2hlZF91
bml0LCBhY3RpdmVfdW5pdF9lbGVtKTsKICAgICAgICAgICAgIEJVR19PTiggc2RvbSAhPSBzdmMt
PnNkb20gKTsKIAogICAgICAgICAgICAgLyogSW5jcmVtZW50IGNyZWRpdCAqLwpAQCAtMTUwNCwy
MCArMTUwMiwyMCBAQCBjc2NoZWRfYWNjdCh2b2lkKiBkdW1teSkKICAgICAgICAgICAgIGNyZWRp
dCA9IGF0b21pY19yZWFkKCZzdmMtPmNyZWRpdCk7CiAKICAgICAgICAgICAgIC8qCi0gICAgICAg
ICAgICAgKiBSZWNvbXB1dGUgcHJpb3JpdHkgb3IsIGlmIFZDUFUgaXMgaWRsaW5nLCByZW1vdmUg
aXQgZnJvbQorICAgICAgICAgICAgICogUmVjb21wdXRlIHByaW9yaXR5IG9yLCBpZiBVTklUIGlz
IGlkbGluZywgcmVtb3ZlIGl0IGZyb20KICAgICAgICAgICAgICAqIHRoZSBhY3RpdmUgbGlzdC4K
ICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgaWYgKCBjcmVkaXQgPCAwICkKICAgICAgICAg
ICAgIHsKICAgICAgICAgICAgICAgICBzdmMtPnByaSA9IENTQ0hFRF9QUklfVFNfT1ZFUjsKIAot
ICAgICAgICAgICAgICAgIC8qIFBhcmsgcnVubmluZyBWQ1BVcyBvZiBjYXBwZWQtb3V0IGRvbWFp
bnMgKi8KKyAgICAgICAgICAgICAgICAvKiBQYXJrIHJ1bm5pbmcgVU5JVHMgb2YgY2FwcGVkLW91
dCBkb21haW5zICovCiAgICAgICAgICAgICAgICAgaWYgKCBzZG9tLT5jYXAgIT0gMFUgJiYKICAg
ICAgICAgICAgICAgICAgICAgIGNyZWRpdCA8IC1jcmVkaXRfY2FwICYmCi0gICAgICAgICAgICAg
ICAgICAgICAhdGVzdF9hbmRfc2V0X2JpdChDU0NIRURfRkxBR19WQ1BVX1BBUktFRCwgJnN2Yy0+
ZmxhZ3MpICkKKyAgICAgICAgICAgICAgICAgICAgICF0ZXN0X2FuZF9zZXRfYml0KENTQ0hFRF9G
TEFHX1VOSVRfUEFSS0VELCAmc3ZjLT5mbGFncykgKQogICAgICAgICAgICAgICAgIHsKICAgICAg
ICAgICAgICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0X3BhcmspOwotICAgICAgICAgICAg
ICAgICAgICB2Y3B1X3BhdXNlX25vc3luYyhzdmMtPnZjcHUpOworICAgICAgICAgICAgICAgICAg
ICB2Y3B1X3BhdXNlX25vc3luYyhzdmMtPnVuaXQtPnZjcHVfbGlzdCk7CiAgICAgICAgICAgICAg
ICAgfQogCiAgICAgICAgICAgICAgICAgLyogTG93ZXIgYm91bmQgb24gY3JlZGl0cyAqLwpAQCAt
MTUzMywyMiArMTUzMSwyMiBAQCBjc2NoZWRfYWNjdCh2b2lkKiBkdW1teSkKICAgICAgICAgICAg
ICAgICBzdmMtPnByaSA9IENTQ0hFRF9QUklfVFNfVU5ERVI7CiAKICAgICAgICAgICAgICAgICAv
KiBVbnBhcmsgYW55IGNhcHBlZCBkb21haW5zIHdob3NlIGNyZWRpdHMgZ28gcG9zaXRpdmUgKi8K
LSAgICAgICAgICAgICAgICBpZiAoIHRlc3RfYml0KENTQ0hFRF9GTEFHX1ZDUFVfUEFSS0VELCAm
c3ZjLT5mbGFncykgKQorICAgICAgICAgICAgICAgIGlmICggdGVzdF9iaXQoQ1NDSEVEX0ZMQUdf
VU5JVF9QQVJLRUQsICZzdmMtPmZsYWdzKSApCiAgICAgICAgICAgICAgICAgewogICAgICAgICAg
ICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgKiBJdCdzIGltcG9ydGFudCB0byB1
bnNldCB0aGUgZmxhZyBBRlRFUiB0aGUgdW5wYXVzZSgpCi0gICAgICAgICAgICAgICAgICAgICAq
IGNhbGwgdG8gbWFrZSBzdXJlIHRoZSBWQ1BVJ3MgcHJpb3JpdHkgaXMgbm90IGJvb3N0ZWQKKyAg
ICAgICAgICAgICAgICAgICAgICogY2FsbCB0byBtYWtlIHN1cmUgdGhlIFVOSVQncyBwcmlvcml0
eSBpcyBub3QgYm9vc3RlZAogICAgICAgICAgICAgICAgICAgICAgKiBpZiBpdCBpcyB3b2tlbiB1
cCBoZXJlLgogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgU0NI
RURfU1RBVF9DUkFOSyh1bml0X3VucGFyayk7Ci0gICAgICAgICAgICAgICAgICAgIHZjcHVfdW5w
YXVzZShzdmMtPnZjcHUpOwotICAgICAgICAgICAgICAgICAgICBjbGVhcl9iaXQoQ1NDSEVEX0ZM
QUdfVkNQVV9QQVJLRUQsICZzdmMtPmZsYWdzKTsKKyAgICAgICAgICAgICAgICAgICAgdmNwdV91
bnBhdXNlKHN2Yy0+dW5pdC0+dmNwdV9saXN0KTsKKyAgICAgICAgICAgICAgICAgICAgY2xlYXJf
Yml0KENTQ0hFRF9GTEFHX1VOSVRfUEFSS0VELCAmc3ZjLT5mbGFncyk7CiAgICAgICAgICAgICAg
ICAgfQogCi0gICAgICAgICAgICAgICAgLyogVXBwZXIgYm91bmQgb24gY3JlZGl0cyBtZWFucyBW
Q1BVIHN0b3BzIGVhcm5pbmcgKi8KKyAgICAgICAgICAgICAgICAvKiBVcHBlciBib3VuZCBvbiBj
cmVkaXRzIG1lYW5zIFVOSVQgc3RvcHMgZWFybmluZyAqLwogICAgICAgICAgICAgICAgIGlmICgg
Y3JlZGl0ID4gcHJ2LT5jcmVkaXRzX3Blcl90c2xpY2UgKQogICAgICAgICAgICAgICAgIHsKLSAg
ICAgICAgICAgICAgICAgICAgX19jc2NoZWRfdmNwdV9hY2N0X3N0b3BfbG9ja2VkKHBydiwgc3Zj
KTsKKyAgICAgICAgICAgICAgICAgICAgX19jc2NoZWRfdW5pdF9hY2N0X3N0b3BfbG9ja2VkKHBy
diwgc3ZjKTsKICAgICAgICAgICAgICAgICAgICAgLyogRGl2aWRlIGNyZWRpdHMgaW4gaGFsZiwg
c28gdGhhdCB3aGVuIGl0IHN0YXJ0cwogICAgICAgICAgICAgICAgICAgICAgKiBhY2NvdW50aW5n
IGFnYWluLCBpdCBzdGFydHMgYSBsaXR0bGUgYml0ICJhaGVhZCIgKi8KICAgICAgICAgICAgICAg
ICAgICAgY3JlZGl0IC89IDI7CkBAIC0xNTU2LDggKzE1NTQsOCBAQCBjc2NoZWRfYWNjdCh2b2lk
KiBkdW1teSkKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICB9CiAKLSAgICAgICAgICAg
IFNDSEVEX1ZDUFVfU1RBVF9TRVQoc3ZjLCBjcmVkaXRfbGFzdCwgY3JlZGl0KTsKLSAgICAgICAg
ICAgIFNDSEVEX1ZDUFVfU1RBVF9TRVQoc3ZjLCBjcmVkaXRfaW5jciwgY3JlZGl0X2ZhaXIpOwor
ICAgICAgICAgICAgU0NIRURfVU5JVF9TVEFUX1NFVChzdmMsIGNyZWRpdF9sYXN0LCBjcmVkaXQp
OworICAgICAgICAgICAgU0NIRURfVU5JVF9TVEFUX1NFVChzdmMsIGNyZWRpdF9pbmNyLCBjcmVk
aXRfZmFpcik7CiAgICAgICAgICAgICBjcmVkaXRfYmFsYW5jZSArPSBjcmVkaXQ7CiAgICAgICAg
IH0KICAgICB9CkBAIC0xNTgzLDEwICsxNTgxLDEwIEBAIGNzY2hlZF90aWNrKHZvaWQgKl9jcHUp
CiAgICAgc3BjLT50aWNrKys7CiAKICAgICAvKgotICAgICAqIEFjY291bnRpbmcgZm9yIHJ1bm5p
bmcgVkNQVQorICAgICAqIEFjY291bnRpbmcgZm9yIHJ1bm5pbmcgVU5JVAogICAgICAqLwotICAg
IGlmICggIWlzX2lkbGVfdmNwdShjdXJyZW50KSApCi0gICAgICAgIGNzY2hlZF92Y3B1X2FjY3Qo
cHJ2LCBjcHUpOworICAgIGlmICggIWlzX2lkbGVfdW5pdChjdXJyZW50LT5zY2hlZF91bml0KSAp
CisgICAgICAgIGNzY2hlZF91bml0X2FjY3QocHJ2LCBjcHUpOwogCiAgICAgLyoKICAgICAgKiBD
aGVjayBpZiBydW5xIG5lZWRzIHRvIGJlIHNvcnRlZApAQCAtMTYwNyw3ICsxNjA1LDcgQEAgY3Nj
aGVkX3J1bnFfc3RlYWwoaW50IHBlZXJfY3B1LCBpbnQgY3B1LCBpbnQgcHJpLCBpbnQgYmFsYW5j
ZV9zdGVwKQogICAgIGNvbnN0IHN0cnVjdCBjc2NoZWRfcGNwdSAqIGNvbnN0IHBlZXJfcGNwdSA9
IENTQ0hFRF9QQ1BVKHBlZXJfY3B1KTsKICAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnNwZWVyOwog
ICAgIHN0cnVjdCBsaXN0X2hlYWQgKml0ZXI7Ci0gICAgc3RydWN0IHZjcHUgKnZjOworICAgIHN0
cnVjdCBzY2hlZF91bml0ICp1bml0OwogCiAgICAgQVNTRVJUKHBlZXJfcGNwdSAhPSBOVUxMKTsK
IApAQCAtMTYxNSw3ICsxNjEzLDcgQEAgY3NjaGVkX3J1bnFfc3RlYWwoaW50IHBlZXJfY3B1LCBp
bnQgY3B1LCBpbnQgcHJpLCBpbnQgYmFsYW5jZV9zdGVwKQogICAgICAqIERvbid0IHN0ZWFsIGZy
b20gYW4gaWRsZSBDUFUncyBydW5xIGJlY2F1c2UgaXQncyBhYm91dCB0bwogICAgICAqIHBpY2sg
dXAgd29yayBmcm9tIGl0IGl0c2VsZi4KICAgICAgKi8KLSAgICBpZiAoIHVubGlrZWx5KGlzX2lk
bGVfdmNwdShjdXJyX29uX2NwdShwZWVyX2NwdSktPnZjcHVfbGlzdCkpICkKKyAgICBpZiAoIHVu
bGlrZWx5KGlzX2lkbGVfdW5pdChjdXJyX29uX2NwdShwZWVyX2NwdSkpKSApCiAgICAgICAgIGdv
dG8gb3V0OwogCiAgICAgbGlzdF9mb3JfZWFjaCggaXRlciwgJnBlZXJfcGNwdS0+cnVucSApCkBA
IC0xNjIzLDQ2ICsxNjIxLDQ0IEBAIGNzY2hlZF9ydW5xX3N0ZWFsKGludCBwZWVyX2NwdSwgaW50
IGNwdSwgaW50IHByaSwgaW50IGJhbGFuY2Vfc3RlcCkKICAgICAgICAgc3BlZXIgPSBfX3J1bnFf
ZWxlbShpdGVyKTsKIAogICAgICAgICAvKgotICAgICAgICAgKiBJZiBuZXh0IGF2YWlsYWJsZSBW
Q1BVIGhlcmUgaXMgbm90IG9mIHN0cmljdGx5IGhpZ2hlcgorICAgICAgICAgKiBJZiBuZXh0IGF2
YWlsYWJsZSBVTklUIGhlcmUgaXMgbm90IG9mIHN0cmljdGx5IGhpZ2hlcgogICAgICAgICAgKiBw
cmlvcml0eSB0aGFuIG91cnMsIHRoaXMgUENQVSBpcyB1c2VsZXNzIHRvIHVzLgogICAgICAgICAg
Ki8KICAgICAgICAgaWYgKCBzcGVlci0+cHJpIDw9IHByaSApCiAgICAgICAgICAgICBicmVhazsK
IAotICAgICAgICAvKiBJcyB0aGlzIFZDUFUgcnVubmFibGUgb24gb3VyIFBDUFU/ICovCi0gICAg
ICAgIHZjID0gc3BlZXItPnZjcHU7Ci0gICAgICAgIEJVR19PTiggaXNfaWRsZV92Y3B1KHZjKSAp
OworICAgICAgICAvKiBJcyB0aGlzIFVOSVQgcnVubmFibGUgb24gb3VyIFBDUFU/ICovCisgICAg
ICAgIHVuaXQgPSBzcGVlci0+dW5pdDsKKyAgICAgICAgQlVHX09OKCBpc19pZGxlX3VuaXQodW5p
dCkgKTsKIAogICAgICAgICAvKgotICAgICAgICAgKiBJZiB0aGUgdmNwdSBpcyBzdGlsbCBpbiBw
ZWVyX2NwdSdzIHNjaGVkdWxpbmcgdGFpbCwgb3IgaWYgaXQKKyAgICAgICAgICogSWYgdGhlIHVu
aXQgaXMgc3RpbGwgaW4gcGVlcl9jcHUncyBzY2hlZHVsaW5nIHRhaWwsIG9yIGlmIGl0CiAgICAg
ICAgICAqIGhhcyBubyB1c2VmdWwgc29mdCBhZmZpbml0eSwgc2tpcCBpdC4KICAgICAgICAgICoK
ICAgICAgICAgICogSW4gZmFjdCwgd2hhdCB3ZSB3YW50IGlzIHRvIGNoZWNrIGlmIHdlIGhhdmUg
YW55ICJzb2Z0LWFmZmluZQogICAgICAgICAgKiB3b3JrIiB0byBzdGVhbCwgYmVmb3JlIHN0YXJ0
aW5nIHRvIGxvb2sgYXQgImhhcmQtYWZmaW5lIHdvcmsiLgogICAgICAgICAgKgotICAgICAgICAg
KiBOb3RpY2UgdGhhdCwgaWYgbm90IGV2ZW4gb25lIHZDUFUgb24gdGhpcyBydW5xIGhhcyBhIHVz
ZWZ1bAorICAgICAgICAgKiBOb3RpY2UgdGhhdCwgaWYgbm90IGV2ZW4gb25lIHVuaXQgb24gdGhp
cyBydW5xIGhhcyBhIHVzZWZ1bAogICAgICAgICAgKiBzb2Z0IGFmZmluaXR5LCB3ZSBjb3VsZCBo
YXZlIGF2b2lkIGNvbnNpZGVyaW5nIHRoaXMgcnVucSBmb3IKICAgICAgICAgICogYSBzb2Z0IGJh
bGFuY2luZyBzdGVwIGluIHRoZSBmaXJzdCBwbGFjZS4gVGhpcywgZm9yIGluc3RhbmNlLAogICAg
ICAgICAgKiBjYW4gYmUgaW1wbGVtZW50ZWQgYnkgdGFraW5nIG5vdGUgb2Ygb24gd2hhdCBydW5x
IHRoZXJlIGFyZQotICAgICAgICAgKiB2Q1BVcyB3aXRoIHVzZWZ1bCBzb2Z0IGFmZmluaXRpZXMg
aW4gc29tZSBzb3J0IG9mIGJpdG1hcAorICAgICAgICAgKiB1bml0cyB3aXRoIHVzZWZ1bCBzb2Z0
IGFmZmluaXRpZXMgaW4gc29tZSBzb3J0IG9mIGJpdG1hcAogICAgICAgICAgKiBvciBjb3VudGVy
LgogICAgICAgICAgKi8KLSAgICAgICAgaWYgKCB2Yy0+c2NoZWRfdW5pdC0+aXNfcnVubmluZyB8
fAotICAgICAgICAgICAgIChiYWxhbmNlX3N0ZXAgPT0gQkFMQU5DRV9TT0ZUX0FGRklOSVRZICYm
Ci0gICAgICAgICAgICAgICFoYXNfc29mdF9hZmZpbml0eSh2Yy0+c2NoZWRfdW5pdCkpICkKKyAg
ICAgICAgaWYgKCB1bml0LT5pc19ydW5uaW5nIHx8IChiYWxhbmNlX3N0ZXAgPT0gQkFMQU5DRV9T
T0ZUX0FGRklOSVRZICYmCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIWhhc19z
b2Z0X2FmZmluaXR5KHVuaXQpKSApCiAgICAgICAgICAgICBjb250aW51ZTsKIAotICAgICAgICBh
ZmZpbml0eV9iYWxhbmNlX2NwdW1hc2sodmMtPnNjaGVkX3VuaXQsIGJhbGFuY2Vfc3RlcCwgY3B1
bWFza19zY3JhdGNoKTsKLSAgICAgICAgaWYgKCBfX2NzY2hlZF92Y3B1X2lzX21pZ3JhdGVhYmxl
KHBydiwgdmMsIGNwdSwgY3B1bWFza19zY3JhdGNoKSApCisgICAgICAgIGFmZmluaXR5X2JhbGFu
Y2VfY3B1bWFzayh1bml0LCBiYWxhbmNlX3N0ZXAsIGNwdW1hc2tfc2NyYXRjaCk7CisgICAgICAg
IGlmICggX19jc2NoZWRfdW5pdF9pc19taWdyYXRlYWJsZShwcnYsIHVuaXQsIGNwdSwgY3B1bWFz
a19zY3JhdGNoKSApCiAgICAgICAgIHsKICAgICAgICAgICAgIC8qIFdlIGdvdCBhIGNhbmRpZGF0
ZS4gR3JhYiBpdCEgKi8KLSAgICAgICAgICAgIFRSQUNFXzNEKFRSQ19DU0NIRURfU1RPTEVOX1ZD
UFUsIHBlZXJfY3B1LAotICAgICAgICAgICAgICAgICAgICAgdmMtPmRvbWFpbi0+ZG9tYWluX2lk
LCB2Yy0+dmNwdV9pZCk7Ci0gICAgICAgICAgICBTQ0hFRF9WQ1BVX1NUQVRfQ1JBTksoc3BlZXIs
IG1pZ3JhdGVfcSk7CisgICAgICAgICAgICBUUkFDRV8zRChUUkNfQ1NDSEVEX1NUT0xFTl9VTklU
LCBwZWVyX2NwdSwKKyAgICAgICAgICAgICAgICAgICAgIHVuaXQtPmRvbWFpbi0+ZG9tYWluX2lk
LCB1bml0LT51bml0X2lkKTsKKyAgICAgICAgICAgIFNDSEVEX1VOSVRfU1RBVF9DUkFOSyhzcGVl
ciwgbWlncmF0ZV9xKTsKICAgICAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksobWlncmF0ZV9xdWV1
ZWQpOwotICAgICAgICAgICAgV0FSTl9PTih2Yy0+aXNfdXJnZW50KTsKICAgICAgICAgICAgIHJ1
bnFfcmVtb3ZlKHNwZWVyKTsKLSAgICAgICAgICAgIHNjaGVkX3NldF9yZXModmMtPnNjaGVkX3Vu
aXQsIGdldF9zY2hlZF9yZXMoY3B1KSk7CisgICAgICAgICAgICBzY2hlZF9zZXRfcmVzKHVuaXQs
IGdldF9zY2hlZF9yZXMoY3B1KSk7CiAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICogc3Bl
ZXIgd2lsbCBzdGFydCBleGVjdXRpbmcgZGlyZWN0bHkgb24gY3B1LCB3aXRob3V0IGhhdmluZyB0
bwogICAgICAgICAgICAgICogZ28gdGhyb3VnaCBydW5xX2luc2VydCgpLiBTbyB3ZSBtdXN0IHVw
ZGF0ZSB0aGUgcnVubmFibGUgY291bnQKQEAgLTE2ODgsNyArMTY4NCw3IEBAIGNzY2hlZF9sb2Fk
X2JhbGFuY2Uoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIGludCBjcHUsCiAgICAgaW50IHBl
ZXJfY3B1LCBmaXJzdF9jcHUsIHBlZXJfbm9kZSwgYnN0ZXA7CiAgICAgaW50IG5vZGUgPSBjcHVf
dG9fbm9kZShjcHUpOwogCi0gICAgQlVHX09OKCBjcHUgIT0gc25leHQtPnZjcHUtPnByb2Nlc3Nv
ciApOworICAgIEJVR19PTiggY3B1ICE9IHNjaGVkX3VuaXRfbWFzdGVyKHNuZXh0LT51bml0KSAp
OwogICAgIG9ubGluZSA9IGNwdXBvb2xfb25saW5lX2NwdW1hc2soYyk7CiAKICAgICAvKgpAQCAt
MTcxNyw3ICsxNzEzLDcgQEAgY3NjaGVkX2xvYWRfYmFsYW5jZShzdHJ1Y3QgY3NjaGVkX3ByaXZh
dGUgKnBydiwgaW50IGNwdSwKICAgICAgICAgLyoKICAgICAgICAgICogV2UgcGVlayBhdCB0aGUg
bm9uLWlkbGluZyBDUFVzIGluIGEgbm9kZS13aXNlIGZhc2hpb24uIEluIGZhY3QsCiAgICAgICAg
ICAqIGl0IGlzIG1vcmUgbGlrZWx5IHRoYXQgd2UgZmluZCBzb21lIGFmZmluZSB3b3JrIG9uIG91
ciBzYW1lCi0gICAgICAgICAqIG5vZGUsIG5vdCB0byBtZW50aW9uIHRoYXQgbWlncmF0aW5nIHZj
cHVzIHdpdGhpbiB0aGUgc2FtZSBub2RlCisgICAgICAgICAqIG5vZGUsIG5vdCB0byBtZW50aW9u
IHRoYXQgbWlncmF0aW5nIHVuaXRzIHdpdGhpbiB0aGUgc2FtZSBub2RlCiAgICAgICAgICAqIGNv
dWxkIHdlbGwgZXhwZWN0ZWQgdG8gYmUgY2hlYXBlciB0aGFuIGFjcm9zcy1ub2RlcyAobWVtb3J5
CiAgICAgICAgICAqIHN0YXlzIGxvY2FsLCB0aGVyZSBtaWdodCBiZSBzb21lIG5vZGUtd2lkZSBj
YWNoZVtzXSwgZXRjLikuCiAgICAgICAgICAqLwpAQCAtMTczOCw3ICsxNzM0LDcgQEAgY3NjaGVk
X2xvYWRfYmFsYW5jZShzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBydiwgaW50IGNwdSwKICAgICAg
ICAgICAgICAgICBzcGlubG9ja190ICpsb2NrOwogCiAgICAgICAgICAgICAgICAgLyoKLSAgICAg
ICAgICAgICAgICAgKiBJZiB0aGVyZSBpcyBvbmx5IG9uZSBydW5uYWJsZSB2Q1BVIG9uIHBlZXJf
Y3B1LCBpdCBtZWFucworICAgICAgICAgICAgICAgICAqIElmIHRoZXJlIGlzIG9ubHkgb25lIHJ1
bm5hYmxlIHVuaXQgb24gcGVlcl9jcHUsIGl0IG1lYW5zCiAgICAgICAgICAgICAgICAgICogdGhl
cmUncyBubyBvbmUgdG8gYmUgc3RvbGVuIGluIGl0cyBydW5xdWV1ZSwgc28gc2tpcCBpdC4KICAg
ICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAqIENoZWNraW5nIHRoaXMgd2l0aG91
dCBob2xkaW5nIHRoZSBsb2NrIGlzIHJhY3kuLi4gQnV0IHRoYXQncwpAQCAtMTc1MSwxMyArMTc0
NywxMyBAQCBjc2NoZWRfbG9hZF9iYWxhbmNlKHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCBp
bnQgY3B1LAogICAgICAgICAgICAgICAgICAqICAgQW5kIHdlIGNhbiBhdm9pZCB0aGF0IGJ5IHJl
LWNoZWNraW5nIG5yX3J1bm5hYmxlIGFmdGVyCiAgICAgICAgICAgICAgICAgICogICBoYXZpbmcg
Z3JhYmJlZCB0aGUgbG9jaywgaWYgd2Ugd2FudDsKICAgICAgICAgICAgICAgICAgKiAtIGlmIHdl
IHJhY2Ugd2l0aCBpbmNfbnJfcnVubmFibGUoKSwgd2Ugc2tpcCBhIHBDUFUgdGhhdCBtYXkKLSAg
ICAgICAgICAgICAgICAgKiAgIGhhdmUgcnVubmFibGUgdkNQVXMgaW4gaXRzIHJ1bnF1ZXVlLCBi
dXQgdGhhdCdzIG5vdCBhCisgICAgICAgICAgICAgICAgICogICBoYXZlIHJ1bm5hYmxlIHVuaXRz
IGluIGl0cyBydW5xdWV1ZSwgYnV0IHRoYXQncyBub3QgYQogICAgICAgICAgICAgICAgICAqICAg
cHJvYmxlbSBiZWNhdXNlOgogICAgICAgICAgICAgICAgICAqICAgKyBpZiByYWNpbmcgd2l0aCBj
c2NoZWRfdW5pdF9pbnNlcnQoKSBvciBjc2NoZWRfdW5pdF93YWtlKCksCi0gICAgICAgICAgICAg
ICAgICogICAgIF9fcnVucV90aWNrbGUoKSB3aWxsIGJlIGNhbGxlZCBhZnRlcndvcmRzLCBzbyB0
aGUgdkNQVQorICAgICAgICAgICAgICAgICAqICAgICBfX3J1bnFfdGlja2xlKCkgd2lsbCBiZSBj
YWxsZWQgYWZ0ZXJ3b3Jkcywgc28gdGhlIHVuaXQKICAgICAgICAgICAgICAgICAgKiAgICAgd29u
J3QgZ2V0IHN0dWNrIGluIHRoZSBydW5xdWV1ZSBmb3IgdG9vIGxvbmc7Ci0gICAgICAgICAgICAg
ICAgICogICArIGlmIHJhY2luZyB3aXRoIGNzY2hlZF9ydW5xX3N0ZWFsKCksIGl0IG1heSBiZSB0
aGF0IGEKLSAgICAgICAgICAgICAgICAgKiAgICAgdkNQVSB0aGF0IHdlIGNvdWxkIGhhdmUgcGlj
a2VkIHVwLCBzdGF5cyBpbiBhIHJ1bnF1ZXVlCisgICAgICAgICAgICAgICAgICogICArIGlmIHJh
Y2luZyB3aXRoIGNzY2hlZF9ydW5xX3N0ZWFsKCksIGl0IG1heSBiZSB0aGF0IGFuCisgICAgICAg
ICAgICAgICAgICogICAgIHVuaXQgdGhhdCB3ZSBjb3VsZCBoYXZlIHBpY2tlZCB1cCwgc3RheXMg
aW4gYSBydW5xdWV1ZQogICAgICAgICAgICAgICAgICAqICAgICB1bnRpbCBzb21lb25lIGVsc2Ug
dHJpZXMgdG8gc3RlYWwgaXQgYWdhaW4uIEJ1dCB0aGlzIGlzCiAgICAgICAgICAgICAgICAgICog
ICAgIG5vIHdvcnNlIHRoYW4gd2hhdCBjYW4gaGFwcGVuIGFscmVhZHkgKHdpdGhvdXQgdGhpcwog
ICAgICAgICAgICAgICAgICAqICAgICBvcHRpbWl6YXRpb24pLCBpdCB0aGUgcENQVSB3b3VsZCBz
Y2hlZHVsZSByaWdodCBhZnRlciB3ZQpAQCAtMTc5Miw3ICsxNzg4LDcgQEAgY3NjaGVkX2xvYWRf
YmFsYW5jZShzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBydiwgaW50IGNwdSwKICAgICAgICAgICAg
ICAgICAgICAgY3NjaGVkX3J1bnFfc3RlYWwocGVlcl9jcHUsIGNwdSwgc25leHQtPnByaSwgYnN0
ZXApIDogTlVMTDsKICAgICAgICAgICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9jayhsb2NrLCBw
ZWVyX2NwdSk7CiAKLSAgICAgICAgICAgICAgICAvKiBBcyBzb29uIGFzIG9uZSB2Y3B1IGlzIGZv
dW5kLCBiYWxhbmNpbmcgZW5kcyAqLworICAgICAgICAgICAgICAgIC8qIEFzIHNvb24gYXMgb25l
IHVuaXQgaXMgZm91bmQsIGJhbGFuY2luZyBlbmRzICovCiAgICAgICAgICAgICAgICAgaWYgKCBz
cGVlciAhPSBOVUxMICkKICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICpz
dG9sZW4gPSAxOwpAQCAtMTgzMSwxNCArMTgyNywxNSBAQCBjc2NoZWRfc2NoZWR1bGUoCiB7CiAg
ICAgY29uc3QgaW50IGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKICAgICBzdHJ1Y3QgbGlzdF9o
ZWFkICogY29uc3QgcnVucSA9IFJVTlEoY3B1KTsKLSAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQgKiBj
b25zdCBzY3VyciA9IENTQ0hFRF9VTklUKGN1cnJlbnQtPnNjaGVkX3VuaXQpOworICAgIHN0cnVj
dCBzY2hlZF91bml0ICp1bml0ID0gY3VycmVudC0+c2NoZWRfdW5pdDsKKyAgICBzdHJ1Y3QgY3Nj
aGVkX3VuaXQgKiBjb25zdCBzY3VyciA9IENTQ0hFRF9VTklUKHVuaXQpOwogICAgIHN0cnVjdCBj
c2NoZWRfcHJpdmF0ZSAqcHJ2ID0gQ1NDSEVEX1BSSVYob3BzKTsKICAgICBzdHJ1Y3QgY3NjaGVk
X3VuaXQgKnNuZXh0OwogICAgIHN0cnVjdCB0YXNrX3NsaWNlIHJldDsKICAgICBzX3RpbWVfdCBy
dW50aW1lLCB0c2xpY2U7CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKHNjaGVkdWxlKTsKLSAgICBD
U0NIRURfVkNQVV9DSEVDSyhjdXJyZW50KTsKKyAgICBDU0NIRURfVU5JVF9DSEVDSyh1bml0KTsK
IAogICAgIC8qCiAgICAgICogSGVyZSBpbiBDcmVkaXQxIGNvZGUsIHdlIHVzdWFsbHkganVzdCBj
YWxsIFRSQUNFX25EKCkgaGVscGVycywgYW5kCkBAIC0xODUyLDMxICsxODQ5LDMxIEBAIGNzY2hl
ZF9zY2hlZHVsZSgKICAgICAgICAgfSBkOwogICAgICAgICBkLmNwdSA9IGNwdTsKICAgICAgICAg
ZC50YXNrbGV0ID0gdGFza2xldF93b3JrX3NjaGVkdWxlZDsKLSAgICAgICAgZC5pZGxlID0gaXNf
aWRsZV92Y3B1KGN1cnJlbnQpOworICAgICAgICBkLmlkbGUgPSBpc19pZGxlX3VuaXQodW5pdCk7
CiAgICAgICAgIF9fdHJhY2VfdmFyKFRSQ19DU0NIRURfU0NIRURVTEUsIDEsIHNpemVvZihkKSwK
ICAgICAgICAgICAgICAgICAgICAgKHVuc2lnbmVkIGNoYXIgKikmZCk7CiAgICAgfQogCi0gICAg
cnVudGltZSA9IG5vdyAtIGN1cnJlbnQtPnNjaGVkX3VuaXQtPnN0YXRlX2VudHJ5X3RpbWU7Cisg
ICAgcnVudGltZSA9IG5vdyAtIHVuaXQtPnN0YXRlX2VudHJ5X3RpbWU7CiAgICAgaWYgKCBydW50
aW1lIDwgMCApIC8qIERvZXMgdGhpcyBldmVyIGhhcHBlbj8gKi8KICAgICAgICAgcnVudGltZSA9
IDA7CiAKLSAgICBpZiAoICFpc19pZGxlX3ZjcHUoc2N1cnItPnZjcHUpICkKKyAgICBpZiAoICFp
c19pZGxlX3VuaXQodW5pdCkgKQogICAgIHsKLSAgICAgICAgLyogVXBkYXRlIGNyZWRpdHMgb2Yg
YSBub24taWRsZSBWQ1BVLiAqLworICAgICAgICAvKiBVcGRhdGUgY3JlZGl0cyBvZiBhIG5vbi1p
ZGxlIFVOSVQuICovCiAgICAgICAgIGJ1cm5fY3JlZGl0cyhzY3Vyciwgbm93KTsKICAgICAgICAg
c2N1cnItPnN0YXJ0X3RpbWUgLT0gbm93OwogICAgICAgICBzY3Vyci0+bGFzdF9zY2hlZF90aW1l
ID0gbm93OwogICAgIH0KICAgICBlbHNlCiAgICAgewotICAgICAgICAvKiBSZS1pbnN0YXRlIGEg
Ym9vc3RlZCBpZGxlIFZDUFUgYXMgbm9ybWFsLWlkbGUuICovCisgICAgICAgIC8qIFJlLWluc3Rh
dGUgYSBib29zdGVkIGlkbGUgVU5JVCBhcyBub3JtYWwtaWRsZS4gKi8KICAgICAgICAgc2N1cnIt
PnByaSA9IENTQ0hFRF9QUklfSURMRTsKICAgICB9CiAKICAgICAvKiBDaG9pY2VzLCBjaG9pY2Vz
OgotICAgICAqIC0gSWYgd2UgaGF2ZSBhIHRhc2tsZXQsIHdlIG5lZWQgdG8gcnVuIHRoZSBpZGxl
IHZjcHUgbm8gbWF0dGVyIHdoYXQuCi0gICAgICogLSBJZiBzY2hlZCByYXRlIGxpbWl0aW5nIGlz
IGluIGVmZmVjdCwgYW5kIHRoZSBjdXJyZW50IHZjcHUgaGFzCisgICAgICogLSBJZiB3ZSBoYXZl
IGEgdGFza2xldCwgd2UgbmVlZCB0byBydW4gdGhlIGlkbGUgdW5pdCBubyBtYXR0ZXIgd2hhdC4K
KyAgICAgKiAtIElmIHNjaGVkIHJhdGUgbGltaXRpbmcgaXMgaW4gZWZmZWN0LCBhbmQgdGhlIGN1
cnJlbnQgdW5pdCBoYXMKICAgICAgKiAgIHJ1biBmb3IgbGVzcyB0aGFuIHRoYXQgYW1vdW50IG9m
IHRpbWUsIGNvbnRpbnVlIHRoZSBjdXJyZW50IG9uZSwKICAgICAgKiAgIGJ1dCB3aXRoIGEgc2hv
cnRlciB0aW1lc2xpY2UgYW5kIHJldHVybiBpdCBpbW1lZGlhdGVseQogICAgICAqIC0gT3RoZXJ3
aXNlLCBjaG9zZSB0aGUgb25lIHdpdGggdGhlIGhpZ2hlc3QgcHJpb3JpdHkgKHdoaWNoIG1heQpA
QCAtMTg5NCwxMSArMTg5MSwxMSBAQCBjc2NoZWRfc2NoZWR1bGUoCiAgICAgICogSW4gZmFjdCwg
aXQgbWF5IGJlIHRoZSBjYXNlIHRoYXQgc2N1cnIgaXMgYWJvdXQgdG8gc3BpbiwgYW5kIHRoZXJl
J3MKICAgICAgKiBubyBwb2ludCBmb3JjaW5nIGl0IHRvIGRvIHNvIHVudGlsIHJhdGUgbGltaXRp
bmcgZXhwaXJlcy4KICAgICAgKi8KLSAgICBpZiAoICF0ZXN0X2JpdChDU0NIRURfRkxBR19WQ1BV
X1lJRUxELCAmc2N1cnItPmZsYWdzKQorICAgIGlmICggIXRlc3RfYml0KENTQ0hFRF9GTEFHX1VO
SVRfWUlFTEQsICZzY3Vyci0+ZmxhZ3MpCiAgICAgICAgICAmJiAhdGFza2xldF93b3JrX3NjaGVk
dWxlZAogICAgICAgICAgJiYgcHJ2LT5yYXRlbGltaXQKLSAgICAgICAgICYmIHZjcHVfcnVubmFi
bGUoY3VycmVudCkKLSAgICAgICAgICYmICFpc19pZGxlX3ZjcHUoY3VycmVudCkKKyAgICAgICAg
ICYmIHVuaXRfcnVubmFibGUodW5pdCkKKyAgICAgICAgICYmICFpc19pZGxlX3VuaXQodW5pdCkK
ICAgICAgICAgICYmIHJ1bnRpbWUgPCBwcnYtPnJhdGVsaW1pdCApCiAgICAgewogICAgICAgICBz
bmV4dCA9IHNjdXJyOwpAQCAtMTkxNiwxMSArMTkxMywxMSBAQCBjc2NoZWRfc2NoZWR1bGUoCiAg
ICAgICAgIGlmICggdW5saWtlbHkodGJfaW5pdF9kb25lKSApCiAgICAgICAgIHsKICAgICAgICAg
ICAgIHN0cnVjdCB7Ci0gICAgICAgICAgICAgICAgdW5zaWduZWQgdmNwdToxNiwgZG9tOjE2Owor
ICAgICAgICAgICAgICAgIHVuc2lnbmVkIHVuaXQ6MTYsIGRvbToxNjsKICAgICAgICAgICAgICAg
ICB1bnNpZ25lZCBydW50aW1lOwogICAgICAgICAgICAgfSBkOwotICAgICAgICAgICAgZC5kb20g
PSBzY3Vyci0+dmNwdS0+ZG9tYWluLT5kb21haW5faWQ7Ci0gICAgICAgICAgICBkLnZjcHUgPSBz
Y3Vyci0+dmNwdS0+dmNwdV9pZDsKKyAgICAgICAgICAgIGQuZG9tID0gdW5pdC0+ZG9tYWluLT5k
b21haW5faWQ7CisgICAgICAgICAgICBkLnVuaXQgPSB1bml0LT51bml0X2lkOwogICAgICAgICAg
ICAgZC5ydW50aW1lID0gcnVudGltZTsKICAgICAgICAgICAgIF9fdHJhY2VfdmFyKFRSQ19DU0NI
RURfUkFURUxJTUlULCAxLCBzaXplb2YoZCksCiAgICAgICAgICAgICAgICAgICAgICAgICAodW5z
aWduZWQgY2hhciAqKSZkKTsKQEAgLTE5MzIsMTMgKzE5MjksMTMgQEAgY3NjaGVkX3NjaGVkdWxl
KAogICAgIHRzbGljZSA9IHBydi0+dHNsaWNlOwogCiAgICAgLyoKLSAgICAgKiBTZWxlY3QgbmV4
dCBydW5uYWJsZSBsb2NhbCBWQ1BVIChpZSB0b3Agb2YgbG9jYWwgcnVucSkKKyAgICAgKiBTZWxl
Y3QgbmV4dCBydW5uYWJsZSBsb2NhbCBVTklUIChpZSB0b3Agb2YgbG9jYWwgcnVucSkKICAgICAg
Ki8KLSAgICBpZiAoIHZjcHVfcnVubmFibGUoY3VycmVudCkgKQorICAgIGlmICggdW5pdF9ydW5u
YWJsZSh1bml0KSApCiAgICAgICAgIF9fcnVucV9pbnNlcnQoc2N1cnIpOwogICAgIGVsc2UKICAg
ICB7Ci0gICAgICAgIEJVR19PTiggaXNfaWRsZV92Y3B1KGN1cnJlbnQpIHx8IGxpc3RfZW1wdHko
cnVucSkgKTsKKyAgICAgICAgQlVHX09OKCBpc19pZGxlX3VuaXQodW5pdCkgfHwgbGlzdF9lbXB0
eShydW5xKSApOwogICAgICAgICAvKiBDdXJyZW50IGhhcyBibG9ja2VkLiBVcGRhdGUgdGhlIHJ1
bm5hYmxlIGNvdW50ZXIgZm9yIHRoaXMgY3B1LiAqLwogICAgICAgICBkZWNfbnJfcnVubmFibGUo
Y3B1KTsKICAgICB9CkBAIC0xOTQ2LDIzICsxOTQzLDIzIEBAIGNzY2hlZF9zY2hlZHVsZSgKICAg
ICBzbmV4dCA9IF9fcnVucV9lbGVtKHJ1bnEtPm5leHQpOwogICAgIHJldC5taWdyYXRlZCA9IDA7
CiAKLSAgICAvKiBUYXNrbGV0IHdvcmsgKHdoaWNoIHJ1bnMgaW4gaWRsZSBWQ1BVIGNvbnRleHQp
IG92ZXJyaWRlcyBhbGwgZWxzZS4gKi8KKyAgICAvKiBUYXNrbGV0IHdvcmsgKHdoaWNoIHJ1bnMg
aW4gaWRsZSBVTklUIGNvbnRleHQpIG92ZXJyaWRlcyBhbGwgZWxzZS4gKi8KICAgICBpZiAoIHRh
c2tsZXRfd29ya19zY2hlZHVsZWQgKQogICAgIHsKICAgICAgICAgVFJBQ0VfMEQoVFJDX0NTQ0hF
RF9TQ0hFRF9UQVNLTEVUKTsKLSAgICAgICAgc25leHQgPSBDU0NIRURfVU5JVChpZGxlX3ZjcHVb
Y3B1XS0+c2NoZWRfdW5pdCk7CisgICAgICAgIHNuZXh0ID0gQ1NDSEVEX1VOSVQoc2NoZWRfaWRs
ZV91bml0KGNwdSkpOwogICAgICAgICBzbmV4dC0+cHJpID0gQ1NDSEVEX1BSSV9UU19CT09TVDsK
ICAgICB9CiAKICAgICAvKgogICAgICAqIENsZWFyIFlJRUxEIGZsYWcgYmVmb3JlIHNjaGVkdWxp
bmcgb3V0CiAgICAgICovCi0gICAgY2xlYXJfYml0KENTQ0hFRF9GTEFHX1ZDUFVfWUlFTEQsICZz
Y3Vyci0+ZmxhZ3MpOworICAgIGNsZWFyX2JpdChDU0NIRURfRkxBR19VTklUX1lJRUxELCAmc2N1
cnItPmZsYWdzKTsKIAogICAgIC8qCiAgICAgICogU01QIExvYWQgYmFsYW5jZToKICAgICAgKgot
ICAgICAqIElmIHRoZSBuZXh0IGhpZ2hlc3QgcHJpb3JpdHkgbG9jYWwgcnVubmFibGUgVkNQVSBo
YXMgYWxyZWFkeSBlYXRlbgorICAgICAqIElmIHRoZSBuZXh0IGhpZ2hlc3QgcHJpb3JpdHkgbG9j
YWwgcnVubmFibGUgVU5JVCBoYXMgYWxyZWFkeSBlYXRlbgogICAgICAqIHRocm91Z2ggaXRzIGNy
ZWRpdHMsIGxvb2sgb24gb3RoZXIgUENQVXMgdG8gc2VlIGlmIHdlIGhhdmUgbW9yZQogICAgICAq
IHVyZ2VudCB3b3JrLi4uIElmIG5vdCwgY3NjaGVkX2xvYWRfYmFsYW5jZSgpIHdpbGwgcmV0dXJu
IHNuZXh0LCBidXQKICAgICAgKiBhbHJlYWR5IHJlbW92ZWQgZnJvbSB0aGUgcnVucS4KQEAgLTE5
ODYsMzIgKzE5ODMsMzIgQEAgY3NjaGVkX3NjaGVkdWxlKAogICAgICAgICBjcHVtYXNrX2NsZWFy
X2NwdShjcHUsIHBydi0+aWRsZXJzKTsKICAgICB9CiAKLSAgICBpZiAoICFpc19pZGxlX3ZjcHUo
c25leHQtPnZjcHUpICkKKyAgICBpZiAoICFpc19pZGxlX3VuaXQoc25leHQtPnVuaXQpICkKICAg
ICAgICAgc25leHQtPnN0YXJ0X3RpbWUgKz0gbm93OwogCiBvdXQ6CiAgICAgLyoKICAgICAgKiBS
ZXR1cm4gdGFzayB0byBydW4gbmV4dC4uLgogICAgICAqLwotICAgIHJldC50aW1lID0gKGlzX2lk
bGVfdmNwdShzbmV4dC0+dmNwdSkgPworICAgIHJldC50aW1lID0gKGlzX2lkbGVfdW5pdChzbmV4
dC0+dW5pdCkgPwogICAgICAgICAgICAgICAgIC0xIDogdHNsaWNlKTsKLSAgICByZXQudGFzayA9
IHNuZXh0LT52Y3B1LT5zY2hlZF91bml0OworICAgIHJldC50YXNrID0gc25leHQtPnVuaXQ7CiAK
LSAgICBDU0NIRURfVkNQVV9DSEVDSyhyZXQudGFzay0+dmNwdV9saXN0KTsKKyAgICBDU0NIRURf
VU5JVF9DSEVDSyhyZXQudGFzayk7CiAgICAgcmV0dXJuIHJldDsKIH0KIAogc3RhdGljIHZvaWQK
LWNzY2hlZF9kdW1wX3ZjcHUoc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCitjc2NoZWRfZHVtcF91
bml0KHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewogICAgIHN0cnVjdCBjc2NoZWRfZG9tICog
Y29uc3Qgc2RvbSA9IHN2Yy0+c2RvbTsKIAogICAgIHByaW50aygiWyVpLiVpXSBwcmk9JWkgZmxh
Z3M9JXggY3B1PSVpIiwKLSAgICAgICAgICAgIHN2Yy0+dmNwdS0+ZG9tYWluLT5kb21haW5faWQs
Ci0gICAgICAgICAgICBzdmMtPnZjcHUtPnZjcHVfaWQsCisgICAgICAgICAgICBzdmMtPnVuaXQt
PmRvbWFpbi0+ZG9tYWluX2lkLAorICAgICAgICAgICAgc3ZjLT51bml0LT51bml0X2lkLAogICAg
ICAgICAgICAgc3ZjLT5wcmksCiAgICAgICAgICAgICBzdmMtPmZsYWdzLAotICAgICAgICAgICAg
c3ZjLT52Y3B1LT5wcm9jZXNzb3IpOworICAgICAgICAgICAgc2NoZWRfdW5pdF9tYXN0ZXIoc3Zj
LT51bml0KSk7CiAKICAgICBpZiAoIHNkb20gKQogICAgIHsKQEAgLTIwNDUsNyArMjA0Miw3IEBA
IGNzY2hlZF9kdW1wX3BjcHUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBpbnQgY3B1KQog
CiAgICAgLyoKICAgICAgKiBXZSBuZWVkIGJvdGggbG9ja3M6Ci0gICAgICogLSBjc2NoZWRfZHVt
cF92Y3B1KCkgd2FudHMgdG8gYWNjZXNzIGRvbWFpbnMnIHNjaGVkdWxpbmcKKyAgICAgKiAtIGNz
Y2hlZF9kdW1wX3VuaXQoKSB3YW50cyB0byBhY2Nlc3MgZG9tYWlucycgc2NoZWR1bGluZwogICAg
ICAqICAgcGFyYW1ldGVycywgd2hpY2ggYXJlIHByb3RlY3RlZCBieSB0aGUgcHJpdmF0ZSBzY2hl
ZHVsZXIgbG9jazsKICAgICAgKiAtIHdlIHNjYW4gdGhyb3VnaCB0aGUgcnVucXVldWUsIHNvIHdl
IG5lZWQgdGhlIHByb3BlciBydW5xdWV1ZQogICAgICAqICAgbG9jayAodGhlIG9uZSBvZiB0aGUg
cnVucXVldWUgb2YgdGhpcyBjcHUpLgpAQCAtMjA2MSwxMiArMjA1OCwxMiBAQCBjc2NoZWRfZHVt
cF9wY3B1KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgaW50IGNwdSkKICAgICAgICAgICAg
Q1BVTUFTS19QUihwZXJfY3B1KGNwdV9zaWJsaW5nX21hc2ssIGNwdSkpLAogICAgICAgICAgICBD
UFVNQVNLX1BSKHBlcl9jcHUoY3B1X2NvcmVfbWFzaywgY3B1KSkpOwogCi0gICAgLyogY3VycmVu
dCBWQ1BVIChub3RoaW5nIHRvIHNheSBpZiB0aGF0J3MgdGhlIGlkbGUgdmNwdSkuICovCisgICAg
LyogY3VycmVudCBVTklUIChub3RoaW5nIHRvIHNheSBpZiB0aGF0J3MgdGhlIGlkbGUgdW5pdCku
ICovCiAgICAgc3ZjID0gQ1NDSEVEX1VOSVQoY3Vycl9vbl9jcHUoY3B1KSk7Ci0gICAgaWYgKCBz
dmMgJiYgIWlzX2lkbGVfdmNwdShzdmMtPnZjcHUpICkKKyAgICBpZiAoIHN2YyAmJiAhaXNfaWRs
ZV91bml0KHN2Yy0+dW5pdCkgKQogICAgIHsKICAgICAgICAgcHJpbnRrKCJcdHJ1bjogIik7Ci0g
ICAgICAgIGNzY2hlZF9kdW1wX3ZjcHUoc3ZjKTsKKyAgICAgICAgY3NjaGVkX2R1bXBfdW5pdChz
dmMpOwogICAgIH0KIAogICAgIGxvb3AgPSAwOwpAQCAtMjA3Niw3ICsyMDczLDcgQEAgY3NjaGVk
X2R1bXBfcGNwdShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIGludCBjcHUpCiAgICAgICAg
IGlmICggc3ZjICkKICAgICAgICAgewogICAgICAgICAgICAgcHJpbnRrKCJcdCUzZDogIiwgKyts
b29wKTsKLSAgICAgICAgICAgIGNzY2hlZF9kdW1wX3ZjcHUoc3ZjKTsKKyAgICAgICAgICAgIGNz
Y2hlZF9kdW1wX3VuaXQoc3ZjKTsKICAgICAgICAgfQogICAgIH0KIApAQCAtMjExOCwyOSArMjEx
NSwyOSBAQCBjc2NoZWRfZHVtcChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMpCiAgICAgICAg
ICAgIHBydi0+cmF0ZWxpbWl0IC8gTUlDUk9TRUNTKDEpLAogICAgICAgICAgICBDU0NIRURfQ1JF
RElUU19QRVJfTVNFQywKICAgICAgICAgICAgcHJ2LT50aWNrc19wZXJfdHNsaWNlLAotICAgICAg
ICAgICBwcnYtPnZjcHVfbWlncl9kZWxheS8gTUlDUk9TRUNTKDEpKTsKKyAgICAgICAgICAgcHJ2
LT51bml0X21pZ3JfZGVsYXkvIE1JQ1JPU0VDUygxKSk7CiAKICAgICBwcmludGsoImlkbGVyczog
JSpwYlxuIiwgQ1BVTUFTS19QUihwcnYtPmlkbGVycykpOwogCi0gICAgcHJpbnRrKCJhY3RpdmUg
dmNwdXM6XG4iKTsKKyAgICBwcmludGsoImFjdGl2ZSB1bml0czpcbiIpOwogICAgIGxvb3AgPSAw
OwogICAgIGxpc3RfZm9yX2VhY2goIGl0ZXJfc2RvbSwgJnBydi0+YWN0aXZlX3Nkb20gKQogICAg
IHsKICAgICAgICAgc3RydWN0IGNzY2hlZF9kb20gKnNkb207CiAgICAgICAgIHNkb20gPSBsaXN0
X2VudHJ5KGl0ZXJfc2RvbSwgc3RydWN0IGNzY2hlZF9kb20sIGFjdGl2ZV9zZG9tX2VsZW0pOwog
Ci0gICAgICAgIGxpc3RfZm9yX2VhY2goIGl0ZXJfc3ZjLCAmc2RvbS0+YWN0aXZlX3ZjcHUgKQor
ICAgICAgICBsaXN0X2Zvcl9lYWNoKCBpdGVyX3N2YywgJnNkb20tPmFjdGl2ZV91bml0ICkKICAg
ICAgICAgewogICAgICAgICAgICAgc3RydWN0IGNzY2hlZF91bml0ICpzdmM7CiAgICAgICAgICAg
ICBzcGlubG9ja190ICpsb2NrOwogCi0gICAgICAgICAgICBzdmMgPSBsaXN0X2VudHJ5KGl0ZXJf
c3ZjLCBzdHJ1Y3QgY3NjaGVkX3VuaXQsIGFjdGl2ZV92Y3B1X2VsZW0pOwotICAgICAgICAgICAg
bG9jayA9IHVuaXRfc2NoZWR1bGVfbG9jayhzdmMtPnZjcHUtPnNjaGVkX3VuaXQpOworICAgICAg
ICAgICAgc3ZjID0gbGlzdF9lbnRyeShpdGVyX3N2Yywgc3RydWN0IGNzY2hlZF91bml0LCBhY3Rp
dmVfdW5pdF9lbGVtKTsKKyAgICAgICAgICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2soc3Zj
LT51bml0KTsKIAogICAgICAgICAgICAgcHJpbnRrKCJcdCUzZDogIiwgKytsb29wKTsKLSAgICAg
ICAgICAgIGNzY2hlZF9kdW1wX3ZjcHUoc3ZjKTsKKyAgICAgICAgICAgIGNzY2hlZF9kdW1wX3Vu
aXQoc3ZjKTsKIAotICAgICAgICAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2sobG9jaywgc3ZjLT52
Y3B1LT5zY2hlZF91bml0KTsKKyAgICAgICAgICAgIHVuaXRfc2NoZWR1bGVfdW5sb2NrKGxvY2ss
IHN2Yy0+dW5pdCk7CiAgICAgICAgIH0KICAgICB9CiAKQEAgLTIyMTQsNyArMjIxMSw3IEBAIGNz
Y2hlZF9pbml0KHN0cnVjdCBzY2hlZHVsZXIgKm9wcykKICAgICBlbHNlCiAgICAgICAgIHBydi0+
cmF0ZWxpbWl0ID0gTUlDUk9TRUNTKHNjaGVkX3JhdGVsaW1pdF91cyk7CiAKLSAgICBwcnYtPnZj
cHVfbWlncl9kZWxheSA9IE1JQ1JPU0VDUyh2Y3B1X21pZ3JhdGlvbl9kZWxheV91cyk7CisgICAg
cHJ2LT51bml0X21pZ3JfZGVsYXkgPSBNSUNST1NFQ1ModmNwdV9taWdyYXRpb25fZGVsYXlfdXMp
OwogCiAgICAgcmV0dXJuIDA7CiB9Ci0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZl
bEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxt
YW4vbGlzdGluZm8veGVuLWRldmVs

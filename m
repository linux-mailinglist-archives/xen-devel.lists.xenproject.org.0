Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id A1FE1168701
	for <lists+xen-devel@lfdr.de>; Fri, 21 Feb 2020 19:52:23 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j5DMs-0006fJ-Pm; Fri, 21 Feb 2020 18:49:42 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=JJS4=4J=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1j5DMr-0006ez-Lw
 for xen-devel@lists.xenproject.org; Fri, 21 Feb 2020 18:49:41 +0000
X-Inumbo-ID: e85df652-54da-11ea-b0fd-bc764e2007e4
Received: from mga12.intel.com (unknown [192.55.52.136])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id e85df652-54da-11ea-b0fd-bc764e2007e4;
 Fri, 21 Feb 2020 18:49:36 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
 by fmsmga106.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 21 Feb 2020 10:49:35 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.70,469,1574150400"; d="scan'208";a="259709287"
Received: from btraw-mobl.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.251.1.240])
 by fmsmga004.fm.intel.com with ESMTP; 21 Feb 2020 10:49:34 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 21 Feb 2020 10:49:21 -0800
Message-Id: <dff6668838b61fb7fe508588bef91d650cddfeb5.1582310142.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1582310142.git.tamas.lengyel@intel.com>
References: <cover.1582310142.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v9 3/5] xen/mem_sharing: VM forking
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Stefano Stabellini <sstabellini@kernel.org>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>,
 George Dunlap <george.dunlap@citrix.com>,
 Tamas K Lengyel <tamas@tklengyel.com>, Jan Beulich <jbeulich@suse.com>,
 Julien Grall <julien@xen.org>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Vk0gZm9ya2luZyBpcyB0aGUgcHJvY2VzcyBvZiBjcmVhdGluZyBhIGRvbWFpbiB3aXRoIGFuIGVt
cHR5IG1lbW9yeSBzcGFjZSBhbmQgYQpwYXJlbnQgZG9tYWluIHNwZWNpZmllZCBmcm9tIHdoaWNo
IHRvIHBvcHVsYXRlIHRoZSBtZW1vcnkgd2hlbiBuZWNlc3NhcnkuIEZvcgp0aGUgbmV3IGRvbWFp
biB0byBiZSBmdW5jdGlvbmFsIHRoZSBWTSBzdGF0ZSBpcyBjb3BpZWQgb3ZlciBhcyBwYXJ0IG9m
IHRoZSBmb3JrCm9wZXJhdGlvbiAoSFZNIHBhcmFtcywgaGFwIGFsbG9jYXRpb24sIGV0YykuCgpT
aWduZWQtb2ZmLWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxAaW50ZWwuY29tPgot
LS0Kdjk6IHJlbW92ZSBzdGFsZSBoZWFkZXIKICAgIGZpeCB0c2MgaW5jYXJuYXRpb24gYmVpbmcg
YnVtcGVkIG9uIHNldAotLS0KIHhlbi9hcmNoL3g4Ni9kb21haW4uYyAgICAgICAgICAgICB8ICAx
MSArKwogeGVuL2FyY2gveDg2L2h2bS9odm0uYyAgICAgICAgICAgIHwgICAyICstCiB4ZW4vYXJj
aC94ODYvbW0vbWVtX3NoYXJpbmcuYyAgICAgfCAyMjIgKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrCiB4ZW4vYXJjaC94ODYvbW0vcDJtLmMgICAgICAgICAgICAgfCAgMTEgKy0KIHhlbi9p
bmNsdWRlL2FzbS14ODYvbWVtX3NoYXJpbmcuaCB8ICAxNyArKysKIHhlbi9pbmNsdWRlL3B1Ymxp
Yy9tZW1vcnkuaCAgICAgICB8ICAgNSArCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCAgICAgICAg
ICAgfCAgIDIgKwogNyBmaWxlcyBjaGFuZ2VkLCAyNjggaW5zZXJ0aW9ucygrKSwgMiBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvZG9tYWluLmMgYi94ZW4vYXJjaC94ODYv
ZG9tYWluLmMKaW5kZXggZmU2M2MyMzY3Ni4uMWFiMGNhMDk0MiAxMDA2NDQKLS0tIGEveGVuL2Fy
Y2gveDg2L2RvbWFpbi5jCisrKyBiL3hlbi9hcmNoL3g4Ni9kb21haW4uYwpAQCAtMjIwMyw2ICsy
MjAzLDE3IEBAIGludCBkb21haW5fcmVsaW5xdWlzaF9yZXNvdXJjZXMoc3RydWN0IGRvbWFpbiAq
ZCkKICAgICAgICAgICAgIHJldCA9IHJlbGlucXVpc2hfc2hhcmVkX3BhZ2VzKGQpOwogICAgICAg
ICAgICAgaWYgKCByZXQgKQogICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CisKKyAgICAgICAg
ICAgIC8qCisgICAgICAgICAgICAgKiBJZiB0aGUgZG9tYWluIGlzIGZvcmtlZCwgZGVjcmVtZW50
IHRoZSBwYXJlbnQncyBwYXVzZSBjb3VudAorICAgICAgICAgICAgICogYW5kIHJlbGVhc2UgdGhl
IGRvbWFpbi4KKyAgICAgICAgICAgICAqLworICAgICAgICAgICAgaWYgKCBkLT5wYXJlbnQgKQor
ICAgICAgICAgICAgeworICAgICAgICAgICAgICAgIGRvbWFpbl91bnBhdXNlKGQtPnBhcmVudCk7
CisgICAgICAgICAgICAgICAgcHV0X2RvbWFpbihkLT5wYXJlbnQpOworICAgICAgICAgICAgICAg
IGQtPnBhcmVudCA9IE5VTEw7CisgICAgICAgICAgICB9CiAgICAgICAgIH0KICNlbmRpZgogCmRp
ZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvaHZtL2h2bS5jIGIveGVuL2FyY2gveDg2L2h2bS9odm0u
YwppbmRleCBhMzM5YjM2YTBkLi45YmZhNjAzZjhjIDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYv
aHZtL2h2bS5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMKQEAgLTE5MTUsNyArMTkxNSw3
IEBAIGludCBodm1faGFwX25lc3RlZF9wYWdlX2ZhdWx0KHBhZGRyX3QgZ3BhLCB1bnNpZ25lZCBs
b25nIGdsYSwKICAgICB9CiAjZW5kaWYKIAotICAgIC8qIFNwdXJpb3VzIGZhdWx0PyBQb0QgYW5k
IGxvZy1kaXJ0eSBhbHNvIHRha2UgdGhpcyBwYXRoLiAqLworICAgIC8qIFNwdXJpb3VzIGZhdWx0
PyBQb0QsIGxvZy1kaXJ0eSBhbmQgVk0gZm9ya2luZyBhbHNvIHRha2UgdGhpcyBwYXRoLiAqLwog
ICAgIGlmICggcDJtX2lzX3JhbShwMm10KSApCiAgICAgewogICAgICAgICByYyA9IDE7CmRpZmYg
LS1naXQgYS94ZW4vYXJjaC94ODYvbW0vbWVtX3NoYXJpbmcuYyBiL3hlbi9hcmNoL3g4Ni9tbS9t
ZW1fc2hhcmluZy5jCmluZGV4IDM4MzViYzkyOGYuLmFkNWRiOWQ4ZDUgMTAwNjQ0Ci0tLSBhL3hl
bi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmluZy5jCisrKyBiL3hlbi9hcmNoL3g4Ni9tbS9tZW1fc2hh
cmluZy5jCkBAIC0yMiw2ICsyMiw3IEBACiAKICNpbmNsdWRlIDx4ZW4vdHlwZXMuaD4KICNpbmNs
dWRlIDx4ZW4vZG9tYWluX3BhZ2UuaD4KKyNpbmNsdWRlIDx4ZW4vZXZlbnQuaD4KICNpbmNsdWRl
IDx4ZW4vc3BpbmxvY2suaD4KICNpbmNsdWRlIDx4ZW4vcndsb2NrLmg+CiAjaW5jbHVkZSA8eGVu
L21tLmg+CkBAIC0zNiw2ICszNyw5IEBACiAjaW5jbHVkZSA8YXNtL2FsdHAybS5oPgogI2luY2x1
ZGUgPGFzbS9hdG9taWMuaD4KICNpbmNsdWRlIDxhc20vZXZlbnQuaD4KKyNpbmNsdWRlIDxhc20v
aGFwLmg+CisjaW5jbHVkZSA8YXNtL2h2bS9odm0uaD4KKyNpbmNsdWRlIDxhc20vaHZtL3NhdmUu
aD4KICNpbmNsdWRlIDx4c20veHNtLmg+CiAKICNpbmNsdWRlICJtbS1sb2Nrcy5oIgpAQCAtMTQ0
NCw2ICsxNDQ4LDE5NCBAQCBzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ19jb250cm9sKHN0
cnVjdCBkb21haW4gKmQsIGJvb2wgZW5hYmxlKQogICAgIHJldHVybiAwOwogfQogCisvKgorICog
Rm9ya2luZyBhIHBhZ2Ugb25seSBnZXRzIGNhbGxlZCB3aGVuIHRoZSBWTSBmYXVsdHMgZHVlIHRv
IG5vIGVudHJ5IGJlaW5nCisgKiBpbiB0aGUgRVBUIGZvciB0aGUgYWNjZXNzLiBEZXBlbmRpbmcg
b24gdGhlIHR5cGUgb2YgYWNjZXNzIHdlIGVpdGhlcgorICogcG9wdWxhdGUgdGhlIHBoeXNtYXAg
d2l0aCBhIHNoYXJlZCBlbnRyeSBmb3IgcmVhZC1vbmx5IGFjY2VzcyBvcgorICogZm9yayB0aGUg
cGFnZSBpZiBpdHMgYSB3cml0ZSBhY2Nlc3MuCisgKgorICogVGhlIGNsaWVudCBwMm0gaXMgYWxy
ZWFkeSBsb2NrZWQgc28gd2Ugb25seSBuZWVkIHRvIGxvY2sKKyAqIHRoZSBwYXJlbnQncyBoZXJl
LgorICovCitpbnQgbWVtX3NoYXJpbmdfZm9ya19wYWdlKHN0cnVjdCBkb21haW4gKmQsIGdmbl90
IGdmbiwgYm9vbCB1bnNoYXJpbmcpCit7CisgICAgaW50IHJjID0gLUVOT0VOVDsKKyAgICBzaHJf
aGFuZGxlX3QgaGFuZGxlOworICAgIHN0cnVjdCBkb21haW4gKnBhcmVudDsKKyAgICBzdHJ1Y3Qg
cDJtX2RvbWFpbiAqcDJtOworICAgIHVuc2lnbmVkIGxvbmcgZ2ZuX2wgPSBnZm5feChnZm4pOwor
ICAgIG1mbl90IG1mbiwgbmV3X21mbjsKKyAgICBwMm1fdHlwZV90IHAybXQ7CisgICAgc3RydWN0
IHBhZ2VfaW5mbyAqcGFnZTsKKworICAgIGlmICggIW1lbV9zaGFyaW5nX2lzX2ZvcmsoZCkgKQor
ICAgICAgICByZXR1cm4gLUVOT0VOVDsKKworICAgIHBhcmVudCA9IGQtPnBhcmVudDsKKworICAg
IGlmICggIXVuc2hhcmluZyApCisgICAgeworICAgICAgICAvKiBGb3IgcmVhZC1vbmx5IGFjY2Vz
c2VzIHdlIGp1c3QgYWRkIGEgc2hhcmVkIGVudHJ5IHRvIHRoZSBwaHlzbWFwICovCisgICAgICAg
IHdoaWxlICggcGFyZW50ICkKKyAgICAgICAgeworICAgICAgICAgICAgaWYgKCAhKHJjID0gbm9t
aW5hdGVfcGFnZShwYXJlbnQsIGdmbiwgMCwgJmhhbmRsZSkpICkKKyAgICAgICAgICAgICAgICBi
cmVhazsKKworICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LT5wYXJlbnQ7CisgICAgICAgIH0K
KworICAgICAgICBpZiAoICFyYyApCisgICAgICAgIHsKKyAgICAgICAgICAgIC8qIFRoZSBjbGll
bnQncyBwMm0gaXMgYWxyZWFkeSBsb2NrZWQgKi8KKyAgICAgICAgICAgIHN0cnVjdCBwMm1fZG9t
YWluICpwcDJtID0gcDJtX2dldF9ob3N0cDJtKHBhcmVudCk7CisKKyAgICAgICAgICAgIHAybV9s
b2NrKHBwMm0pOworICAgICAgICAgICAgcmMgPSBhZGRfdG9fcGh5c21hcChwYXJlbnQsIGdmbl9s
LCBoYW5kbGUsIGQsIGdmbl9sLCBmYWxzZSk7CisgICAgICAgICAgICBwMm1fdW5sb2NrKHBwMm0p
OworCisgICAgICAgICAgICBpZiAoICFyYyApCisgICAgICAgICAgICAgICAgcmV0dXJuIDA7Cisg
ICAgICAgIH0KKyAgICB9CisKKyAgICAvKgorICAgICAqIElmIGl0J3MgYSB3cml0ZSBhY2Nlc3Mg
KGllLiB1bnNoYXJpbmcpIG9yIGlmIGFkZGluZyBhIHNoYXJlZCBlbnRyeSB0bworICAgICAqIHRo
ZSBwaHlzbWFwIGZhaWxlZCB3ZSdsbCBmb3JrIHRoZSBwYWdlIGRpcmVjdGx5LgorICAgICAqLwor
ICAgIHAybSA9IHAybV9nZXRfaG9zdHAybShkKTsKKyAgICBwYXJlbnQgPSBkLT5wYXJlbnQ7CisK
KyAgICB3aGlsZSAoIHBhcmVudCApCisgICAgeworICAgICAgICBtZm4gPSBnZXRfZ2ZuX3F1ZXJ5
KHBhcmVudCwgZ2ZuX2wsICZwMm10KTsKKworICAgICAgICBpZiAoIG1mbl92YWxpZChtZm4pICYm
IHAybV9pc19hbnlfcmFtKHAybXQpICkKKyAgICAgICAgICAgIGJyZWFrOworCisgICAgICAgIHB1
dF9nZm4ocGFyZW50LCBnZm5fbCk7CisgICAgICAgIHBhcmVudCA9IHBhcmVudC0+cGFyZW50Owor
ICAgIH0KKworICAgIGlmICggIXBhcmVudCApCisgICAgICAgIHJldHVybiAtRU5PRU5UOworCisg
ICAgaWYgKCAhKHBhZ2UgPSBhbGxvY19kb21oZWFwX3BhZ2UoZCwgMCkpICkKKyAgICB7CisgICAg
ICAgIHB1dF9nZm4ocGFyZW50LCBnZm5fbCk7CisgICAgICAgIHJldHVybiAtRU5PTUVNOworICAg
IH0KKworICAgIG5ld19tZm4gPSBwYWdlX3RvX21mbihwYWdlKTsKKyAgICBjb3B5X2RvbWFpbl9w
YWdlKG5ld19tZm4sIG1mbik7CisgICAgc2V0X2dwZm5fZnJvbV9tZm4obWZuX3gobmV3X21mbiks
IGdmbl9sKTsKKworICAgIHB1dF9nZm4ocGFyZW50LCBnZm5fbCk7CisKKyAgICByZXR1cm4gcDJt
LT5zZXRfZW50cnkocDJtLCBnZm4sIG5ld19tZm4sIFBBR0VfT1JERVJfNEssIHAybV9yYW1fcncs
CisgICAgICAgICAgICAgICAgICAgICAgICAgIHAybS0+ZGVmYXVsdF9hY2Nlc3MsIC0xKTsKK30K
Kworc3RhdGljIGludCBicmluZ191cF92Y3B1cyhzdHJ1Y3QgZG9tYWluICpjZCwgc3RydWN0IGNw
dXBvb2wgKmNwdXBvb2wpCit7CisgICAgaW50IHJldDsKKyAgICB1bnNpZ25lZCBpbnQgaTsKKwor
ICAgIGlmICggKHJldCA9IGNwdXBvb2xfbW92ZV9kb21haW4oY2QsIGNwdXBvb2wpKSApCisgICAg
ICAgIHJldHVybiByZXQ7CisKKyAgICBmb3IgKCBpID0gMDsgaSA8IGNkLT5tYXhfdmNwdXM7IGkr
KyApCisgICAgeworICAgICAgICBpZiAoIGNkLT52Y3B1W2ldICkKKyAgICAgICAgICAgIGNvbnRp
bnVlOworCisgICAgICAgIGlmICggIXZjcHVfY3JlYXRlKGNkLCBpKSApCisgICAgICAgICAgICBy
ZXR1cm4gLUVJTlZBTDsKKyAgICB9CisKKyAgICBkb21haW5fdXBkYXRlX25vZGVfYWZmaW5pdHko
Y2QpOworICAgIHJldHVybiAwOworfQorCitzdGF0aWMgaW50IGZvcmtfaGFwX2FsbG9jYXRpb24o
c3RydWN0IGRvbWFpbiAqY2QsIHN0cnVjdCBkb21haW4gKmQpCit7CisgICAgaW50IHJjOworICAg
IGJvb2wgcHJlZW1wdGVkOworICAgIHVuc2lnbmVkIGxvbmcgbWIgPSBoYXBfZ2V0X2FsbG9jYXRp
b24oZCk7CisKKyAgICBpZiAoIG1iID09IGhhcF9nZXRfYWxsb2NhdGlvbihjZCkgKQorICAgICAg
ICByZXR1cm4gMDsKKworICAgIHBhZ2luZ19sb2NrKGNkKTsKKyAgICByYyA9IGhhcF9zZXRfYWxs
b2NhdGlvbihjZCwgbWIgPDwgKDIwIC0gUEFHRV9TSElGVCksICZwcmVlbXB0ZWQpOworICAgIHBh
Z2luZ191bmxvY2soY2QpOworCisgICAgaWYgKCByYyApCisgICAgICAgIHJldHVybiByYzsKKwor
ICAgIGlmICggcHJlZW1wdGVkICkKKyAgICAgICAgcmV0dXJuIC1FUkVTVEFSVDsKKworICAgIHJl
dHVybiAwOworfQorCitzdGF0aWMgdm9pZCBmb3JrX3RzYyhzdHJ1Y3QgZG9tYWluICpjZCwgc3Ry
dWN0IGRvbWFpbiAqZCkKK3sKKyAgICB1aW50MzJfdCB0c2NfbW9kZTsKKyAgICB1aW50MzJfdCBn
dHNjX2toejsKKyAgICB1aW50MzJfdCBpbmNhcm5hdGlvbjsKKyAgICB1aW50NjRfdCBlbGFwc2Vk
X25zZWM7CisKKyAgICB0c2NfZ2V0X2luZm8oZCwgJnRzY19tb2RlLCAmZWxhcHNlZF9uc2VjLCAm
Z3RzY19raHosICZpbmNhcm5hdGlvbik7CisgICAgLyogRG9uJ3QgYnVtcCBpbmNhcm5hdGlvbiBv
biBzZXQgKi8KKyAgICB0c2Nfc2V0X2luZm8oY2QsIHRzY19tb2RlLCBlbGFwc2VkX25zZWMsIGd0
c2Nfa2h6LCBpbmNhcm5hdGlvbiAtIDEpOworfQorCitzdGF0aWMgaW50IG1lbV9zaGFyaW5nX2Zv
cmsoc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IGRvbWFpbiAqY2QpCit7CisgICAgaW50IHJjID0g
LUVJTlZBTDsKKworICAgIGlmICggIWNkLT5jb250cm9sbGVyX3BhdXNlX2NvdW50ICkKKyAgICAg
ICAgcmV0dXJuIHJjOworCisgICAgLyoKKyAgICAgKiBXZSBvbmx5IHdhbnQgdG8gZ2V0IGFuZCBw
YXVzZSB0aGUgcGFyZW50IG9uY2UsIG5vdCBlYWNoIHRpbWUgdGhpcworICAgICAqIG9wZXJhdGlv
biBpcyByZXN0YXJ0ZWQgZHVlIHRvIHByZWVtcHRpb24uCisgICAgICovCisgICAgaWYgKCAhY2Qt
PnBhcmVudF9wYXVzZWQgKQorICAgIHsKKyAgICAgICAgQVNTRVJUKGdldF9kb21haW4oZCkpOwor
ICAgICAgICBkb21haW5fcGF1c2UoZCk7CisKKyAgICAgICAgY2QtPnBhcmVudF9wYXVzZWQgPSB0
cnVlOworICAgICAgICBjZC0+bWF4X3BhZ2VzID0gZC0+bWF4X3BhZ2VzOworICAgICAgICBjZC0+
bWF4X3ZjcHVzID0gZC0+bWF4X3ZjcHVzOworICAgIH0KKworICAgIC8qIHRoaXMgaXMgcHJlZW1w
dGlibGUgc28gaXQncyB0aGUgZmlyc3QgdG8gZ2V0IGRvbmUgKi8KKyAgICBpZiAoIChyYyA9IGZv
cmtfaGFwX2FsbG9jYXRpb24oY2QsIGQpKSApCisgICAgICAgIGdvdG8gZG9uZTsKKworICAgIGlm
ICggKHJjID0gYnJpbmdfdXBfdmNwdXMoY2QsIGQtPmNwdXBvb2wpKSApCisgICAgICAgIGdvdG8g
ZG9uZTsKKworICAgIGlmICggKHJjID0gaHZtX2NvcHlfY29udGV4dF9hbmRfcGFyYW1zKGNkLCBk
KSkgKQorICAgICAgICBnb3RvIGRvbmU7CisKKyAgICBmb3JrX3RzYyhjZCwgZCk7CisKKyAgICBj
ZC0+cGFyZW50ID0gZDsKKworIGRvbmU6CisgICAgaWYgKCByYyAmJiByYyAhPSAtRVJFU1RBUlQg
KQorICAgIHsKKyAgICAgICAgZG9tYWluX3VucGF1c2UoZCk7CisgICAgICAgIHB1dF9kb21haW4o
ZCk7CisgICAgICAgIGNkLT5wYXJlbnRfcGF1c2VkID0gZmFsc2U7CisgICAgfQorCisgICAgcmV0
dXJuIHJjOworfQorCiBpbnQgbWVtX3NoYXJpbmdfbWVtb3AoWEVOX0dVRVNUX0hBTkRMRV9QQVJB
TSh4ZW5fbWVtX3NoYXJpbmdfb3BfdCkgYXJnKQogewogICAgIGludCByYzsKQEAgLTE2OTgsNiAr
MTg5MCwzNiBAQCBpbnQgbWVtX3NoYXJpbmdfbWVtb3AoWEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4
ZW5fbWVtX3NoYXJpbmdfb3BfdCkgYXJnKQogICAgICAgICByYyA9IGRlYnVnX2dyZWYoZCwgbXNv
LnUuZGVidWcudS5ncmVmKTsKICAgICAgICAgYnJlYWs7CiAKKyAgICBjYXNlIFhFTk1FTV9zaGFy
aW5nX29wX2Zvcms6CisgICAgeworICAgICAgICBzdHJ1Y3QgZG9tYWluICpwZDsKKworICAgICAg
ICByYyA9IC1FSU5WQUw7CisgICAgICAgIGlmICggbXNvLnUuZm9yay5fcGFkWzBdIHx8IG1zby51
LmZvcmsuX3BhZFsxXSB8fAorICAgICAgICAgICAgIG1zby51LmZvcmsuX3BhZFsyXSApCisgICAg
ICAgICAgICBnb3RvIG91dDsKKworICAgICAgICByYyA9IHJjdV9sb2NrX2xpdmVfcmVtb3RlX2Rv
bWFpbl9ieV9pZChtc28udS5mb3JrLnBhcmVudF9kb21haW4sCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICZwZCk7CisgICAgICAgIGlmICggcmMgKQorICAg
ICAgICAgICAgZ290byBvdXQ7CisKKyAgICAgICAgaWYgKCAhbWVtX3NoYXJpbmdfZW5hYmxlZChw
ZCkgKQorICAgICAgICB7CisgICAgICAgICAgICBpZiAoIChyYyA9IG1lbV9zaGFyaW5nX2NvbnRy
b2wocGQsIHRydWUpKSApCisgICAgICAgICAgICAgICAgZ290byBvdXQ7CisgICAgICAgIH0KKwor
ICAgICAgICByYyA9IG1lbV9zaGFyaW5nX2ZvcmsocGQsIGQpOworCisgICAgICAgIGlmICggcmMg
PT0gLUVSRVNUQVJUICkKKyAgICAgICAgICAgIHJjID0gaHlwZXJjYWxsX2NyZWF0ZV9jb250aW51
YXRpb24oX19IWVBFUlZJU09SX21lbW9yeV9vcCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgImxoIiwgWEVOTUVNX3NoYXJpbmdfb3AsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZyk7CisgICAgICAgIHJjdV91
bmxvY2tfZG9tYWluKHBkKTsKKyAgICAgICAgYnJlYWs7CisgICAgfQorCiAgICAgZGVmYXVsdDoK
ICAgICAgICAgcmMgPSAtRU5PU1lTOwogICAgICAgICBicmVhazsKZGlmZiAtLWdpdCBhL3hlbi9h
cmNoL3g4Ni9tbS9wMm0uYyBiL3hlbi9hcmNoL3g4Ni9tbS9wMm0uYwppbmRleCBjNWY0MjhkNjdj
Li43YzRkMmZkN2EwIDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvbW0vcDJtLmMKKysrIGIveGVu
L2FyY2gveDg2L21tL3AybS5jCkBAIC01MDksNiArNTA5LDE0IEBAIG1mbl90IF9fZ2V0X2dmbl90
eXBlX2FjY2VzcyhzdHJ1Y3QgcDJtX2RvbWFpbiAqcDJtLCB1bnNpZ25lZCBsb25nIGdmbl9sLAog
CiAgICAgbWZuID0gcDJtLT5nZXRfZW50cnkocDJtLCBnZm4sIHQsIGEsIHEsIHBhZ2Vfb3JkZXIs
IE5VTEwpOwogCisgICAgLyogQ2hlY2sgaWYgd2UgbmVlZCB0byBmb3JrIHRoZSBwYWdlICovCisg
ICAgaWYgKCAocSAmIFAyTV9BTExPQykgJiYgcDJtX2lzX2hvbGUoKnQpICYmCisgICAgICAgICAh
bWVtX3NoYXJpbmdfZm9ya19wYWdlKHAybS0+ZG9tYWluLCBnZm4sICEhKHEgJiBQMk1fVU5TSEFS
RSkpICkKKyAgICB7CisgICAgICAgIG1mbiA9IHAybS0+Z2V0X2VudHJ5KHAybSwgZ2ZuLCB0LCBh
LCBxLCBwYWdlX29yZGVyLCBOVUxMKTsKKyAgICB9CisKKyAgICAvKiBDaGVjayBpZiB3ZSBuZWVk
IHRvIHVuc2hhcmUgdGhlIHBhZ2UgKi8KICAgICBpZiAoIChxICYgUDJNX1VOU0hBUkUpICYmIHAy
bV9pc19zaGFyZWQoKnQpICkKICAgICB7CiAgICAgICAgIEFTU0VSVChwMm1faXNfaG9zdHAybShw
Mm0pKTsKQEAgLTU4OCw3ICs1OTYsOCBAQCBzdHJ1Y3QgcGFnZV9pbmZvICpwMm1fZ2V0X3BhZ2Vf
ZnJvbV9nZm4oCiAgICAgICAgICAgICByZXR1cm4gcGFnZTsKIAogICAgICAgICAvKiBFcnJvciBw
YXRoOiBub3QgYSBzdWl0YWJsZSBHRk4gYXQgYWxsICovCi0gICAgICAgIGlmICggIXAybV9pc19y
YW0oKnQpICYmICFwMm1faXNfcGFnaW5nKCp0KSAmJiAhcDJtX2lzX3BvZCgqdCkgKQorICAgICAg
ICBpZiAoICFwMm1faXNfcmFtKCp0KSAmJiAhcDJtX2lzX3BhZ2luZygqdCkgJiYgIXAybV9pc19w
b2QoKnQpICYmCisgICAgICAgICAgICAgIW1lbV9zaGFyaW5nX2lzX2ZvcmsocDJtLT5kb21haW4p
ICkKICAgICAgICAgICAgIHJldHVybiBOVUxMOwogICAgIH0KIApkaWZmIC0tZ2l0IGEveGVuL2lu
Y2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oIGIveGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hh
cmluZy5oCmluZGV4IDUzNzYwYTI4OTYuLmFjOTY4ZmFlM2YgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNs
dWRlL2FzbS14ODYvbWVtX3NoYXJpbmcuaAorKysgYi94ZW4vaW5jbHVkZS9hc20teDg2L21lbV9z
aGFyaW5nLmgKQEAgLTM5LDYgKzM5LDkgQEAgc3RydWN0IG1lbV9zaGFyaW5nX2RvbWFpbgogCiAj
ZGVmaW5lIG1lbV9zaGFyaW5nX2VuYWJsZWQoZCkgKChkKS0+YXJjaC5odm0ubWVtX3NoYXJpbmcu
ZW5hYmxlZCkKIAorI2RlZmluZSBtZW1fc2hhcmluZ19pc19mb3JrKGQpIFwKKyAgICAobWVtX3No
YXJpbmdfZW5hYmxlZChkKSAmJiAhISgoZCktPnBhcmVudCkpCisKIC8qIEF1ZGl0aW5nIG9mIG1l
bW9yeSBzaGFyaW5nIGNvZGU/ICovCiAjaWZuZGVmIE5ERUJVRwogI2RlZmluZSBNRU1fU0hBUklO
R19BVURJVCAxCkBAIC04OCw2ICs5MSw5IEBAIHN0YXRpYyBpbmxpbmUgaW50IG1lbV9zaGFyaW5n
X3Vuc2hhcmVfcGFnZShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHJldHVybiByYzsKIH0KIAoraW50
IG1lbV9zaGFyaW5nX2ZvcmtfcGFnZShzdHJ1Y3QgZG9tYWluICpkLCBnZm5fdCBnZm4sCisgICAg
ICAgICAgICAgICAgICAgICAgICAgIGJvb2wgdW5zaGFyaW5nKTsKKwogLyoKICAqIElmIGNhbGxl
ZCBieSBhIGZvcmVpZ24gZG9tYWluLCBwb3NzaWJsZSBlcnJvcnMgYXJlCiAgKiAgIC1FQlVTWSAt
PiByaW5nIGZ1bGwKQEAgLTExNyw2ICsxMjMsNyBAQCBpbnQgcmVsaW5xdWlzaF9zaGFyZWRfcGFn
ZXMoc3RydWN0IGRvbWFpbiAqZCk7CiAjZWxzZQogCiAjZGVmaW5lIG1lbV9zaGFyaW5nX2VuYWJs
ZWQoZCkgZmFsc2UKKyNkZWZpbmUgbWVtX3NoYXJpbmdfaXNfZm9yayhwMm0pIGZhbHNlCiAKIHN0
YXRpYyBpbmxpbmUgdW5zaWduZWQgaW50IG1lbV9zaGFyaW5nX2dldF9ucl9zYXZlZF9tZm5zKHZv
aWQpCiB7CkBAIC0xNDEsNiArMTQ4LDE2IEBAIHN0YXRpYyBpbmxpbmUgaW50IG1lbV9zaGFyaW5n
X25vdGlmeV9lbm9tZW0oc3RydWN0IGRvbWFpbiAqZCwgdW5zaWduZWQgbG9uZyBnZm4sCiAgICAg
cmV0dXJuIC1FT1BOT1RTVVBQOwogfQogCitzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ19m
b3JrKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkLCBib29sIHZjcHUpCit7Cisg
ICAgcmV0dXJuIC1FT1BOT1RTVVBQOworfQorCitzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmlu
Z19mb3JrX3BhZ2Uoc3RydWN0IGRvbWFpbiAqZCwgZ2ZuX3QgZ2ZuLCBib29sIGxvY2spCit7Cisg
ICAgcmV0dXJuIC1FT1BOT1RTVVBQOworfQorCiAjZW5kaWYKIAogI2VuZGlmIC8qIF9fTUVNX1NI
QVJJTkdfSF9fICovCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS9wdWJsaWMvbWVtb3J5LmggYi94
ZW4vaW5jbHVkZS9wdWJsaWMvbWVtb3J5LmgKaW5kZXggMTI2ZDBmZjA2ZS4uMjQxMDZjNmMyZiAx
MDA2NDQKLS0tIGEveGVuL2luY2x1ZGUvcHVibGljL21lbW9yeS5oCisrKyBiL3hlbi9pbmNsdWRl
L3B1YmxpYy9tZW1vcnkuaApAQCAtNDgyLDYgKzQ4Miw3IEBAIERFRklORV9YRU5fR1VFU1RfSEFO
RExFKHhlbl9tZW1fYWNjZXNzX29wX3QpOwogI2RlZmluZSBYRU5NRU1fc2hhcmluZ19vcF9hZGRf
cGh5c21hcCAgICAgICA2CiAjZGVmaW5lIFhFTk1FTV9zaGFyaW5nX29wX2F1ZGl0ICAgICAgICAg
ICAgIDcKICNkZWZpbmUgWEVOTUVNX3NoYXJpbmdfb3BfcmFuZ2Vfc2hhcmUgICAgICAgOAorI2Rl
ZmluZSBYRU5NRU1fc2hhcmluZ19vcF9mb3JrICAgICAgICAgICAgICA5CiAKICNkZWZpbmUgWEVO
TUVNX1NIQVJJTkdfT1BfU19IQU5ETEVfSU5WQUxJRCAgKC0xMCkKICNkZWZpbmUgWEVOTUVNX1NI
QVJJTkdfT1BfQ19IQU5ETEVfSU5WQUxJRCAgKC05KQpAQCAtNTMyLDYgKzUzMywxMCBAQCBzdHJ1
Y3QgeGVuX21lbV9zaGFyaW5nX29wIHsKICAgICAgICAgICAgICAgICB1aW50MzJfdCBncmVmOyAg
ICAgLyogSU46IGdyZWYgdG8gZGVidWcgICAgICAgICAqLwogICAgICAgICAgICAgfSB1OwogICAg
ICAgICB9IGRlYnVnOworICAgICAgICBzdHJ1Y3QgbWVtX3NoYXJpbmdfb3BfZm9yayB7CisgICAg
ICAgICAgICBkb21pZF90IHBhcmVudF9kb21haW47CisgICAgICAgICAgICB1aW50MTZfdCBfcGFk
WzNdOyAgICAgICAgICAgICAgICAvKiBNdXN0IGJlIHNldCB0byAwICovCisgICAgICAgIH0gZm9y
azsKICAgICB9IHU7CiB9OwogdHlwZWRlZiBzdHJ1Y3QgeGVuX21lbV9zaGFyaW5nX29wIHhlbl9t
ZW1fc2hhcmluZ19vcF90OwpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmggYi94
ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaAppbmRleCAzYTRmNDMwOThjLi5kOThlOTk5ZmNjIDEwMDY0
NAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaAorKysgYi94ZW4vaW5jbHVkZS94ZW4vc2No
ZWQuaApAQCAtNTAzLDYgKzUwMyw4IEBAIHN0cnVjdCBkb21haW4KICAgICAvKiBNZW1vcnkgc2hh
cmluZyBzdXBwb3J0ICovCiAjaWZkZWYgQ09ORklHX01FTV9TSEFSSU5HCiAgICAgc3RydWN0IHZt
X2V2ZW50X2RvbWFpbiAqdm1fZXZlbnRfc2hhcmU7CisgICAgc3RydWN0IGRvbWFpbiAqcGFyZW50
OyAvKiBWTSBmb3JrIHBhcmVudCAqLworICAgIGJvb2wgcGFyZW50X3BhdXNlZDsKICNlbmRpZgog
ICAgIC8qIE1lbW9yeSBwYWdpbmcgc3VwcG9ydCAqLwogI2lmZGVmIENPTkZJR19IQVNfTUVNX1BB
R0lORwotLSAKMi4yMC4xCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVj
dC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1k
ZXZlbA==

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 3E8472C478
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:36:39 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZQP-0005Eq-I4; Tue, 28 May 2019 10:33:45 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZQA-0004kI-2p
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:33:30 +0000
X-Inumbo-ID: 070b75fc-8134-11e9-8980-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 070b75fc-8134-11e9-8980-bc764e045a96;
 Tue, 28 May 2019 10:33:27 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 7B8A8B03A;
 Tue, 28 May 2019 10:33:26 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:32:51 +0200
Message-Id: <20190528103313.1343-39-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 38/60] x86: make loading of GDT at context
 switch more modular
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Andrew Cooper <andrew.cooper3@citrix.com>,
 Wei Liu <wl@xen.org>, Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SW4gcHJlcGFyYXRpb24gZm9yIGNvcmUgc2NoZWR1bGluZyBjYXJ2ZSBvdXQgdGhlIEdEVCByZWxh
dGVkCmZ1bmN0aW9uYWxpdHkgKHdyaXRpbmcgR0RUIHJlbGF0ZWQgUFRFcywgbG9hZGluZyBkZWZh
dWx0IG9mIGZ1bGwgR0RUKQppbnRvIHN1Yi1mdW5jdGlvbnMuCgpTaWduZWQtb2ZmLWJ5OiBKdWVy
Z2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+CkFja2VkLWJ5OiBKYW4gQmV1bGljaCA8amJldWxp
Y2hAc3VzZS5jb20+Ci0tLQpSRkMgVjI6IHNwbGl0IG9mZiBub24tcmVmYWN0b3JpbmcgcGFydApW
MTogY29uc3RpZnkgcG9pbnRlcnMsIHVzZSBpbml0aWFsaXplcnMgKEphbiBCZXVsaWNoKQotLS0K
IHhlbi9hcmNoL3g4Ni9kb21haW4uYyB8IDU3ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KystLS0tLS0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDM1IGluc2VydGlvbnMoKyks
IDIyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9kb21haW4uYyBiL3hl
bi9hcmNoL3g4Ni9kb21haW4uYwppbmRleCBkM2VlNjk5ZGE2Li5hZGMwNjE1NGVlIDEwMDY0NAot
LS0gYS94ZW4vYXJjaC94ODYvZG9tYWluLmMKKysrIGIveGVuL2FyY2gveDg2L2RvbWFpbi5jCkBA
IC0xNjI2LDYgKzE2MjYsMzcgQEAgc3RhdGljIGlubGluZSBib29sIG5lZWRfZnVsbF9nZHQoY29u
c3Qgc3RydWN0IGRvbWFpbiAqZCkKICAgICByZXR1cm4gaXNfcHZfZG9tYWluKGQpICYmICFpc19p
ZGxlX2RvbWFpbihkKTsKIH0KIAorc3RhdGljIGlubGluZSB2b2lkIHdyaXRlX2Z1bGxfZ2R0X3B0
ZXMoc2VnX2Rlc2NfdCAqZ2R0LCBjb25zdCBzdHJ1Y3QgdmNwdSAqdikKK3sKKyAgICB1bnNpZ25l
ZCBsb25nIG1mbiA9IHZpcnRfdG9fbWZuKGdkdCk7CisgICAgbDFfcGdlbnRyeV90ICpwbDFlID0g
cHZfZ2R0X3B0ZXModik7CisgICAgdW5zaWduZWQgaW50IGk7CisKKyAgICBmb3IgKCBpID0gMDsg
aSA8IE5SX1JFU0VSVkVEX0dEVF9QQUdFUzsgaSsrICkKKyAgICAgICAgbDFlX3dyaXRlKHBsMWUg
KyBGSVJTVF9SRVNFUlZFRF9HRFRfUEFHRSArIGksCisgICAgICAgICAgICAgICAgICBsMWVfZnJv
bV9wZm4obWZuICsgaSwgX19QQUdFX0hZUEVSVklTT1JfUlcpKTsKK30KKworc3RhdGljIGlubGlu
ZSB2b2lkIGxvYWRfZnVsbF9nZHQoY29uc3Qgc3RydWN0IHZjcHUgKnYsIHVuc2lnbmVkIGludCBj
cHUpCit7CisgICAgc3RydWN0IGRlc2NfcHRyIGdkdF9kZXNjID0geworICAgICAgICAubGltaXQg
PSBMQVNUX1JFU0VSVkVEX0dEVF9CWVRFLAorICAgICAgICAuYmFzZSA9IEdEVF9WSVJUX1NUQVJU
KHYpLAorICAgIH07CisKKyAgICBsZ2R0KCZnZHRfZGVzYyk7Cit9CisKK3N0YXRpYyBpbmxpbmUg
dm9pZCBsb2FkX2RlZmF1bHRfZ2R0KGNvbnN0IHNlZ19kZXNjX3QgKmdkdCwgdW5zaWduZWQgaW50
IGNwdSkKK3sKKyAgICBzdHJ1Y3QgZGVzY19wdHIgZ2R0X2Rlc2MgPSB7CisgICAgICAgIC5saW1p
dCA9IExBU1RfUkVTRVJWRURfR0RUX0JZVEUsCisgICAgICAgIC5iYXNlICA9ICh1bnNpZ25lZCBs
b25nKShnZHQgLSBGSVJTVF9SRVNFUlZFRF9HRFRfRU5UUlkpLAorICAgIH07CisKKyAgICBsZ2R0
KCZnZHRfZGVzYyk7Cit9CisKIHN0YXRpYyB2b2lkIF9fY29udGV4dF9zd2l0Y2godm9pZCkKIHsK
ICAgICBzdHJ1Y3QgY3B1X3VzZXJfcmVncyAqc3RhY2tfcmVncyA9IGd1ZXN0X2NwdV91c2VyX3Jl
Z3MoKTsKQEAgLTE2MzQsNyArMTY2NSw2IEBAIHN0YXRpYyB2b2lkIF9fY29udGV4dF9zd2l0Y2go
dm9pZCkKICAgICBzdHJ1Y3QgdmNwdSAgICAgICAgICAqbiA9IGN1cnJlbnQ7CiAgICAgc3RydWN0
IGRvbWFpbiAgICAgICAgKnBkID0gcC0+ZG9tYWluLCAqbmQgPSBuLT5kb21haW47CiAgICAgc2Vn
X2Rlc2NfdCAgICAgICAgICAgKmdkdDsKLSAgICBzdHJ1Y3QgZGVzY19wdHIgICAgICAgZ2R0X2Rl
c2M7CiAKICAgICBBU1NFUlQocCAhPSBuKTsKICAgICBBU1NFUlQoIXZjcHVfY3B1X2RpcnR5KG4p
KTsKQEAgLTE2NzYsMjUgKzE3MDYsMTMgQEAgc3RhdGljIHZvaWQgX19jb250ZXh0X3N3aXRjaCh2
b2lkKQogCiAgICAgZ2R0ID0gIWlzX3B2XzMyYml0X2RvbWFpbihuZCkgPyBwZXJfY3B1KGdkdF90
YWJsZSwgY3B1KSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJfY3B1
KGNvbXBhdF9nZHRfdGFibGUsIGNwdSk7Ci0gICAgaWYgKCBuZWVkX2Z1bGxfZ2R0KG5kKSApCi0g
ICAgewotICAgICAgICB1bnNpZ25lZCBsb25nIG1mbiA9IHZpcnRfdG9fbWZuKGdkdCk7Ci0gICAg
ICAgIGwxX3BnZW50cnlfdCAqcGwxZSA9IHB2X2dkdF9wdGVzKG4pOwotICAgICAgICB1bnNpZ25l
ZCBpbnQgaTsKIAotICAgICAgICBmb3IgKCBpID0gMDsgaSA8IE5SX1JFU0VSVkVEX0dEVF9QQUdF
UzsgaSsrICkKLSAgICAgICAgICAgIGwxZV93cml0ZShwbDFlICsgRklSU1RfUkVTRVJWRURfR0RU
X1BBR0UgKyBpLAotICAgICAgICAgICAgICAgICAgICAgIGwxZV9mcm9tX3BmbihtZm4gKyBpLCBf
X1BBR0VfSFlQRVJWSVNPUl9SVykpOwotICAgIH0KKyAgICBpZiAoIG5lZWRfZnVsbF9nZHQobmQp
ICkKKyAgICAgICAgd3JpdGVfZnVsbF9nZHRfcHRlcyhnZHQsIG4pOwogCiAgICAgaWYgKCBuZWVk
X2Z1bGxfZ2R0KHBkKSAmJgogICAgICAgICAgKChwLT52Y3B1X2lkICE9IG4tPnZjcHVfaWQpIHx8
ICFuZWVkX2Z1bGxfZ2R0KG5kKSkgKQotICAgIHsKLSAgICAgICAgZ2R0X2Rlc2MubGltaXQgPSBM
QVNUX1JFU0VSVkVEX0dEVF9CWVRFOwotICAgICAgICBnZHRfZGVzYy5iYXNlICA9ICh1bnNpZ25l
ZCBsb25nKShnZHQgLSBGSVJTVF9SRVNFUlZFRF9HRFRfRU5UUlkpOwotCi0gICAgICAgIGxnZHQo
JmdkdF9kZXNjKTsKLSAgICB9CisgICAgICAgIGxvYWRfZGVmYXVsdF9nZHQoZ2R0LCBjcHUpOwog
CiAgICAgd3JpdGVfcHRiYXNlKG4pOwogCkBAIC0xNzA3LDEyICsxNzI1LDcgQEAgc3RhdGljIHZv
aWQgX19jb250ZXh0X3N3aXRjaCh2b2lkKQogCiAgICAgaWYgKCBuZWVkX2Z1bGxfZ2R0KG5kKSAm
JgogICAgICAgICAgKChwLT52Y3B1X2lkICE9IG4tPnZjcHVfaWQpIHx8ICFuZWVkX2Z1bGxfZ2R0
KHBkKSkgKQotICAgIHsKLSAgICAgICAgZ2R0X2Rlc2MubGltaXQgPSBMQVNUX1JFU0VSVkVEX0dE
VF9CWVRFOwotICAgICAgICBnZHRfZGVzYy5iYXNlID0gR0RUX1ZJUlRfU1RBUlQobik7Ci0KLSAg
ICAgICAgbGdkdCgmZ2R0X2Rlc2MpOwotICAgIH0KKyAgICAgICAgbG9hZF9mdWxsX2dkdChuLCBj
cHUpOwogCiAgICAgaWYgKCBwZCAhPSBuZCApCiAgICAgICAgIGNwdW1hc2tfY2xlYXJfY3B1KGNw
dSwgcGQtPmRpcnR5X2NwdW1hc2spOwotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2
ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWls
bWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

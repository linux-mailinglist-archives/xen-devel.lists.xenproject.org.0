Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 6D3B6125227
	for <lists+xen-devel@lfdr.de>; Wed, 18 Dec 2019 20:45:33 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ihfDU-0000IC-Fw; Wed, 18 Dec 2019 19:42:40 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=wZRn=2I=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1ihfDS-0000Ge-8u
 for xen-devel@lists.xenproject.org; Wed, 18 Dec 2019 19:42:38 +0000
X-Inumbo-ID: 651b6b6b-21ce-11ea-90f3-12813bfff9fa
Received: from mga04.intel.com (unknown [192.55.52.120])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 651b6b6b-21ce-11ea-90f3-12813bfff9fa;
 Wed, 18 Dec 2019 19:41:34 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga008.jf.intel.com ([10.7.209.65])
 by fmsmga104.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 18 Dec 2019 11:41:33 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,330,1571727600"; d="scan'208";a="210196437"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.254.103.7])
 by orsmga008.jf.intel.com with ESMTP; 18 Dec 2019 11:41:31 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Wed, 18 Dec 2019 11:40:57 -0800
Message-Id: <122128bd25e184d310a0a8af0f3c1e1c272d2fe1.1576697796.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1576697796.git.tamas.lengyel@intel.com>
References: <cover.1576697796.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2 20/20] xen/tools: VM forking toolstack side
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QWRkIG5lY2Vzc2FyeSBiaXRzIHRvIGltcGxlbWVudCAieGwgZm9yay12bSIsICJ4bCBmb3JrLWxh
dW5jaC1kbSIgYW5kCiJ4bCBmb3JrLXJlc2V0IiBjb21tYW5kcy4gVGhlIHByb2Nlc3MgaXMgc3Bs
aXQgaW4gdHdvIHRvIGFsbG93IHRvb2xzIG5lZWRpbmcKYWNjZXNzIHRvIHRoZSBuZXcgVk0gYXMg
ZmFzdCBhcyBwb3NzaWJsZSBhZnRlciBpdCB3YXMgZm9ya2VkLiBJdCBpcyBleHBlY3RlZAp0aGF0
IHVuZGVyIGNlcnRhaW4gdXNlLWNhc2VzIHRoZSBzZWNvbmQgY29tbWFuZCB0aGF0IGxhdW5jaGVz
IFFFTVUgd2lsbCBiZQpza2lwcGVkIGVudGlyZWx5LgoKU2lnbmVkLW9mZi1ieTogVGFtYXMgSyBM
ZW5neWVsIDx0YW1hcy5sZW5neWVsQGludGVsLmNvbT4KLS0tCiB0b29scy9saWJ4Yy9pbmNsdWRl
L3hlbmN0cmwuaCB8ICAgNiArCiB0b29scy9saWJ4Yy94Y19tZW1zaHIuYyAgICAgICB8ICAyMiAr
KysrCiB0b29scy9saWJ4bC9saWJ4bC5oICAgICAgICAgICB8ICAgNyArCiB0b29scy9saWJ4bC9s
aWJ4bF9jcmVhdGUuYyAgICB8IDIzNyArKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0t
CiB0b29scy9saWJ4bC9saWJ4bF9kbS5jICAgICAgICB8ICAgMiArLQogdG9vbHMvbGlieGwvbGli
eGxfZG9tLmMgICAgICAgfCAgODMgKysrKysrKystLS0tCiB0b29scy9saWJ4bC9saWJ4bF9pbnRl
cm5hbC5oICB8ICAgMSArCiB0b29scy9saWJ4bC9saWJ4bF90eXBlcy5pZGwgICB8ICAgMSArCiB0
b29scy94bC94bC5oICAgICAgICAgICAgICAgICB8ICAgNSArCiB0b29scy94bC94bF9jbWR0YWJs
ZS5jICAgICAgICB8ICAyMiArKysrCiB0b29scy94bC94bF9zYXZlcmVzdG9yZS5jICAgICB8ICA5
NiArKysrKysrKysrKysrKwogdG9vbHMveGwveGxfdm1jb250cm9sLmMgICAgICAgfCAgIDggKysK
IDEyIGZpbGVzIGNoYW5nZWQsIDM4NiBpbnNlcnRpb25zKCspLCAxMDQgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvdG9vbHMvbGlieGMvaW5jbHVkZS94ZW5jdHJsLmggYi90b29scy9saWJ4Yy9p
bmNsdWRlL3hlbmN0cmwuaAppbmRleCBiNWZmYTUzZDU1Li4zOWFmZGI5YjMzIDEwMDY0NAotLS0g
YS90b29scy9saWJ4Yy9pbmNsdWRlL3hlbmN0cmwuaAorKysgYi90b29scy9saWJ4Yy9pbmNsdWRl
L3hlbmN0cmwuaApAQCAtMjIyMSw2ICsyMjIxLDEyIEBAIGludCB4Y19tZW1zaHJfcmFuZ2Vfc2hh
cmUoeGNfaW50ZXJmYWNlICp4Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ2NF90
IGZpcnN0X2dmbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDY0X3QgbGFzdF9nZm4p
OwogCitpbnQgeGNfbWVtc2hyX2ZvcmsoeGNfaW50ZXJmYWNlICp4Y2gsCisgICAgICAgICAgICAg
ICAgICAgdWludDMyX3Qgc291cmNlX2RvbWFpbiwKKyAgICAgICAgICAgICAgICAgICB1aW50MzJf
dCBjbGllbnRfZG9tYWluKTsKKworaW50IHhjX21lbXNocl9mb3JrX3Jlc2V0KHhjX2ludGVyZmFj
ZSAqeGNoLCB1aW50MzJfdCBmb3JrZWRfZG9tYWluKTsKKwogLyogRGVidWcgY2FsbHM6IHJldHVy
biB0aGUgbnVtYmVyIG9mIHBhZ2VzIHJlZmVyZW5jaW5nIHRoZSBzaGFyZWQgZnJhbWUgYmFja2lu
ZwogICogdGhlIGlucHV0IGFyZ3VtZW50LiBTaG91bGQgYmUgb25lIG9yIGdyZWF0ZXIuCiAgKgpk
aWZmIC0tZ2l0IGEvdG9vbHMvbGlieGMveGNfbWVtc2hyLmMgYi90b29scy9saWJ4Yy94Y19tZW1z
aHIuYwppbmRleCA1ZWY1NmE2OTMzLi5lZjVhNWVlNmE0IDEwMDY0NAotLS0gYS90b29scy9saWJ4
Yy94Y19tZW1zaHIuYworKysgYi90b29scy9saWJ4Yy94Y19tZW1zaHIuYwpAQCAtMjM3LDYgKzIz
NywyOCBAQCBpbnQgeGNfbWVtc2hyX2RlYnVnX2dyZWYoeGNfaW50ZXJmYWNlICp4Y2gsCiAgICAg
cmV0dXJuIHhjX21lbXNocl9tZW1vcCh4Y2gsIGRvbWlkLCAmbXNvKTsKIH0KIAoraW50IHhjX21l
bXNocl9mb3JrKHhjX2ludGVyZmFjZSAqeGNoLCB1aW50MzJfdCBwZG9taWQsIHVpbnQzMl90IGRv
bWlkKQoreworICAgIHhlbl9tZW1fc2hhcmluZ19vcF90IG1zbzsKKworICAgIG1lbXNldCgmbXNv
LCAwLCBzaXplb2YobXNvKSk7CisKKyAgICBtc28ub3AgPSBYRU5NRU1fc2hhcmluZ19vcF9mb3Jr
OworICAgIG1zby51LmZvcmsucGFyZW50X2RvbWFpbiA9IHBkb21pZDsKKworICAgIHJldHVybiB4
Y19tZW1zaHJfbWVtb3AoeGNoLCBkb21pZCwgJm1zbyk7Cit9CisKK2ludCB4Y19tZW1zaHJfZm9y
a19yZXNldCh4Y19pbnRlcmZhY2UgKnhjaCwgdWludDMyX3QgZG9taWQpCit7CisgICAgeGVuX21l
bV9zaGFyaW5nX29wX3QgbXNvOworCisgICAgbWVtc2V0KCZtc28sIDAsIHNpemVvZihtc28pKTsK
KyAgICBtc28ub3AgPSBYRU5NRU1fc2hhcmluZ19vcF9mb3JrX3Jlc2V0OworCisgICAgcmV0dXJu
IHhjX21lbXNocl9tZW1vcCh4Y2gsIGRvbWlkLCAmbXNvKTsKK30KKwogaW50IHhjX21lbXNocl9h
dWRpdCh4Y19pbnRlcmZhY2UgKnhjaCkKIHsKICAgICB4ZW5fbWVtX3NoYXJpbmdfb3BfdCBtc287
CmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bC5oIGIvdG9vbHMvbGlieGwvbGlieGwuaApp
bmRleCA1NGFiYjlkYjFmLi43NWNiMDcwNTg3IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4
bC5oCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsLmgKQEAgLTE1MzYsNiArMTUzNiwxMyBAQCBpbnQg
bGlieGxfZG9tYWluX2NyZWF0ZV9uZXcobGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25m
aWcgKmRfY29uZmlnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpYnhsX2Fz
eW5jb3BfaG93ICphb19ob3csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGli
eGxfYXN5bmNwcm9ncmVzc19ob3cgKmFvcF9jb25zb2xlX2hvdykKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBMSUJYTF9FWFRFUk5BTF9DQUxMRVJTX09OTFk7CitpbnQgbGlieGxfZG9tYWlu
X2Zvcmtfdm0obGlieGxfY3R4ICpjdHgsIHVpbnQzMl90IHBkb21pZCwgdWludDMyX3QgKmRvbWlk
KQorICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMSUJYTF9FWFRFUk5BTF9DQUxMRVJTX09O
TFk7CitpbnQgbGlieGxfZG9tYWluX2ZvcmtfbGF1bmNoX2RtKGxpYnhsX2N0eCAqY3R4LCBsaWJ4
bF9kb21haW5fY29uZmlnICpkX2NvbmZpZywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgdWludDMyX3QgZG9taWQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0
IGxpYnhsX2FzeW5jcHJvZ3Jlc3NfaG93ICphb3BfY29uc29sZV9ob3cpCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIExJQlhMX0VYVEVSTkFMX0NBTExFUlNfT05MWTsKK2ludCBsaWJ4
bF9kb21haW5fZm9ya19yZXNldChsaWJ4bF9jdHggKmN0eCwgdWludDMyX3QgZG9taWQpOwogaW50
IGxpYnhsX2RvbWFpbl9jcmVhdGVfcmVzdG9yZShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9tYWlu
X2NvbmZpZyAqZF9jb25maWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQz
Ml90ICpkb21pZCwgaW50IHJlc3RvcmVfZmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGludCBzZW5kX2JhY2tfZmQsCmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9jcmVh
dGUuYyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2NyZWF0ZS5jCmluZGV4IDMyZDQ1ZGNlZjAuLmUwZDIx
OTU5NmMgMTAwNjQ0Ci0tLSBhL3Rvb2xzL2xpYnhsL2xpYnhsX2NyZWF0ZS5jCisrKyBiL3Rvb2xz
L2xpYnhsL2xpYnhsX2NyZWF0ZS5jCkBAIC01MzYsMTIgKzUzNiwxMiBAQCBvdXQ6CiAgICAgcmV0
dXJuIHJldDsKIH0KIAotaW50IGxpYnhsX19kb21haW5fbWFrZShsaWJ4bF9fZ2MgKmdjLCBsaWJ4
bF9kb21haW5fY29uZmlnICpkX2NvbmZpZywKLSAgICAgICAgICAgICAgICAgICAgICAgbGlieGxf
X2RvbWFpbl9idWlsZF9zdGF0ZSAqc3RhdGUsCi0gICAgICAgICAgICAgICAgICAgICAgIHVpbnQz
Ml90ICpkb21pZCkKK3N0YXRpYyBpbnQgbGlieGxfX2RvbWFpbl9tYWtlX3hzX2VudHJpZXMobGli
eGxfX2djICpnYywgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpYnhsX19kb21haW5fYnVpbGRfc3RhdGUgKnN0
YXRlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50MzJfdCBk
b21pZCkKIHsKICAgICBsaWJ4bF9jdHggKmN0eCA9IGxpYnhsX19nY19vd25lcihnYyk7Ci0gICAg
aW50IHJldCwgcmMsIG5iX3ZtOworICAgIGludCByYywgbmJfdm07CiAgICAgY29uc3QgY2hhciAq
ZG9tX3R5cGU7CiAgICAgY2hhciAqdXVpZF9zdHJpbmc7CiAgICAgY2hhciAqZG9tX3BhdGgsICp2
bV9wYXRoLCAqbGlieGxfcGF0aDsKQEAgLTU1Myw3ICs1NTMsNiBAQCBpbnQgbGlieGxfX2RvbWFp
bl9tYWtlKGxpYnhsX19nYyAqZ2MsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogCiAg
ICAgLyogY29udmVuaWVuY2UgYWxpYXNlcyAqLwogICAgIGxpYnhsX2RvbWFpbl9jcmVhdGVfaW5m
byAqaW5mbyA9ICZkX2NvbmZpZy0+Y19pbmZvOwotICAgIGxpYnhsX2RvbWFpbl9idWlsZF9pbmZv
ICpiX2luZm8gPSAmZF9jb25maWctPmJfaW5mbzsKIAogICAgIHV1aWRfc3RyaW5nID0gbGlieGxf
X3V1aWQyc3RyaW5nKGdjLCBpbmZvLT51dWlkKTsKICAgICBpZiAoIXV1aWRfc3RyaW5nKSB7CkBA
IC01NjEsNjQgKzU2MCw3IEBAIGludCBsaWJ4bF9fZG9tYWluX21ha2UobGlieGxfX2djICpnYywg
bGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcsCiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0K
IAotICAgIC8qIFZhbGlkIGRvbWlkIGhlcmUgbWVhbnMgd2UncmUgc29mdCByZXNldHRpbmcuICov
Ci0gICAgaWYgKCFsaWJ4bF9kb21pZF92YWxpZF9ndWVzdCgqZG9taWQpKSB7Ci0gICAgICAgIHN0
cnVjdCB4ZW5fZG9tY3RsX2NyZWF0ZWRvbWFpbiBjcmVhdGUgPSB7Ci0gICAgICAgICAgICAuc3Np
ZHJlZiA9IGluZm8tPnNzaWRyZWYsCi0gICAgICAgICAgICAubWF4X3ZjcHVzID0gYl9pbmZvLT5t
YXhfdmNwdXMsCi0gICAgICAgICAgICAubWF4X2V2dGNobl9wb3J0ID0gYl9pbmZvLT5ldmVudF9j
aGFubmVscywKLSAgICAgICAgICAgIC5tYXhfZ3JhbnRfZnJhbWVzID0gYl9pbmZvLT5tYXhfZ3Jh
bnRfZnJhbWVzLAotICAgICAgICAgICAgLm1heF9tYXB0cmFja19mcmFtZXMgPSBiX2luZm8tPm1h
eF9tYXB0cmFja19mcmFtZXMsCi0gICAgICAgIH07Ci0KLSAgICAgICAgaWYgKGluZm8tPnR5cGUg
IT0gTElCWExfRE9NQUlOX1RZUEVfUFYpIHsKLSAgICAgICAgICAgIGNyZWF0ZS5mbGFncyB8PSBY
RU5fRE9NQ1RMX0NERl9odm07Ci0gICAgICAgICAgICBjcmVhdGUuZmxhZ3MgfD0KLSAgICAgICAg
ICAgICAgICBsaWJ4bF9kZWZib29sX3ZhbChpbmZvLT5oYXApID8gWEVOX0RPTUNUTF9DREZfaGFw
IDogMDsKLSAgICAgICAgICAgIGNyZWF0ZS5mbGFncyB8PQotICAgICAgICAgICAgICAgIGxpYnhs
X2RlZmJvb2xfdmFsKGluZm8tPm9vcykgPyAwIDogWEVOX0RPTUNUTF9DREZfb29zX29mZjsKLSAg
ICAgICAgfQotCi0gICAgICAgIGFzc2VydChpbmZvLT5wYXNzdGhyb3VnaCAhPSBMSUJYTF9QQVNT
VEhST1VHSF9ERUZBVUxUKTsKLSAgICAgICAgTE9HKERFVEFJTCwgInBhc3N0aHJvdWdoOiAlcyIs
Ci0gICAgICAgICAgICBsaWJ4bF9wYXNzdGhyb3VnaF90b19zdHJpbmcoaW5mby0+cGFzc3Rocm91
Z2gpKTsKLQotICAgICAgICBpZiAoaW5mby0+cGFzc3Rocm91Z2ggIT0gTElCWExfUEFTU1RIUk9V
R0hfRElTQUJMRUQpCi0gICAgICAgICAgICBjcmVhdGUuZmxhZ3MgfD0gWEVOX0RPTUNUTF9DREZf
aW9tbXU7Ci0KLSAgICAgICAgaWYgKGluZm8tPnBhc3N0aHJvdWdoID09IExJQlhMX1BBU1NUSFJP
VUdIX1NZTkNfUFQpCi0gICAgICAgICAgICBjcmVhdGUuaW9tbXVfb3B0cyB8PSBYRU5fRE9NQ1RM
X0lPTU1VX25vX3NoYXJlcHQ7Ci0KLSAgICAgICAgLyogVWx0aW1hdGVseSwgaGFuZGxlIGlzIGFu
IGFycmF5IG9mIDE2IHVpbnQ4X3QsIHNhbWUgYXMgdXVpZCAqLwotICAgICAgICBsaWJ4bF91dWlk
X2NvcHkoY3R4LCAobGlieGxfdXVpZCAqKSZjcmVhdGUuaGFuZGxlLCAmaW5mby0+dXVpZCk7Ci0K
LSAgICAgICAgcmV0ID0gbGlieGxfX2FyY2hfZG9tYWluX3ByZXBhcmVfY29uZmlnKGdjLCBkX2Nv
bmZpZywgJmNyZWF0ZSk7Ci0gICAgICAgIGlmIChyZXQgPCAwKSB7Ci0gICAgICAgICAgICBMT0dF
RChFUlJPUiwgKmRvbWlkLCAiZmFpbCB0byBnZXQgZG9tYWluIGNvbmZpZyIpOwotICAgICAgICAg
ICAgcmMgPSBFUlJPUl9GQUlMOwotICAgICAgICAgICAgZ290byBvdXQ7Ci0gICAgICAgIH0KLQot
ICAgICAgICByZXQgPSB4Y19kb21haW5fY3JlYXRlKGN0eC0+eGNoLCBkb21pZCwgJmNyZWF0ZSk7
Ci0gICAgICAgIGlmIChyZXQgPCAwKSB7Ci0gICAgICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlk
LCAiZG9tYWluIGNyZWF0aW9uIGZhaWwiKTsKLSAgICAgICAgICAgIHJjID0gRVJST1JfRkFJTDsK
LSAgICAgICAgICAgIGdvdG8gb3V0OwotICAgICAgICB9Ci0KLSAgICAgICAgcmMgPSBsaWJ4bF9f
YXJjaF9kb21haW5fc2F2ZV9jb25maWcoZ2MsIGRfY29uZmlnLCBzdGF0ZSwgJmNyZWF0ZSk7Ci0g
ICAgICAgIGlmIChyYyA8IDApCi0gICAgICAgICAgICBnb3RvIG91dDsKLSAgICB9Ci0KLSAgICBy
ZXQgPSB4Y19jcHVwb29sX21vdmVkb21haW4oY3R4LT54Y2gsIGluZm8tPnBvb2xpZCwgKmRvbWlk
KTsKLSAgICBpZiAocmV0IDwgMCkgewotICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlkLCAiZG9t
YWluIG1vdmUgZmFpbCIpOwotICAgICAgICByYyA9IEVSUk9SX0ZBSUw7Ci0gICAgICAgIGdvdG8g
b3V0OwotICAgIH0KLQotICAgIGRvbV9wYXRoID0gbGlieGxfX3hzX2dldF9kb21wYXRoKGdjLCAq
ZG9taWQpOworICAgIGRvbV9wYXRoID0gbGlieGxfX3hzX2dldF9kb21wYXRoKGdjLCBkb21pZCk7
CiAgICAgaWYgKCFkb21fcGF0aCkgewogICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CiAgICAgICAg
IGdvdG8gb3V0OwpAQCAtNjI2LDEyICs1NjgsMTIgQEAgaW50IGxpYnhsX19kb21haW5fbWFrZShs
aWJ4bF9fZ2MgKmdjLCBsaWJ4bF9kb21haW5fY29uZmlnICpkX2NvbmZpZywKIAogICAgIHZtX3Bh
dGggPSBHQ1NQUklOVEYoIi92bS8lcyIsIHV1aWRfc3RyaW5nKTsKICAgICBpZiAoIXZtX3BhdGgp
IHsKLSAgICAgICAgTE9HRChFUlJPUiwgKmRvbWlkLCAiY2Fubm90IGFsbG9jYXRlIGNyZWF0ZSBw
YXRocyIpOworICAgICAgICBMT0dEKEVSUk9SLCBkb21pZCwgImNhbm5vdCBhbGxvY2F0ZSBjcmVh
dGUgcGF0aHMiKTsKICAgICAgICAgcmMgPSBFUlJPUl9GQUlMOwogICAgICAgICBnb3RvIG91dDsK
ICAgICB9CiAKLSAgICBsaWJ4bF9wYXRoID0gbGlieGxfX3hzX2xpYnhsX3BhdGgoZ2MsICpkb21p
ZCk7CisgICAgbGlieGxfcGF0aCA9IGxpYnhsX194c19saWJ4bF9wYXRoKGdjLCBkb21pZCk7CiAg
ICAgaWYgKCFsaWJ4bF9wYXRoKSB7CiAgICAgICAgIHJjID0gRVJST1JfRkFJTDsKICAgICAgICAg
Z290byBvdXQ7CkBAIC02NDIsMTAgKzU4NCwxMCBAQCBpbnQgbGlieGxfX2RvbWFpbl9tYWtlKGxp
YnhsX19nYyAqZ2MsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogCiAgICAgcm9wZXJt
WzBdLmlkID0gMDsKICAgICByb3Blcm1bMF0ucGVybXMgPSBYU19QRVJNX05PTkU7Ci0gICAgcm9w
ZXJtWzFdLmlkID0gKmRvbWlkOworICAgIHJvcGVybVsxXS5pZCA9IGRvbWlkOwogICAgIHJvcGVy
bVsxXS5wZXJtcyA9IFhTX1BFUk1fUkVBRDsKIAotICAgIHJ3cGVybVswXS5pZCA9ICpkb21pZDsK
KyAgICByd3Blcm1bMF0uaWQgPSBkb21pZDsKICAgICByd3Blcm1bMF0ucGVybXMgPSBYU19QRVJN
X05PTkU7CiAKIHJldHJ5X3RyYW5zYWN0aW9uOgpAQCAtNjYzLDcgKzYwNSw3IEBAIHJldHJ5X3Ry
YW5zYWN0aW9uOgogICAgICAgICAgICAgICAgICAgICBub3Blcm0sIEFSUkFZX1NJWkUobm9wZXJt
KSk7CiAKICAgICB4c193cml0ZShjdHgtPnhzaCwgdCwgR0NTUFJJTlRGKCIlcy92bSIsIGRvbV9w
YXRoKSwgdm1fcGF0aCwgc3RybGVuKHZtX3BhdGgpKTsKLSAgICByYyA9IGxpYnhsX19kb21haW5f
cmVuYW1lKGdjLCAqZG9taWQsIDAsIGluZm8tPm5hbWUsIHQpOworICAgIHJjID0gbGlieGxfX2Rv
bWFpbl9yZW5hbWUoZ2MsIGRvbWlkLCAwLCBpbmZvLT5uYW1lLCB0KTsKICAgICBpZiAocmMpCiAg
ICAgICAgIGdvdG8gb3V0OwogCkBAIC03NDAsNyArNjgyLDcgQEAgcmV0cnlfdHJhbnNhY3Rpb246
CiAKICAgICB2bV9saXN0ID0gbGlieGxfbGlzdF92bShjdHgsICZuYl92bSk7CiAgICAgaWYgKCF2
bV9saXN0KSB7Ci0gICAgICAgIExPR0QoRVJST1IsICpkb21pZCwgImNhbm5vdCBnZXQgbnVtYmVy
IG9mIHJ1bm5pbmcgZ3Vlc3RzIik7CisgICAgICAgIExPR0QoRVJST1IsIGRvbWlkLCAiY2Fubm90
IGdldCBudW1iZXIgb2YgcnVubmluZyBndWVzdHMiKTsKICAgICAgICAgcmMgPSBFUlJPUl9GQUlM
OwogICAgICAgICBnb3RvIG91dDsKICAgICB9CkBAIC03NjQsNyArNzA2LDcgQEAgcmV0cnlfdHJh
bnNhY3Rpb246CiAgICAgICAgICAgICB0ID0gMDsKICAgICAgICAgICAgIGdvdG8gcmV0cnlfdHJh
bnNhY3Rpb247CiAgICAgICAgIH0KLSAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImRvbWFp
biBjcmVhdGlvbiAiInhlbnN0b3JlIHRyYW5zYWN0aW9uIGNvbW1pdCBmYWlsZWQiKTsKKyAgICAg
ICAgTE9HRUQoRVJST1IsIGRvbWlkLCAiZG9tYWluIGNyZWF0aW9uICIieGVuc3RvcmUgdHJhbnNh
Y3Rpb24gY29tbWl0IGZhaWxlZCIpOwogICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CiAgICAgICAg
IGdvdG8gb3V0OwogICAgIH0KQEAgLTc3Niw2ICs3MTgsODAgQEAgcmV0cnlfdHJhbnNhY3Rpb246
CiAgICAgcmV0dXJuIHJjOwogfQogCitpbnQgbGlieGxfX2RvbWFpbl9tYWtlKGxpYnhsX19nYyAq
Z2MsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAorICAgICAgICAgICAgICAgICAgICAg
ICBsaWJ4bF9fZG9tYWluX2J1aWxkX3N0YXRlICpzdGF0ZSwKKyAgICAgICAgICAgICAgICAgICAg
ICAgdWludDMyX3QgKmRvbWlkKQoreworICAgIGxpYnhsX2N0eCAqY3R4ID0gbGlieGxfX2djX293
bmVyKGdjKTsKKyAgICBpbnQgcmV0LCByYzsKKworICAgIC8qIGNvbnZlbmllbmNlIGFsaWFzZXMg
Ki8KKyAgICBsaWJ4bF9kb21haW5fY3JlYXRlX2luZm8gKmluZm8gPSAmZF9jb25maWctPmNfaW5m
bzsKKyAgICBsaWJ4bF9kb21haW5fYnVpbGRfaW5mbyAqYl9pbmZvID0gJmRfY29uZmlnLT5iX2lu
Zm87CisKKyAgICAvKiBWYWxpZCBkb21pZCBoZXJlIG1lYW5zIHdlJ3JlIHNvZnQgcmVzZXR0aW5n
LiAqLworICAgIGlmICghbGlieGxfZG9taWRfdmFsaWRfZ3Vlc3QoKmRvbWlkKSkgeworICAgICAg
ICBzdHJ1Y3QgeGVuX2RvbWN0bF9jcmVhdGVkb21haW4gY3JlYXRlID0geworICAgICAgICAgICAg
LnNzaWRyZWYgPSBpbmZvLT5zc2lkcmVmLAorICAgICAgICAgICAgLm1heF92Y3B1cyA9IGJfaW5m
by0+bWF4X3ZjcHVzLAorICAgICAgICAgICAgLm1heF9ldnRjaG5fcG9ydCA9IGJfaW5mby0+ZXZl
bnRfY2hhbm5lbHMsCisgICAgICAgICAgICAubWF4X2dyYW50X2ZyYW1lcyA9IGJfaW5mby0+bWF4
X2dyYW50X2ZyYW1lcywKKyAgICAgICAgICAgIC5tYXhfbWFwdHJhY2tfZnJhbWVzID0gYl9pbmZv
LT5tYXhfbWFwdHJhY2tfZnJhbWVzLAorICAgICAgICB9OworCisgICAgICAgIGlmIChpbmZvLT50
eXBlICE9IExJQlhMX0RPTUFJTl9UWVBFX1BWKSB7CisgICAgICAgICAgICBjcmVhdGUuZmxhZ3Mg
fD0gWEVOX0RPTUNUTF9DREZfaHZtOworICAgICAgICAgICAgY3JlYXRlLmZsYWdzIHw9CisgICAg
ICAgICAgICAgICAgbGlieGxfZGVmYm9vbF92YWwoaW5mby0+aGFwKSA/IFhFTl9ET01DVExfQ0RG
X2hhcCA6IDA7CisgICAgICAgICAgICBjcmVhdGUuZmxhZ3MgfD0KKyAgICAgICAgICAgICAgICBs
aWJ4bF9kZWZib29sX3ZhbChpbmZvLT5vb3MpID8gMCA6IFhFTl9ET01DVExfQ0RGX29vc19vZmY7
CisgICAgICAgIH0KKworICAgICAgICBhc3NlcnQoaW5mby0+cGFzc3Rocm91Z2ggIT0gTElCWExf
UEFTU1RIUk9VR0hfREVGQVVMVCk7CisgICAgICAgIExPRyhERVRBSUwsICJwYXNzdGhyb3VnaDog
JXMiLAorICAgICAgICAgICAgbGlieGxfcGFzc3Rocm91Z2hfdG9fc3RyaW5nKGluZm8tPnBhc3N0
aHJvdWdoKSk7CisKKyAgICAgICAgaWYgKGluZm8tPnBhc3N0aHJvdWdoICE9IExJQlhMX1BBU1NU
SFJPVUdIX0RJU0FCTEVEKQorICAgICAgICAgICAgY3JlYXRlLmZsYWdzIHw9IFhFTl9ET01DVExf
Q0RGX2lvbW11OworCisgICAgICAgIGlmIChpbmZvLT5wYXNzdGhyb3VnaCA9PSBMSUJYTF9QQVNT
VEhST1VHSF9TWU5DX1BUKQorICAgICAgICAgICAgY3JlYXRlLmlvbW11X29wdHMgfD0gWEVOX0RP
TUNUTF9JT01NVV9ub19zaGFyZXB0OworCisgICAgICAgIC8qIFVsdGltYXRlbHksIGhhbmRsZSBp
cyBhbiBhcnJheSBvZiAxNiB1aW50OF90LCBzYW1lIGFzIHV1aWQgKi8KKyAgICAgICAgbGlieGxf
dXVpZF9jb3B5KGN0eCwgKGxpYnhsX3V1aWQgKikmY3JlYXRlLmhhbmRsZSwgJmluZm8tPnV1aWQp
OworCisgICAgICAgIHJldCA9IGxpYnhsX19hcmNoX2RvbWFpbl9wcmVwYXJlX2NvbmZpZyhnYywg
ZF9jb25maWcsICZjcmVhdGUpOworICAgICAgICBpZiAocmV0IDwgMCkgeworICAgICAgICAgICAg
TE9HRUQoRVJST1IsICpkb21pZCwgImZhaWwgdG8gZ2V0IGRvbWFpbiBjb25maWciKTsKKyAgICAg
ICAgICAgIHJjID0gRVJST1JfRkFJTDsKKyAgICAgICAgICAgIGdvdG8gb3V0OworICAgICAgICB9
CisKKyAgICAgICAgcmV0ID0geGNfZG9tYWluX2NyZWF0ZShjdHgtPnhjaCwgZG9taWQsICZjcmVh
dGUpOworICAgICAgICBpZiAocmV0IDwgMCkgeworICAgICAgICAgICAgTE9HRUQoRVJST1IsICpk
b21pZCwgImRvbWFpbiBjcmVhdGlvbiBmYWlsIik7CisgICAgICAgICAgICByYyA9IEVSUk9SX0ZB
SUw7CisgICAgICAgICAgICBnb3RvIG91dDsKKyAgICAgICAgfQorCisgICAgICAgIHJjID0gbGli
eGxfX2FyY2hfZG9tYWluX3NhdmVfY29uZmlnKGdjLCBkX2NvbmZpZywgc3RhdGUsICZjcmVhdGUp
OworICAgICAgICBpZiAocmMgPCAwKQorICAgICAgICAgICAgZ290byBvdXQ7CisgICAgfQorCisg
ICAgcmV0ID0geGNfY3B1cG9vbF9tb3ZlZG9tYWluKGN0eC0+eGNoLCBpbmZvLT5wb29saWQsICpk
b21pZCk7CisgICAgaWYgKHJldCA8IDApIHsKKyAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwg
ImRvbWFpbiBtb3ZlIGZhaWwiKTsKKyAgICAgICAgcmMgPSBFUlJPUl9GQUlMOworICAgICAgICBn
b3RvIG91dDsKKyAgICB9CisKKyAgICByYyA9IGxpYnhsX19kb21haW5fbWFrZV94c19lbnRyaWVz
KGdjLCBkX2NvbmZpZywgc3RhdGUsICpkb21pZCk7CisKK291dDoKKyAgICByZXR1cm4gcmM7Cit9
CisKIHN0YXRpYyBpbnQgc3RvcmVfbGlieGxfZW50cnkobGlieGxfX2djICpnYywgdWludDMyX3Qg
ZG9taWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpYnhsX2RvbWFpbl9idWlsZF9p
bmZvICpiX2luZm8pCiB7CkBAIC0xMDk3LDE1ICsxMTEzLDMxIEBAIHN0YXRpYyB2b2lkIGluaXRp
YXRlX2RvbWFpbl9jcmVhdGUobGlieGxfX2VnYyAqZWdjLAogICAgIHJldCA9IGxpYnhsX19kb21h
aW5fY29uZmlnX3NldGRlZmF1bHQoZ2MsZF9jb25maWcsZG9taWQpOwogICAgIGlmIChyZXQpIGdv
dG8gZXJyb3Jfb3V0OwogCi0gICAgcmV0ID0gbGlieGxfX2RvbWFpbl9tYWtlKGdjLCBkX2NvbmZp
ZywgJmRjcy0+YnVpbGRfc3RhdGUsICZkb21pZCk7Ci0gICAgaWYgKHJldCkgewotICAgICAgICBM
T0dEKEVSUk9SLCBkb21pZCwgImNhbm5vdCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOworICAgIGlm
ICggIWRfY29uZmlnLT5kbV9yZXN0b3JlX2ZpbGUgKQorICAgIHsKKyAgICAgICAgcmV0ID0gbGli
eGxfX2RvbWFpbl9tYWtlKGdjLCBkX2NvbmZpZywgJmRjcy0+YnVpbGRfc3RhdGUsICZkb21pZCk7
CiAgICAgICAgIGRjcy0+Z3Vlc3RfZG9taWQgPSBkb21pZDsKKworICAgICAgICBpZiAocmV0KSB7
CisgICAgICAgICAgICBMT0dEKEVSUk9SLCBkb21pZCwgImNhbm5vdCBtYWtlIGRvbWFpbjogJWQi
LCByZXQpOworICAgICAgICAgICAgcmV0ID0gRVJST1JfRkFJTDsKKyAgICAgICAgICAgIGdvdG8g
ZXJyb3Jfb3V0OworICAgICAgICB9CisgICAgfSBlbHNlIGlmICggZGNzLT5ndWVzdF9kb21pZCAh
PSBJTlZBTElEX0RPTUlEICkgeworICAgICAgICBkb21pZCA9IGRjcy0+Z3Vlc3RfZG9taWQ7CisK
KyAgICAgICAgcmV0ID0gbGlieGxfX2RvbWFpbl9tYWtlX3hzX2VudHJpZXMoZ2MsIGRfY29uZmln
LCAmZGNzLT5idWlsZF9zdGF0ZSwgZG9taWQpOworICAgICAgICBpZiAocmV0KSB7CisgICAgICAg
ICAgICBMT0dEKEVSUk9SLCBkb21pZCwgImNhbm5vdCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOwor
ICAgICAgICAgICAgcmV0ID0gRVJST1JfRkFJTDsKKyAgICAgICAgICAgIGdvdG8gZXJyb3Jfb3V0
OworICAgICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAgTE9HRChFUlJPUiwgZG9taWQsICJj
YW5ub3QgbWFrZSBkb21haW4iKTsKICAgICAgICAgcmV0ID0gRVJST1JfRkFJTDsKICAgICAgICAg
Z290byBlcnJvcl9vdXQ7CiAgICAgfQogCi0gICAgZGNzLT5ndWVzdF9kb21pZCA9IGRvbWlkOwog
ICAgIGRjcy0+c2Rzcy5kbS5ndWVzdF9kb21pZCA9IDA7IC8qIG1lYW5zIHdlIGhhdmVuJ3Qgc3Bh
d25lZCAqLwogCiAgICAgLyogcG9zdC00LjEzIHRvZG86IG1vdmUgdGhlc2UgbmV4dCBiaXRzIG9m
IGRlZmF1bHRpbmcgdG8KQEAgLTExNDEsNyArMTE3Myw3IEBAIHN0YXRpYyB2b2lkIGluaXRpYXRl
X2RvbWFpbl9jcmVhdGUobGlieGxfX2VnYyAqZWdjLAogICAgIGlmIChyZXQpCiAgICAgICAgIGdv
dG8gZXJyb3Jfb3V0OwogCi0gICAgaWYgKHJlc3RvcmVfZmQgPj0gMCB8fCBkY3MtPmRvbWlkX3Nv
ZnRfcmVzZXQgIT0gSU5WQUxJRF9ET01JRCkgeworICAgIGlmIChyZXN0b3JlX2ZkID49IDAgfHwg
ZGNzLT5kb21pZF9zb2Z0X3Jlc2V0ICE9IElOVkFMSURfRE9NSUQgfHwgZF9jb25maWctPmRtX3Jl
c3RvcmVfZmlsZSkgewogICAgICAgICBMT0dEKERFQlVHLCBkb21pZCwgInJlc3RvcmluZywgbm90
IHJ1bm5pbmcgYm9vdGxvYWRlciIpOwogICAgICAgICBkb21jcmVhdGVfYm9vdGxvYWRlcl9kb25l
KGVnYywgJmRjcy0+YmwsIDApOwogICAgIH0gZWxzZSAgewpAQCAtMTIxNyw3ICsxMjQ5LDE2IEBA
IHN0YXRpYyB2b2lkIGRvbWNyZWF0ZV9ib290bG9hZGVyX2RvbmUobGlieGxfX2VnYyAqZWdjLAog
ICAgIGRjcy0+c2Rzcy5kbS5jYWxsYmFjayA9IGRvbWNyZWF0ZV9kZXZtb2RlbF9zdGFydGVkOwog
ICAgIGRjcy0+c2Rzcy5jYWxsYmFjayA9IGRvbWNyZWF0ZV9kZXZtb2RlbF9zdGFydGVkOwogCi0g
ICAgaWYgKHJlc3RvcmVfZmQgPCAwICYmIGRjcy0+ZG9taWRfc29mdF9yZXNldCA9PSBJTlZBTElE
X0RPTUlEKSB7CisgICAgaWYgKHJlc3RvcmVfZmQgPCAwICYmIGRjcy0+ZG9taWRfc29mdF9yZXNl
dCA9PSBJTlZBTElEX0RPTUlEICYmICFkX2NvbmZpZy0+ZG1fcmVzdG9yZV9maWxlKSB7CisgICAg
ICAgIHJjID0gbGlieGxfX2RvbWFpbl9idWlsZChnYywgZF9jb25maWcsIGRvbWlkLCBzdGF0ZSk7
CisgICAgICAgIGRvbWNyZWF0ZV9yZWJ1aWxkX2RvbmUoZWdjLCBkY3MsIHJjKTsKKyAgICAgICAg
cmV0dXJuOworICAgIH0KKworICAgIGlmICggZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSApIHsK
KyAgICAgICAgZGNzLT5zcnMuZGNzID0gZGNzOworICAgICAgICBkY3MtPnNycy5hbyA9IGFvOwor
ICAgICAgICBzdGF0ZS0+Zm9ya2VkX3ZtID0gdHJ1ZTsKICAgICAgICAgcmMgPSBsaWJ4bF9fZG9t
YWluX2J1aWxkKGdjLCBkX2NvbmZpZywgZG9taWQsIHN0YXRlKTsKICAgICAgICAgZG9tY3JlYXRl
X3JlYnVpbGRfZG9uZShlZ2MsIGRjcywgcmMpOwogICAgICAgICByZXR1cm47CkBAIC0xNDE1LDYg
KzE0NTYsNyBAQCBzdGF0aWMgdm9pZCBkb21jcmVhdGVfcmVidWlsZF9kb25lKGxpYnhsX19lZ2Mg
KmVnYywKICAgICAvKiBjb252ZW5pZW5jZSBhbGlhc2VzICovCiAgICAgY29uc3QgdWludDMyX3Qg
ZG9taWQgPSBkY3MtPmd1ZXN0X2RvbWlkOwogICAgIGxpYnhsX2RvbWFpbl9jb25maWcgKmNvbnN0
IGRfY29uZmlnID0gZGNzLT5ndWVzdF9jb25maWc7CisgICAgbGlieGxfX2RvbWFpbl9idWlsZF9z
dGF0ZSAqY29uc3Qgc3RhdGUgPSAmZGNzLT5idWlsZF9zdGF0ZTsKIAogICAgIGlmIChyZXQpIHsK
ICAgICAgICAgTE9HRChFUlJPUiwgZG9taWQsICJjYW5ub3QgKHJlLSlidWlsZCBkb21haW46ICVk
IiwgcmV0KTsKQEAgLTE0MjIsNiArMTQ2NCw5IEBAIHN0YXRpYyB2b2lkIGRvbWNyZWF0ZV9yZWJ1
aWxkX2RvbmUobGlieGxfX2VnYyAqZWdjLAogICAgICAgICBnb3RvIGVycm9yX291dDsKICAgICB9
CiAKKyAgICBpZiAoIGRfY29uZmlnLT5kbV9yZXN0b3JlX2ZpbGUgKQorICAgICAgICBzdGF0ZS0+
c2F2ZWRfc3RhdGUgPSBHQ1NQUklOVEYoIiVzIiwgZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSk7
CisKICAgICBzdG9yZV9saWJ4bF9lbnRyeShnYywgZG9taWQsICZkX2NvbmZpZy0+Yl9pbmZvKTsK
IAogICAgIGxpYnhsX19tdWx0aWRldl9iZWdpbihhbywgJmRjcy0+bXVsdGlkZXYpOwpAQCAtMTgy
MywxMCArMTg2OCwxMyBAQCBzdGF0aWMgaW50IGRvX2RvbWFpbl9jcmVhdGUobGlieGxfY3R4ICpj
dHgsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogICAgIEdDTkVXKGNkY3MpOwogICAg
IGNkY3MtPmRjcy5hbyA9IGFvOwogICAgIGNkY3MtPmRjcy5ndWVzdF9jb25maWcgPSBkX2NvbmZp
ZzsKKyAgICBjZGNzLT5kY3MuZ3Vlc3RfZG9taWQgPSAqZG9taWQ7CisKICAgICBsaWJ4bF9kb21h
aW5fY29uZmlnX2luaXQoJmNkY3MtPmRjcy5ndWVzdF9jb25maWdfc2F2ZWQpOwogICAgIGxpYnhs
X2RvbWFpbl9jb25maWdfY29weShjdHgsICZjZGNzLT5kY3MuZ3Vlc3RfY29uZmlnX3NhdmVkLCBk
X2NvbmZpZyk7CiAgICAgY2Rjcy0+ZGNzLnJlc3RvcmVfZmQgPSBjZGNzLT5kY3MubGlieGNfZmQg
PSByZXN0b3JlX2ZkOwogICAgIGNkY3MtPmRjcy5zZW5kX2JhY2tfZmQgPSBzZW5kX2JhY2tfZmQ7
CisKICAgICBpZiAocmVzdG9yZV9mZCA+IC0xKSB7CiAgICAgICAgIGNkY3MtPmRjcy5yZXN0b3Jl
X3BhcmFtcyA9ICpwYXJhbXM7CiAgICAgICAgIHJjID0gbGlieGxfX2ZkX2ZsYWdzX21vZGlmeV9z
YXZlKGdjLCBjZGNzLT5kY3MucmVzdG9yZV9mZCwKQEAgLTIwNjksNiArMjExNyw0MyBAQCBpbnQg
bGlieGxfZG9tYWluX2NyZWF0ZV9uZXcobGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25m
aWcgKmRfY29uZmlnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFvX2hvdywgYW9wX2Nv
bnNvbGVfaG93KTsKIH0KIAoraW50IGxpYnhsX2RvbWFpbl9mb3JrX3ZtKGxpYnhsX2N0eCAqY3R4
LCB1aW50MzJfdCBwZG9taWQsIHVpbnQzMl90ICpkb21pZCkKK3sKKyAgICBpbnQgcmM7CisgICAg
c3RydWN0IHhlbl9kb21jdGxfY3JlYXRlZG9tYWluIGNyZWF0ZSA9IHswfTsKKyAgICBjcmVhdGUu
ZmxhZ3MgfD0gWEVOX0RPTUNUTF9DREZfaHZtOworICAgIGNyZWF0ZS5mbGFncyB8PSBYRU5fRE9N
Q1RMX0NERl9oYXA7CisgICAgY3JlYXRlLmZsYWdzIHw9IFhFTl9ET01DVExfQ0RGX29vc19vZmY7
CisgICAgY3JlYXRlLmFyY2guZW11bGF0aW9uX2ZsYWdzID0gKFhFTl9YODZfRU1VX0FMTCAmIH5Y
RU5fWDg2X0VNVV9WUENJKTsKKworICAgIGNyZWF0ZS5zc2lkcmVmID0gU0VDSU5JVFNJRF9ET01V
OworICAgIGNyZWF0ZS5tYXhfdmNwdXMgPSAxOyAvLyBwbGFjZWhvbGRlciwgd2lsbCBiZSBjbG9u
ZWQgZnJvbSBwZG9taWQKKyAgICBjcmVhdGUubWF4X2V2dGNobl9wb3J0ID0gMTAyMzsKKyAgICBj
cmVhdGUubWF4X2dyYW50X2ZyYW1lcyA9IExJQlhMX01BWF9HUkFOVF9GUkFNRVNfREVGQVVMVDsK
KyAgICBjcmVhdGUubWF4X21hcHRyYWNrX2ZyYW1lcyA9IExJQlhMX01BWF9NQVBUUkFDS19GUkFN
RVNfREVGQVVMVDsKKworICAgIGlmICggKHJjID0geGNfZG9tYWluX2NyZWF0ZShjdHgtPnhjaCwg
ZG9taWQsICZjcmVhdGUpKSApCisgICAgICAgIHJldHVybiByYzsKKworICAgIGlmICggKHJjID0g
eGNfbWVtc2hyX2ZvcmsoY3R4LT54Y2gsIHBkb21pZCwgKmRvbWlkKSkgKQorICAgICAgICB4Y19k
b21haW5fZGVzdHJveShjdHgtPnhjaCwgKmRvbWlkKTsKKworICAgIHJldHVybiByYzsKK30KKwor
aW50IGxpYnhsX2RvbWFpbl9mb3JrX2xhdW5jaF9kbShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9t
YWluX2NvbmZpZyAqZF9jb25maWcsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVp
bnQzMl90IGRvbWlkLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWJ4
bF9hc3luY3Byb2dyZXNzX2hvdyAqYW9wX2NvbnNvbGVfaG93KQoreworICAgIHVuc2V0X2Rpc2tf
Y29sb19yZXN0b3JlKGRfY29uZmlnKTsKKyAgICByZXR1cm4gZG9fZG9tYWluX2NyZWF0ZShjdHgs
IGRfY29uZmlnLCAmZG9taWQsIC0xLCAtMSwgMCwgMCwgYW9wX2NvbnNvbGVfaG93KTsKK30KKwor
aW50IGxpYnhsX2RvbWFpbl9mb3JrX3Jlc2V0KGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBkb21p
ZCkKK3sKKyAgICByZXR1cm4geGNfbWVtc2hyX2ZvcmtfcmVzZXQoY3R4LT54Y2gsIGRvbWlkKTsK
K30KKwogaW50IGxpYnhsX2RvbWFpbl9jcmVhdGVfcmVzdG9yZShsaWJ4bF9jdHggKmN0eCwgbGli
eGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHVpbnQzMl90ICpkb21pZCwgaW50IHJlc3RvcmVfZmQsCiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGludCBzZW5kX2JhY2tfZmQsCmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9s
aWJ4bF9kbS5jIGIvdG9vbHMvbGlieGwvbGlieGxfZG0uYwppbmRleCBkYWMxYjhkZGI4Li5hMTE5
ZTc4OWE3IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9kbS5jCisrKyBiL3Rvb2xzL2xp
YnhsL2xpYnhsX2RtLmMKQEAgLTI3ODQsNyArMjc4NCw3IEBAIHN0YXRpYyB2b2lkIGRldmljZV9t
b2RlbF9zcGF3bl9vdXRjb21lKGxpYnhsX19lZ2MgKmVnYywKIAogICAgIGxpYnhsX19kb21haW5f
YnVpbGRfc3RhdGUgKnN0YXRlID0gZG1zcy0+YnVpbGRfc3RhdGU7CiAKLSAgICBpZiAoc3RhdGUt
PnNhdmVkX3N0YXRlKSB7CisgICAgaWYgKHN0YXRlLT5zYXZlZF9zdGF0ZSAmJiAhc3RhdGUtPmZv
cmtlZF92bSkgewogICAgICAgICByZXQyID0gdW5saW5rKHN0YXRlLT5zYXZlZF9zdGF0ZSk7CiAg
ICAgICAgIGlmIChyZXQyKSB7CiAgICAgICAgICAgICBMT0dFRChFUlJPUiwgZG1zcy0+Z3Vlc3Rf
ZG9taWQsICIlczogZmFpbGVkIHRvIHJlbW92ZSBkZXZpY2UtbW9kZWwgc3RhdGUgJXMiLApkaWZm
IC0tZ2l0IGEvdG9vbHMvbGlieGwvbGlieGxfZG9tLmMgYi90b29scy9saWJ4bC9saWJ4bF9kb20u
YwppbmRleCBjZGIyOTRhYjhkLi45NWU2ZWNjOWQzIDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9s
aWJ4bF9kb20uYworKysgYi90b29scy9saWJ4bC9saWJ4bF9kb20uYwpAQCAtMzkyLDkgKzM5Miwx
MiBAQCBpbnQgbGlieGxfX2J1aWxkX3ByZShsaWJ4bF9fZ2MgKmdjLCB1aW50MzJfdCBkb21pZCwK
ICAgICBsaWJ4bF9kb21haW5fYnVpbGRfaW5mbyAqY29uc3QgaW5mbyA9ICZkX2NvbmZpZy0+Yl9p
bmZvOwogICAgIGxpYnhsX2N0eCAqY3R4ID0gbGlieGxfX2djX293bmVyKGdjKTsKICAgICBjaGFy
ICp4c19kb21pZCwgKmNvbl9kb21pZDsKLSAgICBpbnQgcmM7CisgICAgaW50IHJjID0gMDsKICAg
ICB1aW50NjRfdCBzaXplOwogCisgICAgaWYgKCBzdGF0ZS0+Zm9ya2VkX3ZtICkKKyAgICAgICAg
Z290byBza2lwX2Zvcms7CisKICAgICBpZiAoeGNfZG9tYWluX21heF92Y3B1cyhjdHgtPnhjaCwg
ZG9taWQsIGluZm8tPm1heF92Y3B1cykgIT0gMCkgewogICAgICAgICBMT0coRVJST1IsICJDb3Vs
ZG4ndCBzZXQgbWF4IHZjcHUgY291bnQiKTsKICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUw7CkBA
IC00OTksMjkgKzUwMiw2IEBAIGludCBsaWJ4bF9fYnVpbGRfcHJlKGxpYnhsX19nYyAqZ2MsIHVp
bnQzMl90IGRvbWlkLAogICAgICAgICB9CiAgICAgfQogCi0KLSAgICByYyA9IGxpYnhsX19hcmNo
X2V4dHJhX21lbW9yeShnYywgaW5mbywgJnNpemUpOwotICAgIGlmIChyYyA8IDApIHsKLSAgICAg
ICAgTE9HRShFUlJPUiwgIkNvdWxkbid0IGdldCBhcmNoIGV4dHJhIGNvbnN0YW50IG1lbW9yeSBz
aXplIik7Ci0gICAgICAgIHJldHVybiBFUlJPUl9GQUlMOwotICAgIH0KLQotICAgIGlmICh4Y19k
b21haW5fc2V0bWF4bWVtKGN0eC0+eGNoLCBkb21pZCwgaW5mby0+dGFyZ2V0X21lbWtiICsgc2l6
ZSkgPCAwKSB7Ci0gICAgICAgIExPR0UoRVJST1IsICJDb3VsZG4ndCBzZXQgbWF4IG1lbW9yeSIp
OwotICAgICAgICByZXR1cm4gRVJST1JfRkFJTDsKLSAgICB9Ci0KLSAgICB4c19kb21pZCA9IHhz
X3JlYWQoY3R4LT54c2gsIFhCVF9OVUxMLCAiL3Rvb2wveGVuc3RvcmVkL2RvbWlkIiwgTlVMTCk7
Ci0gICAgc3RhdGUtPnN0b3JlX2RvbWlkID0geHNfZG9taWQgPyBhdG9pKHhzX2RvbWlkKSA6IDA7
Ci0gICAgZnJlZSh4c19kb21pZCk7Ci0KLSAgICBjb25fZG9taWQgPSB4c19yZWFkKGN0eC0+eHNo
LCBYQlRfTlVMTCwgIi90b29sL3hlbmNvbnNvbGVkL2RvbWlkIiwgTlVMTCk7Ci0gICAgc3RhdGUt
PmNvbnNvbGVfZG9taWQgPSBjb25fZG9taWQgPyBhdG9pKGNvbl9kb21pZCkgOiAwOwotICAgIGZy
ZWUoY29uX2RvbWlkKTsKLQotICAgIHN0YXRlLT5zdG9yZV9wb3J0ID0geGNfZXZ0Y2huX2FsbG9j
X3VuYm91bmQoY3R4LT54Y2gsIGRvbWlkLCBzdGF0ZS0+c3RvcmVfZG9taWQpOwotICAgIHN0YXRl
LT5jb25zb2xlX3BvcnQgPSB4Y19ldnRjaG5fYWxsb2NfdW5ib3VuZChjdHgtPnhjaCwgZG9taWQs
IHN0YXRlLT5jb25zb2xlX2RvbWlkKTsKLQogICAgIGlmIChpbmZvLT50eXBlICE9IExJQlhMX0RP
TUFJTl9UWVBFX1BWKQogICAgICAgICBodm1fc2V0X2NvbmZfcGFyYW1zKGN0eC0+eGNoLCBkb21p
ZCwgaW5mbyk7CiAKQEAgLTU1Niw4ICs1MzYsMzQgQEAgaW50IGxpYnhsX19idWlsZF9wcmUobGli
eGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5m
by0+YWx0cDJtKTsKICAgICB9CiAKKyAgICByYyA9IGxpYnhsX19hcmNoX2V4dHJhX21lbW9yeShn
YywgaW5mbywgJnNpemUpOworICAgIGlmIChyYyA8IDApIHsKKyAgICAgICAgTE9HRShFUlJPUiwg
IkNvdWxkbid0IGdldCBhcmNoIGV4dHJhIGNvbnN0YW50IG1lbW9yeSBzaXplIik7CisgICAgICAg
IHJldHVybiBFUlJPUl9GQUlMOworICAgIH0KKworICAgIGlmICh4Y19kb21haW5fc2V0bWF4bWVt
KGN0eC0+eGNoLCBkb21pZCwgaW5mby0+dGFyZ2V0X21lbWtiICsgc2l6ZSkgPCAwKSB7CisgICAg
ICAgIExPR0UoRVJST1IsICJDb3VsZG4ndCBzZXQgbWF4IG1lbW9yeSIpOworICAgICAgICByZXR1
cm4gRVJST1JfRkFJTDsKKyAgICB9CisKICAgICByYyA9IGxpYnhsX19hcmNoX2RvbWFpbl9jcmVh
dGUoZ2MsIGRfY29uZmlnLCBkb21pZCk7CisgICAgaWYgKCByYyApCisgICAgICAgIGdvdG8gb3V0
OwogCitza2lwX2Zvcms6CisgICAgeHNfZG9taWQgPSB4c19yZWFkKGN0eC0+eHNoLCBYQlRfTlVM
TCwgIi90b29sL3hlbnN0b3JlZC9kb21pZCIsIE5VTEwpOworICAgIHN0YXRlLT5zdG9yZV9kb21p
ZCA9IHhzX2RvbWlkID8gYXRvaSh4c19kb21pZCkgOiAwOworICAgIGZyZWUoeHNfZG9taWQpOwor
CisgICAgY29uX2RvbWlkID0geHNfcmVhZChjdHgtPnhzaCwgWEJUX05VTEwsICIvdG9vbC94ZW5j
b25zb2xlZC9kb21pZCIsIE5VTEwpOworICAgIHN0YXRlLT5jb25zb2xlX2RvbWlkID0gY29uX2Rv
bWlkID8gYXRvaShjb25fZG9taWQpIDogMDsKKyAgICBmcmVlKGNvbl9kb21pZCk7CisKKyAgICBz
dGF0ZS0+c3RvcmVfcG9ydCA9IHhjX2V2dGNobl9hbGxvY191bmJvdW5kKGN0eC0+eGNoLCBkb21p
ZCwgc3RhdGUtPnN0b3JlX2RvbWlkKTsKKyAgICBzdGF0ZS0+Y29uc29sZV9wb3J0ID0geGNfZXZ0
Y2huX2FsbG9jX3VuYm91bmQoY3R4LT54Y2gsIGRvbWlkLCBzdGF0ZS0+Y29uc29sZV9kb21pZCk7
CisKK291dDoKICAgICByZXR1cm4gcmM7CiB9CiAKQEAgLTYxNSw2ICs2MjEsOSBAQCBpbnQgbGli
eGxfX2J1aWxkX3Bvc3QobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgY2hhciAq
KmVudHM7CiAgICAgaW50IGksIHJjOwogCisgICAgaWYgKCBzdGF0ZS0+Zm9ya2VkX3ZtICkKKyAg
ICAgICAgZ290byBza2lwX2Zvcms7CisKICAgICBpZiAoaW5mby0+bnVtX3ZudW1hX25vZGVzICYm
ICFpbmZvLT5udW1fdmNwdV9zb2Z0X2FmZmluaXR5KSB7CiAgICAgICAgIHJjID0gc2V0X3ZudW1h
X2FmZmluaXR5KGdjLCBkb21pZCwgaW5mbyk7CiAgICAgICAgIGlmIChyYykKQEAgLTYzOSw2ICs2
NDgsNyBAQCBpbnQgbGlieGxfX2J1aWxkX3Bvc3QobGlieGxfX2djICpnYywgdWludDMyX3QgZG9t
aWQsCiAgICAgICAgIH0KICAgICB9CiAKK3NraXBfZm9yazoKICAgICBlbnRzID0gbGlieGxfX2Nh
bGxvYyhnYywgMTIgKyAoaW5mby0+bWF4X3ZjcHVzICogMikgKyAyLCBzaXplb2YoY2hhciAqKSk7
CiAgICAgZW50c1swXSA9ICJtZW1vcnkvc3RhdGljLW1heCI7CiAgICAgZW50c1sxXSA9IEdDU1BS
SU5URigiJSJQUklkNjQsIGluZm8tPm1heF9tZW1rYik7CkBAIC05MDEsMTQgKzkxMSwxNiBAQCBz
dGF0aWMgaW50IGh2bV9idWlsZF9zZXRfcGFyYW1zKHhjX2ludGVyZmFjZSAqaGFuZGxlLCB1aW50
MzJfdCBkb21pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfZG9tYWlu
X2J1aWxkX2luZm8gKmluZm8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBz
dG9yZV9ldnRjaG4sIHVuc2lnbmVkIGxvbmcgKnN0b3JlX21mbiwKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgaW50IGNvbnNvbGVfZXZ0Y2huLCB1bnNpZ25lZCBsb25nICpjb25zb2xl
X21mbiwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9taWRfdCBzdG9yZV9kb21p
ZCwgZG9taWRfdCBjb25zb2xlX2RvbWlkKQorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBkb21pZF90IHN0b3JlX2RvbWlkLCBkb21pZF90IGNvbnNvbGVfZG9taWQsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGJvb2wgZm9ya2VkX3ZtKQogewogICAgIHN0cnVjdCBodm1f
aW5mb190YWJsZSAqdmFfaHZtOwogICAgIHVpbnQ4X3QgKnZhX21hcCwgc3VtOwogICAgIHVpbnQ2
NF90IHN0cl9tZm4sIGNvbnNfbWZuOwogICAgIGludCBpOwogCi0gICAgaWYgKGluZm8tPnR5cGUg
PT0gTElCWExfRE9NQUlOX1RZUEVfSFZNKSB7CisgICAgaWYgKCBpbmZvLT50eXBlID09IExJQlhM
X0RPTUFJTl9UWVBFX0hWTSAmJiAhZm9ya2VkX3ZtICkKKyAgICB7CiAgICAgICAgIHZhX21hcCA9
IHhjX21hcF9mb3JlaWduX3JhbmdlKGhhbmRsZSwgZG9taWQsCiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIFhDX1BBR0VfU0laRSwgUFJPVF9SRUFEIHwgUFJPVF9XUklURSwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSFZNX0lORk9fUEZOKTsKQEAg
LTEyMjQsNiArMTIzNiwyMyBAQCBpbnQgbGlieGxfX2J1aWxkX2h2bShsaWJ4bF9fZ2MgKmdjLCB1
aW50MzJfdCBkb21pZCwKICAgICBzdHJ1Y3QgeGNfZG9tX2ltYWdlICpkb20gPSBOVUxMOwogICAg
IGJvb2wgZGV2aWNlX21vZGVsID0gaW5mby0+dHlwZSA9PSBMSUJYTF9ET01BSU5fVFlQRV9IVk0g
PyB0cnVlIDogZmFsc2U7CiAKKyAgICBpZiAoIHN0YXRlLT5mb3JrZWRfdm0gKQorICAgIHsKKyAg
ICAgICAgcmMgPSBodm1fYnVpbGRfc2V0X3BhcmFtcyhjdHgtPnhjaCwgZG9taWQsIGluZm8sIHN0
YXRlLT5zdG9yZV9wb3J0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZzdGF0
ZS0+c3RvcmVfbWZuLCBzdGF0ZS0+Y29uc29sZV9wb3J0LAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICZzdGF0ZS0+Y29uc29sZV9tZm4sIHN0YXRlLT5zdG9yZV9kb21pZCwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS0+Y29uc29sZV9kb21pZCwgc3Rh
dGUtPmZvcmtlZF92bSk7CisKKyAgICAgICAgaWYgKCByYyApCisgICAgICAgICAgICByZXR1cm4g
cmM7CisKKyAgICAgICAgcmV0dXJuIHhjX2RvbV9nbnR0YWJfc2VlZChjdHgtPnhjaCwgZG9taWQs
IHRydWUsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUtPmNvbnNvbGVf
bWZuLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLT5zdG9yZV9tZm4s
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUtPmNvbnNvbGVfZG9taWQs
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUtPnN0b3JlX2RvbWlkKTsK
KyAgICB9CisKICAgICB4Y19kb21fbG9naW5pdChjdHgtPnhjaCk7CiAKICAgICAvKgpAQCAtMTM0
OCw3ICsxMzc3LDcgQEAgaW50IGxpYnhsX19idWlsZF9odm0obGlieGxfX2djICpnYywgdWludDMy
X3QgZG9taWQsCiAgICAgcmMgPSBodm1fYnVpbGRfc2V0X3BhcmFtcyhjdHgtPnhjaCwgZG9taWQs
IGluZm8sIHN0YXRlLT5zdG9yZV9wb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICZzdGF0ZS0+c3RvcmVfbWZuLCBzdGF0ZS0+Y29uc29sZV9wb3J0LAogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICZzdGF0ZS0+Y29uc29sZV9tZm4sIHN0YXRlLT5zdG9yZV9kb21pZCwK
LSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS0+Y29uc29sZV9kb21pZCk7Cisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUtPmNvbnNvbGVfZG9taWQsIGZhbHNl
KTsKICAgICBpZiAocmMgIT0gMCkgewogICAgICAgICBMT0coRVJST1IsICJodm0gYnVpbGQgc2V0
IHBhcmFtcyBmYWlsZWQiKTsKICAgICAgICAgZ290byBvdXQ7CmRpZmYgLS1naXQgYS90b29scy9s
aWJ4bC9saWJ4bF9pbnRlcm5hbC5oIGIvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaAppbmRl
eCBiNWFkYmZlNGI3Li5lYTZmZTEzM2E1IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9p
bnRlcm5hbC5oCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmgKQEAgLTEzNjAsNiAr
MTM2MCw3IEBAIHR5cGVkZWYgc3RydWN0IHsKIAogICAgIGNoYXIgKnNhdmVkX3N0YXRlOwogICAg
IGludCBkbV9tb25pdG9yX2ZkOworICAgIGJvb2wgZm9ya2VkX3ZtOwogCiAgICAgbGlieGxfX2Zp
bGVfcmVmZXJlbmNlIHB2X2tlcm5lbDsKICAgICBsaWJ4bF9fZmlsZV9yZWZlcmVuY2UgcHZfcmFt
ZGlzazsKZGlmZiAtLWdpdCBhL3Rvb2xzL2xpYnhsL2xpYnhsX3R5cGVzLmlkbCBiL3Rvb2xzL2xp
YnhsL2xpYnhsX3R5cGVzLmlkbAppbmRleCA3OTIxOTUwZjZhLi43YzRjNDA1N2E5IDEwMDY0NAot
LS0gYS90b29scy9saWJ4bC9saWJ4bF90eXBlcy5pZGwKKysrIGIvdG9vbHMvbGlieGwvbGlieGxf
dHlwZXMuaWRsCkBAIC05NTYsNiArOTU2LDcgQEAgbGlieGxfZG9tYWluX2NvbmZpZyA9IFN0cnVj
dCgiZG9tYWluX2NvbmZpZyIsIFsKICAgICAoIm9uX3dhdGNoZG9nIiwgbGlieGxfYWN0aW9uX29u
X3NodXRkb3duKSwKICAgICAoIm9uX2NyYXNoIiwgbGlieGxfYWN0aW9uX29uX3NodXRkb3duKSwK
ICAgICAoIm9uX3NvZnRfcmVzZXQiLCBsaWJ4bF9hY3Rpb25fb25fc2h1dGRvd24pLAorICAgICgi
ZG1fcmVzdG9yZV9maWxlIiwgc3RyaW5nLCB7J2NvbnN0JzogVHJ1ZX0pLAogICAgIF0sIGRpcj1E
SVJfSU4pCiAKIGxpYnhsX2Rpc2tpbmZvID0gU3RydWN0KCJkaXNraW5mbyIsIFsKZGlmZiAtLWdp
dCBhL3Rvb2xzL3hsL3hsLmggYi90b29scy94bC94bC5oCmluZGV4IDYwYmRhZDhmZmIuLjliZGFk
NjUyNmUgMTAwNjQ0Ci0tLSBhL3Rvb2xzL3hsL3hsLmgKKysrIGIvdG9vbHMveGwveGwuaApAQCAt
MzEsNiArMzEsNyBAQCBzdHJ1Y3QgY21kX3NwZWMgewogfTsKIAogc3RydWN0IGRvbWFpbl9jcmVh
dGUgeworICAgIHVpbnQzMl90IGRkb21pZDsgLyogZm9yayBsYXVuY2ggZG0gZm9yIHRoaXMgZG9t
aWQgKi8KICAgICBpbnQgZGVidWc7CiAgICAgaW50IGRhZW1vbml6ZTsKICAgICBpbnQgbW9uaXRv
cjsgLyogaGFuZGxlIGd1ZXN0IHJlYm9vdHMgZXRjICovCkBAIC00NSw2ICs0Niw3IEBAIHN0cnVj
dCBkb21haW5fY3JlYXRlIHsKICAgICBjb25zdCBjaGFyICpjb25maWdfZmlsZTsKICAgICBjaGFy
ICpleHRyYV9jb25maWc7IC8qIGV4dHJhIGNvbmZpZyBzdHJpbmcgKi8KICAgICBjb25zdCBjaGFy
ICpyZXN0b3JlX2ZpbGU7CisgICAgY29uc3QgY2hhciAqZG1fcmVzdG9yZV9maWxlOwogICAgIGNo
YXIgKmNvbG9fcHJveHlfc2NyaXB0OwogICAgIGJvb2wgdXNlcnNwYWNlX2NvbG9fcHJveHk7CiAg
ICAgaW50IG1pZ3JhdGVfZmQ7IC8qIC0xIG1lYW5zIG5vbmUgKi8KQEAgLTEyNyw2ICsxMjksOSBA
QCBpbnQgbWFpbl9wY2lhc3NpZ25hYmxlX3JlbW92ZShpbnQgYXJnYywgY2hhciAqKmFyZ3YpOwog
aW50IG1haW5fcGNpYXNzaWduYWJsZV9saXN0KGludCBhcmdjLCBjaGFyICoqYXJndik7CiAjaWZu
ZGVmIExJQlhMX0hBVkVfTk9fU1VTUEVORF9SRVNVTUUKIGludCBtYWluX3Jlc3RvcmUoaW50IGFy
Z2MsIGNoYXIgKiphcmd2KTsKK2ludCBtYWluX2Zvcmtfdm0oaW50IGFyZ2MsIGNoYXIgKiphcmd2
KTsKK2ludCBtYWluX2ZvcmtfbGF1bmNoX2RtKGludCBhcmdjLCBjaGFyICoqYXJndik7CitpbnQg
bWFpbl9mb3JrX3Jlc2V0KGludCBhcmdjLCBjaGFyICoqYXJndik7CiBpbnQgbWFpbl9taWdyYXRl
X3JlY2VpdmUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KTsKIGludCBtYWluX3NhdmUoaW50IGFyZ2Ms
IGNoYXIgKiphcmd2KTsKIGludCBtYWluX21pZ3JhdGUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KTsK
ZGlmZiAtLWdpdCBhL3Rvb2xzL3hsL3hsX2NtZHRhYmxlLmMgYi90b29scy94bC94bF9jbWR0YWJs
ZS5jCmluZGV4IDViYWE2MDIzYWEuLjk0MjE3ZTRlZDQgMTAwNjQ0Ci0tLSBhL3Rvb2xzL3hsL3hs
X2NtZHRhYmxlLmMKKysrIGIvdG9vbHMveGwveGxfY21kdGFibGUuYwpAQCAtMTgwLDYgKzE4MCwy
OCBAQCBzdHJ1Y3QgY21kX3NwZWMgY21kX3RhYmxlW10gPSB7CiAgICAgICAiLVYsIC0tdm5jdmll
d2VyICAgICAgICAgIENvbm5lY3QgdG8gdGhlIFZOQyBkaXNwbGF5IGFmdGVyIHRoZSBkb21haW4g
aXMgY3JlYXRlZC5cbiIKICAgICAgICItQSwgLS12bmN2aWV3ZXItYXV0b3Bhc3MgUGFzcyBWTkMg
cGFzc3dvcmQgdG8gdmlld2VyIHZpYSBzdGRpbi4iCiAgICAgfSwKKyAgICB7ICJmb3JrLXZtIiwK
KyAgICAgICZtYWluX2Zvcmtfdm0sIDAsIDEsCisgICAgICAiRm9yayBhIGRvbWFpbiBmcm9tIHRo
ZSBydW5uaW5nIHBhcmVudCBkb21pZCIsCisgICAgICAiW29wdGlvbnNdIDxQYXJlbnREb21pZD4i
LAorICAgICAgIi1oICAgICAgICAgICAgICAgICAgICAgICBQcmludCB0aGlzIGhlbHAuXG4iCisg
ICAgICAiLWQgICAgICAgICAgICAgICAgICAgICAgIEVuYWJsZSBkZWJ1ZyBtZXNzYWdlcy5cbiIK
KyAgICB9LAorICAgIHsgImZvcmstbGF1bmNoLWRtIiwKKyAgICAgICZtYWluX2ZvcmtfbGF1bmNo
X2RtLCAwLCAxLAorICAgICAgIkxhdW5jaCB0aGUgZGV2aWNlIG1vZGVsIGZvciBhIGZvcmtlZCBW
TSIsCisgICAgICAiW29wdGlvbnNdIDxDb25maWdGaWxlPiA8RG1SZXN0b3JlRmlsZT4gPERvbWlk
PiIsCisgICAgICAiLWggICAgICAgICAgICAgICAgICAgICAgIFByaW50IHRoaXMgaGVscC5cbiIK
KyAgICAgICItcCAgICAgICAgICAgICAgICAgICAgICAgRG8gbm90IHVucGF1c2UgZG9tYWluIGFm
dGVyIHJlc3RvcmluZyBpdC5cbiIKKyAgICAgICItZCAgICAgICAgICAgICAgICAgICAgICAgRW5h
YmxlIGRlYnVnIG1lc3NhZ2VzLlxuIgorICAgIH0sCisgICAgeyAiZm9yay1yZXNldCIsCisgICAg
ICAmbWFpbl9mb3JrX3Jlc2V0LCAwLCAxLAorICAgICAgIkxhdW5jaCB0aGUgZGV2aWNlIG1vZGVs
IGZvciBhIGZvcmtlZCBWTSIsCisgICAgICAiW29wdGlvbnNdIDxEb21pZD4iLAorICAgICAgIi1o
ICAgICAgICAgICAgICAgICAgICAgICBQcmludCB0aGlzIGhlbHAuXG4iCisgICAgICAiLWQgICAg
ICAgICAgICAgICAgICAgICAgIEVuYWJsZSBkZWJ1ZyBtZXNzYWdlcy5cbiIKKyAgICB9LAogICAg
IHsgIm1pZ3JhdGUtcmVjZWl2ZSIsCiAgICAgICAmbWFpbl9taWdyYXRlX3JlY2VpdmUsIDAsIDEs
CiAgICAgICAiUmVzdG9yZSBhIGRvbWFpbiBmcm9tIGEgc2F2ZWQgc3RhdGUiLApkaWZmIC0tZ2l0
IGEvdG9vbHMveGwveGxfc2F2ZXJlc3RvcmUuYyBiL3Rvb2xzL3hsL3hsX3NhdmVyZXN0b3JlLmMK
aW5kZXggOWJlMDMzZmU2NS4uYzFkZDc0ZjMzZSAxMDA2NDQKLS0tIGEvdG9vbHMveGwveGxfc2F2
ZXJlc3RvcmUuYworKysgYi90b29scy94bC94bF9zYXZlcmVzdG9yZS5jCkBAIC0yMjksNiArMjI5
LDEwMiBAQCBpbnQgbWFpbl9yZXN0b3JlKGludCBhcmdjLCBjaGFyICoqYXJndikKICAgICByZXR1
cm4gRVhJVF9TVUNDRVNTOwogfQogCitpbnQgbWFpbl9mb3JrX3ZtKGludCBhcmdjLCBjaGFyICoq
YXJndikKK3sKKyAgICBpbnQgZGVidWcgPSAwOworICAgIHVpbnQzMl90IHBkb21pZCA9IDAsIGRv
bWlkID0gSU5WQUxJRF9ET01JRDsKKyAgICBpbnQgb3B0OworCisgICAgU1dJVENIX0ZPUkVBQ0hf
T1BUKG9wdCwgImQiLCBOVUxMLCAiZm9yay12bSIsIDEpIHsKKyAgICBjYXNlICdkJzoKKyAgICAg
ICAgZGVidWcgPSAxOworICAgICAgICBicmVhazsKKyAgICB9CisKKyAgICBpZiAoYXJnYy1vcHRp
bmQgPT0gMSkgeworICAgICAgICBwZG9taWQgPSBhdG9pKGFyZ3Zbb3B0aW5kXSk7CisgICAgfSBl
bHNlIHsKKyAgICAgICAgaGVscCgiZm9yay12bSIpOworICAgICAgICByZXR1cm4gRVhJVF9GQUlM
VVJFOworICAgIH0KKworICAgIGlmIChsaWJ4bF9kb21haW5fZm9ya192bShjdHgsIHBkb21pZCwg
JmRvbWlkKSB8fCBkb21pZCA9PSBJTlZBTElEX0RPTUlEKQorICAgICAgICByZXR1cm4gRVhJVF9G
QUlMVVJFOworCisgICAgZnByaW50ZihzdGRlcnIsICJWTSBmb3JrIGNyZWF0ZWQgd2l0aCBkb21p
ZDogJXVcbiIsIGRvbWlkKTsKKyAgICByZXR1cm4gRVhJVF9TVUNDRVNTOworfQorCitpbnQgbWFp
bl9mb3JrX2xhdW5jaF9kbShpbnQgYXJnYywgY2hhciAqKmFyZ3YpCit7CisgICAgY29uc3QgY2hh
ciAqY29uZmlnX2ZpbGUgPSBOVUxMOworICAgIGNvbnN0IGNoYXIgKmRtX3Jlc3RvcmVfZmlsZSA9
IE5VTEw7CisgICAgc3RydWN0IGRvbWFpbl9jcmVhdGUgZG9tX2luZm87CisgICAgaW50IHBhdXNl
ZCA9IDAsIGRlYnVnID0gMDsKKyAgICB1aW50MzJfdCBkZG9taWQgPSAwOworICAgIGludCBvcHQs
IHJjOworCisgICAgU1dJVENIX0ZPUkVBQ0hfT1BUKG9wdCwgInBkIiwgTlVMTCwgImZvcmstbGF1
bmNoLWRtIiwgMSkgeworICAgIGNhc2UgJ3AnOgorICAgICAgICBwYXVzZWQgPSAxOworICAgICAg
ICBicmVhazsKKyAgICBjYXNlICdkJzoKKyAgICAgICAgZGVidWcgPSAxOworICAgICAgICBicmVh
azsKKyAgICB9CisKKyAgICBpZiAoYXJnYy1vcHRpbmQgPT0gMykgeworICAgICAgICBjb25maWdf
ZmlsZSA9IGFyZ3Zbb3B0aW5kXTsKKyAgICAgICAgZG1fcmVzdG9yZV9maWxlID0gYXJndltvcHRp
bmQgKyAxXTsKKyAgICAgICAgZGRvbWlkID0gYXRvaShhcmd2W29wdGluZCArIDJdKTsKKyAgICB9
IGVsc2UgeworICAgICAgICBoZWxwKCJmb3JrLWxhdW5jaC1kbSIpOworICAgICAgICByZXR1cm4g
RVhJVF9GQUlMVVJFOworICAgIH0KKworICAgIG1lbXNldCgmZG9tX2luZm8sIDAsIHNpemVvZihk
b21faW5mbykpOworICAgIGRvbV9pbmZvLmRkb21pZCA9IGRkb21pZDsKKyAgICBkb21faW5mby5k
bV9yZXN0b3JlX2ZpbGUgPSBkbV9yZXN0b3JlX2ZpbGU7CisgICAgZG9tX2luZm8uZGVidWcgPSBk
ZWJ1ZzsKKyAgICBkb21faW5mby5wYXVzZWQgPSBwYXVzZWQ7CisgICAgZG9tX2luZm8uY29uZmln
X2ZpbGUgPSBjb25maWdfZmlsZTsKKyAgICBkb21faW5mby5taWdyYXRlX2ZkID0gLTE7CisgICAg
ZG9tX2luZm8uc2VuZF9iYWNrX2ZkID0gLTE7CisKKyAgICByYyA9IGNyZWF0ZV9kb21haW4oJmRv
bV9pbmZvKTsKKyAgICBpZiAocmMgPCAwKQorICAgICAgICByZXR1cm4gRVhJVF9GQUlMVVJFOwor
CisgICAgcmV0dXJuIEVYSVRfU1VDQ0VTUzsKK30KKworaW50IG1haW5fZm9ya19yZXNldChpbnQg
YXJnYywgY2hhciAqKmFyZ3YpCit7CisgICAgaW50IGRlYnVnID0gMDsKKyAgICB1aW50MzJfdCBk
b21pZCA9IDA7CisgICAgaW50IG9wdCwgcmM7CisKKyAgICBTV0lUQ0hfRk9SRUFDSF9PUFQob3B0
LCAiZCIsIE5VTEwsICJmb3JrLXJlc2V0IiwgMSkKKyAgICB7CisgICAgY2FzZSAnZCc6CisgICAg
ICAgIGRlYnVnID0gMTsKKyAgICAgICAgYnJlYWs7CisgICAgfQorCisgICAgaWYgKGFyZ2Mtb3B0
aW5kID09IDEpIHsKKyAgICAgICAgZG9taWQgPSBhdG9pKGFyZ3Zbb3B0aW5kXSk7CisgICAgfSBl
bHNlIHsKKyAgICAgICAgaGVscCgiZm9yay1yZXNldCIpOworICAgICAgICByZXR1cm4gRVhJVF9G
QUlMVVJFOworICAgIH0KKworICAgIHJjID0gbGlieGxfZG9tYWluX2ZvcmtfcmVzZXQoY3R4LCBk
b21pZCk7CisgICAgaWYgKHJjIDwgMCkKKyAgICAgICAgcmV0dXJuIEVYSVRfRkFJTFVSRTsKKwor
ICAgIHJldHVybiBFWElUX1NVQ0NFU1M7Cit9CisKIGludCBtYWluX3NhdmUoaW50IGFyZ2MsIGNo
YXIgKiphcmd2KQogewogICAgIHVpbnQzMl90IGRvbWlkOwpkaWZmIC0tZ2l0IGEvdG9vbHMveGwv
eGxfdm1jb250cm9sLmMgYi90b29scy94bC94bF92bWNvbnRyb2wuYwppbmRleCBlNTIwYjFkYTc5
Li5kOWNiMTljNTk5IDEwMDY0NAotLS0gYS90b29scy94bC94bF92bWNvbnRyb2wuYworKysgYi90
b29scy94bC94bF92bWNvbnRyb2wuYwpAQCAtNjQ1LDYgKzY0NSw3IEBAIGludCBjcmVhdGVfZG9t
YWluKHN0cnVjdCBkb21haW5fY3JlYXRlICpkb21faW5mbykKIAogICAgIGxpYnhsX2RvbWFpbl9j
b25maWcgZF9jb25maWc7CiAKKyAgICB1aW50MzJfdCBkZG9taWQgPSBkb21faW5mby0+ZGRvbWlk
OyAvLyBsYXVuY2ggZG0gZm9yIHRoaXMgZG9tYWluIGlmZiBzZXQKICAgICBpbnQgZGVidWcgPSBk
b21faW5mby0+ZGVidWc7CiAgICAgaW50IGRhZW1vbml6ZSA9IGRvbV9pbmZvLT5kYWVtb25pemU7
CiAgICAgaW50IG1vbml0b3IgPSBkb21faW5mby0+bW9uaXRvcjsKQEAgLTY1NSw2ICs2NTYsNyBA
QCBpbnQgY3JlYXRlX2RvbWFpbihzdHJ1Y3QgZG9tYWluX2NyZWF0ZSAqZG9tX2luZm8pCiAgICAg
Y29uc3QgY2hhciAqcmVzdG9yZV9maWxlID0gZG9tX2luZm8tPnJlc3RvcmVfZmlsZTsKICAgICBj
b25zdCBjaGFyICpjb25maWdfc291cmNlID0gTlVMTDsKICAgICBjb25zdCBjaGFyICpyZXN0b3Jl
X3NvdXJjZSA9IE5VTEw7CisgICAgY29uc3QgY2hhciAqZG1fcmVzdG9yZV9maWxlID0gZG9tX2lu
Zm8tPmRtX3Jlc3RvcmVfZmlsZTsKICAgICBpbnQgbWlncmF0ZV9mZCA9IGRvbV9pbmZvLT5taWdy
YXRlX2ZkOwogICAgIGJvb2wgY29uZmlnX2luX2pzb247CiAKQEAgLTkyMyw2ICs5MjUsMTIgQEAg
c3RhcnQ6CiAgICAgICAgICAqIHJlc3RvcmUvbWlncmF0ZS1yZWNlaXZlIGl0IGFnYWluLgogICAg
ICAgICAgKi8KICAgICAgICAgcmVzdG9yaW5nID0gMDsKKyAgICB9IGVsc2UgaWYgKCBkZG9taWQg
KSB7CisgICAgICAgIGRfY29uZmlnLmRtX3Jlc3RvcmVfZmlsZSA9IGRtX3Jlc3RvcmVfZmlsZTsK
KyAgICAgICAgcmV0ID0gbGlieGxfZG9tYWluX2ZvcmtfbGF1bmNoX2RtKGN0eCwgJmRfY29uZmln
LCBkZG9taWQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRv
Y29ubmVjdF9jb25zb2xlX2hvdyk7CisgICAgICAgIGRvbWlkID0gZGRvbWlkOworICAgICAgICBk
ZG9taWQgPSBJTlZBTElEX0RPTUlEOwogICAgIH0gZWxzZSBpZiAoZG9taWRfc29mdF9yZXNldCAh
PSBJTlZBTElEX0RPTUlEKSB7CiAgICAgICAgIC8qIERvIHNvZnQgcmVzZXQuICovCiAgICAgICAg
IHJldCA9IGxpYnhsX2RvbWFpbl9zb2Z0X3Jlc2V0KGN0eCwgJmRfY29uZmlnLCBkb21pZF9zb2Z0
X3Jlc2V0LAotLSAKMi4yMC4xCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJv
amVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hl
bi1kZXZlbA==

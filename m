Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id A8BCBBF95D
	for <lists+xen-devel@lfdr.de>; Thu, 26 Sep 2019 20:42:04 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDYel-0002Ob-2S; Thu, 26 Sep 2019 18:38:23 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=fOM6=XV=arm.com=julien.grall@srs-us1.protection.inumbo.net>)
 id 1iDYej-0002OH-4C
 for xen-devel@lists.xenproject.org; Thu, 26 Sep 2019 18:38:21 +0000
X-Inumbo-ID: cddbbc6e-e08c-11e9-965e-12813bfff9fa
Received: from foss.arm.com (unknown [217.140.110.172])
 by localhost (Halon) with ESMTP
 id cddbbc6e-e08c-11e9-965e-12813bfff9fa;
 Thu, 26 Sep 2019 18:38:16 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
 by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 521AA142F;
 Thu, 26 Sep 2019 11:38:16 -0700 (PDT)
Received: from e108454-lin.cambridge.arm.com (e108454-lin.cambridge.arm.com
 [10.1.196.50])
 by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id 85B833F67D;
 Thu, 26 Sep 2019 11:38:15 -0700 (PDT)
From: Julien Grall <julien.grall@arm.com>
To: xen-devel@lists.xenproject.org
Date: Thu, 26 Sep 2019 19:38:01 +0100
Message-Id: <20190926183808.11630-4-julien.grall@arm.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <20190926183808.11630-1-julien.grall@arm.com>
References: <20190926183808.11630-1-julien.grall@arm.com>
Subject: [Xen-devel] [PATCH RFC for-4.13 03/10] xen/arm: traps: Rework
 entry/exit from the guest path
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Julien Grall <julien.grall@arm.com>,
 Stefano Stabellini <sstabellini@kernel.org>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>, andrii.anisov@gmail.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QXQgdGhlIG1vbWVudCwgZW50ZXJfaHlwZXJ2aXNvcl9oZWFkKCkgYW5kIGxlYXZlX2h5cGVydmlz
b3JfdGFpbCgpIGFyZQp1c2VkIHRvIGRlYWwgd2l0aCBhY3Rpb25zIHRvIGJlIGRvbmUgYmVmb3Jl
L2FmdGVyIGFueSBndWVzdCByZXF1ZXN0IGlzCmhhbmRsZWQuCgpXaGlsZSB0aGV5IGFyZSBtZWFu
dCB0byB3b3JrIGluIHBhaXIsIHRoZSBmb3JtZXIgaXMgY2FsbGVkIGZvciBtb3N0IG9mCnRoZSB0
cmFwcywgaW5jbHVkaW5nIHRyYXBzIGZyb20gdGhlIHNhbWUgZXhjZXB0aW9uIGxldmVsIChpLmUu
Cmh5cGVydmlzb3IpIHdoaWxzdCB0aGUgbGF0dGVyIHdpbGwgb25seSBiZSBjYWxsZWQgd2hlbiBy
ZXR1cm5pbmcgdG8gdGhlCmd1ZXN0LgoKQXMgcG9pbnRlZCBvdXQsIHRoZSBlbnRlcl9oeXBlcnZp
c29yX2hlYWQoKSBpcyBub3QgY2FsbGVkIGZyb20gYWxsIHRoZQp0cmFwcywgc28gdGhpcyBtYWtl
cyBwb3RlbnRpYWxseSBkaWZmaWN1bHQgdG8gZXh0ZW5kIGl0IGZvciB0aGUgZGVhbGluZwp3aXRo
IHNhbWUgZXhjZXB0aW9uIGxldmVsLgoKRnVydGhlcm1vcmUsIHNvbWUgYXNzZW1ibHkgb25seSBw
YXRoIHdpbGwgcmVxdWlyZSB0byBjYWxsCmVudGVyX2h5cGVydmlzb3JfdGFpbCgpLiBTbyB0aGUg
ZnVuY3Rpb24gaXMgbm93IGRpcmVjdGx5IGNhbGwgYnkKYXNzZW1ibHkgaW4gZm9yIGd1ZXN0IHZl
Y3RvciBvbmx5LiBUaGlzIG1lYW5zIHRoYXQgdGhlIGNoZWNrIHdoZXRoZXIgd2UKYXJlIGNhbGxl
ZCBpbiBhIGd1ZXN0IHRyYXAgY2FuIG5vdyBiZSByZW1vdmVkLgoKVGFrZSB0aGUgb3Bwb3J0dW5p
dHkgdG8gcmVuYW1lIGVudGVyX2h5cGVydmlzb3JfdGFpbCgpIGFuZApsZWF2ZV9oeXBlcnZpc29y
X3RhaWwoKSB0byBzb21ldGhpbmcgbW9yZSBtZWFuaW5nZnVsIGFuZCBkb2N1bWVudCB0aGVtLgpU
aGlzIHNob3VsZCBoZWxwIGV2ZXJ5b25lIHRvIHVuZGVyc3RhbmQgdGhlIHB1cnBvc2Ugb2YgdGhl
IHR3bwpmdW5jdGlvbnMuCgpTaWduZWQtb2ZmLWJ5OiBKdWxpZW4gR3JhbGwgPGp1bGllbi5ncmFs
bEBhcm0uY29tPgoKLS0tCgpJIGhhdmVuJ3QgZG9uZSB0aGUgMzItYml0cyBwYXJ0IHlldC4gSSB3
YW50ZWQgdG8gZ2F0aGVyIGZlZWRiYWNrIGJlZm9yZQpsb29raW5nIGluIGRldGFpbHMgaG93IHRv
IGludGVncmF0ZSB0aGF0IHdpdGggQXJtMzIuCi0tLQogeGVuL2FyY2gvYXJtL2FybTY0L2VudHJ5
LlMgfCAgNCArKy0KIHhlbi9hcmNoL2FybS90cmFwcy5jICAgICAgIHwgNzEgKysrKysrKysrKysr
KysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogMiBmaWxlcyBjaGFuZ2VkLCAzNyBp
bnNlcnRpb25zKCspLCAzOCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC9hcm0v
YXJtNjQvZW50cnkuUyBiL3hlbi9hcmNoL2FybS9hcm02NC9lbnRyeS5TCmluZGV4IDQwZDlmM2Vj
OGMuLjllYWZhZTUxNmIgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL2FybS9hcm02NC9lbnRyeS5TCisr
KyBiL3hlbi9hcmNoL2FybS9hcm02NC9lbnRyeS5TCkBAIC0xNDcsNyArMTQ3LDcgQEAKIAogICAg
ICAgICAuaWYgXGh5cCA9PSAwICAgICAgICAgLyogR3Vlc3QgbW9kZSAqLwogCi0gICAgICAgIGJs
ICAgICAgbGVhdmVfaHlwZXJ2aXNvcl90YWlsIC8qIERpc2FibGVzIGludGVycnVwdHMgb24gcmV0
dXJuICovCisgICAgICAgIGJsICAgICAgbGVhdmVfaHlwZXJ2aXNvcl90b19ndWVzdCAvKiBEaXNh
YmxlcyBpbnRlcnJ1cHRzIG9uIHJldHVybiAqLwogCiAgICAgICAgIGV4aXRfZ3Vlc3QgXGNvbXBh
dAogCkBAIC0xNzUsNiArMTc1LDggQEAKICAgICAgICAgICAgICAgICAgICAgU0tJUF9TWU5DSFJP
TklaRV9TRVJST1JfRU5UUllfRVhJVCkKICAgICAgICAgbXNyICAgICBkYWlmY2xyLCBcaWZsYWdz
CiAgICAgICAgIG1vdiAgICAgeDAsIHNwCisgICAgICAgIGJsICAgICAgZW50ZXJfaHlwZXJ2aXNv
cl9mcm9tX2d1ZXN0CisgICAgICAgIG1vdiAgICAgeDAsIHNwCiAgICAgICAgIGJsICAgICAgZG9f
dHJhcF9cdHJhcAogMToKICAgICAgICAgZXhpdCAgICBoeXA9MCwgY29tcGF0PVxjb21wYXQKZGlm
ZiAtLWdpdCBhL3hlbi9hcmNoL2FybS90cmFwcy5jIGIveGVuL2FyY2gvYXJtL3RyYXBzLmMKaW5k
ZXggYTNiOTYxYmQwNi4uMjBiYTM0ZWM5MSAxMDA2NDQKLS0tIGEveGVuL2FyY2gvYXJtL3RyYXBz
LmMKKysrIGIveGVuL2FyY2gvYXJtL3RyYXBzLmMKQEAgLTIwMDYsNDcgKzIwMDYsNDYgQEAgc3Rh
dGljIGlubGluZSBib29sIG5lZWRzX3NzYmRfZmxpcChzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAg
ICAgICBjcHVfcmVxdWlyZV9zc2JkX21pdGlnYXRpb24oKTsKIH0KIAotc3RhdGljIHZvaWQgZW50
ZXJfaHlwZXJ2aXNvcl9oZWFkKHN0cnVjdCBjcHVfdXNlcl9yZWdzICpyZWdzKQorLyoKKyAqIEFj
dGlvbnMgdGhhdCBuZWVkcyB0byBiZSBkb25lIGFmdGVyIGV4aXRpbmcgdGhlIGd1ZXN0IGFuZCBi
ZWZvcmUgYW55CisgKiByZXF1ZXN0IGZyb20gaXQgaXMgaGFuZGxlZC4KKyAqLwordm9pZCBlbnRl
cl9oeXBlcnZpc29yX2Zyb21fZ3Vlc3Qoc3RydWN0IGNwdV91c2VyX3JlZ3MgKnJlZ3MpCiB7Ci0g
ICAgaWYgKCBndWVzdF9tb2RlKHJlZ3MpICkKLSAgICB7Ci0gICAgICAgIHN0cnVjdCB2Y3B1ICp2
ID0gY3VycmVudDsKKyAgICBzdHJ1Y3QgdmNwdSAqdiA9IGN1cnJlbnQ7CiAKLSAgICAgICAgLyog
SWYgdGhlIGd1ZXN0IGhhcyBkaXNhYmxlZCB0aGUgd29ya2Fyb3VuZCwgYnJpbmcgaXQgYmFjayBv
bi4gKi8KLSAgICAgICAgaWYgKCBuZWVkc19zc2JkX2ZsaXAodikgKQotICAgICAgICAgICAgYXJt
X3NtY2NjXzFfMV9zbWMoQVJNX1NNQ0NDX0FSQ0hfV09SS0FST1VORF8yX0ZJRCwgMSwgTlVMTCk7
CisgICAgLyogSWYgdGhlIGd1ZXN0IGhhcyBkaXNhYmxlZCB0aGUgd29ya2Fyb3VuZCwgYnJpbmcg
aXQgYmFjayBvbi4gKi8KKyAgICBpZiAoIG5lZWRzX3NzYmRfZmxpcCh2KSApCisgICAgICAgIGFy
bV9zbWNjY18xXzFfc21jKEFSTV9TTUNDQ19BUkNIX1dPUktBUk9VTkRfMl9GSUQsIDEsIE5VTEwp
OwogCi0gICAgICAgIC8qCi0gICAgICAgICAqIElmIHdlIHBlbmRlZCBhIHZpcnR1YWwgYWJvcnQs
IHByZXNlcnZlIGl0IHVudGlsIGl0IGdldHMgY2xlYXJlZC4KLSAgICAgICAgICogU2VlIEFSTSBB
Uk0gRERJIDA0ODdBLmogRDEuMTQuMyAoVmlydHVhbCBJbnRlcnJ1cHRzKSBmb3IgZGV0YWlscywK
LSAgICAgICAgICogYnV0IHRoZSBjcnVjaWFsIGJpdCBpcyAiT24gdGFraW5nIGEgdlNFcnJvciBp
bnRlcnJ1cHQsIEhDUl9FTDIuVlNFCi0gICAgICAgICAqIChhbGlhcyBvZiBIQ1IuVkEpIGlzIGNs
ZWFyZWQgdG8gMC4iCi0gICAgICAgICAqLwotICAgICAgICBpZiAoIHYtPmFyY2guaGNyX2VsMiAm
IEhDUl9WQSApCi0gICAgICAgICAgICB2LT5hcmNoLmhjcl9lbDIgPSBSRUFEX1NZU1JFRyhIQ1Jf
RUwyKTsKKyAgICAvKgorICAgICAqIElmIHdlIHBlbmRlZCBhIHZpcnR1YWwgYWJvcnQsIHByZXNl
cnZlIGl0IHVudGlsIGl0IGdldHMgY2xlYXJlZC4KKyAgICAgKiBTZWUgQVJNIEFSTSBEREkgMDQ4
N0EuaiBEMS4xNC4zIChWaXJ0dWFsIEludGVycnVwdHMpIGZvciBkZXRhaWxzLAorICAgICAqIGJ1
dCB0aGUgY3J1Y2lhbCBiaXQgaXMgIk9uIHRha2luZyBhIHZTRXJyb3IgaW50ZXJydXB0LCBIQ1Jf
RUwyLlZTRQorICAgICAqIChhbGlhcyBvZiBIQ1IuVkEpIGlzIGNsZWFyZWQgdG8gMC4iCisgICAg
ICovCisgICAgaWYgKCB2LT5hcmNoLmhjcl9lbDIgJiBIQ1JfVkEgKQorICAgICAgICB2LT5hcmNo
Lmhjcl9lbDIgPSBSRUFEX1NZU1JFRyhIQ1JfRUwyKTsKIAogI2lmZGVmIENPTkZJR19ORVdfVkdJ
QwotICAgICAgICAvKgotICAgICAgICAgKiBXZSBuZWVkIHRvIHVwZGF0ZSB0aGUgc3RhdGUgb2Yg
b3VyIGVtdWxhdGVkIGRldmljZXMgdXNpbmcgbGV2ZWwKLSAgICAgICAgICogdHJpZ2dlcmVkIGlu
dGVycnVwdHMgYmVmb3JlIHN5bmNpbmcgYmFjayB0aGUgVkdJQyBzdGF0ZS4KLSAgICAgICAgICoK
LSAgICAgICAgICogVE9ETzogSW52ZXN0aWdhdGUgd2hldGhlciB0aGlzIGlzIG5lY2Vzc2FyeSB0
byBkbyBvbiBldmVyeQotICAgICAgICAgKiB0cmFwIGFuZCBob3cgaXQgY2FuIGJlIG9wdGltaXNl
ZC4KLSAgICAgICAgICovCi0gICAgICAgIHZ0aW1lcl91cGRhdGVfaXJxcyh2KTsKLSAgICAgICAg
dmNwdV91cGRhdGVfZXZ0Y2huX2lycSh2KTsKKyAgICAvKgorICAgICAqIFdlIG5lZWQgdG8gdXBk
YXRlIHRoZSBzdGF0ZSBvZiBvdXIgZW11bGF0ZWQgZGV2aWNlcyB1c2luZyBsZXZlbAorICAgICAq
IHRyaWdnZXJlZCBpbnRlcnJ1cHRzIGJlZm9yZSBzeW5jaW5nIGJhY2sgdGhlIFZHSUMgc3RhdGUu
CisgICAgICoKKyAgICAgKiBUT0RPOiBJbnZlc3RpZ2F0ZSB3aGV0aGVyIHRoaXMgaXMgbmVjZXNz
YXJ5IHRvIGRvIG9uIGV2ZXJ5CisgICAgICogdHJhcCBhbmQgaG93IGl0IGNhbiBiZSBvcHRpbWlz
ZWQuCisgICAgICovCisgICAgdnRpbWVyX3VwZGF0ZV9pcnFzKHYpOworICAgIHZjcHVfdXBkYXRl
X2V2dGNobl9pcnEodik7CiAjZW5kaWYKIAotICAgICAgICB2Z2ljX3N5bmNfZnJvbV9scnModik7
Ci0gICAgfQorICAgIHZnaWNfc3luY19mcm9tX2xycyh2KTsKIH0KIAogdm9pZCBkb190cmFwX2d1
ZXN0X3N5bmMoc3RydWN0IGNwdV91c2VyX3JlZ3MgKnJlZ3MpCiB7CiAgICAgY29uc3QgdW5pb24g
aHNyIGhzciA9IHsgLmJpdHMgPSByZWdzLT5oc3IgfTsKIAotICAgIGVudGVyX2h5cGVydmlzb3Jf
aGVhZChyZWdzKTsKLQogICAgIHN3aXRjaCAoIGhzci5lYyApCiAgICAgewogICAgIGNhc2UgSFNS
X0VDX1dGSV9XRkU6CkBAIC0yMTgwLDggKzIxNzksNiBAQCB2b2lkIGRvX3RyYXBfaHlwX3N5bmMo
c3RydWN0IGNwdV91c2VyX3JlZ3MgKnJlZ3MpCiB7CiAgICAgY29uc3QgdW5pb24gaHNyIGhzciA9
IHsgLmJpdHMgPSByZWdzLT5oc3IgfTsKIAotICAgIGVudGVyX2h5cGVydmlzb3JfaGVhZChyZWdz
KTsKLQogICAgIHN3aXRjaCAoIGhzci5lYyApCiAgICAgewogI2lmZGVmIENPTkZJR19BUk1fNjQK
QEAgLTIyMTgsMjcgKzIyMTUsMjEgQEAgdm9pZCBkb190cmFwX2h5cF9zeW5jKHN0cnVjdCBjcHVf
dXNlcl9yZWdzICpyZWdzKQogCiB2b2lkIGRvX3RyYXBfaHlwX3NlcnJvcihzdHJ1Y3QgY3B1X3Vz
ZXJfcmVncyAqcmVncykKIHsKLSAgICBlbnRlcl9oeXBlcnZpc29yX2hlYWQocmVncyk7Ci0KICAg
ICBfX2RvX3RyYXBfc2Vycm9yKHJlZ3MsIFZBQk9SVF9HRU5fQllfR1VFU1QocmVncykpOwogfQog
CiB2b2lkIGRvX3RyYXBfZ3Vlc3Rfc2Vycm9yKHN0cnVjdCBjcHVfdXNlcl9yZWdzICpyZWdzKQog
ewotICAgIGVudGVyX2h5cGVydmlzb3JfaGVhZChyZWdzKTsKLQogICAgIF9fZG9fdHJhcF9zZXJy
b3IocmVncywgdHJ1ZSk7CiB9CiAKIHZvaWQgZG9fdHJhcF9pcnEoc3RydWN0IGNwdV91c2VyX3Jl
Z3MgKnJlZ3MpCiB7Ci0gICAgZW50ZXJfaHlwZXJ2aXNvcl9oZWFkKHJlZ3MpOwogICAgIGdpY19p
bnRlcnJ1cHQocmVncywgMCk7CiB9CiAKIHZvaWQgZG9fdHJhcF9maXEoc3RydWN0IGNwdV91c2Vy
X3JlZ3MgKnJlZ3MpCiB7Ci0gICAgZW50ZXJfaHlwZXJ2aXNvcl9oZWFkKHJlZ3MpOwogICAgIGdp
Y19pbnRlcnJ1cHQocmVncywgMSk7CiB9CiAKQEAgLTIyODEsNyArMjI3MiwxMyBAQCBzdGF0aWMg
dm9pZCBjaGVja19mb3JfdmNwdV93b3JrKHZvaWQpCiAgICAgbG9jYWxfaXJxX2Rpc2FibGUoKTsK
IH0KIAotdm9pZCBsZWF2ZV9oeXBlcnZpc29yX3RhaWwodm9pZCkKKy8qCisgKiBBY3Rpb25zIHRo
YXQgbmVlZHMgdG8gYmUgZG9uZSBiZWZvcmUgZW50ZXJpbmcgdGhlIGd1ZXN0LiBUaGlzIGlzIHRo
ZQorICogbGFzdCB0aGluZyBleGVjdXRlZCBiZWZvcmUgdGhlIGd1ZXN0IGNvbnRleHQgaXMgZnVs
bHkgcmVzdG9yZWQuCisgKgorICogVGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHdpdGggaW50ZXJy
dXB0cyBkaXNhYmxlZC4KKyAqLwordm9pZCBsZWF2ZV9oeXBlcnZpc29yX3RvX2d1ZXN0KHZvaWQp
CiB7CiAgICAgbG9jYWxfaXJxX2Rpc2FibGUoKTsKIAotLSAKMi4xMS4wCgoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlz
dApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id CEA7DB2AB6
	for <lists+xen-devel@lfdr.de>; Sat, 14 Sep 2019 10:57:14 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i93ph-0002FV-TL; Sat, 14 Sep 2019 08:55:05 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=rDpt=XJ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1i93pf-0002Ci-Sa
 for xen-devel@lists.xenproject.org; Sat, 14 Sep 2019 08:55:03 +0000
X-Inumbo-ID: 1320bd48-d6cd-11e9-95c1-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 1320bd48-d6cd-11e9-95c1-12813bfff9fa;
 Sat, 14 Sep 2019 08:53:09 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 9D32AB66A;
 Sat, 14 Sep 2019 08:53:08 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Sat, 14 Sep 2019 10:52:48 +0200
Message-Id: <20190914085251.18816-45-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190914085251.18816-1-jgross@suse.com>
References: <20190914085251.18816-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v3 44/47] xen/sched: support differing
 granularity in schedule_cpu_[add/rm]()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2l0aCBjb3JlIHNjaGVkdWxpbmcgYWN0aXZlIHNjaGVkdWxlX2NwdV9bYWRkL3JtXSgpIGhhcyB0
byBjb3BlIHdpdGgKZGlmZmVyZW50IHNjaGVkdWxpbmcgZ3JhbnVsYXJpdHk6IGEgY3B1IG5vdCBp
biBhbnkgY3B1cG9vbCBpcyBzdWJqZWN0CnRvIGdyYW51bGFyaXR5IDEgKGNwdSBzY2hlZHVsaW5n
KSwgd2hpbGUgYSBjcHUgaW4gYSBjcHVwb29sIG1pZ2h0IGJlCmluIGEgc2NoZWR1bGluZyByZXNv
dXJjZSB3aXRoIG1vcmUgdGhhbiBvbmUgY3B1LgoKSGFuZGxlIHRoYXQgYnkgaGF2aW5nIGFycmF5
cyBvZiBvbGQvbmV3IHBkYXRhIGFuZCB2ZGF0YSBhbmQgbG9vcCBvdmVyCnRob3NlIHdoZXJlIGFw
cHJvcHJpYXRlLgoKQWRkaXRpb25hbGx5IHRoZSBzY2hlZHVsaW5nIHJlc291cmNlKHMpIG11c3Qg
ZWl0aGVyIGJlIG1lcmdlZCBvcgpzcGxpdC4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3Mg
PGpncm9zc0BzdXNlLmNvbT4KLS0tCiB4ZW4vY29tbW9uL2NwdXBvb2wuYyAgfCAgMTggKystLQog
eGVuL2NvbW1vbi9zY2hlZHVsZS5jIHwgMjI2ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKystLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDIwNCBpbnNlcnRpb25zKCsp
LCA0MCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL2NwdXBvb2wuYyBiL3hl
bi9jb21tb24vY3B1cG9vbC5jCmluZGV4IGY1M2NlZWMzYWIuLmFkYTNhN2U4MjQgMTAwNjQ0Ci0t
LSBhL3hlbi9jb21tb24vY3B1cG9vbC5jCisrKyBiL3hlbi9jb21tb24vY3B1cG9vbC5jCkBAIC01
MzEsNiArNTMxLDcgQEAgc3RhdGljIHZvaWQgY3B1cG9vbF9jcHVfcmVtb3ZlKHVuc2lnbmVkIGlu
dCBjcHUpCiAgICAgICAgIHJldCA9IGNwdXBvb2xfdW5hc3NpZ25fY3B1X2ZpbmlzaChjcHVwb29s
MCk7CiAgICAgICAgIEJVR19PTihyZXQpOwogICAgIH0KKyAgICBjcHVtYXNrX2NsZWFyX2NwdShj
cHUsICZjcHVwb29sX2ZyZWVfY3B1cyk7CiB9CiAKIC8qCkBAIC01ODAsMjAgKzU4MSwxOSBAQCBz
dGF0aWMgdm9pZCBjcHVwb29sX2NwdV9yZW1vdmVfZm9yY2VkKHVuc2lnbmVkIGludCBjcHUpCiAg
ICAgc3RydWN0IGNwdXBvb2wgKipjOwogICAgIGludCByZXQ7CiAKLSAgICBpZiAoIGNwdW1hc2tf
dGVzdF9jcHUoY3B1LCAmY3B1cG9vbF9mcmVlX2NwdXMpICkKLSAgICAgICAgY3B1bWFza19jbGVh
cl9jcHUoY3B1LCAmY3B1cG9vbF9mcmVlX2NwdXMpOwotICAgIGVsc2UKKyAgICBmb3JfZWFjaF9j
cHVwb29sICggYyApCiAgICAgewotICAgICAgICBmb3JfZWFjaF9jcHVwb29sKGMpCisgICAgICAg
IGlmICggY3B1bWFza190ZXN0X2NwdShjcHUsICgqYyktPmNwdV92YWxpZCkgKQogICAgICAgICB7
Ci0gICAgICAgICAgICBpZiAoIGNwdW1hc2tfdGVzdF9jcHUoY3B1LCAoKmMpLT5jcHVfdmFsaWQp
ICkKLSAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAgICByZXQgPSBjcHVwb29sX3VuYXNzaWdu
X2NwdSgqYywgY3B1KTsKLSAgICAgICAgICAgICAgICBCVUdfT04ocmV0KTsKLSAgICAgICAgICAg
IH0KKyAgICAgICAgICAgIHJldCA9IGNwdXBvb2xfdW5hc3NpZ25fY3B1X3N0YXJ0KCpjLCBjcHUp
OworICAgICAgICAgICAgQlVHX09OKHJldCk7CisgICAgICAgICAgICByZXQgPSBjcHVwb29sX3Vu
YXNzaWduX2NwdV9maW5pc2goKmMpOworICAgICAgICAgICAgQlVHX09OKHJldCk7CiAgICAgICAg
IH0KICAgICB9CiAKKyAgICBjcHVtYXNrX2NsZWFyX2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1
cyk7CisKICAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAgICAgc2NoZWRf
cm1fY3B1KGNwdSk7CiAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CmRp
ZmYgLS1naXQgYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMK
aW5kZXggODgyYjNiYWY0Mi4uNGQ1NmNkOTA3ZiAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hl
ZHVsZS5jCisrKyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwpAQCAtNDA0LDI3ICs0MDQsMzAgQEAg
c3RhdGljIHZvaWQgc2NoZWRfdW5pdF9hZGRfdmNwdShzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwg
c3RydWN0IHZjcHUgKnYpCiAgICAgdW5pdC0+cnVuc3RhdGVfY250W3YtPnJ1bnN0YXRlLnN0YXRl
XSsrOwogfQogCi1zdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQgKnNjaGVkX2FsbG9jX3VuaXQoc3Ry
dWN0IHZjcHUgKnYpCitzdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQgKnNjaGVkX2FsbG9jX3VuaXRf
bWVtKHZvaWQpCiB7Ci0gICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsICoqcHJldl91bml0Owot
ICAgIHN0cnVjdCBkb21haW4gKmQgPSB2LT5kb21haW47Ci0gICAgdW5zaWduZWQgaW50IGdyYW4g
PSBkLT5jcHVwb29sID8gZC0+Y3B1cG9vbC0+Z3JhbnVsYXJpdHkgOiAxOworICAgIHN0cnVjdCBz
Y2hlZF91bml0ICp1bml0OwogCi0gICAgZm9yX2VhY2hfc2NoZWRfdW5pdCAoIGQsIHVuaXQgKQot
ICAgICAgICBpZiAoIHVuaXQtPnZjcHVfbGlzdC0+dmNwdV9pZCAvIGdyYW4gPT0gdi0+dmNwdV9p
ZCAvIGdyYW4gKQotICAgICAgICAgICAgYnJlYWs7CisgICAgdW5pdCA9IHh6YWxsb2Moc3RydWN0
IHNjaGVkX3VuaXQpOworICAgIGlmICggIXVuaXQgKQorICAgICAgICByZXR1cm4gTlVMTDsKIAot
ICAgIGlmICggdW5pdCApCisgICAgaWYgKCAhemFsbG9jX2NwdW1hc2tfdmFyKCZ1bml0LT5jcHVf
aGFyZF9hZmZpbml0eSkgfHwKKyAgICAgICAgICF6YWxsb2NfY3B1bWFza192YXIoJnVuaXQtPmNw
dV9oYXJkX2FmZmluaXR5X3NhdmVkKSB8fAorICAgICAgICAgIXphbGxvY19jcHVtYXNrX3Zhcigm
dW5pdC0+Y3B1X3NvZnRfYWZmaW5pdHkpICkKICAgICB7Ci0gICAgICAgIHNjaGVkX3VuaXRfYWRk
X3ZjcHUodW5pdCwgdik7Ci0gICAgICAgIHJldHVybiB1bml0OworICAgICAgICBzY2hlZF9mcmVl
X3VuaXRfbWVtKHVuaXQpOworICAgICAgICB1bml0ID0gTlVMTDsKICAgICB9CiAKLSAgICBpZiAo
ICh1bml0ID0geHphbGxvYyhzdHJ1Y3Qgc2NoZWRfdW5pdCkpID09IE5VTEwgKQotICAgICAgICBy
ZXR1cm4gTlVMTDsKKyAgICByZXR1cm4gdW5pdDsKK30KKworc3RhdGljIHZvaWQgc2NoZWRfZG9t
YWluX2luc2VydF91bml0KHN0cnVjdCBzY2hlZF91bml0ICp1bml0LCBzdHJ1Y3QgZG9tYWluICpk
KQoreworICAgIHN0cnVjdCBzY2hlZF91bml0ICoqcHJldl91bml0OwogCiAgICAgdW5pdC0+ZG9t
YWluID0gZDsKLSAgICBzY2hlZF91bml0X2FkZF92Y3B1KHVuaXQsIHYpOwogCiAgICAgZm9yICgg
cHJldl91bml0ID0gJmQtPnNjaGVkX3VuaXRfbGlzdDsgKnByZXZfdW5pdDsKICAgICAgICAgICBw
cmV2X3VuaXQgPSAmKCpwcmV2X3VuaXQpLT5uZXh0X2luX2xpc3QgKQpAQCAtNDM0LDE3ICs0Mzcs
MzEgQEAgc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9hbGxvY191bml0KHN0cnVjdCB2
Y3B1ICp2KQogCiAgICAgdW5pdC0+bmV4dF9pbl9saXN0ID0gKnByZXZfdW5pdDsKICAgICAqcHJl
dl91bml0ID0gdW5pdDsKK30KIAotICAgIGlmICggIXphbGxvY19jcHVtYXNrX3ZhcigmdW5pdC0+
Y3B1X2hhcmRfYWZmaW5pdHkpIHx8Ci0gICAgICAgICAhemFsbG9jX2NwdW1hc2tfdmFyKCZ1bml0
LT5jcHVfaGFyZF9hZmZpbml0eV9zYXZlZCkgfHwKLSAgICAgICAgICF6YWxsb2NfY3B1bWFza192
YXIoJnVuaXQtPmNwdV9zb2Z0X2FmZmluaXR5KSApCi0gICAgICAgIGdvdG8gZmFpbDsKK3N0YXRp
YyBzdHJ1Y3Qgc2NoZWRfdW5pdCAqc2NoZWRfYWxsb2NfdW5pdChzdHJ1Y3QgdmNwdSAqdikKK3sK
KyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdDsKKyAgICBzdHJ1Y3QgZG9tYWluICpkID0gdi0+
ZG9tYWluOworICAgIHVuc2lnbmVkIGludCBncmFuID0gZC0+Y3B1cG9vbCA/IGQtPmNwdXBvb2wt
PmdyYW51bGFyaXR5IDogMTsKIAotICAgIHJldHVybiB1bml0OworICAgIGZvcl9lYWNoX3NjaGVk
X3VuaXQgKCBkLCB1bml0ICkKKyAgICAgICAgaWYgKCB1bml0LT52Y3B1X2xpc3QtPnZjcHVfaWQg
LyBncmFuID09IHYtPnZjcHVfaWQgLyBncmFuICkKKyAgICAgICAgICAgIGJyZWFrOwogCi0gZmFp
bDoKLSAgICBzY2hlZF9mcmVlX3VuaXQodW5pdCwgdik7Ci0gICAgcmV0dXJuIE5VTEw7CisgICAg
aWYgKCB1bml0ICkKKyAgICB7CisgICAgICAgIHNjaGVkX3VuaXRfYWRkX3ZjcHUodW5pdCwgdik7
CisgICAgICAgIHJldHVybiB1bml0OworICAgIH0KKworICAgIGlmICggKHVuaXQgPSBzY2hlZF9h
bGxvY191bml0X21lbSgpKSA9PSBOVUxMICkKKyAgICAgICAgcmV0dXJuIE5VTEw7CisKKyAgICBz
Y2hlZF91bml0X2FkZF92Y3B1KHVuaXQsIHYpOworICAgIHNjaGVkX2RvbWFpbl9pbnNlcnRfdW5p
dCh1bml0LCBkKTsKKworICAgIHJldHVybiB1bml0OwogfQogCiBzdGF0aWMgdW5zaWduZWQgaW50
IHNjaGVkX3NlbGVjdF9pbml0aWFsX2NwdShjb25zdCBzdHJ1Y3QgdmNwdSAqdikKQEAgLTIzODEs
MTggKzIzOTgsMjggQEAgc3RhdGljIHZvaWQgcG9sbF90aW1lcl9mbih2b2lkICpkYXRhKQogICAg
ICAgICB2Y3B1X3VuYmxvY2sodik7CiB9CiAKLXN0YXRpYyBpbnQgY3B1X3NjaGVkdWxlX3VwKHVu
c2lnbmVkIGludCBjcHUpCitzdGF0aWMgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzY2hlZF9hbGxv
Y19yZXModm9pZCkKIHsKICAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkOwogCiAgICAgc2Qg
PSB4emFsbG9jKHN0cnVjdCBzY2hlZF9yZXNvdXJjZSk7CiAgICAgaWYgKCBzZCA9PSBOVUxMICkK
LSAgICAgICAgcmV0dXJuIC1FTk9NRU07CisgICAgICAgIHJldHVybiBOVUxMOwogICAgIGlmICgg
IXphbGxvY19jcHVtYXNrX3Zhcigmc2QtPmNwdXMpICkKICAgICB7CiAgICAgICAgIHhmcmVlKHNk
KTsKLSAgICAgICAgcmV0dXJuIC1FTk9NRU07CisgICAgICAgIHJldHVybiBOVUxMOwogICAgIH0K
KyAgICByZXR1cm4gc2Q7Cit9CisKK3N0YXRpYyBpbnQgY3B1X3NjaGVkdWxlX3VwKHVuc2lnbmVk
IGludCBjcHUpCit7CisgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzZDsKKworICAgIHNkID0g
c2NoZWRfYWxsb2NfcmVzKCk7CisgICAgaWYgKCBzZCA9PSBOVUxMICkKKyAgICAgICAgcmV0dXJu
IC1FTk9NRU07CiAKICAgICBzZC0+bWFzdGVyX2NwdSA9IGNwdTsKICAgICBjcHVtYXNrX2NvcHko
c2QtPmNwdXMsIGNwdW1hc2tfb2YoY3B1KSk7CkBAIC0yNDQyLDYgKzI0NjksOCBAQCBzdGF0aWMg
dm9pZCBzY2hlZF9yZXNfZnJlZShzdHJ1Y3QgcmN1X2hlYWQgKmhlYWQpCiAgICAgc3RydWN0IHNj
aGVkX3Jlc291cmNlICpzZCA9IGNvbnRhaW5lcl9vZihoZWFkLCBzdHJ1Y3Qgc2NoZWRfcmVzb3Vy
Y2UsIHJjdSk7CiAKICAgICBmcmVlX2NwdW1hc2tfdmFyKHNkLT5jcHVzKTsKKyAgICBpZiAoIHNk
LT5zY2hlZF91bml0X2lkbGUgKQorICAgICAgICBzY2hlZF9mcmVlX3VuaXRfbWVtKHNkLT5zY2hl
ZF91bml0X2lkbGUpOwogICAgIHhmcmVlKHNkKTsKIH0KIApAQCAtMjQ1Niw2ICsyNDg1LDggQEAg
c3RhdGljIHZvaWQgY3B1X3NjaGVkdWxlX2Rvd24odW5zaWduZWQgaW50IGNwdSkKICAgICBraWxs
X3RpbWVyKCZzZC0+c190aW1lcik7CiAKICAgICBzZXRfc2NoZWRfcmVzKGNwdSwgTlVMTCk7Cisg
ICAgLyogS2VlcCBpZGxlIHVuaXQuICovCisgICAgc2QtPnNjaGVkX3VuaXRfaWRsZSA9IE5VTEw7
CiAgICAgY2FsbF9yY3UoJnNkLT5yY3UsIHNjaGVkX3Jlc19mcmVlKTsKIAogICAgIHJjdV9yZWFk
X3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwpAQCAtMjUzNSw2ICsyNTY2LDMwIEBAIHN0YXRp
YyBzdHJ1Y3Qgbm90aWZpZXJfYmxvY2sgY3B1X3NjaGVkdWxlX25mYiA9IHsKICAgICAubm90aWZp
ZXJfY2FsbCA9IGNwdV9zY2hlZHVsZV9jYWxsYmFjawogfTsKIAorc3RhdGljIGNvbnN0IGNwdW1h
c2tfdCAqc2NoZWRfZ2V0X29wdF9jcHVtYXNrKGVudW0gc2NoZWRfZ3JhbiBvcHQsCisgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGNwdSkK
K3sKKyAgICBjb25zdCBjcHVtYXNrX3QgKm1hc2s7CisKKyAgICBzd2l0Y2ggKCBvcHQgKQorICAg
IHsKKyAgICBjYXNlIFNDSEVEX0dSQU5fY3B1OgorICAgICAgICBtYXNrID0gY3B1bWFza19vZihj
cHUpOworICAgICAgICBicmVhazsKKyAgICBjYXNlIFNDSEVEX0dSQU5fY29yZToKKyAgICAgICAg
bWFzayA9IHBlcl9jcHUoY3B1X3NpYmxpbmdfbWFzaywgY3B1KTsKKyAgICAgICAgYnJlYWs7Cisg
ICAgY2FzZSBTQ0hFRF9HUkFOX3NvY2tldDoKKyAgICAgICAgbWFzayA9IHBlcl9jcHUoY3B1X2Nv
cmVfbWFzaywgY3B1KTsKKyAgICAgICAgYnJlYWs7CisgICAgZGVmYXVsdDoKKyAgICAgICAgQVNT
RVJUX1VOUkVBQ0hBQkxFKCk7CisgICAgICAgIHJldHVybiBOVUxMOworICAgIH0KKworICAgIHJl
dHVybiBtYXNrOworfQorCiAvKiBJbml0aWFsaXNlIHRoZSBkYXRhIHN0cnVjdHVyZXMuICovCiB2
b2lkIF9faW5pdCBzY2hlZHVsZXJfaW5pdCh2b2lkKQogewpAQCAtMjY5Myw2ICsyNzQ4LDQ2IEBA
IGludCBzY2hlZHVsZV9jcHVfYWRkKHVuc2lnbmVkIGludCBjcHUsIHN0cnVjdCBjcHVwb29sICpj
KQogICAgICAqLwogICAgIG9sZF9sb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycXNhdmUoY3B1
LCAmZmxhZ3MpOwogCisgICAgaWYgKCBjLT5ncmFudWxhcml0eSA+IDEgKQorICAgIHsKKyAgICAg
ICAgY29uc3QgY3B1bWFza190ICptYXNrOworICAgICAgICB1bnNpZ25lZCBpbnQgY3B1X2l0ZXIs
IGlkeCA9IDA7CisgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICpvbGRfdW5pdCwgKm1hc3Rlcl91
bml0OworICAgICAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkX29sZDsKKworICAgICAgICAv
KgorICAgICAgICAgKiBXZSBuZWVkIHRvIG1lcmdlIG11bHRpcGxlIGlkbGVfdmNwdSB1bml0cyBh
bmQgc2NoZWRfcmVzb3VyY2Ugc3RydWN0cworICAgICAgICAgKiBpbnRvIG9uZS4gQXMgdGhlIGZy
ZWUgY3B1cyBhbGwgc2hhcmUgdGhlIHNhbWUgbG9jayB3ZSBhcmUgZmluZSBkb2luZworICAgICAg
ICAgKiB0aGF0IG5vdy4gVGhlIHdvcnN0IHdoaWNoIGNvdWxkIGhhcHBlbiB3b3VsZCBiZSBzb21l
b25lIHdhaXRpbmcgZm9yCisgICAgICAgICAqIHRoZSBsb2NrLCB0aHVzIGRlcmVmZXJlbmNpbmcg
c2NoZWRfcmVzLT5zY2hlZHVsZV9sb2NrLiBUaGlzIGlzIHRoZQorICAgICAgICAgKiByZWFzb24g
d2UgYXJlIGZyZWVpbmcgc3RydWN0IHNjaGVkX3JlcyB2aWEgY2FsbF9yY3UoKSB0byBhdm9pZCB0
aGUKKyAgICAgICAgICogbG9jayBwb2ludGVyIHN1ZGRlbmx5IGRpc2FwcGVhcmluZy4KKyAgICAg
ICAgICovCisgICAgICAgIG1hc2sgPSBzY2hlZF9nZXRfb3B0X2NwdW1hc2soYy0+b3B0X2dyYW51
bGFyaXR5LCBjcHUpOworICAgICAgICBtYXN0ZXJfdW5pdCA9IGlkbGVfdmNwdVtjcHVdLT5zY2hl
ZF91bml0OworCisgICAgICAgIGZvcl9lYWNoX2NwdSAoIGNwdV9pdGVyLCBtYXNrICkKKyAgICAg
ICAgeworICAgICAgICAgICAgaWYgKCBpZHggKQorICAgICAgICAgICAgICAgIGNwdW1hc2tfY2xl
YXJfY3B1KGNwdV9pdGVyLCBzY2hlZF9yZXNfbWFzayk7CisKKyAgICAgICAgICAgIHBlcl9jcHUo
c2NoZWRfcmVzX2lkeCwgY3B1X2l0ZXIpID0gaWR4Kys7CisKKyAgICAgICAgICAgIGlmICggY3B1
ID09IGNwdV9pdGVyICkKKyAgICAgICAgICAgICAgICBjb250aW51ZTsKKworICAgICAgICAgICAg
b2xkX3VuaXQgPSBpZGxlX3ZjcHVbY3B1X2l0ZXJdLT5zY2hlZF91bml0OworICAgICAgICAgICAg
c2Rfb2xkID0gZ2V0X3NjaGVkX3JlcyhjcHVfaXRlcik7CisgICAgICAgICAgICBraWxsX3RpbWVy
KCZzZF9vbGQtPnNfdGltZXIpOworICAgICAgICAgICAgaWRsZV92Y3B1W2NwdV9pdGVyXS0+c2No
ZWRfdW5pdCA9IG1hc3Rlcl91bml0OworICAgICAgICAgICAgbWFzdGVyX3VuaXQtPnJ1bnN0YXRl
X2NudFtSVU5TVEFURV9ydW5uaW5nXSsrOworICAgICAgICAgICAgc2V0X3NjaGVkX3JlcyhjcHVf
aXRlciwgc2QpOworICAgICAgICAgICAgY3B1bWFza19zZXRfY3B1KGNwdV9pdGVyLCBzZC0+Y3B1
cyk7CisKKyAgICAgICAgICAgIGNhbGxfcmN1KCZzZF9vbGQtPnJjdSwgc2NoZWRfcmVzX2ZyZWUp
OworICAgICAgICB9CisgICAgfQorCiAgICAgbmV3X2xvY2sgPSBzY2hlZF9zd2l0Y2hfc2NoZWQo
bmV3X29wcywgY3B1LCBwcHJpdiwgdnByaXYpOwogCiAgICAgc2QtPnNjaGVkdWxlciA9IG5ld19v
cHM7CkBAIC0yNzMwLDMzICsyODI1LDEwMCBAQCBvdXQ6CiAgKi8KIGludCBzY2hlZHVsZV9jcHVf
cm0odW5zaWduZWQgaW50IGNwdSkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqaWRsZTsKICAgICB2b2lk
ICpwcHJpdl9vbGQsICp2cHJpdl9vbGQ7Ci0gICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzZDsK
KyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkLCAqKnNkX25ldyA9IE5VTEw7CisgICAgc3Ry
dWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAgICAgc3RydWN0IHNjaGVkdWxlciAqb2xkX29wczsKICAg
ICBzcGlubG9ja190ICpvbGRfbG9jazsKICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOworICAgIGlu
dCBpZHgsIHJldCA9IC1FTk9NRU07CisgICAgdW5zaWduZWQgaW50IGNwdV9pdGVyOwogCiAgICAg
cmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogCiAgICAgc2QgPSBnZXRfc2NoZWRf
cmVzKGNwdSk7CiAgICAgb2xkX29wcyA9IHNkLT5zY2hlZHVsZXI7CiAKKyAgICBpZiAoIHNkLT5n
cmFudWxhcml0eSA+IDEgKQorICAgIHsKKyAgICAgICAgc2RfbmV3ID0geG1hbGxvY19hcnJheShz
dHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKiwgc2QtPmdyYW51bGFyaXR5IC0gMSk7CisgICAgICAgIGlm
ICggIXNkX25ldyApCisgICAgICAgICAgICBnb3RvIG91dDsKKyAgICAgICAgZm9yICggaWR4ID0g
MDsgaWR4IDwgc2QtPmdyYW51bGFyaXR5IC0gMTsgaWR4KysgKQorICAgICAgICB7CisgICAgICAg
ICAgICBzZF9uZXdbaWR4XSA9IHNjaGVkX2FsbG9jX3JlcygpOworICAgICAgICAgICAgaWYgKCBz
ZF9uZXdbaWR4XSApCisgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgc2RfbmV3W2lkeF0t
PnNjaGVkX3VuaXRfaWRsZSA9IHNjaGVkX2FsbG9jX3VuaXRfbWVtKCk7CisgICAgICAgICAgICAg
ICAgaWYgKCAhc2RfbmV3W2lkeF0tPnNjaGVkX3VuaXRfaWRsZSApCisgICAgICAgICAgICAgICAg
eworICAgICAgICAgICAgICAgICAgICBzY2hlZF9yZXNfZnJlZSgmc2RfbmV3W2lkeF0tPnJjdSk7
CisgICAgICAgICAgICAgICAgICAgIHNkX25ld1tpZHhdID0gTlVMTDsKKyAgICAgICAgICAgICAg
ICB9CisgICAgICAgICAgICB9CisgICAgICAgICAgICBpZiAoICFzZF9uZXdbaWR4XSApCisgICAg
ICAgICAgICB7CisgICAgICAgICAgICAgICAgZm9yICggaWR4LS07IGlkeCA+PSAwOyBpZHgtLSAp
CisgICAgICAgICAgICAgICAgICAgIHNjaGVkX3Jlc19mcmVlKCZzZF9uZXdbaWR4XS0+cmN1KTsK
KyAgICAgICAgICAgICAgICBnb3RvIG91dDsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIHNk
X25ld1tpZHhdLT5jdXJyID0gc2RfbmV3W2lkeF0tPnNjaGVkX3VuaXRfaWRsZTsKKyAgICAgICAg
ICAgIHNkX25ld1tpZHhdLT5zY2hlZHVsZXIgPSAmc2NoZWRfaWRsZV9vcHM7CisgICAgICAgICAg
ICBzZF9uZXdbaWR4XS0+Z3JhbnVsYXJpdHkgPSAxOworCisgICAgICAgICAgICAvKiBXZSB3YW50
IHRoZSBsb2NrIG5vdCB0byBjaGFuZ2Ugd2hlbiByZXBsYWNpbmcgdGhlIHJlc291cmNlLiAqLwor
ICAgICAgICAgICAgc2RfbmV3W2lkeF0tPnNjaGVkdWxlX2xvY2sgPSBzZC0+c2NoZWR1bGVfbG9j
azsKKyAgICAgICAgfQorICAgIH0KKworICAgIHJldCA9IDA7CiAgICAgQVNTRVJUKHNkLT5jcHVw
b29sICE9IE5VTEwpOwogICAgIEFTU0VSVChjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgJmNwdXBvb2xf
ZnJlZV9jcHVzKSk7CiAgICAgQVNTRVJUKCFjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgc2QtPmNwdXBv
b2wtPmNwdV92YWxpZCkpOwogCi0gICAgaWRsZSA9IGlkbGVfdmNwdVtjcHVdOwotCiAgICAgc2No
ZWRfZG9fdGlja19zdXNwZW5kKG9sZF9vcHMsIGNwdSk7CiAKICAgICAvKiBTZWUgY29tbWVudCBp
biBzY2hlZHVsZV9jcHVfYWRkKCkgcmVnYXJkaW5nIGxvY2sgc3dpdGNoaW5nLiAqLwogICAgIG9s
ZF9sb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycXNhdmUoY3B1LCAmZmxhZ3MpOwogCi0gICAg
dnByaXZfb2xkID0gaWRsZS0+c2NoZWRfdW5pdC0+cHJpdjsKKyAgICB2cHJpdl9vbGQgPSBpZGxl
X3ZjcHVbY3B1XS0+c2NoZWRfdW5pdC0+cHJpdjsKICAgICBwcHJpdl9vbGQgPSBzZC0+c2NoZWRf
cHJpdjsKIAotICAgIGlkbGUtPnNjaGVkX3VuaXQtPnByaXYgPSBOVUxMOworICAgIGlkeCA9IDA7
CisgICAgZm9yX2VhY2hfY3B1ICggY3B1X2l0ZXIsIHNkLT5jcHVzICkKKyAgICB7CisgICAgICAg
IHBlcl9jcHUoc2NoZWRfcmVzX2lkeCwgY3B1X2l0ZXIpID0gMDsKKyAgICAgICAgaWYgKCBjcHVf
aXRlciA9PSBjcHUgKQorICAgICAgICB7CisgICAgICAgICAgICBpZGxlX3ZjcHVbY3B1X2l0ZXJd
LT5zY2hlZF91bml0LT5wcml2ID0gTlVMTDsKKyAgICAgICAgfQorICAgICAgICBlbHNlCisgICAg
ICAgIHsKKyAgICAgICAgICAgIC8qIEluaXRpYWxpemUgdW5pdC4gKi8KKyAgICAgICAgICAgIHVu
aXQgPSBzZF9uZXdbaWR4XS0+c2NoZWRfdW5pdF9pZGxlOworICAgICAgICAgICAgdW5pdC0+cmVz
ID0gc2RfbmV3W2lkeF07CisgICAgICAgICAgICB1bml0LT5pc19ydW5uaW5nID0gdHJ1ZTsKKyAg
ICAgICAgICAgIHNjaGVkX3VuaXRfYWRkX3ZjcHUodW5pdCwgaWRsZV92Y3B1W2NwdV9pdGVyXSk7
CisgICAgICAgICAgICBzY2hlZF9kb21haW5faW5zZXJ0X3VuaXQodW5pdCwgaWRsZV92Y3B1W2Nw
dV9pdGVyXS0+ZG9tYWluKTsKKworICAgICAgICAgICAgLyogQWRqdXN0IGNwdSBtYXNrcyBvZiBy
ZXNvdXJjZXMgKG9sZCBhbmQgbmV3KS4gKi8KKyAgICAgICAgICAgIGNwdW1hc2tfY2xlYXJfY3B1
KGNwdV9pdGVyLCBzZC0+Y3B1cyk7CisgICAgICAgICAgICBjcHVtYXNrX3NldF9jcHUoY3B1X2l0
ZXIsIHNkX25ld1tpZHhdLT5jcHVzKTsKKworICAgICAgICAgICAgLyogSW5pdCB0aW1lci4gKi8K
KyAgICAgICAgICAgIGluaXRfdGltZXIoJnNkX25ld1tpZHhdLT5zX3RpbWVyLCBzX3RpbWVyX2Zu
LCBOVUxMLCBjcHVfaXRlcik7CisKKyAgICAgICAgICAgIC8qIExhc3QgcmVzb3VyY2UgaW5pdGlh
bGl6YXRpb25zIGFuZCBpbnNlcnQgcmVzb3VyY2UgcG9pbnRlci4gKi8KKyAgICAgICAgICAgIHNk
X25ld1tpZHhdLT5tYXN0ZXJfY3B1ID0gY3B1X2l0ZXI7CisgICAgICAgICAgICBzZXRfc2NoZWRf
cmVzKGNwdV9pdGVyLCBzZF9uZXdbaWR4XSk7CisKKyAgICAgICAgICAgIC8qIExhc3QgYWN0aW9u
OiBzZXQgdGhlIG5ldyBsb2NrIHBvaW50ZXIuICovCisgICAgICAgICAgICBzbXBfbWIoKTsKKyAg
ICAgICAgICAgIHNkX25ld1tpZHhdLT5zY2hlZHVsZV9sb2NrID0gJnNjaGVkX2ZyZWVfY3B1X2xv
Y2s7CisKKyAgICAgICAgICAgIGlkeCsrOworICAgICAgICB9CisgICAgfQogICAgIHNkLT5zY2hl
ZHVsZXIgPSAmc2NoZWRfaWRsZV9vcHM7CiAgICAgc2QtPnNjaGVkX3ByaXYgPSBOVUxMOwogCkBA
IC0yNzc0LDkgKzI5MzYsMTEgQEAgaW50IHNjaGVkdWxlX2NwdV9ybSh1bnNpZ25lZCBpbnQgY3B1
KQogICAgIHNkLT5ncmFudWxhcml0eSA9IDE7CiAgICAgc2QtPmNwdXBvb2wgPSBOVUxMOwogCitv
dXQ6CiAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisgICAgeGZyZWUo
c2RfbmV3KTsKIAotICAgIHJldHVybiAwOworICAgIHJldHVybiByZXQ7CiB9CiAKIHN0cnVjdCBz
Y2hlZHVsZXIgKnNjaGVkdWxlcl9nZXRfZGVmYXVsdCh2b2lkKQotLSAKMi4xNi40CgoKX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxp
bmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5w
cm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

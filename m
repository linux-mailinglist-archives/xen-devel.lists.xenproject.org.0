Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 1E096BFFBA
	for <lists+xen-devel@lfdr.de>; Fri, 27 Sep 2019 09:05:43 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDkGZ-0004R1-CV; Fri, 27 Sep 2019 07:02:11 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Rbpq=XW=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iDkGY-0004Q1-4s
 for xen-devel@lists.xenproject.org; Fri, 27 Sep 2019 07:02:10 +0000
X-Inumbo-ID: 92a6c32e-e0f4-11e9-966c-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 92a6c32e-e0f4-11e9-966c-12813bfff9fa;
 Fri, 27 Sep 2019 07:01:05 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id E6FE0AE1A;
 Fri, 27 Sep 2019 07:01:02 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 27 Sep 2019 09:00:32 +0200
Message-Id: <20190927070050.12405-29-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190927070050.12405-1-jgross@suse.com>
References: <20190927070050.12405-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v4 28/46] xen/sched: add code to sync scheduling
 of all vcpus of a sched unit
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>,
 Dario Faggioli <dfaggioli@suse.com>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiBzd2l0Y2hpbmcgc2NoZWQgdW5pdHMgc3luY2hyb25pemUgYWxsIHZjcHVzIG9mIHRoZSBu
ZXcgdW5pdCB0byBiZQpzY2hlZHVsZWQgYXQgdGhlIHNhbWUgdGltZS4KCkEgdmFyaWFibGUgc2No
ZWRfZ3JhbnVsYXJpdHkgaXMgYWRkZWQgd2hpY2ggaG9sZHMgdGhlIG51bWJlciBvZiB2Y3B1cwpw
ZXIgc2NoZWR1bGUgdW5pdC4KCkFzIHRhc2tsZXRzIHJlcXVpcmUgdG8gc2NoZWR1bGUgdGhlIGlk
bGUgdW5pdCBpdCBpcyByZXF1aXJlZCB0byBzZXQgdGhlCnRhc2tsZXRfd29ya19zY2hlZHVsZWQg
cGFyYW1ldGVyIG9mIGRvX3NjaGVkdWxlKCkgdG8gdHJ1ZSBpZiBhbnkgY3B1CmNvdmVyZWQgYnkg
dGhlIGN1cnJlbnQgc2NoZWR1bGUoKSBjYWxsIGhhcyBhbnkgcGVuZGluZyB0YXNrbGV0IHdvcmsu
CgpGb3Igam9pbmluZyBvdGhlciB2Y3B1cyBvZiB0aGUgc2NoZWR1bGUgdW5pdCB3ZSBuZWVkIHRv
IGFkZCBhIG5ldwpzb2Z0aXJxIFNDSEVEX1NMQVZFX1NPRlRJUlEgaW4gb3JkZXIgdG8gaGF2ZSBh
IHdheSB0byBpbml0aWF0ZSBhCmNvbnRleHQgc3dpdGNoIHdpdGhvdXQgY2FsbGluZyB0aGUgZ2Vu
ZXJpYyBzY2hlZHVsZSgpIGZ1bmN0aW9uCnNlbGVjdGluZyB0aGUgdmNwdSB0byBzd2l0Y2ggdG8s
IGFzIHdlIGFscmVhZHkga25vdyB3aGljaCB2Y3B1IHdlCndhbnQgdG8gcnVuLiBUaGlzIGhhcyB0
aGUgb3RoZXIgYWR2YW50YWdlIG5vdCB0byBsb29zZSBhbnkgb3RoZXIKY29uY3VycmVudCBTQ0hF
RFVMRV9TT0ZUSVJRIGV2ZW50cy4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9z
c0BzdXNlLmNvbT4KLS0tClJGQyBWMjoKLSBtb3ZlIHN5bmNpbmcgYWZ0ZXIgY29udGV4dF9zd2l0
Y2goKSB0byBzY2hlZHVsZS5jClYyOgotIGRvbid0IHJ1biB0YXNrbGV0cyBkaXJlY3RseSBmcm9t
IHNjaGVkX3dhaXRfcmVuZGV6dm91c19pbigpClYzOgotIGFkYXB0IGFycmF5IHNpemUgaW4gc2No
ZWRfbW92ZV9kb21haW4oKSAoSmFuIEJldWxpY2gpCi0gaW50IC0+IHVuc2lnbmVkIGludCAoSmFu
IEJldWxpY2gpClY0OgotIHJlbmFtZWQgc2QgdG8gc3IgaW4gc2V2ZXJhbCBwbGFjZXMgKEphbiBC
ZXVsaWNoKQotIHN3YXAgc3RvcF90aW1lcigpIGFuZCBOT1coKSBjYWxscyAoSmFuIEJldWxpY2gp
Ci0gY29udGV4dF9zd2l0Y2goKSBvbiBBUk0gcmV0dXJucyAtIGhhbmRsZSB0aGF0IChKYW4gQmV1
bGljaCkKLS0tCiB4ZW4vYXJjaC9hcm0vZG9tYWluLmMgICAgICB8ICAgMiArLQogeGVuL2FyY2gv
eDg2L2RvbWFpbi5jICAgICAgfCAgIDMgKy0KIHhlbi9jb21tb24vc2NoZWR1bGUuYyAgICAgIHwg
MzUzICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLQogeGVuL2Nv
bW1vbi9zb2Z0aXJxLmMgICAgICAgfCAgIDYgKy0KIHhlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5o
IHwgICAxICsKIHhlbi9pbmNsdWRlL3hlbi9zY2hlZC5oICAgIHwgIDE2ICstCiB4ZW4vaW5jbHVk
ZS94ZW4vc29mdGlycS5oICB8ICAgMSArCiA3IGZpbGVzIGNoYW5nZWQsIDI5NCBpbnNlcnRpb25z
KCspLCA4OCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC9hcm0vZG9tYWluLmMg
Yi94ZW4vYXJjaC9hcm0vZG9tYWluLmMKaW5kZXggZjBlZTVhMjE0MC4uNDYwZTk2OGU5NyAxMDA2
NDQKLS0tIGEveGVuL2FyY2gvYXJtL2RvbWFpbi5jCisrKyBiL3hlbi9hcmNoL2FybS9kb21haW4u
YwpAQCAtMzE4LDcgKzMxOCw3IEBAIHN0YXRpYyB2b2lkIHNjaGVkdWxlX3RhaWwoc3RydWN0IHZj
cHUgKnByZXYpCiAKICAgICBsb2NhbF9pcnFfZW5hYmxlKCk7CiAKLSAgICBjb250ZXh0X3NhdmVk
KHByZXYpOworICAgIHNjaGVkX2NvbnRleHRfc3dpdGNoZWQocHJldiwgY3VycmVudCk7CiAKICAg
ICB1cGRhdGVfcnVuc3RhdGVfYXJlYShjdXJyZW50KTsKIApkaWZmIC0tZ2l0IGEveGVuL2FyY2gv
eDg2L2RvbWFpbi5jIGIveGVuL2FyY2gveDg2L2RvbWFpbi5jCmluZGV4IGM3ZmEyMjRjODkuLjI3
Zjk5ZDNiY2MgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9kb21haW4uYworKysgYi94ZW4vYXJj
aC94ODYvZG9tYWluLmMKQEAgLTE3ODQsNyArMTc4NCw2IEBAIHN0YXRpYyB2b2lkIF9fY29udGV4
dF9zd2l0Y2godm9pZCkKICAgICBwZXJfY3B1KGN1cnJfdmNwdSwgY3B1KSA9IG47CiB9CiAKLQog
dm9pZCBjb250ZXh0X3N3aXRjaChzdHJ1Y3QgdmNwdSAqcHJldiwgc3RydWN0IHZjcHUgKm5leHQp
CiB7CiAgICAgdW5zaWduZWQgaW50IGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKQEAgLTE4NjAs
NyArMTg1OSw3IEBAIHZvaWQgY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnByZXYsIHN0cnVj
dCB2Y3B1ICpuZXh0KQogICAgICAgICB9CiAgICAgfQogCi0gICAgY29udGV4dF9zYXZlZChwcmV2
KTsKKyAgICBzY2hlZF9jb250ZXh0X3N3aXRjaGVkKHByZXYsIG5leHQpOwogCiAgICAgX3VwZGF0
ZV9ydW5zdGF0ZV9hcmVhKG5leHQpOwogICAgIC8qIE11c3QgYmUgZG9uZSB3aXRoIGludGVycnVw
dHMgZW5hYmxlZCAqLwpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2Nv
bW1vbi9zY2hlZHVsZS5jCmluZGV4IDZmMWE2ZmJkNmUuLjE4MGEyMjU0OTQgMTAwNjQ0Ci0tLSBh
L3hlbi9jb21tb24vc2NoZWR1bGUuYworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTU5
LDYgKzU5LDkgQEAgYm9vbGVhbl9wYXJhbSgic2NoZWRfc210X3Bvd2VyX3NhdmluZ3MiLCBzY2hl
ZF9zbXRfcG93ZXJfc2F2aW5ncyk7CiBpbnQgc2NoZWRfcmF0ZWxpbWl0X3VzID0gU0NIRURfREVG
QVVMVF9SQVRFTElNSVRfVVM7CiBpbnRlZ2VyX3BhcmFtKCJzY2hlZF9yYXRlbGltaXRfdXMiLCBz
Y2hlZF9yYXRlbGltaXRfdXMpOwogCisvKiBOdW1iZXIgb2YgdmNwdXMgcGVyIHN0cnVjdCBzY2hl
ZF91bml0LiAqLworc3RhdGljIHVuc2lnbmVkIGludCBfX3JlYWRfbW9zdGx5IHNjaGVkX2dyYW51
bGFyaXR5ID0gMTsKKwogLyogQ29tbW9uIGxvY2sgZm9yIGZyZWUgY3B1cy4gKi8KIHN0YXRpYyBE
RUZJTkVfU1BJTkxPQ0soc2NoZWRfZnJlZV9jcHVfbG9jayk7CiAKQEAgLTUzMCw4ICs1MzMsOCBA
QCBpbnQgc2NoZWRfbW92ZV9kb21haW4oc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wg
KmMpCiAgICAgaWYgKCBJU19FUlIoZG9tZGF0YSkgKQogICAgICAgICByZXR1cm4gUFRSX0VSUihk
b21kYXRhKTsKIAotICAgIC8qIFRPRE86IGZpeCBhcnJheSBzaXplIHdpdGggbXVsdGlwbGUgdmNw
dXMgcGVyIHVuaXQuICovCi0gICAgdW5pdF9wcml2ID0geHphbGxvY19hcnJheSh2b2lkICosIGQt
Pm1heF92Y3B1cyk7CisgICAgdW5pdF9wcml2ID0geHphbGxvY19hcnJheSh2b2lkICosCisgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBESVZfUk9VTkRfVVAoZC0+bWF4X3ZjcHVzLCBzY2hl
ZF9ncmFudWxhcml0eSkpOwogICAgIGlmICggdW5pdF9wcml2ID09IE5VTEwgKQogICAgIHsKICAg
ICAgICAgc2NoZWRfZnJlZV9kb21kYXRhKGMtPnNjaGVkLCBkb21kYXRhKTsKQEAgLTE3MTIsMTMz
ICsxNzE1LDMyNSBAQCB2b2lkIHZjcHVfc2V0X3BlcmlvZGljX3RpbWVyKHN0cnVjdCB2Y3B1ICp2
LCBzX3RpbWVfdCB2YWx1ZSkKICAgICBzcGluX3VubG9jaygmdi0+cGVyaW9kaWNfdGltZXJfbG9j
ayk7CiB9CiAKLS8qCi0gKiBUaGUgbWFpbiBmdW5jdGlvbgotICogLSBkZXNjaGVkdWxlIHRoZSBj
dXJyZW50IGRvbWFpbiAoc2NoZWR1bGVyIGluZGVwZW5kZW50KS4KLSAqIC0gcGljayBhIG5ldyBk
b21haW4gKHNjaGVkdWxlciBkZXBlbmRlbnQpLgotICovCi1zdGF0aWMgdm9pZCBzY2hlZHVsZSh2
b2lkKQorc3RhdGljIHZvaWQgc2NoZWRfc3dpdGNoX3VuaXRzKHN0cnVjdCBzY2hlZF9yZXNvdXJj
ZSAqc3IsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQg
Km5leHQsIHN0cnVjdCBzY2hlZF91bml0ICpwcmV2LAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHNfdGltZV90IG5vdykKIHsKLSAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAgICAqcHJldiA9
IGN1cnJlbnQtPnNjaGVkX3VuaXQsICpuZXh0ID0gTlVMTDsKLSAgICBzX3RpbWVfdCAgICAgICAg
ICAgICAgbm93OwotICAgIHN0cnVjdCBzY2hlZHVsZXIgICAgICpzY2hlZDsKLSAgICB1bnNpZ25l
ZCBsb25nICAgICAgICAqdGFza2xldF93b3JrID0gJnRoaXNfY3B1KHRhc2tsZXRfd29ya190b19k
byk7Ci0gICAgYm9vbCAgICAgICAgICAgICAgICAgIHRhc2tsZXRfd29ya19zY2hlZHVsZWQgPSBm
YWxzZTsKLSAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkOwotICAgIHNwaW5sb2NrX3QgICAg
ICAgICAgICpsb2NrOwotICAgIGludCBjcHUgPSBzbXBfcHJvY2Vzc29yX2lkKCk7CisgICAgc3It
PmN1cnIgPSBuZXh0OwogCi0gICAgQVNTRVJUX05PVF9JTl9BVE9NSUMoKTsKKyAgICBUUkFDRV8z
RChUUkNfU0NIRURfU1dJVENIX0lORlBSRVYsIHByZXYtPmRvbWFpbi0+ZG9tYWluX2lkLCBwcmV2
LT51bml0X2lkLAorICAgICAgICAgICAgIG5vdyAtIHByZXYtPnN0YXRlX2VudHJ5X3RpbWUpOwor
ICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GTkVYVCwgbmV4dC0+ZG9tYWluLT5kb21h
aW5faWQsIG5leHQtPnVuaXRfaWQsCisgICAgICAgICAgICAgKG5leHQtPnZjcHVfbGlzdC0+cnVu
c3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmFibGUpID8KKyAgICAgICAgICAgICAobm93IC0g
bmV4dC0+c3RhdGVfZW50cnlfdGltZSkgOiAwLCBwcmV2LT5uZXh0X3RpbWUpOwogCi0gICAgU0NI
RURfU1RBVF9DUkFOSyhzY2hlZF9ydW4pOworICAgIEFTU0VSVChwcmV2LT52Y3B1X2xpc3QtPnJ1
bnN0YXRlLnN0YXRlID09IFJVTlNUQVRFX3J1bm5pbmcpOworCisgICAgVFJBQ0VfNEQoVFJDX1ND
SEVEX1NXSVRDSCwgcHJldi0+ZG9tYWluLT5kb21haW5faWQsIHByZXYtPnVuaXRfaWQsCisgICAg
ICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQtPnVuaXRfaWQpOworCisgICAg
c2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2UocHJldiwgZmFsc2UsIG5vdyk7CisKKyAgICBBU1NF
UlQobmV4dC0+dmNwdV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSAhPSBSVU5TVEFURV9ydW5uaW5nKTsK
KyAgICBzY2hlZF91bml0X3J1bnN0YXRlX2NoYW5nZShuZXh0LCB0cnVlLCBub3cpOwogCi0gICAg
c2QgPSBnZXRfc2NoZWRfcmVzKGNwdSk7CisgICAgLyoKKyAgICAgKiBOQi4gRG9uJ3QgYWRkIGFu
eSB0cmFjZSByZWNvcmRzIGZyb20gaGVyZSB1bnRpbCB0aGUgYWN0dWFsIGNvbnRleHQKKyAgICAg
KiBzd2l0Y2gsIGVsc2UgbG9zdF9yZWNvcmRzIHJlc3VtZSB3aWxsIG5vdCB3b3JrIHByb3Blcmx5
LgorICAgICAqLworCisgICAgQVNTRVJUKCFuZXh0LT5pc19ydW5uaW5nKTsKKyAgICBuZXh0LT52
Y3B1X2xpc3QtPmlzX3J1bm5pbmcgPSAxOworICAgIG5leHQtPmlzX3J1bm5pbmcgPSB0cnVlOwor
ICAgIG5leHQtPnN0YXRlX2VudHJ5X3RpbWUgPSBub3c7Cit9CisKK3N0YXRpYyBib29sIHNjaGVk
X3Rhc2tsZXRfY2hlY2tfY3B1KHVuc2lnbmVkIGludCBjcHUpCit7CisgICAgdW5zaWduZWQgbG9u
ZyAqdGFza2xldF93b3JrID0gJnBlcl9jcHUodGFza2xldF93b3JrX3RvX2RvLCBjcHUpOwogCi0g
ICAgLyogVXBkYXRlIHRhc2tsZXQgc2NoZWR1bGluZyBzdGF0dXMuICovCiAgICAgc3dpdGNoICgg
KnRhc2tsZXRfd29yayApCiAgICAgewogICAgIGNhc2UgVEFTS0xFVF9lbnF1ZXVlZDoKICAgICAg
ICAgc2V0X2JpdChfVEFTS0xFVF9zY2hlZHVsZWQsIHRhc2tsZXRfd29yayk7CiAgICAgICAgIC8q
IGZhbGx0aHJvdWdoICovCiAgICAgY2FzZSBUQVNLTEVUX2VucXVldWVkfFRBU0tMRVRfc2NoZWR1
bGVkOgotICAgICAgICB0YXNrbGV0X3dvcmtfc2NoZWR1bGVkID0gdHJ1ZTsKKyAgICAgICAgcmV0
dXJuIHRydWU7CiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgVEFTS0xFVF9zY2hlZHVsZWQ6CiAg
ICAgICAgIGNsZWFyX2JpdChfVEFTS0xFVF9zY2hlZHVsZWQsIHRhc2tsZXRfd29yayk7CisgICAg
ICAgIC8qIGZhbGx0aHJvdWdoICovCiAgICAgY2FzZSAwOgotICAgICAgICAvKnRhc2tsZXRfd29y
a19zY2hlZHVsZWQgPSBmYWxzZTsqLworICAgICAgICAvKiByZXR1cm4gZmFsc2U7ICovCiAgICAg
ICAgIGJyZWFrOwogICAgIGRlZmF1bHQ6CiAgICAgICAgIEJVRygpOwogICAgIH0KIAotICAgIGxv
Y2sgPSBwY3B1X3NjaGVkdWxlX2xvY2tfaXJxKGNwdSk7CisgICAgcmV0dXJuIGZhbHNlOworfQog
Ci0gICAgbm93ID0gTk9XKCk7CitzdGF0aWMgYm9vbCBzY2hlZF90YXNrbGV0X2NoZWNrKHVuc2ln
bmVkIGludCBjcHUpCit7CisgICAgYm9vbCB0YXNrbGV0X3dvcmtfc2NoZWR1bGVkID0gZmFsc2U7
CisgICAgY29uc3QgY3B1bWFza190ICptYXNrID0gZ2V0X3NjaGVkX3JlcyhjcHUpLT5jcHVzOwor
ICAgIHVuc2lnbmVkIGludCBjcHVfaXRlcjsKKworICAgIGZvcl9lYWNoX2NwdSAoIGNwdV9pdGVy
LCBtYXNrICkKKyAgICAgICAgaWYgKCBzY2hlZF90YXNrbGV0X2NoZWNrX2NwdShjcHVfaXRlcikg
KQorICAgICAgICAgICAgdGFza2xldF93b3JrX3NjaGVkdWxlZCA9IHRydWU7CiAKLSAgICBzdG9w
X3RpbWVyKCZzZC0+c190aW1lcik7CisgICAgcmV0dXJuIHRhc2tsZXRfd29ya19zY2hlZHVsZWQ7
Cit9CisKK3N0YXRpYyBzdHJ1Y3Qgc2NoZWRfdW5pdCAqZG9fc2NoZWR1bGUoc3RydWN0IHNjaGVk
X3VuaXQgKnByZXYsIHNfdGltZV90IG5vdywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgdW5zaWduZWQgaW50IGNwdSkKK3sKKyAgICBzdHJ1Y3Qgc2NoZWR1bGVyICpzY2hl
ZCA9IHBlcl9jcHUoc2NoZWR1bGVyLCBjcHUpOworICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAq
c3IgPSBnZXRfc2NoZWRfcmVzKGNwdSk7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKm5leHQ7CiAK
ICAgICAvKiBnZXQgcG9saWN5LXNwZWNpZmljIGRlY2lzaW9uIG9uIHNjaGVkdWxpbmcuLi4gKi8K
LSAgICBzY2hlZCA9IHRoaXNfY3B1KHNjaGVkdWxlcik7Ci0gICAgc2NoZWQtPmRvX3NjaGVkdWxl
KHNjaGVkLCBwcmV2LCBub3csIHRhc2tsZXRfd29ya19zY2hlZHVsZWQpOworICAgIHNjaGVkLT5k
b19zY2hlZHVsZShzY2hlZCwgcHJldiwgbm93LCBzY2hlZF90YXNrbGV0X2NoZWNrKGNwdSkpOwog
CiAgICAgbmV4dCA9IHByZXYtPm5leHRfdGFzazsKIAotICAgIHNkLT5jdXJyID0gbmV4dDsKLQog
ICAgIGlmICggcHJldi0+bmV4dF90aW1lID49IDAgKSAvKiAtdmUgbWVhbnMgbm8gbGltaXQgKi8K
LSAgICAgICAgc2V0X3RpbWVyKCZzZC0+c190aW1lciwgbm93ICsgcHJldi0+bmV4dF90aW1lKTsK
KyAgICAgICAgc2V0X3RpbWVyKCZzci0+c190aW1lciwgbm93ICsgcHJldi0+bmV4dF90aW1lKTsK
KworICAgIGlmICggbGlrZWx5KHByZXYgIT0gbmV4dCkgKQorICAgICAgICBzY2hlZF9zd2l0Y2hf
dW5pdHMoc3IsIG5leHQsIHByZXYsIG5vdyk7CisKKyAgICByZXR1cm4gbmV4dDsKK30KKworc3Rh
dGljIHZvaWQgY29udGV4dF9zYXZlZChzdHJ1Y3QgdmNwdSAqcHJldikKK3sKKyAgICBzdHJ1Y3Qg
c2NoZWRfdW5pdCAqdW5pdCA9IHByZXYtPnNjaGVkX3VuaXQ7CisKKyAgICAvKiBDbGVhciBydW5u
aW5nIGZsYWcgL2FmdGVyLyB3cml0aW5nIGNvbnRleHQgdG8gbWVtb3J5LiAqLworICAgIHNtcF93
bWIoKTsKKworICAgIHByZXYtPmlzX3J1bm5pbmcgPSAwOworICAgIHVuaXQtPmlzX3J1bm5pbmcg
PSBmYWxzZTsKKyAgICB1bml0LT5zdGF0ZV9lbnRyeV90aW1lID0gTk9XKCk7CisKKyAgICAvKiBD
aGVjayBmb3IgbWlncmF0aW9uIHJlcXVlc3QgL2FmdGVyLyBjbGVhcmluZyBydW5uaW5nIGZsYWcu
ICovCisgICAgc21wX21iKCk7CisKKyAgICBzY2hlZF9jb250ZXh0X3NhdmVkKHZjcHVfc2NoZWR1
bGVyKHByZXYpLCB1bml0KTsKIAotICAgIGlmICggdW5saWtlbHkocHJldiA9PSBuZXh0KSApCisg
ICAgc2NoZWRfdW5pdF9taWdyYXRlX2ZpbmlzaCh1bml0KTsKK30KKworLyoKKyAqIFJlbmRlenZv
dXMgb24gZW5kIG9mIGNvbnRleHQgc3dpdGNoLgorICogQXMgbm8gbG9jayBpcyBwcm90ZWN0aW5n
IHRoaXMgcmVuZGV6dm91cyBmdW5jdGlvbiB3ZSBuZWVkIHRvIHVzZSBhdG9taWMKKyAqIGFjY2Vz
cyBmdW5jdGlvbnMgb24gdGhlIGNvdW50ZXIuCisgKiBUaGUgY291bnRlciB3aWxsIGJlIDAgaW4g
Y2FzZSBubyByZW5kZXp2b3VzIGlzIG5lZWRlZC4gRm9yIHRoZSByZW5kZXp2b3VzCisgKiBjYXNl
IGl0IGlzIGluaXRpYWxpc2VkIHRvIHRoZSBudW1iZXIgb2YgY3B1cyB0byByZW5kZXp2b3VzIHBs
dXMgMS4gRWFjaAorICogbWVtYmVyIGVudGVyaW5nIGRlY3JlbWVudHMgdGhlIGNvdW50ZXIuIFRo
ZSBsYXN0IG9uZSB3aWxsIGRlY3JlbWVudCBpdCB0bworICogMSBhbmQgcGVyZm9ybSB0aGUgZmlu
YWwgbmVlZGVkIGFjdGlvbiBpbiB0aGF0IGNhc2UgKGNhbGwgb2YgY29udGV4dF9zYXZlZCgpCisg
KiBpZiB2Y3B1IHdhcyBzd2l0Y2hlZCksIGFuZCB0aGVuIHNldCB0aGUgY291bnRlciB0byB6ZXJv
LiBUaGUgb3RoZXIgbWVtYmVycworICogd2lsbCB3YWl0IHVudGlsIHRoZSBjb3VudGVyIGJlY29t
ZXMgemVybyB1bnRpbCB0aGV5IHByb2NlZWQuCisgKi8KK3ZvaWQgc2NoZWRfY29udGV4dF9zd2l0
Y2hlZChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCkKK3sKKyAgICBzdHJ1
Y3Qgc2NoZWRfdW5pdCAqbmV4dCA9IHZuZXh0LT5zY2hlZF91bml0OworCisgICAgaWYgKCBhdG9t
aWNfcmVhZCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250KSApCisgICAgeworICAgICAgICBpbnQg
Y250ID0gYXRvbWljX2RlY19yZXR1cm4oJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCk7CisKKyAg
ICAgICAgLyogQ2FsbCBjb250ZXh0X3NhdmVkKCkgYmVmb3JlIHJlbGVhc2luZyBvdGhlciB3YWl0
ZXJzLiAqLworICAgICAgICBpZiAoIGNudCA9PSAxICkKKyAgICAgICAgeworICAgICAgICAgICAg
aWYgKCB2cHJldiAhPSB2bmV4dCApCisgICAgICAgICAgICAgICAgY29udGV4dF9zYXZlZCh2cHJl
dik7CisgICAgICAgICAgICBhdG9taWNfc2V0KCZuZXh0LT5yZW5kZXp2b3VzX291dF9jbnQsIDAp
OworICAgICAgICB9CisgICAgICAgIGVsc2UKKyAgICAgICAgICAgIHdoaWxlICggYXRvbWljX3Jl
YWQoJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCkgKQorICAgICAgICAgICAgICAgIGNwdV9yZWxh
eCgpOworICAgIH0KKyAgICBlbHNlIGlmICggdnByZXYgIT0gdm5leHQgKQorICAgICAgICBjb250
ZXh0X3NhdmVkKHZwcmV2KTsKK30KKworc3RhdGljIHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2go
c3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBzX3RpbWVfdCBub3cpCit7CisgICAgaWYgKCB1bmxpa2VseSh2cHJl
diA9PSB2bmV4dCkgKQogICAgIHsKLSAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxv
Y2ssIGNwdSk7CiAgICAgICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GQ09OVCwKLSAg
ICAgICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQtPnVuaXRfaWQsCi0g
ICAgICAgICAgICAgICAgIG5vdyAtIHByZXYtPnN0YXRlX2VudHJ5X3RpbWUsCi0gICAgICAgICAg
ICAgICAgIHByZXYtPm5leHRfdGltZSk7Ci0gICAgICAgIHRyYWNlX2NvbnRpbnVlX3J1bm5pbmco
bmV4dC0+dmNwdV9saXN0KTsKLSAgICAgICAgcmV0dXJuIGNvbnRpbnVlX3J1bm5pbmcocHJldi0+
dmNwdV9saXN0KTsKKyAgICAgICAgICAgICAgICAgdm5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCB2
bmV4dC0+c2NoZWRfdW5pdC0+dW5pdF9pZCwKKyAgICAgICAgICAgICAgICAgbm93IC0gdnByZXYt
PnJ1bnN0YXRlLnN0YXRlX2VudHJ5X3RpbWUsCisgICAgICAgICAgICAgICAgIHZwcmV2LT5zY2hl
ZF91bml0LT5uZXh0X3RpbWUpOworICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaGVkKHZwcmV2
LCB2bmV4dCk7CisgICAgICAgIHRyYWNlX2NvbnRpbnVlX3J1bm5pbmcodm5leHQpOworICAgICAg
ICByZXR1cm4gY29udGludWVfcnVubmluZyh2cHJldik7CiAgICAgfQogCi0gICAgVFJBQ0VfM0Qo
VFJDX1NDSEVEX1NXSVRDSF9JTkZQUkVWLAotICAgICAgICAgICAgIHByZXYtPmRvbWFpbi0+ZG9t
YWluX2lkLCBwcmV2LT51bml0X2lkLAotICAgICAgICAgICAgIG5vdyAtIHByZXYtPnN0YXRlX2Vu
dHJ5X3RpbWUpOwotICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GTkVYVCwKLSAgICAg
ICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCwKLSAgICAgICAg
ICAgICAobmV4dC0+dmNwdV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uYWJs
ZSkgPwotICAgICAgICAgICAgIChub3cgLSBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lKSA6IDAsCi0g
ICAgICAgICAgICAgcHJldi0+bmV4dF90aW1lKTsKKyAgICBTQ0hFRF9TVEFUX0NSQU5LKHNjaGVk
X2N0eCk7CiAKLSAgICBBU1NFUlQocHJldi0+dmNwdV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBS
VU5TVEFURV9ydW5uaW5nKTsKKyAgICBzdG9wX3RpbWVyKCZ2cHJldi0+cGVyaW9kaWNfdGltZXIp
OwogCi0gICAgVFJBQ0VfNEQoVFJDX1NDSEVEX1NXSVRDSCwKLSAgICAgICAgICAgICBwcmV2LT5k
b21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKLSAgICAgICAgICAgICBuZXh0LT5kb21h
aW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCk7CisgICAgaWYgKCB2bmV4dC0+c2NoZWRfdW5p
dC0+bWlncmF0ZWQgKQorICAgICAgICB2Y3B1X21vdmVfaXJxcyh2bmV4dCk7CiAKLSAgICBzY2hl
ZF91bml0X3J1bnN0YXRlX2NoYW5nZShwcmV2LCBmYWxzZSwgbm93KTsKKyAgICB2Y3B1X3Blcmlv
ZGljX3RpbWVyX3dvcmsodm5leHQpOwogCi0gICAgQVNTRVJUKG5leHQtPnZjcHVfbGlzdC0+cnVu
c3RhdGUuc3RhdGUgIT0gUlVOU1RBVEVfcnVubmluZyk7Ci0gICAgc2NoZWRfdW5pdF9ydW5zdGF0
ZV9jaGFuZ2UobmV4dCwgdHJ1ZSwgbm93KTsKKyAgICBjb250ZXh0X3N3aXRjaCh2cHJldiwgdm5l
eHQpOworfQogCi0gICAgLyoKLSAgICAgKiBOQi4gRG9uJ3QgYWRkIGFueSB0cmFjZSByZWNvcmRz
IGZyb20gaGVyZSB1bnRpbCB0aGUgYWN0dWFsIGNvbnRleHQKLSAgICAgKiBzd2l0Y2gsIGVsc2Ug
bG9zdF9yZWNvcmRzIHJlc3VtZSB3aWxsIG5vdCB3b3JrIHByb3Blcmx5LgotICAgICAqLworLyoK
KyAqIFJlbmRlenZvdXMgYmVmb3JlIHRha2luZyBhIHNjaGVkdWxpbmcgZGVjaXNpb24uCisgKiBD
YWxsZWQgd2l0aCBzY2hlZHVsZSBsb2NrIGhlbGQsIHNvIGFsbCBhY2Nlc3NlcyB0byB0aGUgcmVu
ZGV6dm91cyBjb3VudGVyCisgKiBjYW4gYmUgbm9ybWFsIG9uZXMgKG5vIGF0b21pYyBhY2Nlc3Nl
cyBuZWVkZWQpLgorICogVGhlIGNvdW50ZXIgaXMgaW5pdGlhbGl6ZWQgdG8gdGhlIG51bWJlciBv
ZiBjcHVzIHRvIHJlbmRlenZvdXMgaW5pdGlhbGx5LgorICogRWFjaCBjcHUgZW50ZXJpbmcgd2ls
bCBkZWNyZW1lbnQgdGhlIGNvdW50ZXIuIEluIGNhc2UgdGhlIGNvdW50ZXIgYmVjb21lcworICog
emVybyBkb19zY2hlZHVsZSgpIGlzIGNhbGxlZCBhbmQgdGhlIHJlbmRlenZvdXMgY291bnRlciBm
b3IgbGVhdmluZworICogY29udGV4dF9zd2l0Y2goKSBpcyBzZXQuIEFsbCBvdGhlciBtZW1iZXJz
IHdpbGwgd2FpdCB1bnRpbCB0aGUgY291bnRlciBpcworICogYmVjb21pbmcgemVybywgZHJvcHBp
bmcgdGhlIHNjaGVkdWxlIGxvY2sgaW4gYmV0d2Vlbi4KKyAqLworc3RhdGljIHN0cnVjdCBzY2hl
ZF91bml0ICpzY2hlZF93YWl0X3JlbmRlenZvdXNfaW4oc3RydWN0IHNjaGVkX3VuaXQgKnByZXYs
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGlu
bG9ja190ICoqbG9jaywgaW50IGNwdSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIHNfdGltZV90IG5vdykKK3sKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5p
dCAqbmV4dDsKIAotICAgIEFTU0VSVCghbmV4dC0+aXNfcnVubmluZyk7Ci0gICAgbmV4dC0+dmNw
dV9saXN0LT5pc19ydW5uaW5nID0gMTsKLSAgICBuZXh0LT5pc19ydW5uaW5nID0gdHJ1ZTsKLSAg
ICBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lID0gbm93OworICAgIGlmICggIS0tcHJldi0+cmVuZGV6
dm91c19pbl9jbnQgKQorICAgIHsKKyAgICAgICAgbmV4dCA9IGRvX3NjaGVkdWxlKHByZXYsIG5v
dywgY3B1KTsKKyAgICAgICAgYXRvbWljX3NldCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250LCBz
Y2hlZF9ncmFudWxhcml0eSArIDEpOworICAgICAgICByZXR1cm4gbmV4dDsKKyAgICB9CiAKLSAg
ICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKKyAgICB3aGlsZSAoIHByZXYt
PnJlbmRlenZvdXNfaW5fY250ICkKKyAgICB7CisgICAgICAgIC8qCisgICAgICAgICAqIENvbWlu
ZyBmcm9tIGlkbGUgbWlnaHQgbmVlZCB0byBkbyB0YXNrbGV0IHdvcmsuCisgICAgICAgICAqIElu
IG9yZGVyIHRvIGF2b2lkIGRlYWRsb2NrcyB3ZSBjYW4ndCBkbyB0aGF0IGhlcmUsIGJ1dCBoYXZl
IHRvCisgICAgICAgICAqIGNvbnRpbnVlIHRoZSBpZGxlIGxvb3AuCisgICAgICAgICAqIFVuZG8g
dGhlIHJlbmRlenZvdXNfaW5fY250IGRlY3JlbWVudCBhbmQgc2NoZWR1bGUgYW5vdGhlciBjYWxs
IG9mCisgICAgICAgICAqIHNjaGVkX3NsYXZlKCkuCisgICAgICAgICAqLworICAgICAgICBpZiAo
IGlzX2lkbGVfdW5pdChwcmV2KSAmJiBzY2hlZF90YXNrbGV0X2NoZWNrX2NwdShjcHUpICkKKyAg
ICAgICAgeworICAgICAgICAgICAgc3RydWN0IHZjcHUgKnZwcmV2ID0gY3VycmVudDsKIAotICAg
IFNDSEVEX1NUQVRfQ1JBTksoc2NoZWRfY3R4KTsKKyAgICAgICAgICAgIHByZXYtPnJlbmRlenZv
dXNfaW5fY250Kys7CisgICAgICAgICAgICBhdG9taWNfc2V0KCZwcmV2LT5yZW5kZXp2b3VzX291
dF9jbnQsIDApOworCisgICAgICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEoKmxvY2ss
IGNwdSk7CisKKyAgICAgICAgICAgIHJhaXNlX3NvZnRpcnEoU0NIRURfU0xBVkVfU09GVElSUSk7
CisgICAgICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgdnByZXYsIG5vdyk7CisK
KyAgICAgICAgICAgIHJldHVybiBOVUxMOyAgICAgICAgIC8qIEFSTSBvbmx5LiAqLworICAgICAg
ICB9CiAKLSAgICBzdG9wX3RpbWVyKCZwcmV2LT52Y3B1X2xpc3QtPnBlcmlvZGljX3RpbWVyKTsK
KyAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKCpsb2NrLCBjcHUpOwogCi0gICAgaWYg
KCBuZXh0LT5taWdyYXRlZCApCi0gICAgICAgIHZjcHVfbW92ZV9pcnFzKG5leHQtPnZjcHVfbGlz
dCk7CisgICAgICAgIGNwdV9yZWxheCgpOwogCi0gICAgdmNwdV9wZXJpb2RpY190aW1lcl93b3Jr
KG5leHQtPnZjcHVfbGlzdCk7CisgICAgICAgICpsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2ly
cShjcHUpOworICAgIH0KIAotICAgIGNvbnRleHRfc3dpdGNoKHByZXYtPnZjcHVfbGlzdCwgbmV4
dC0+dmNwdV9saXN0KTsKKyAgICByZXR1cm4gcHJldi0+bmV4dF90YXNrOwogfQogCi12b2lkIGNv
bnRleHRfc2F2ZWQoc3RydWN0IHZjcHUgKnByZXYpCitzdGF0aWMgdm9pZCBzY2hlZF9zbGF2ZSh2
b2lkKQogewotICAgIC8qIENsZWFyIHJ1bm5pbmcgZmxhZyAvYWZ0ZXIvIHdyaXRpbmcgY29udGV4
dCB0byBtZW1vcnkuICovCi0gICAgc21wX3dtYigpOworICAgIHN0cnVjdCB2Y3B1ICAgICAgICAg
ICp2cHJldiA9IGN1cnJlbnQ7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgICAgKnByZXYgPSB2cHJl
di0+c2NoZWRfdW5pdCwgKm5leHQ7CisgICAgc190aW1lX3QgICAgICAgICAgICAgIG5vdzsKKyAg
ICBzcGlubG9ja190ICAgICAgICAgICAqbG9jazsKKyAgICB1bnNpZ25lZCBpbnQgICAgICAgICAg
Y3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOwogCi0gICAgcHJldi0+aXNfcnVubmluZyA9IDA7Ci0g
ICAgcHJldi0+c2NoZWRfdW5pdC0+aXNfcnVubmluZyA9IGZhbHNlOwotICAgIHByZXYtPnNjaGVk
X3VuaXQtPnN0YXRlX2VudHJ5X3RpbWUgPSBOT1coKTsKKyAgICBBU1NFUlRfTk9UX0lOX0FUT01J
QygpOwogCi0gICAgLyogQ2hlY2sgZm9yIG1pZ3JhdGlvbiByZXF1ZXN0IC9hZnRlci8gY2xlYXJp
bmcgcnVubmluZyBmbGFnLiAqLwotICAgIHNtcF9tYigpOworICAgIGxvY2sgPSBwY3B1X3NjaGVk
dWxlX2xvY2tfaXJxKGNwdSk7CiAKLSAgICBzY2hlZF9jb250ZXh0X3NhdmVkKHZjcHVfc2NoZWR1
bGVyKHByZXYpLCBwcmV2LT5zY2hlZF91bml0KTsKKyAgICBub3cgPSBOT1coKTsKKworICAgIGlm
ICggIXByZXYtPnJlbmRlenZvdXNfaW5fY250ICkKKyAgICB7CisgICAgICAgIHBjcHVfc2NoZWR1
bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOworICAgICAgICByZXR1cm47CisgICAgfQorCisgICAg
c3RvcF90aW1lcigmZ2V0X3NjaGVkX3JlcyhjcHUpLT5zX3RpbWVyKTsKKworICAgIG5leHQgPSBz
Y2hlZF93YWl0X3JlbmRlenZvdXNfaW4ocHJldiwgJmxvY2ssIGNwdSwgbm93KTsKKyAgICBpZiAo
ICFuZXh0ICkKKyAgICAgICAgcmV0dXJuOworCisgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJx
KGxvY2ssIGNwdSk7CiAKLSAgICBzY2hlZF91bml0X21pZ3JhdGVfZmluaXNoKHByZXYtPnNjaGVk
X3VuaXQpOworICAgIHNjaGVkX2NvbnRleHRfc3dpdGNoKHZwcmV2LCBuZXh0LT52Y3B1X2xpc3Qs
IG5vdyk7Cit9CisKKy8qCisgKiBUaGUgbWFpbiBmdW5jdGlvbgorICogLSBkZXNjaGVkdWxlIHRo
ZSBjdXJyZW50IGRvbWFpbiAoc2NoZWR1bGVyIGluZGVwZW5kZW50KS4KKyAqIC0gcGljayBhIG5l
dyBkb21haW4gKHNjaGVkdWxlciBkZXBlbmRlbnQpLgorICovCitzdGF0aWMgdm9pZCBzY2hlZHVs
ZSh2b2lkKQoreworICAgIHN0cnVjdCB2Y3B1ICAgICAgICAgICp2bmV4dCwgKnZwcmV2ID0gY3Vy
cmVudDsKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAgICAqcHJldiA9IHZwcmV2LT5zY2hlZF91bml0
LCAqbmV4dCA9IE5VTEw7CisgICAgc190aW1lX3QgICAgICAgICAgICAgIG5vdzsKKyAgICBzdHJ1
Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyOworICAgIHNwaW5sb2NrX3QgICAgICAgICAgICpsb2NrOwor
ICAgIGludCBjcHUgPSBzbXBfcHJvY2Vzc29yX2lkKCk7CisKKyAgICBBU1NFUlRfTk9UX0lOX0FU
T01JQygpOworCisgICAgU0NIRURfU1RBVF9DUkFOSyhzY2hlZF9ydW4pOworCisgICAgc3IgPSBn
ZXRfc2NoZWRfcmVzKGNwdSk7CisKKyAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycShj
cHUpOworCisgICAgaWYgKCBwcmV2LT5yZW5kZXp2b3VzX2luX2NudCApCisgICAgeworICAgICAg
ICAvKgorICAgICAgICAgKiBXZSBoYXZlIGEgcmFjZTogc2NoZWRfc2xhdmUoKSBzaG91bGQgYmUg
Y2FsbGVkLCBzbyByYWlzZSBhIHNvZnRpcnEKKyAgICAgICAgICogaW4gb3JkZXIgdG8gcmUtZW50
ZXIgc2NoZWR1bGUoKSBsYXRlciBhbmQgY2FsbCBzY2hlZF9zbGF2ZSgpIG5vdy4KKyAgICAgICAg
ICovCisgICAgICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOworCisgICAg
ICAgIHJhaXNlX3NvZnRpcnEoU0NIRURVTEVfU09GVElSUSk7CisgICAgICAgIHJldHVybiBzY2hl
ZF9zbGF2ZSgpOworICAgIH0KKworICAgIHN0b3BfdGltZXIoJnNyLT5zX3RpbWVyKTsKKworICAg
IG5vdyA9IE5PVygpOworCisgICAgaWYgKCBzY2hlZF9ncmFudWxhcml0eSA+IDEgKQorICAgIHsK
KyAgICAgICAgY3B1bWFza190IG1hc2s7CisKKyAgICAgICAgcHJldi0+cmVuZGV6dm91c19pbl9j
bnQgPSBzY2hlZF9ncmFudWxhcml0eTsKKyAgICAgICAgY3B1bWFza19hbmRub3QoJm1hc2ssIHNy
LT5jcHVzLCBjcHVtYXNrX29mKGNwdSkpOworICAgICAgICBjcHVtYXNrX3JhaXNlX3NvZnRpcnEo
Jm1hc2ssIFNDSEVEX1NMQVZFX1NPRlRJUlEpOworICAgICAgICBuZXh0ID0gc2NoZWRfd2FpdF9y
ZW5kZXp2b3VzX2luKHByZXYsICZsb2NrLCBjcHUsIG5vdyk7CisgICAgICAgIGlmICggIW5leHQg
KQorICAgICAgICAgICAgcmV0dXJuOworICAgIH0KKyAgICBlbHNlCisgICAgeworICAgICAgICBw
cmV2LT5yZW5kZXp2b3VzX2luX2NudCA9IDA7CisgICAgICAgIG5leHQgPSBkb19zY2hlZHVsZShw
cmV2LCBub3csIGNwdSk7CisgICAgICAgIGF0b21pY19zZXQoJm5leHQtPnJlbmRlenZvdXNfb3V0
X2NudCwgMCk7CisgICAgfQorCisgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNw
dSk7CisKKyAgICB2bmV4dCA9IG5leHQtPnZjcHVfbGlzdDsKKyAgICBzY2hlZF9jb250ZXh0X3N3
aXRjaCh2cHJldiwgdm5leHQsIG5vdyk7CiB9CiAKIC8qIFRoZSBzY2hlZHVsZXIgdGltZXI6IGZv
cmNlIGEgcnVuIHRocm91Z2ggdGhlIHNjaGVkdWxlciAqLwpAQCAtMTg3OSw2ICsyMDc0LDcgQEAg
c3RhdGljIGludCBjcHVfc2NoZWR1bGVfdXAodW5zaWduZWQgaW50IGNwdSkKICAgICBpZiAoIHNy
ID09IE5VTEwgKQogICAgICAgICByZXR1cm4gLUVOT01FTTsKICAgICBzci0+bWFzdGVyX2NwdSA9
IGNwdTsKKyAgICBzci0+Y3B1cyA9IGNwdW1hc2tfb2YoY3B1KTsKICAgICBzZXRfc2NoZWRfcmVz
KGNwdSwgc3IpOwogCiAgICAgcGVyX2NwdShzY2hlZHVsZXIsIGNwdSkgPSAmc2NoZWRfaWRsZV9v
cHM7CkBAIC0xODk5LDYgKzIwOTUsOCBAQCBzdGF0aWMgaW50IGNwdV9zY2hlZHVsZV91cCh1bnNp
Z25lZCBpbnQgY3B1KQogICAgIGlmICggaWRsZV92Y3B1W2NwdV0gPT0gTlVMTCApCiAgICAgICAg
IHJldHVybiAtRU5PTUVNOwogCisgICAgaWRsZV92Y3B1W2NwdV0tPnNjaGVkX3VuaXQtPnJlbmRl
enZvdXNfaW5fY250ID0gMDsKKwogICAgIC8qCiAgICAgICogTm8gbmVlZCB0byBhbGxvY2F0ZSBh
bnkgc2NoZWR1bGVyIGRhdGEsIGFzIGNwdXMgY29taW5nIG9ubGluZSBhcmUKICAgICAgKiBmcmVl
IGluaXRpYWxseSBhbmQgdGhlIGlkbGUgc2NoZWR1bGVyIGRvZXNuJ3QgbmVlZCBhbnkgZGF0YSBh
cmVhcwpAQCAtMTk5OSw2ICsyMTk3LDcgQEAgdm9pZCBfX2luaXQgc2NoZWR1bGVyX2luaXQodm9p
ZCkKICAgICBpbnQgaTsKIAogICAgIG9wZW5fc29mdGlycShTQ0hFRFVMRV9TT0ZUSVJRLCBzY2hl
ZHVsZSk7CisgICAgb3Blbl9zb2Z0aXJxKFNDSEVEX1NMQVZFX1NPRlRJUlEsIHNjaGVkX3NsYXZl
KTsKIAogICAgIGZvciAoIGkgPSAwOyBpIDwgTlVNX1NDSEVEVUxFUlM7IGkrKykKICAgICB7CmRp
ZmYgLS1naXQgYS94ZW4vY29tbW9uL3NvZnRpcnEuYyBiL3hlbi9jb21tb24vc29mdGlycS5jCmlu
ZGV4IDgzYzNjMDliZDUuLjJkNjYxOTMyMDMgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc29mdGly
cS5jCisrKyBiL3hlbi9jb21tb24vc29mdGlycS5jCkBAIC0zMyw4ICszMyw4IEBAIHN0YXRpYyB2
b2lkIF9fZG9fc29mdGlycSh1bnNpZ25lZCBsb25nIGlnbm9yZV9tYXNrKQogICAgIGZvciAoIDsg
OyApCiAgICAgewogICAgICAgICAvKgotICAgICAgICAgKiBJbml0aWFsaXNlIEBjcHUgb24gZXZl
cnkgaXRlcmF0aW9uOiBTQ0hFRFVMRV9TT0ZUSVJRIG1heSBtb3ZlCi0gICAgICAgICAqIHVzIHRv
IGFub3RoZXIgcHJvY2Vzc29yLgorICAgICAgICAgKiBJbml0aWFsaXNlIEBjcHUgb24gZXZlcnkg
aXRlcmF0aW9uOiBTQ0hFRFVMRV9TT0ZUSVJRIG9yCisgICAgICAgICAqIFNDSEVEX1NMQVZFX1NP
RlRJUlEgbWF5IG1vdmUgdXMgdG8gYW5vdGhlciBwcm9jZXNzb3IuCiAgICAgICAgICAqLwogICAg
ICAgICBjcHUgPSBzbXBfcHJvY2Vzc29yX2lkKCk7CiAKQEAgLTU1LDcgKzU1LDcgQEAgdm9pZCBw
cm9jZXNzX3BlbmRpbmdfc29mdGlycXModm9pZCkKIHsKICAgICBBU1NFUlQoIWluX2lycSgpICYm
IGxvY2FsX2lycV9pc19lbmFibGVkKCkpOwogICAgIC8qIERvIG5vdCBlbnRlciBzY2hlZHVsZXIg
YXMgaXQgY2FuIHByZWVtcHQgdGhlIGNhbGxpbmcgY29udGV4dC4gKi8KLSAgICBfX2RvX3NvZnRp
cnEoMXVsPDxTQ0hFRFVMRV9TT0ZUSVJRKTsKKyAgICBfX2RvX3NvZnRpcnEoKDF1bCA8PCBTQ0hF
RFVMRV9TT0ZUSVJRKSB8ICgxdWwgPDwgU0NIRURfU0xBVkVfU09GVElSUSkpOwogfQogCiB2b2lk
IGRvX3NvZnRpcnEodm9pZCkKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5o
IGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKaW5kZXggMDQyM2JlOTg3ZC4uYzY1ZGZhOTQz
YiAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKKysrIGIveGVuL2luY2x1
ZGUveGVuL3NjaGVkLWlmLmgKQEAgLTQyLDYgKzQyLDcgQEAgc3RydWN0IHNjaGVkX3Jlc291cmNl
IHsKIAogICAgIC8qIENwdSB3aXRoIGxvd2VzdCBpZCBpbiBzY2hlZHVsaW5nIHJlc291cmNlLiAq
LwogICAgIHVuc2lnbmVkIGludCAgICAgICAgbWFzdGVyX2NwdTsKKyAgICBjb25zdCBjcHVtYXNr
X3QgICAgKmNwdXM7ICAgICAgICAgICAvKiBjcHVzIGNvdmVyZWQgYnkgdGhpcyBzdHJ1Y3QgICAg
ICovCiB9OwogCiBERUNMQVJFX1BFUl9DUFUoc3RydWN0IHNjaGVkdWxlciAqLCBzY2hlZHVsZXIp
OwpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmggYi94ZW4vaW5jbHVkZS94ZW4v
c2NoZWQuaAppbmRleCBlYmY3MjNhODY2Li5jNzcwYWI0YWEwIDEwMDY0NAotLS0gYS94ZW4vaW5j
bHVkZS94ZW4vc2NoZWQuaAorKysgYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaApAQCAtMjkyLDYg
KzI5MiwxMiBAQCBzdHJ1Y3Qgc2NoZWRfdW5pdCB7CiAgICAgLyogTmV4dCB1bml0IHRvIHJ1bi4g
Ki8KICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAgICAgICpuZXh0X3Rhc2s7CiAgICAgc190aW1lX3Qg
ICAgICAgICAgICAgICAgbmV4dF90aW1lOworCisgICAgLyogTnVtYmVyIG9mIHZjcHVzIG5vdCB5
ZXQgam9pbmVkIGZvciBjb250ZXh0IHN3aXRjaC4gKi8KKyAgICB1bnNpZ25lZCBpbnQgICAgICAg
ICAgICByZW5kZXp2b3VzX2luX2NudDsKKworICAgIC8qIE51bWJlciBvZiB2Y3B1cyBub3QgeWV0
IGZpbmlzaGVkIHdpdGggY29udGV4dCBzd2l0Y2guICovCisgICAgYXRvbWljX3QgICAgICAgICAg
ICAgICAgcmVuZGV6dm91c19vdXRfY250OwogfTsKIAogI2RlZmluZSBmb3JfZWFjaF9zY2hlZF91
bml0KGQsIHUpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCkBAIC02
OTYsMTAgKzcwMiwxMCBAQCB2b2lkIHN5bmNfbG9jYWxfZXhlY3N0YXRlKHZvaWQpOwogCiAvKgog
ICogQ2FsbGVkIGJ5IHRoZSBzY2hlZHVsZXIgdG8gc3dpdGNoIHRvIGFub3RoZXIgVkNQVS4gVGhp
cyBmdW5jdGlvbiBtdXN0Ci0gKiBjYWxsIGNvbnRleHRfc2F2ZWQoQHByZXYpIHdoZW4gdGhlIGxv
Y2FsIENQVSBpcyBubyBsb25nZXIgcnVubmluZyBpbgotICogQHByZXYncyBjb250ZXh0LCBhbmQg
dGhhdCBjb250ZXh0IGlzIHNhdmVkIHRvIG1lbW9yeS4gQWx0ZXJuYXRpdmVseSwgaWYKLSAqIGlt
cGxlbWVudGluZyBsYXp5IGNvbnRleHQgc3dpdGNoaW5nLCBpdCBzdWZmaWNlcyB0byBlbnN1cmUg
dGhhdCBpbnZva2luZwotICogc3luY192Y3B1X2V4ZWNzdGF0ZSgpIHdpbGwgc3dpdGNoIGFuZCBj
b21taXQgQHByZXYncyBzdGF0ZS4KKyAqIGNhbGwgc2NoZWRfY29udGV4dF9zd2l0Y2hlZChAcHJl
diwgQG5leHQpIHdoZW4gdGhlIGxvY2FsIENQVSBpcyBubyBsb25nZXIKKyAqIHJ1bm5pbmcgaW4g
QHByZXYncyBjb250ZXh0LCBhbmQgdGhhdCBjb250ZXh0IGlzIHNhdmVkIHRvIG1lbW9yeS4KKyAq
IEFsdGVybmF0aXZlbHksIGlmIGltcGxlbWVudGluZyBsYXp5IGNvbnRleHQgc3dpdGNoaW5nLCBp
dCBzdWZmaWNlcyB0byBlbnN1cmUKKyAqIHRoYXQgaW52b2tpbmcgc3luY192Y3B1X2V4ZWNzdGF0
ZSgpIHdpbGwgc3dpdGNoIGFuZCBjb21taXQgQHByZXYncyBzdGF0ZS4KICAqLwogdm9pZCBjb250
ZXh0X3N3aXRjaCgKICAgICBzdHJ1Y3QgdmNwdSAqcHJldiwKQEAgLTcxMSw3ICs3MTcsNyBAQCB2
b2lkIGNvbnRleHRfc3dpdGNoKAogICogc2F2ZWQgdG8gbWVtb3J5LiBBbHRlcm5hdGl2ZWx5LCBp
ZiBpbXBsZW1lbnRpbmcgbGF6eSBjb250ZXh0IHN3aXRjaGluZywKICAqIGVuc3VyZSB0aGF0IGlu
dm9raW5nIHN5bmNfdmNwdV9leGVjc3RhdGUoKSB3aWxsIHN3aXRjaCBhbmQgY29tbWl0IEBwcmV2
LgogICovCi12b2lkIGNvbnRleHRfc2F2ZWQoc3RydWN0IHZjcHUgKnByZXYpOwordm9pZCBzY2hl
ZF9jb250ZXh0X3N3aXRjaGVkKHN0cnVjdCB2Y3B1ICpwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQp
OwogCiAvKiBDYWxsZWQgYnkgdGhlIHNjaGVkdWxlciB0byBjb250aW51ZSBydW5uaW5nIHRoZSBj
dXJyZW50IFZDUFUuICovCiB2b2lkIGNvbnRpbnVlX3J1bm5pbmcoCmRpZmYgLS1naXQgYS94ZW4v
aW5jbHVkZS94ZW4vc29mdGlycS5oIGIveGVuL2luY2x1ZGUveGVuL3NvZnRpcnEuaAppbmRleCBj
MzI3YzliNmNkLi5kNzI3M2IzODliIDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vc29mdGly
cS5oCisrKyBiL3hlbi9pbmNsdWRlL3hlbi9zb2Z0aXJxLmgKQEAgLTQsNiArNCw3IEBACiAvKiBM
b3ctbGF0ZW5jeSBzb2Z0aXJxcyBjb21lIGZpcnN0IGluIHRoZSBmb2xsb3dpbmcgbGlzdC4gKi8K
IGVudW0gewogICAgIFRJTUVSX1NPRlRJUlEgPSAwLAorICAgIFNDSEVEX1NMQVZFX1NPRlRJUlEs
CiAgICAgU0NIRURVTEVfU09GVElSUSwKICAgICBORVdfVExCRkxVU0hfQ0xPQ0tfUEVSSU9EX1NP
RlRJUlEsCiAgICAgUkNVX1NPRlRJUlEsCi0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1k
ZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21h
aWxtYW4vbGlzdGluZm8veGVuLWRldmVs

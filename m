Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id AB03D12D1D4
	for <lists+xen-devel@lfdr.de>; Mon, 30 Dec 2019 17:15:49 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ilxep-0002ZZ-Nf; Mon, 30 Dec 2019 16:12:39 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=0QMt=2U=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1ilxeo-0002Y3-5d
 for xen-devel@lists.xenproject.org; Mon, 30 Dec 2019 16:12:38 +0000
X-Inumbo-ID: 1e03a33f-2b1f-11ea-a04b-12813bfff9fa
Received: from mga14.intel.com (unknown [192.55.52.115])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 1e03a33f-2b1f-11ea-a04b-12813bfff9fa;
 Mon, 30 Dec 2019 16:12:05 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga003.jf.intel.com ([10.7.209.27])
 by fmsmga103.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 30 Dec 2019 08:12:04 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,375,1571727600"; d="scan'208";a="221167393"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.254.94.206])
 by orsmga003.jf.intel.com with ESMTP; 30 Dec 2019 08:12:03 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 30 Dec 2019 08:11:42 -0800
Message-Id: <33e3c8d7f172d27b7f94657edd27b308c9e3abb1.1577721845.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1577721845.git.tamas.lengyel@intel.com>
References: <cover.1577721845.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v3 18/18] xen/tools: VM forking toolstack side
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QWRkIG5lY2Vzc2FyeSBiaXRzIHRvIGltcGxlbWVudCAieGwgZm9yay12bSIsICJ4bCBmb3JrLWxh
dW5jaC1kbSIgYW5kCiJ4bCBmb3JrLXJlc2V0IiBjb21tYW5kcy4gVGhlIHByb2Nlc3MgaXMgc3Bs
aXQgaW4gdHdvIHRvIGFsbG93IHRvb2xzIG5lZWRpbmcKYWNjZXNzIHRvIHRoZSBuZXcgVk0gYXMg
ZmFzdCBhcyBwb3NzaWJsZSBhZnRlciBpdCB3YXMgZm9ya2VkLiBJdCBpcyBleHBlY3RlZAp0aGF0
IHVuZGVyIGNlcnRhaW4gdXNlLWNhc2VzIHRoZSBzZWNvbmQgY29tbWFuZCB0aGF0IGxhdW5jaGVz
IFFFTVUgd2lsbCBiZQpza2lwcGVkIGVudGlyZWx5LgoKU2lnbmVkLW9mZi1ieTogVGFtYXMgSyBM
ZW5neWVsIDx0YW1hcy5sZW5neWVsQGludGVsLmNvbT4KLS0tCiB0b29scy9saWJ4Yy9pbmNsdWRl
L3hlbmN0cmwuaCB8ICAxMyArKwogdG9vbHMvbGlieGMveGNfbWVtc2hyLmMgICAgICAgfCAgMjIg
KysrKwogdG9vbHMvbGlieGwvbGlieGwuaCAgICAgICAgICAgfCAgIDcgKwogdG9vbHMvbGlieGwv
bGlieGxfY3JlYXRlLmMgICAgfCAyMzcgKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0t
LQogdG9vbHMvbGlieGwvbGlieGxfZG0uYyAgICAgICAgfCAgIDIgKy0KIHRvb2xzL2xpYnhsL2xp
YnhsX2RvbS5jICAgICAgIHwgIDgzICsrKysrKysrLS0tLQogdG9vbHMvbGlieGwvbGlieGxfaW50
ZXJuYWwuaCAgfCAgIDEgKwogdG9vbHMvbGlieGwvbGlieGxfdHlwZXMuaWRsICAgfCAgIDEgKwog
dG9vbHMveGwveGwuaCAgICAgICAgICAgICAgICAgfCAgIDUgKwogdG9vbHMveGwveGxfY21kdGFi
bGUuYyAgICAgICAgfCAgMjIgKysrKwogdG9vbHMveGwveGxfc2F2ZXJlc3RvcmUuYyAgICAgfCAg
OTYgKysrKysrKysrKysrKysKIHRvb2xzL3hsL3hsX3ZtY29udHJvbC5jICAgICAgIHwgICA4ICsr
CiAxMiBmaWxlcyBjaGFuZ2VkLCAzOTMgaW5zZXJ0aW9ucygrKSwgMTA0IGRlbGV0aW9ucygtKQoK
ZGlmZiAtLWdpdCBhL3Rvb2xzL2xpYnhjL2luY2x1ZGUveGVuY3RybC5oIGIvdG9vbHMvbGlieGMv
aW5jbHVkZS94ZW5jdHJsLmgKaW5kZXggNzVmMTkxYWUzYS4uZmZiMGJiOWE0MiAxMDA2NDQKLS0t
IGEvdG9vbHMvbGlieGMvaW5jbHVkZS94ZW5jdHJsLmgKKysrIGIvdG9vbHMvbGlieGMvaW5jbHVk
ZS94ZW5jdHJsLmgKQEAgLTIyMjEsNiArMjIyMSwxOSBAQCBpbnQgeGNfbWVtc2hyX3JhbmdlX3No
YXJlKHhjX2ludGVyZmFjZSAqeGNoLAogICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50NjRf
dCBmaXJzdF9nZm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ2NF90IGxhc3RfZ2Zu
KTsKIAoraW50IHhjX21lbXNocl9mb3JrKHhjX2ludGVyZmFjZSAqeGNoLAorICAgICAgICAgICAg
ICAgICAgIHVpbnQzMl90IHNvdXJjZV9kb21haW4sCisgICAgICAgICAgICAgICAgICAgdWludDMy
X3QgY2xpZW50X2RvbWFpbik7CisKKy8qCisgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIG9ubHkg
aW50ZW5kZWQgdG8gYmUgdXNlZCBvbiBzaG9ydC1saXZlZCBmb3JrcyB0aGF0CisgKiBoYXZlbid0
IHlldCBhcXVpcmVkIGEgbG90IG9mIG1lbW9yeS4gSW4gY2FzZSB0aGUgZm9yayBoYXMgYSBsb3Qg
b2YgbWVtb3J5CisgKiBpdCBpcyBsaWtlbHkgbW9yZSBwZXJmb3JtYW50IHRvIGNyZWF0ZSBhIG5l
dyBmb3JrIHdpdGggeGNfbWVtc2hyX2ZvcmsuCisgKgorICogV2l0aCBWTXMgdGhhdCBoYXZlIGEg
bG90IG9mIG1lbW9yeSB0aGlzIGNhbGwgbWF5IGJsb2NrIGZvciBhIGxvbmcgdGltZS4KKyAqLwor
aW50IHhjX21lbXNocl9mb3JrX3Jlc2V0KHhjX2ludGVyZmFjZSAqeGNoLCB1aW50MzJfdCBmb3Jr
ZWRfZG9tYWluKTsKKwogLyogRGVidWcgY2FsbHM6IHJldHVybiB0aGUgbnVtYmVyIG9mIHBhZ2Vz
IHJlZmVyZW5jaW5nIHRoZSBzaGFyZWQgZnJhbWUgYmFja2luZwogICogdGhlIGlucHV0IGFyZ3Vt
ZW50LiBTaG91bGQgYmUgb25lIG9yIGdyZWF0ZXIuCiAgKgpkaWZmIC0tZ2l0IGEvdG9vbHMvbGli
eGMveGNfbWVtc2hyLmMgYi90b29scy9saWJ4Yy94Y19tZW1zaHIuYwppbmRleCA5N2UyZTZhOGQ5
Li5kMGU0ZWUyMjViIDEwMDY0NAotLS0gYS90b29scy9saWJ4Yy94Y19tZW1zaHIuYworKysgYi90
b29scy9saWJ4Yy94Y19tZW1zaHIuYwpAQCAtMjM5LDYgKzIzOSwyOCBAQCBpbnQgeGNfbWVtc2hy
X2RlYnVnX2dyZWYoeGNfaW50ZXJmYWNlICp4Y2gsCiAgICAgcmV0dXJuIHhjX21lbXNocl9tZW1v
cCh4Y2gsIGRvbWlkLCAmbXNvKTsKIH0KIAoraW50IHhjX21lbXNocl9mb3JrKHhjX2ludGVyZmFj
ZSAqeGNoLCB1aW50MzJfdCBwZG9taWQsIHVpbnQzMl90IGRvbWlkKQoreworICAgIHhlbl9tZW1f
c2hhcmluZ19vcF90IG1zbzsKKworICAgIG1lbXNldCgmbXNvLCAwLCBzaXplb2YobXNvKSk7CisK
KyAgICBtc28ub3AgPSBYRU5NRU1fc2hhcmluZ19vcF9mb3JrOworICAgIG1zby51LmZvcmsucGFy
ZW50X2RvbWFpbiA9IHBkb21pZDsKKworICAgIHJldHVybiB4Y19tZW1zaHJfbWVtb3AoeGNoLCBk
b21pZCwgJm1zbyk7Cit9CisKK2ludCB4Y19tZW1zaHJfZm9ya19yZXNldCh4Y19pbnRlcmZhY2Ug
KnhjaCwgdWludDMyX3QgZG9taWQpCit7CisgICAgeGVuX21lbV9zaGFyaW5nX29wX3QgbXNvOwor
CisgICAgbWVtc2V0KCZtc28sIDAsIHNpemVvZihtc28pKTsKKyAgICBtc28ub3AgPSBYRU5NRU1f
c2hhcmluZ19vcF9mb3JrX3Jlc2V0OworCisgICAgcmV0dXJuIHhjX21lbXNocl9tZW1vcCh4Y2gs
IGRvbWlkLCAmbXNvKTsKK30KKwogaW50IHhjX21lbXNocl9hdWRpdCh4Y19pbnRlcmZhY2UgKnhj
aCkKIHsKICAgICB4ZW5fbWVtX3NoYXJpbmdfb3BfdCBtc287CmRpZmYgLS1naXQgYS90b29scy9s
aWJ4bC9saWJ4bC5oIGIvdG9vbHMvbGlieGwvbGlieGwuaAppbmRleCA1NGFiYjlkYjFmLi43NWNi
MDcwNTg3IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bC5oCisrKyBiL3Rvb2xzL2xpYnhs
L2xpYnhsLmgKQEAgLTE1MzYsNiArMTUzNiwxMyBAQCBpbnQgbGlieGxfZG9tYWluX2NyZWF0ZV9u
ZXcobGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpYnhsX2FzeW5jb3BfaG93ICphb19ob3csCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlieGxfYXN5bmNwcm9ncmVzc19ob3cg
KmFvcF9jb25zb2xlX2hvdykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMSUJYTF9FWFRF
Uk5BTF9DQUxMRVJTX09OTFk7CitpbnQgbGlieGxfZG9tYWluX2Zvcmtfdm0obGlieGxfY3R4ICpj
dHgsIHVpbnQzMl90IHBkb21pZCwgdWludDMyX3QgKmRvbWlkKQorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBMSUJYTF9FWFRFUk5BTF9DQUxMRVJTX09OTFk7CitpbnQgbGlieGxfZG9tYWlu
X2ZvcmtfbGF1bmNoX2RtKGxpYnhsX2N0eCAqY3R4LCBsaWJ4bF9kb21haW5fY29uZmlnICpkX2Nv
bmZpZywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgZG9taWQsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpYnhsX2FzeW5jcHJvZ3Jlc3Nf
aG93ICphb3BfY29uc29sZV9ob3cpCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExJ
QlhMX0VYVEVSTkFMX0NBTExFUlNfT05MWTsKK2ludCBsaWJ4bF9kb21haW5fZm9ya19yZXNldChs
aWJ4bF9jdHggKmN0eCwgdWludDMyX3QgZG9taWQpOwogaW50IGxpYnhsX2RvbWFpbl9jcmVhdGVf
cmVzdG9yZShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcsCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90ICpkb21pZCwgaW50IHJlc3Rv
cmVfZmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBzZW5kX2JhY2tfZmQs
CmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9jcmVhdGUuYyBiL3Rvb2xzL2xpYnhsL2xp
YnhsX2NyZWF0ZS5jCmluZGV4IDMyZDQ1ZGNlZjAuLmUwZDIxOTU5NmMgMTAwNjQ0Ci0tLSBhL3Rv
b2xzL2xpYnhsL2xpYnhsX2NyZWF0ZS5jCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2NyZWF0ZS5j
CkBAIC01MzYsMTIgKzUzNiwxMiBAQCBvdXQ6CiAgICAgcmV0dXJuIHJldDsKIH0KIAotaW50IGxp
YnhsX19kb21haW5fbWFrZShsaWJ4bF9fZ2MgKmdjLCBsaWJ4bF9kb21haW5fY29uZmlnICpkX2Nv
bmZpZywKLSAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfX2RvbWFpbl9idWlsZF9zdGF0ZSAq
c3RhdGUsCi0gICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90ICpkb21pZCkKK3N0YXRpYyBp
bnQgbGlieGxfX2RvbWFpbl9tYWtlX3hzX2VudHJpZXMobGlieGxfX2djICpnYywgbGlieGxfZG9t
YWluX2NvbmZpZyAqZF9jb25maWcsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIGxpYnhsX19kb21haW5fYnVpbGRfc3RhdGUgKnN0YXRlLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50MzJfdCBkb21pZCkKIHsKICAgICBsaWJ4bF9j
dHggKmN0eCA9IGxpYnhsX19nY19vd25lcihnYyk7Ci0gICAgaW50IHJldCwgcmMsIG5iX3ZtOwor
ICAgIGludCByYywgbmJfdm07CiAgICAgY29uc3QgY2hhciAqZG9tX3R5cGU7CiAgICAgY2hhciAq
dXVpZF9zdHJpbmc7CiAgICAgY2hhciAqZG9tX3BhdGgsICp2bV9wYXRoLCAqbGlieGxfcGF0aDsK
QEAgLTU1Myw3ICs1NTMsNiBAQCBpbnQgbGlieGxfX2RvbWFpbl9tYWtlKGxpYnhsX19nYyAqZ2Ms
IGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogCiAgICAgLyogY29udmVuaWVuY2UgYWxp
YXNlcyAqLwogICAgIGxpYnhsX2RvbWFpbl9jcmVhdGVfaW5mbyAqaW5mbyA9ICZkX2NvbmZpZy0+
Y19pbmZvOwotICAgIGxpYnhsX2RvbWFpbl9idWlsZF9pbmZvICpiX2luZm8gPSAmZF9jb25maWct
PmJfaW5mbzsKIAogICAgIHV1aWRfc3RyaW5nID0gbGlieGxfX3V1aWQyc3RyaW5nKGdjLCBpbmZv
LT51dWlkKTsKICAgICBpZiAoIXV1aWRfc3RyaW5nKSB7CkBAIC01NjEsNjQgKzU2MCw3IEBAIGlu
dCBsaWJ4bF9fZG9tYWluX21ha2UobGlieGxfX2djICpnYywgbGlieGxfZG9tYWluX2NvbmZpZyAq
ZF9jb25maWcsCiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0KIAotICAgIC8qIFZhbGlkIGRvbWlk
IGhlcmUgbWVhbnMgd2UncmUgc29mdCByZXNldHRpbmcuICovCi0gICAgaWYgKCFsaWJ4bF9kb21p
ZF92YWxpZF9ndWVzdCgqZG9taWQpKSB7Ci0gICAgICAgIHN0cnVjdCB4ZW5fZG9tY3RsX2NyZWF0
ZWRvbWFpbiBjcmVhdGUgPSB7Ci0gICAgICAgICAgICAuc3NpZHJlZiA9IGluZm8tPnNzaWRyZWYs
Ci0gICAgICAgICAgICAubWF4X3ZjcHVzID0gYl9pbmZvLT5tYXhfdmNwdXMsCi0gICAgICAgICAg
ICAubWF4X2V2dGNobl9wb3J0ID0gYl9pbmZvLT5ldmVudF9jaGFubmVscywKLSAgICAgICAgICAg
IC5tYXhfZ3JhbnRfZnJhbWVzID0gYl9pbmZvLT5tYXhfZ3JhbnRfZnJhbWVzLAotICAgICAgICAg
ICAgLm1heF9tYXB0cmFja19mcmFtZXMgPSBiX2luZm8tPm1heF9tYXB0cmFja19mcmFtZXMsCi0g
ICAgICAgIH07Ci0KLSAgICAgICAgaWYgKGluZm8tPnR5cGUgIT0gTElCWExfRE9NQUlOX1RZUEVf
UFYpIHsKLSAgICAgICAgICAgIGNyZWF0ZS5mbGFncyB8PSBYRU5fRE9NQ1RMX0NERl9odm07Ci0g
ICAgICAgICAgICBjcmVhdGUuZmxhZ3MgfD0KLSAgICAgICAgICAgICAgICBsaWJ4bF9kZWZib29s
X3ZhbChpbmZvLT5oYXApID8gWEVOX0RPTUNUTF9DREZfaGFwIDogMDsKLSAgICAgICAgICAgIGNy
ZWF0ZS5mbGFncyB8PQotICAgICAgICAgICAgICAgIGxpYnhsX2RlZmJvb2xfdmFsKGluZm8tPm9v
cykgPyAwIDogWEVOX0RPTUNUTF9DREZfb29zX29mZjsKLSAgICAgICAgfQotCi0gICAgICAgIGFz
c2VydChpbmZvLT5wYXNzdGhyb3VnaCAhPSBMSUJYTF9QQVNTVEhST1VHSF9ERUZBVUxUKTsKLSAg
ICAgICAgTE9HKERFVEFJTCwgInBhc3N0aHJvdWdoOiAlcyIsCi0gICAgICAgICAgICBsaWJ4bF9w
YXNzdGhyb3VnaF90b19zdHJpbmcoaW5mby0+cGFzc3Rocm91Z2gpKTsKLQotICAgICAgICBpZiAo
aW5mby0+cGFzc3Rocm91Z2ggIT0gTElCWExfUEFTU1RIUk9VR0hfRElTQUJMRUQpCi0gICAgICAg
ICAgICBjcmVhdGUuZmxhZ3MgfD0gWEVOX0RPTUNUTF9DREZfaW9tbXU7Ci0KLSAgICAgICAgaWYg
KGluZm8tPnBhc3N0aHJvdWdoID09IExJQlhMX1BBU1NUSFJPVUdIX1NZTkNfUFQpCi0gICAgICAg
ICAgICBjcmVhdGUuaW9tbXVfb3B0cyB8PSBYRU5fRE9NQ1RMX0lPTU1VX25vX3NoYXJlcHQ7Ci0K
LSAgICAgICAgLyogVWx0aW1hdGVseSwgaGFuZGxlIGlzIGFuIGFycmF5IG9mIDE2IHVpbnQ4X3Qs
IHNhbWUgYXMgdXVpZCAqLwotICAgICAgICBsaWJ4bF91dWlkX2NvcHkoY3R4LCAobGlieGxfdXVp
ZCAqKSZjcmVhdGUuaGFuZGxlLCAmaW5mby0+dXVpZCk7Ci0KLSAgICAgICAgcmV0ID0gbGlieGxf
X2FyY2hfZG9tYWluX3ByZXBhcmVfY29uZmlnKGdjLCBkX2NvbmZpZywgJmNyZWF0ZSk7Ci0gICAg
ICAgIGlmIChyZXQgPCAwKSB7Ci0gICAgICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlkLCAiZmFp
bCB0byBnZXQgZG9tYWluIGNvbmZpZyIpOwotICAgICAgICAgICAgcmMgPSBFUlJPUl9GQUlMOwot
ICAgICAgICAgICAgZ290byBvdXQ7Ci0gICAgICAgIH0KLQotICAgICAgICByZXQgPSB4Y19kb21h
aW5fY3JlYXRlKGN0eC0+eGNoLCBkb21pZCwgJmNyZWF0ZSk7Ci0gICAgICAgIGlmIChyZXQgPCAw
KSB7Ci0gICAgICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlkLCAiZG9tYWluIGNyZWF0aW9uIGZh
aWwiKTsKLSAgICAgICAgICAgIHJjID0gRVJST1JfRkFJTDsKLSAgICAgICAgICAgIGdvdG8gb3V0
OwotICAgICAgICB9Ci0KLSAgICAgICAgcmMgPSBsaWJ4bF9fYXJjaF9kb21haW5fc2F2ZV9jb25m
aWcoZ2MsIGRfY29uZmlnLCBzdGF0ZSwgJmNyZWF0ZSk7Ci0gICAgICAgIGlmIChyYyA8IDApCi0g
ICAgICAgICAgICBnb3RvIG91dDsKLSAgICB9Ci0KLSAgICByZXQgPSB4Y19jcHVwb29sX21vdmVk
b21haW4oY3R4LT54Y2gsIGluZm8tPnBvb2xpZCwgKmRvbWlkKTsKLSAgICBpZiAocmV0IDwgMCkg
ewotICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlkLCAiZG9tYWluIG1vdmUgZmFpbCIpOwotICAg
ICAgICByYyA9IEVSUk9SX0ZBSUw7Ci0gICAgICAgIGdvdG8gb3V0OwotICAgIH0KLQotICAgIGRv
bV9wYXRoID0gbGlieGxfX3hzX2dldF9kb21wYXRoKGdjLCAqZG9taWQpOworICAgIGRvbV9wYXRo
ID0gbGlieGxfX3hzX2dldF9kb21wYXRoKGdjLCBkb21pZCk7CiAgICAgaWYgKCFkb21fcGF0aCkg
ewogICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CiAgICAgICAgIGdvdG8gb3V0OwpAQCAtNjI2LDEy
ICs1NjgsMTIgQEAgaW50IGxpYnhsX19kb21haW5fbWFrZShsaWJ4bF9fZ2MgKmdjLCBsaWJ4bF9k
b21haW5fY29uZmlnICpkX2NvbmZpZywKIAogICAgIHZtX3BhdGggPSBHQ1NQUklOVEYoIi92bS8l
cyIsIHV1aWRfc3RyaW5nKTsKICAgICBpZiAoIXZtX3BhdGgpIHsKLSAgICAgICAgTE9HRChFUlJP
UiwgKmRvbWlkLCAiY2Fubm90IGFsbG9jYXRlIGNyZWF0ZSBwYXRocyIpOworICAgICAgICBMT0dE
KEVSUk9SLCBkb21pZCwgImNhbm5vdCBhbGxvY2F0ZSBjcmVhdGUgcGF0aHMiKTsKICAgICAgICAg
cmMgPSBFUlJPUl9GQUlMOwogICAgICAgICBnb3RvIG91dDsKICAgICB9CiAKLSAgICBsaWJ4bF9w
YXRoID0gbGlieGxfX3hzX2xpYnhsX3BhdGgoZ2MsICpkb21pZCk7CisgICAgbGlieGxfcGF0aCA9
IGxpYnhsX194c19saWJ4bF9wYXRoKGdjLCBkb21pZCk7CiAgICAgaWYgKCFsaWJ4bF9wYXRoKSB7
CiAgICAgICAgIHJjID0gRVJST1JfRkFJTDsKICAgICAgICAgZ290byBvdXQ7CkBAIC02NDIsMTAg
KzU4NCwxMCBAQCBpbnQgbGlieGxfX2RvbWFpbl9tYWtlKGxpYnhsX19nYyAqZ2MsIGxpYnhsX2Rv
bWFpbl9jb25maWcgKmRfY29uZmlnLAogCiAgICAgcm9wZXJtWzBdLmlkID0gMDsKICAgICByb3Bl
cm1bMF0ucGVybXMgPSBYU19QRVJNX05PTkU7Ci0gICAgcm9wZXJtWzFdLmlkID0gKmRvbWlkOwor
ICAgIHJvcGVybVsxXS5pZCA9IGRvbWlkOwogICAgIHJvcGVybVsxXS5wZXJtcyA9IFhTX1BFUk1f
UkVBRDsKIAotICAgIHJ3cGVybVswXS5pZCA9ICpkb21pZDsKKyAgICByd3Blcm1bMF0uaWQgPSBk
b21pZDsKICAgICByd3Blcm1bMF0ucGVybXMgPSBYU19QRVJNX05PTkU7CiAKIHJldHJ5X3RyYW5z
YWN0aW9uOgpAQCAtNjYzLDcgKzYwNSw3IEBAIHJldHJ5X3RyYW5zYWN0aW9uOgogICAgICAgICAg
ICAgICAgICAgICBub3Blcm0sIEFSUkFZX1NJWkUobm9wZXJtKSk7CiAKICAgICB4c193cml0ZShj
dHgtPnhzaCwgdCwgR0NTUFJJTlRGKCIlcy92bSIsIGRvbV9wYXRoKSwgdm1fcGF0aCwgc3RybGVu
KHZtX3BhdGgpKTsKLSAgICByYyA9IGxpYnhsX19kb21haW5fcmVuYW1lKGdjLCAqZG9taWQsIDAs
IGluZm8tPm5hbWUsIHQpOworICAgIHJjID0gbGlieGxfX2RvbWFpbl9yZW5hbWUoZ2MsIGRvbWlk
LCAwLCBpbmZvLT5uYW1lLCB0KTsKICAgICBpZiAocmMpCiAgICAgICAgIGdvdG8gb3V0OwogCkBA
IC03NDAsNyArNjgyLDcgQEAgcmV0cnlfdHJhbnNhY3Rpb246CiAKICAgICB2bV9saXN0ID0gbGli
eGxfbGlzdF92bShjdHgsICZuYl92bSk7CiAgICAgaWYgKCF2bV9saXN0KSB7Ci0gICAgICAgIExP
R0QoRVJST1IsICpkb21pZCwgImNhbm5vdCBnZXQgbnVtYmVyIG9mIHJ1bm5pbmcgZ3Vlc3RzIik7
CisgICAgICAgIExPR0QoRVJST1IsIGRvbWlkLCAiY2Fubm90IGdldCBudW1iZXIgb2YgcnVubmlu
ZyBndWVzdHMiKTsKICAgICAgICAgcmMgPSBFUlJPUl9GQUlMOwogICAgICAgICBnb3RvIG91dDsK
ICAgICB9CkBAIC03NjQsNyArNzA2LDcgQEAgcmV0cnlfdHJhbnNhY3Rpb246CiAgICAgICAgICAg
ICB0ID0gMDsKICAgICAgICAgICAgIGdvdG8gcmV0cnlfdHJhbnNhY3Rpb247CiAgICAgICAgIH0K
LSAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImRvbWFpbiBjcmVhdGlvbiAiInhlbnN0b3Jl
IHRyYW5zYWN0aW9uIGNvbW1pdCBmYWlsZWQiKTsKKyAgICAgICAgTE9HRUQoRVJST1IsIGRvbWlk
LCAiZG9tYWluIGNyZWF0aW9uICIieGVuc3RvcmUgdHJhbnNhY3Rpb24gY29tbWl0IGZhaWxlZCIp
OwogICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0KQEAg
LTc3Niw2ICs3MTgsODAgQEAgcmV0cnlfdHJhbnNhY3Rpb246CiAgICAgcmV0dXJuIHJjOwogfQog
CitpbnQgbGlieGxfX2RvbWFpbl9tYWtlKGxpYnhsX19nYyAqZ2MsIGxpYnhsX2RvbWFpbl9jb25m
aWcgKmRfY29uZmlnLAorICAgICAgICAgICAgICAgICAgICAgICBsaWJ4bF9fZG9tYWluX2J1aWxk
X3N0YXRlICpzdGF0ZSwKKyAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgKmRvbWlkKQor
eworICAgIGxpYnhsX2N0eCAqY3R4ID0gbGlieGxfX2djX293bmVyKGdjKTsKKyAgICBpbnQgcmV0
LCByYzsKKworICAgIC8qIGNvbnZlbmllbmNlIGFsaWFzZXMgKi8KKyAgICBsaWJ4bF9kb21haW5f
Y3JlYXRlX2luZm8gKmluZm8gPSAmZF9jb25maWctPmNfaW5mbzsKKyAgICBsaWJ4bF9kb21haW5f
YnVpbGRfaW5mbyAqYl9pbmZvID0gJmRfY29uZmlnLT5iX2luZm87CisKKyAgICAvKiBWYWxpZCBk
b21pZCBoZXJlIG1lYW5zIHdlJ3JlIHNvZnQgcmVzZXR0aW5nLiAqLworICAgIGlmICghbGlieGxf
ZG9taWRfdmFsaWRfZ3Vlc3QoKmRvbWlkKSkgeworICAgICAgICBzdHJ1Y3QgeGVuX2RvbWN0bF9j
cmVhdGVkb21haW4gY3JlYXRlID0geworICAgICAgICAgICAgLnNzaWRyZWYgPSBpbmZvLT5zc2lk
cmVmLAorICAgICAgICAgICAgLm1heF92Y3B1cyA9IGJfaW5mby0+bWF4X3ZjcHVzLAorICAgICAg
ICAgICAgLm1heF9ldnRjaG5fcG9ydCA9IGJfaW5mby0+ZXZlbnRfY2hhbm5lbHMsCisgICAgICAg
ICAgICAubWF4X2dyYW50X2ZyYW1lcyA9IGJfaW5mby0+bWF4X2dyYW50X2ZyYW1lcywKKyAgICAg
ICAgICAgIC5tYXhfbWFwdHJhY2tfZnJhbWVzID0gYl9pbmZvLT5tYXhfbWFwdHJhY2tfZnJhbWVz
LAorICAgICAgICB9OworCisgICAgICAgIGlmIChpbmZvLT50eXBlICE9IExJQlhMX0RPTUFJTl9U
WVBFX1BWKSB7CisgICAgICAgICAgICBjcmVhdGUuZmxhZ3MgfD0gWEVOX0RPTUNUTF9DREZfaHZt
OworICAgICAgICAgICAgY3JlYXRlLmZsYWdzIHw9CisgICAgICAgICAgICAgICAgbGlieGxfZGVm
Ym9vbF92YWwoaW5mby0+aGFwKSA/IFhFTl9ET01DVExfQ0RGX2hhcCA6IDA7CisgICAgICAgICAg
ICBjcmVhdGUuZmxhZ3MgfD0KKyAgICAgICAgICAgICAgICBsaWJ4bF9kZWZib29sX3ZhbChpbmZv
LT5vb3MpID8gMCA6IFhFTl9ET01DVExfQ0RGX29vc19vZmY7CisgICAgICAgIH0KKworICAgICAg
ICBhc3NlcnQoaW5mby0+cGFzc3Rocm91Z2ggIT0gTElCWExfUEFTU1RIUk9VR0hfREVGQVVMVCk7
CisgICAgICAgIExPRyhERVRBSUwsICJwYXNzdGhyb3VnaDogJXMiLAorICAgICAgICAgICAgbGli
eGxfcGFzc3Rocm91Z2hfdG9fc3RyaW5nKGluZm8tPnBhc3N0aHJvdWdoKSk7CisKKyAgICAgICAg
aWYgKGluZm8tPnBhc3N0aHJvdWdoICE9IExJQlhMX1BBU1NUSFJPVUdIX0RJU0FCTEVEKQorICAg
ICAgICAgICAgY3JlYXRlLmZsYWdzIHw9IFhFTl9ET01DVExfQ0RGX2lvbW11OworCisgICAgICAg
IGlmIChpbmZvLT5wYXNzdGhyb3VnaCA9PSBMSUJYTF9QQVNTVEhST1VHSF9TWU5DX1BUKQorICAg
ICAgICAgICAgY3JlYXRlLmlvbW11X29wdHMgfD0gWEVOX0RPTUNUTF9JT01NVV9ub19zaGFyZXB0
OworCisgICAgICAgIC8qIFVsdGltYXRlbHksIGhhbmRsZSBpcyBhbiBhcnJheSBvZiAxNiB1aW50
OF90LCBzYW1lIGFzIHV1aWQgKi8KKyAgICAgICAgbGlieGxfdXVpZF9jb3B5KGN0eCwgKGxpYnhs
X3V1aWQgKikmY3JlYXRlLmhhbmRsZSwgJmluZm8tPnV1aWQpOworCisgICAgICAgIHJldCA9IGxp
YnhsX19hcmNoX2RvbWFpbl9wcmVwYXJlX2NvbmZpZyhnYywgZF9jb25maWcsICZjcmVhdGUpOwor
ICAgICAgICBpZiAocmV0IDwgMCkgeworICAgICAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwg
ImZhaWwgdG8gZ2V0IGRvbWFpbiBjb25maWciKTsKKyAgICAgICAgICAgIHJjID0gRVJST1JfRkFJ
TDsKKyAgICAgICAgICAgIGdvdG8gb3V0OworICAgICAgICB9CisKKyAgICAgICAgcmV0ID0geGNf
ZG9tYWluX2NyZWF0ZShjdHgtPnhjaCwgZG9taWQsICZjcmVhdGUpOworICAgICAgICBpZiAocmV0
IDwgMCkgeworICAgICAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImRvbWFpbiBjcmVhdGlv
biBmYWlsIik7CisgICAgICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CisgICAgICAgICAgICBnb3Rv
IG91dDsKKyAgICAgICAgfQorCisgICAgICAgIHJjID0gbGlieGxfX2FyY2hfZG9tYWluX3NhdmVf
Y29uZmlnKGdjLCBkX2NvbmZpZywgc3RhdGUsICZjcmVhdGUpOworICAgICAgICBpZiAocmMgPCAw
KQorICAgICAgICAgICAgZ290byBvdXQ7CisgICAgfQorCisgICAgcmV0ID0geGNfY3B1cG9vbF9t
b3ZlZG9tYWluKGN0eC0+eGNoLCBpbmZvLT5wb29saWQsICpkb21pZCk7CisgICAgaWYgKHJldCA8
IDApIHsKKyAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImRvbWFpbiBtb3ZlIGZhaWwiKTsK
KyAgICAgICAgcmMgPSBFUlJPUl9GQUlMOworICAgICAgICBnb3RvIG91dDsKKyAgICB9CisKKyAg
ICByYyA9IGxpYnhsX19kb21haW5fbWFrZV94c19lbnRyaWVzKGdjLCBkX2NvbmZpZywgc3RhdGUs
ICpkb21pZCk7CisKK291dDoKKyAgICByZXR1cm4gcmM7Cit9CisKIHN0YXRpYyBpbnQgc3RvcmVf
bGlieGxfZW50cnkobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGxpYnhsX2RvbWFpbl9idWlsZF9pbmZvICpiX2luZm8pCiB7CkBAIC0x
MDk3LDE1ICsxMTEzLDMxIEBAIHN0YXRpYyB2b2lkIGluaXRpYXRlX2RvbWFpbl9jcmVhdGUobGli
eGxfX2VnYyAqZWdjLAogICAgIHJldCA9IGxpYnhsX19kb21haW5fY29uZmlnX3NldGRlZmF1bHQo
Z2MsZF9jb25maWcsZG9taWQpOwogICAgIGlmIChyZXQpIGdvdG8gZXJyb3Jfb3V0OwogCi0gICAg
cmV0ID0gbGlieGxfX2RvbWFpbl9tYWtlKGdjLCBkX2NvbmZpZywgJmRjcy0+YnVpbGRfc3RhdGUs
ICZkb21pZCk7Ci0gICAgaWYgKHJldCkgewotICAgICAgICBMT0dEKEVSUk9SLCBkb21pZCwgImNh
bm5vdCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOworICAgIGlmICggIWRfY29uZmlnLT5kbV9yZXN0
b3JlX2ZpbGUgKQorICAgIHsKKyAgICAgICAgcmV0ID0gbGlieGxfX2RvbWFpbl9tYWtlKGdjLCBk
X2NvbmZpZywgJmRjcy0+YnVpbGRfc3RhdGUsICZkb21pZCk7CiAgICAgICAgIGRjcy0+Z3Vlc3Rf
ZG9taWQgPSBkb21pZDsKKworICAgICAgICBpZiAocmV0KSB7CisgICAgICAgICAgICBMT0dEKEVS
Uk9SLCBkb21pZCwgImNhbm5vdCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOworICAgICAgICAgICAg
cmV0ID0gRVJST1JfRkFJTDsKKyAgICAgICAgICAgIGdvdG8gZXJyb3Jfb3V0OworICAgICAgICB9
CisgICAgfSBlbHNlIGlmICggZGNzLT5ndWVzdF9kb21pZCAhPSBJTlZBTElEX0RPTUlEICkgewor
ICAgICAgICBkb21pZCA9IGRjcy0+Z3Vlc3RfZG9taWQ7CisKKyAgICAgICAgcmV0ID0gbGlieGxf
X2RvbWFpbl9tYWtlX3hzX2VudHJpZXMoZ2MsIGRfY29uZmlnLCAmZGNzLT5idWlsZF9zdGF0ZSwg
ZG9taWQpOworICAgICAgICBpZiAocmV0KSB7CisgICAgICAgICAgICBMT0dEKEVSUk9SLCBkb21p
ZCwgImNhbm5vdCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOworICAgICAgICAgICAgcmV0ID0gRVJS
T1JfRkFJTDsKKyAgICAgICAgICAgIGdvdG8gZXJyb3Jfb3V0OworICAgICAgICB9CisgICAgfSBl
bHNlIHsKKyAgICAgICAgTE9HRChFUlJPUiwgZG9taWQsICJjYW5ub3QgbWFrZSBkb21haW4iKTsK
ICAgICAgICAgcmV0ID0gRVJST1JfRkFJTDsKICAgICAgICAgZ290byBlcnJvcl9vdXQ7CiAgICAg
fQogCi0gICAgZGNzLT5ndWVzdF9kb21pZCA9IGRvbWlkOwogICAgIGRjcy0+c2Rzcy5kbS5ndWVz
dF9kb21pZCA9IDA7IC8qIG1lYW5zIHdlIGhhdmVuJ3Qgc3Bhd25lZCAqLwogCiAgICAgLyogcG9z
dC00LjEzIHRvZG86IG1vdmUgdGhlc2UgbmV4dCBiaXRzIG9mIGRlZmF1bHRpbmcgdG8KQEAgLTEx
NDEsNyArMTE3Myw3IEBAIHN0YXRpYyB2b2lkIGluaXRpYXRlX2RvbWFpbl9jcmVhdGUobGlieGxf
X2VnYyAqZWdjLAogICAgIGlmIChyZXQpCiAgICAgICAgIGdvdG8gZXJyb3Jfb3V0OwogCi0gICAg
aWYgKHJlc3RvcmVfZmQgPj0gMCB8fCBkY3MtPmRvbWlkX3NvZnRfcmVzZXQgIT0gSU5WQUxJRF9E
T01JRCkgeworICAgIGlmIChyZXN0b3JlX2ZkID49IDAgfHwgZGNzLT5kb21pZF9zb2Z0X3Jlc2V0
ICE9IElOVkFMSURfRE9NSUQgfHwgZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSkgewogICAgICAg
ICBMT0dEKERFQlVHLCBkb21pZCwgInJlc3RvcmluZywgbm90IHJ1bm5pbmcgYm9vdGxvYWRlciIp
OwogICAgICAgICBkb21jcmVhdGVfYm9vdGxvYWRlcl9kb25lKGVnYywgJmRjcy0+YmwsIDApOwog
ICAgIH0gZWxzZSAgewpAQCAtMTIxNyw3ICsxMjQ5LDE2IEBAIHN0YXRpYyB2b2lkIGRvbWNyZWF0
ZV9ib290bG9hZGVyX2RvbmUobGlieGxfX2VnYyAqZWdjLAogICAgIGRjcy0+c2Rzcy5kbS5jYWxs
YmFjayA9IGRvbWNyZWF0ZV9kZXZtb2RlbF9zdGFydGVkOwogICAgIGRjcy0+c2Rzcy5jYWxsYmFj
ayA9IGRvbWNyZWF0ZV9kZXZtb2RlbF9zdGFydGVkOwogCi0gICAgaWYgKHJlc3RvcmVfZmQgPCAw
ICYmIGRjcy0+ZG9taWRfc29mdF9yZXNldCA9PSBJTlZBTElEX0RPTUlEKSB7CisgICAgaWYgKHJl
c3RvcmVfZmQgPCAwICYmIGRjcy0+ZG9taWRfc29mdF9yZXNldCA9PSBJTlZBTElEX0RPTUlEICYm
ICFkX2NvbmZpZy0+ZG1fcmVzdG9yZV9maWxlKSB7CisgICAgICAgIHJjID0gbGlieGxfX2RvbWFp
bl9idWlsZChnYywgZF9jb25maWcsIGRvbWlkLCBzdGF0ZSk7CisgICAgICAgIGRvbWNyZWF0ZV9y
ZWJ1aWxkX2RvbmUoZWdjLCBkY3MsIHJjKTsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAg
IGlmICggZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSApIHsKKyAgICAgICAgZGNzLT5zcnMuZGNz
ID0gZGNzOworICAgICAgICBkY3MtPnNycy5hbyA9IGFvOworICAgICAgICBzdGF0ZS0+Zm9ya2Vk
X3ZtID0gdHJ1ZTsKICAgICAgICAgcmMgPSBsaWJ4bF9fZG9tYWluX2J1aWxkKGdjLCBkX2NvbmZp
ZywgZG9taWQsIHN0YXRlKTsKICAgICAgICAgZG9tY3JlYXRlX3JlYnVpbGRfZG9uZShlZ2MsIGRj
cywgcmMpOwogICAgICAgICByZXR1cm47CkBAIC0xNDE1LDYgKzE0NTYsNyBAQCBzdGF0aWMgdm9p
ZCBkb21jcmVhdGVfcmVidWlsZF9kb25lKGxpYnhsX19lZ2MgKmVnYywKICAgICAvKiBjb252ZW5p
ZW5jZSBhbGlhc2VzICovCiAgICAgY29uc3QgdWludDMyX3QgZG9taWQgPSBkY3MtPmd1ZXN0X2Rv
bWlkOwogICAgIGxpYnhsX2RvbWFpbl9jb25maWcgKmNvbnN0IGRfY29uZmlnID0gZGNzLT5ndWVz
dF9jb25maWc7CisgICAgbGlieGxfX2RvbWFpbl9idWlsZF9zdGF0ZSAqY29uc3Qgc3RhdGUgPSAm
ZGNzLT5idWlsZF9zdGF0ZTsKIAogICAgIGlmIChyZXQpIHsKICAgICAgICAgTE9HRChFUlJPUiwg
ZG9taWQsICJjYW5ub3QgKHJlLSlidWlsZCBkb21haW46ICVkIiwgcmV0KTsKQEAgLTE0MjIsNiAr
MTQ2NCw5IEBAIHN0YXRpYyB2b2lkIGRvbWNyZWF0ZV9yZWJ1aWxkX2RvbmUobGlieGxfX2VnYyAq
ZWdjLAogICAgICAgICBnb3RvIGVycm9yX291dDsKICAgICB9CiAKKyAgICBpZiAoIGRfY29uZmln
LT5kbV9yZXN0b3JlX2ZpbGUgKQorICAgICAgICBzdGF0ZS0+c2F2ZWRfc3RhdGUgPSBHQ1NQUklO
VEYoIiVzIiwgZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSk7CisKICAgICBzdG9yZV9saWJ4bF9l
bnRyeShnYywgZG9taWQsICZkX2NvbmZpZy0+Yl9pbmZvKTsKIAogICAgIGxpYnhsX19tdWx0aWRl
dl9iZWdpbihhbywgJmRjcy0+bXVsdGlkZXYpOwpAQCAtMTgyMywxMCArMTg2OCwxMyBAQCBzdGF0
aWMgaW50IGRvX2RvbWFpbl9jcmVhdGUobGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25m
aWcgKmRfY29uZmlnLAogICAgIEdDTkVXKGNkY3MpOwogICAgIGNkY3MtPmRjcy5hbyA9IGFvOwog
ICAgIGNkY3MtPmRjcy5ndWVzdF9jb25maWcgPSBkX2NvbmZpZzsKKyAgICBjZGNzLT5kY3MuZ3Vl
c3RfZG9taWQgPSAqZG9taWQ7CisKICAgICBsaWJ4bF9kb21haW5fY29uZmlnX2luaXQoJmNkY3Mt
PmRjcy5ndWVzdF9jb25maWdfc2F2ZWQpOwogICAgIGxpYnhsX2RvbWFpbl9jb25maWdfY29weShj
dHgsICZjZGNzLT5kY3MuZ3Vlc3RfY29uZmlnX3NhdmVkLCBkX2NvbmZpZyk7CiAgICAgY2Rjcy0+
ZGNzLnJlc3RvcmVfZmQgPSBjZGNzLT5kY3MubGlieGNfZmQgPSByZXN0b3JlX2ZkOwogICAgIGNk
Y3MtPmRjcy5zZW5kX2JhY2tfZmQgPSBzZW5kX2JhY2tfZmQ7CisKICAgICBpZiAocmVzdG9yZV9m
ZCA+IC0xKSB7CiAgICAgICAgIGNkY3MtPmRjcy5yZXN0b3JlX3BhcmFtcyA9ICpwYXJhbXM7CiAg
ICAgICAgIHJjID0gbGlieGxfX2ZkX2ZsYWdzX21vZGlmeV9zYXZlKGdjLCBjZGNzLT5kY3MucmVz
dG9yZV9mZCwKQEAgLTIwNjksNiArMjExNyw0MyBAQCBpbnQgbGlieGxfZG9tYWluX2NyZWF0ZV9u
ZXcobGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGFvX2hvdywgYW9wX2NvbnNvbGVfaG93KTsKIH0KIAoraW50
IGxpYnhsX2RvbWFpbl9mb3JrX3ZtKGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBwZG9taWQsIHVp
bnQzMl90ICpkb21pZCkKK3sKKyAgICBpbnQgcmM7CisgICAgc3RydWN0IHhlbl9kb21jdGxfY3Jl
YXRlZG9tYWluIGNyZWF0ZSA9IHswfTsKKyAgICBjcmVhdGUuZmxhZ3MgfD0gWEVOX0RPTUNUTF9D
REZfaHZtOworICAgIGNyZWF0ZS5mbGFncyB8PSBYRU5fRE9NQ1RMX0NERl9oYXA7CisgICAgY3Jl
YXRlLmZsYWdzIHw9IFhFTl9ET01DVExfQ0RGX29vc19vZmY7CisgICAgY3JlYXRlLmFyY2guZW11
bGF0aW9uX2ZsYWdzID0gKFhFTl9YODZfRU1VX0FMTCAmIH5YRU5fWDg2X0VNVV9WUENJKTsKKwor
ICAgIGNyZWF0ZS5zc2lkcmVmID0gU0VDSU5JVFNJRF9ET01VOworICAgIGNyZWF0ZS5tYXhfdmNw
dXMgPSAxOyAvLyBwbGFjZWhvbGRlciwgd2lsbCBiZSBjbG9uZWQgZnJvbSBwZG9taWQKKyAgICBj
cmVhdGUubWF4X2V2dGNobl9wb3J0ID0gMTAyMzsKKyAgICBjcmVhdGUubWF4X2dyYW50X2ZyYW1l
cyA9IExJQlhMX01BWF9HUkFOVF9GUkFNRVNfREVGQVVMVDsKKyAgICBjcmVhdGUubWF4X21hcHRy
YWNrX2ZyYW1lcyA9IExJQlhMX01BWF9NQVBUUkFDS19GUkFNRVNfREVGQVVMVDsKKworICAgIGlm
ICggKHJjID0geGNfZG9tYWluX2NyZWF0ZShjdHgtPnhjaCwgZG9taWQsICZjcmVhdGUpKSApCisg
ICAgICAgIHJldHVybiByYzsKKworICAgIGlmICggKHJjID0geGNfbWVtc2hyX2ZvcmsoY3R4LT54
Y2gsIHBkb21pZCwgKmRvbWlkKSkgKQorICAgICAgICB4Y19kb21haW5fZGVzdHJveShjdHgtPnhj
aCwgKmRvbWlkKTsKKworICAgIHJldHVybiByYzsKK30KKworaW50IGxpYnhsX2RvbWFpbl9mb3Jr
X2xhdW5jaF9kbShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcs
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90IGRvbWlkLAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWJ4bF9hc3luY3Byb2dyZXNzX2hvdyAq
YW9wX2NvbnNvbGVfaG93KQoreworICAgIHVuc2V0X2Rpc2tfY29sb19yZXN0b3JlKGRfY29uZmln
KTsKKyAgICByZXR1cm4gZG9fZG9tYWluX2NyZWF0ZShjdHgsIGRfY29uZmlnLCAmZG9taWQsIC0x
LCAtMSwgMCwgMCwgYW9wX2NvbnNvbGVfaG93KTsKK30KKworaW50IGxpYnhsX2RvbWFpbl9mb3Jr
X3Jlc2V0KGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBkb21pZCkKK3sKKyAgICByZXR1cm4geGNf
bWVtc2hyX2ZvcmtfcmVzZXQoY3R4LT54Y2gsIGRvbWlkKTsKK30KKwogaW50IGxpYnhsX2RvbWFp
bl9jcmVhdGVfcmVzdG9yZShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9j
b25maWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90ICpkb21pZCwg
aW50IHJlc3RvcmVfZmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBzZW5k
X2JhY2tfZmQsCmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9kbS5jIGIvdG9vbHMvbGli
eGwvbGlieGxfZG0uYwppbmRleCBkYWMxYjhkZGI4Li5hMTE5ZTc4OWE3IDEwMDY0NAotLS0gYS90
b29scy9saWJ4bC9saWJ4bF9kbS5jCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2RtLmMKQEAgLTI3
ODQsNyArMjc4NCw3IEBAIHN0YXRpYyB2b2lkIGRldmljZV9tb2RlbF9zcGF3bl9vdXRjb21lKGxp
YnhsX19lZ2MgKmVnYywKIAogICAgIGxpYnhsX19kb21haW5fYnVpbGRfc3RhdGUgKnN0YXRlID0g
ZG1zcy0+YnVpbGRfc3RhdGU7CiAKLSAgICBpZiAoc3RhdGUtPnNhdmVkX3N0YXRlKSB7CisgICAg
aWYgKHN0YXRlLT5zYXZlZF9zdGF0ZSAmJiAhc3RhdGUtPmZvcmtlZF92bSkgewogICAgICAgICBy
ZXQyID0gdW5saW5rKHN0YXRlLT5zYXZlZF9zdGF0ZSk7CiAgICAgICAgIGlmIChyZXQyKSB7CiAg
ICAgICAgICAgICBMT0dFRChFUlJPUiwgZG1zcy0+Z3Vlc3RfZG9taWQsICIlczogZmFpbGVkIHRv
IHJlbW92ZSBkZXZpY2UtbW9kZWwgc3RhdGUgJXMiLApkaWZmIC0tZ2l0IGEvdG9vbHMvbGlieGwv
bGlieGxfZG9tLmMgYi90b29scy9saWJ4bC9saWJ4bF9kb20uYwppbmRleCBjZGIyOTRhYjhkLi45
NWU2ZWNjOWQzIDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9kb20uYworKysgYi90b29s
cy9saWJ4bC9saWJ4bF9kb20uYwpAQCAtMzkyLDkgKzM5MiwxMiBAQCBpbnQgbGlieGxfX2J1aWxk
X3ByZShsaWJ4bF9fZ2MgKmdjLCB1aW50MzJfdCBkb21pZCwKICAgICBsaWJ4bF9kb21haW5fYnVp
bGRfaW5mbyAqY29uc3QgaW5mbyA9ICZkX2NvbmZpZy0+Yl9pbmZvOwogICAgIGxpYnhsX2N0eCAq
Y3R4ID0gbGlieGxfX2djX293bmVyKGdjKTsKICAgICBjaGFyICp4c19kb21pZCwgKmNvbl9kb21p
ZDsKLSAgICBpbnQgcmM7CisgICAgaW50IHJjID0gMDsKICAgICB1aW50NjRfdCBzaXplOwogCisg
ICAgaWYgKCBzdGF0ZS0+Zm9ya2VkX3ZtICkKKyAgICAgICAgZ290byBza2lwX2Zvcms7CisKICAg
ICBpZiAoeGNfZG9tYWluX21heF92Y3B1cyhjdHgtPnhjaCwgZG9taWQsIGluZm8tPm1heF92Y3B1
cykgIT0gMCkgewogICAgICAgICBMT0coRVJST1IsICJDb3VsZG4ndCBzZXQgbWF4IHZjcHUgY291
bnQiKTsKICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUw7CkBAIC00OTksMjkgKzUwMiw2IEBAIGlu
dCBsaWJ4bF9fYnVpbGRfcHJlKGxpYnhsX19nYyAqZ2MsIHVpbnQzMl90IGRvbWlkLAogICAgICAg
ICB9CiAgICAgfQogCi0KLSAgICByYyA9IGxpYnhsX19hcmNoX2V4dHJhX21lbW9yeShnYywgaW5m
bywgJnNpemUpOwotICAgIGlmIChyYyA8IDApIHsKLSAgICAgICAgTE9HRShFUlJPUiwgIkNvdWxk
bid0IGdldCBhcmNoIGV4dHJhIGNvbnN0YW50IG1lbW9yeSBzaXplIik7Ci0gICAgICAgIHJldHVy
biBFUlJPUl9GQUlMOwotICAgIH0KLQotICAgIGlmICh4Y19kb21haW5fc2V0bWF4bWVtKGN0eC0+
eGNoLCBkb21pZCwgaW5mby0+dGFyZ2V0X21lbWtiICsgc2l6ZSkgPCAwKSB7Ci0gICAgICAgIExP
R0UoRVJST1IsICJDb3VsZG4ndCBzZXQgbWF4IG1lbW9yeSIpOwotICAgICAgICByZXR1cm4gRVJS
T1JfRkFJTDsKLSAgICB9Ci0KLSAgICB4c19kb21pZCA9IHhzX3JlYWQoY3R4LT54c2gsIFhCVF9O
VUxMLCAiL3Rvb2wveGVuc3RvcmVkL2RvbWlkIiwgTlVMTCk7Ci0gICAgc3RhdGUtPnN0b3JlX2Rv
bWlkID0geHNfZG9taWQgPyBhdG9pKHhzX2RvbWlkKSA6IDA7Ci0gICAgZnJlZSh4c19kb21pZCk7
Ci0KLSAgICBjb25fZG9taWQgPSB4c19yZWFkKGN0eC0+eHNoLCBYQlRfTlVMTCwgIi90b29sL3hl
bmNvbnNvbGVkL2RvbWlkIiwgTlVMTCk7Ci0gICAgc3RhdGUtPmNvbnNvbGVfZG9taWQgPSBjb25f
ZG9taWQgPyBhdG9pKGNvbl9kb21pZCkgOiAwOwotICAgIGZyZWUoY29uX2RvbWlkKTsKLQotICAg
IHN0YXRlLT5zdG9yZV9wb3J0ID0geGNfZXZ0Y2huX2FsbG9jX3VuYm91bmQoY3R4LT54Y2gsIGRv
bWlkLCBzdGF0ZS0+c3RvcmVfZG9taWQpOwotICAgIHN0YXRlLT5jb25zb2xlX3BvcnQgPSB4Y19l
dnRjaG5fYWxsb2NfdW5ib3VuZChjdHgtPnhjaCwgZG9taWQsIHN0YXRlLT5jb25zb2xlX2RvbWlk
KTsKLQogICAgIGlmIChpbmZvLT50eXBlICE9IExJQlhMX0RPTUFJTl9UWVBFX1BWKQogICAgICAg
ICBodm1fc2V0X2NvbmZfcGFyYW1zKGN0eC0+eGNoLCBkb21pZCwgaW5mbyk7CiAKQEAgLTU1Niw4
ICs1MzYsMzQgQEAgaW50IGxpYnhsX19idWlsZF9wcmUobGlieGxfX2djICpnYywgdWludDMyX3Qg
ZG9taWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5mby0+YWx0cDJtKTsKICAgICB9CiAK
KyAgICByYyA9IGxpYnhsX19hcmNoX2V4dHJhX21lbW9yeShnYywgaW5mbywgJnNpemUpOworICAg
IGlmIChyYyA8IDApIHsKKyAgICAgICAgTE9HRShFUlJPUiwgIkNvdWxkbid0IGdldCBhcmNoIGV4
dHJhIGNvbnN0YW50IG1lbW9yeSBzaXplIik7CisgICAgICAgIHJldHVybiBFUlJPUl9GQUlMOwor
ICAgIH0KKworICAgIGlmICh4Y19kb21haW5fc2V0bWF4bWVtKGN0eC0+eGNoLCBkb21pZCwgaW5m
by0+dGFyZ2V0X21lbWtiICsgc2l6ZSkgPCAwKSB7CisgICAgICAgIExPR0UoRVJST1IsICJDb3Vs
ZG4ndCBzZXQgbWF4IG1lbW9yeSIpOworICAgICAgICByZXR1cm4gRVJST1JfRkFJTDsKKyAgICB9
CisKICAgICByYyA9IGxpYnhsX19hcmNoX2RvbWFpbl9jcmVhdGUoZ2MsIGRfY29uZmlnLCBkb21p
ZCk7CisgICAgaWYgKCByYyApCisgICAgICAgIGdvdG8gb3V0OwogCitza2lwX2Zvcms6CisgICAg
eHNfZG9taWQgPSB4c19yZWFkKGN0eC0+eHNoLCBYQlRfTlVMTCwgIi90b29sL3hlbnN0b3JlZC9k
b21pZCIsIE5VTEwpOworICAgIHN0YXRlLT5zdG9yZV9kb21pZCA9IHhzX2RvbWlkID8gYXRvaSh4
c19kb21pZCkgOiAwOworICAgIGZyZWUoeHNfZG9taWQpOworCisgICAgY29uX2RvbWlkID0geHNf
cmVhZChjdHgtPnhzaCwgWEJUX05VTEwsICIvdG9vbC94ZW5jb25zb2xlZC9kb21pZCIsIE5VTEwp
OworICAgIHN0YXRlLT5jb25zb2xlX2RvbWlkID0gY29uX2RvbWlkID8gYXRvaShjb25fZG9taWQp
IDogMDsKKyAgICBmcmVlKGNvbl9kb21pZCk7CisKKyAgICBzdGF0ZS0+c3RvcmVfcG9ydCA9IHhj
X2V2dGNobl9hbGxvY191bmJvdW5kKGN0eC0+eGNoLCBkb21pZCwgc3RhdGUtPnN0b3JlX2RvbWlk
KTsKKyAgICBzdGF0ZS0+Y29uc29sZV9wb3J0ID0geGNfZXZ0Y2huX2FsbG9jX3VuYm91bmQoY3R4
LT54Y2gsIGRvbWlkLCBzdGF0ZS0+Y29uc29sZV9kb21pZCk7CisKK291dDoKICAgICByZXR1cm4g
cmM7CiB9CiAKQEAgLTYxNSw2ICs2MjEsOSBAQCBpbnQgbGlieGxfX2J1aWxkX3Bvc3QobGlieGxf
X2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgY2hhciAqKmVudHM7CiAgICAgaW50IGksIHJj
OwogCisgICAgaWYgKCBzdGF0ZS0+Zm9ya2VkX3ZtICkKKyAgICAgICAgZ290byBza2lwX2Zvcms7
CisKICAgICBpZiAoaW5mby0+bnVtX3ZudW1hX25vZGVzICYmICFpbmZvLT5udW1fdmNwdV9zb2Z0
X2FmZmluaXR5KSB7CiAgICAgICAgIHJjID0gc2V0X3ZudW1hX2FmZmluaXR5KGdjLCBkb21pZCwg
aW5mbyk7CiAgICAgICAgIGlmIChyYykKQEAgLTYzOSw2ICs2NDgsNyBAQCBpbnQgbGlieGxfX2J1
aWxkX3Bvc3QobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgICAgIH0KICAgICB9
CiAKK3NraXBfZm9yazoKICAgICBlbnRzID0gbGlieGxfX2NhbGxvYyhnYywgMTIgKyAoaW5mby0+
bWF4X3ZjcHVzICogMikgKyAyLCBzaXplb2YoY2hhciAqKSk7CiAgICAgZW50c1swXSA9ICJtZW1v
cnkvc3RhdGljLW1heCI7CiAgICAgZW50c1sxXSA9IEdDU1BSSU5URigiJSJQUklkNjQsIGluZm8t
Pm1heF9tZW1rYik7CkBAIC05MDEsMTQgKzkxMSwxNiBAQCBzdGF0aWMgaW50IGh2bV9idWlsZF9z
ZXRfcGFyYW1zKHhjX2ludGVyZmFjZSAqaGFuZGxlLCB1aW50MzJfdCBkb21pZCwKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfZG9tYWluX2J1aWxkX2luZm8gKmluZm8sCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBzdG9yZV9ldnRjaG4sIHVuc2lnbmVk
IGxvbmcgKnN0b3JlX21mbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50IGNv
bnNvbGVfZXZ0Y2huLCB1bnNpZ25lZCBsb25nICpjb25zb2xlX21mbiwKLSAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgZG9taWRfdCBzdG9yZV9kb21pZCwgZG9taWRfdCBjb25zb2xlX2Rv
bWlkKQorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21pZF90IHN0b3JlX2RvbWlk
LCBkb21pZF90IGNvbnNvbGVfZG9taWQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IGJvb2wgZm9ya2VkX3ZtKQogewogICAgIHN0cnVjdCBodm1faW5mb190YWJsZSAqdmFfaHZtOwog
ICAgIHVpbnQ4X3QgKnZhX21hcCwgc3VtOwogICAgIHVpbnQ2NF90IHN0cl9tZm4sIGNvbnNfbWZu
OwogICAgIGludCBpOwogCi0gICAgaWYgKGluZm8tPnR5cGUgPT0gTElCWExfRE9NQUlOX1RZUEVf
SFZNKSB7CisgICAgaWYgKCBpbmZvLT50eXBlID09IExJQlhMX0RPTUFJTl9UWVBFX0hWTSAmJiAh
Zm9ya2VkX3ZtICkKKyAgICB7CiAgICAgICAgIHZhX21hcCA9IHhjX21hcF9mb3JlaWduX3Jhbmdl
KGhhbmRsZSwgZG9taWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFhD
X1BBR0VfU0laRSwgUFJPVF9SRUFEIHwgUFJPVF9XUklURSwKICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgSFZNX0lORk9fUEZOKTsKQEAgLTEyMjQsNiArMTIzNiwyMyBAQCBp
bnQgbGlieGxfX2J1aWxkX2h2bShsaWJ4bF9fZ2MgKmdjLCB1aW50MzJfdCBkb21pZCwKICAgICBz
dHJ1Y3QgeGNfZG9tX2ltYWdlICpkb20gPSBOVUxMOwogICAgIGJvb2wgZGV2aWNlX21vZGVsID0g
aW5mby0+dHlwZSA9PSBMSUJYTF9ET01BSU5fVFlQRV9IVk0gPyB0cnVlIDogZmFsc2U7CiAKKyAg
ICBpZiAoIHN0YXRlLT5mb3JrZWRfdm0gKQorICAgIHsKKyAgICAgICAgcmMgPSBodm1fYnVpbGRf
c2V0X3BhcmFtcyhjdHgtPnhjaCwgZG9taWQsIGluZm8sIHN0YXRlLT5zdG9yZV9wb3J0LAorICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZzdGF0ZS0+c3RvcmVfbWZuLCBzdGF0ZS0+
Y29uc29sZV9wb3J0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZzdGF0ZS0+
Y29uc29sZV9tZm4sIHN0YXRlLT5zdG9yZV9kb21pZCwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBzdGF0ZS0+Y29uc29sZV9kb21pZCwgc3RhdGUtPmZvcmtlZF92bSk7CisKKyAg
ICAgICAgaWYgKCByYyApCisgICAgICAgICAgICByZXR1cm4gcmM7CisKKyAgICAgICAgcmV0dXJu
IHhjX2RvbV9nbnR0YWJfc2VlZChjdHgtPnhjaCwgZG9taWQsIHRydWUsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgc3RhdGUtPmNvbnNvbGVfbWZuLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIHN0YXRlLT5zdG9yZV9tZm4sCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgc3RhdGUtPmNvbnNvbGVfZG9taWQsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgc3RhdGUtPnN0b3JlX2RvbWlkKTsKKyAgICB9CisKICAgICB4Y19kb21f
bG9naW5pdChjdHgtPnhjaCk7CiAKICAgICAvKgpAQCAtMTM0OCw3ICsxMzc3LDcgQEAgaW50IGxp
YnhsX19idWlsZF9odm0obGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgcmMgPSBo
dm1fYnVpbGRfc2V0X3BhcmFtcyhjdHgtPnhjaCwgZG9taWQsIGluZm8sIHN0YXRlLT5zdG9yZV9w
b3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZzdGF0ZS0+c3RvcmVfbWZuLCBz
dGF0ZS0+Y29uc29sZV9wb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZzdGF0
ZS0+Y29uc29sZV9tZm4sIHN0YXRlLT5zdG9yZV9kb21pZCwKLSAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBzdGF0ZS0+Y29uc29sZV9kb21pZCk7CisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgc3RhdGUtPmNvbnNvbGVfZG9taWQsIGZhbHNlKTsKICAgICBpZiAocmMgIT0gMCkg
ewogICAgICAgICBMT0coRVJST1IsICJodm0gYnVpbGQgc2V0IHBhcmFtcyBmYWlsZWQiKTsKICAg
ICAgICAgZ290byBvdXQ7CmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5o
IGIvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaAppbmRleCBiNWFkYmZlNGI3Li5lYTZmZTEz
M2E1IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5oCisrKyBiL3Rvb2xz
L2xpYnhsL2xpYnhsX2ludGVybmFsLmgKQEAgLTEzNjAsNiArMTM2MCw3IEBAIHR5cGVkZWYgc3Ry
dWN0IHsKIAogICAgIGNoYXIgKnNhdmVkX3N0YXRlOwogICAgIGludCBkbV9tb25pdG9yX2ZkOwor
ICAgIGJvb2wgZm9ya2VkX3ZtOwogCiAgICAgbGlieGxfX2ZpbGVfcmVmZXJlbmNlIHB2X2tlcm5l
bDsKICAgICBsaWJ4bF9fZmlsZV9yZWZlcmVuY2UgcHZfcmFtZGlzazsKZGlmZiAtLWdpdCBhL3Rv
b2xzL2xpYnhsL2xpYnhsX3R5cGVzLmlkbCBiL3Rvb2xzL2xpYnhsL2xpYnhsX3R5cGVzLmlkbApp
bmRleCA3OTIxOTUwZjZhLi43YzRjNDA1N2E5IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4
bF90eXBlcy5pZGwKKysrIGIvdG9vbHMvbGlieGwvbGlieGxfdHlwZXMuaWRsCkBAIC05NTYsNiAr
OTU2LDcgQEAgbGlieGxfZG9tYWluX2NvbmZpZyA9IFN0cnVjdCgiZG9tYWluX2NvbmZpZyIsIFsK
ICAgICAoIm9uX3dhdGNoZG9nIiwgbGlieGxfYWN0aW9uX29uX3NodXRkb3duKSwKICAgICAoIm9u
X2NyYXNoIiwgbGlieGxfYWN0aW9uX29uX3NodXRkb3duKSwKICAgICAoIm9uX3NvZnRfcmVzZXQi
LCBsaWJ4bF9hY3Rpb25fb25fc2h1dGRvd24pLAorICAgICgiZG1fcmVzdG9yZV9maWxlIiwgc3Ry
aW5nLCB7J2NvbnN0JzogVHJ1ZX0pLAogICAgIF0sIGRpcj1ESVJfSU4pCiAKIGxpYnhsX2Rpc2tp
bmZvID0gU3RydWN0KCJkaXNraW5mbyIsIFsKZGlmZiAtLWdpdCBhL3Rvb2xzL3hsL3hsLmggYi90
b29scy94bC94bC5oCmluZGV4IDYwYmRhZDhmZmIuLjliZGFkNjUyNmUgMTAwNjQ0Ci0tLSBhL3Rv
b2xzL3hsL3hsLmgKKysrIGIvdG9vbHMveGwveGwuaApAQCAtMzEsNiArMzEsNyBAQCBzdHJ1Y3Qg
Y21kX3NwZWMgewogfTsKIAogc3RydWN0IGRvbWFpbl9jcmVhdGUgeworICAgIHVpbnQzMl90IGRk
b21pZDsgLyogZm9yayBsYXVuY2ggZG0gZm9yIHRoaXMgZG9taWQgKi8KICAgICBpbnQgZGVidWc7
CiAgICAgaW50IGRhZW1vbml6ZTsKICAgICBpbnQgbW9uaXRvcjsgLyogaGFuZGxlIGd1ZXN0IHJl
Ym9vdHMgZXRjICovCkBAIC00NSw2ICs0Niw3IEBAIHN0cnVjdCBkb21haW5fY3JlYXRlIHsKICAg
ICBjb25zdCBjaGFyICpjb25maWdfZmlsZTsKICAgICBjaGFyICpleHRyYV9jb25maWc7IC8qIGV4
dHJhIGNvbmZpZyBzdHJpbmcgKi8KICAgICBjb25zdCBjaGFyICpyZXN0b3JlX2ZpbGU7CisgICAg
Y29uc3QgY2hhciAqZG1fcmVzdG9yZV9maWxlOwogICAgIGNoYXIgKmNvbG9fcHJveHlfc2NyaXB0
OwogICAgIGJvb2wgdXNlcnNwYWNlX2NvbG9fcHJveHk7CiAgICAgaW50IG1pZ3JhdGVfZmQ7IC8q
IC0xIG1lYW5zIG5vbmUgKi8KQEAgLTEyNyw2ICsxMjksOSBAQCBpbnQgbWFpbl9wY2lhc3NpZ25h
YmxlX3JlbW92ZShpbnQgYXJnYywgY2hhciAqKmFyZ3YpOwogaW50IG1haW5fcGNpYXNzaWduYWJs
ZV9saXN0KGludCBhcmdjLCBjaGFyICoqYXJndik7CiAjaWZuZGVmIExJQlhMX0hBVkVfTk9fU1VT
UEVORF9SRVNVTUUKIGludCBtYWluX3Jlc3RvcmUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KTsKK2lu
dCBtYWluX2Zvcmtfdm0oaW50IGFyZ2MsIGNoYXIgKiphcmd2KTsKK2ludCBtYWluX2ZvcmtfbGF1
bmNoX2RtKGludCBhcmdjLCBjaGFyICoqYXJndik7CitpbnQgbWFpbl9mb3JrX3Jlc2V0KGludCBh
cmdjLCBjaGFyICoqYXJndik7CiBpbnQgbWFpbl9taWdyYXRlX3JlY2VpdmUoaW50IGFyZ2MsIGNo
YXIgKiphcmd2KTsKIGludCBtYWluX3NhdmUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KTsKIGludCBt
YWluX21pZ3JhdGUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KTsKZGlmZiAtLWdpdCBhL3Rvb2xzL3hs
L3hsX2NtZHRhYmxlLmMgYi90b29scy94bC94bF9jbWR0YWJsZS5jCmluZGV4IDViYWE2MDIzYWEu
Ljk0MjE3ZTRlZDQgMTAwNjQ0Ci0tLSBhL3Rvb2xzL3hsL3hsX2NtZHRhYmxlLmMKKysrIGIvdG9v
bHMveGwveGxfY21kdGFibGUuYwpAQCAtMTgwLDYgKzE4MCwyOCBAQCBzdHJ1Y3QgY21kX3NwZWMg
Y21kX3RhYmxlW10gPSB7CiAgICAgICAiLVYsIC0tdm5jdmlld2VyICAgICAgICAgIENvbm5lY3Qg
dG8gdGhlIFZOQyBkaXNwbGF5IGFmdGVyIHRoZSBkb21haW4gaXMgY3JlYXRlZC5cbiIKICAgICAg
ICItQSwgLS12bmN2aWV3ZXItYXV0b3Bhc3MgUGFzcyBWTkMgcGFzc3dvcmQgdG8gdmlld2VyIHZp
YSBzdGRpbi4iCiAgICAgfSwKKyAgICB7ICJmb3JrLXZtIiwKKyAgICAgICZtYWluX2Zvcmtfdm0s
IDAsIDEsCisgICAgICAiRm9yayBhIGRvbWFpbiBmcm9tIHRoZSBydW5uaW5nIHBhcmVudCBkb21p
ZCIsCisgICAgICAiW29wdGlvbnNdIDxQYXJlbnREb21pZD4iLAorICAgICAgIi1oICAgICAgICAg
ICAgICAgICAgICAgICBQcmludCB0aGlzIGhlbHAuXG4iCisgICAgICAiLWQgICAgICAgICAgICAg
ICAgICAgICAgIEVuYWJsZSBkZWJ1ZyBtZXNzYWdlcy5cbiIKKyAgICB9LAorICAgIHsgImZvcmst
bGF1bmNoLWRtIiwKKyAgICAgICZtYWluX2ZvcmtfbGF1bmNoX2RtLCAwLCAxLAorICAgICAgIkxh
dW5jaCB0aGUgZGV2aWNlIG1vZGVsIGZvciBhIGZvcmtlZCBWTSIsCisgICAgICAiW29wdGlvbnNd
IDxDb25maWdGaWxlPiA8RG1SZXN0b3JlRmlsZT4gPERvbWlkPiIsCisgICAgICAiLWggICAgICAg
ICAgICAgICAgICAgICAgIFByaW50IHRoaXMgaGVscC5cbiIKKyAgICAgICItcCAgICAgICAgICAg
ICAgICAgICAgICAgRG8gbm90IHVucGF1c2UgZG9tYWluIGFmdGVyIHJlc3RvcmluZyBpdC5cbiIK
KyAgICAgICItZCAgICAgICAgICAgICAgICAgICAgICAgRW5hYmxlIGRlYnVnIG1lc3NhZ2VzLlxu
IgorICAgIH0sCisgICAgeyAiZm9yay1yZXNldCIsCisgICAgICAmbWFpbl9mb3JrX3Jlc2V0LCAw
LCAxLAorICAgICAgIkxhdW5jaCB0aGUgZGV2aWNlIG1vZGVsIGZvciBhIGZvcmtlZCBWTSIsCisg
ICAgICAiW29wdGlvbnNdIDxEb21pZD4iLAorICAgICAgIi1oICAgICAgICAgICAgICAgICAgICAg
ICBQcmludCB0aGlzIGhlbHAuXG4iCisgICAgICAiLWQgICAgICAgICAgICAgICAgICAgICAgIEVu
YWJsZSBkZWJ1ZyBtZXNzYWdlcy5cbiIKKyAgICB9LAogICAgIHsgIm1pZ3JhdGUtcmVjZWl2ZSIs
CiAgICAgICAmbWFpbl9taWdyYXRlX3JlY2VpdmUsIDAsIDEsCiAgICAgICAiUmVzdG9yZSBhIGRv
bWFpbiBmcm9tIGEgc2F2ZWQgc3RhdGUiLApkaWZmIC0tZ2l0IGEvdG9vbHMveGwveGxfc2F2ZXJl
c3RvcmUuYyBiL3Rvb2xzL3hsL3hsX3NhdmVyZXN0b3JlLmMKaW5kZXggOWJlMDMzZmU2NS4uYzFk
ZDc0ZjMzZSAxMDA2NDQKLS0tIGEvdG9vbHMveGwveGxfc2F2ZXJlc3RvcmUuYworKysgYi90b29s
cy94bC94bF9zYXZlcmVzdG9yZS5jCkBAIC0yMjksNiArMjI5LDEwMiBAQCBpbnQgbWFpbl9yZXN0
b3JlKGludCBhcmdjLCBjaGFyICoqYXJndikKICAgICByZXR1cm4gRVhJVF9TVUNDRVNTOwogfQog
CitpbnQgbWFpbl9mb3JrX3ZtKGludCBhcmdjLCBjaGFyICoqYXJndikKK3sKKyAgICBpbnQgZGVi
dWcgPSAwOworICAgIHVpbnQzMl90IHBkb21pZCA9IDAsIGRvbWlkID0gSU5WQUxJRF9ET01JRDsK
KyAgICBpbnQgb3B0OworCisgICAgU1dJVENIX0ZPUkVBQ0hfT1BUKG9wdCwgImQiLCBOVUxMLCAi
Zm9yay12bSIsIDEpIHsKKyAgICBjYXNlICdkJzoKKyAgICAgICAgZGVidWcgPSAxOworICAgICAg
ICBicmVhazsKKyAgICB9CisKKyAgICBpZiAoYXJnYy1vcHRpbmQgPT0gMSkgeworICAgICAgICBw
ZG9taWQgPSBhdG9pKGFyZ3Zbb3B0aW5kXSk7CisgICAgfSBlbHNlIHsKKyAgICAgICAgaGVscCgi
Zm9yay12bSIpOworICAgICAgICByZXR1cm4gRVhJVF9GQUlMVVJFOworICAgIH0KKworICAgIGlm
IChsaWJ4bF9kb21haW5fZm9ya192bShjdHgsIHBkb21pZCwgJmRvbWlkKSB8fCBkb21pZCA9PSBJ
TlZBTElEX0RPTUlEKQorICAgICAgICByZXR1cm4gRVhJVF9GQUlMVVJFOworCisgICAgZnByaW50
ZihzdGRlcnIsICJWTSBmb3JrIGNyZWF0ZWQgd2l0aCBkb21pZDogJXVcbiIsIGRvbWlkKTsKKyAg
ICByZXR1cm4gRVhJVF9TVUNDRVNTOworfQorCitpbnQgbWFpbl9mb3JrX2xhdW5jaF9kbShpbnQg
YXJnYywgY2hhciAqKmFyZ3YpCit7CisgICAgY29uc3QgY2hhciAqY29uZmlnX2ZpbGUgPSBOVUxM
OworICAgIGNvbnN0IGNoYXIgKmRtX3Jlc3RvcmVfZmlsZSA9IE5VTEw7CisgICAgc3RydWN0IGRv
bWFpbl9jcmVhdGUgZG9tX2luZm87CisgICAgaW50IHBhdXNlZCA9IDAsIGRlYnVnID0gMDsKKyAg
ICB1aW50MzJfdCBkZG9taWQgPSAwOworICAgIGludCBvcHQsIHJjOworCisgICAgU1dJVENIX0ZP
UkVBQ0hfT1BUKG9wdCwgInBkIiwgTlVMTCwgImZvcmstbGF1bmNoLWRtIiwgMSkgeworICAgIGNh
c2UgJ3AnOgorICAgICAgICBwYXVzZWQgPSAxOworICAgICAgICBicmVhazsKKyAgICBjYXNlICdk
JzoKKyAgICAgICAgZGVidWcgPSAxOworICAgICAgICBicmVhazsKKyAgICB9CisKKyAgICBpZiAo
YXJnYy1vcHRpbmQgPT0gMykgeworICAgICAgICBjb25maWdfZmlsZSA9IGFyZ3Zbb3B0aW5kXTsK
KyAgICAgICAgZG1fcmVzdG9yZV9maWxlID0gYXJndltvcHRpbmQgKyAxXTsKKyAgICAgICAgZGRv
bWlkID0gYXRvaShhcmd2W29wdGluZCArIDJdKTsKKyAgICB9IGVsc2UgeworICAgICAgICBoZWxw
KCJmb3JrLWxhdW5jaC1kbSIpOworICAgICAgICByZXR1cm4gRVhJVF9GQUlMVVJFOworICAgIH0K
KworICAgIG1lbXNldCgmZG9tX2luZm8sIDAsIHNpemVvZihkb21faW5mbykpOworICAgIGRvbV9p
bmZvLmRkb21pZCA9IGRkb21pZDsKKyAgICBkb21faW5mby5kbV9yZXN0b3JlX2ZpbGUgPSBkbV9y
ZXN0b3JlX2ZpbGU7CisgICAgZG9tX2luZm8uZGVidWcgPSBkZWJ1ZzsKKyAgICBkb21faW5mby5w
YXVzZWQgPSBwYXVzZWQ7CisgICAgZG9tX2luZm8uY29uZmlnX2ZpbGUgPSBjb25maWdfZmlsZTsK
KyAgICBkb21faW5mby5taWdyYXRlX2ZkID0gLTE7CisgICAgZG9tX2luZm8uc2VuZF9iYWNrX2Zk
ID0gLTE7CisKKyAgICByYyA9IGNyZWF0ZV9kb21haW4oJmRvbV9pbmZvKTsKKyAgICBpZiAocmMg
PCAwKQorICAgICAgICByZXR1cm4gRVhJVF9GQUlMVVJFOworCisgICAgcmV0dXJuIEVYSVRfU1VD
Q0VTUzsKK30KKworaW50IG1haW5fZm9ya19yZXNldChpbnQgYXJnYywgY2hhciAqKmFyZ3YpCit7
CisgICAgaW50IGRlYnVnID0gMDsKKyAgICB1aW50MzJfdCBkb21pZCA9IDA7CisgICAgaW50IG9w
dCwgcmM7CisKKyAgICBTV0lUQ0hfRk9SRUFDSF9PUFQob3B0LCAiZCIsIE5VTEwsICJmb3JrLXJl
c2V0IiwgMSkKKyAgICB7CisgICAgY2FzZSAnZCc6CisgICAgICAgIGRlYnVnID0gMTsKKyAgICAg
ICAgYnJlYWs7CisgICAgfQorCisgICAgaWYgKGFyZ2Mtb3B0aW5kID09IDEpIHsKKyAgICAgICAg
ZG9taWQgPSBhdG9pKGFyZ3Zbb3B0aW5kXSk7CisgICAgfSBlbHNlIHsKKyAgICAgICAgaGVscCgi
Zm9yay1yZXNldCIpOworICAgICAgICByZXR1cm4gRVhJVF9GQUlMVVJFOworICAgIH0KKworICAg
IHJjID0gbGlieGxfZG9tYWluX2ZvcmtfcmVzZXQoY3R4LCBkb21pZCk7CisgICAgaWYgKHJjIDwg
MCkKKyAgICAgICAgcmV0dXJuIEVYSVRfRkFJTFVSRTsKKworICAgIHJldHVybiBFWElUX1NVQ0NF
U1M7Cit9CisKIGludCBtYWluX3NhdmUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KQogewogICAgIHVp
bnQzMl90IGRvbWlkOwpkaWZmIC0tZ2l0IGEvdG9vbHMveGwveGxfdm1jb250cm9sLmMgYi90b29s
cy94bC94bF92bWNvbnRyb2wuYwppbmRleCBlNTIwYjFkYTc5Li5kOWNiMTljNTk5IDEwMDY0NAot
LS0gYS90b29scy94bC94bF92bWNvbnRyb2wuYworKysgYi90b29scy94bC94bF92bWNvbnRyb2wu
YwpAQCAtNjQ1LDYgKzY0NSw3IEBAIGludCBjcmVhdGVfZG9tYWluKHN0cnVjdCBkb21haW5fY3Jl
YXRlICpkb21faW5mbykKIAogICAgIGxpYnhsX2RvbWFpbl9jb25maWcgZF9jb25maWc7CiAKKyAg
ICB1aW50MzJfdCBkZG9taWQgPSBkb21faW5mby0+ZGRvbWlkOyAvLyBsYXVuY2ggZG0gZm9yIHRo
aXMgZG9tYWluIGlmZiBzZXQKICAgICBpbnQgZGVidWcgPSBkb21faW5mby0+ZGVidWc7CiAgICAg
aW50IGRhZW1vbml6ZSA9IGRvbV9pbmZvLT5kYWVtb25pemU7CiAgICAgaW50IG1vbml0b3IgPSBk
b21faW5mby0+bW9uaXRvcjsKQEAgLTY1NSw2ICs2NTYsNyBAQCBpbnQgY3JlYXRlX2RvbWFpbihz
dHJ1Y3QgZG9tYWluX2NyZWF0ZSAqZG9tX2luZm8pCiAgICAgY29uc3QgY2hhciAqcmVzdG9yZV9m
aWxlID0gZG9tX2luZm8tPnJlc3RvcmVfZmlsZTsKICAgICBjb25zdCBjaGFyICpjb25maWdfc291
cmNlID0gTlVMTDsKICAgICBjb25zdCBjaGFyICpyZXN0b3JlX3NvdXJjZSA9IE5VTEw7CisgICAg
Y29uc3QgY2hhciAqZG1fcmVzdG9yZV9maWxlID0gZG9tX2luZm8tPmRtX3Jlc3RvcmVfZmlsZTsK
ICAgICBpbnQgbWlncmF0ZV9mZCA9IGRvbV9pbmZvLT5taWdyYXRlX2ZkOwogICAgIGJvb2wgY29u
ZmlnX2luX2pzb247CiAKQEAgLTkyMyw2ICs5MjUsMTIgQEAgc3RhcnQ6CiAgICAgICAgICAqIHJl
c3RvcmUvbWlncmF0ZS1yZWNlaXZlIGl0IGFnYWluLgogICAgICAgICAgKi8KICAgICAgICAgcmVz
dG9yaW5nID0gMDsKKyAgICB9IGVsc2UgaWYgKCBkZG9taWQgKSB7CisgICAgICAgIGRfY29uZmln
LmRtX3Jlc3RvcmVfZmlsZSA9IGRtX3Jlc3RvcmVfZmlsZTsKKyAgICAgICAgcmV0ID0gbGlieGxf
ZG9tYWluX2ZvcmtfbGF1bmNoX2RtKGN0eCwgJmRfY29uZmlnLCBkZG9taWQsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvY29ubmVjdF9jb25zb2xlX2hvdyk7
CisgICAgICAgIGRvbWlkID0gZGRvbWlkOworICAgICAgICBkZG9taWQgPSBJTlZBTElEX0RPTUlE
OwogICAgIH0gZWxzZSBpZiAoZG9taWRfc29mdF9yZXNldCAhPSBJTlZBTElEX0RPTUlEKSB7CiAg
ICAgICAgIC8qIERvIHNvZnQgcmVzZXQuICovCiAgICAgICAgIHJldCA9IGxpYnhsX2RvbWFpbl9z
b2Z0X3Jlc2V0KGN0eCwgJmRfY29uZmlnLCBkb21pZF9zb2Z0X3Jlc2V0LAotLSAKMi4yMC4xCgoK
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVs
IG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0
cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

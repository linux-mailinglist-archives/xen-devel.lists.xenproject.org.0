Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 99D22144C5
	for <lists+xen-devel@lfdr.de>; Mon,  6 May 2019 09:00:01 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hNXYp-0002Lp-9L; Mon, 06 May 2019 06:57:15 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=XZcu=TG=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hNXYh-00028F-Tr
 for xen-devel@lists.xenproject.org; Mon, 06 May 2019 06:57:07 +0000
X-Inumbo-ID: 22ff9e54-6fcc-11e9-8291-1b98ce9c8cff
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 22ff9e54-6fcc-11e9-8291-1b98ce9c8cff;
 Mon, 06 May 2019 06:56:56 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id D5BBCAF1E;
 Mon,  6 May 2019 06:56:53 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon,  6 May 2019 08:56:17 +0200
Message-Id: <20190506065644.7415-19-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190506065644.7415-1-jgross@suse.com>
References: <20190506065644.7415-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH RFC V2 18/45] xen/sched: make null scheduler
 vcpu agnostic.
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U3dpdGNoIG51bGwgc2NoZWR1bGVyIGNvbXBsZXRlbHkgZnJvbSB2Y3B1IHRvIHNjaGVkX2l0ZW0g
dXNhZ2UuCgpTaWduZWQtb2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+Ci0t
LQogeGVuL2NvbW1vbi9zY2hlZF9udWxsLmMgfCAzMDQgKysrKysrKysrKysrKysrKysrKysrKysr
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTQ5IGluc2VydGlvbnMo
KyksIDE1NSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL3NjaGVkX251bGwu
YyBiL3hlbi9jb21tb24vc2NoZWRfbnVsbC5jCmluZGV4IDYyYzUxZTJjODMuLmNlYjAyNmM4YWYg
MTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWRfbnVsbC5jCisrKyBiL3hlbi9jb21tb24vc2No
ZWRfbnVsbC5jCkBAIC0xOCwxMCArMTgsMTAgQEAKIAogLyoKICAqIFRoZSAnbnVsbCcgc2NoZWR1
bGVyIGFsd2F5cyBjaG9vc2UgdG8gcnVuLCBvbiBlYWNoIHBDUFUsIGVpdGhlciBub3RoaW5nCi0g
KiAoaS5lLiwgdGhlIHBDUFUgc3RheXMgaWRsZSkgb3IgYWx3YXlzIHRoZSBzYW1lIHZDUFUuCisg
KiAoaS5lLiwgdGhlIHBDUFUgc3RheXMgaWRsZSkgb3IgYWx3YXlzIHRoZSBzYW1lIEl0ZW0uCiAg
KgogICogSXQgaXMgYWltZWQgYXQgc3VwcG9ydGluZyBzdGF0aWMgc2NlbmFyaW9zLCB3aGVyZSB0
aGVyZSBhbHdheXMgYXJlCi0gKiBsZXNzIHZDUFVzIHRoYW4gcENQVXMgKGFuZCB0aGUgdkNQVXMg
ZG9uJ3QgbmVlZCB0byBtb3ZlIGFtb25nIHBDUFVzCisgKiBsZXNzIEl0ZW1zIHRoYW4gcENQVXMg
KGFuZCB0aGUgSXRlbXMgZG9uJ3QgbmVlZCB0byBtb3ZlIGFtb25nIHBDUFVzCiAgKiBmb3IgYW55
IHJlYXNvbikgd2l0aCB0aGUgbGVhc3QgcG9zc2libGUgb3ZlcmhlYWQuCiAgKgogICogVHlwaWNh
bCB1c2VjYXNlIGFyZSBlbWJlZGRlZCBhcHBsaWNhdGlvbnMsIGJ1dCBhbHNvIEhQQywgZXNwZWNp
YWxseQpAQCAtMzgsOCArMzgsOCBAQAogICogbnVsbCB0cmFjaW5nIGV2ZW50cy4gQ2hlY2sgaW5j
bHVkZS9wdWJsaWMvdHJhY2UuaCBmb3IgbW9yZSBkZXRhaWxzLgogICovCiAjZGVmaW5lIFRSQ19T
TlVMTF9QSUNLRURfQ1BVICAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDEpCi0jZGVmaW5l
IFRSQ19TTlVMTF9WQ1BVX0FTU0lHTiAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDIpCi0j
ZGVmaW5lIFRSQ19TTlVMTF9WQ1BVX0RFQVNTSUdOIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEws
IDMpCisjZGVmaW5lIFRSQ19TTlVMTF9JVEVNX0FTU0lHTiAgIFRSQ19TQ0hFRF9DTEFTU19FVlQo
U05VTEwsIDIpCisjZGVmaW5lIFRSQ19TTlVMTF9JVEVNX0RFQVNTSUdOIFRSQ19TQ0hFRF9DTEFT
U19FVlQoU05VTEwsIDMpCiAjZGVmaW5lIFRSQ19TTlVMTF9NSUdSQVRFICAgICAgIFRSQ19TQ0hF
RF9DTEFTU19FVlQoU05VTEwsIDQpCiAjZGVmaW5lIFRSQ19TTlVMTF9TQ0hFRFVMRSAgICAgIFRS
Q19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDUpCiAjZGVmaW5lIFRSQ19TTlVMTF9UQVNLTEVUICAg
ICAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDYpCkBAIC00OCwxMyArNDgsMTMgQEAKICAq
IExvY2tpbmc6CiAgKiAtIFNjaGVkdWxlci1sb2NrIChhLmsuYS4gcnVucXVldWUgbG9jayk6CiAg
KiAgKyBpcyBwZXItcENQVTsKLSAqICArIHNlcmlhbGl6ZXMgYXNzaWdubWVudCBhbmQgZGVhc3Np
Z25tZW50IG9mIHZDUFVzIHRvIGEgcENQVS4KKyAqICArIHNlcmlhbGl6ZXMgYXNzaWdubWVudCBh
bmQgZGVhc3NpZ25tZW50IG9mIEl0ZW1zIHRvIGEgcENQVS4KICAqIC0gUHJpdmF0ZSBkYXRhIGxv
Y2sgKGEuay5hLiBwcml2YXRlIHNjaGVkdWxlciBsb2NrKToKICAqICArIGlzIHNjaGVkdWxlci13
aWRlOwogICogICsgc2VyaWFsaXplcyBhY2Nlc3NlcyB0byB0aGUgbGlzdCBvZiBkb21haW5zIGlu
IHRoaXMgc2NoZWR1bGVyLgogICogLSBXYWl0cXVldWUgbG9jazoKICAqICArIGlzIHNjaGVkdWxl
ci13aWRlOwotICogICsgc2VyaWFsaXplIGFjY2Vzc2VzIHRvIHRoZSBsaXN0IG9mIHZDUFVzIHdh
aXRpbmcgdG8gYmUgYXNzaWduZWQKKyAqICArIHNlcmlhbGl6ZSBhY2Nlc3NlcyB0byB0aGUgbGlz
dCBvZiBJdGVtcyB3YWl0aW5nIHRvIGJlIGFzc2lnbmVkCiAgKiAgICB0byBwQ1BVcy4KICAqCiAg
KiBPcmRlcmluZyBpczogcHJpdmF0ZSBsb2NrLCBydW5xdWV1ZSBsb2NrLCB3YWl0cXVldWUgbG9j
ay4gT3IsIE9UT0gsCkBAIC03OCwyNSArNzgsMjUgQEAKIHN0cnVjdCBudWxsX3ByaXZhdGUgewog
ICAgIHNwaW5sb2NrX3QgbG9jazsgICAgICAgIC8qIHNjaGVkdWxlciBsb2NrOyBuZXN0cyBpbnNp
ZGUgY3B1cG9vbF9sb2NrICovCiAgICAgc3RydWN0IGxpc3RfaGVhZCBuZG9tOyAgLyogRG9tYWlu
cyBvZiB0aGlzIHNjaGVkdWxlciAgICAgICAgICAgICAgICAgKi8KLSAgICBzdHJ1Y3QgbGlzdF9o
ZWFkIHdhaXRxOyAvKiB2Q1BVcyBub3QgYXNzaWduZWQgdG8gYW55IHBDUFUgICAgICAgICAgICAq
LworICAgIHN0cnVjdCBsaXN0X2hlYWQgd2FpdHE7IC8qIEl0ZW1zIG5vdCBhc3NpZ25lZCB0byBh
bnkgcENQVSAgICAgICAgICAgICovCiAgICAgc3BpbmxvY2tfdCB3YWl0cV9sb2NrOyAgLyogc2Vy
aWFsaXplcyB3YWl0cTsgbmVzdHMgaW5zaWRlIHJ1bnEgbG9ja3MgKi8KLSAgICBjcHVtYXNrX3Qg
Y3B1c19mcmVlOyAgICAvKiBDUFVzIHdpdGhvdXQgYSB2Q1BVIGFzc29jaWF0ZWQgdG8gdGhlbSAg
ICAqLworICAgIGNwdW1hc2tfdCBjcHVzX2ZyZWU7ICAgIC8qIENQVXMgd2l0aG91dCBhIEl0ZW0g
YXNzb2NpYXRlZCB0byB0aGVtICAgICovCiB9OwogCiAvKgogICogUGh5c2ljYWwgQ1BVCiAgKi8K
IHN0cnVjdCBudWxsX3BjcHUgewotICAgIHN0cnVjdCB2Y3B1ICp2Y3B1OworICAgIHN0cnVjdCBz
Y2hlZF9pdGVtICppdGVtOwogfTsKIERFRklORV9QRVJfQ1BVKHN0cnVjdCBudWxsX3BjcHUsIG5w
Yyk7CiAKIC8qCi0gKiBWaXJ0dWFsIENQVQorICogU2NoZWR1bGUgSXRlbQogICovCiBzdHJ1Y3Qg
bnVsbF9pdGVtIHsKICAgICBzdHJ1Y3QgbGlzdF9oZWFkIHdhaXRxX2VsZW07Ci0gICAgc3RydWN0
IHZjcHUgKnZjcHU7CisgICAgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW07CiB9OwogCiAvKgpAQCAt
MTIwLDEzICsxMjAsMTMgQEAgc3RhdGljIGlubGluZSBzdHJ1Y3QgbnVsbF9pdGVtICpudWxsX2l0
ZW0oY29uc3Qgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0pCiAgICAgcmV0dXJuIGl0ZW0tPnByaXY7
CiB9CiAKLXN0YXRpYyBpbmxpbmUgYm9vbCB2Y3B1X2NoZWNrX2FmZmluaXR5KHN0cnVjdCB2Y3B1
ICp2LCB1bnNpZ25lZCBpbnQgY3B1LAorc3RhdGljIGlubGluZSBib29sIGl0ZW1fY2hlY2tfYWZm
aW5pdHkoc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0sCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgY3B1LAogICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGJhbGFuY2Vfc3RlcCkKIHsKLSAgICBhZmZpbml0
eV9iYWxhbmNlX2NwdW1hc2sodi0+c2NoZWRfaXRlbSwgYmFsYW5jZV9zdGVwLAotICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBjcHVtYXNrX3NjcmF0Y2hfY3B1KGNwdSkpOworICAgIGFmZmlu
aXR5X2JhbGFuY2VfY3B1bWFzayhpdGVtLCBiYWxhbmNlX3N0ZXAsIGNwdW1hc2tfc2NyYXRjaF9j
cHUoY3B1KSk7CiAgICAgY3B1bWFza19hbmQoY3B1bWFza19zY3JhdGNoX2NwdShjcHUpLCBjcHVt
YXNrX3NjcmF0Y2hfY3B1KGNwdSksCi0gICAgICAgICAgICAgICAgY3B1cG9vbF9kb21haW5fY3B1
bWFzayh2LT5kb21haW4pKTsKKyAgICAgICAgICAgICAgICBjcHVwb29sX2RvbWFpbl9jcHVtYXNr
KGl0ZW0tPmRvbWFpbikpOwogCiAgICAgcmV0dXJuIGNwdW1hc2tfdGVzdF9jcHUoY3B1LCBjcHVt
YXNrX3NjcmF0Y2hfY3B1KGNwdSkpOwogfQpAQCAtMTYxLDkgKzE2MSw5IEBAIHN0YXRpYyB2b2lk
IG51bGxfZGVpbml0KHN0cnVjdCBzY2hlZHVsZXIgKm9wcykKIAogc3RhdGljIHZvaWQgaW5pdF9w
ZGF0YShzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHVuc2lnbmVkIGludCBjcHUpCiB7Ci0gICAg
LyogTWFyayB0aGUgcENQVSBhcyBmcmVlLCBhbmQgd2l0aCBubyB2Q1BVIGFzc2lnbmVkICovCisg
ICAgLyogTWFyayB0aGUgcENQVSBhcyBmcmVlLCBhbmQgd2l0aCBubyBpdGVtIGFzc2lnbmVkICov
CiAgICAgY3B1bWFza19zZXRfY3B1KGNwdSwgJnBydi0+Y3B1c19mcmVlKTsKLSAgICBwZXJfY3B1
KG5wYywgY3B1KS52Y3B1ID0gTlVMTDsKKyAgICBwZXJfY3B1KG5wYywgY3B1KS5pdGVtID0gTlVM
TDsKIH0KIAogc3RhdGljIHZvaWQgbnVsbF9pbml0X3BkYXRhKGNvbnN0IHN0cnVjdCBzY2hlZHVs
ZXIgKm9wcywgdm9pZCAqcGRhdGEsIGludCBjcHUpCkBAIC0xOTEsMTMgKzE5MSwxMiBAQCBzdGF0
aWMgdm9pZCBudWxsX2RlaW5pdF9wZGF0YShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHZv
aWQgKnBjcHUsIGludCBjcHUpCiAgICAgQVNTRVJUKCFwY3B1KTsKIAogICAgIGNwdW1hc2tfY2xl
YXJfY3B1KGNwdSwgJnBydi0+Y3B1c19mcmVlKTsKLSAgICBwZXJfY3B1KG5wYywgY3B1KS52Y3B1
ID0gTlVMTDsKKyAgICBwZXJfY3B1KG5wYywgY3B1KS5pdGVtID0gTlVMTDsKIH0KIAogc3RhdGlj
IHZvaWQgKm51bGxfYWxsb2NfdmRhdGEoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0sIHZvaWQg
KmRkKQogewotICAgIHN0cnVjdCB2Y3B1ICp2ID0gaXRlbS0+dmNwdTsKICAgICBzdHJ1Y3QgbnVs
bF9pdGVtICpudmM7CiAKICAgICBudmMgPSB4emFsbG9jKHN0cnVjdCBudWxsX2l0ZW0pOwpAQCAt
MjA1LDcgKzIwNCw3IEBAIHN0YXRpYyB2b2lkICpudWxsX2FsbG9jX3ZkYXRhKGNvbnN0IHN0cnVj
dCBzY2hlZHVsZXIgKm9wcywKICAgICAgICAgcmV0dXJuIE5VTEw7CiAKICAgICBJTklUX0xJU1Rf
SEVBRCgmbnZjLT53YWl0cV9lbGVtKTsKLSAgICBudmMtPnZjcHUgPSB2OworICAgIG52Yy0+aXRl
bSA9IGl0ZW07CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKGl0ZW1fYWxsb2MpOwogCkBAIC0yNTcs
MTUgKzI1NiwxNSBAQCBzdGF0aWMgdm9pZCBudWxsX2ZyZWVfZG9tZGF0YShjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMsIHZvaWQgKmRhdGEpCiB9CiAKIC8qCi0gKiB2Q1BVIHRvIHBDUFUgYXNz
aWdubWVudCBhbmQgcGxhY2VtZW50LiBUaGlzIF9vbmx5XyBoYXBwZW5zOgorICogaXRlbSB0byBw
Q1BVIGFzc2lnbm1lbnQgYW5kIHBsYWNlbWVudC4gVGhpcyBfb25seV8gaGFwcGVuczoKICAqICAt
IG9uIGluc2VydCwKICAqICAtIG9uIG1pZ3JhdGUuCiAgKgotICogSW5zZXJ0IG9jY3VycyB3aGVu
IGEgdkNQVSBqb2lucyB0aGlzIHNjaGVkdWxlciBmb3IgdGhlIGZpcnN0IHRpbWUKKyAqIEluc2Vy
dCBvY2N1cnMgd2hlbiBhIGl0ZW0gam9pbnMgdGhpcyBzY2hlZHVsZXIgZm9yIHRoZSBmaXJzdCB0
aW1lCiAgKiAoZS5nLiwgd2hlbiB0aGUgZG9tYWluIGl0J3MgcGFydCBvZiBpcyBtb3ZlZCB0byB0
aGUgc2NoZWR1bGVyJ3MKICAqIGNwdXBvb2wpLgogICoKLSAqIE1pZ3JhdGlvbiBtYXkgYmUgbmVj
ZXNzYXJ5IGlmIGEgcENQVSAod2l0aCBhIHZDUFUgYXNzaWduZWQgdG8gaXQpCisgKiBNaWdyYXRp
b24gbWF5IGJlIG5lY2Vzc2FyeSBpZiBhIHBDUFUgKHdpdGggYSBpdGVtIGFzc2lnbmVkIHRvIGl0
KQogICogaXMgcmVtb3ZlZCBmcm9tIHRoZSBzY2hlZHVsZXIncyBjcHVwb29sLgogICoKICAqIFNv
IHRoaXMgaXMgbm90IHBhcnQgb2YgYW55IGhvdCBwYXRoLgpAQCAtMjc0LDkgKzI3Myw4IEBAIHN0
YXRpYyBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKgogcGlja19yZXMoc3RydWN0IG51bGxfcHJpdmF0
ZSAqcHJ2LCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSkKIHsKICAgICB1bnNpZ25lZCBpbnQgYnM7
Ci0gICAgc3RydWN0IHZjcHUgKnYgPSBpdGVtLT52Y3B1OwotICAgIHVuc2lnbmVkIGludCBjcHUg
PSB2LT5wcm9jZXNzb3IsIG5ld19jcHU7Ci0gICAgY3B1bWFza190ICpjcHVzID0gY3B1cG9vbF9k
b21haW5fY3B1bWFzayh2LT5kb21haW4pOworICAgIHVuc2lnbmVkIGludCBjcHUgPSBzY2hlZF9p
dGVtX2NwdShpdGVtKSwgbmV3X2NwdTsKKyAgICBjcHVtYXNrX3QgKmNwdXMgPSBjcHVwb29sX2Rv
bWFpbl9jcHVtYXNrKGl0ZW0tPmRvbWFpbik7CiAKICAgICBBU1NFUlQoc3Bpbl9pc19sb2NrZWQo
cGVyX2NwdShzY2hlZF9yZXMsIGNwdSktPnNjaGVkdWxlX2xvY2spKTsKIApAQCAtMjkxLDExICsy
ODksMTIgQEAgcGlja19yZXMoc3RydWN0IG51bGxfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3Qgc2NoZWRf
aXRlbSAqaXRlbSkKICAgICAgICAgLyoKICAgICAgICAgICogSWYgb3VyIHByb2Nlc3NvciBpcyBm
cmVlLCBvciB3ZSBhcmUgYXNzaWduZWQgdG8gaXQsIGFuZCBpdCBpcyBhbHNvCiAgICAgICAgICAq
IHN0aWxsIHZhbGlkIGFuZCBwYXJ0IG9mIG91ciBhZmZpbml0eSwganVzdCBnbyBmb3IgaXQuCi0g
ICAgICAgICAqIChOb3RlIHRoYXQgd2UgbWF5IGNhbGwgdmNwdV9jaGVja19hZmZpbml0eSgpLCBi
dXQgd2UgZGVsaWJlcmF0ZWx5CisgICAgICAgICAqIChOb3RlIHRoYXQgd2UgbWF5IGNhbGwgaXRl
bV9jaGVja19hZmZpbml0eSgpLCBidXQgd2UgZGVsaWJlcmF0ZWx5CiAgICAgICAgICAqIGRvbid0
LCBzbyB3ZSBnZXQgdG8ga2VlcCBpbiB0aGUgc2NyYXRjaCBjcHVtYXNrIHdoYXQgd2UgaGF2ZSBq
dXN0CiAgICAgICAgICAqIHB1dCBpbiBpdC4pCiAgICAgICAgICAqLwotICAgICAgICBpZiAoIGxp
a2VseSgocGVyX2NwdShucGMsIGNwdSkudmNwdSA9PSBOVUxMIHx8IHBlcl9jcHUobnBjLCBjcHUp
LnZjcHUgPT0gdikKKyAgICAgICAgaWYgKCBsaWtlbHkoKHBlcl9jcHUobnBjLCBjcHUpLml0ZW0g
PT0gTlVMTCB8fAorICAgICAgICAgICAgICAgICAgICAgcGVyX2NwdShucGMsIGNwdSkuaXRlbSA9
PSBpdGVtKQogICAgICAgICAgICAgICAgICAgICAmJiBjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgY3B1
bWFza19zY3JhdGNoX2NwdShjcHUpKSkgKQogICAgICAgICB7CiAgICAgICAgICAgICBuZXdfY3B1
ID0gY3B1OwpAQCAtMzEzLDEzICszMTIsMTMgQEAgcGlja19yZXMoc3RydWN0IG51bGxfcHJpdmF0
ZSAqcHJ2LCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSkKIAogICAgIC8qCiAgICAgICogSWYgd2Ug
ZGlkbid0IGZpbmQgYW55IGZyZWUgcENQVSwganVzdCBwaWNrIGFueSB2YWxpZCBwY3B1LCBldmVu
IGlmCi0gICAgICogaXQgaGFzIGFub3RoZXIgdkNQVSBhc3NpZ25lZC4gVGhpcyB3aWxsIGhhcHBl
biBkdXJpbmcgc2h1dGRvd24gYW5kCisgICAgICogaXQgaGFzIGFub3RoZXIgSXRlbSBhc3NpZ25l
ZC4gVGhpcyB3aWxsIGhhcHBlbiBkdXJpbmcgc2h1dGRvd24gYW5kCiAgICAgICogc3VzcGVuZC9y
ZXN1bWUsIGJ1dCBpdCBtYXkgYWxzbyBoYXBwZW4gZHVyaW5nICJub3JtYWwgb3BlcmF0aW9uIiwg
aWYKICAgICAgKiBhbGwgdGhlIHBDUFVzIGFyZSBidXN5LgogICAgICAqCiAgICAgICogSW4gZmFj
dCwgdGhlcmUgbXVzdCBhbHdheXMgYmUgc29tZXRoaW5nIHNhbmUgaW4gdi0+cHJvY2Vzc29yLCBv
cgogICAgICAqIGl0ZW1fc2NoZWR1bGVfbG9jaygpIGFuZCBmcmllbmRzIHdvbid0IHdvcmsuIFRo
aXMgaXMgbm90IGEgcHJvYmxlbSwKLSAgICAgKiBhcyB3ZSB3aWxsIGFjdHVhbGx5IGFzc2lnbiB0
aGUgdkNQVSB0byB0aGUgcENQVSB3ZSByZXR1cm4gZnJvbSBoZXJlLAorICAgICAqIGFzIHdlIHdp
bGwgYWN0dWFsbHkgYXNzaWduIHRoZSBJdGVtIHRvIHRoZSBwQ1BVIHdlIHJldHVybiBmcm9tIGhl
cmUsCiAgICAgICogb25seSBpZiB0aGUgcENQVSBpcyBmcmVlLgogICAgICAqLwogICAgIGNwdW1h
c2tfYW5kKGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSwgY3B1cywgaXRlbS0+Y3B1X2hhcmRfYWZm
aW5pdHkpOwpAQCAtMzI5LDExICszMjgsMTEgQEAgcGlja19yZXMoc3RydWN0IG51bGxfcHJpdmF0
ZSAqcHJ2LCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSkKICAgICBpZiAoIHVubGlrZWx5KHRiX2lu
aXRfZG9uZSkgKQogICAgIHsKICAgICAgICAgc3RydWN0IHsKLSAgICAgICAgICAgIHVpbnQxNl90
IHZjcHUsIGRvbTsKKyAgICAgICAgICAgIHVpbnQxNl90IGl0ZW0sIGRvbTsKICAgICAgICAgICAg
IHVpbnQzMl90IG5ld19jcHU7CiAgICAgICAgIH0gZDsKLSAgICAgICAgZC5kb20gPSB2LT5kb21h
aW4tPmRvbWFpbl9pZDsKLSAgICAgICAgZC52Y3B1ID0gdi0+dmNwdV9pZDsKKyAgICAgICAgZC5k
b20gPSBpdGVtLT5kb21haW4tPmRvbWFpbl9pZDsKKyAgICAgICAgZC5pdGVtID0gaXRlbS0+aXRl
bV9pZDsKICAgICAgICAgZC5uZXdfY3B1ID0gbmV3X2NwdTsKICAgICAgICAgX190cmFjZV92YXIo
VFJDX1NOVUxMX1BJQ0tFRF9DUFUsIDEsIHNpemVvZihkKSwgJmQpOwogICAgIH0KQEAgLTM0MSw0
NyArMzQwLDQ3IEBAIHBpY2tfcmVzKHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiwgc3RydWN0IHNj
aGVkX2l0ZW0gKml0ZW0pCiAgICAgcmV0dXJuIHBlcl9jcHUoc2NoZWRfcmVzLCBuZXdfY3B1KTsK
IH0KIAotc3RhdGljIHZvaWQgdmNwdV9hc3NpZ24oc3RydWN0IG51bGxfcHJpdmF0ZSAqcHJ2LCBz
dHJ1Y3QgdmNwdSAqdiwKK3N0YXRpYyB2b2lkIGl0ZW1fYXNzaWduKHN0cnVjdCBudWxsX3ByaXZh
dGUgKnBydiwgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAg
ICB1bnNpZ25lZCBpbnQgY3B1KQogewotICAgIHBlcl9jcHUobnBjLCBjcHUpLnZjcHUgPSB2Owot
ICAgIHYtPnByb2Nlc3NvciA9IGNwdTsKLSAgICB2LT5zY2hlZF9pdGVtLT5yZXMgPSBwZXJfY3B1
KHNjaGVkX3JlcywgY3B1KTsKKyAgICBwZXJfY3B1KG5wYywgY3B1KS5pdGVtID0gaXRlbTsKKyAg
ICBzY2hlZF9zZXRfcmVzKGl0ZW0sIHBlcl9jcHUoc2NoZWRfcmVzLCBjcHUpKTsKICAgICBjcHVt
YXNrX2NsZWFyX2NwdShjcHUsICZwcnYtPmNwdXNfZnJlZSk7CiAKLSAgICBkcHJpbnRrKFhFTkxP
R19HX0lORk8sICIlZCA8LS0gJXB2XG4iLCBjcHUsIHYpOworICAgIGRwcmludGsoWEVOTE9HX0df
SU5GTywgIiVkIDwtLSAlcGR2JWRcbiIsIGNwdSwgaXRlbS0+ZG9tYWluLCBpdGVtLT5pdGVtX2lk
KTsKIAogICAgIGlmICggdW5saWtlbHkodGJfaW5pdF9kb25lKSApCiAgICAgewogICAgICAgICBz
dHJ1Y3QgewotICAgICAgICAgICAgdWludDE2X3QgdmNwdSwgZG9tOworICAgICAgICAgICAgdWlu
dDE2X3QgaXRlbSwgZG9tOwogICAgICAgICAgICAgdWludDMyX3QgY3B1OwogICAgICAgICB9IGQ7
Ci0gICAgICAgIGQuZG9tID0gdi0+ZG9tYWluLT5kb21haW5faWQ7Ci0gICAgICAgIGQudmNwdSA9
IHYtPnZjcHVfaWQ7CisgICAgICAgIGQuZG9tID0gaXRlbS0+ZG9tYWluLT5kb21haW5faWQ7Cisg
ICAgICAgIGQuaXRlbSA9IGl0ZW0tPml0ZW1faWQ7CiAgICAgICAgIGQuY3B1ID0gY3B1OwotICAg
ICAgICBfX3RyYWNlX3ZhcihUUkNfU05VTExfVkNQVV9BU1NJR04sIDEsIHNpemVvZihkKSwgJmQp
OworICAgICAgICBfX3RyYWNlX3ZhcihUUkNfU05VTExfSVRFTV9BU1NJR04sIDEsIHNpemVvZihk
KSwgJmQpOwogICAgIH0KIH0KIAotc3RhdGljIHZvaWQgdmNwdV9kZWFzc2lnbihzdHJ1Y3QgbnVs
bF9wcml2YXRlICpwcnYsIHN0cnVjdCB2Y3B1ICp2LAorc3RhdGljIHZvaWQgaXRlbV9kZWFzc2ln
bihzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHN0cnVjdCBzY2hlZF9pdGVtICppdGVtLAogICAg
ICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgY3B1KQogewotICAgIHBlcl9jcHUo
bnBjLCBjcHUpLnZjcHUgPSBOVUxMOworICAgIHBlcl9jcHUobnBjLCBjcHUpLml0ZW0gPSBOVUxM
OwogICAgIGNwdW1hc2tfc2V0X2NwdShjcHUsICZwcnYtPmNwdXNfZnJlZSk7CiAKLSAgICBkcHJp
bnRrKFhFTkxPR19HX0lORk8sICIlZCA8LS0gTlVMTCAoJXB2KVxuIiwgY3B1LCB2KTsKKyAgICBk
cHJpbnRrKFhFTkxPR19HX0lORk8sICIlZCA8LS0gTlVMTCAoJXBkdiVkKVxuIiwgY3B1LCBpdGVt
LT5kb21haW4sCisgICAgICAgICAgICBpdGVtLT5pdGVtX2lkKTsKIAogICAgIGlmICggdW5saWtl
bHkodGJfaW5pdF9kb25lKSApCiAgICAgewogICAgICAgICBzdHJ1Y3QgewotICAgICAgICAgICAg
dWludDE2X3QgdmNwdSwgZG9tOworICAgICAgICAgICAgdWludDE2X3QgaXRlbSwgZG9tOwogICAg
ICAgICAgICAgdWludDMyX3QgY3B1OwogICAgICAgICB9IGQ7Ci0gICAgICAgIGQuZG9tID0gdi0+
ZG9tYWluLT5kb21haW5faWQ7Ci0gICAgICAgIGQudmNwdSA9IHYtPnZjcHVfaWQ7CisgICAgICAg
IGQuZG9tID0gaXRlbS0+ZG9tYWluLT5kb21haW5faWQ7CisgICAgICAgIGQuaXRlbSA9IGl0ZW0t
Pml0ZW1faWQ7CiAgICAgICAgIGQuY3B1ID0gY3B1OwotICAgICAgICBfX3RyYWNlX3ZhcihUUkNf
U05VTExfVkNQVV9ERUFTU0lHTiwgMSwgc2l6ZW9mKGQpLCAmZCk7CisgICAgICAgIF9fdHJhY2Vf
dmFyKFRSQ19TTlVMTF9JVEVNX0RFQVNTSUdOLCAxLCBzaXplb2YoZCksICZkKTsKICAgICB9CiB9
CiAKQEAgLTM5Myw5ICszOTIsOSBAQCBzdGF0aWMgdm9pZCBudWxsX3N3aXRjaF9zY2hlZChzdHJ1
Y3Qgc2NoZWR1bGVyICpuZXdfb3BzLCB1bnNpZ25lZCBpbnQgY3B1LAogICAgIHN0cnVjdCBudWxs
X3ByaXZhdGUgKnBydiA9IG51bGxfcHJpdihuZXdfb3BzKTsKICAgICBzdHJ1Y3QgbnVsbF9pdGVt
ICpudmMgPSB2ZGF0YTsKIAotICAgIEFTU0VSVChudmMgJiYgaXNfaWRsZV92Y3B1KG52Yy0+dmNw
dSkpOworICAgIEFTU0VSVChudmMgJiYgaXNfaWRsZV9pdGVtKG52Yy0+aXRlbSkpOwogCi0gICAg
aWRsZV92Y3B1W2NwdV0tPnNjaGVkX2l0ZW0tPnByaXYgPSB2ZGF0YTsKKyAgICBzY2hlZF9pZGxl
X2l0ZW0oY3B1KS0+cHJpdiA9IHZkYXRhOwogCiAgICAgLyoKICAgICAgKiBXZSBhcmUgaG9sZGlu
ZyB0aGUgcnVucXVldWUgbG9jayBhbHJlYWR5IChpdCdzIGJlZW4gdGFrZW4gaW4KQEAgLTQyMSwz
NSArNDIwLDM0IEBAIHN0YXRpYyB2b2lkIG51bGxfc3dpdGNoX3NjaGVkKHN0cnVjdCBzY2hlZHVs
ZXIgKm5ld19vcHMsIHVuc2lnbmVkIGludCBjcHUsCiBzdGF0aWMgdm9pZCBudWxsX2l0ZW1faW5z
ZXJ0KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0pCiB7Ci0gICAgc3RydWN0IHZjcHUgKnYgPSBp
dGVtLT52Y3B1OwogICAgIHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiA9IG51bGxfcHJpdihvcHMp
OwogICAgIHN0cnVjdCBudWxsX2l0ZW0gKm52YyA9IG51bGxfaXRlbShpdGVtKTsKICAgICB1bnNp
Z25lZCBpbnQgY3B1OwogICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAKLSAgICBBU1NFUlQoIWlzX2lk
bGVfdmNwdSh2KSk7CisgICAgQVNTRVJUKCFpc19pZGxlX2l0ZW0oaXRlbSkpOwogCiAgICAgbG9j
ayA9IGl0ZW1fc2NoZWR1bGVfbG9ja19pcnEoaXRlbSk7CiAgcmV0cnk6CiAKLSAgICBpdGVtLT5y
ZXMgPSBwaWNrX3JlcyhwcnYsIGl0ZW0pOwotICAgIGNwdSA9IHYtPnByb2Nlc3NvciA9IGl0ZW0t
PnJlcy0+cHJvY2Vzc29yOworICAgIHNjaGVkX3NldF9yZXMoaXRlbSwgcGlja19yZXMocHJ2LCBp
dGVtKSk7CisgICAgY3B1ID0gc2NoZWRfaXRlbV9jcHUoaXRlbSk7CiAKICAgICBzcGluX3VubG9j
ayhsb2NrKTsKIAogICAgIGxvY2sgPSBpdGVtX3NjaGVkdWxlX2xvY2soaXRlbSk7CiAKICAgICBj
cHVtYXNrX2FuZChjcHVtYXNrX3NjcmF0Y2hfY3B1KGNwdSksIGl0ZW0tPmNwdV9oYXJkX2FmZmlu
aXR5LAotICAgICAgICAgICAgICAgIGNwdXBvb2xfZG9tYWluX2NwdW1hc2sodi0+ZG9tYWluKSk7
CisgICAgICAgICAgICAgICAgY3B1cG9vbF9kb21haW5fY3B1bWFzayhpdGVtLT5kb21haW4pKTsK
IAotICAgIC8qIElmIHRoZSBwQ1BVIGlzIGZyZWUsIHdlIGFzc2lnbiB2IHRvIGl0ICovCi0gICAg
aWYgKCBsaWtlbHkocGVyX2NwdShucGMsIGNwdSkudmNwdSA9PSBOVUxMKSApCisgICAgLyogSWYg
dGhlIHBDUFUgaXMgZnJlZSwgd2UgYXNzaWduIGl0ZW0gdG8gaXQgKi8KKyAgICBpZiAoIGxpa2Vs
eShwZXJfY3B1KG5wYywgY3B1KS5pdGVtID09IE5VTEwpICkKICAgICB7CiAgICAgICAgIC8qCiAg
ICAgICAgICAqIEluc2VydCBpcyBmb2xsb3dlZCBieSB2Y3B1X3dha2UoKSwgc28gdGhlcmUncyBu
byBuZWVkIHRvIHBva2UKICAgICAgICAgICogdGhlIHBjcHUgd2l0aCB0aGUgU0NIRURVTEVfU09G
VElSUSwgYXMgd2FrZSB3aWxsIGRvIHRoYXQuCiAgICAgICAgICAqLwotICAgICAgICB2Y3B1X2Fz
c2lnbihwcnYsIHYsIGNwdSk7CisgICAgICAgIGl0ZW1fYXNzaWduKHBydiwgaXRlbSwgY3B1KTsK
ICAgICB9CiAgICAgZWxzZSBpZiAoIGNwdW1hc2tfaW50ZXJzZWN0cygmcHJ2LT5jcHVzX2ZyZWUs
IGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSkgKQogICAgIHsKQEAgLTQ2OCw3ICs0NjYsOCBAQCBz
dGF0aWMgdm9pZCBudWxsX2l0ZW1faW5zZXJ0KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywK
ICAgICAgICAgICovCiAgICAgICAgIHNwaW5fbG9jaygmcHJ2LT53YWl0cV9sb2NrKTsKICAgICAg
ICAgbGlzdF9hZGRfdGFpbCgmbnZjLT53YWl0cV9lbGVtLCAmcHJ2LT53YWl0cSk7Ci0gICAgICAg
IGRwcmludGsoWEVOTE9HX0dfV0FSTklORywgIldBUk5JTkc6ICVwdiBub3QgYXNzaWduZWQgdG8g
YW55IENQVSFcbiIsIHYpOworICAgICAgICBkcHJpbnRrKFhFTkxPR19HX1dBUk5JTkcsICJXQVJO
SU5HOiAlcGR2JWQgbm90IGFzc2lnbmVkIHRvIGFueSBDUFUhXG4iLAorICAgICAgICAgICAgICAg
IGl0ZW0tPmRvbWFpbiwgaXRlbS0+aXRlbV9pZCk7CiAgICAgICAgIHNwaW5fdW5sb2NrKCZwcnYt
PndhaXRxX2xvY2spOwogICAgIH0KICAgICBzcGluX3VubG9ja19pcnEobG9jayk7CkBAIC00NzYs
MzUgKzQ3NSwzNCBAQCBzdGF0aWMgdm9pZCBudWxsX2l0ZW1faW5zZXJ0KGNvbnN0IHN0cnVjdCBz
Y2hlZHVsZXIgKm9wcywKICAgICBTQ0hFRF9TVEFUX0NSQU5LKGl0ZW1faW5zZXJ0KTsKIH0KIAot
c3RhdGljIHZvaWQgX3ZjcHVfcmVtb3ZlKHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiwgc3RydWN0
IHZjcHUgKnYpCitzdGF0aWMgdm9pZCBfaXRlbV9yZW1vdmUoc3RydWN0IG51bGxfcHJpdmF0ZSAq
cHJ2LCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSkKIHsKICAgICB1bnNpZ25lZCBpbnQgYnM7Ci0g
ICAgdW5zaWduZWQgaW50IGNwdSA9IHYtPnByb2Nlc3NvcjsKKyAgICB1bnNpZ25lZCBpbnQgY3B1
ID0gc2NoZWRfaXRlbV9jcHUoaXRlbSk7CiAgICAgc3RydWN0IG51bGxfaXRlbSAqd3ZjOwogCi0g
ICAgQVNTRVJUKGxpc3RfZW1wdHkoJm51bGxfaXRlbSh2LT5zY2hlZF9pdGVtKS0+d2FpdHFfZWxl
bSkpOworICAgIEFTU0VSVChsaXN0X2VtcHR5KCZudWxsX2l0ZW0oaXRlbSktPndhaXRxX2VsZW0p
KTsKIAotICAgIHZjcHVfZGVhc3NpZ24ocHJ2LCB2LCBjcHUpOworICAgIGl0ZW1fZGVhc3NpZ24o
cHJ2LCBpdGVtLCBjcHUpOwogCiAgICAgc3Bpbl9sb2NrKCZwcnYtPndhaXRxX2xvY2spOwogCiAg
ICAgLyoKLSAgICAgKiBJZiB2IGlzIGFzc2lnbmVkIHRvIGEgcENQVSwgbGV0J3Mgc2VlIGlmIHRo
ZXJlIGlzIHNvbWVvbmUgd2FpdGluZywKLSAgICAgKiBzdWl0YWJsZSB0byBiZSBhc3NpZ25lZCB0
byBpdCAocHJpb3JpdGl6aW5nIHZjcHVzIHRoYXQgaGF2ZQorICAgICAqIElmIGl0ZW0gaXMgYXNz
aWduZWQgdG8gYSBwQ1BVLCBsZXQncyBzZWUgaWYgdGhlcmUgaXMgc29tZW9uZSB3YWl0aW5nLAor
ICAgICAqIHN1aXRhYmxlIHRvIGJlIGFzc2lnbmVkIHRvIGl0IChwcmlvcml0aXppbmcgaXRlbXMg
dGhhdCBoYXZlCiAgICAgICogc29mdC1hZmZpbml0eSB3aXRoIGNwdSkuCiAgICAgICovCiAgICAg
Zm9yX2VhY2hfYWZmaW5pdHlfYmFsYW5jZV9zdGVwKCBicyApCiAgICAgewogICAgICAgICBsaXN0
X2Zvcl9lYWNoX2VudHJ5KCB3dmMsICZwcnYtPndhaXRxLCB3YWl0cV9lbGVtICkKICAgICAgICAg
ewotICAgICAgICAgICAgaWYgKCBicyA9PSBCQUxBTkNFX1NPRlRfQUZGSU5JVFkgJiYKLSAgICAg
ICAgICAgICAgICAgIWhhc19zb2Z0X2FmZmluaXR5KHd2Yy0+dmNwdS0+c2NoZWRfaXRlbSkgKQor
ICAgICAgICAgICAgaWYgKCBicyA9PSBCQUxBTkNFX1NPRlRfQUZGSU5JVFkgJiYgIWhhc19zb2Z0
X2FmZmluaXR5KHd2Yy0+aXRlbSkgKQogICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogCi0gICAg
ICAgICAgICBpZiAoIHZjcHVfY2hlY2tfYWZmaW5pdHkod3ZjLT52Y3B1LCBjcHUsIGJzKSApCisg
ICAgICAgICAgICBpZiAoIGl0ZW1fY2hlY2tfYWZmaW5pdHkod3ZjLT5pdGVtLCBjcHUsIGJzKSAp
CiAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgbGlzdF9kZWxfaW5pdCgmd3ZjLT53YWl0
cV9lbGVtKTsKLSAgICAgICAgICAgICAgICB2Y3B1X2Fzc2lnbihwcnYsIHd2Yy0+dmNwdSwgY3B1
KTsKKyAgICAgICAgICAgICAgICBpdGVtX2Fzc2lnbihwcnYsIHd2Yy0+aXRlbSwgY3B1KTsKICAg
ICAgICAgICAgICAgICBjcHVfcmFpc2Vfc29mdGlycShjcHUsIFNDSEVEVUxFX1NPRlRJUlEpOwog
ICAgICAgICAgICAgICAgIHNwaW5fdW5sb2NrKCZwcnYtPndhaXRxX2xvY2spOwogICAgICAgICAg
ICAgICAgIHJldHVybjsKQEAgLTUxNywxNiArNTE1LDE1IEBAIHN0YXRpYyB2b2lkIF92Y3B1X3Jl
bW92ZShzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHN0cnVjdCB2Y3B1ICp2KQogc3RhdGljIHZv
aWQgbnVsbF9pdGVtX3JlbW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBzY2hlZF9pdGVtICppdGVtKQogewotICAgIHN0
cnVjdCB2Y3B1ICp2ID0gaXRlbS0+dmNwdTsKICAgICBzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYg
PSBudWxsX3ByaXYob3BzKTsKICAgICBzdHJ1Y3QgbnVsbF9pdGVtICpudmMgPSBudWxsX2l0ZW0o
aXRlbSk7CiAgICAgc3BpbmxvY2tfdCAqbG9jazsKIAotICAgIEFTU0VSVCghaXNfaWRsZV92Y3B1
KHYpKTsKKyAgICBBU1NFUlQoIWlzX2lkbGVfaXRlbShpdGVtKSk7CiAKICAgICBsb2NrID0gaXRl
bV9zY2hlZHVsZV9sb2NrX2lycShpdGVtKTsKIAotICAgIC8qIElmIHYgaXMgaW4gd2FpdHF1ZXVl
LCBqdXN0IGdldCBpdCBvdXQgb2YgdGhlcmUgYW5kIGJhaWwgKi8KKyAgICAvKiBJZiBpdGVtIGlz
IGluIHdhaXRxdWV1ZSwganVzdCBnZXQgaXQgb3V0IG9mIHRoZXJlIGFuZCBiYWlsICovCiAgICAg
aWYgKCB1bmxpa2VseSghbGlzdF9lbXB0eSgmbnZjLT53YWl0cV9lbGVtKSkgKQogICAgIHsKICAg
ICAgICAgc3Bpbl9sb2NrKCZwcnYtPndhaXRxX2xvY2spOwpAQCAtNTM2LDEwICs1MzMsMTAgQEAg
c3RhdGljIHZvaWQgbnVsbF9pdGVtX3JlbW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMs
CiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0KIAotICAgIEFTU0VSVChwZXJfY3B1KG5wYywgdi0+
cHJvY2Vzc29yKS52Y3B1ID09IHYpOwotICAgIEFTU0VSVCghY3B1bWFza190ZXN0X2NwdSh2LT5w
cm9jZXNzb3IsICZwcnYtPmNwdXNfZnJlZSkpOworICAgIEFTU0VSVChwZXJfY3B1KG5wYywgc2No
ZWRfaXRlbV9jcHUoaXRlbSkpLml0ZW0gPT0gaXRlbSk7CisgICAgQVNTRVJUKCFjcHVtYXNrX3Rl
c3RfY3B1KHNjaGVkX2l0ZW1fY3B1KGl0ZW0pLCAmcHJ2LT5jcHVzX2ZyZWUpKTsKIAotICAgIF92
Y3B1X3JlbW92ZShwcnYsIHYpOworICAgIF9pdGVtX3JlbW92ZShwcnYsIGl0ZW0pOwogCiAgb3V0
OgogICAgIGl0ZW1fc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBpdGVtKTsKQEAgLTU1MCwxMSAr
NTQ3LDkgQEAgc3RhdGljIHZvaWQgbnVsbF9pdGVtX3JlbW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1
bGVyICpvcHMsCiBzdGF0aWMgdm9pZCBudWxsX2l0ZW1fd2FrZShjb25zdCBzdHJ1Y3Qgc2NoZWR1
bGVyICpvcHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJ1Y3Qgc2NoZWRfaXRlbSAq
aXRlbSkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqdiA9IGl0ZW0tPnZjcHU7CisgICAgQVNTRVJUKCFp
c19pZGxlX2l0ZW0oaXRlbSkpOwogCi0gICAgQVNTRVJUKCFpc19pZGxlX3ZjcHUodikpOwotCi0g
ICAgaWYgKCB1bmxpa2VseShjdXJyX29uX2NwdSh2LT5wcm9jZXNzb3IpID09IGl0ZW0pICkKKyAg
ICBpZiAoIHVubGlrZWx5KGN1cnJfb25fY3B1KHNjaGVkX2l0ZW1fY3B1KGl0ZW0pKSA9PSBpdGVt
KSApCiAgICAgewogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKGl0ZW1fd2FrZV9ydW5uaW5nKTsK
ICAgICAgICAgcmV0dXJuOwpAQCAtNTY3LDI1ICs1NjIsMjMgQEAgc3RhdGljIHZvaWQgbnVsbF9p
dGVtX3dha2UoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAgICAgICByZXR1cm47CiAg
ICAgfQogCi0gICAgaWYgKCBsaWtlbHkodmNwdV9ydW5uYWJsZSh2KSkgKQorICAgIGlmICggbGlr
ZWx5KGl0ZW1fcnVubmFibGUoaXRlbSkpICkKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyhpdGVt
X3dha2VfcnVubmFibGUpOwogICAgIGVsc2UKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyhpdGVt
X3dha2Vfbm90X3J1bm5hYmxlKTsKIAotICAgIC8qIE5vdGUgdGhhdCB3ZSBnZXQgaGVyZSBvbmx5
IGZvciB2Q1BVcyBhc3NpZ25lZCB0byBhIHBDUFUgKi8KLSAgICBjcHVfcmFpc2Vfc29mdGlycSh2
LT5wcm9jZXNzb3IsIFNDSEVEVUxFX1NPRlRJUlEpOworICAgIC8qIE5vdGUgdGhhdCB3ZSBnZXQg
aGVyZSBvbmx5IGZvciBpdGVtcyBhc3NpZ25lZCB0byBhIHBDUFUgKi8KKyAgICBjcHVfcmFpc2Vf
c29mdGlycShzY2hlZF9pdGVtX2NwdShpdGVtKSwgU0NIRURVTEVfU09GVElSUSk7CiB9CiAKIHN0
YXRpYyB2b2lkIG51bGxfaXRlbV9zbGVlcChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0pCiB7Ci0g
ICAgc3RydWN0IHZjcHUgKnYgPSBpdGVtLT52Y3B1OwotCi0gICAgQVNTRVJUKCFpc19pZGxlX3Zj
cHUodikpOworICAgIEFTU0VSVCghaXNfaWRsZV9pdGVtKGl0ZW0pKTsKIAotICAgIC8qIElmIHYg
aXMgbm90IGFzc2lnbmVkIHRvIGEgcENQVSwgb3IgaXMgbm90IHJ1bm5pbmcsIG5vIG5lZWQgdG8g
Ym90aGVyICovCi0gICAgaWYgKCBjdXJyX29uX2NwdSh2LT5wcm9jZXNzb3IpID09IGl0ZW0gKQot
ICAgICAgICBjcHVfcmFpc2Vfc29mdGlycSh2LT5wcm9jZXNzb3IsIFNDSEVEVUxFX1NPRlRJUlEp
OworICAgIC8qIElmIGl0ZW0gaXNuJ3QgYXNzaWduZWQgdG8gYSBwQ1BVLCBvciBpc24ndCBydW5u
aW5nLCBubyBuZWVkIHRvIGJvdGhlciAqLworICAgIGlmICggY3Vycl9vbl9jcHUoc2NoZWRfaXRl
bV9jcHUoaXRlbSkpID09IGl0ZW0gKQorICAgICAgICBjcHVfcmFpc2Vfc29mdGlycShzY2hlZF9p
dGVtX2NwdShpdGVtKSwgU0NIRURVTEVfU09GVElSUSk7CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5L
KGl0ZW1fc2xlZXApOwogfQpAQCAtNTkzLDM3ICs1ODYsMzYgQEAgc3RhdGljIHZvaWQgbnVsbF9p
dGVtX3NsZWVwKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKIHN0YXRpYyBzdHJ1Y3Qgc2No
ZWRfcmVzb3VyY2UgKgogbnVsbF9yZXNfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMs
IHN0cnVjdCBzY2hlZF9pdGVtICppdGVtKQogewotICAgIEFTU0VSVCghaXNfaWRsZV92Y3B1KGl0
ZW0tPnZjcHUpKTsKKyAgICBBU1NFUlQoIWlzX2lkbGVfaXRlbShpdGVtKSk7CiAgICAgcmV0dXJu
IHBpY2tfcmVzKG51bGxfcHJpdihvcHMpLCBpdGVtKTsKIH0KIAogc3RhdGljIHZvaWQgbnVsbF9p
dGVtX21pZ3JhdGUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0sIHVuc2lnbmVkIGludCBuZXdf
Y3B1KQogewotICAgIHN0cnVjdCB2Y3B1ICp2ID0gaXRlbS0+dmNwdTsKICAgICBzdHJ1Y3QgbnVs
bF9wcml2YXRlICpwcnYgPSBudWxsX3ByaXYob3BzKTsKICAgICBzdHJ1Y3QgbnVsbF9pdGVtICpu
dmMgPSBudWxsX2l0ZW0oaXRlbSk7CiAKLSAgICBBU1NFUlQoIWlzX2lkbGVfdmNwdSh2KSk7Cisg
ICAgQVNTRVJUKCFpc19pZGxlX2l0ZW0oaXRlbSkpOwogCi0gICAgaWYgKCB2LT5wcm9jZXNzb3Ig
PT0gbmV3X2NwdSApCisgICAgaWYgKCBzY2hlZF9pdGVtX2NwdShpdGVtKSA9PSBuZXdfY3B1ICkK
ICAgICAgICAgcmV0dXJuOwogCiAgICAgaWYgKCB1bmxpa2VseSh0Yl9pbml0X2RvbmUpICkKICAg
ICB7CiAgICAgICAgIHN0cnVjdCB7Ci0gICAgICAgICAgICB1aW50MTZfdCB2Y3B1LCBkb207Cisg
ICAgICAgICAgICB1aW50MTZfdCBpdGVtLCBkb207CiAgICAgICAgICAgICB1aW50MTZfdCBjcHUs
IG5ld19jcHU7CiAgICAgICAgIH0gZDsKLSAgICAgICAgZC5kb20gPSB2LT5kb21haW4tPmRvbWFp
bl9pZDsKLSAgICAgICAgZC52Y3B1ID0gdi0+dmNwdV9pZDsKLSAgICAgICAgZC5jcHUgPSB2LT5w
cm9jZXNzb3I7CisgICAgICAgIGQuZG9tID0gaXRlbS0+ZG9tYWluLT5kb21haW5faWQ7CisgICAg
ICAgIGQuaXRlbSA9IGl0ZW0tPml0ZW1faWQ7CisgICAgICAgIGQuY3B1ID0gc2NoZWRfaXRlbV9j
cHUoaXRlbSk7CiAgICAgICAgIGQubmV3X2NwdSA9IG5ld19jcHU7CiAgICAgICAgIF9fdHJhY2Vf
dmFyKFRSQ19TTlVMTF9NSUdSQVRFLCAxLCBzaXplb2YoZCksICZkKTsKICAgICB9CiAKICAgICAv
KgotICAgICAqIHYgaXMgZWl0aGVyIGFzc2lnbmVkIHRvIGEgcENQVSwgb3IgaW4gdGhlIHdhaXRx
dWV1ZS4KKyAgICAgKiBpdGVtIGlzIGVpdGhlciBhc3NpZ25lZCB0byBhIHBDUFUsIG9yIGluIHRo
ZSB3YWl0cXVldWUuCiAgICAgICoKICAgICAgKiBJbiB0aGUgZm9ybWVyIGNhc2UsIHRoZSBwQ1BV
IHRvIHdoaWNoIGl0IHdhcyBhc3NpZ25lZCB3b3VsZAogICAgICAqIGJlY29tZSBmcmVlLCBhbmQg
d2UsIHRoZXJlZm9yZSwgc2hvdWxkIGNoZWNrIHdoZXRoZXIgdGhlcmUgaXMKQEAgLTYzMyw3ICs2
MjUsNyBAQCBzdGF0aWMgdm9pZCBudWxsX2l0ZW1fbWlncmF0ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1
bGVyICpvcHMsCiAgICAgICovCiAgICAgaWYgKCBsaWtlbHkobGlzdF9lbXB0eSgmbnZjLT53YWl0
cV9lbGVtKSkgKQogICAgIHsKLSAgICAgICAgX3ZjcHVfcmVtb3ZlKHBydiwgdik7CisgICAgICAg
IF9pdGVtX3JlbW92ZShwcnYsIGl0ZW0pOwogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3Jh
dGVfcnVubmluZyk7CiAgICAgfQogICAgIGVsc2UKQEAgLTY0MiwzMiArNjM0LDM0IEBAIHN0YXRp
YyB2b2lkIG51bGxfaXRlbV9taWdyYXRlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAg
ICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3JhdGVkKTsKIAogICAgIC8qCi0gICAgICogTGV0J3Mgbm93
IGNvbnNpZGVyIG5ld19jcHUsIHdoaWNoIGlzIHdoZXJlIHYgaXMgYmVpbmcgc2VudC4gSXQgY2Fu
IGJlCi0gICAgICogZWl0aGVyIGZyZWUsIG9yIGhhdmUgYSB2Q1BVIGFscmVhZHkgYXNzaWduZWQg
dG8gaXQuCisgICAgICogTGV0J3Mgbm93IGNvbnNpZGVyIG5ld19jcHUsIHdoaWNoIGlzIHdoZXJl
IGl0ZW0gaXMgYmVpbmcgc2VudC4gSXQgY2FuIGJlCisgICAgICogZWl0aGVyIGZyZWUsIG9yIGhh
dmUgYSBpdGVtIGFscmVhZHkgYXNzaWduZWQgdG8gaXQuCiAgICAgICoKLSAgICAgKiBJbiB0aGUg
Zm9ybWVyIGNhc2UsIHdlIHNob3VsZCBhc3NpZ24gdiB0byBpdCwgYW5kIHRyeSB0byBnZXQgaXQg
dG8gcnVuLAorICAgICAqIEluIHRoZSBmb3JtZXIgY2FzZSB3ZSBzaG91bGQgYXNzaWduIGl0ZW0g
dG8gaXQsIGFuZCB0cnkgdG8gZ2V0IGl0IHRvIHJ1biwKICAgICAgKiBpZiBwb3NzaWJsZSwgYWNj
b3JkaW5nIHRvIGFmZmluaXR5LgogICAgICAqCi0gICAgICogSW4gbGF0dGVyLCBhbGwgd2UgY2Fu
IGRvIGlzIHRvIHBhcmsgdiBpbiB0aGUgd2FpdHF1ZXVlLgorICAgICAqIEluIGxhdHRlciwgYWxs
IHdlIGNhbiBkbyBpcyB0byBwYXJrIGl0ZW0gaW4gdGhlIHdhaXRxdWV1ZS4KICAgICAgKi8KLSAg
ICBpZiAoIHBlcl9jcHUobnBjLCBuZXdfY3B1KS52Y3B1ID09IE5VTEwgJiYKLSAgICAgICAgIHZj
cHVfY2hlY2tfYWZmaW5pdHkodiwgbmV3X2NwdSwgQkFMQU5DRV9IQVJEX0FGRklOSVRZKSApCisg
ICAgaWYgKCBwZXJfY3B1KG5wYywgbmV3X2NwdSkuaXRlbSA9PSBOVUxMICYmCisgICAgICAgICBp
dGVtX2NoZWNrX2FmZmluaXR5KGl0ZW0sIG5ld19jcHUsIEJBTEFOQ0VfSEFSRF9BRkZJTklUWSkg
KQogICAgIHsKLSAgICAgICAgLyogdiBtaWdodCBoYXZlIGJlZW4gaW4gdGhlIHdhaXRxdWV1ZSwg
c28gcmVtb3ZlIGl0ICovCisgICAgICAgIC8qIGl0ZW0gbWlnaHQgaGF2ZSBiZWVuIGluIHRoZSB3
YWl0cXVldWUsIHNvIHJlbW92ZSBpdCAqLwogICAgICAgICBzcGluX2xvY2soJnBydi0+d2FpdHFf
bG9jayk7CiAgICAgICAgIGxpc3RfZGVsX2luaXQoJm52Yy0+d2FpdHFfZWxlbSk7CiAgICAgICAg
IHNwaW5fdW5sb2NrKCZwcnYtPndhaXRxX2xvY2spOwogCi0gICAgICAgIHZjcHVfYXNzaWduKHBy
diwgdiwgbmV3X2NwdSk7CisgICAgICAgIGl0ZW1fYXNzaWduKHBydiwgaXRlbSwgbmV3X2NwdSk7
CiAgICAgfQogICAgIGVsc2UKICAgICB7Ci0gICAgICAgIC8qIFB1dCB2IGluIHRoZSB3YWl0cXVl
dWUsIGlmIGl0IHdhc24ndCB0aGVyZSBhbHJlYWR5ICovCisgICAgICAgIC8qIFB1dCBpdGVtIGlu
IHRoZSB3YWl0cXVldWUsIGlmIGl0IHdhc24ndCB0aGVyZSBhbHJlYWR5ICovCiAgICAgICAgIHNw
aW5fbG9jaygmcHJ2LT53YWl0cV9sb2NrKTsKICAgICAgICAgaWYgKCBsaXN0X2VtcHR5KCZudmMt
PndhaXRxX2VsZW0pICkKICAgICAgICAgewogICAgICAgICAgICAgbGlzdF9hZGRfdGFpbCgmbnZj
LT53YWl0cV9lbGVtLCAmcHJ2LT53YWl0cSk7Ci0gICAgICAgICAgICBkcHJpbnRrKFhFTkxPR19H
X1dBUk5JTkcsICJXQVJOSU5HOiAlcHYgbm90IGFzc2lnbmVkIHRvIGFueSBDUFUhXG4iLCB2KTsK
KyAgICAgICAgICAgIGRwcmludGsoWEVOTE9HX0dfV0FSTklORywKKyAgICAgICAgICAgICAgICAg
ICAgIldBUk5JTkc6ICVwZHYlZCBub3QgYXNzaWduZWQgdG8gYW55IENQVSFcbiIsIGl0ZW0tPmRv
bWFpbiwKKyAgICAgICAgICAgICAgICAgICAgaXRlbS0+aXRlbV9pZCk7CiAgICAgICAgIH0KICAg
ICAgICAgc3Bpbl91bmxvY2soJnBydi0+d2FpdHFfbG9jayk7CiAgICAgfQpAQCAtNjgwLDM1ICs2
NzQsMzQgQEAgc3RhdGljIHZvaWQgbnVsbF9pdGVtX21pZ3JhdGUoY29uc3Qgc3RydWN0IHNjaGVk
dWxlciAqb3BzLAogICAgICAqIGF0IGxlYXN0LiBJbiBjYXNlIG9mIHN1c3BlbmQsIGFueSB0ZW1w
b3JhcnkgaW5jb25zaXN0ZW5jeSBjYXVzZWQKICAgICAgKiBieSB0aGlzLCB3aWxsIGJlIGZpeGVk
LXVwIGR1cmluZyByZXN1bWUuCiAgICAgICovCi0gICAgdi0+cHJvY2Vzc29yID0gbmV3X2NwdTsK
LSAgICBpdGVtLT5yZXMgPSBwZXJfY3B1KHNjaGVkX3JlcywgbmV3X2NwdSk7CisgICAgc2NoZWRf
c2V0X3JlcyhpdGVtLCBwZXJfY3B1KHNjaGVkX3JlcywgbmV3X2NwdSkpOwogfQogCiAjaWZuZGVm
IE5ERUJVRwotc3RhdGljIGlubGluZSB2b2lkIG51bGxfdmNwdV9jaGVjayhzdHJ1Y3QgdmNwdSAq
dikKK3N0YXRpYyBpbmxpbmUgdm9pZCBudWxsX2l0ZW1fY2hlY2soc3RydWN0IHNjaGVkX2l0ZW0g
Kml0ZW0pCiB7Ci0gICAgc3RydWN0IG51bGxfaXRlbSAqIGNvbnN0IG52YyA9IG51bGxfaXRlbSh2
LT5zY2hlZF9pdGVtKTsKLSAgICBzdHJ1Y3QgbnVsbF9kb20gKiBjb25zdCBuZG9tID0gdi0+ZG9t
YWluLT5zY2hlZF9wcml2OworICAgIHN0cnVjdCBudWxsX2l0ZW0gKiBjb25zdCBudmMgPSBudWxs
X2l0ZW0oaXRlbSk7CisgICAgc3RydWN0IG51bGxfZG9tICogY29uc3QgbmRvbSA9IGl0ZW0tPmRv
bWFpbi0+c2NoZWRfcHJpdjsKIAotICAgIEJVR19PTihudmMtPnZjcHUgIT0gdik7CisgICAgQlVH
X09OKG52Yy0+aXRlbSAhPSBpdGVtKTsKIAogICAgIGlmICggbmRvbSApCi0gICAgICAgIEJVR19P
Tihpc19pZGxlX3ZjcHUodikpOworICAgICAgICBCVUdfT04oaXNfaWRsZV9pdGVtKGl0ZW0pKTsK
ICAgICBlbHNlCi0gICAgICAgIEJVR19PTighaXNfaWRsZV92Y3B1KHYpKTsKKyAgICAgICAgQlVH
X09OKCFpc19pZGxlX2l0ZW0oaXRlbSkpOwogCiAgICAgU0NIRURfU1RBVF9DUkFOSyhpdGVtX2No
ZWNrKTsKIH0KLSNkZWZpbmUgTlVMTF9WQ1BVX0NIRUNLKHYpICAobnVsbF92Y3B1X2NoZWNrKHYp
KQorI2RlZmluZSBOVUxMX0lURU1fQ0hFQ0soaXRlbSkgIChudWxsX2l0ZW1fY2hlY2soaXRlbSkp
CiAjZWxzZQotI2RlZmluZSBOVUxMX1ZDUFVfQ0hFQ0sodikKKyNkZWZpbmUgTlVMTF9JVEVNX0NI
RUNLKGl0ZW0pCiAjZW5kaWYKIAogCiAvKgogICogVGhlIG1vc3Qgc2ltcGxlIHNjaGVkdWxpbmcg
ZnVuY3Rpb24gb2YgYWxsIHRpbWVzISBXZSBlaXRoZXIgcmV0dXJuOgotICogIC0gdGhlIHZDUFUg
YXNzaWduZWQgdG8gdGhlIHBDUFUsIGlmIHRoZXJlJ3Mgb25lIGFuZCBpdCBjYW4gcnVuOwotICog
IC0gdGhlIGlkbGUgdkNQVSwgb3RoZXJ3aXNlLgorICogIC0gdGhlIGl0ZW0gYXNzaWduZWQgdG8g
dGhlIHBDUFUsIGlmIHRoZXJlJ3Mgb25lIGFuZCBpdCBjYW4gcnVuOworICogIC0gdGhlIGlkbGUg
aXRlbSwgb3RoZXJ3aXNlLgogICovCiBzdGF0aWMgc3RydWN0IHRhc2tfc2xpY2UgbnVsbF9zY2hl
ZHVsZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBzX3RpbWVfdCBub3csCkBAIC03MjEsMjQgKzcxNCwyNCBAQCBzdGF0
aWMgc3RydWN0IHRhc2tfc2xpY2UgbnVsbF9zY2hlZHVsZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVy
ICpvcHMsCiAgICAgc3RydWN0IHRhc2tfc2xpY2UgcmV0OwogCiAgICAgU0NIRURfU1RBVF9DUkFO
SyhzY2hlZHVsZSk7Ci0gICAgTlVMTF9WQ1BVX0NIRUNLKGN1cnJlbnQpOworICAgIE5VTExfSVRF
TV9DSEVDSyhjdXJyZW50LT5zY2hlZF9pdGVtKTsKIAogICAgIGlmICggdW5saWtlbHkodGJfaW5p
dF9kb25lKSApCiAgICAgewogICAgICAgICBzdHJ1Y3QgewogICAgICAgICAgICAgdWludDE2X3Qg
dGFza2xldCwgY3B1OwotICAgICAgICAgICAgaW50MTZfdCB2Y3B1LCBkb207CisgICAgICAgICAg
ICBpbnQxNl90IGl0ZW0sIGRvbTsKICAgICAgICAgfSBkOwogICAgICAgICBkLmNwdSA9IGNwdTsK
ICAgICAgICAgZC50YXNrbGV0ID0gdGFza2xldF93b3JrX3NjaGVkdWxlZDsKLSAgICAgICAgaWYg
KCBwZXJfY3B1KG5wYywgY3B1KS52Y3B1ID09IE5VTEwgKQorICAgICAgICBpZiAoIHBlcl9jcHUo
bnBjLCBjcHUpLml0ZW0gPT0gTlVMTCApCiAgICAgICAgIHsKLSAgICAgICAgICAgIGQudmNwdSA9
IGQuZG9tID0gLTE7CisgICAgICAgICAgICBkLml0ZW0gPSBkLmRvbSA9IC0xOwogICAgICAgICB9
CiAgICAgICAgIGVsc2UKICAgICAgICAgewotICAgICAgICAgICAgZC52Y3B1ID0gcGVyX2NwdShu
cGMsIGNwdSkudmNwdS0+dmNwdV9pZDsKLSAgICAgICAgICAgIGQuZG9tID0gcGVyX2NwdShucGMs
IGNwdSkudmNwdS0+ZG9tYWluLT5kb21haW5faWQ7CisgICAgICAgICAgICBkLml0ZW0gPSBwZXJf
Y3B1KG5wYywgY3B1KS5pdGVtLT5pdGVtX2lkOworICAgICAgICAgICAgZC5kb20gPSBwZXJfY3B1
KG5wYywgY3B1KS5pdGVtLT5kb21haW4tPmRvbWFpbl9pZDsKICAgICAgICAgfQogICAgICAgICBf
X3RyYWNlX3ZhcihUUkNfU05VTExfU0NIRURVTEUsIDEsIHNpemVvZihkKSwgJmQpOwogICAgIH0K
QEAgLTc0NiwxNiArNzM5LDE2IEBAIHN0YXRpYyBzdHJ1Y3QgdGFza19zbGljZSBudWxsX3NjaGVk
dWxlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAgICBpZiAoIHRhc2tsZXRfd29ya19z
Y2hlZHVsZWQgKQogICAgIHsKICAgICAgICAgdHJhY2VfdmFyKFRSQ19TTlVMTF9UQVNLTEVULCAx
LCAwLCBOVUxMKTsKLSAgICAgICAgcmV0LnRhc2sgPSBpZGxlX3ZjcHVbY3B1XS0+c2NoZWRfaXRl
bTsKKyAgICAgICAgcmV0LnRhc2sgPSBzY2hlZF9pZGxlX2l0ZW0oY3B1KTsKICAgICB9CiAgICAg
ZWxzZQotICAgICAgICByZXQudGFzayA9IHBlcl9jcHUobnBjLCBjcHUpLnZjcHUtPnNjaGVkX2l0
ZW07CisgICAgICAgIHJldC50YXNrID0gcGVyX2NwdShucGMsIGNwdSkuaXRlbTsKICAgICByZXQu
bWlncmF0ZWQgPSAwOwogICAgIHJldC50aW1lID0gLTE7CiAKICAgICAvKgogICAgICAqIFdlIG1h
eSBiZSBuZXcgaW4gdGhlIGNwdXBvb2wsIG9yIGp1c3QgY29taW5nIGJhY2sgb25saW5lLiBJbiB3
aGljaAotICAgICAqIGNhc2UsIHRoZXJlIG1heSBiZSB2Q1BVcyBpbiB0aGUgd2FpdHF1ZXVlIHRo
YXQgd2UgY2FuIGFzc2lnbiB0byB1cworICAgICAqIGNhc2UsIHRoZXJlIG1heSBiZSBpdGVtcyBp
biB0aGUgd2FpdHF1ZXVlIHRoYXQgd2UgY2FuIGFzc2lnbiB0byB1cwogICAgICAqIGFuZCBydW4u
CiAgICAgICovCiAgICAgaWYgKCB1bmxpa2VseShyZXQudGFzayA9PSBOVUxMKSApCkBAIC03NjYs
MTAgKzc1OSwxMCBAQCBzdGF0aWMgc3RydWN0IHRhc2tfc2xpY2UgbnVsbF9zY2hlZHVsZShjb25z
dCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiAgICAgICAgICAgICBnb3RvIHVubG9jazsKIAogICAg
ICAgICAvKgotICAgICAgICAgKiBXZSBzY2FuIHRoZSB3YWl0cXVldWUgdHdpY2UsIGZvciBwcmlv
cml0aXppbmcgdmNwdXMgdGhhdCBoYXZlCisgICAgICAgICAqIFdlIHNjYW4gdGhlIHdhaXRxdWV1
ZSB0d2ljZSwgZm9yIHByaW9yaXRpemluZyBpdGVtcyB0aGF0IGhhdmUKICAgICAgICAgICogc29m
dC1hZmZpbml0eSB3aXRoIGNwdS4gVGhpcyBtYXkgbG9vayBsaWtlIHNvbWV0aGluZyBleHBlbnNp
dmUgdG8KLSAgICAgICAgICogZG8gaGVyZSBpbiBudWxsX3NjaGVkdWxlKCksIGJ1dCBpdCdzIGFj
dHVhbGx5IGZpbmUsIGJlY2V1c2Ugd2UgZG8KLSAgICAgICAgICogaXQgb25seSBpbiBjYXNlcyB3
aGVyZSBhIHBjcHUgaGFzIG5vIHZjcHUgYXNzb2NpYXRlZCAoZS5nLiwgYXMKKyAgICAgICAgICog
ZG8gaGVyZSBpbiBudWxsX3NjaGVkdWxlKCksIGJ1dCBpdCdzIGFjdHVhbGx5IGZpbmUsIGJlY2F1
c2Ugd2UgZG8KKyAgICAgICAgICogaXQgb25seSBpbiBjYXNlcyB3aGVyZSBhIHBjcHUgaGFzIG5v
IGl0ZW0gYXNzb2NpYXRlZCAoZS5nLiwgYXMKICAgICAgICAgICogc2FpZCBhYm92ZSwgdGhlIGNw
dSBoYXMganVzdCBqb2luZWQgYSBjcHVwb29sKS4KICAgICAgICAgICovCiAgICAgICAgIGZvcl9l
YWNoX2FmZmluaXR5X2JhbGFuY2Vfc3RlcCggYnMgKQpAQCAtNzc3LDE0ICs3NzAsMTQgQEAgc3Rh
dGljIHN0cnVjdCB0YXNrX3NsaWNlIG51bGxfc2NoZWR1bGUoY29uc3Qgc3RydWN0IHNjaGVkdWxl
ciAqb3BzLAogICAgICAgICAgICAgbGlzdF9mb3JfZWFjaF9lbnRyeSggd3ZjLCAmcHJ2LT53YWl0
cSwgd2FpdHFfZWxlbSApCiAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgaWYgKCBicyA9
PSBCQUxBTkNFX1NPRlRfQUZGSU5JVFkgJiYKLSAgICAgICAgICAgICAgICAgICAgICFoYXNfc29m
dF9hZmZpbml0eSh3dmMtPnZjcHUtPnNjaGVkX2l0ZW0pICkKKyAgICAgICAgICAgICAgICAgICAg
ICFoYXNfc29mdF9hZmZpbml0eSh3dmMtPml0ZW0pICkKICAgICAgICAgICAgICAgICAgICAgY29u
dGludWU7CiAKLSAgICAgICAgICAgICAgICBpZiAoIHZjcHVfY2hlY2tfYWZmaW5pdHkod3ZjLT52
Y3B1LCBjcHUsIGJzKSApCisgICAgICAgICAgICAgICAgaWYgKCBpdGVtX2NoZWNrX2FmZmluaXR5
KHd2Yy0+aXRlbSwgY3B1LCBicykgKQogICAgICAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAg
ICAgICAgdmNwdV9hc3NpZ24ocHJ2LCB3dmMtPnZjcHUsIGNwdSk7CisgICAgICAgICAgICAgICAg
ICAgIGl0ZW1fYXNzaWduKHBydiwgd3ZjLT5pdGVtLCBjcHUpOwogICAgICAgICAgICAgICAgICAg
ICBsaXN0X2RlbF9pbml0KCZ3dmMtPndhaXRxX2VsZW0pOwotICAgICAgICAgICAgICAgICAgICBy
ZXQudGFzayA9IHd2Yy0+dmNwdS0+c2NoZWRfaXRlbTsKKyAgICAgICAgICAgICAgICAgICAgcmV0
LnRhc2sgPSB3dmMtPml0ZW07CiAgICAgICAgICAgICAgICAgICAgIGdvdG8gdW5sb2NrOwogICAg
ICAgICAgICAgICAgIH0KICAgICAgICAgICAgIH0KQEAgLTc5NCwxNyArNzg3LDE3IEBAIHN0YXRp
YyBzdHJ1Y3QgdGFza19zbGljZSBudWxsX3NjaGVkdWxlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIg
Km9wcywKICAgICB9CiAKICAgICBpZiAoIHVubGlrZWx5KHJldC50YXNrID09IE5VTEwgfHwgIWl0
ZW1fcnVubmFibGUocmV0LnRhc2spKSApCi0gICAgICAgIHJldC50YXNrID0gaWRsZV92Y3B1W2Nw
dV0tPnNjaGVkX2l0ZW07CisgICAgICAgIHJldC50YXNrID0gc2NoZWRfaWRsZV9pdGVtKGNwdSk7
CiAKLSAgICBOVUxMX1ZDUFVfQ0hFQ0socmV0LnRhc2stPnZjcHUpOworICAgIE5VTExfSVRFTV9D
SEVDSyhyZXQudGFzayk7CiAgICAgcmV0dXJuIHJldDsKIH0KIAotc3RhdGljIGlubGluZSB2b2lk
IGR1bXBfdmNwdShzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHN0cnVjdCBudWxsX2l0ZW0gKm52
YykKK3N0YXRpYyBpbmxpbmUgdm9pZCBkdW1wX2l0ZW0oc3RydWN0IG51bGxfcHJpdmF0ZSAqcHJ2
LCBzdHJ1Y3QgbnVsbF9pdGVtICpudmMpCiB7Ci0gICAgcHJpbnRrKCJbJWkuJWldIHBjcHU9JWQi
LCBudmMtPnZjcHUtPmRvbWFpbi0+ZG9tYWluX2lkLAotICAgICAgICAgICAgbnZjLT52Y3B1LT52
Y3B1X2lkLCBsaXN0X2VtcHR5KCZudmMtPndhaXRxX2VsZW0pID8KLSAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgbnZjLT52Y3B1LT5wcm9jZXNzb3IgOiAtMSk7CisgICAgcHJpbnRrKCJb
JWkuJWldIHBjcHU9JWQiLCBudmMtPml0ZW0tPmRvbWFpbi0+ZG9tYWluX2lkLAorICAgICAgICAg
ICAgbnZjLT5pdGVtLT5pdGVtX2lkLCBsaXN0X2VtcHR5KCZudmMtPndhaXRxX2VsZW0pID8KKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWRfaXRlbV9jcHUobnZjLT5pdGVtKSA6
IC0xKTsKIH0KIAogc3RhdGljIHZvaWQgbnVsbF9kdW1wX3BjcHUoY29uc3Qgc3RydWN0IHNjaGVk
dWxlciAqb3BzLCBpbnQgY3B1KQpAQCAtODIwLDE2ICs4MTMsMTcgQEAgc3RhdGljIHZvaWQgbnVs
bF9kdW1wX3BjcHUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBpbnQgY3B1KQogICAgICAg
ICAgICBjcHUsCiAgICAgICAgICAgIG5yX2NwdV9pZHMsIGNwdW1hc2tfYml0cyhwZXJfY3B1KGNw
dV9zaWJsaW5nX21hc2ssIGNwdSkpLAogICAgICAgICAgICBucl9jcHVfaWRzLCBjcHVtYXNrX2Jp
dHMocGVyX2NwdShjcHVfY29yZV9tYXNrLCBjcHUpKSk7Ci0gICAgaWYgKCBwZXJfY3B1KG5wYywg
Y3B1KS52Y3B1ICE9IE5VTEwgKQotICAgICAgICBwcmludGsoIiwgdmNwdT0lcHYiLCBwZXJfY3B1
KG5wYywgY3B1KS52Y3B1KTsKKyAgICBpZiAoIHBlcl9jcHUobnBjLCBjcHUpLml0ZW0gIT0gTlVM
TCApCisgICAgICAgIHByaW50aygiLCBpdGVtPSVwZHYlZCIsIHBlcl9jcHUobnBjLCBjcHUpLml0
ZW0tPmRvbWFpbiwKKyAgICAgICAgICAgICAgIHBlcl9jcHUobnBjLCBjcHUpLml0ZW0tPml0ZW1f
aWQpOwogICAgIHByaW50aygiXG4iKTsKIAotICAgIC8qIGN1cnJlbnQgVkNQVSAobm90aGluZyB0
byBzYXkgaWYgdGhhdCdzIHRoZSBpZGxlIHZjcHUpICovCisgICAgLyogY3VycmVudCBpdGVtIChu
b3RoaW5nIHRvIHNheSBpZiB0aGF0J3MgdGhlIGlkbGUgaXRlbSkgKi8KICAgICBudmMgPSBudWxs
X2l0ZW0oY3Vycl9vbl9jcHUoY3B1KSk7Ci0gICAgaWYgKCBudmMgJiYgIWlzX2lkbGVfdmNwdShu
dmMtPnZjcHUpICkKKyAgICBpZiAoIG52YyAmJiAhaXNfaWRsZV9pdGVtKG52Yy0+aXRlbSkgKQog
ICAgIHsKICAgICAgICAgcHJpbnRrKCJcdHJ1bjogIik7Ci0gICAgICAgIGR1bXBfdmNwdShwcnYs
IG52Yyk7CisgICAgICAgIGR1bXBfaXRlbShwcnYsIG52Yyk7CiAgICAgICAgIHByaW50aygiXG4i
KTsKICAgICB9CiAKQEAgLTg1MiwyMyArODQ2LDIzIEBAIHN0YXRpYyB2b2lkIG51bGxfZHVtcChj
b25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMpCiAgICAgbGlzdF9mb3JfZWFjaCggaXRlciwgJnBy
di0+bmRvbSApCiAgICAgewogICAgICAgICBzdHJ1Y3QgbnVsbF9kb20gKm5kb207Ci0gICAgICAg
IHN0cnVjdCB2Y3B1ICp2OworICAgICAgICBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbTsKIAogICAg
ICAgICBuZG9tID0gbGlzdF9lbnRyeShpdGVyLCBzdHJ1Y3QgbnVsbF9kb20sIG5kb21fZWxlbSk7
CiAKICAgICAgICAgcHJpbnRrKCJcdERvbWFpbjogJWRcbiIsIG5kb20tPmRvbS0+ZG9tYWluX2lk
KTsKLSAgICAgICAgZm9yX2VhY2hfdmNwdSggbmRvbS0+ZG9tLCB2ICkKKyAgICAgICAgZm9yX2Vh
Y2hfc2NoZWRfaXRlbSggbmRvbS0+ZG9tLCBpdGVtICkKICAgICAgICAgewotICAgICAgICAgICAg
c3RydWN0IG51bGxfaXRlbSAqIGNvbnN0IG52YyA9IG51bGxfaXRlbSh2LT5zY2hlZF9pdGVtKTsK
KyAgICAgICAgICAgIHN0cnVjdCBudWxsX2l0ZW0gKiBjb25zdCBudmMgPSBudWxsX2l0ZW0oaXRl
bSk7CiAgICAgICAgICAgICBzcGlubG9ja190ICpsb2NrOwogCi0gICAgICAgICAgICBsb2NrID0g
aXRlbV9zY2hlZHVsZV9sb2NrKG52Yy0+dmNwdS0+c2NoZWRfaXRlbSk7CisgICAgICAgICAgICBs
b2NrID0gaXRlbV9zY2hlZHVsZV9sb2NrKGl0ZW0pOwogCiAgICAgICAgICAgICBwcmludGsoIlx0
JTNkOiAiLCArK2xvb3ApOwotICAgICAgICAgICAgZHVtcF92Y3B1KHBydiwgbnZjKTsKKyAgICAg
ICAgICAgIGR1bXBfaXRlbShwcnYsIG52Yyk7CiAgICAgICAgICAgICBwcmludGsoIlxuIik7CiAK
LSAgICAgICAgICAgIGl0ZW1fc2NoZWR1bGVfdW5sb2NrKGxvY2ssIG52Yy0+dmNwdS0+c2NoZWRf
aXRlbSk7CisgICAgICAgICAgICBpdGVtX3NjaGVkdWxlX3VubG9jayhsb2NrLCBpdGVtKTsKICAg
ICAgICAgfQogICAgIH0KIApAQCAtODgzLDcgKzg3Nyw3IEBAIHN0YXRpYyB2b2lkIG51bGxfZHVt
cChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMpCiAgICAgICAgICAgICBwcmludGsoIiwgIik7
CiAgICAgICAgIGlmICggbG9vcCAlIDI0ID09IDAgKQogICAgICAgICAgICAgcHJpbnRrKCJcblx0
Iik7Ci0gICAgICAgIHByaW50aygiJXB2IiwgbnZjLT52Y3B1KTsKKyAgICAgICAgcHJpbnRrKCIl
cGR2JWQiLCBudmMtPml0ZW0tPmRvbWFpbiwgbnZjLT5pdGVtLT5pdGVtX2lkKTsKICAgICB9CiAg
ICAgcHJpbnRrKCJcbiIpOwogICAgIHNwaW5fdW5sb2NrKCZwcnYtPndhaXRxX2xvY2spOwotLSAK
Mi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
WGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0
cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

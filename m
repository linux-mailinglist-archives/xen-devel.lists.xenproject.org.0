Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 44886BFFAD
	for <lists+xen-devel@lfdr.de>; Fri, 27 Sep 2019 09:05:16 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDkH8-0005Wg-Ny; Fri, 27 Sep 2019 07:02:46 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Rbpq=XW=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iDkH7-0005Ut-6U
 for xen-devel@lists.xenproject.org; Fri, 27 Sep 2019 07:02:45 +0000
X-Inumbo-ID: 94ff5ae7-e0f4-11e9-966c-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 94ff5ae7-e0f4-11e9-966c-12813bfff9fa;
 Fri, 27 Sep 2019 07:01:09 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 9E7F6B03C;
 Fri, 27 Sep 2019 07:01:07 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 27 Sep 2019 09:00:47 +0200
Message-Id: <20190927070050.12405-44-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190927070050.12405-1-jgross@suse.com>
References: <20190927070050.12405-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v4 43/46] xen/sched: support differing
 granularity in schedule_cpu_[add/rm]()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2l0aCBjb3JlIHNjaGVkdWxpbmcgYWN0aXZlIHNjaGVkdWxlX2NwdV9bYWRkL3JtXSgpIGhhcyB0
byBjb3BlIHdpdGgKZGlmZmVyZW50IHNjaGVkdWxpbmcgZ3JhbnVsYXJpdHk6IGEgY3B1IG5vdCBp
biBhbnkgY3B1cG9vbCBpcyBzdWJqZWN0CnRvIGdyYW51bGFyaXR5IDEgKGNwdSBzY2hlZHVsaW5n
KSwgd2hpbGUgYSBjcHUgaW4gYSBjcHVwb29sIG1pZ2h0IGJlCmluIGEgc2NoZWR1bGluZyByZXNv
dXJjZSB3aXRoIG1vcmUgdGhhbiBvbmUgY3B1LgoKSGFuZGxlIHRoYXQgYnkgaGF2aW5nIGFycmF5
cyBvZiBvbGQvbmV3IHBkYXRhIGFuZCB2ZGF0YSBhbmQgbG9vcCBvdmVyCnRob3NlIHdoZXJlIGFw
cHJvcHJpYXRlLgoKQWRkaXRpb25hbGx5IHRoZSBzY2hlZHVsaW5nIHJlc291cmNlKHMpIG11c3Qg
ZWl0aGVyIGJlIG1lcmdlZCBvcgpzcGxpdC4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3Mg
PGpncm9zc0BzdXNlLmNvbT4KLS0tCiB4ZW4vY29tbW9uL2NwdXBvb2wuYyAgfCAgMTggKystLQog
eGVuL2NvbW1vbi9zY2hlZHVsZS5jIHwgMjI2ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKystLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDIwNCBpbnNlcnRpb25zKCsp
LCA0MCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL2NwdXBvb2wuYyBiL3hl
bi9jb21tb24vY3B1cG9vbC5jCmluZGV4IDEzZGZmYWFkY2YuLjA0YzNiM2MwNGIgMTAwNjQ0Ci0t
LSBhL3hlbi9jb21tb24vY3B1cG9vbC5jCisrKyBiL3hlbi9jb21tb24vY3B1cG9vbC5jCkBAIC01
MzYsNiArNTM2LDcgQEAgc3RhdGljIHZvaWQgY3B1cG9vbF9jcHVfcmVtb3ZlKHVuc2lnbmVkIGlu
dCBjcHUpCiAgICAgICAgIHJldCA9IGNwdXBvb2xfdW5hc3NpZ25fY3B1X2ZpbmlzaChjcHVwb29s
MCk7CiAgICAgICAgIEJVR19PTihyZXQpOwogICAgIH0KKyAgICBjcHVtYXNrX2NsZWFyX2NwdShj
cHUsICZjcHVwb29sX2ZyZWVfY3B1cyk7CiB9CiAKIC8qCkBAIC01ODUsMjAgKzU4NiwxOSBAQCBz
dGF0aWMgdm9pZCBjcHVwb29sX2NwdV9yZW1vdmVfZm9yY2VkKHVuc2lnbmVkIGludCBjcHUpCiAg
ICAgc3RydWN0IGNwdXBvb2wgKipjOwogICAgIGludCByZXQ7CiAKLSAgICBpZiAoIGNwdW1hc2tf
dGVzdF9jcHUoY3B1LCAmY3B1cG9vbF9mcmVlX2NwdXMpICkKLSAgICAgICAgY3B1bWFza19jbGVh
cl9jcHUoY3B1LCAmY3B1cG9vbF9mcmVlX2NwdXMpOwotICAgIGVsc2UKKyAgICBmb3JfZWFjaF9j
cHVwb29sICggYyApCiAgICAgewotICAgICAgICBmb3JfZWFjaF9jcHVwb29sKGMpCisgICAgICAg
IGlmICggY3B1bWFza190ZXN0X2NwdShjcHUsICgqYyktPmNwdV92YWxpZCkgKQogICAgICAgICB7
Ci0gICAgICAgICAgICBpZiAoIGNwdW1hc2tfdGVzdF9jcHUoY3B1LCAoKmMpLT5jcHVfdmFsaWQp
ICkKLSAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAgICByZXQgPSBjcHVwb29sX3VuYXNzaWdu
X2NwdSgqYywgY3B1KTsKLSAgICAgICAgICAgICAgICBCVUdfT04ocmV0KTsKLSAgICAgICAgICAg
IH0KKyAgICAgICAgICAgIHJldCA9IGNwdXBvb2xfdW5hc3NpZ25fY3B1X3N0YXJ0KCpjLCBjcHUp
OworICAgICAgICAgICAgQlVHX09OKHJldCk7CisgICAgICAgICAgICByZXQgPSBjcHVwb29sX3Vu
YXNzaWduX2NwdV9maW5pc2goKmMpOworICAgICAgICAgICAgQlVHX09OKHJldCk7CiAgICAgICAg
IH0KICAgICB9CiAKKyAgICBjcHVtYXNrX2NsZWFyX2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1
cyk7CisKICAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAgICAgc2NoZWRf
cm1fY3B1KGNwdSk7CiAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CmRp
ZmYgLS1naXQgYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMK
aW5kZXggYmFiMjQxMDRjZC4uODkyMzhmODAxZCAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hl
ZHVsZS5jCisrKyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwpAQCAtNDE2LDI3ICs0MTYsMzAgQEAg
c3RhdGljIHZvaWQgc2NoZWRfdW5pdF9hZGRfdmNwdShzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwg
c3RydWN0IHZjcHUgKnYpCiAgICAgdW5pdC0+cnVuc3RhdGVfY250W3YtPnJ1bnN0YXRlLnN0YXRl
XSsrOwogfQogCi1zdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQgKnNjaGVkX2FsbG9jX3VuaXQoc3Ry
dWN0IHZjcHUgKnYpCitzdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQgKnNjaGVkX2FsbG9jX3VuaXRf
bWVtKHZvaWQpCiB7Ci0gICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsICoqcHJldl91bml0Owot
ICAgIHN0cnVjdCBkb21haW4gKmQgPSB2LT5kb21haW47Ci0gICAgdW5zaWduZWQgaW50IGdyYW4g
PSBjcHVwb29sX2dldF9ncmFudWxhcml0eShkLT5jcHVwb29sKTsKKyAgICBzdHJ1Y3Qgc2NoZWRf
dW5pdCAqdW5pdDsKIAotICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkKLSAgICAg
ICAgaWYgKCB1bml0LT51bml0X2lkIC8gZ3JhbiA9PSB2LT52Y3B1X2lkIC8gZ3JhbiApCi0gICAg
ICAgICAgICBicmVhazsKKyAgICB1bml0ID0geHphbGxvYyhzdHJ1Y3Qgc2NoZWRfdW5pdCk7Cisg
ICAgaWYgKCAhdW5pdCApCisgICAgICAgIHJldHVybiBOVUxMOwogCi0gICAgaWYgKCB1bml0ICkK
KyAgICBpZiAoICF6YWxsb2NfY3B1bWFza192YXIoJnVuaXQtPmNwdV9oYXJkX2FmZmluaXR5KSB8
fAorICAgICAgICAgIXphbGxvY19jcHVtYXNrX3ZhcigmdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHlf
c2F2ZWQpIHx8CisgICAgICAgICAhemFsbG9jX2NwdW1hc2tfdmFyKCZ1bml0LT5jcHVfc29mdF9h
ZmZpbml0eSkgKQogICAgIHsKLSAgICAgICAgc2NoZWRfdW5pdF9hZGRfdmNwdSh1bml0LCB2KTsK
LSAgICAgICAgcmV0dXJuIHVuaXQ7CisgICAgICAgIHNjaGVkX2ZyZWVfdW5pdF9tZW0odW5pdCk7
CisgICAgICAgIHVuaXQgPSBOVUxMOwogICAgIH0KIAotICAgIGlmICggKHVuaXQgPSB4emFsbG9j
KHN0cnVjdCBzY2hlZF91bml0KSkgPT0gTlVMTCApCi0gICAgICAgIHJldHVybiBOVUxMOworICAg
IHJldHVybiB1bml0OworfQorCitzdGF0aWMgdm9pZCBzY2hlZF9kb21haW5faW5zZXJ0X3VuaXQo
c3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsIHN0cnVjdCBkb21haW4gKmQpCit7CisgICAgc3RydWN0
IHNjaGVkX3VuaXQgKipwcmV2X3VuaXQ7CiAKICAgICB1bml0LT5kb21haW4gPSBkOwotICAgIHNj
aGVkX3VuaXRfYWRkX3ZjcHUodW5pdCwgdik7CiAKICAgICBmb3IgKCBwcmV2X3VuaXQgPSAmZC0+
c2NoZWRfdW5pdF9saXN0OyAqcHJldl91bml0OwogICAgICAgICAgIHByZXZfdW5pdCA9ICYoKnBy
ZXZfdW5pdCktPm5leHRfaW5fbGlzdCApCkBAIC00NDYsMTcgKzQ0OSwzMSBAQCBzdGF0aWMgc3Ry
dWN0IHNjaGVkX3VuaXQgKnNjaGVkX2FsbG9jX3VuaXQoc3RydWN0IHZjcHUgKnYpCiAKICAgICB1
bml0LT5uZXh0X2luX2xpc3QgPSAqcHJldl91bml0OwogICAgICpwcmV2X3VuaXQgPSB1bml0Owor
fQogCi0gICAgaWYgKCAhemFsbG9jX2NwdW1hc2tfdmFyKCZ1bml0LT5jcHVfaGFyZF9hZmZpbml0
eSkgfHwKLSAgICAgICAgICF6YWxsb2NfY3B1bWFza192YXIoJnVuaXQtPmNwdV9oYXJkX2FmZmlu
aXR5X3NhdmVkKSB8fAotICAgICAgICAgIXphbGxvY19jcHVtYXNrX3ZhcigmdW5pdC0+Y3B1X3Nv
ZnRfYWZmaW5pdHkpICkKLSAgICAgICAgZ290byBmYWlsOworc3RhdGljIHN0cnVjdCBzY2hlZF91
bml0ICpzY2hlZF9hbGxvY191bml0KHN0cnVjdCB2Y3B1ICp2KQoreworICAgIHN0cnVjdCBzY2hl
ZF91bml0ICp1bml0OworICAgIHN0cnVjdCBkb21haW4gKmQgPSB2LT5kb21haW47CisgICAgdW5z
aWduZWQgaW50IGdyYW4gPSBjcHVwb29sX2dldF9ncmFudWxhcml0eShkLT5jcHVwb29sKTsKIAot
ICAgIHJldHVybiB1bml0OworICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkKKyAg
ICAgICAgaWYgKCB1bml0LT51bml0X2lkIC8gZ3JhbiA9PSB2LT52Y3B1X2lkIC8gZ3JhbiApCisg
ICAgICAgICAgICBicmVhazsKIAotIGZhaWw6Ci0gICAgc2NoZWRfZnJlZV91bml0KHVuaXQsIHYp
OwotICAgIHJldHVybiBOVUxMOworICAgIGlmICggdW5pdCApCisgICAgeworICAgICAgICBzY2hl
ZF91bml0X2FkZF92Y3B1KHVuaXQsIHYpOworICAgICAgICByZXR1cm4gdW5pdDsKKyAgICB9CisK
KyAgICBpZiAoICh1bml0ID0gc2NoZWRfYWxsb2NfdW5pdF9tZW0oKSkgPT0gTlVMTCApCisgICAg
ICAgIHJldHVybiBOVUxMOworCisgICAgc2NoZWRfdW5pdF9hZGRfdmNwdSh1bml0LCB2KTsKKyAg
ICBzY2hlZF9kb21haW5faW5zZXJ0X3VuaXQodW5pdCwgZCk7CisKKyAgICByZXR1cm4gdW5pdDsK
IH0KIAogc3RhdGljIHVuc2lnbmVkIGludCBzY2hlZF9zZWxlY3RfaW5pdGlhbF9jcHUoY29uc3Qg
c3RydWN0IHZjcHUgKnYpCkBAIC0yNDA0LDE4ICsyNDIxLDI4IEBAIHN0YXRpYyB2b2lkIHBvbGxf
dGltZXJfZm4odm9pZCAqZGF0YSkKICAgICAgICAgdmNwdV91bmJsb2NrKHYpOwogfQogCi1zdGF0
aWMgaW50IGNwdV9zY2hlZHVsZV91cCh1bnNpZ25lZCBpbnQgY3B1KQorc3RhdGljIHN0cnVjdCBz
Y2hlZF9yZXNvdXJjZSAqc2NoZWRfYWxsb2NfcmVzKHZvaWQpCiB7CiAgICAgc3RydWN0IHNjaGVk
X3Jlc291cmNlICpzcjsKIAogICAgIHNyID0geHphbGxvYyhzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2Up
OwogICAgIGlmICggc3IgPT0gTlVMTCApCi0gICAgICAgIHJldHVybiAtRU5PTUVNOworICAgICAg
ICByZXR1cm4gTlVMTDsKICAgICBpZiAoICF6YWxsb2NfY3B1bWFza192YXIoJnNyLT5jcHVzKSAp
CiAgICAgewogICAgICAgICB4ZnJlZShzcik7Ci0gICAgICAgIHJldHVybiAtRU5PTUVNOworICAg
ICAgICByZXR1cm4gTlVMTDsKICAgICB9CisgICAgcmV0dXJuIHNyOworfQorCitzdGF0aWMgaW50
IGNwdV9zY2hlZHVsZV91cCh1bnNpZ25lZCBpbnQgY3B1KQoreworICAgIHN0cnVjdCBzY2hlZF9y
ZXNvdXJjZSAqc3I7CisKKyAgICBzciA9IHNjaGVkX2FsbG9jX3JlcygpOworICAgIGlmICggc3Ig
PT0gTlVMTCApCisgICAgICAgIHJldHVybiAtRU5PTUVNOwogCiAgICAgc3ItPm1hc3Rlcl9jcHUg
PSBjcHU7CiAgICAgY3B1bWFza19jb3B5KHNyLT5jcHVzLCBjcHVtYXNrX29mKGNwdSkpOwpAQCAt
MjQ2NSw2ICsyNDkyLDggQEAgc3RhdGljIHZvaWQgc2NoZWRfcmVzX2ZyZWUoc3RydWN0IHJjdV9o
ZWFkICpoZWFkKQogICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3IgPSBjb250YWluZXJfb2Yo
aGVhZCwgc3RydWN0IHNjaGVkX3Jlc291cmNlLCByY3UpOwogCiAgICAgZnJlZV9jcHVtYXNrX3Zh
cihzci0+Y3B1cyk7CisgICAgaWYgKCBzci0+c2NoZWRfdW5pdF9pZGxlICkKKyAgICAgICAgc2No
ZWRfZnJlZV91bml0X21lbShzci0+c2NoZWRfdW5pdF9pZGxlKTsKICAgICB4ZnJlZShzcik7CiB9
CiAKQEAgLTI0ODEsNiArMjUxMCw4IEBAIHN0YXRpYyB2b2lkIGNwdV9zY2hlZHVsZV9kb3duKHVu
c2lnbmVkIGludCBjcHUpCiAgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1LCAmc2NoZWRfcmVzX21h
c2spOwogICAgIHNldF9zY2hlZF9yZXMoY3B1LCBOVUxMKTsKIAorICAgIC8qIEtlZXAgaWRsZSB1
bml0LiAqLworICAgIHNyLT5zY2hlZF91bml0X2lkbGUgPSBOVUxMOwogICAgIGNhbGxfcmN1KCZz
ci0+cmN1LCBzY2hlZF9yZXNfZnJlZSk7CiAKICAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jl
c19yY3Vsb2NrKTsKQEAgLTI1NjAsNiArMjU5MSwzMCBAQCBzdGF0aWMgc3RydWN0IG5vdGlmaWVy
X2Jsb2NrIGNwdV9zY2hlZHVsZV9uZmIgPSB7CiAgICAgLm5vdGlmaWVyX2NhbGwgPSBjcHVfc2No
ZWR1bGVfY2FsbGJhY2sKIH07CiAKK3N0YXRpYyBjb25zdCBjcHVtYXNrX3QgKnNjaGVkX2dldF9v
cHRfY3B1bWFzayhlbnVtIHNjaGVkX2dyYW4gb3B0LAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBjcHUpCit7CisgICAgY29uc3QgY3B1
bWFza190ICptYXNrOworCisgICAgc3dpdGNoICggb3B0ICkKKyAgICB7CisgICAgY2FzZSBTQ0hF
RF9HUkFOX2NwdToKKyAgICAgICAgbWFzayA9IGNwdW1hc2tfb2YoY3B1KTsKKyAgICAgICAgYnJl
YWs7CisgICAgY2FzZSBTQ0hFRF9HUkFOX2NvcmU6CisgICAgICAgIG1hc2sgPSBwZXJfY3B1KGNw
dV9zaWJsaW5nX21hc2ssIGNwdSk7CisgICAgICAgIGJyZWFrOworICAgIGNhc2UgU0NIRURfR1JB
Tl9zb2NrZXQ6CisgICAgICAgIG1hc2sgPSBwZXJfY3B1KGNwdV9jb3JlX21hc2ssIGNwdSk7Cisg
ICAgICAgIGJyZWFrOworICAgIGRlZmF1bHQ6CisgICAgICAgIEFTU0VSVF9VTlJFQUNIQUJMRSgp
OworICAgICAgICByZXR1cm4gTlVMTDsKKyAgICB9CisKKyAgICByZXR1cm4gbWFzazsKK30KKwog
LyogSW5pdGlhbGlzZSB0aGUgZGF0YSBzdHJ1Y3R1cmVzLiAqLwogdm9pZCBfX2luaXQgc2NoZWR1
bGVyX2luaXQodm9pZCkKIHsKQEAgLTI3MTUsNiArMjc3MCw0NiBAQCBpbnQgc2NoZWR1bGVfY3B1
X2FkZCh1bnNpZ25lZCBpbnQgY3B1LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICAgKi8KICAgICBv
bGRfbG9jayA9IHBjcHVfc2NoZWR1bGVfbG9ja19pcnFzYXZlKGNwdSwgJmZsYWdzKTsKIAorICAg
IGlmICggY3B1cG9vbF9nZXRfZ3JhbnVsYXJpdHkoYykgPiAxICkKKyAgICB7CisgICAgICAgIGNv
bnN0IGNwdW1hc2tfdCAqbWFzazsKKyAgICAgICAgdW5zaWduZWQgaW50IGNwdV9pdGVyLCBpZHgg
PSAwOworICAgICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqb2xkX3VuaXQsICptYXN0ZXJfdW5pdDsK
KyAgICAgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcl9vbGQ7CisKKyAgICAgICAgLyoKKyAg
ICAgICAgICogV2UgbmVlZCB0byBtZXJnZSBtdWx0aXBsZSBpZGxlX3ZjcHUgdW5pdHMgYW5kIHNj
aGVkX3Jlc291cmNlIHN0cnVjdHMKKyAgICAgICAgICogaW50byBvbmUuIEFzIHRoZSBmcmVlIGNw
dXMgYWxsIHNoYXJlIHRoZSBzYW1lIGxvY2sgd2UgYXJlIGZpbmUgZG9pbmcKKyAgICAgICAgICog
dGhhdCBub3cuIFRoZSB3b3JzdCB3aGljaCBjb3VsZCBoYXBwZW4gd291bGQgYmUgc29tZW9uZSB3
YWl0aW5nIGZvcgorICAgICAgICAgKiB0aGUgbG9jaywgdGh1cyBkZXJlZmVyZW5jaW5nIHNjaGVk
X3Jlcy0+c2NoZWR1bGVfbG9jay4gVGhpcyBpcyB0aGUKKyAgICAgICAgICogcmVhc29uIHdlIGFy
ZSBmcmVlaW5nIHN0cnVjdCBzY2hlZF9yZXMgdmlhIGNhbGxfcmN1KCkgdG8gYXZvaWQgdGhlCisg
ICAgICAgICAqIGxvY2sgcG9pbnRlciBzdWRkZW5seSBkaXNhcHBlYXJpbmcuCisgICAgICAgICAq
LworICAgICAgICBtYXNrID0gc2NoZWRfZ2V0X29wdF9jcHVtYXNrKGMtPmdyYW4sIGNwdSk7Cisg
ICAgICAgIG1hc3Rlcl91bml0ID0gaWRsZV92Y3B1W2NwdV0tPnNjaGVkX3VuaXQ7CisKKyAgICAg
ICAgZm9yX2VhY2hfY3B1ICggY3B1X2l0ZXIsIG1hc2sgKQorICAgICAgICB7CisgICAgICAgICAg
ICBpZiAoIGlkeCApCisgICAgICAgICAgICAgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1X2l0ZXIs
ICZzY2hlZF9yZXNfbWFzayk7CisKKyAgICAgICAgICAgIHBlcl9jcHUoc2NoZWRfcmVzX2lkeCwg
Y3B1X2l0ZXIpID0gaWR4Kys7CisKKyAgICAgICAgICAgIGlmICggY3B1ID09IGNwdV9pdGVyICkK
KyAgICAgICAgICAgICAgICBjb250aW51ZTsKKworICAgICAgICAgICAgb2xkX3VuaXQgPSBpZGxl
X3ZjcHVbY3B1X2l0ZXJdLT5zY2hlZF91bml0OworICAgICAgICAgICAgc3Jfb2xkID0gZ2V0X3Nj
aGVkX3JlcyhjcHVfaXRlcik7CisgICAgICAgICAgICBraWxsX3RpbWVyKCZzcl9vbGQtPnNfdGlt
ZXIpOworICAgICAgICAgICAgaWRsZV92Y3B1W2NwdV9pdGVyXS0+c2NoZWRfdW5pdCA9IG1hc3Rl
cl91bml0OworICAgICAgICAgICAgbWFzdGVyX3VuaXQtPnJ1bnN0YXRlX2NudFtSVU5TVEFURV9y
dW5uaW5nXSsrOworICAgICAgICAgICAgc2V0X3NjaGVkX3JlcyhjcHVfaXRlciwgc3IpOworICAg
ICAgICAgICAgY3B1bWFza19zZXRfY3B1KGNwdV9pdGVyLCBzci0+Y3B1cyk7CisKKyAgICAgICAg
ICAgIGNhbGxfcmN1KCZzcl9vbGQtPnJjdSwgc2NoZWRfcmVzX2ZyZWUpOworICAgICAgICB9Cisg
ICAgfQorCiAgICAgbmV3X2xvY2sgPSBzY2hlZF9zd2l0Y2hfc2NoZWQobmV3X29wcywgY3B1LCBw
cHJpdiwgdnByaXYpOwogCiAgICAgc3ItPnNjaGVkdWxlciA9IG5ld19vcHM7CkBAIC0yNzUyLDMz
ICsyODQ3LDEwMCBAQCBvdXQ6CiAgKi8KIGludCBzY2hlZHVsZV9jcHVfcm0odW5zaWduZWQgaW50
IGNwdSkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqaWRsZTsKICAgICB2b2lkICpwcHJpdl9vbGQsICp2
cHJpdl9vbGQ7Ci0gICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcjsKKyAgICBzdHJ1Y3Qgc2No
ZWRfcmVzb3VyY2UgKnNyLCAqKnNyX25ldyA9IE5VTEw7CisgICAgc3RydWN0IHNjaGVkX3VuaXQg
KnVuaXQ7CiAgICAgc3RydWN0IHNjaGVkdWxlciAqb2xkX29wczsKICAgICBzcGlubG9ja190ICpv
bGRfbG9jazsKICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOworICAgIGludCBpZHgsIHJldCA9IC1F
Tk9NRU07CisgICAgdW5zaWduZWQgaW50IGNwdV9pdGVyOwogCiAgICAgcmN1X3JlYWRfbG9jaygm
c2NoZWRfcmVzX3JjdWxvY2spOwogCiAgICAgc3IgPSBnZXRfc2NoZWRfcmVzKGNwdSk7CiAgICAg
b2xkX29wcyA9IHNyLT5zY2hlZHVsZXI7CiAKKyAgICBpZiAoIHNyLT5ncmFudWxhcml0eSA+IDEg
KQorICAgIHsKKyAgICAgICAgc3JfbmV3ID0geG1hbGxvY19hcnJheShzdHJ1Y3Qgc2NoZWRfcmVz
b3VyY2UgKiwgc3ItPmdyYW51bGFyaXR5IC0gMSk7CisgICAgICAgIGlmICggIXNyX25ldyApCisg
ICAgICAgICAgICBnb3RvIG91dDsKKyAgICAgICAgZm9yICggaWR4ID0gMDsgaWR4IDwgc3ItPmdy
YW51bGFyaXR5IC0gMTsgaWR4KysgKQorICAgICAgICB7CisgICAgICAgICAgICBzcl9uZXdbaWR4
XSA9IHNjaGVkX2FsbG9jX3JlcygpOworICAgICAgICAgICAgaWYgKCBzcl9uZXdbaWR4XSApCisg
ICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgc3JfbmV3W2lkeF0tPnNjaGVkX3VuaXRfaWRs
ZSA9IHNjaGVkX2FsbG9jX3VuaXRfbWVtKCk7CisgICAgICAgICAgICAgICAgaWYgKCAhc3JfbmV3
W2lkeF0tPnNjaGVkX3VuaXRfaWRsZSApCisgICAgICAgICAgICAgICAgeworICAgICAgICAgICAg
ICAgICAgICBzY2hlZF9yZXNfZnJlZSgmc3JfbmV3W2lkeF0tPnJjdSk7CisgICAgICAgICAgICAg
ICAgICAgIHNyX25ld1tpZHhdID0gTlVMTDsKKyAgICAgICAgICAgICAgICB9CisgICAgICAgICAg
ICB9CisgICAgICAgICAgICBpZiAoICFzcl9uZXdbaWR4XSApCisgICAgICAgICAgICB7CisgICAg
ICAgICAgICAgICAgZm9yICggaWR4LS07IGlkeCA+PSAwOyBpZHgtLSApCisgICAgICAgICAgICAg
ICAgICAgIHNjaGVkX3Jlc19mcmVlKCZzcl9uZXdbaWR4XS0+cmN1KTsKKyAgICAgICAgICAgICAg
ICBnb3RvIG91dDsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIHNyX25ld1tpZHhdLT5jdXJy
ID0gc3JfbmV3W2lkeF0tPnNjaGVkX3VuaXRfaWRsZTsKKyAgICAgICAgICAgIHNyX25ld1tpZHhd
LT5zY2hlZHVsZXIgPSAmc2NoZWRfaWRsZV9vcHM7CisgICAgICAgICAgICBzcl9uZXdbaWR4XS0+
Z3JhbnVsYXJpdHkgPSAxOworCisgICAgICAgICAgICAvKiBXZSB3YW50IHRoZSBsb2NrIG5vdCB0
byBjaGFuZ2Ugd2hlbiByZXBsYWNpbmcgdGhlIHJlc291cmNlLiAqLworICAgICAgICAgICAgc3Jf
bmV3W2lkeF0tPnNjaGVkdWxlX2xvY2sgPSBzci0+c2NoZWR1bGVfbG9jazsKKyAgICAgICAgfQor
ICAgIH0KKworICAgIHJldCA9IDA7CiAgICAgQVNTRVJUKHNyLT5jcHVwb29sICE9IE5VTEwpOwog
ICAgIEFTU0VSVChjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgJmNwdXBvb2xfZnJlZV9jcHVzKSk7CiAg
ICAgQVNTRVJUKCFjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgc3ItPmNwdXBvb2wtPmNwdV92YWxpZCkp
OwogCi0gICAgaWRsZSA9IGlkbGVfdmNwdVtjcHVdOwotCiAgICAgc2NoZWRfZG9fdGlja19zdXNw
ZW5kKG9sZF9vcHMsIGNwdSk7CiAKICAgICAvKiBTZWUgY29tbWVudCBpbiBzY2hlZHVsZV9jcHVf
YWRkKCkgcmVnYXJkaW5nIGxvY2sgc3dpdGNoaW5nLiAqLwogICAgIG9sZF9sb2NrID0gcGNwdV9z
Y2hlZHVsZV9sb2NrX2lycXNhdmUoY3B1LCAmZmxhZ3MpOwogCi0gICAgdnByaXZfb2xkID0gaWRs
ZS0+c2NoZWRfdW5pdC0+cHJpdjsKKyAgICB2cHJpdl9vbGQgPSBpZGxlX3ZjcHVbY3B1XS0+c2No
ZWRfdW5pdC0+cHJpdjsKICAgICBwcHJpdl9vbGQgPSBzci0+c2NoZWRfcHJpdjsKIAotICAgIGlk
bGUtPnNjaGVkX3VuaXQtPnByaXYgPSBOVUxMOworICAgIGlkeCA9IDA7CisgICAgZm9yX2VhY2hf
Y3B1ICggY3B1X2l0ZXIsIHNyLT5jcHVzICkKKyAgICB7CisgICAgICAgIHBlcl9jcHUoc2NoZWRf
cmVzX2lkeCwgY3B1X2l0ZXIpID0gMDsKKyAgICAgICAgaWYgKCBjcHVfaXRlciA9PSBjcHUgKQor
ICAgICAgICB7CisgICAgICAgICAgICBpZGxlX3ZjcHVbY3B1X2l0ZXJdLT5zY2hlZF91bml0LT5w
cml2ID0gTlVMTDsKKyAgICAgICAgfQorICAgICAgICBlbHNlCisgICAgICAgIHsKKyAgICAgICAg
ICAgIC8qIEluaXRpYWxpemUgdW5pdC4gKi8KKyAgICAgICAgICAgIHVuaXQgPSBzcl9uZXdbaWR4
XS0+c2NoZWRfdW5pdF9pZGxlOworICAgICAgICAgICAgdW5pdC0+cmVzID0gc3JfbmV3W2lkeF07
CisgICAgICAgICAgICB1bml0LT5pc19ydW5uaW5nID0gdHJ1ZTsKKyAgICAgICAgICAgIHNjaGVk
X3VuaXRfYWRkX3ZjcHUodW5pdCwgaWRsZV92Y3B1W2NwdV9pdGVyXSk7CisgICAgICAgICAgICBz
Y2hlZF9kb21haW5faW5zZXJ0X3VuaXQodW5pdCwgaWRsZV92Y3B1W2NwdV9pdGVyXS0+ZG9tYWlu
KTsKKworICAgICAgICAgICAgLyogQWRqdXN0IGNwdSBtYXNrcyBvZiByZXNvdXJjZXMgKG9sZCBh
bmQgbmV3KS4gKi8KKyAgICAgICAgICAgIGNwdW1hc2tfY2xlYXJfY3B1KGNwdV9pdGVyLCBzci0+
Y3B1cyk7CisgICAgICAgICAgICBjcHVtYXNrX3NldF9jcHUoY3B1X2l0ZXIsIHNyX25ld1tpZHhd
LT5jcHVzKTsKKworICAgICAgICAgICAgLyogSW5pdCB0aW1lci4gKi8KKyAgICAgICAgICAgIGlu
aXRfdGltZXIoJnNyX25ld1tpZHhdLT5zX3RpbWVyLCBzX3RpbWVyX2ZuLCBOVUxMLCBjcHVfaXRl
cik7CisKKyAgICAgICAgICAgIC8qIExhc3QgcmVzb3VyY2UgaW5pdGlhbGl6YXRpb25zIGFuZCBp
bnNlcnQgcmVzb3VyY2UgcG9pbnRlci4gKi8KKyAgICAgICAgICAgIHNyX25ld1tpZHhdLT5tYXN0
ZXJfY3B1ID0gY3B1X2l0ZXI7CisgICAgICAgICAgICBzZXRfc2NoZWRfcmVzKGNwdV9pdGVyLCBz
cl9uZXdbaWR4XSk7CisKKyAgICAgICAgICAgIC8qIExhc3QgYWN0aW9uOiBzZXQgdGhlIG5ldyBs
b2NrIHBvaW50ZXIuICovCisgICAgICAgICAgICBzbXBfbWIoKTsKKyAgICAgICAgICAgIHNyX25l
d1tpZHhdLT5zY2hlZHVsZV9sb2NrID0gJnNjaGVkX2ZyZWVfY3B1X2xvY2s7CisKKyAgICAgICAg
ICAgIGlkeCsrOworICAgICAgICB9CisgICAgfQogICAgIHNyLT5zY2hlZHVsZXIgPSAmc2NoZWRf
aWRsZV9vcHM7CiAgICAgc3ItPnNjaGVkX3ByaXYgPSBOVUxMOwogCkBAIC0yNzk2LDkgKzI5NTgs
MTEgQEAgaW50IHNjaGVkdWxlX2NwdV9ybSh1bnNpZ25lZCBpbnQgY3B1KQogICAgIHNyLT5ncmFu
dWxhcml0eSA9IDE7CiAgICAgc3ItPmNwdXBvb2wgPSBOVUxMOwogCitvdXQ6CiAgICAgcmN1X3Jl
YWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisgICAgeGZyZWUoc3JfbmV3KTsKIAotICAg
IHJldHVybiAwOworICAgIHJldHVybiByZXQ7CiB9CiAKIHN0cnVjdCBzY2hlZHVsZXIgKnNjaGVk
dWxlcl9nZXRfZGVmYXVsdCh2b2lkKQotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2
ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWls
bWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

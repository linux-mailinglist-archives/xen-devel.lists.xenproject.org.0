Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 8DAA5127BB1
	for <lists+xen-devel@lfdr.de>; Fri, 20 Dec 2019 14:31:29 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iiIKa-0005Wl-2f; Fri, 20 Dec 2019 13:28:36 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=fFWP=2K=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1iiIKY-0005Wa-6I
 for xen-devel@lists.xenproject.org; Fri, 20 Dec 2019 13:28:34 +0000
X-Inumbo-ID: 9e390bb4-232c-11ea-9359-12813bfff9fa
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 9e390bb4-232c-11ea-9359-12813bfff9fa;
 Fri, 20 Dec 2019 13:28:33 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id 92814AC37;
 Fri, 20 Dec 2019 13:28:32 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <20efd995-9346-4b0c-f927-ad1152f6ccfe@suse.com>
Message-ID: <44e660c6-841c-1fe1-ab26-4e2d03b170df@suse.com>
Date: Fri, 20 Dec 2019 14:29:01 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.9.1
MIME-Version: 1.0
In-Reply-To: <20efd995-9346-4b0c-f927-ad1152f6ccfe@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH 1/6] x86/IRQ: move do_IRQ()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>, Wei Liu <wl@xen.org>,
 =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhpcyBpcyB0byBhdm9pZCBmb3J3YXJkIGRlY2xhcmF0aW9ucyBvZiBzdGF0aWMgZnVuY3Rpb25z
LiBCZXlvbmQgdGhlCmFjdHVhbCBjb2RlIG1vdmVtZW50IHRoaXMgZG9lcwotIHU4IC0+IHVpbnQ4
X3QsCi0gY29udmVydCB0byBYZW4gc3R5bGUsCi0gZHJvcCB1bm5lY2Vzc2FyeSBwYXJlbnRoZXNl
cyBhbmQgYWxpa2UsCi0gc3RyaXAgdHJhaWxpbmcgd2hpdGUgc3BhY2UuCgpTaWduZWQtb2ZmLWJ5
OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+CgotLS0gYS94ZW4vYXJjaC94ODYvaXJx
LmMKKysrIGIveGVuL2FyY2gveDg2L2lycS5jCkBAIC00MzcsOSArNDM3LDYgQEAgaW50IF9faW5p
dCBpbml0X2lycV9kYXRhKHZvaWQpCiAgICAgcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyB2b2lkIF9f
ZG9fSVJRX2d1ZXN0KGludCB2ZWN0b3IpOwotc3RhdGljIHZvaWQgZmx1c2hfcmVhZHlfZW9pKHZv
aWQpOwotCiBzdGF0aWMgdm9pZCBhY2tfbm9uZShzdHJ1Y3QgaXJxX2Rlc2MgKmRlc2MpCiB7CiAg
ICAgYWNrX2JhZF9pcnEoZGVzYy0+aXJxKTsKQEAgLTg5NywxNDUgKzg5NCw2IEBAIHZvaWQgYWxs
b2NfZGlyZWN0X2FwaWNfdmVjdG9yKAogICAgIHNwaW5fdW5sb2NrKCZsb2NrKTsKIH0KIAotdm9p
ZCBkb19JUlEoc3RydWN0IGNwdV91c2VyX3JlZ3MgKnJlZ3MpCi17Ci0gICAgc3RydWN0IGlycWFj
dGlvbiAqYWN0aW9uOwotICAgIHVpbnQzMl90ICAgICAgICAgIHRzY19pbjsKLSAgICBzdHJ1Y3Qg
aXJxX2Rlc2MgICpkZXNjOwotICAgIHVuc2lnbmVkIGludCAgICAgIHZlY3RvciA9ICh1OClyZWdz
LT5lbnRyeV92ZWN0b3I7Ci0gICAgaW50ICAgICAgICAgICAgICAgaXJxID0gdGhpc19jcHUodmVj
dG9yX2lycSlbdmVjdG9yXTsKLSAgICBzdHJ1Y3QgY3B1X3VzZXJfcmVncyAqb2xkX3JlZ3MgPSBz
ZXRfaXJxX3JlZ3MocmVncyk7Ci0gICAgCi0gICAgcGVyZmNfaW5jcihpcnFzKTsKLSAgICB0aGlz
X2NwdShpcnFfY291bnQpKys7Ci0gICAgaXJxX2VudGVyKCk7Ci0KLSAgICBpZiAoaXJxIDwgMCkg
ewotICAgICAgICBpZiAoZGlyZWN0X2FwaWNfdmVjdG9yW3ZlY3Rvcl0gIT0gTlVMTCkgewotICAg
ICAgICAgICAgKCpkaXJlY3RfYXBpY192ZWN0b3JbdmVjdG9yXSkocmVncyk7Ci0gICAgICAgIH0g
ZWxzZSB7Ci0gICAgICAgICAgICBjb25zdCBjaGFyICpraW5kID0gIiwgTEFQSUMiOwotCi0gICAg
ICAgICAgICBpZiAoIGFwaWNfaXNyX3JlYWQodmVjdG9yKSApCi0gICAgICAgICAgICAgICAgYWNr
X0FQSUNfaXJxKCk7Ci0gICAgICAgICAgICBlbHNlCi0gICAgICAgICAgICAgICAga2luZCA9ICIi
OwotICAgICAgICAgICAgaWYgKCAhICggdmVjdG9yID49IEZJUlNUX0xFR0FDWV9WRUNUT1IgJiYK
LSAgICAgICAgICAgICAgICAgICAgIHZlY3RvciA8PSBMQVNUX0xFR0FDWV9WRUNUT1IgJiYKLSAg
ICAgICAgICAgICAgICAgICAgIGJvZ3VzXzgyNTlBX2lycSh2ZWN0b3IgLSBGSVJTVF9MRUdBQ1lf
VkVDVE9SKSApICkKLSAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAgICBwcmludGsoIkNQVSV1
OiBObyBpcnEgaGFuZGxlciBmb3IgdmVjdG9yICUwMnggKElSUSAlZCVzKVxuIiwKLSAgICAgICAg
ICAgICAgICAgICAgICAgc21wX3Byb2Nlc3Nvcl9pZCgpLCB2ZWN0b3IsIGlycSwga2luZCk7Ci0g
ICAgICAgICAgICAgICAgZGVzYyA9IGlycV90b19kZXNjKH5pcnEpOwotICAgICAgICAgICAgICAg
IGlmICggfmlycSA8IG5yX2lycXMgJiYgaXJxX2Rlc2NfaW5pdGlhbGl6ZWQoZGVzYykgKQotICAg
ICAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAgICAgICAgc3Bpbl9sb2NrKCZkZXNjLT5sb2Nr
KTsKLSAgICAgICAgICAgICAgICAgICAgcHJpbnRrKCJJUlElZCBhPSUwNGx4WyUwNGx4LCUwNGx4
XSB2PSUwMnhbJTAyeF0gdD0lcyBzPSUwOHhcbiIsCi0gICAgICAgICAgICAgICAgICAgICAgICAg
ICB+aXJxLCAqY3B1bWFza19iaXRzKGRlc2MtPmFmZmluaXR5KSwKLSAgICAgICAgICAgICAgICAg
ICAgICAgICAgICpjcHVtYXNrX2JpdHMoZGVzYy0+YXJjaC5jcHVfbWFzayksCi0gICAgICAgICAg
ICAgICAgICAgICAgICAgICAqY3B1bWFza19iaXRzKGRlc2MtPmFyY2gub2xkX2NwdV9tYXNrKSwK
LSAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2MtPmFyY2gudmVjdG9yLCBkZXNjLT5hcmNo
Lm9sZF92ZWN0b3IsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjLT5oYW5kbGVyLT50
eXBlbmFtZSwgZGVzYy0+c3RhdHVzKTsKLSAgICAgICAgICAgICAgICAgICAgc3Bpbl91bmxvY2so
JmRlc2MtPmxvY2spOwotICAgICAgICAgICAgICAgIH0KLSAgICAgICAgICAgIH0KLSAgICAgICAg
ICAgIFRSQUNFXzFEKFRSQ19IV19JUlFfVU5NQVBQRURfVkVDVE9SLCB2ZWN0b3IpOwotICAgICAg
ICB9Ci0gICAgICAgIGdvdG8gb3V0X25vX3VubG9jazsKLSAgICB9Ci0KLSAgICBkZXNjID0gaXJx
X3RvX2Rlc2MoaXJxKTsKLQotICAgIHNwaW5fbG9jaygmZGVzYy0+bG9jayk7Ci0gICAgZGVzYy0+
aGFuZGxlci0+YWNrKGRlc2MpOwotCi0gICAgaWYgKCBsaWtlbHkoZGVzYy0+c3RhdHVzICYgSVJR
X0dVRVNUKSApCi0gICAgewotICAgICAgICBpZiAoIGlycV9yYXRlbGltaXRfdGltZXIuZnVuY3Rp
b24gJiYgLyogaXJxIHJhdGUgbGltaXRpbmcgZW5hYmxlZD8gKi8KLSAgICAgICAgICAgICB1bmxp
a2VseShkZXNjLT5ybF9jbnQrKyA+PSBpcnFfcmF0ZWxpbWl0X3RocmVzaG9sZCkgKQotICAgICAg
ICB7Ci0gICAgICAgICAgICBzX3RpbWVfdCBub3cgPSBOT1coKTsKLSAgICAgICAgICAgIGlmICgg
bm93IDwgKGRlc2MtPnJsX3F1YW50dW1fc3RhcnQgKyBNSUxMSVNFQ1MoMTApKSApCi0gICAgICAg
ICAgICB7Ci0gICAgICAgICAgICAgICAgZGVzYy0+aGFuZGxlci0+ZGlzYWJsZShkZXNjKTsKLSAg
ICAgICAgICAgICAgICAvKgotICAgICAgICAgICAgICAgICAqIElmIGhhbmRsZXItPmRpc2FibGUg
ZG9lc24ndCBhY3R1YWxseSBtYXNrIHRoZSBpbnRlcnJ1cHQsIGEgCi0gICAgICAgICAgICAgICAg
ICogZGlzYWJsZWQgaXJxIHN0aWxsIGNhbiBmaXJlLiBUaGlzIGNoZWNrIGFsc28gYXZvaWRzIHBv
c3NpYmxlIAotICAgICAgICAgICAgICAgICAqIGRlYWRsb2NrcyBpZiByYXRlbGltaXRfdGltZXJf
Zm4gcnVucyBhdCB0aGUgc2FtZSB0aW1lLgotICAgICAgICAgICAgICAgICAqLwotICAgICAgICAg
ICAgICAgIGlmICggbGlrZWx5KGxpc3RfZW1wdHkoJmRlc2MtPnJsX2xpbmspKSApCi0gICAgICAg
ICAgICAgICAgewotICAgICAgICAgICAgICAgICAgICBzcGluX2xvY2soJmlycV9yYXRlbGltaXRf
bG9jayk7Ci0gICAgICAgICAgICAgICAgICAgIGlmICggbGlzdF9lbXB0eSgmaXJxX3JhdGVsaW1p
dF9saXN0KSApCi0gICAgICAgICAgICAgICAgICAgICAgICBzZXRfdGltZXIoJmlycV9yYXRlbGlt
aXRfdGltZXIsIG5vdyArIE1JTExJU0VDUygxMCkpOwotICAgICAgICAgICAgICAgICAgICBsaXN0
X2FkZCgmZGVzYy0+cmxfbGluaywgJmlycV9yYXRlbGltaXRfbGlzdCk7Ci0gICAgICAgICAgICAg
ICAgICAgIHNwaW5fdW5sb2NrKCZpcnFfcmF0ZWxpbWl0X2xvY2spOwotICAgICAgICAgICAgICAg
IH0KLSAgICAgICAgICAgICAgICBnb3RvIG91dDsKLSAgICAgICAgICAgIH0KLSAgICAgICAgICAg
IGRlc2MtPnJsX2NudCA9IDA7Ci0gICAgICAgICAgICBkZXNjLT5ybF9xdWFudHVtX3N0YXJ0ID0g
bm93OwotICAgICAgICB9Ci0KLSAgICAgICAgdHNjX2luID0gdGJfaW5pdF9kb25lID8gZ2V0X2N5
Y2xlcygpIDogMDsKLSAgICAgICAgX19kb19JUlFfZ3Vlc3QoaXJxKTsKLSAgICAgICAgVFJBQ0Vf
M0QoVFJDX0hXX0lSUV9IQU5ETEVELCBpcnEsIHRzY19pbiwgZ2V0X2N5Y2xlcygpKTsKLSAgICAg
ICAgZ290byBvdXRfbm9fZW5kOwotICAgIH0KLQotICAgIGRlc2MtPnN0YXR1cyAmPSB+SVJRX1JF
UExBWTsKLSAgICBkZXNjLT5zdGF0dXMgfD0gSVJRX1BFTkRJTkc7Ci0KLSAgICAvKgotICAgICAq
IFNpbmNlIHdlIHNldCBQRU5ESU5HLCBpZiBhbm90aGVyIHByb2Nlc3NvciBpcyBoYW5kbGluZyBh
IGRpZmZlcmVudCAKLSAgICAgKiBpbnN0YW5jZSBvZiB0aGlzIHNhbWUgaXJxLCB0aGUgb3RoZXIg
cHJvY2Vzc29yIHdpbGwgdGFrZSBjYXJlIG9mIGl0LgotICAgICAqLwotICAgIGlmICggZGVzYy0+
c3RhdHVzICYgKElSUV9ESVNBQkxFRCB8IElSUV9JTlBST0dSRVNTKSApCi0gICAgICAgIGdvdG8g
b3V0OwotCi0gICAgZGVzYy0+c3RhdHVzIHw9IElSUV9JTlBST0dSRVNTOwotCi0gICAgYWN0aW9u
ID0gZGVzYy0+YWN0aW9uOwotICAgIHdoaWxlICggZGVzYy0+c3RhdHVzICYgSVJRX1BFTkRJTkcg
KQotICAgIHsKLSAgICAgICAgZGVzYy0+c3RhdHVzICY9IH5JUlFfUEVORElORzsKLSAgICAgICAg
c3Bpbl91bmxvY2tfaXJxKCZkZXNjLT5sb2NrKTsKLSAgICAgICAgdHNjX2luID0gdGJfaW5pdF9k
b25lID8gZ2V0X2N5Y2xlcygpIDogMDsKLSAgICAgICAgYWN0aW9uLT5oYW5kbGVyKGlycSwgYWN0
aW9uLT5kZXZfaWQsIHJlZ3MpOwotICAgICAgICBUUkFDRV8zRChUUkNfSFdfSVJRX0hBTkRMRUQs
IGlycSwgdHNjX2luLCBnZXRfY3ljbGVzKCkpOwotICAgICAgICBzcGluX2xvY2tfaXJxKCZkZXNj
LT5sb2NrKTsKLSAgICB9Ci0KLSAgICBkZXNjLT5zdGF0dXMgJj0gfklSUV9JTlBST0dSRVNTOwot
Ci0gb3V0OgotICAgIGlmICggZGVzYy0+aGFuZGxlci0+ZW5kICkKLSAgICB7Ci0gICAgICAgIC8q
Ci0gICAgICAgICAqIElmIGhpZ2hlciBwcmlvcml0eSB2ZWN0b3JzIHN0aWxsIGhhdmUgdGhlaXIg
RU9JcyBwZW5kaW5nLCB3ZSBtYXkKLSAgICAgICAgICogbm90IGlzc3VlIGFuIEVPSSBoZXJlLCBh
cyB0aGlzIHdvdWxkIEVPSSB0aGUgaGlnaGVzdCBwcmlvcml0eSBvbmUuCi0gICAgICAgICAqLwot
ICAgICAgICBpZiAoIGNwdV9oYXNfcGVuZGluZ19hcGljX2VvaSgpICkKLSAgICAgICAgewotICAg
ICAgICAgICAgdGhpc19jcHUoY2hlY2tfZW9pX2RlZmVycmFsKSA9IHRydWU7Ci0gICAgICAgICAg
ICBkZXNjLT5oYW5kbGVyLT5lbmQoZGVzYywgdmVjdG9yKTsKLSAgICAgICAgICAgIHRoaXNfY3B1
KGNoZWNrX2VvaV9kZWZlcnJhbCkgPSBmYWxzZTsKLQotICAgICAgICAgICAgc3Bpbl91bmxvY2so
JmRlc2MtPmxvY2spOwotICAgICAgICAgICAgZmx1c2hfcmVhZHlfZW9pKCk7Ci0gICAgICAgICAg
ICBnb3RvIG91dF9ub191bmxvY2s7Ci0gICAgICAgIH0KLQotICAgICAgICBkZXNjLT5oYW5kbGVy
LT5lbmQoZGVzYywgdmVjdG9yKTsKLSAgICB9Ci0KLSBvdXRfbm9fZW5kOgotICAgIHNwaW5fdW5s
b2NrKCZkZXNjLT5sb2NrKTsKLSBvdXRfbm9fdW5sb2NrOgotICAgIGlycV9leGl0KCk7Ci0gICAg
c2V0X2lycV9yZWdzKG9sZF9yZWdzKTsKLX0KLQogc3RhdGljIHZvaWQgaXJxX3JhdGVsaW1pdF90
aW1lcl9mbih2b2lkICpkYXRhKQogewogICAgIHN0cnVjdCBpcnFfZGVzYyAqZGVzYywgKnRtcDsK
QEAgLTIwMTIsNiArMTg3MCwxNTAgQEAgc3RhdGljIGJvb2wgcGlycV9ndWVzdF9mb3JjZV91bmJp
bmQoc3RydQogICAgIHJldHVybiBib3VuZDsKIH0KIAordm9pZCBkb19JUlEoc3RydWN0IGNwdV91
c2VyX3JlZ3MgKnJlZ3MpCit7CisgICAgc3RydWN0IGlycWFjdGlvbiAqYWN0aW9uOworICAgIHVp
bnQzMl90ICAgICAgICAgIHRzY19pbjsKKyAgICBzdHJ1Y3QgaXJxX2Rlc2MgICpkZXNjOworICAg
IHVuc2lnbmVkIGludCAgICAgIHZlY3RvciA9ICh1aW50OF90KXJlZ3MtPmVudHJ5X3ZlY3RvcjsK
KyAgICBpbnQgICAgICAgICAgICAgICBpcnEgPSB0aGlzX2NwdSh2ZWN0b3JfaXJxKVt2ZWN0b3Jd
OworICAgIHN0cnVjdCBjcHVfdXNlcl9yZWdzICpvbGRfcmVncyA9IHNldF9pcnFfcmVncyhyZWdz
KTsKKworICAgIHBlcmZjX2luY3IoaXJxcyk7CisgICAgdGhpc19jcHUoaXJxX2NvdW50KSsrOwor
ICAgIGlycV9lbnRlcigpOworCisgICAgaWYgKCBpcnEgPCAwICkKKyAgICB7CisgICAgICAgIGlm
ICggZGlyZWN0X2FwaWNfdmVjdG9yW3ZlY3Rvcl0gKQorICAgICAgICAgICAgZGlyZWN0X2FwaWNf
dmVjdG9yW3ZlY3Rvcl0ocmVncyk7CisgICAgICAgIGVsc2UKKyAgICAgICAgeworICAgICAgICAg
ICAgY29uc3QgY2hhciAqa2luZCA9ICIsIExBUElDIjsKKworICAgICAgICAgICAgaWYgKCBhcGlj
X2lzcl9yZWFkKHZlY3RvcikgKQorICAgICAgICAgICAgICAgIGFja19BUElDX2lycSgpOworICAg
ICAgICAgICAgZWxzZQorICAgICAgICAgICAgICAgIGtpbmQgPSAiIjsKKyAgICAgICAgICAgIGlm
ICggISh2ZWN0b3IgPj0gRklSU1RfTEVHQUNZX1ZFQ1RPUiAmJgorICAgICAgICAgICAgICAgICAg
IHZlY3RvciA8PSBMQVNUX0xFR0FDWV9WRUNUT1IgJiYKKyAgICAgICAgICAgICAgICAgICBib2d1
c184MjU5QV9pcnEodmVjdG9yIC0gRklSU1RfTEVHQUNZX1ZFQ1RPUikpICkKKyAgICAgICAgICAg
IHsKKyAgICAgICAgICAgICAgICBwcmludGsoIkNQVSV1OiBObyBpcnEgaGFuZGxlciBmb3IgdmVj
dG9yICUwMnggKElSUSAlZCVzKVxuIiwKKyAgICAgICAgICAgICAgICAgICAgICAgc21wX3Byb2Nl
c3Nvcl9pZCgpLCB2ZWN0b3IsIGlycSwga2luZCk7CisgICAgICAgICAgICAgICAgZGVzYyA9IGly
cV90b19kZXNjKH5pcnEpOworICAgICAgICAgICAgICAgIGlmICggfmlycSA8IG5yX2lycXMgJiYg
aXJxX2Rlc2NfaW5pdGlhbGl6ZWQoZGVzYykgKQorICAgICAgICAgICAgICAgIHsKKyAgICAgICAg
ICAgICAgICAgICAgc3Bpbl9sb2NrKCZkZXNjLT5sb2NrKTsKKyAgICAgICAgICAgICAgICAgICAg
cHJpbnRrKCJJUlElZCBhPSUwNGx4WyUwNGx4LCUwNGx4XSB2PSUwMnhbJTAyeF0gdD0lcyBzPSUw
OHhcbiIsCisgICAgICAgICAgICAgICAgICAgICAgICAgICB+aXJxLCAqY3B1bWFza19iaXRzKGRl
c2MtPmFmZmluaXR5KSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICpjcHVtYXNrX2JpdHMo
ZGVzYy0+YXJjaC5jcHVfbWFzayksCisgICAgICAgICAgICAgICAgICAgICAgICAgICAqY3B1bWFz
a19iaXRzKGRlc2MtPmFyY2gub2xkX2NwdV9tYXNrKSwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGRlc2MtPmFyY2gudmVjdG9yLCBkZXNjLT5hcmNoLm9sZF92ZWN0b3IsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICBkZXNjLT5oYW5kbGVyLT50eXBlbmFtZSwgZGVzYy0+c3RhdHVzKTsK
KyAgICAgICAgICAgICAgICAgICAgc3Bpbl91bmxvY2soJmRlc2MtPmxvY2spOworICAgICAgICAg
ICAgICAgIH0KKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIFRSQUNFXzFEKFRSQ19IV19JUlFf
VU5NQVBQRURfVkVDVE9SLCB2ZWN0b3IpOworICAgICAgICB9CisgICAgICAgIGdvdG8gb3V0X25v
X3VubG9jazsKKyAgICB9CisKKyAgICBkZXNjID0gaXJxX3RvX2Rlc2MoaXJxKTsKKworICAgIHNw
aW5fbG9jaygmZGVzYy0+bG9jayk7CisgICAgZGVzYy0+aGFuZGxlci0+YWNrKGRlc2MpOworCisg
ICAgaWYgKCBsaWtlbHkoZGVzYy0+c3RhdHVzICYgSVJRX0dVRVNUKSApCisgICAgeworICAgICAg
ICBpZiAoIGlycV9yYXRlbGltaXRfdGltZXIuZnVuY3Rpb24gJiYgLyogaXJxIHJhdGUgbGltaXRp
bmcgZW5hYmxlZD8gKi8KKyAgICAgICAgICAgICB1bmxpa2VseShkZXNjLT5ybF9jbnQrKyA+PSBp
cnFfcmF0ZWxpbWl0X3RocmVzaG9sZCkgKQorICAgICAgICB7CisgICAgICAgICAgICBzX3RpbWVf
dCBub3cgPSBOT1coKTsKKworICAgICAgICAgICAgaWYgKCBub3cgPCAoZGVzYy0+cmxfcXVhbnR1
bV9zdGFydCArIE1JTExJU0VDUygxMCkpICkKKyAgICAgICAgICAgIHsKKyAgICAgICAgICAgICAg
ICBkZXNjLT5oYW5kbGVyLT5kaXNhYmxlKGRlc2MpOworICAgICAgICAgICAgICAgIC8qCisgICAg
ICAgICAgICAgICAgICogSWYgaGFuZGxlci0+ZGlzYWJsZSBkb2Vzbid0IGFjdHVhbGx5IG1hc2sg
dGhlIGludGVycnVwdCwgYQorICAgICAgICAgICAgICAgICAqIGRpc2FibGVkIGlycSBzdGlsbCBj
YW4gZmlyZS4gVGhpcyBjaGVjayBhbHNvIGF2b2lkcyBwb3NzaWJsZQorICAgICAgICAgICAgICAg
ICAqIGRlYWRsb2NrcyBpZiByYXRlbGltaXRfdGltZXJfZm4gcnVucyBhdCB0aGUgc2FtZSB0aW1l
LgorICAgICAgICAgICAgICAgICAqLworICAgICAgICAgICAgICAgIGlmICggbGlrZWx5KGxpc3Rf
ZW1wdHkoJmRlc2MtPnJsX2xpbmspKSApCisgICAgICAgICAgICAgICAgeworICAgICAgICAgICAg
ICAgICAgICBzcGluX2xvY2soJmlycV9yYXRlbGltaXRfbG9jayk7CisgICAgICAgICAgICAgICAg
ICAgIGlmICggbGlzdF9lbXB0eSgmaXJxX3JhdGVsaW1pdF9saXN0KSApCisgICAgICAgICAgICAg
ICAgICAgICAgICBzZXRfdGltZXIoJmlycV9yYXRlbGltaXRfdGltZXIsIG5vdyArIE1JTExJU0VD
UygxMCkpOworICAgICAgICAgICAgICAgICAgICBsaXN0X2FkZCgmZGVzYy0+cmxfbGluaywgJmly
cV9yYXRlbGltaXRfbGlzdCk7CisgICAgICAgICAgICAgICAgICAgIHNwaW5fdW5sb2NrKCZpcnFf
cmF0ZWxpbWl0X2xvY2spOworICAgICAgICAgICAgICAgIH0KKyAgICAgICAgICAgICAgICBnb3Rv
IG91dDsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIGRlc2MtPnJsX2NudCA9IDA7CisgICAg
ICAgICAgICBkZXNjLT5ybF9xdWFudHVtX3N0YXJ0ID0gbm93OworICAgICAgICB9CisKKyAgICAg
ICAgdHNjX2luID0gdGJfaW5pdF9kb25lID8gZ2V0X2N5Y2xlcygpIDogMDsKKyAgICAgICAgX19k
b19JUlFfZ3Vlc3QoaXJxKTsKKyAgICAgICAgVFJBQ0VfM0QoVFJDX0hXX0lSUV9IQU5ETEVELCBp
cnEsIHRzY19pbiwgZ2V0X2N5Y2xlcygpKTsKKyAgICAgICAgZ290byBvdXRfbm9fZW5kOworICAg
IH0KKworICAgIGRlc2MtPnN0YXR1cyAmPSB+SVJRX1JFUExBWTsKKyAgICBkZXNjLT5zdGF0dXMg
fD0gSVJRX1BFTkRJTkc7CisKKyAgICAvKgorICAgICAqIFNpbmNlIHdlIHNldCBQRU5ESU5HLCBp
ZiBhbm90aGVyIHByb2Nlc3NvciBpcyBoYW5kbGluZyBhIGRpZmZlcmVudAorICAgICAqIGluc3Rh
bmNlIG9mIHRoaXMgc2FtZSBpcnEsIHRoZSBvdGhlciBwcm9jZXNzb3Igd2lsbCB0YWtlIGNhcmUg
b2YgaXQuCisgICAgICovCisgICAgaWYgKCBkZXNjLT5zdGF0dXMgJiAoSVJRX0RJU0FCTEVEIHwg
SVJRX0lOUFJPR1JFU1MpICkKKyAgICAgICAgZ290byBvdXQ7CisKKyAgICBkZXNjLT5zdGF0dXMg
fD0gSVJRX0lOUFJPR1JFU1M7CisKKyAgICBhY3Rpb24gPSBkZXNjLT5hY3Rpb247CisgICAgd2hp
bGUgKCBkZXNjLT5zdGF0dXMgJiBJUlFfUEVORElORyApCisgICAgeworICAgICAgICBkZXNjLT5z
dGF0dXMgJj0gfklSUV9QRU5ESU5HOworICAgICAgICBzcGluX3VubG9ja19pcnEoJmRlc2MtPmxv
Y2spOworCisgICAgICAgIHRzY19pbiA9IHRiX2luaXRfZG9uZSA/IGdldF9jeWNsZXMoKSA6IDA7
CisgICAgICAgIGFjdGlvbi0+aGFuZGxlcihpcnEsIGFjdGlvbi0+ZGV2X2lkLCByZWdzKTsKKyAg
ICAgICAgVFJBQ0VfM0QoVFJDX0hXX0lSUV9IQU5ETEVELCBpcnEsIHRzY19pbiwgZ2V0X2N5Y2xl
cygpKTsKKworICAgICAgICBzcGluX2xvY2tfaXJxKCZkZXNjLT5sb2NrKTsKKyAgICB9CisKKyAg
ICBkZXNjLT5zdGF0dXMgJj0gfklSUV9JTlBST0dSRVNTOworCisgb3V0OgorICAgIGlmICggZGVz
Yy0+aGFuZGxlci0+ZW5kICkKKyAgICB7CisgICAgICAgIC8qCisgICAgICAgICAqIElmIGhpZ2hl
ciBwcmlvcml0eSB2ZWN0b3JzIHN0aWxsIGhhdmUgdGhlaXIgRU9JcyBwZW5kaW5nLCB3ZSBtYXkK
KyAgICAgICAgICogbm90IGlzc3VlIGFuIEVPSSBoZXJlLCBhcyB0aGlzIHdvdWxkIEVPSSB0aGUg
aGlnaGVzdCBwcmlvcml0eSBvbmUuCisgICAgICAgICAqLworICAgICAgICBpZiAoIGNwdV9oYXNf
cGVuZGluZ19hcGljX2VvaSgpICkKKyAgICAgICAgeworICAgICAgICAgICAgdGhpc19jcHUoY2hl
Y2tfZW9pX2RlZmVycmFsKSA9IHRydWU7CisgICAgICAgICAgICBkZXNjLT5oYW5kbGVyLT5lbmQo
ZGVzYywgdmVjdG9yKTsKKyAgICAgICAgICAgIHRoaXNfY3B1KGNoZWNrX2VvaV9kZWZlcnJhbCkg
PSBmYWxzZTsKKworICAgICAgICAgICAgc3Bpbl91bmxvY2soJmRlc2MtPmxvY2spOworICAgICAg
ICAgICAgZmx1c2hfcmVhZHlfZW9pKCk7CisgICAgICAgICAgICBnb3RvIG91dF9ub191bmxvY2s7
CisgICAgICAgIH0KKworICAgICAgICBkZXNjLT5oYW5kbGVyLT5lbmQoZGVzYywgdmVjdG9yKTsK
KyAgICB9CisKKyBvdXRfbm9fZW5kOgorICAgIHNwaW5fdW5sb2NrKCZkZXNjLT5sb2NrKTsKKyBv
dXRfbm9fdW5sb2NrOgorICAgIGlycV9leGl0KCk7CisgICAgc2V0X2lycV9yZWdzKG9sZF9yZWdz
KTsKK30KKwogc3RhdGljIGlubGluZSBib29sIGlzX2ZyZWVfcGlycShjb25zdCBzdHJ1Y3QgZG9t
YWluICpkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJ1Y3QgcGly
cSAqcGlycSkKIHsKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9y
ZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

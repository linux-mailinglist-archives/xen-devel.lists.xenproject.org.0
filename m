Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 953DD83271
	for <lists+xen-devel@lfdr.de>; Tue,  6 Aug 2019 15:14:00 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1huzF8-0004fU-3J; Tue, 06 Aug 2019 13:11:10 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=jalH=WC=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1huzF6-0004fC-7U
 for xen-devel@lists.xenproject.org; Tue, 06 Aug 2019 13:11:08 +0000
X-Inumbo-ID: a5c77402-b84b-11e9-aa65-834c26242642
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id a5c77402-b84b-11e9-aa65-834c26242642;
 Tue, 06 Aug 2019 13:11:05 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 3E627B636;
 Tue,  6 Aug 2019 13:11:05 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <5a4d4a61-a543-c657-8458-cbc6b5a8a633@suse.com>
Message-ID: <a96066ba-5f8e-b6af-f049-2c8263b0f446@suse.com>
Date: Tue, 6 Aug 2019 15:11:04 +0200
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.8.0
MIME-Version: 1.0
In-Reply-To: <5a4d4a61-a543-c657-8458-cbc6b5a8a633@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v5 09/10] AMD/IOMMU: replace INTREMAP_ENTRIES
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Brian Woods <brian.woods@amd.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Transfer-Encoding: base64
Content-Type: text/plain; charset="utf-8"; Format="flowed"
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

UHJlcGFyZSBmb3IgdGhlIG51bWJlciBvZiBlbnRyaWVzIHRvIG5vdCBiZSB0aGUgbWF4aW11bSBw
b3NzaWJsZSwgYnkKc2VwYXJhdGluZyBjaGVja3MgYWdhaW5zdCBtYXhpbXVtIHNpemUgZnJvbSBv
bmVzIGFnYWluc3QgYWN0dWFsIHNpemUuCkZvciBjYWxsZXIgc2lkZSBzaW1wbGljaXR5IGhhdmUg
YWxsb2NfaW50cmVtYXBfZW50cnkoKSByZXR1cm4gdGhlCm1heGltdW0gcG9zc2libGUgdmFsdWUg
dXBvbiBhbGxvY2F0aW9uIGZhaWx1cmUsIHJhdGhlciB0aGFuIHRoZSBmaXJzdApqdXN0IG91dC1v
Zi1ib3VuZHMgb25lLgoKSGF2ZSB0aGUgaW52b2x2ZWQgZnVuY3Rpb25zIGFscmVhZHkgdGFrZSBh
bGwgdGhlIHN1YnNlcXVlbnRseSBuZWVkZWQKYXJndW1lbnRzIGhlcmUgYWxyZWFkeSwgdG8gcmVk
dWNlIGNvZGUgY2h1cm4gaW4gdGhlIHBhdGNoIGFjdHVhbGx5Cm1ha2luZyB0aGUgYWxsb2NhdGlv
biBzaXplIGR5bmFtaWMuCgpTaWduZWQtb2ZmLWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3Vz
ZS5jb20+Ci0tLQp2NTogTmV3LgoKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lv
bW11X2ludHIuYworKysgYi94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfaW50ci5j
CkBAIC02OSw3ICs2OSw3IEBAIHVuaW9uIGlydGVfY3B0ciB7CiAgICAgIGNvbnN0IHVuaW9uIGly
dGUxMjggKnB0cjEyODsKICB9IF9fdHJhbnNwYXJlbnRfXzsKICAKLSNkZWZpbmUgSU5UUkVNQVBf
RU5UUklFUyAoMSA8PCBJT01NVV9JTlRSRU1BUF9PUkRFUikKKyNkZWZpbmUgSU5UUkVNQVBfTUFY
X0VOVFJJRVMgKDEgPDwgSU9NTVVfSU5UUkVNQVBfT1JERVIpCiAgCiAgc3RydWN0IGlvYXBpY19z
YmRmIGlvYXBpY19zYmRmW01BWF9JT19BUElDU107CiAgc3RydWN0IGhwZXRfc2JkZiBocGV0X3Ni
ZGY7CkBAIC04Myw4ICs4MywyMCBAQCBzdGF0aWMgdm9pZCBkdW1wX2ludHJlbWFwX3RhYmxlcyh1
bnNpZ25lCiAgc3RhdGljIHVuc2lnbmVkIGludCBfX2luaXQgaW50cmVtYXBfdGFibGVfb3JkZXIo
Y29uc3Qgc3RydWN0IGFtZF9pb21tdSAqaW9tbXUpCiAgewogICAgICByZXR1cm4gaW9tbXUtPmN0
cmwuZ2FfZW4KLSAgICAgICAgICAgPyBnZXRfb3JkZXJfZnJvbV9ieXRlcyhJTlRSRU1BUF9FTlRS
SUVTICogc2l6ZW9mKHVuaW9uIGlydGUxMjgpKQotICAgICAgICAgICA6IGdldF9vcmRlcl9mcm9t
X2J5dGVzKElOVFJFTUFQX0VOVFJJRVMgKiBzaXplb2YodW5pb24gaXJ0ZTMyKSk7CisgICAgICAg
ICAgID8gZ2V0X29yZGVyX2Zyb21fYnl0ZXMoSU5UUkVNQVBfTUFYX0VOVFJJRVMgKiBzaXplb2Yo
dW5pb24gaXJ0ZTEyOCkpCisgICAgICAgICAgIDogZ2V0X29yZGVyX2Zyb21fYnl0ZXMoSU5UUkVN
QVBfTUFYX0VOVFJJRVMgKiBzaXplb2YodW5pb24gaXJ0ZTMyKSk7Cit9CisKK3Vuc2lnbmVkIGlu
dCBhbWRfaW9tbXVfaW50cmVtYXBfdGFibGVfb3JkZXIoCisgICAgY29uc3Qgdm9pZCAqaXJ0LCBj
b25zdCBzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSkKK3sKKyAgICByZXR1cm4gSU9NTVVfSU5UUkVN
QVBfT1JERVI7Cit9CisKK3N0YXRpYyB1bnNpZ25lZCBpbnQgaW50cmVtYXBfdGFibGVfZW50cmll
cygKKyAgICBjb25zdCB2b2lkICppcnQsIGNvbnN0IHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11KQor
eworICAgIHJldHVybiAxdSA8PCBhbWRfaW9tbXVfaW50cmVtYXBfdGFibGVfb3JkZXIoaXJ0LCBp
b21tdSk7CiAgfQogIAogIHVuc2lnbmVkIGludCBpb2FwaWNfaWRfdG9faW5kZXgodW5zaWduZWQg
aW50IGFwaWNfaWQpCkBAIC0xMjIsMjAgKzEzNCwyNCBAQCBzdGF0aWMgaW50IGdldF9pbnRyZW1h
cF9yZXF1ZXN0b3JfaWQoaW50CiAgICAgIHJldHVybiBnZXRfaXZyc19tYXBwaW5ncyhzZWcpW2Jk
Zl0uZHRlX3JlcXVlc3Rvcl9pZDsKICB9CiAgCi1zdGF0aWMgdW5zaWduZWQgaW50IGFsbG9jX2lu
dHJlbWFwX2VudHJ5KGludCBzZWcsIGludCBiZGYsIHVuc2lnbmVkIGludCBucikKK3N0YXRpYyB1
bnNpZ25lZCBpbnQgYWxsb2NfaW50cmVtYXBfZW50cnkoY29uc3Qgc3RydWN0IGFtZF9pb21tdSAq
aW9tbXUsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVk
IGludCBiZGYsIHVuc2lnbmVkIGludCBucikKICB7Ci0gICAgdW5zaWduZWQgbG9uZyAqaW51c2Ug
PSBnZXRfaXZyc19tYXBwaW5ncyhzZWcpW2JkZl0uaW50cmVtYXBfaW51c2U7Ci0gICAgdW5zaWdu
ZWQgaW50IHNsb3QgPSBmaW5kX2ZpcnN0X3plcm9fYml0KGludXNlLCBJTlRSRU1BUF9FTlRSSUVT
KTsKKyAgICBjb25zdCBzdHJ1Y3QgaXZyc19tYXBwaW5ncyAqaXZyc19tYXBwaW5ncyA9IGdldF9p
dnJzX21hcHBpbmdzKGlvbW11LT5zZWcpOworICAgIHVuc2lnbmVkIGxvbmcgKmludXNlID0gaXZy
c19tYXBwaW5nc1tiZGZdLmludHJlbWFwX2ludXNlOworICAgIHVuc2lnbmVkIGludCBucl9lbnRz
ID0KKyAgICAgICAgaW50cmVtYXBfdGFibGVfZW50cmllcyhpdnJzX21hcHBpbmdzW2JkZl0uaW50
cmVtYXBfdGFibGUsIGlvbW11KTsKKyAgICB1bnNpZ25lZCBpbnQgc2xvdCA9IGZpbmRfZmlyc3Rf
emVyb19iaXQoaW51c2UsIG5yX2VudHMpOwogIAogICAgICBmb3IgKCA7IDsgKQogICAgICB7CiAg
ICAgICAgICB1bnNpZ25lZCBpbnQgZW5kOwogIAotICAgICAgICBpZiAoIHNsb3QgPj0gSU5UUkVN
QVBfRU5UUklFUyApCisgICAgICAgIGlmICggc2xvdCA+PSBucl9lbnRzICkKICAgICAgICAgICAg
ICBicmVhazsKLSAgICAgICAgZW5kID0gZmluZF9uZXh0X2JpdChpbnVzZSwgSU5UUkVNQVBfRU5U
UklFUywgc2xvdCArIDEpOwotICAgICAgICBpZiAoIGVuZCA+IElOVFJFTUFQX0VOVFJJRVMgKQot
ICAgICAgICAgICAgZW5kID0gSU5UUkVNQVBfRU5UUklFUzsKKyAgICAgICAgZW5kID0gZmluZF9u
ZXh0X2JpdChpbnVzZSwgbnJfZW50cywgc2xvdCArIDEpOworICAgICAgICBpZiAoIGVuZCA+IG5y
X2VudHMgKQorICAgICAgICAgICAgZW5kID0gbnJfZW50czsKICAgICAgICAgIHNsb3QgPSAoc2xv
dCArIG5yIC0gMSkgJiB+KG5yIC0gMSk7CiAgICAgICAgICBpZiAoIHNsb3QgKyBuciA8PSBlbmQg
KQogICAgICAgICAgewpAQCAtMTQ0LDEyICsxNjAsMTIgQEAgc3RhdGljIHVuc2lnbmVkIGludCBh
bGxvY19pbnRyZW1hcF9lbnRyeQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAg
ICAgICAgc2xvdCA9IChlbmQgKyBucikgJiB+KG5yIC0gMSk7Ci0gICAgICAgIGlmICggc2xvdCA+
PSBJTlRSRU1BUF9FTlRSSUVTICkKKyAgICAgICAgaWYgKCBzbG90ID49IG5yX2VudHMgKQogICAg
ICAgICAgICAgIGJyZWFrOwotICAgICAgICBzbG90ID0gZmluZF9uZXh0X3plcm9fYml0KGludXNl
LCBJTlRSRU1BUF9FTlRSSUVTLCBzbG90KTsKKyAgICAgICAgc2xvdCA9IGZpbmRfbmV4dF96ZXJv
X2JpdChpbnVzZSwgbnJfZW50cywgc2xvdCk7CiAgICAgIH0KICAKLSAgICByZXR1cm4gc2xvdDsK
KyAgICByZXR1cm4gc2xvdCA8IG5yX2VudHMgPyBzbG90IDogSU5UUkVNQVBfTUFYX0VOVFJJRVM7
CiAgfQogIAogIHN0YXRpYyB1bmlvbiBpcnRlX3B0ciBnZXRfaW50cmVtYXBfZW50cnkoY29uc3Qg
c3RydWN0IGFtZF9pb21tdSAqaW9tbXUsCkBAIC0xNTksNyArMTc1LDcgQEAgc3RhdGljIHVuaW9u
IGlydGVfcHRyIGdldF9pbnRyZW1hcF9lbnRyeQogICAgICAgICAgLnB0ciA9IGdldF9pdnJzX21h
cHBpbmdzKGlvbW11LT5zZWcpW2JkZl0uaW50cmVtYXBfdGFibGUKICAgICAgfTsKICAKLSAgICBB
U1NFUlQodGFibGUucHRyICYmIChpbmRleCA8IElOVFJFTUFQX0VOVFJJRVMpKTsKKyAgICBBU1NF
UlQodGFibGUucHRyICYmIChpbmRleCA8IGludHJlbWFwX3RhYmxlX2VudHJpZXModGFibGUucHRy
LCBpb21tdSkpKTsKICAKICAgICAgaWYgKCBpb21tdS0+Y3RybC5nYV9lbiApCiAgICAgICAgICB0
YWJsZS5wdHIxMjggKz0gaW5kZXg7CkBAIC0yNzksMTAgKzI5NSwxMCBAQCBzdGF0aWMgaW50IHVw
ZGF0ZV9pbnRyZW1hcF9lbnRyeV9mcm9tX2lvCiAgICAgIHNwaW5fbG9ja19pcnFzYXZlKGxvY2ss
IGZsYWdzKTsKICAKICAgICAgb2Zmc2V0ID0gKmluZGV4OwotICAgIGlmICggb2Zmc2V0ID49IElO
VFJFTUFQX0VOVFJJRVMgKQorICAgIGlmICggb2Zmc2V0ID49IElOVFJFTUFQX01BWF9FTlRSSUVT
ICkKICAgICAgewotICAgICAgICBvZmZzZXQgPSBhbGxvY19pbnRyZW1hcF9lbnRyeShpb21tdS0+
c2VnLCByZXFfaWQsIDEpOwotICAgICAgICBpZiAoIG9mZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVT
ICkKKyAgICAgICAgb2Zmc2V0ID0gYWxsb2NfaW50cmVtYXBfZW50cnkoaW9tbXUsIHJlcV9pZCwg
MSk7CisgICAgICAgIGlmICggb2Zmc2V0ID49IElOVFJFTUFQX01BWF9FTlRSSUVTICkKICAgICAg
ICAgIHsKICAgICAgICAgICAgICBzcGluX3VubG9ja19pcnFyZXN0b3JlKGxvY2ssIGZsYWdzKTsK
ICAgICAgICAgICAgICBydGUtPm1hc2sgPSAxOwpAQCAtNDAwLDggKzQxNiw4IEBAIGludCBfX2lu
aXQgYW1kX2lvbW11X3NldHVwX2lvYXBpY19yZW1hcHAKICAgICAgICAgICAgICB9CiAgCiAgICAg
ICAgICAgICAgc3Bpbl9sb2NrX2lycXNhdmUobG9jaywgZmxhZ3MpOwotICAgICAgICAgICAgb2Zm
c2V0ID0gYWxsb2NfaW50cmVtYXBfZW50cnkoc2VnLCByZXFfaWQsIDEpOwotICAgICAgICAgICAg
QlVHX09OKG9mZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVTKTsKKyAgICAgICAgICAgIG9mZnNldCA9
IGFsbG9jX2ludHJlbWFwX2VudHJ5KGlvbW11LCByZXFfaWQsIDEpOworICAgICAgICAgICAgQlVH
X09OKG9mZnNldCA+PSBJTlRSRU1BUF9NQVhfRU5UUklFUyk7CiAgICAgICAgICAgICAgZW50cnkg
PSBnZXRfaW50cmVtYXBfZW50cnkoaW9tbXUsIHJlcV9pZCwgb2Zmc2V0KTsKICAgICAgICAgICAg
ICB1cGRhdGVfaW50cmVtYXBfZW50cnkoaW9tbXUsIGVudHJ5LCB2ZWN0b3IsCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGl2ZXJ5X21vZGUsIGRlc3RfbW9kZSwgZGVzdCk7
CkBAIC00NzYsNyArNDkyLDcgQEAgdm9pZCBhbWRfaW9tbXVfaW9hcGljX3VwZGF0ZV9pcmUoCiAg
ICAgICAgICAqKCgodTMyICopJm5ld19ydGUpICsgMSkgPSB2YWx1ZTsKICAgICAgfQogIAotICAg
IGlmICggaW9hcGljX3NiZGZbaWR4XS5waW5fMl9pZHhbcGluXSA+PSBJTlRSRU1BUF9FTlRSSUVT
ICkKKyAgICBpZiAoIGlvYXBpY19zYmRmW2lkeF0ucGluXzJfaWR4W3Bpbl0gPj0gSU5UUkVNQVBf
TUFYX0VOVFJJRVMgKQogICAgICB7CiAgICAgICAgICBBU1NFUlQoc2F2ZWRfbWFzayk7CiAgCkBA
IC01NDgsNyArNTY0LDcgQEAgdW5zaWduZWQgaW50IGFtZF9pb21tdV9yZWFkX2lvYXBpY19mcm9t
XwogICAgICAgICAgcmV0dXJuIHZhbDsKICAKICAgICAgb2Zmc2V0ID0gaW9hcGljX3NiZGZbaWR4
XS5waW5fMl9pZHhbcGluXTsKLSAgICBpZiAoIG9mZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVTICkK
KyAgICBpZiAoIG9mZnNldCA+PSBJTlRSRU1BUF9NQVhfRU5UUklFUyApCiAgICAgICAgICByZXR1
cm4gdmFsOwogIAogICAgICBzZWcgPSBpb2FwaWNfc2JkZltpZHhdLnNlZzsKQEAgLTU2MSw4ICs1
NzcsOCBAQCB1bnNpZ25lZCBpbnQgYW1kX2lvbW11X3JlYWRfaW9hcGljX2Zyb21fCiAgCiAgICAg
IGlmICggIShyZWcgJiAxKSApCiAgICAgIHsKLSAgICAgICAgQVNTRVJUKG9mZnNldCA9PSAodmFs
ICYgKElOVFJFTUFQX0VOVFJJRVMgLSAxKSkpOwotICAgICAgICB2YWwgJj0gfihJTlRSRU1BUF9F
TlRSSUVTIC0gMSk7CisgICAgICAgIEFTU0VSVChvZmZzZXQgPT0gKHZhbCAmIChJTlRSRU1BUF9N
QVhfRU5UUklFUyAtIDEpKSk7CisgICAgICAgIHZhbCAmPSB+KElOVFJFTUFQX01BWF9FTlRSSUVT
IC0gMSk7CiAgICAgICAgICAvKiBUaGUgSW50VHlwZSBmaWVsZHMgbWF0Y2ggZm9yIGJvdGggZm9y
bWF0cy4gKi8KICAgICAgICAgIHZhbCB8PSBNQVNLX0lOU1IoZW50cnkucHRyMzItPmZsZHMuaW50
X3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIElPX0FQSUNfUkVESVJfREVMSVZfTU9E
RV9NQVNLKTsKQEAgLTYyMiwxMSArNjM4LDExIEBAIHN0YXRpYyBpbnQgdXBkYXRlX2ludHJlbWFw
X2VudHJ5X2Zyb21fbXMKICAgICAgICAgIGRlc3QgPSBNQVNLX0VYVFIobXNnLT5hZGRyZXNzX2xv
LCBNU0lfQUREUl9ERVNUX0lEX01BU0spOwogIAogICAgICBvZmZzZXQgPSAqcmVtYXBfaW5kZXg7
Ci0gICAgaWYgKCBvZmZzZXQgPj0gSU5UUkVNQVBfRU5UUklFUyApCisgICAgaWYgKCBvZmZzZXQg
Pj0gSU5UUkVNQVBfTUFYX0VOVFJJRVMgKQogICAgICB7CiAgICAgICAgICBBU1NFUlQobnIpOwot
ICAgICAgICBvZmZzZXQgPSBhbGxvY19pbnRyZW1hcF9lbnRyeShpb21tdS0+c2VnLCBiZGYsIG5y
KTsKLSAgICAgICAgaWYgKCBvZmZzZXQgPj0gSU5UUkVNQVBfRU5UUklFUyApCisgICAgICAgIG9m
ZnNldCA9IGFsbG9jX2ludHJlbWFwX2VudHJ5KGlvbW11LCBiZGYsIG5yKTsKKyAgICAgICAgaWYg
KCBvZmZzZXQgPj0gSU5UUkVNQVBfTUFYX0VOVFJJRVMgKQogICAgICAgICAgewogICAgICAgICAg
ICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MpOwogICAgICAgICAgICAgIHJl
dHVybiAtRU5PU1BDOwpAQCAtNjU0LDcgKzY3MCw3IEBAIHN0YXRpYyBpbnQgdXBkYXRlX2ludHJl
bWFwX2VudHJ5X2Zyb21fbXMKICAgICAgdXBkYXRlX2ludHJlbWFwX2VudHJ5KGlvbW11LCBlbnRy
eSwgdmVjdG9yLCBkZWxpdmVyeV9tb2RlLCBkZXN0X21vZGUsIGRlc3QpOwogICAgICBzcGluX3Vu
bG9ja19pcnFyZXN0b3JlKGxvY2ssIGZsYWdzKTsKICAKLSAgICAqZGF0YSA9IChtc2ctPmRhdGEg
JiB+KElOVFJFTUFQX0VOVFJJRVMgLSAxKSkgfCBvZmZzZXQ7CisgICAgKmRhdGEgPSAobXNnLT5k
YXRhICYgfihJTlRSRU1BUF9NQVhfRU5UUklFUyAtIDEpKSB8IG9mZnNldDsKICAKICAgICAgLyoK
ICAgICAgICogSW4gc29tZSBzcGVjaWFsIGNhc2VzLCBhIHBjaS1lIGRldmljZShlLmcgU0FUQSBj
b250cm9sbGVyIGluIElERSBtb2RlKQpAQCAtNzM4LDcgKzc1NCw3IEBAIGludCBhbWRfaW9tbXVf
bXNpX21zZ191cGRhdGVfaXJlKAogIHZvaWQgYW1kX2lvbW11X3JlYWRfbXNpX2Zyb21faXJlKAog
ICAgICBzdHJ1Y3QgbXNpX2Rlc2MgKm1zaV9kZXNjLCBzdHJ1Y3QgbXNpX21zZyAqbXNnKQogIHsK
LSAgICB1bnNpZ25lZCBpbnQgb2Zmc2V0ID0gbXNnLT5kYXRhICYgKElOVFJFTUFQX0VOVFJJRVMg
LSAxKTsKKyAgICB1bnNpZ25lZCBpbnQgb2Zmc2V0ID0gbXNnLT5kYXRhICYgKElOVFJFTUFQX01B
WF9FTlRSSUVTIC0gMSk7CiAgICAgIGNvbnN0IHN0cnVjdCBwY2lfZGV2ICpwZGV2ID0gbXNpX2Rl
c2MtPmRldjsKICAgICAgdTE2IGJkZiA9IHBkZXYgPyBQQ0lfQkRGMihwZGV2LT5idXMsIHBkZXYt
PmRldmZuKSA6IGhwZXRfc2JkZi5iZGY7CiAgICAgIHUxNiBzZWcgPSBwZGV2ID8gcGRldi0+c2Vn
IDogaHBldF9zYmRmLnNlZzsKQEAgLTc1OCw3ICs3NzQsNyBAQCB2b2lkIGFtZF9pb21tdV9yZWFk
X21zaV9mcm9tX2lyZSgKICAgICAgICAgIG9mZnNldCB8PSBucjsKICAgICAgfQogIAotICAgIG1z
Zy0+ZGF0YSAmPSB+KElOVFJFTUFQX0VOVFJJRVMgLSAxKTsKKyAgICBtc2ctPmRhdGEgJj0gfihJ
TlRSRU1BUF9NQVhfRU5UUklFUyAtIDEpOwogICAgICAvKiBUaGUgSW50VHlwZSBmaWVsZHMgbWF0
Y2ggZm9yIGJvdGggZm9ybWF0cy4gKi8KICAgICAgbXNnLT5kYXRhIHw9IE1BU0tfSU5TUihlbnRy
eS5wdHIzMi0+Zmxkcy5pbnRfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNU0lf
REFUQV9ERUxJVkVSWV9NT0RFX01BU0spOwpAQCAtODI0LDggKzg0MCw5IEBAIHZvaWQgKmFtZF9p
b21tdV9hbGxvY19pbnRyZW1hcF90YWJsZSgKICAKICAgICAgaWYgKCB0YiApCiAgICAgIHsKLSAg
ICAgICAgKmludXNlX21hcCA9IHh6YWxsb2NfYXJyYXkodW5zaWduZWQgbG9uZywKLSAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgQklUU19UT19MT05HUyhJTlRSRU1BUF9FTlRSSUVT
KSk7CisgICAgICAgIHVuc2lnbmVkIGludCBuciA9IGludHJlbWFwX3RhYmxlX2VudHJpZXModGIs
IGlvbW11KTsKKworICAgICAgICAqaW51c2VfbWFwID0geHphbGxvY19hcnJheSh1bnNpZ25lZCBs
b25nLCBCSVRTX1RPX0xPTkdTKG5yKSk7CiAgICAgICAgICBpZiAoICppbnVzZV9tYXAgKQogICAg
ICAgICAgICAgIG1lbXNldCh0YiwgMCwgUEFHRV9TSVpFIDw8IG9yZGVyKTsKICAgICAgICAgIGVs
c2UKQEAgLTg2OSw2ICs4ODYsNyBAQCBib29sIF9faW5pdCBpb3Zfc3VwcG9ydHNfeHQodm9pZCkK
ICAKICBpbnQgX19pbml0IGFtZF9zZXR1cF9ocGV0X21zaShzdHJ1Y3QgbXNpX2Rlc2MgKm1zaV9k
ZXNjKQogIHsKKyAgICBjb25zdCBzdHJ1Y3QgYW1kX2lvbW11ICppb21tdTsKICAgICAgc3Bpbmxv
Y2tfdCAqbG9jazsKICAgICAgdW5zaWduZWQgbG9uZyBmbGFnczsKICAgICAgaW50IHJjID0gMDsK
QEAgLTg4NiwxMiArOTA0LDE1IEBAIGludCBfX2luaXQgYW1kX3NldHVwX2hwZXRfbXNpKHN0cnVj
dCBtc2kKICAgICAgICAgIHJldHVybiAtRU5PREVWOwogICAgICB9CiAgCisgICAgaW9tbXUgPSBm
aW5kX2lvbW11X2Zvcl9kZXZpY2UoaHBldF9zYmRmLnNlZywgaHBldF9zYmRmLmJkZik7CisgICAg
aWYgKCAhaW9tbXUgKQorICAgICAgICByZXR1cm4gLUVOWElPOworCiAgICAgIGxvY2sgPSBnZXRf
aW50cmVtYXBfbG9jayhocGV0X3NiZGYuc2VnLCBocGV0X3NiZGYuYmRmKTsKICAgICAgc3Bpbl9s
b2NrX2lycXNhdmUobG9jaywgZmxhZ3MpOwogIAotICAgIG1zaV9kZXNjLT5yZW1hcF9pbmRleCA9
IGFsbG9jX2ludHJlbWFwX2VudHJ5KGhwZXRfc2JkZi5zZWcsCi0gICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHBldF9zYmRmLmJkZiwgMSk7Ci0gICAgaWYg
KCBtc2lfZGVzYy0+cmVtYXBfaW5kZXggPj0gSU5UUkVNQVBfRU5UUklFUyApCisgICAgbXNpX2Rl
c2MtPnJlbWFwX2luZGV4ID0gYWxsb2NfaW50cmVtYXBfZW50cnkoaW9tbXUsIGhwZXRfc2JkZi5i
ZGYsIDEpOworICAgIGlmICggbXNpX2Rlc2MtPnJlbWFwX2luZGV4ID49IElOVFJFTUFQX01BWF9F
TlRSSUVTICkKICAgICAgewogICAgICAgICAgbXNpX2Rlc2MtPnJlbWFwX2luZGV4ID0gLTE7CiAg
ICAgICAgICByYyA9IC1FTlhJTzsKQEAgLTkwNiwxMiArOTI3LDEyIEBAIHN0YXRpYyB2b2lkIGR1
bXBfaW50cmVtYXBfdGFibGUoY29uc3Qgc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHVuaW9uIGlydGVfY3B0ciB0YmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBjb25zdCBzdHJ1Y3QgaXZyc19tYXBwaW5ncyAqaXZyc19tYXBwaW5nKQogIHsKLSAgICB1bnNp
Z25lZCBpbnQgY291bnQ7CisgICAgdW5zaWduZWQgaW50IGNvdW50LCBuciA9IGludHJlbWFwX3Rh
YmxlX2VudHJpZXModGJsLnB0ciwgaW9tbXUpOwogIAogICAgICBpZiAoICF0YmwucHRyICkKICAg
ICAgICAgIHJldHVybjsKICAKLSAgICBmb3IgKCBjb3VudCA9IDA7IGNvdW50IDwgSU5UUkVNQVBf
RU5UUklFUzsgY291bnQrKyApCisgICAgZm9yICggY291bnQgPSAwOyBjb3VudCA8IG5yOyBjb3Vu
dCsrICkKICAgICAgewogICAgICAgICAgaWYgKCBpb21tdS0+Y3RybC5nYV9lbgogICAgICAgICAg
ICAgICA/ICF0YmwucHRyMTI4W2NvdW50XS5yYXdbMF0gJiYgIXRibC5wdHIxMjhbY291bnRdLnJh
d1sxXQotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9zdm0vYW1kLWlvbW11LXByb3RvLmgK
KysrIGIveGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vc3ZtL2FtZC1pb21tdS1wcm90by5oCkBAIC0x
MDIsNiArMTAyLDggQEAgdm9pZCAqYW1kX2lvbW11X2FsbG9jX2ludHJlbWFwX3RhYmxlKAogICAg
ICBjb25zdCBzdHJ1Y3QgYW1kX2lvbW11ICosIHVuc2lnbmVkIGxvbmcgKiopOwogIGludCBhbWRf
aW9tbXVfZnJlZV9pbnRyZW1hcF90YWJsZSgKICAgICAgY29uc3Qgc3RydWN0IGFtZF9pb21tdSAq
LCBzdHJ1Y3QgaXZyc19tYXBwaW5ncyAqLCB1aW50MTZfdCk7Cit1bnNpZ25lZCBpbnQgYW1kX2lv
bW11X2ludHJlbWFwX3RhYmxlX29yZGVyKAorICAgIGNvbnN0IHZvaWQgKmlydCwgY29uc3Qgc3Ry
dWN0IGFtZF9pb21tdSAqaW9tbXUpOwogIHZvaWQgYW1kX2lvbW11X2lvYXBpY191cGRhdGVfaXJl
KAogICAgICB1bnNpZ25lZCBpbnQgYXBpYywgdW5zaWduZWQgaW50IHJlZywgdW5zaWduZWQgaW50
IHZhbHVlKTsKICB1bnNpZ25lZCBpbnQgYW1kX2lvbW11X3JlYWRfaW9hcGljX2Zyb21faXJlKAoK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZl
bCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlz
dHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

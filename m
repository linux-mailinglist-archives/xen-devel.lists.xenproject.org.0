Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 4382C2102B
	for <lists+xen-devel@lfdr.de>; Thu, 16 May 2019 23:41:01 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hRO4l-0000Df-Qa; Thu, 16 May 2019 21:38:07 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=ykOh=TQ=gmail.com=tamas.k.lengyel@srs-us1.protection.inumbo.net>)
 id 1hRO4j-0000Da-TR
 for xen-devel@lists.xenproject.org; Thu, 16 May 2019 21:38:05 +0000
X-Inumbo-ID: e2ddeed2-7822-11e9-8980-bc764e045a96
Received: from mail-it1-f194.google.com (unknown [209.85.166.194])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id e2ddeed2-7822-11e9-8980-bc764e045a96;
 Thu, 16 May 2019 21:38:04 +0000 (UTC)
Received: by mail-it1-f194.google.com with SMTP id m3so4879143itl.1
 for <xen-devel@lists.xenproject.org>; Thu, 16 May 2019 14:38:04 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=KL58/IRwGmE6I3Cm69naAG6NV+s6OX9WmMv6CAnobso=;
 b=i9eDZcOo81ua66OFMhHQxdUWRpy0iGqjrNxmtQy7BqkeJg8+pvoE04rPSJb0cVx7dH
 wi2b7AIHfGlgiVd7ns+N/io72KRqBRhVQIBqMR+7kQgZyNi1vTn7gAtbvV6PBtjZFUK2
 vMpg/DV2KFD+QwV5ARgqJoV095v0YD2zfdW45iSjGdqa3Y4cfG2C5iGQC+GDl86LH4mv
 Xp3o8ctkn6gt0EVu+gfIqGxlw3Fse0ownKEFxXOxj+28Xq05uR9/hfruNpi2HMO/Ywo0
 7FZh+HZABH3PS3ZJ5H2gKbiQ0QAgWEuZOGBth0fLN08PIRcPkduvrRAbNdXhzY8Sx9jt
 qJcQ==
X-Gm-Message-State: APjAAAW5rJhSa31HF7eAPci4jQsZxODqGO9J3Jhj5TCHUP5DCRfuiGHM
 GLhQ9M6ddvCk8cc+At1Gxma2bW1M
X-Google-Smtp-Source: APXvYqxTnIAO3yMvQc2JHXuTSk3z/isPJdv3U206RzA8VSetWgyMA3w3kxKIBIvD8BplCIWSmMDuGA==
X-Received: by 2002:a05:660c:652:: with SMTP id
 y18mr15427333itk.93.1558042683567; 
 Thu, 16 May 2019 14:38:03 -0700 (PDT)
Received: from localhost.localdomain (c-71-205-12-124.hsd1.co.comcast.net.
 [71.205.12.124])
 by smtp.gmail.com with ESMTPSA id j81sm2509701itj.26.2019.05.16.14.38.02
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
 Thu, 16 May 2019 14:38:02 -0700 (PDT)
From: Tamas K Lengyel <tamas@tklengyel.com>
To: xen-devel@lists.xenproject.org
Date: Thu, 16 May 2019 15:37:49 -0600
Message-Id: <20190516213752.1701-1-tamas@tklengyel.com>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v5 1/4] x86/mem_sharing: reorder when pages are
 unlocked and released
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Tamas K Lengyel <tamas@tklengyel.com>, Wei Liu <wei.liu2@citrix.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Jan Beulich <jbeulich@suse.com>,
 Roger Pau Monne <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q2FsbGluZyBfcHV0X3BhZ2VfdHlwZSB3aGlsZSBhbHNvIGhvbGRpbmcgdGhlIHBhZ2VfbG9jawpm
b3IgdGhhdCBwYWdlIGNhbiBjYXVzZSBhIGRlYWRsb2NrLgoKVGhlIGNvbW1lbnQgYmVpbmcgZHJv
cHBlZCBpcyBpbmNvcnJlY3Qgc2luY2UgaXQncyBub3cgb3V0LW9mLWRhdGUuCgpTaWduZWQtb2Zm
LWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzQHRrbGVuZ3llbC5jb20+CkNjOiBKYW4gQmV1bGlj
aCA8amJldWxpY2hAc3VzZS5jb20+CkNjOiBBbmRyZXcgQ29vcGVyIDxhbmRyZXcuY29vcGVyM0Bj
aXRyaXguY29tPgpDYzogR2VvcmdlIER1bmxhcCA8Z2VvcmdlLmR1bmxhcEBldS5jaXRyaXguY29t
PgpDYzogV2VpIExpdSA8d2VpLmxpdTJAY2l0cml4LmNvbT4KQ2M6IFJvZ2VyIFBhdSBNb25uZSA8
cm9nZXIucGF1QGNpdHJpeC5jb20+Ci0tLQpUaGlzIHNlcmllcyBpcyBiYXNlZCBvbiBBbmRyZXcg
Q29vcGVyJ3MgeDg2LW5leHQgYnJhbmNoCgp2NTogQlVHX09OIGVhcmx5IGJlZm9yZSByZWxlYXNp
bmcgcmVmZXJlbmNlcwotLS0KIHhlbi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmluZy5jIHwgNDEgKysr
KysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAxMSBpbnNl
cnRpb25zKCspLCAzMCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvbW0v
bWVtX3NoYXJpbmcuYyBiL3hlbi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmluZy5jCmluZGV4IGYxNmEz
ZjUzMjQuLjEzYjJmMDA5ZDQgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmlu
Zy5jCisrKyBiL3hlbi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmluZy5jCkBAIC02NDgsMTAgKzY0OCw2
IEBAIHN0YXRpYyBpbnQgcGFnZV9tYWtlX3ByaXZhdGUoc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0
IHBhZ2VfaW5mbyAqcGFnZSkKICAgICAgICAgcmV0dXJuIC1FQlVTWTsKICAgICB9CiAKLSAgICAv
KiBXZSBjYW4gb25seSBjaGFuZ2UgdGhlIHR5cGUgaWYgY291bnQgaXMgb25lICovCi0gICAgLyog
QmVjYXVzZSB3ZSBhcmUgbG9ja2luZyBwYWdlcyBpbmRpdmlkdWFsbHksIHdlIG5lZWQgdG8gZHJv
cAotICAgICAqIHRoZSBsb2NrIGhlcmUsIHdoaWxlIHRoZSBwYWdlIGlzIHR5cGVkLiBXZSBjYW5u
b3QgcmlzayB0aGUgCi0gICAgICogcmFjZSBvZiBwYWdlX3VubG9jayBhbmQgdGhlbiBwdXRfcGFn
ZV90eXBlLiAqLwogICAgIGV4cGVjdGVkX3R5cGUgPSAoUEdUX3NoYXJlZF9wYWdlIHwgUEdUX3Zh
bGlkYXRlZCB8IFBHVF9sb2NrZWQgfCAyKTsKICAgICBpZiAoIHBhZ2UtPnUuaW51c2UudHlwZV9p
bmZvICE9IGV4cGVjdGVkX3R5cGUgKQogICAgIHsKQEAgLTY2MCwxMiArNjU2LDExIEBAIHN0YXRp
YyBpbnQgcGFnZV9tYWtlX3ByaXZhdGUoc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IHBhZ2VfaW5m
byAqcGFnZSkKICAgICAgICAgcmV0dXJuIC1FRVhJU1Q7CiAgICAgfQogCisgICAgbWVtX3NoYXJp
bmdfcGFnZV91bmxvY2socGFnZSk7CisKICAgICAvKiBEcm9wIHRoZSBmaW5hbCB0eXBlY291bnQg
Ki8KICAgICBwdXRfcGFnZV9hbmRfdHlwZShwYWdlKTsKIAotICAgIC8qIE5vdyB0aGF0IHdlJ3Zl
IGRyb3BwZWQgdGhlIHR5cGUsIHdlIGNhbiB1bmxvY2sgKi8KLSAgICBtZW1fc2hhcmluZ19wYWdl
X3VubG9jayhwYWdlKTsKLQogICAgIC8qIENoYW5nZSB0aGUgb3duZXIgKi8KICAgICBBU1NFUlQo
cGFnZV9nZXRfb3duZXIocGFnZSkgPT0gZG9tX2Nvdyk7CiAgICAgcGFnZV9zZXRfb3duZXIocGFn
ZSwgZCk7CkBAIC05MDAsNiArODk1LDcgQEAgc3RhdGljIGludCBzaGFyZV9wYWdlcyhzdHJ1Y3Qg
ZG9tYWluICpzZCwgZ2ZuX3Qgc2dmbiwgc2hyX2hhbmRsZV90IHNoLAogICAgIHAybV90eXBlX3Qg
c21mbl90eXBlLCBjbWZuX3R5cGU7CiAgICAgc3RydWN0IHR3b19nZm5zIHRnOwogICAgIHN0cnVj
dCBybWFwX2l0ZXJhdG9yIHJpOworICAgIHVuc2lnbmVkIGxvbmcgcHV0X2NvdW50ID0gMDsKIAog
ICAgIGdldF90d29fZ2ZucyhzZCwgc2dmbiwgJnNtZm5fdHlwZSwgTlVMTCwgJnNtZm4sCiAgICAg
ICAgICAgICAgICAgIGNkLCBjZ2ZuLCAmY21mbl90eXBlLCBOVUxMLCAmY21mbiwgMCwgJnRnKTsK
QEAgLTk2NCwxNSArOTYwLDYgQEAgc3RhdGljIGludCBzaGFyZV9wYWdlcyhzdHJ1Y3QgZG9tYWlu
ICpzZCwgZ2ZuX3Qgc2dmbiwgc2hyX2hhbmRsZV90IHNoLAogICAgICAgICBnb3RvIGVycl9vdXQ7
CiAgICAgfQogCi0gICAgLyogQWNxdWlyZSBhbiBleHRyYSByZWZlcmVuY2UsIGZvciB0aGUgZnJl
ZWluZyBiZWxvdyB0byBiZSBzYWZlLiAqLwotICAgIGlmICggIWdldF9wYWdlKGNwYWdlLCBkb21f
Y293KSApCi0gICAgewotICAgICAgICByZXQgPSAtRU9WRVJGTE9XOwotICAgICAgICBtZW1fc2hh
cmluZ19wYWdlX3VubG9jayhzZWNvbmRwZyk7Ci0gICAgICAgIG1lbV9zaGFyaW5nX3BhZ2VfdW5s
b2NrKGZpcnN0cGcpOwotICAgICAgICBnb3RvIGVycl9vdXQ7Ci0gICAgfQotCiAgICAgLyogTWVy
Z2UgdGhlIGxpc3RzIHRvZ2V0aGVyICovCiAgICAgcm1hcF9zZWVkX2l0ZXJhdG9yKGNwYWdlLCAm
cmkpOwogICAgIHdoaWxlICggKGdmbiA9IHJtYXBfaXRlcmF0ZShjcGFnZSwgJnJpKSkgIT0gTlVM
TCkKQEAgLTk4NCwxMyArOTcxLDE0IEBAIHN0YXRpYyBpbnQgc2hhcmVfcGFnZXMoc3RydWN0IGRv
bWFpbiAqc2QsIGdmbl90IHNnZm4sIHNocl9oYW5kbGVfdCBzaCwKICAgICAgICAgICogRG9uJ3Qg
Y2hhbmdlIHRoZSB0eXBlIG9mIHJtYXAgZm9yIHRoZSBjbGllbnQgcGFnZS4gKi8KICAgICAgICAg
cm1hcF9kZWwoZ2ZuLCBjcGFnZSwgMCk7CiAgICAgICAgIHJtYXBfYWRkKGdmbiwgc3BhZ2UpOwot
ICAgICAgICBwdXRfcGFnZV9hbmRfdHlwZShjcGFnZSk7CisgICAgICAgIHB1dF9jb3VudCsrOwog
ICAgICAgICBkID0gZ2V0X2RvbWFpbl9ieV9pZChnZm4tPmRvbWFpbik7CiAgICAgICAgIEJVR19P
TighZCk7CiAgICAgICAgIEJVR19PTihzZXRfc2hhcmVkX3AybV9lbnRyeShkLCBnZm4tPmdmbiwg
c21mbikpOwogICAgICAgICBwdXRfZG9tYWluKGQpOwogICAgIH0KICAgICBBU1NFUlQobGlzdF9l
bXB0eSgmY3BhZ2UtPnNoYXJpbmctPmdmbnMpKTsKKyAgICBCVUdfT04oIXB1dF9jb3VudCk7CiAK
ICAgICAvKiBDbGVhciB0aGUgcmVzdCBvZiB0aGUgc2hhcmVkIHN0YXRlICovCiAgICAgcGFnZV9z
aGFyaW5nX2Rpc3Bvc2UoY3BhZ2UpOwpAQCAtMTAwMiw3ICs5OTAsOSBAQCBzdGF0aWMgaW50IHNo
YXJlX3BhZ2VzKHN0cnVjdCBkb21haW4gKnNkLCBnZm5fdCBzZ2ZuLCBzaHJfaGFuZGxlX3Qgc2gs
CiAgICAgLyogRnJlZSB0aGUgY2xpZW50IHBhZ2UgKi8KICAgICBpZih0ZXN0X2FuZF9jbGVhcl9i
aXQoX1BHQ19hbGxvY2F0ZWQsICZjcGFnZS0+Y291bnRfaW5mbykpCiAgICAgICAgIHB1dF9wYWdl
KGNwYWdlKTsKLSAgICBwdXRfcGFnZShjcGFnZSk7CisKKyAgICB3aGlsZSAoIHB1dF9jb3VudC0t
ICkKKyAgICAgICAgcHV0X3BhZ2VfYW5kX3R5cGUoY3BhZ2UpOwogCiAgICAgLyogV2UgbWFuYWdl
ZCB0byBmcmVlIGEgZG9tYWluIHBhZ2UuICovCiAgICAgYXRvbWljX2RlYygmbnJfc2hhcmVkX21m
bnMpOwpAQCAtMTE2NywyMCArMTE1NywxMSBAQCBpbnQgX19tZW1fc2hhcmluZ191bnNoYXJlX3Bh
Z2Uoc3RydWN0IGRvbWFpbiAqZCwKICAgICB7CiAgICAgICAgIGlmICggIWxhc3RfZ2ZuICkKICAg
ICAgICAgICAgIG1lbV9zaGFyaW5nX2dmbl9kZXN0cm95KHBhZ2UsIGQsIGdmbl9pbmZvKTsKLSAg
ICAgICAgcHV0X3BhZ2VfYW5kX3R5cGUocGFnZSk7CiAgICAgICAgIG1lbV9zaGFyaW5nX3BhZ2Vf
dW5sb2NrKHBhZ2UpOwotICAgICAgICBpZiAoIGxhc3RfZ2ZuICkKLSAgICAgICAgewotICAgICAg
ICAgICAgaWYgKCAhZ2V0X3BhZ2UocGFnZSwgZG9tX2NvdykgKQotICAgICAgICAgICAgewotICAg
ICAgICAgICAgICAgIHB1dF9nZm4oZCwgZ2ZuKTsKLSAgICAgICAgICAgICAgICBkb21haW5fY3Jh
c2goZCk7Ci0gICAgICAgICAgICAgICAgcmV0dXJuIC1FT1ZFUkZMT1c7Ci0gICAgICAgICAgICB9
Ci0gICAgICAgICAgICBpZiAoIHRlc3RfYW5kX2NsZWFyX2JpdChfUEdDX2FsbG9jYXRlZCwgJnBh
Z2UtPmNvdW50X2luZm8pICkKLSAgICAgICAgICAgICAgICBwdXRfcGFnZShwYWdlKTsKKyAgICAg
ICAgaWYgKCBsYXN0X2dmbiAmJgorICAgICAgICAgICAgdGVzdF9hbmRfY2xlYXJfYml0KF9QR0Nf
YWxsb2NhdGVkLCAmcGFnZS0+Y291bnRfaW5mbykgKQogICAgICAgICAgICAgcHV0X3BhZ2UocGFn
ZSk7Ci0gICAgICAgIH0KKyAgICAgICAgcHV0X3BhZ2VfYW5kX3R5cGUocGFnZSk7CiAgICAgICAg
IHB1dF9nZm4oZCwgZ2ZuKTsKIAogICAgICAgICByZXR1cm4gMDsKLS0gCjIuMjAuMQoKCl9fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWls
aW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVu
cHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

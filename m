Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 830515857D
	for <lists+xen-devel@lfdr.de>; Thu, 27 Jun 2019 17:24:33 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hgWDF-00041E-Kt; Thu, 27 Jun 2019 15:21:25 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=LRcK=U2=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1hgWDE-00040w-83
 for xen-devel@lists.xenproject.org; Thu, 27 Jun 2019 15:21:24 +0000
X-Inumbo-ID: 386f3c53-98ef-11e9-8980-bc764e045a96
Received: from prv1-mh.provo.novell.com (unknown [137.65.248.33])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 386f3c53-98ef-11e9-8980-bc764e045a96;
 Thu, 27 Jun 2019 15:21:22 +0000 (UTC)
Received: from INET-PRV1-MTA by prv1-mh.provo.novell.com
 with Novell_GroupWise; Thu, 27 Jun 2019 09:21:21 -0600
Message-Id: <5D14DEEB020000780023B987@prv1-mh.provo.novell.com>
X-Mailer: Novell GroupWise Internet Agent 18.1.1 
Date: Thu, 27 Jun 2019 09:21:15 -0600
From: "Jan Beulich" <JBeulich@suse.com>
To: "xen-devel" <xen-devel@lists.xenproject.org>
References: <5D024C500200007800237DD8@prv1-mh.provo.novell.com>
 <5D14DDA6020000780023B96E@prv1-mh.provo.novell.com>
In-Reply-To: <5D14DDA6020000780023B96E@prv1-mh.provo.novell.com>
Mime-Version: 1.0
Content-Disposition: inline
Subject: [Xen-devel] [PATCH v2 05/10] AMD/IOMMU: introduce 128-bit IRTE
 non-guest-APIC IRTE format
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Brian Woods <brian.woods@amd.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhpcyBpcyBpbiBwcmVwYXJhdGlvbiBvZiBhY3R1YWxseSBlbmFibGluZyB4MkFQSUMgbW9kZSwg
d2hpY2ggcmVxdWlyZXMKdGhpcyB3aWRlciBJUlRFIGZvcm1hdCB0byBiZSB1c2VkLgoKQSBzcGVj
aWZpYyByZW1hcmsgcmVnYXJkaW5nIHRoZSBmaXJzdCBodW5rIGNoYW5naW5nCmFtZF9pb21tdV9p
b2FwaWNfdXBkYXRlX2lyZSgpOiBUaGlzIGJ5cGFzcyB3YXMgaW50cm9kdWNlZCBmb3IgWFNBLTM2
LAppLmUuIGJ5IDk0ZDRhMTExOWQgKCJBTUQsSU9NTVU6IENsZWFuIHVwIG9sZCBlbnRyaWVzIGlu
IHJlbWFwcGluZwp0YWJsZXMgd2hlbiBjcmVhdGluZyBuZXcgb25lIikuIE90aGVyIGNvZGUgaW50
cm9kdWNlZCBieSB0aGF0IGNoYW5nZSBoYXMKbWVhbndoaWxlIGRpc2FwcGVhcmVkIG9yIGZ1cnRo
ZXIgY2hhbmdlZCwgYW5kIEkgd29uZGVyIGlmIC0gcmF0aGVyIHRoYW4KYWRkaW5nIGFuIHgyYXBp
Y19lbmFibGVkIGNoZWNrIHRvIHRoZSBjb25kaXRpb25hbCAtIHRoZSBieXBhc3MgY291bGRuJ3QK
YmUgZGVsZXRlZCBhbHRvZ2V0aGVyLiBGb3Igbm93IHRoZSBnb2FsIGlzIHRvIGFmZmVjdCB0aGUg
bm9uLXgyQVBJQwpwYXRocyBhcyBsaXR0bGUgYXMgcG9zc2libGUuCgpUYWtlIHRoZSBsaWJlcnR5
IGFuZCB1c2UgdGhlIG5ldyAiZnJlc2giIGZsYWcgdG8gc3VwcHJlc3MgYW4gdW5uZWVkZWQKZmx1
c2ggaW4gdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zyb21faW9hcGljKCkuCgpTaWduZWQtb2ZmLWJ5
OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+Ci0tLQp2MjogQWRkIGNhc3QgaW4gZ2V0
X2Z1bGxfZGVzdCgpLiBSZS1iYXNlIG92ZXIgY2hhbmdlcyBlYXJsaWVyIGluIHRoZQogICAgc2Vy
aWVzLiBEb24ndCB1c2UgY21weGNoZzE2Yi4gVXNlIGJhcnJpZXIoKSBpbnN0ZWFkIG9mIHdtYigp
LgotLS0KTm90ZSB0aGF0IEFNRCdzIGRvYyBzYXlzIExvd2VzdCBQcmlvcml0eSAoIkFyYml0cmF0
ZWQiIGJ5IHRoZWlyIG5hbWluZykKbW9kZSBpcyB1bmF2YWlsYWJsZSBpbiB4MkFQSUMgbW9kZSwg
YnV0IHRoZXkndmUgY29uZmlybWVkIHRoaXMgdG8gYmUgYQptaXN0YWtlIG9uIHRoZWlyIHBhcnQu
CgotLS0gYS94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfaW50ci5jCisrKyBiL3hl
bi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdV9pbnRyLmMKQEAgLTQwLDEyICs0MCw0NSBA
QCB1bmlvbiBpcnRlMzIgewogICAgIHN0cnVjdCBpcnRlX2Jhc2ljIGJhc2ljOwogfTsKIAorc3Ry
dWN0IGlydGVfZnVsbCB7CisgICAgdW5zaWduZWQgaW50IHJlbWFwX2VuOjE7CisgICAgdW5zaWdu
ZWQgaW50IHN1cF9pb19wZjoxOworICAgIHVuc2lnbmVkIGludCBpbnRfdHlwZTozOworICAgIHVu
c2lnbmVkIGludCBycV9lb2k6MTsKKyAgICB1bnNpZ25lZCBpbnQgZG06MTsKKyAgICB1bnNpZ25l
ZCBpbnQgZ3Vlc3RfbW9kZToxOyAvKiBNQlogKi8KKyAgICB1bnNpZ25lZCBpbnQgZGVzdF9sbzoy
NDsKKyAgICB1bnNpZ25lZCBpbnQgOjMyOworICAgIHVuc2lnbmVkIGludCB2ZWN0b3I6ODsKKyAg
ICB1bnNpZ25lZCBpbnQgOjI0OworICAgIHVuc2lnbmVkIGludCA6MjQ7CisgICAgdW5zaWduZWQg
aW50IGRlc3RfaGk6ODsKK307CisKK3VuaW9uIGlydGUxMjggeworICAgIHVpbnQ2NF90IHJhd1sy
XTsKKyAgICBzdHJ1Y3QgaXJ0ZV9mdWxsIGZ1bGw7Cit9OworCitzdGF0aWMgZW51bSB7CisgICAg
aXJ0ZTMyLAorICAgIGlydGUxMjgsCisgICAgaXJ0ZVVOSywKK30gaXJ0ZV9tb2RlIF9fcmVhZF9t
b3N0bHkgPSBpcnRlVU5LOworCiB1bmlvbiBpcnRlX3B0ciB7CiAgICAgdm9pZCAqcHRyOwogICAg
IHVuaW9uIGlydGUzMiAqcHRyMzI7CisgICAgdW5pb24gaXJ0ZTEyOCAqcHRyMTI4OwogfTsKIAot
I2RlZmluZSBJTlRSRU1BUF9UQUJMRV9PUkRFUiAgICAxCit1bmlvbiBpcnRlX2NwdHIgeworICAg
IGNvbnN0IHZvaWQgKnB0cjsKKyAgICBjb25zdCB1bmlvbiBpcnRlMzIgKnB0cjMyOworICAgIGNv
bnN0IHVuaW9uIGlydGUxMjggKnB0cjEyODsKK30gX190cmFuc3BhcmVudF9fOworCisjZGVmaW5l
IElOVFJFTUFQX1RBQkxFX09SREVSIChpcnRlX21vZGUgPT0gaXJ0ZTMyID8gMSA6IDMpCiAjZGVm
aW5lIElOVFJFTUFQX0xFTkdUSCAweEIKICNkZWZpbmUgSU5UUkVNQVBfRU5UUklFUyAoMSA8PCBJ
TlRSRU1BUF9MRU5HVEgpCiAKQEAgLTEzMiw3ICsxNjUsMTkgQEAgc3RhdGljIHVuaW9uIGlydGVf
cHRyIGdldF9pbnRyZW1hcF9lbnRyeQogCiAgICAgQVNTRVJUKHRhYmxlLnB0ciAmJiAoaW5kZXgg
PCBJTlRSRU1BUF9FTlRSSUVTKSk7CiAKLSAgICB0YWJsZS5wdHIzMiArPSBpbmRleDsKKyAgICBz
d2l0Y2ggKCBpcnRlX21vZGUgKQorICAgIHsKKyAgICBjYXNlIGlydGUzMjoKKyAgICAgICAgdGFi
bGUucHRyMzIgKz0gaW5kZXg7CisgICAgICAgIGJyZWFrOworCisgICAgY2FzZSBpcnRlMTI4Ogor
ICAgICAgICB0YWJsZS5wdHIxMjggKz0gaW5kZXg7CisgICAgICAgIGJyZWFrOworCisgICAgZGVm
YXVsdDoKKyAgICAgICAgQVNTRVJUX1VOUkVBQ0hBQkxFKCk7CisgICAgfQogCiAgICAgcmV0dXJu
IHRhYmxlOwogfQpAQCAtMTQyLDcgKzE4NywyMSBAQCBzdGF0aWMgdm9pZCBmcmVlX2ludHJlbWFw
X2VudHJ5KHVuc2lnbmVkCiB7CiAgICAgdW5pb24gaXJ0ZV9wdHIgZW50cnkgPSBnZXRfaW50cmVt
YXBfZW50cnkoc2VnLCBiZGYsIGluZGV4KTsKIAotICAgIEFDQ0VTU19PTkNFKGVudHJ5LnB0cjMy
LT5yYXdbMF0pID0gMDsKKyAgICBzd2l0Y2ggKCBpcnRlX21vZGUgKQorICAgIHsKKyAgICBjYXNl
IGlydGUzMjoKKyAgICAgICAgQUNDRVNTX09OQ0UoZW50cnkucHRyMzItPnJhd1swXSkgPSAwOwor
ICAgICAgICBicmVhazsKKworICAgIGNhc2UgaXJ0ZTEyODoKKyAgICAgICAgQUNDRVNTX09OQ0Uo
ZW50cnkucHRyMTI4LT5yYXdbMF0pID0gMDsKKyAgICAgICAgYmFycmllcigpOworICAgICAgICBl
bnRyeS5wdHIxMjgtPnJhd1sxXSA9IDA7CisgICAgICAgIGJyZWFrOworCisgICAgZGVmYXVsdDoK
KyAgICAgICAgQVNTRVJUX1VOUkVBQ0hBQkxFKCk7CisgICAgfQogCiAgICAgX19jbGVhcl9iaXQo
aW5kZXgsIGdldF9pdnJzX21hcHBpbmdzKHNlZylbYmRmXS5pbnRyZW1hcF9pbnVzZSk7CiB9CkBA
IC0xNjAsOSArMjE5LDM3IEBAIHN0YXRpYyB2b2lkIHVwZGF0ZV9pbnRyZW1hcF9lbnRyeSh1bmlv
bgogICAgICAgICAuZGVzdCA9IGRlc3QsCiAgICAgICAgIC52ZWN0b3IgPSB2ZWN0b3IsCiAgICAg
fTsKKyAgICBzdHJ1Y3QgaXJ0ZV9mdWxsIGZ1bGwgPSB7CisgICAgICAgIC5yZW1hcF9lbiA9IDEs
CisgICAgICAgIC5zdXBfaW9fcGYgPSAwLAorICAgICAgICAuaW50X3R5cGUgPSBpbnRfdHlwZSwK
KyAgICAgICAgLnJxX2VvaSA9IDAsCisgICAgICAgIC5kbSA9IGRlc3RfbW9kZSwKKyAgICAgICAg
LmRlc3RfbG8gPSBkZXN0LAorICAgICAgICAuZGVzdF9oaSA9IGRlc3QgPj4gMjQsCisgICAgICAg
IC52ZWN0b3IgPSB2ZWN0b3IsCisgICAgfTsKKworICAgIHN3aXRjaCAoIGlydGVfbW9kZSApCisg
ICAgeworICAgIGNhc2UgaXJ0ZTMyOgorICAgICAgICBBQ0NFU1NfT05DRShlbnRyeS5wdHIzMi0+
cmF3WzBdKSA9CisgICAgICAgICAgICBjb250YWluZXJfb2YoJmJhc2ljLCB1bmlvbiBpcnRlMzIs
IGJhc2ljKS0+cmF3WzBdOworICAgICAgICBicmVhazsKKworICAgIGNhc2UgaXJ0ZTEyODoKKyAg
ICAgICAgQUNDRVNTX09OQ0UoZW50cnkucHRyMTI4LT5yYXdbMF0pID0gMDsKKyAgICAgICAgYmFy
cmllcigpOworICAgICAgICBlbnRyeS5wdHIxMjgtPnJhd1sxXSA9CisgICAgICAgICAgICBjb250
YWluZXJfb2YoJmZ1bGwsIHVuaW9uIGlydGUxMjgsIGZ1bGwpLT5yYXdbMV07CisgICAgICAgIGJh
cnJpZXIoKTsKKyAgICAgICAgQUNDRVNTX09OQ0UoZW50cnkucHRyMTI4LT5yYXdbMF0pID0KKyAg
ICAgICAgICAgIGNvbnRhaW5lcl9vZigmZnVsbCwgdW5pb24gaXJ0ZTEyOCwgZnVsbCktPnJhd1sw
XTsKKyAgICAgICAgYnJlYWs7CiAKLSAgICBBQ0NFU1NfT05DRShlbnRyeS5wdHIzMi0+cmF3WzBd
KSA9Ci0gICAgICAgIGNvbnRhaW5lcl9vZigmYmFzaWMsIHVuaW9uIGlydGUzMiwgYmFzaWMpLT5y
YXdbMF07CisgICAgZGVmYXVsdDoKKyAgICAgICAgQVNTRVJUX1VOUkVBQ0hBQkxFKCk7CisgICAg
fQogfQogCiBzdGF0aWMgaW5saW5lIGludCBnZXRfcnRlX2luZGV4KGNvbnN0IHN0cnVjdCBJT19B
UElDX3JvdXRlX2VudHJ5ICpydGUpCkBAIC0xNzYsNiArMjYzLDExIEBAIHN0YXRpYyBpbmxpbmUg
dm9pZCBzZXRfcnRlX2luZGV4KHN0cnVjdAogICAgIHJ0ZS0+ZGVsaXZlcnlfbW9kZSA9IG9mZnNl
dCA+PiA4OwogfQogCitzdGF0aWMgaW5saW5lIHVuc2lnbmVkIGludCBnZXRfZnVsbF9kZXN0KGNv
bnN0IHVuaW9uIGlydGUxMjggKmVudHJ5KQoreworICAgIHJldHVybiBlbnRyeS0+ZnVsbC5kZXN0
X2xvIHwgKCh1bnNpZ25lZCBpbnQpZW50cnktPmZ1bGwuZGVzdF9oaSA8PCAyNCk7Cit9CisKIHN0
YXRpYyBpbnQgdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zyb21faW9hcGljKAogICAgIGludCBiZGYs
CiAgICAgc3RydWN0IGFtZF9pb21tdSAqaW9tbXUsCkBAIC0xODUsMTAgKzI3NywxMSBAQCBzdGF0
aWMgaW50IHVwZGF0ZV9pbnRyZW1hcF9lbnRyeV9mcm9tX2lvCiB7CiAgICAgdW5zaWduZWQgbG9u
ZyBmbGFnczsKICAgICB1bmlvbiBpcnRlX3B0ciBlbnRyeTsKLSAgICB1OCBkZWxpdmVyeV9tb2Rl
LCBkZXN0LCB2ZWN0b3IsIGRlc3RfbW9kZTsKKyAgICB1bnNpZ25lZCBpbnQgZGVsaXZlcnlfbW9k
ZSwgZGVzdCwgdmVjdG9yLCBkZXN0X21vZGU7CiAgICAgaW50IHJlcV9pZDsKICAgICBzcGlubG9j
a190ICpsb2NrOwogICAgIHVuc2lnbmVkIGludCBvZmZzZXQ7CisgICAgYm9vbCBmcmVzaCA9IGZh
bHNlOwogCiAgICAgcmVxX2lkID0gZ2V0X2ludHJlbWFwX3JlcXVlc3Rvcl9pZChpb21tdS0+c2Vn
LCBiZGYpOwogICAgIGxvY2sgPSBnZXRfaW50cmVtYXBfbG9jayhpb21tdS0+c2VnLCByZXFfaWQp
OwpAQCAtMTk2LDcgKzI4OSw3IEBAIHN0YXRpYyBpbnQgdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zy
b21faW8KICAgICBkZWxpdmVyeV9tb2RlID0gcnRlLT5kZWxpdmVyeV9tb2RlOwogICAgIHZlY3Rv
ciA9IHJ0ZS0+dmVjdG9yOwogICAgIGRlc3RfbW9kZSA9IHJ0ZS0+ZGVzdF9tb2RlOwotICAgIGRl
c3QgPSBydGUtPmRlc3QubG9naWNhbC5sb2dpY2FsX2Rlc3Q7CisgICAgZGVzdCA9IHgyYXBpY19l
bmFibGVkID8gcnRlLT5kZXN0LmRlc3QzMiA6IHJ0ZS0+ZGVzdC5sb2dpY2FsLmxvZ2ljYWxfZGVz
dDsKIAogICAgIHNwaW5fbG9ja19pcnFzYXZlKGxvY2ssIGZsYWdzKTsKIApAQCAtMjExLDI1ICsz
MDQsNDAgQEAgc3RhdGljIGludCB1cGRhdGVfaW50cmVtYXBfZW50cnlfZnJvbV9pbwogICAgICAg
ICAgICAgcmV0dXJuIC1FTk9TUEM7CiAgICAgICAgIH0KICAgICAgICAgKmluZGV4ID0gb2Zmc2V0
OwotICAgICAgICBsb191cGRhdGUgPSAxOworICAgICAgICBmcmVzaCA9IHRydWU7CiAgICAgfQog
CiAgICAgZW50cnkgPSBnZXRfaW50cmVtYXBfZW50cnkoaW9tbXUtPnNlZywgcmVxX2lkLCBvZmZz
ZXQpOwotICAgIGlmICggIWxvX3VwZGF0ZSApCisgICAgaWYgKCBmcmVzaCApCisgICAgICAgIC8q
IG5vdGhpbmcgKi87CisgICAgZWxzZSBpZiAoICFsb191cGRhdGUgKQogICAgIHsKICAgICAgICAg
LyoKICAgICAgICAgICogTG93IGhhbGYgb2YgaW5jb21pbmcgUlRFIGlzIGFscmVhZHkgaW4gcmVt
YXBwZWQgZm9ybWF0LAogICAgICAgICAgKiBzbyBuZWVkIHRvIHJlY292ZXIgdmVjdG9yIGFuZCBk
ZWxpdmVyeSBtb2RlIGZyb20gSVJURS4KICAgICAgICAgICovCiAgICAgICAgIEFTU0VSVChnZXRf
cnRlX2luZGV4KHJ0ZSkgPT0gb2Zmc2V0KTsKLSAgICAgICAgdmVjdG9yID0gZW50cnkucHRyMzIt
PmJhc2ljLnZlY3RvcjsKKyAgICAgICAgaWYgKCBpcnRlX21vZGUgPT0gaXJ0ZTMyICkKKyAgICAg
ICAgICAgIHZlY3RvciA9IGVudHJ5LnB0cjMyLT5iYXNpYy52ZWN0b3I7CisgICAgICAgIGVsc2UK
KyAgICAgICAgICAgIHZlY3RvciA9IGVudHJ5LnB0cjEyOC0+ZnVsbC52ZWN0b3I7CisgICAgICAg
IC8qIFRoZSBJbnRUeXBlIGZpZWxkcyBtYXRjaCBmb3IgYm90aCBmb3JtYXRzLiAqLwogICAgICAg
ICBkZWxpdmVyeV9tb2RlID0gZW50cnkucHRyMzItPmJhc2ljLmludF90eXBlOwogICAgIH0KKyAg
ICBlbHNlIGlmICggeDJhcGljX2VuYWJsZWQgKQorICAgIHsKKyAgICAgICAgLyoKKyAgICAgICAg
ICogSGlnaCBoYWxmIG9mIGluY29taW5nIFJURSB3YXMgcmVhZCBmcm9tIHRoZSBJL08gQVBJQyBh
bmQgaGVuY2UgbWF5CisgICAgICAgICAqIG5vdCBob2xkIHRoZSBmdWxsIGRlc3RpbmF0aW9uLCBz
byBuZWVkIHRvIHJlY292ZXIgZnVsbCBkZXN0aW5hdGlvbgorICAgICAgICAgKiBmcm9tIElSVEUu
CisgICAgICAgICAqLworICAgICAgICBkZXN0ID0gZ2V0X2Z1bGxfZGVzdChlbnRyeS5wdHIxMjgp
OworICAgIH0KICAgICB1cGRhdGVfaW50cmVtYXBfZW50cnkoZW50cnksIHZlY3RvciwgZGVsaXZl
cnlfbW9kZSwgZGVzdF9tb2RlLCBkZXN0KTsKIAogICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUo
bG9jaywgZmxhZ3MpOwogCi0gICAgaWYgKCBpb21tdS0+ZW5hYmxlZCApCisgICAgaWYgKCBpb21t
dS0+ZW5hYmxlZCAmJiAhZnJlc2ggKQogICAgIHsKICAgICAgICAgc3Bpbl9sb2NrX2lycXNhdmUo
JmlvbW11LT5sb2NrLCBmbGFncyk7CiAgICAgICAgIGFtZF9pb21tdV9mbHVzaF9pbnRyZW1hcChp
b21tdSwgcmVxX2lkKTsKQEAgLTI1Myw2ICszNjEsMTkgQEAgaW50IF9faW5pdCBhbWRfaW9tbXVf
c2V0dXBfaW9hcGljX3JlbWFwcAogICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAgICAgdW5zaWduZWQg
aW50IG9mZnNldDsKIAorICAgIGZvcl9lYWNoX2FtZF9pb21tdSAoIGlvbW11ICkKKyAgICB7Cisg
ICAgICAgIGlmICggaXJ0ZV9tb2RlICE9IGlydGVVTksgKQorICAgICAgICB7CisgICAgICAgICAg
ICBpZiAoIGlvbW11LT5jdHJsLmdhX2VuID09IChpcnRlX21vZGUgPT0gaXJ0ZTMyKSApCisgICAg
ICAgICAgICAgICAgcmV0dXJuIC1FTlhJTzsKKyAgICAgICAgfQorICAgICAgICBlbHNlIGlmICgg
aW9tbXUtPmN0cmwuZ2FfZW4gKQorICAgICAgICAgICAgaXJ0ZV9tb2RlID0gaXJ0ZTEyODsKKyAg
ICAgICAgZWxzZQorICAgICAgICAgICAgaXJ0ZV9tb2RlID0gaXJ0ZTMyOworICAgIH0KKwogICAg
IC8qIFJlYWQgaW9hcGljIGVudHJpZXMgYW5kIHVwZGF0ZSBpbnRlcnJ1cHQgcmVtYXBwaW5nIHRh
YmxlIGFjY29yZGluZ2x5ICovCiAgICAgZm9yICggYXBpYyA9IDA7IGFwaWMgPCBucl9pb2FwaWNz
OyBhcGljKysgKQogICAgIHsKQEAgLTI4Nyw2ICs0MDgsMTggQEAgaW50IF9faW5pdCBhbWRfaW9t
bXVfc2V0dXBfaW9hcGljX3JlbWFwcAogICAgICAgICAgICAgZGVzdF9tb2RlID0gcnRlLmRlc3Rf
bW9kZTsKICAgICAgICAgICAgIGRlc3QgPSBydGUuZGVzdC5sb2dpY2FsLmxvZ2ljYWxfZGVzdDsK
IAorICAgICAgICAgICAgaWYgKCBpb21tdS0+Y3RybC54dF9lbiApCisgICAgICAgICAgICB7Cisg
ICAgICAgICAgICAgICAgLyoKKyAgICAgICAgICAgICAgICAgKiBJbiB4MkFQSUMgbW9kZSB3ZSBo
YXZlIG5vIHdheSBvZiBkaXNjb3ZlcmluZyB0aGUgaGlnaCAyNAorICAgICAgICAgICAgICAgICAq
IGJpdHMgb2YgdGhlIGRlc3RpbmF0aW9uIG9mIGFuIGFscmVhZHkgZW5hYmxlZCBpbnRlcnJ1cHQu
CisgICAgICAgICAgICAgICAgICogV2UgY29tZSBoZXJlIGVhcmxpZXIgdGhhbiBmb3IgeEFQSUMg
bW9kZSwgc28gbm8gaW50ZXJydXB0cworICAgICAgICAgICAgICAgICAqIHNob3VsZCBoYXZlIGJl
ZW4gc2V0IHVwIGJlZm9yZS4KKyAgICAgICAgICAgICAgICAgKi8KKyAgICAgICAgICAgICAgICBB
TURfSU9NTVVfREVCVUcoIlVubWFza2VkIElPLUFQSUMjJXUgZW50cnkgJXUgaW4geDJBUElDIG1v
ZGVcbiIsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElPX0FQSUNfSUQoYXBpYyks
IHBpbik7CisgICAgICAgICAgICB9CisKICAgICAgICAgICAgIHNwaW5fbG9ja19pcnFzYXZlKGxv
Y2ssIGZsYWdzKTsKICAgICAgICAgICAgIG9mZnNldCA9IGFsbG9jX2ludHJlbWFwX2VudHJ5KHNl
ZywgcmVxX2lkLCAxKTsKICAgICAgICAgICAgIEJVR19PTihvZmZzZXQgPj0gSU5UUkVNQVBfRU5U
UklFUyk7CkBAIC0zMjEsNyArNDU0LDggQEAgdm9pZCBhbWRfaW9tbXVfaW9hcGljX3VwZGF0ZV9p
cmUoCiAgICAgc3RydWN0IElPX0FQSUNfcm91dGVfZW50cnkgbmV3X3J0ZSA9IHsgMCB9OwogICAg
IHVuc2lnbmVkIGludCBydGVfbG8gPSAocmVnICYgMSkgPyByZWcgLSAxIDogcmVnOwogICAgIHVu
c2lnbmVkIGludCBwaW4gPSAocmVnIC0gMHgxMCkgLyAyOwotICAgIGludCBzYXZlZF9tYXNrLCBz
ZWcsIGJkZiwgcmM7CisgICAgaW50IHNlZywgYmRmLCByYzsKKyAgICBib29sIHNhdmVkX21hc2ss
IGZyZXNoID0gZmFsc2U7CiAgICAgc3RydWN0IGFtZF9pb21tdSAqaW9tbXU7CiAgICAgdW5zaWdu
ZWQgaW50IGlkeDsKIApAQCAtMzYzLDEyICs0OTcsMjIgQEAgdm9pZCBhbWRfaW9tbXVfaW9hcGlj
X3VwZGF0ZV9pcmUoCiAgICAgICAgICooKCh1MzIgKikmbmV3X3J0ZSkgKyAxKSA9IHZhbHVlOwog
ICAgIH0KIAotICAgIGlmICggbmV3X3J0ZS5tYXNrICYmCi0gICAgICAgICBpb2FwaWNfc2JkZltp
ZHhdLnBpbl8yX2lkeFtwaW5dID49IElOVFJFTUFQX0VOVFJJRVMgKQorICAgIGlmICggaW9hcGlj
X3NiZGZbaWR4XS5waW5fMl9pZHhbcGluXSA+PSBJTlRSRU1BUF9FTlRSSUVTICkKICAgICB7CiAg
ICAgICAgIEFTU0VSVChzYXZlZF9tYXNrKTsKLSAgICAgICAgX19pb19hcGljX3dyaXRlKGFwaWMs
IHJlZywgdmFsdWUpOwotICAgICAgICByZXR1cm47CisKKyAgICAgICAgLyoKKyAgICAgICAgICog
VGhlcmUncyBub3doZXJlIGV4Y2VwdCB0aGUgSVJURSB0byBzdG9yZSBhIGZ1bGwgMzItYml0IGRl
c3RpbmF0aW9uLAorICAgICAgICAgKiBzbyB3ZSBtYXkgbm90IGJ5cGFzcyBlbnRyeSBhbGxvY2F0
aW9uIGFuZCB1cGRhdGluZyBvZiB0aGUgbG93IFJURQorICAgICAgICAgKiBoYWxmIGluIHRoZSAo
dXN1YWwpIGNhc2Ugb2YgdGhlIGhpZ2ggUlRFIGhhbGYgZ2V0dGluZyB3cml0dGVuIGZpcnN0Lgor
ICAgICAgICAgKi8KKyAgICAgICAgaWYgKCBuZXdfcnRlLm1hc2sgJiYgIXgyYXBpY19lbmFibGVk
ICkKKyAgICAgICAgeworICAgICAgICAgICAgX19pb19hcGljX3dyaXRlKGFwaWMsIHJlZywgdmFs
dWUpOworICAgICAgICAgICAgcmV0dXJuOworICAgICAgICB9CisKKyAgICAgICAgZnJlc2ggPSB0
cnVlOwogICAgIH0KIAogICAgIC8qIG1hc2sgdGhlIGludGVycnVwdCB3aGlsZSB3ZSBjaGFuZ2Ug
dGhlIGludHJlbWFwIHRhYmxlICovCkBAIC0zOTcsOCArNTQxLDEyIEBAIHZvaWQgYW1kX2lvbW11
X2lvYXBpY191cGRhdGVfaXJlKAogICAgIGlmICggcmVnID09IHJ0ZV9sbyApCiAgICAgICAgIHJl
dHVybjsKIAotICAgIC8qIHVubWFzayB0aGUgaW50ZXJydXB0IGFmdGVyIHdlIGhhdmUgdXBkYXRl
ZCB0aGUgaW50cmVtYXAgdGFibGUgKi8KLSAgICBpZiAoICFzYXZlZF9tYXNrICkKKyAgICAvKgor
ICAgICAqIFVubWFzayB0aGUgaW50ZXJydXB0IGFmdGVyIHdlIGhhdmUgdXBkYXRlZCB0aGUgaW50
cmVtYXAgdGFibGUuIEFsc28KKyAgICAgKiB3cml0ZSB0aGUgbG93IGhhbGYgaWYgYSBmcmVzaCBl
bnRyeSB3YXMgYWxsb2NhdGVkIGZvciBhIGhpZ2ggaGFsZgorICAgICAqIHVwZGF0ZSBpbiB4MkFQ
SUMgbW9kZS4KKyAgICAgKi8KKyAgICBpZiAoICFzYXZlZF9tYXNrIHx8ICh4MmFwaWNfZW5hYmxl
ZCAmJiBmcmVzaCkgKQogICAgIHsKICAgICAgICAgb2xkX3J0ZS5tYXNrID0gc2F2ZWRfbWFzazsK
ICAgICAgICAgX19pb19hcGljX3dyaXRlKGFwaWMsIHJ0ZV9sbywgKigodTMyICopJm9sZF9ydGUp
KTsKQEAgLTQxMiwyNyArNTYwLDM2IEBAIHVuc2lnbmVkIGludCBhbWRfaW9tbXVfcmVhZF9pb2Fw
aWNfZnJvbV8KICAgICB1bnNpZ25lZCBpbnQgb2Zmc2V0OwogICAgIHVuc2lnbmVkIGludCB2YWwg
PSBfX2lvX2FwaWNfcmVhZChhcGljLCByZWcpOwogICAgIHVuc2lnbmVkIGludCBwaW4gPSAocmVn
IC0gMHgxMCkgLyAyOworICAgIHVpbnQxNl90IHNlZywgcmVxX2lkOworICAgIHVuaW9uIGlydGVf
cHRyIGVudHJ5OwogCiAgICAgaWR4ID0gaW9hcGljX2lkX3RvX2luZGV4KElPX0FQSUNfSUQoYXBp
YykpOwogICAgIGlmICggaWR4ID09IE1BWF9JT19BUElDUyApCiAgICAgICAgIHJldHVybiAtRUlO
VkFMOwogCiAgICAgb2Zmc2V0ID0gaW9hcGljX3NiZGZbaWR4XS5waW5fMl9pZHhbcGluXTsKKyAg
ICBpZiAoIG9mZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVTICkKKyAgICAgICAgcmV0dXJuIHZhbDsK
IAotICAgIGlmICggIShyZWcgJiAxKSAmJiBvZmZzZXQgPCBJTlRSRU1BUF9FTlRSSUVTICkKKyAg
ICBzZWcgPSBpb2FwaWNfc2JkZltpZHhdLnNlZzsKKyAgICByZXFfaWQgPSBnZXRfaW50cmVtYXBf
cmVxdWVzdG9yX2lkKHNlZywgaW9hcGljX3NiZGZbaWR4XS5iZGYpOworICAgIGVudHJ5ID0gZ2V0
X2ludHJlbWFwX2VudHJ5KHNlZywgcmVxX2lkLCBvZmZzZXQpOworCisgICAgaWYgKCAhKHJlZyAm
IDEpICkKICAgICB7Ci0gICAgICAgIHUxNiBiZGYgPSBpb2FwaWNfc2JkZltpZHhdLmJkZjsKLSAg
ICAgICAgdTE2IHNlZyA9IGlvYXBpY19zYmRmW2lkeF0uc2VnOwotICAgICAgICB1MTYgcmVxX2lk
ID0gZ2V0X2ludHJlbWFwX3JlcXVlc3Rvcl9pZChzZWcsIGJkZik7Ci0gICAgICAgIHVuaW9uIGly
dGVfcHRyIGVudHJ5ID0gZ2V0X2ludHJlbWFwX2VudHJ5KHNlZywgcmVxX2lkLCBvZmZzZXQpOwog
CiAgICAgICAgIEFTU0VSVChvZmZzZXQgPT0gKHZhbCAmIChJTlRSRU1BUF9FTlRSSUVTIC0gMSkp
KTsKICAgICAgICAgdmFsICY9IH4oSU5UUkVNQVBfRU5UUklFUyAtIDEpOworICAgICAgICAvKiBU
aGUgSW50VHlwZSBmaWVsZHMgbWF0Y2ggZm9yIGJvdGggZm9ybWF0cy4gKi8KICAgICAgICAgdmFs
IHw9IE1BU0tfSU5TUihlbnRyeS5wdHIzMi0+YmFzaWMuaW50X3R5cGUsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgSU9fQVBJQ19SRURJUl9ERUxJVl9NT0RFX01BU0spOwotICAgICAgICB2YWwg
fD0gTUFTS19JTlNSKGVudHJ5LnB0cjMyLT5iYXNpYy52ZWN0b3IsCisgICAgICAgIHZhbCB8PSBN
QVNLX0lOU1IoaXJ0ZV9tb2RlID09IGlydGUzMgorICAgICAgICAgICAgICAgICAgICAgICAgID8g
ZW50cnkucHRyMzItPmJhc2ljLnZlY3RvcgorICAgICAgICAgICAgICAgICAgICAgICAgIDogZW50
cnkucHRyMTI4LT5mdWxsLnZlY3RvciwKICAgICAgICAgICAgICAgICAgICAgICAgICBJT19BUElD
X1JFRElSX1ZFQ1RPUl9NQVNLKTsKICAgICB9CisgICAgZWxzZSBpZiAoIHgyYXBpY19lbmFibGVk
ICkKKyAgICAgICAgdmFsID0gZ2V0X2Z1bGxfZGVzdChlbnRyeS5wdHIxMjgpOwogCiAgICAgcmV0
dXJuIHZhbDsKIH0KQEAgLTQ0NCw5ICs2MDEsOSBAQCBzdGF0aWMgaW50IHVwZGF0ZV9pbnRyZW1h
cF9lbnRyeV9mcm9tX21zCiAgICAgdW5zaWduZWQgbG9uZyBmbGFnczsKICAgICB1bmlvbiBpcnRl
X3B0ciBlbnRyeTsKICAgICB1MTYgcmVxX2lkLCBhbGlhc19pZDsKLSAgICB1OCBkZWxpdmVyeV9t
b2RlLCBkZXN0LCB2ZWN0b3IsIGRlc3RfbW9kZTsKKyAgICB1aW50OF90IGRlbGl2ZXJ5X21vZGUs
IHZlY3RvciwgZGVzdF9tb2RlOwogICAgIHNwaW5sb2NrX3QgKmxvY2s7Ci0gICAgdW5zaWduZWQg
aW50IG9mZnNldCwgaTsKKyAgICB1bnNpZ25lZCBpbnQgZGVzdCwgb2Zmc2V0LCBpOwogCiAgICAg
cmVxX2lkID0gZ2V0X2RtYV9yZXF1ZXN0b3JfaWQoaW9tbXUtPnNlZywgYmRmKTsKICAgICBhbGlh
c19pZCA9IGdldF9pbnRyZW1hcF9yZXF1ZXN0b3JfaWQoaW9tbXUtPnNlZywgYmRmKTsKQEAgLTQ2
Nyw3ICs2MjQsMTIgQEAgc3RhdGljIGludCB1cGRhdGVfaW50cmVtYXBfZW50cnlfZnJvbV9tcwog
ICAgIGRlc3RfbW9kZSA9IChtc2ctPmFkZHJlc3NfbG8gPj4gTVNJX0FERFJfREVTVE1PREVfU0hJ
RlQpICYgMHgxOwogICAgIGRlbGl2ZXJ5X21vZGUgPSAobXNnLT5kYXRhID4+IE1TSV9EQVRBX0RF
TElWRVJZX01PREVfU0hJRlQpICYgMHgxOwogICAgIHZlY3RvciA9IChtc2ctPmRhdGEgPj4gTVNJ
X0RBVEFfVkVDVE9SX1NISUZUKSAmIE1TSV9EQVRBX1ZFQ1RPUl9NQVNLOwotICAgIGRlc3QgPSAo
bXNnLT5hZGRyZXNzX2xvID4+IE1TSV9BRERSX0RFU1RfSURfU0hJRlQpICYgMHhmZjsKKworICAg
IGlmICggeDJhcGljX2VuYWJsZWQgKQorICAgICAgICBkZXN0ID0gbXNnLT5kZXN0MzI7CisgICAg
ZWxzZQorICAgICAgICBkZXN0ID0gTUFTS19FWFRSKG1zZy0+YWRkcmVzc19sbywgTVNJX0FERFJf
REVTVF9JRF9NQVNLKTsKKwogICAgIG9mZnNldCA9ICpyZW1hcF9pbmRleDsKICAgICBpZiAoIG9m
ZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVTICkKICAgICB7CkBAIC02MTIsMTAgKzc3NCwyMSBAQCB2
b2lkIGFtZF9pb21tdV9yZWFkX21zaV9mcm9tX2lyZSgKICAgICB9CiAKICAgICBtc2ctPmRhdGEg
Jj0gfihJTlRSRU1BUF9FTlRSSUVTIC0gMSk7CisgICAgLyogVGhlIEludFR5cGUgZmllbGRzIG1h
dGNoIGZvciBib3RoIGZvcm1hdHMuICovCiAgICAgbXNnLT5kYXRhIHw9IE1BU0tfSU5TUihlbnRy
eS5wdHIzMi0+YmFzaWMuaW50X3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBNU0lf
REFUQV9ERUxJVkVSWV9NT0RFX01BU0spOwotICAgIG1zZy0+ZGF0YSB8PSBNQVNLX0lOU1IoZW50
cnkucHRyMzItPmJhc2ljLnZlY3RvciwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgIE1TSV9E
QVRBX1ZFQ1RPUl9NQVNLKTsKKyAgICBpZiAoIGlydGVfbW9kZSA9PSBpcnRlMzIgKQorICAgIHsK
KyAgICAgICAgbXNnLT5kYXRhIHw9IE1BU0tfSU5TUihlbnRyeS5wdHIzMi0+YmFzaWMudmVjdG9y
LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1TSV9EQVRBX1ZFQ1RPUl9NQVNLKTsK
KyAgICAgICAgbXNnLT5kZXN0MzIgPSBlbnRyeS5wdHIzMi0+YmFzaWMuZGVzdDsKKyAgICB9Cisg
ICAgZWxzZQorICAgIHsKKyAgICAgICAgbXNnLT5kYXRhIHw9IE1BU0tfSU5TUihlbnRyeS5wdHIx
MjgtPmZ1bGwudmVjdG9yLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1TSV9EQVRB
X1ZFQ1RPUl9NQVNLKTsKKyAgICAgICAgbXNnLT5kZXN0MzIgPSBnZXRfZnVsbF9kZXN0KGVudHJ5
LnB0cjEyOCk7CisgICAgfQogfQogCiBpbnQgX19pbml0IGFtZF9pb21tdV9mcmVlX2ludHJlbWFw
X3RhYmxlKApAQCAtNjc4LDE4ICs4NTEsMjggQEAgaW50IF9faW5pdCBhbWRfc2V0dXBfaHBldF9t
c2koc3RydWN0IG1zaQogICAgIHJldHVybiByYzsKIH0KIAotc3RhdGljIHZvaWQgZHVtcF9pbnRy
ZW1hcF90YWJsZShjb25zdCB1MzIgKnRhYmxlKQorc3RhdGljIHZvaWQgZHVtcF9pbnRyZW1hcF90
YWJsZSh1bmlvbiBpcnRlX2NwdHIgdGJsKQogewotICAgIHUzMiBjb3VudDsKKyAgICB1bnNpZ25l
ZCBpbnQgY291bnQ7CiAKLSAgICBpZiAoICF0YWJsZSApCisgICAgaWYgKCAhdGJsLnB0ciB8fCBp
cnRlX21vZGUgPT0gaXJ0ZVVOSyApCiAgICAgICAgIHJldHVybjsKIAogICAgIGZvciAoIGNvdW50
ID0gMDsgY291bnQgPCBJTlRSRU1BUF9FTlRSSUVTOyBjb3VudCsrICkKICAgICB7Ci0gICAgICAg
IGlmICggIXRhYmxlW2NvdW50XSApCi0gICAgICAgICAgICBjb250aW51ZTsKLSAgICAgICAgcHJp
bnRrKCIgICAgSVJURVslMDN4XSAlMDh4XG4iLCBjb3VudCwgdGFibGVbY291bnRdKTsKKyAgICAg
ICAgaWYgKCBpcnRlX21vZGUgPT0gaXJ0ZTMyICkKKyAgICAgICAgeworICAgICAgICAgICAgaWYg
KCAhdGJsLnB0cjMyW2NvdW50XS5yYXdbMF0gKQorICAgICAgICAgICAgICAgIGNvbnRpbnVlOwor
ICAgICAgICAgICAgcHJpbnRrKCIgICAgSVJURVslMDN4XSAlMDh4XG4iLCBjb3VudCwgdGJsLnB0
cjMyW2NvdW50XS5yYXdbMF0pOworICAgICAgICB9CisgICAgICAgIGVsc2UKKyAgICAgICAgewor
ICAgICAgICAgICAgaWYgKCAhdGJsLnB0cjEyOFtjb3VudF0ucmF3WzBdICYmICF0YmwucHRyMTI4
W2NvdW50XS5yYXdbMV0gKQorICAgICAgICAgICAgICAgIGNvbnRpbnVlOworICAgICAgICAgICAg
cHJpbnRrKCIgICAgSVJURVslMDN4XSAlMDE2bHhfJTAxNmx4XG4iLAorICAgICAgICAgICAgICAg
ICAgIGNvdW50LCB0YmwucHRyMTI4W2NvdW50XS5yYXdbMV0sIHRibC5wdHIxMjhbY291bnRdLnJh
d1swXSk7CisgICAgICAgIH0KICAgICB9CiB9CiAKCgoKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVs
QGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1h
bi9saXN0aW5mby94ZW4tZGV2ZWw=

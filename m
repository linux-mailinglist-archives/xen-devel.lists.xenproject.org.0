Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 59669B779B
	for <lists+xen-devel@lfdr.de>; Thu, 19 Sep 2019 12:40:47 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iAtod-0005ej-7p; Thu, 19 Sep 2019 10:37:35 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=5hYN=XO=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1iAtob-0005eR-SL
 for xen-devel@lists.xenproject.org; Thu, 19 Sep 2019 10:37:33 +0000
X-Inumbo-ID: 7bc9caec-dac9-11e9-b76c-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 7bc9caec-dac9-11e9-b76c-bc764e2007e4;
 Thu, 19 Sep 2019 10:37:31 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 5EEA6AFB2;
 Thu, 19 Sep 2019 10:37:30 +0000 (UTC)
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
From: Jan Beulich <jbeulich@suse.com>
Message-ID: <845737d3-e16e-61d7-7733-0f8b9eddfb45@suse.com>
Date: Thu, 19 Sep 2019 12:37:36 +0200
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.9.0
MIME-Version: 1.0
Content-Language: en-US
Subject: [Xen-devel] [PATCH] SVM: correct CPUID event processing
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Petre Pircalabu <ppircalabu@bitdefender.com>,
 Juergen Gross <jgross@suse.com>, Kevin Tian <kevin.tian@intel.com>,
 Tamas K Lengyel <tamas@tklengyel.com>, Jun Nakajima <jun.nakajima@intel.com>,
 Wei Liu <wl@xen.org>, Andrew Cooper <andrew.cooper3@citrix.com>,
 Razvan Cojocaru <rcojocaru@bitdefender.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>,
 Alexandru Isaila <aisaila@bitdefender.com>,
 Boris Ostrovsky <boris.ostrovsky@oracle.com>,
 =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

aHZtX21vbml0b3JfY3B1aWQoKSBleHBlY3RzIHRoZSBpbnB1dCByZWdpc3RlcnMsIG5vdCB0d28g
b2YgdGhlIG91dHB1dHMuCgpIb3dldmVyLCBvbmNlIGhhdmluZyBtYWRlIHRoZSBuZWNlc3Nhcnkg
YWRqdXN0bWVudCwgdGhlIFNWTSBhbmQgVk1YCmZ1bmN0aW9ucyBhcmUgc28gc2ltaWxhciB0aGF0
IHRoZXkgc2hvdWxkIGJlIGZvbGRlZCAodGh1cyBhdm9pZGluZwpmdXJ0aGVyIHNpbWlsYXIgYXN5
bW1ldHJpZXMgdG8gZ2V0IGludHJvZHVjZWQpLiBVc2UgdGhlIGJlc3Qgb2YgYm90aAp3b3JsZHMg
YnkgZS5nLiB1c2luZyAiY3VyciIgY29uc2lzdGVudGx5LiBUaGlzIHRoZW4gYmVpbmcgdGhlIG9u
bHkKY2FsbGVyIG9mIGh2bV9jaGVja19jcHVpZF9mYXVsdGluZygpLCBmb2xkIGluIHRoYXQgZnVu
Y3Rpb24gYXMgd2VsbC4KClNpZ25lZC1vZmYtYnk6IEphbiBCZXVsaWNoIDxqYmV1bGljaEBzdXNl
LmNvbT4KCi0tLSBhL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMKKysrIGIveGVuL2FyY2gveDg2L2h2
bS9odm0uYwpAQCAtMzM0OSwxNCArMzM0OSwyOCBAQCB1bnNpZ25lZCBsb25nIGNvcHlfZnJvbV91
c2VyX2h2bSh2b2lkICp0CiAgICAgcmV0dXJuIHJjID8gbGVuIDogMDsgLyogZmFrZSBhIGNvcHlf
ZnJvbV91c2VyKCkgcmV0dXJuIGNvZGUgKi8KIH0KIAotYm9vbCBodm1fY2hlY2tfY3B1aWRfZmF1
bHRpbmcoc3RydWN0IHZjcHUgKnYpCitpbnQgaHZtX3ZtZXhpdF9jcHVpZChzdHJ1Y3QgY3B1X3Vz
ZXJfcmVncyAqcmVncywgdW5zaWduZWQgaW50IGluc3RfbGVuKQogewotICAgIGNvbnN0IHN0cnVj
dCB2Y3B1X21zcnMgKm1zcnMgPSB2LT5hcmNoLm1zcnM7CisgICAgc3RydWN0IHZjcHUgKmN1cnIg
PSBjdXJyZW50OworICAgIHVuc2lnbmVkIGludCBsZWFmID0gcmVncy0+ZWF4LCBzdWJsZWFmID0g
cmVncy0+ZWN4OworICAgIHN0cnVjdCBjcHVpZF9sZWFmIHJlczsKIAotICAgIGlmICggIW1zcnMt
Pm1pc2NfZmVhdHVyZXNfZW5hYmxlcy5jcHVpZF9mYXVsdGluZyApCi0gICAgICAgIHJldHVybiBm
YWxzZTsKKyAgICBpZiAoIGN1cnItPmFyY2gubXNycy0+bWlzY19mZWF0dXJlc19lbmFibGVzLmNw
dWlkX2ZhdWx0aW5nICYmCisgICAgICAgICBodm1fZ2V0X2NwbChjdXJyKSA+IDAgKQorICAgIHsK
KyAgICAgICAgaHZtX2luamVjdF9od19leGNlcHRpb24oVFJBUF9ncF9mYXVsdCwgMCk7CisgICAg
ICAgIHJldHVybiAxOyAvKiBEb24ndCBhZHZhbmNlIHRoZSBndWVzdCBJUCEgKi8KKyAgICB9CiAK
LSAgICByZXR1cm4gaHZtX2dldF9jcGwodikgPiAwOworICAgIGd1ZXN0X2NwdWlkKGN1cnIsIGxl
YWYsIHN1YmxlYWYsICZyZXMpOworICAgIEhWTVRSQUNFXzZEKENQVUlELCBsZWFmLCBzdWJsZWFm
LCByZXMuYSwgcmVzLmIsIHJlcy5jLCByZXMuZCk7CisKKyAgICByZWdzLT5yYXggPSByZXMuYTsK
KyAgICByZWdzLT5yYnggPSByZXMuYjsKKyAgICByZWdzLT5yY3ggPSByZXMuYzsKKyAgICByZWdz
LT5yZHggPSByZXMuZDsKKworICAgIHJldHVybiBodm1fbW9uaXRvcl9jcHVpZChpbnN0X2xlbiwg
bGVhZiwgc3VibGVhZik7CiB9CiAKIHN0YXRpYyB1aW50NjRfdCBfaHZtX3JkdHNjX2ludGVyY2Vw
dCh2b2lkKQotLS0gYS94ZW4vYXJjaC94ODYvaHZtL3N2bS9zdm0uYworKysgYi94ZW4vYXJjaC94
ODYvaHZtL3N2bS9zdm0uYwpAQCAtMTc4NCwyOCArMTc4NCw2IEBAIHN0YXRpYyB2b2lkIHN2bV9m
cHVfZGlydHlfaW50ZXJjZXB0KHZvaWQKICAgICAgICAgdm1jYl9zZXRfY3IwKHZtY2IsIHZtY2Jf
Z2V0X2NyMCh2bWNiKSAmIH5YODZfQ1IwX1RTKTsKIH0KIAotc3RhdGljIGludCBzdm1fdm1leGl0
X2RvX2NwdWlkKHN0cnVjdCBjcHVfdXNlcl9yZWdzICpyZWdzLCB1bnNpZ25lZCBpbnQgaW5zdF9s
ZW4pCi17Ci0gICAgc3RydWN0IHZjcHUgKmN1cnIgPSBjdXJyZW50OwotICAgIHN0cnVjdCBjcHVp
ZF9sZWFmIHJlczsKLQotICAgIGlmICggaHZtX2NoZWNrX2NwdWlkX2ZhdWx0aW5nKGN1cnIpICkK
LSAgICB7Ci0gICAgICAgIGh2bV9pbmplY3RfaHdfZXhjZXB0aW9uKFRSQVBfZ3BfZmF1bHQsIDAp
OwotICAgICAgICByZXR1cm4gMTsgLyogRG9uJ3QgYWR2YW5jZSB0aGUgZ3Vlc3QgSVAhICovCi0g
ICAgfQotCi0gICAgZ3Vlc3RfY3B1aWQoY3VyciwgcmVncy0+ZWF4LCByZWdzLT5lY3gsICZyZXMp
OwotICAgIEhWTVRSQUNFXzVEKENQVUlELCByZWdzLT5lYXgsIHJlcy5hLCByZXMuYiwgcmVzLmMs
IHJlcy5kKTsKLQotICAgIHJlZ3MtPnJheCA9IHJlcy5hOwotICAgIHJlZ3MtPnJieCA9IHJlcy5i
OwotICAgIHJlZ3MtPnJjeCA9IHJlcy5jOwotICAgIHJlZ3MtPnJkeCA9IHJlcy5kOwotCi0gICAg
cmV0dXJuIGh2bV9tb25pdG9yX2NwdWlkKGluc3RfbGVuLCByZWdzLT5lYXgsIHJlZ3MtPmVjeCk7
Ci19Ci0KIHN0YXRpYyB2b2lkIHN2bV92bWV4aXRfZG9fY3JfYWNjZXNzKAogICAgIHN0cnVjdCB2
bWNiX3N0cnVjdCAqdm1jYiwgc3RydWN0IGNwdV91c2VyX3JlZ3MgKnJlZ3MpCiB7CkBAIC0yODI4
LDcgKzI4MDYsNyBAQCB2b2lkIHN2bV92bWV4aXRfaGFuZGxlcihzdHJ1Y3QgY3B1X3VzZXJfCiAg
ICAgICAgIGlmICggaW5zdF9sZW4gPT0gMCApCiAgICAgICAgICAgICBicmVhazsKIAotICAgICAg
ICByYyA9IHN2bV92bWV4aXRfZG9fY3B1aWQocmVncywgaW5zdF9sZW4pOworICAgICAgICByYyA9
IGh2bV92bWV4aXRfY3B1aWQocmVncywgaW5zdF9sZW4pOwogCiAgICAgICAgIGlmICggcmMgPCAw
ICkKICAgICAgICAgICAgIGdvdG8gdW5leHBlY3RlZF9leGl0X3R5cGU7Ci0tLSBhL3hlbi9hcmNo
L3g4Ni9odm0vdm14L3ZteC5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vdm14L3ZteC5jCkBAIC0y
NDg5LDI5ICsyMzg5LDYgQEAgc3RhdGljIHZvaWQgdm14X2ZwdV9kaXJ0eV9pbnRlcmNlcHQodm9p
ZAogICAgIH0KIH0KIAotc3RhdGljIGludCB2bXhfZG9fY3B1aWQoc3RydWN0IGNwdV91c2VyX3Jl
Z3MgKnJlZ3MpCi17Ci0gICAgc3RydWN0IHZjcHUgKmN1cnIgPSBjdXJyZW50OwotICAgIHVpbnQz
Ml90IGxlYWYgPSByZWdzLT5lYXgsIHN1YmxlYWYgPSByZWdzLT5lY3g7Ci0gICAgc3RydWN0IGNw
dWlkX2xlYWYgcmVzOwotCi0gICAgaWYgKCBodm1fY2hlY2tfY3B1aWRfZmF1bHRpbmcoY3VycmVu
dCkgKQotICAgIHsKLSAgICAgICAgaHZtX2luamVjdF9od19leGNlcHRpb24oVFJBUF9ncF9mYXVs
dCwgMCk7Ci0gICAgICAgIHJldHVybiAxOyAgLyogRG9uJ3QgYWR2YW5jZSB0aGUgZ3Vlc3QgSVAh
ICovCi0gICAgfQotCi0gICAgZ3Vlc3RfY3B1aWQoY3VyciwgbGVhZiwgc3VibGVhZiwgJnJlcyk7
Ci0gICAgSFZNVFJBQ0VfNUQoQ1BVSUQsIGxlYWYsIHJlcy5hLCByZXMuYiwgcmVzLmMsIHJlcy5k
KTsKLQotICAgIHJlZ3MtPnJheCA9IHJlcy5hOwotICAgIHJlZ3MtPnJieCA9IHJlcy5iOwotICAg
IHJlZ3MtPnJjeCA9IHJlcy5jOwotICAgIHJlZ3MtPnJkeCA9IHJlcy5kOwotCi0gICAgcmV0dXJu
IGh2bV9tb25pdG9yX2NwdWlkKGdldF9pbnN0cnVjdGlvbl9sZW5ndGgoKSwgbGVhZiwgc3VibGVh
Zik7Ci19Ci0KIHN0YXRpYyB2b2lkIHZteF9kcl9hY2Nlc3ModW5zaWduZWQgbG9uZyBleGl0X3F1
YWxpZmljYXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBjcHVfdXNlcl9y
ZWdzICpyZWdzKQogewpAQCAtMzg2Miw3ICszODM5LDcgQEAgdm9pZCB2bXhfdm1leGl0X2hhbmRs
ZXIoc3RydWN0IGNwdV91c2VyXwogICAgIH0KICAgICBjYXNlIEVYSVRfUkVBU09OX0NQVUlEOgog
ICAgIHsKLSAgICAgICAgaW50IHJjID0gdm14X2RvX2NwdWlkKHJlZ3MpOworICAgICAgICBpbnQg
cmMgPSBodm1fdm1leGl0X2NwdWlkKHJlZ3MsIGdldF9pbnN0cnVjdGlvbl9sZW5ndGgoKSk7CiAK
ICAgICAgICAgLyoKICAgICAgICAgICogcmMgPCAwIGVycm9yIGluIG1vbml0b3Ivdm1fZXZlbnQs
IGNyYXNoCi0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oCisrKyBiL3hlbi9pbmNs
dWRlL2FzbS14ODYvaHZtL2h2bS5oCkBAIC0yODAsNyArMjgwLDcgQEAgdm9pZCBodm1fc2V0X3Nl
Z21lbnRfcmVnaXN0ZXIoc3RydWN0IHZjcAogCiBib29sIGh2bV9zZXRfZ3Vlc3RfYm5kY2Zncyhz
dHJ1Y3QgdmNwdSAqdiwgdTY0IHZhbCk7CiAKLWJvb2wgaHZtX2NoZWNrX2NwdWlkX2ZhdWx0aW5n
KHN0cnVjdCB2Y3B1ICp2KTsKK2ludCBodm1fdm1leGl0X2NwdWlkKHN0cnVjdCBjcHVfdXNlcl9y
ZWdzICpyZWdzLCB1bnNpZ25lZCBpbnQgaW5zdF9sZW4pOwogdm9pZCBodm1fbWlncmF0ZV90aW1l
cnMoc3RydWN0IHZjcHUgKnYpOwogdm9pZCBodm1fZG9fcmVzdW1lKHN0cnVjdCB2Y3B1ICp2KTsK
IHZvaWQgaHZtX21pZ3JhdGVfcGlycShzdHJ1Y3QgaHZtX3BpcnFfZHBjaSAqcGlycV9kcGNpLCBj
b25zdCBzdHJ1Y3QgdmNwdSAqdik7CgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5w
cm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8v
eGVuLWRldmVs

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 78C0115817F
	for <lists+xen-devel@lfdr.de>; Mon, 10 Feb 2020 18:36:17 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j1Cvx-00080c-1a; Mon, 10 Feb 2020 17:33:21 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=qaH/=36=citrix.com=andrew.cooper3@srs-us1.protection.inumbo.net>)
 id 1j1Cvv-00080W-Kz
 for xen-devel@lists.xenproject.org; Mon, 10 Feb 2020 17:33:19 +0000
X-Inumbo-ID: 6cdb1e04-4c2b-11ea-852a-bc764e2007e4
Received: from esa3.hc3370-68.iphmx.com (unknown [216.71.145.155])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 6cdb1e04-4c2b-11ea-852a-bc764e2007e4;
 Mon, 10 Feb 2020 17:33:18 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1581355999;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=jTiP3tkDdsjIXkTSj3Vh0lwnBnBBu6bNZnmi7jPJ6L4=;
 b=DBkuUr4xbHRo3F1rJ0ysUZ7Zj72aGbcorFYkt8ACF/rifFzM0oCwyxiR
 3J3q+EsYPBtL5OuywdX4NZc6XawEzP9qiJ6oa58bs6i0yCBCn+T0JZfAk
 Pzt/hR3+gbyLwfUcqhiaq7FFOJ/T/JzlHI1Or6XzeXLFr8GBjoBIIOwS1 Y=;
Authentication-Results: esa3.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=andrew.cooper3@citrix.com;
 spf=Pass smtp.mailfrom=Andrew.Cooper3@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa3.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 andrew.cooper3@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="Andrew.Cooper3@citrix.com";
 x-sender="andrew.cooper3@citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa3.hc3370-68.iphmx.com: domain of
 Andrew.Cooper3@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="Andrew.Cooper3@citrix.com";
 x-sender="Andrew.Cooper3@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83
 ip4:168.245.78.127 ~all"
Received-SPF: None (esa3.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="Andrew.Cooper3@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: FwlNcXYOoZoTntgmXfT6vA+yaeqIZlJan2hy0/R4Os3e8NCte98FIZSlImxlMYmelGEc6X+exd
 RNO9Ff3nJClanVHS6ND64Sqweqx6xHBS0zGsK3oXTCZzeS/Yos0+saNoWvV3OH6FX+Owb4tpGo
 ITCH1YAvOrKLFrSkRq9elNWOKNvHrPDO1nKHqySPNhBy0q521BTLx51tpBufoVaCw8tcgDIbFH
 4PdANUl5eo7ftLqL4GxZ/DEtSFR5hDQwANTQU900bSkyIcS+0bSSiRjxAUI8AwfFmpl3GmNuS8
 smQ=
X-SBRS: 2.7
X-MesageID: 12215004
X-Ironport-Server: esa3.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.70,425,1574139600"; d="scan'208";a="12215004"
From: Andrew Cooper <andrew.cooper3@citrix.com>
To: Xen-devel <xen-devel@lists.xenproject.org>
Date: Mon, 10 Feb 2020 17:33:09 +0000
Message-ID: <20200210173309.16521-1-andrew.cooper3@citrix.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <20200203144340.4614-5-andrew.cooper3@citrix.com>
References: <20200203144340.4614-5-andrew.cooper3@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2 4/4] AMD/IOMMU: Treat head/tail pointers as
 byte offsets
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>, Wei Liu <wl@xen.org>,
 Jan Beulich <JBeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhlIE1NSU8gcmVnaXN0ZXJzIGFzIGFscmVhZHkgYnl0ZSBvZmZzZXRzLiAgVXNpbmcgdGhlbSBp
biB0aGlzIGZvcm0gcmVtb3Zlcwp0aGUgbmVlZCB0byBzaGlmdCB0aGVpciB2YWx1ZXMgZm9yIHVz
ZS4KCkl0IGlzIGFsc28gaW5lZmZpY2llbnQgdG8gc3RvcmUgYm90aCBlbnRyaWVzIGFuZCBhbGxv
Y19zaXplICh3aGljaCBvbmx5IGRpZmZlcgpieSBlbnRyeV9zaXplKS4gIFJlbmFtZSBhbGxvY19z
aXplIHRvIHNpemUsIGFuZCBkcm9wIGVudHJpZXMgZW50aXJlbHksIHdoaWNoCnNpbXBsaWZpZXMg
dGhlIGFsbG9jYXRpb24vZGVhbGxvY2F0aW9uIGhlbHBlcnMgc2xpZ2h0bHkuCgpNYXJrIHNlbmRf
aW9tbXVfY29tbWFuZCgpIGFuZCBpbnZhbGlkYXRlX2lvbW11X2FsbCgpIGFzIHN0YXRpYywgYXMg
dGhleSBoYXZlCm5vIGV4dGVybmFsIGRlY2xhcmF0aW9uIG9yIGNhbGxlcnMuCgpTaWduZWQtb2Zm
LWJ5OiBBbmRyZXcgQ29vcGVyIDxhbmRyZXcuY29vcGVyM0BjaXRyaXguY29tPgotLS0KQ0M6IEph
biBCZXVsaWNoIDxKQmV1bGljaEBzdXNlLmNvbT4KQ0M6IFdlaSBMaXUgPHdsQHhlbi5vcmc+CkND
OiBSb2dlciBQYXUgTW9ubsOpIDxyb2dlci5wYXVAY2l0cml4LmNvbT4KCnYyOgogKiBNYXNrIGhl
YWQvdGFpbCBwb2ludGVycwogKiBEcm9wIHVubmVjZXNzYXJ5IGNhc3QuCgpUZXN0ZWQgb24gYSBS
b21lIHN5c3RlbS4KLS0tCiB4ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXUtZGVmcy5o
IHwgIDEgLQogeGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LmggICAgICB8IDE4ICsr
LS0tLS0tLS0tLS0tLS0tLQogeGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11X2NtZC5j
ICB8IDIxICsrKysrKysrKy0tLS0tLS0tLS0tLQogeGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1k
L2lvbW11X2luaXQuYyB8IDMyICsrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tCiA0IGZp
bGVzIGNoYW5nZWQsIDI1IGluc2VydGlvbnMoKyksIDQ3IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdp
dCBhL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdS1kZWZzLmggYi94ZW4vZHJpdmVy
cy9wYXNzdGhyb3VnaC9hbWQvaW9tbXUtZGVmcy5oCmluZGV4IDk2MzAwOWRlNmEuLjUwNjEzY2Ex
NTAgMTAwNjQ0Ci0tLSBhL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdS1kZWZzLmgK
KysrIGIveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LWRlZnMuaApAQCAtNDgxLDcg
KzQ4MSw2IEBAIHN0cnVjdCBhbWRfaW9tbXVfcHRlIHsKICNkZWZpbmUgSU5WX0lPTU1VX0FMTF9Q
QUdFU19BRERSRVNTICAgICAgKCgxVUxMIDw8IDYzKSAtIDEpCiAKICNkZWZpbmUgSU9NTVVfUklO
R19CVUZGRVJfUFRSX01BU0sgICAgICAgICAgICAgICAgICAweDAwMDdGRkYwCi0jZGVmaW5lIElP
TU1VX1JJTkdfQlVGRkVSX1BUUl9TSElGVCAgICAgICAgICAgICAgICAgNAogCiAjZGVmaW5lIElP
TU1VX0NNRF9ERVZJQ0VfSURfTUFTSyAgICAgICAgICAgICAgICAgICAgMHgwMDAwRkZGRgogI2Rl
ZmluZSBJT01NVV9DTURfREVWSUNFX0lEX1NISUZUICAgICAgICAgICAgICAgICAgIDAKZGlmZiAt
LWdpdCBhL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdS5oIGIveGVuL2RyaXZlcnMv
cGFzc3Rocm91Z2gvYW1kL2lvbW11LmgKaW5kZXggMGI1OThkMDZmOC4uMWFiZmRjNjg1YSAxMDA2
NDQKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LmgKKysrIGIveGVuL2Ry
aXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LmgKQEAgLTU4LDEyICs1OCwxMSBAQCBzdHJ1Y3Qg
dGFibGVfc3RydWN0IHsKIH07CiAKIHN0cnVjdCByaW5nX2J1ZmZlciB7CisgICAgc3BpbmxvY2tf
dCBsb2NrOyAgICAvKiBwcm90ZWN0IGJ1ZmZlciBwb2ludGVycyAqLwogICAgIHZvaWQgKmJ1ZmZl
cjsKLSAgICB1bnNpZ25lZCBsb25nIGVudHJpZXM7Ci0gICAgdW5zaWduZWQgbG9uZyBhbGxvY19z
aXplOwogICAgIHVpbnQzMl90IHRhaWw7CiAgICAgdWludDMyX3QgaGVhZDsKLSAgICBzcGlubG9j
a190IGxvY2s7ICAgIC8qIHByb3RlY3QgYnVmZmVyIHBvaW50ZXJzICovCisgICAgdWludDMyX3Qg
c2l6ZTsKIH07CiAKIHR5cGVkZWYgc3RydWN0IGlvbW11X2NhcCB7CkBAIC0zNzksMTkgKzM3OCw2
IEBAIHN0YXRpYyBpbmxpbmUgaW50IGlvbW11X2hhc19jYXAoc3RydWN0IGFtZF9pb21tdSAqaW9t
bXUsIHVpbnQzMl90IGJpdCkKICAgICByZXR1cm4gISEoaW9tbXUtPmNhcC5oZWFkZXIgJiAoMXUg
PDwgYml0KSk7CiB9CiAKLS8qIGFjY2VzcyB0YWlsIG9yIGhlYWQgcG9pbnRlciBvZiByaW5nIGJ1
ZmZlciAqLwotc3RhdGljIGlubGluZSB1aW50MzJfdCBpb21tdV9nZXRfcmJfcG9pbnRlcih1aW50
MzJfdCByZWcpCi17Ci0gICAgcmV0dXJuIGdldF9maWVsZF9mcm9tX3JlZ191MzIocmVnLCBJT01N
VV9SSU5HX0JVRkZFUl9QVFJfTUFTSywKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBJT01NVV9SSU5HX0JVRkZFUl9QVFJfU0hJRlQpOwotfQotCi1zdGF0aWMgaW5saW5lIHZvaWQg
aW9tbXVfc2V0X3JiX3BvaW50ZXIodWludDMyX3QgKnJlZywgdWludDMyX3QgdmFsKQotewotICAg
IHNldF9maWVsZF9pbl9yZWdfdTMyKHZhbCwgKnJlZywgSU9NTVVfUklOR19CVUZGRVJfUFRSX01B
U0ssCi0gICAgICAgICAgICAgICAgICAgICAgICAgSU9NTVVfUklOR19CVUZGRVJfUFRSX1NISUZU
LCByZWcpOwotfQotCiAvKiBhY2Nlc3MgZGV2aWNlIGlkIGZpZWxkIGZyb20gaW9tbXUgY21kICov
CiBzdGF0aWMgaW5saW5lIHVpbnQxNl90IGlvbW11X2dldF9kZXZpZF9mcm9tX2NtZCh1aW50MzJf
dCBjbWQpCiB7CmRpZmYgLS1naXQgYS94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVf
Y21kLmMgYi94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfY21kLmMKaW5kZXggMWVh
ZTMzOTY5Mi4uMjQ5ZWQzNDVhMCAxMDA2NDQKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gv
YW1kL2lvbW11X2NtZC5jCisrKyBiL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdV9j
bWQuYwpAQCAtMjQsMTYgKzI0LDE1IEBAIHN0YXRpYyBpbnQgcXVldWVfaW9tbXVfY29tbWFuZChz
dHJ1Y3QgYW1kX2lvbW11ICppb21tdSwgdTMyIGNtZFtdKQogewogICAgIHVpbnQzMl90IHRhaWws
IGhlYWQ7CiAKLSAgICB0YWlsID0gaW9tbXUtPmNtZF9idWZmZXIudGFpbDsKLSAgICBpZiAoICsr
dGFpbCA9PSBpb21tdS0+Y21kX2J1ZmZlci5lbnRyaWVzICkKKyAgICB0YWlsID0gaW9tbXUtPmNt
ZF9idWZmZXIudGFpbCArIElPTU1VX0NNRF9CVUZGRVJfRU5UUllfU0laRTsKKyAgICBpZiAoIHRh
aWwgPT0gaW9tbXUtPmNtZF9idWZmZXIuc2l6ZSApCiAgICAgICAgIHRhaWwgPSAwOwogCi0gICAg
aGVhZCA9IGlvbW11X2dldF9yYl9wb2ludGVyKHJlYWRsKGlvbW11LT5tbWlvX2Jhc2UgKwotICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJT01NVV9DTURfQlVGRkVSX0hFQURf
T0ZGU0VUKSk7CisgICAgaGVhZCA9IHJlYWRsKGlvbW11LT5tbWlvX2Jhc2UgKworICAgICAgICAg
ICAgICAgICBJT01NVV9DTURfQlVGRkVSX0hFQURfT0ZGU0VUKSAmIElPTU1VX1JJTkdfQlVGRkVS
X1BUUl9NQVNLOwogICAgIGlmICggaGVhZCAhPSB0YWlsICkKICAgICB7Ci0gICAgICAgIG1lbWNw
eShpb21tdS0+Y21kX2J1ZmZlci5idWZmZXIgKwotICAgICAgICAgICAgICAgKGlvbW11LT5jbWRf
YnVmZmVyLnRhaWwgKiBJT01NVV9DTURfQlVGRkVSX0VOVFJZX1NJWkUpLAorICAgICAgICBtZW1j
cHkoaW9tbXUtPmNtZF9idWZmZXIuYnVmZmVyICsgaW9tbXUtPmNtZF9idWZmZXIudGFpbCwKICAg
ICAgICAgICAgICAgIGNtZCwgSU9NTVVfQ01EX0JVRkZFUl9FTlRSWV9TSVpFKTsKIAogICAgICAg
ICBpb21tdS0+Y21kX2J1ZmZlci50YWlsID0gdGFpbDsKQEAgLTQ1LDEzICs0NCwxMSBAQCBzdGF0
aWMgaW50IHF1ZXVlX2lvbW11X2NvbW1hbmQoc3RydWN0IGFtZF9pb21tdSAqaW9tbXUsIHUzMiBj
bWRbXSkKIAogc3RhdGljIHZvaWQgY29tbWl0X2lvbW11X2NvbW1hbmRfYnVmZmVyKHN0cnVjdCBh
bWRfaW9tbXUgKmlvbW11KQogewotICAgIHUzMiB0YWlsID0gMDsKLQotICAgIGlvbW11X3NldF9y
Yl9wb2ludGVyKCZ0YWlsLCBpb21tdS0+Y21kX2J1ZmZlci50YWlsKTsKLSAgICB3cml0ZWwodGFp
bCwgaW9tbXUtPm1taW9fYmFzZStJT01NVV9DTURfQlVGRkVSX1RBSUxfT0ZGU0VUKTsKKyAgICB3
cml0ZWwoaW9tbXUtPmNtZF9idWZmZXIudGFpbCwKKyAgICAgICAgICAgaW9tbXUtPm1taW9fYmFz
ZSArIElPTU1VX0NNRF9CVUZGRVJfVEFJTF9PRkZTRVQpOwogfQogCi1pbnQgc2VuZF9pb21tdV9j
b21tYW5kKHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11LCB1MzIgY21kW10pCitzdGF0aWMgaW50IHNl
bmRfaW9tbXVfY29tbWFuZChzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSwgdTMyIGNtZFtdKQogewog
ICAgIGlmICggcXVldWVfaW9tbXVfY29tbWFuZChpb21tdSwgY21kKSApCiAgICAgewpAQCAtMjYx
LDcgKzI1OCw3IEBAIHN0YXRpYyB2b2lkIGludmFsaWRhdGVfaW50ZXJydXB0X3RhYmxlKHN0cnVj
dCBhbWRfaW9tbXUgKmlvbW11LCB1MTYgZGV2aWNlX2lkKQogICAgIHNlbmRfaW9tbXVfY29tbWFu
ZChpb21tdSwgY21kKTsKIH0KIAotdm9pZCBpbnZhbGlkYXRlX2lvbW11X2FsbChzdHJ1Y3QgYW1k
X2lvbW11ICppb21tdSkKK3N0YXRpYyB2b2lkIGludmFsaWRhdGVfaW9tbXVfYWxsKHN0cnVjdCBh
bWRfaW9tbXUgKmlvbW11KQogewogICAgIHUzMiBjbWRbNF0sIGVudHJ5OwogCmRpZmYgLS1naXQg
YS94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfaW5pdC5jIGIveGVuL2RyaXZlcnMv
cGFzc3Rocm91Z2gvYW1kL2lvbW11X2luaXQuYwppbmRleCA1NTQ0ZGQ5NTA1Li5jNDJiNjA4ZjA3
IDEwMDY0NAotLS0gYS94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfaW5pdC5jCisr
KyBiL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdV9pbml0LmMKQEAgLTExNyw3ICsx
MTcsNyBAQCBzdGF0aWMgdm9pZCByZWdpc3Rlcl9pb21tdV9jbWRfYnVmZmVyX2luX21taW9fc3Bh
Y2Uoc3RydWN0IGFtZF9pb21tdSAqaW9tbXUpCiAgICAgaW9tbXVfc2V0X2FkZHJfbG9fdG9fcmVn
KCZlbnRyeSwgYWRkcl9sbyA+PiBQQUdFX1NISUZUKTsKICAgICB3cml0ZWwoZW50cnksIGlvbW11
LT5tbWlvX2Jhc2UgKyBJT01NVV9DTURfQlVGRkVSX0JBU0VfTE9XX09GRlNFVCk7CiAKLSAgICBw
b3dlcl9vZjJfZW50cmllcyA9IGdldF9vcmRlcl9mcm9tX2J5dGVzKGlvbW11LT5jbWRfYnVmZmVy
LmFsbG9jX3NpemUpICsKKyAgICBwb3dlcl9vZjJfZW50cmllcyA9IGdldF9vcmRlcl9mcm9tX2J5
dGVzKGlvbW11LT5jbWRfYnVmZmVyLnNpemUpICsKICAgICAgICAgSU9NTVVfQ01EX0JVRkZFUl9Q
T1dFUl9PRjJfRU5UUklFU19QRVJfUEFHRTsKIAogICAgIGVudHJ5ID0gMDsKQEAgLTE0NSw3ICsx
NDUsNyBAQCBzdGF0aWMgdm9pZCByZWdpc3Rlcl9pb21tdV9ldmVudF9sb2dfaW5fbW1pb19zcGFj
ZShzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSkKICAgICBpb21tdV9zZXRfYWRkcl9sb190b19yZWco
JmVudHJ5LCBhZGRyX2xvID4+IFBBR0VfU0hJRlQpOwogICAgIHdyaXRlbChlbnRyeSwgaW9tbXUt
Pm1taW9fYmFzZSArIElPTU1VX0VWRU5UX0xPR19CQVNFX0xPV19PRkZTRVQpOwogCi0gICAgcG93
ZXJfb2YyX2VudHJpZXMgPSBnZXRfb3JkZXJfZnJvbV9ieXRlcyhpb21tdS0+ZXZlbnRfbG9nLmFs
bG9jX3NpemUpICsKKyAgICBwb3dlcl9vZjJfZW50cmllcyA9IGdldF9vcmRlcl9mcm9tX2J5dGVz
KGlvbW11LT5ldmVudF9sb2cuc2l6ZSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgSU9NTVVf
RVZFTlRfTE9HX1BPV0VSX09GMl9FTlRSSUVTX1BFUl9QQUdFOwogCiAgICAgZW50cnkgPSAwOwpA
QCAtMTczLDcgKzE3Myw3IEBAIHN0YXRpYyB2b2lkIHJlZ2lzdGVyX2lvbW11X3Bwcl9sb2dfaW5f
bW1pb19zcGFjZShzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSkKICAgICBpb21tdV9zZXRfYWRkcl9s
b190b19yZWcoJmVudHJ5LCBhZGRyX2xvID4+IFBBR0VfU0hJRlQpOwogICAgIHdyaXRlbChlbnRy
eSwgaW9tbXUtPm1taW9fYmFzZSArIElPTU1VX1BQUl9MT0dfQkFTRV9MT1dfT0ZGU0VUKTsKIAot
ICAgIHBvd2VyX29mMl9lbnRyaWVzID0gZ2V0X29yZGVyX2Zyb21fYnl0ZXMoaW9tbXUtPnBwcl9s
b2cuYWxsb2Nfc2l6ZSkgKworICAgIHBvd2VyX29mMl9lbnRyaWVzID0gZ2V0X29yZGVyX2Zyb21f
Ynl0ZXMoaW9tbXUtPnBwcl9sb2cuc2l6ZSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgSU9N
TVVfUFBSX0xPR19QT1dFUl9PRjJfRU5UUklFU19QRVJfUEFHRTsKIAogICAgIGVudHJ5ID0gMDsK
QEAgLTMwMCw3ICszMDAsNyBAQCBzdGF0aWMgaW50IGlvbW11X3JlYWRfbG9nKHN0cnVjdCBhbWRf
aW9tbXUgKmlvbW11LAogICAgICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgZW50
cnlfc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9pZCAoKnBhcnNlX2Z1bmMpKHN0
cnVjdCBhbWRfaW9tbXUgKiwgdTMyICopKQogewotICAgIHUzMiB0YWlsLCBoZWFkLCAqZW50cnks
IHRhaWxfb2ZmZXN0LCBoZWFkX29mZnNldDsKKyAgICB1MzIgdGFpbCwgKmVudHJ5LCB0YWlsX29m
ZmVzdCwgaGVhZF9vZmZzZXQ7CiAKICAgICBCVUdfT04oIWlvbW11IHx8ICgobG9nICE9ICZpb21t
dS0+ZXZlbnRfbG9nKSAmJiAobG9nICE9ICZpb21tdS0+cHByX2xvZykpKTsKICAgICAKQEAgLTMx
NSwyMyArMzE1LDIxIEBAIHN0YXRpYyBpbnQgaW9tbXVfcmVhZF9sb2coc3RydWN0IGFtZF9pb21t
dSAqaW9tbXUsCiAgICAgICAgIElPTU1VX0VWRU5UX0xPR19IRUFEX09GRlNFVCA6CiAgICAgICAg
IElPTU1VX1BQUl9MT0dfSEVBRF9PRkZTRVQ7CiAKLSAgICB0YWlsID0gcmVhZGwoaW9tbXUtPm1t
aW9fYmFzZSArIHRhaWxfb2ZmZXN0KTsKLSAgICB0YWlsID0gaW9tbXVfZ2V0X3JiX3BvaW50ZXIo
dGFpbCk7CisgICAgdGFpbCA9IHJlYWRsKGlvbW11LT5tbWlvX2Jhc2UgKyB0YWlsX29mZmVzdCkg
JiBJT01NVV9SSU5HX0JVRkZFUl9QVFJfTUFTSzsKIAogICAgIHdoaWxlICggdGFpbCAhPSBsb2ct
PmhlYWQgKQogICAgIHsKICAgICAgICAgLyogcmVhZCBldmVudCBsb2cgZW50cnkgKi8KLSAgICAg
ICAgZW50cnkgPSAodTMyICopKGxvZy0+YnVmZmVyICsgbG9nLT5oZWFkICogZW50cnlfc2l6ZSk7
CisgICAgICAgIGVudHJ5ID0gbG9nLT5idWZmZXIgKyBsb2ctPmhlYWQ7CiAKICAgICAgICAgcGFy
c2VfZnVuYyhpb21tdSwgZW50cnkpOwotICAgICAgICBpZiAoICsrbG9nLT5oZWFkID09IGxvZy0+
ZW50cmllcyApCisKKyAgICAgICAgbG9nLT5oZWFkICs9IGVudHJ5X3NpemU7CisgICAgICAgIGlm
ICggbG9nLT5oZWFkID09IGxvZy0+c2l6ZSApCiAgICAgICAgICAgICBsb2ctPmhlYWQgPSAwOwog
CiAgICAgICAgIC8qIHVwZGF0ZSBoZWFkIHBvaW50ZXIgKi8KLSAgICAgICAgaGVhZCA9IDA7Ci0g
ICAgICAgIGlvbW11X3NldF9yYl9wb2ludGVyKCZoZWFkLCBsb2ctPmhlYWQpOwotCi0gICAgICAg
IHdyaXRlbChoZWFkLCBpb21tdS0+bW1pb19iYXNlICsgaGVhZF9vZmZzZXQpOworICAgICAgICB3
cml0ZWwobG9nLT5oZWFkLCBpb21tdS0+bW1pb19iYXNlICsgaGVhZF9vZmZzZXQpOwogICAgIH0K
IAogICAgIHNwaW5fdW5sb2NrKCZsb2ctPmxvY2spOwpAQCAtMTAwMCw3ICs5OTgsNyBAQCBzdGF0
aWMgdm9pZCBfX2luaXQgZGVhbGxvY2F0ZV9idWZmZXIodm9pZCAqYnVmLCB1bnNpZ25lZCBsb25n
IHN6KQogCiBzdGF0aWMgdm9pZCBfX2luaXQgZGVhbGxvY2F0ZV9yaW5nX2J1ZmZlcihzdHJ1Y3Qg
cmluZ19idWZmZXIgKnJpbmdfYnVmKQogewotICAgIGRlYWxsb2NhdGVfYnVmZmVyKHJpbmdfYnVm
LT5idWZmZXIsIHJpbmdfYnVmLT5hbGxvY19zaXplKTsKKyAgICBkZWFsbG9jYXRlX2J1ZmZlcihy
aW5nX2J1Zi0+YnVmZmVyLCByaW5nX2J1Zi0+c2l6ZSk7CiAgICAgcmluZ19idWYtPmJ1ZmZlciA9
IE5VTEw7CiAgICAgcmluZ19idWYtPmhlYWQgPSAwOwogICAgIHJpbmdfYnVmLT50YWlsID0gMDsK
QEAgLTEwMzUsMTEgKzEwMzMsOSBAQCBzdGF0aWMgdm9pZCAqX19pbml0IGFsbG9jYXRlX3Jpbmdf
YnVmZmVyKHN0cnVjdCByaW5nX2J1ZmZlciAqcmluZ19idWYsCiAgICAgcmluZ19idWYtPnRhaWwg
PSAwOwogCiAgICAgc3Bpbl9sb2NrX2luaXQoJnJpbmdfYnVmLT5sb2NrKTsKLSAgICAKLSAgICBy
aW5nX2J1Zi0+YWxsb2Nfc2l6ZSA9IFBBR0VfU0laRSA8PCBnZXRfb3JkZXJfZnJvbV9ieXRlcyhl
bnRyaWVzICoKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBlbnRyeV9zaXplKTsKLSAgICByaW5nX2J1Zi0+ZW50cmllcyA9IHJpbmdf
YnVmLT5hbGxvY19zaXplIC8gZW50cnlfc2l6ZTsKLSAgICByaW5nX2J1Zi0+YnVmZmVyID0gYWxs
b2NhdGVfYnVmZmVyKHJpbmdfYnVmLT5hbGxvY19zaXplLCBuYW1lLCBjbGVhcik7CisKKyAgICBy
aW5nX2J1Zi0+c2l6ZSA9IFBBR0VfU0laRSA8PCBnZXRfb3JkZXJfZnJvbV9ieXRlcyhlbnRyaWVz
ICogZW50cnlfc2l6ZSk7CisgICAgcmluZ19idWYtPmJ1ZmZlciA9IGFsbG9jYXRlX2J1ZmZlcihy
aW5nX2J1Zi0+c2l6ZSwgbmFtZSwgY2xlYXIpOwogCiAgICAgcmV0dXJuIHJpbmdfYnVmLT5idWZm
ZXI7CiB9Ci0tIAoyLjExLjAKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9q
ZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVu
LWRldmVs

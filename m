Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 6779411AB5B
	for <lists+xen-devel@lfdr.de>; Wed, 11 Dec 2019 13:56:30 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1if1U5-0003vn-3K; Wed, 11 Dec 2019 12:52:53 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=bHGM=2B=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1if1U4-0003vi-2v
 for xen-devel@lists.xenproject.org; Wed, 11 Dec 2019 12:52:52 +0000
X-Inumbo-ID: 1e1935a8-1c15-11ea-a914-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 1e1935a8-1c15-11ea-a914-bc764e2007e4;
 Wed, 11 Dec 2019 12:52:41 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 783B5B1B3;
 Wed, 11 Dec 2019 12:52:40 +0000 (UTC)
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
From: Jan Beulich <jbeulich@suse.com>
Message-ID: <e43e17ea-6ad0-d125-216f-4798853e3116@suse.com>
Date: Wed, 11 Dec 2019 13:53:00 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.9.1
MIME-Version: 1.0
Content-Language: en-US
Subject: [Xen-devel] [PATCH] IOMMU: make DMA containment of quarantined
 devices optional
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Kevin Tian <kevin.tian@intel.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Julien Grall <julien@xen.org>,
 Wei Liu <wl@xen.org>, Konrad Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Paul Durrant <paul@xen.org>,
 Ian Jackson <ian.jackson@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q29udGFpbmluZyBzdGlsbCBpbiBmbGlnaHQgRE1BIHdhcyBpbnRyb2R1Y2VkIHRvIHdvcmsgYXJv
dW5kIGNlcnRhaW4KZGV2aWNlcyAvIHN5c3RlbXMgaGFuZ2luZyBoYXJkIHVwb24gaGl0dGluZyBh
biBJT01NVSBmYXVsdC4gUGFzc2luZwp0aHJvdWdoIChzdWNoKSBkZXZpY2VzIChvbiBzdWNoIHN5
c3RlbXMpIGlzIGluaGVyZW50bHkgaW5zZWN1cmUgKGFzCmd1ZXN0cyBjb3VsZCBlYXNpbHkgYXJy
YW5nZSBmb3IgSU9NTVUgZmF1bHRzIHRvIG9jY3VyKS4gRGVmYXVsdGluZyB0bwphIG1vZGUgd2hl
cmUgYWRtaW5zIG1heSBub3QgZXZlbiBiZWNvbWUgYXdhcmUgb2YgaXNzdWVzIHdpdGggZGV2aWNl
cyBjYW4KYmUgY29uc2lkZXJlZCB1bmRlc2lyYWJsZS4gVGhlcmVmb3JlIGNvbnZlcnQgdGhpcyBt
b2RlIG9mIG9wZXJhdGlvbiB0bwphbiBvcHRpb25hbCBvbmUsIG5vdCBvbmUgZW5hYmxlZCBieSBk
ZWZhdWx0LgoKVGhpcyBpbnZvbHZlcyByZXN1cnJlY3RpbmcgY29kZSBjb21taXQgZWEzODg2Nzgz
MWRhICgieDg2IC8gaW9tbXU6IHNldAp1cCBhIHNjcmF0Y2ggcGFnZSBpbiB0aGUgcXVhcmFudGlu
ZSBkb21haW4iKSBkaWQgcmVtb3ZlLCBpbiBhIHNsaWdodGx5CmV4dGVuZGVkIGZhc2hpb24uIEhl
cmUsIGluc3RlYWQgb2YgcmVpbnRyb2R1Y2luZyBhIHByZXR0eSBwb2ludGxlc3MgdXNlCm9mICJn
b3RvIiBpbiBkb21haW5fY29udGV4dF91bm1hcCgpLCBhbmQgaW5zdGVhZCBvZiBtYWtpbmcgdGhl
IGZ1bmN0aW9uCihhdCBsZWFzdCB0ZW1wb3JhcmlseSkgaW5jb25zaXN0ZW50LCB0YWtlIHRoZSBv
cHBvcnR1bml0eSBhbmQgcmVwbGFjZQp0aGUgb3RoZXIgc2ltaWxhcmx5IHBvaW50bGVzcyAiZ290
byIgYXMgd2VsbC4KCkluIG9yZGVyIHRvIGtleSB0aGUgcmUtaW5zdGF0ZWQgYnlwYXNzZXMgb2Zm
IG9mIHRoZXJlIChub3QpIGJlaW5nIGEgcm9vdApwYWdlIHRhYmxlIHRoaXMgZnVydGhlciByZXF1
aXJlcyBtb3ZpbmcgdGhlIGFsbG9jYXRlX2RvbWFpbl9yZXNvdXJjZXMoKQppbnZvY2F0aW9uIGZy
b20gcmVhc3NpZ25fZGV2aWNlKCkgdG8gYW1kX2lvbW11X3NldHVwX2RvbWFpbl9kZXZpY2UoKSAo
b3IKZWxzZSByZWFzc2lnbl9kZXZpY2UoKSB3b3VsZCBhbGxvY2F0ZSBhIHJvb3QgcGFnZSB0YWJs
ZSBhbnl3YXkpOyB0aGlzIGlzCmJlbmlnbiB0byB0aGUgc2Vjb25kIGNhbGxlciBvZiB0aGUgbGF0
dGVyIGZ1bmN0aW9uLgoKU2lnbmVkLW9mZi1ieTogSmFuIEJldWxpY2ggPGpiZXVsaWNoQHN1c2Uu
Y29tPgotLS0KSSdtIGhhcHB5IHRvIHRha2UgYmV0dGVyIHN1Z2dlc3Rpb25zIHRvIHJlcGxhY2Ug
ImZ1bGwiLgoKLS0tIGEvZG9jcy9taXNjL3hlbi1jb21tYW5kLWxpbmUucGFuZG9jCisrKyBiL2Rv
Y3MvbWlzYy94ZW4tY29tbWFuZC1saW5lLnBhbmRvYwpAQCAtMTIzMiw3ICsxMjMyLDcgQEAgZGV0
ZWN0aW9uIG9mIHN5c3RlbXMga25vd24gdG8gbWlzYmVoYXZlCiA+IERlZmF1bHQ6IGBuZXdgIHVu
bGVzcyBkaXJlY3RlZC1FT0kgaXMgc3VwcG9ydGVkCiAKICMjIyBpb21tdQotICAgID0gTGlzdCBv
ZiBbIDxib29sPiwgdmVyYm9zZSwgZGVidWcsIGZvcmNlLCByZXF1aXJlZCwgcXVhcmFudGluZSwK
KyAgICA9IExpc3Qgb2YgWyA8Ym9vbD4sIHZlcmJvc2UsIGRlYnVnLCBmb3JjZSwgcmVxdWlyZWQs
IHF1YXJhbnRpbmVbPWZ1bGxdLAogICAgICAgICAgICAgICAgIHNoYXJlcHQsIGludHJlbWFwLCBp
bnRwb3N0LCBjcmFzaC1kaXNhYmxlLAogICAgICAgICAgICAgICAgIHNub29wLCBxaW52YWwsIGln
ZngsIGFtZC1pb21tdS1wZXJkZXYtaW50cmVtYXAsCiAgICAgICAgICAgICAgICAgZG9tMC17cGFz
c3Rocm91Z2gsc3RyaWN0fSBdCkBAIC0xMjcwLDExICsxMjcwLDEzIEBAIGJvb2xlYW4gKGUuZy4g
YGlvbW11PW5vYCkgY2FuIG92ZXJyaWRlIHQKICAgICB3aWxsIHByZXZlbnQgWGVuIGZyb20gYm9v
dGluZyBpZiBJT01NVXMgYXJlbid0IGRpc2NvdmVyZWQgYW5kIGVuYWJsZWQKICAgICBzdWNjZXNz
ZnVsbHkuCiAKLSogICBUaGUgYHF1YXJhbnRpbmVgIGJvb2xlYW4gY2FuIGJlIHVzZWQgdG8gY29u
dHJvbCBYZW4ncyBiZWhhdmlvciB3aGVuCi0gICAgZGUtYXNzaWduaW5nIGRldmljZXMgZnJvbSBn
dWVzdHMuICBJZiBlbmFibGVkICh0aGUgZGVmYXVsdCksIFhlbiBhbHdheXMKLSAgICBxdWFyYW50
aW5lcyBzdWNoIGRldmljZXM7IHRoZXkgbXVzdCBiZSBleHBsaWNpdGx5IGFzc2lnbmVkIGJhY2sg
dG8gRG9tMAotICAgIGJlZm9yZSB0aGV5IGNhbiBiZSB1c2VkIHRoZXJlIGFnYWluLiAgSWYgZGlz
YWJsZWQsIFhlbiB3aWxsIG9ubHkKLSAgICBxdWFyYW50aW5lIGRldmljZXMgdGhlIHRvb2xzdGFj
ayBoYXNzIGFycmFuZ2VkIGZvciBnZXR0aW5nIHF1YXJhbnRpbmVkLgorKiAgIFRoZSBgcXVhcmFu
dGluZWAgb3B0aW9uIGNhbiBiZSB1c2VkIHRvIGNvbnRyb2wgWGVuJ3MgYmVoYXZpb3Igd2hlbgor
ICAgIGRlLWFzc2lnbmluZyBkZXZpY2VzIGZyb20gZ3Vlc3RzLiAgSWYgc2V0IHRvIHRydWUgKHRo
ZSBkZWZhdWx0KSwgWGVuCisgICAgYWx3YXlzIHF1YXJhbnRpbmVzIHN1Y2ggZGV2aWNlczsgdGhl
eSBtdXN0IGJlIGV4cGxpY2l0bHkgYXNzaWduZWQgYmFjaworICAgIHRvIERvbTAgYmVmb3JlIHRo
ZXkgY2FuIGJlIHVzZWQgdGhlcmUgYWdhaW4uICBJZiBzZXQgdG8gImZ1bGwiLCBzdGlsbAorICAg
IGFjdGl2ZSBETUEgd2lsbCBhZGRpdGlvbmFsbHkgYmUgZGlyZWN0ZWQgdG8gYSAic2luayIgcGFn
ZS4gIElmIHNldCB0bworICAgIGZhbHNlLCBYZW4gd2lsbCBvbmx5IHF1YXJhbnRpbmUgZGV2aWNl
cyB0aGUgdG9vbHN0YWNrIGhhcyBhcnJhbmdlZCBmb3IKKyAgICBnZXR0aW5nIHF1YXJhbnRpbmVk
LgogCiAqICAgVGhlIGBzaGFyZXB0YCBib29sZWFuIGNvbnRyb2xzIHdoZXRoZXIgdGhlIElPTU1V
IHBhZ2V0YWJsZXMgYXJlIHNoYXJlZAogICAgIHdpdGggdGhlIENQVS1zaWRlIEhBUCBwYWdldGFi
bGVzLCBvciBhbGxvY2F0ZWQgc2VwYXJhdGVseS4gIFNoYXJpbmcKLS0tIGEveGVuL2RyaXZlcnMv
cGFzc3Rocm91Z2gvYW1kL3BjaV9hbWRfaW9tbXUuYworKysgYi94ZW4vZHJpdmVycy9wYXNzdGhy
b3VnaC9hbWQvcGNpX2FtZF9pb21tdS5jCkBAIC04NSwxOCArODUsMzYgQEAgaW50IGdldF9kbWFf
cmVxdWVzdG9yX2lkKHVpbnQxNl90IHNlZywgdQogICAgIHJldHVybiByZXFfaWQ7CiB9CiAKLXN0
YXRpYyB2b2lkIGFtZF9pb21tdV9zZXR1cF9kb21haW5fZGV2aWNlKAorc3RhdGljIGludCBfX211
c3RfY2hlY2sgYWxsb2NhdGVfZG9tYWluX3Jlc291cmNlcyhzdHJ1Y3QgZG9tYWluX2lvbW11ICpo
ZCkKK3sKKyAgICBpbnQgcmM7CisKKyAgICBzcGluX2xvY2soJmhkLT5hcmNoLm1hcHBpbmdfbG9j
ayk7CisgICAgcmMgPSBhbWRfaW9tbXVfYWxsb2Nfcm9vdChoZCk7CisgICAgc3Bpbl91bmxvY2so
JmhkLT5hcmNoLm1hcHBpbmdfbG9jayk7CisKKyAgICByZXR1cm4gcmM7Cit9CisKK3N0YXRpYyBp
bnQgX19tdXN0X2NoZWNrIGFtZF9pb21tdV9zZXR1cF9kb21haW5fZGV2aWNlKAogICAgIHN0cnVj
dCBkb21haW4gKmRvbWFpbiwgc3RydWN0IGFtZF9pb21tdSAqaW9tbXUsCiAgICAgdWludDhfdCBk
ZXZmbiwgc3RydWN0IHBjaV9kZXYgKnBkZXYpCiB7CiAgICAgc3RydWN0IGFtZF9pb21tdV9kdGUg
KnRhYmxlLCAqZHRlOwogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7Ci0gICAgaW50IHJlcV9pZCwg
dmFsaWQgPSAxOworICAgIGludCByZXFfaWQsIHZhbGlkID0gMSwgcmM7CiAgICAgdTggYnVzID0g
cGRldi0+YnVzOwotICAgIGNvbnN0IHN0cnVjdCBkb21haW5faW9tbXUgKmhkID0gZG9tX2lvbW11
KGRvbWFpbik7CisgICAgc3RydWN0IGRvbWFpbl9pb21tdSAqaGQgPSBkb21faW9tbXUoZG9tYWlu
KTsKKworICAgIC8qIGRvbV9pbyBpcyB1c2VkIGFzIGEgc2VudGluZWwgZm9yIHF1YXJhbnRpbmVk
IGRldmljZXMgKi8KKyAgICBpZiAoIGRvbWFpbiA9PSBkb21faW8gJiYgIWhkLT5hcmNoLnJvb3Rf
dGFibGUgKQorICAgICAgICByZXR1cm4gMDsKKworICAgIEJVR19PTighaGQtPmFyY2gucGFnaW5n
X21vZGUgfHwgIWlvbW11LT5kZXZfdGFibGUuYnVmZmVyKTsKIAotICAgIEJVR19PTiggIWhkLT5h
cmNoLnJvb3RfdGFibGUgfHwgIWhkLT5hcmNoLnBhZ2luZ19tb2RlIHx8Ci0gICAgICAgICAgICAh
aW9tbXUtPmRldl90YWJsZS5idWZmZXIgKTsKKyAgICByYyA9IGFsbG9jYXRlX2RvbWFpbl9yZXNv
dXJjZXMoaGQpOworICAgIGlmICggcmMgKQorICAgICAgICByZXR1cm4gcmM7CiAKICAgICBpZiAo
IGlvbW11X2h3ZG9tX3Bhc3N0aHJvdWdoICYmIGlzX2hhcmR3YXJlX2RvbWFpbihkb21haW4pICkK
ICAgICAgICAgdmFsaWQgPSAwOwpAQCAtMTUxLDYgKzE2OSw4IEBAIHN0YXRpYyB2b2lkIGFtZF9p
b21tdV9zZXR1cF9kb21haW5fZGV2aWMKIAogICAgICAgICBhbWRfaW9tbXVfZmx1c2hfaW90bGIo
ZGV2Zm4sIHBkZXYsIElOVl9JT01NVV9BTExfUEFHRVNfQUREUkVTUywgMCk7CiAgICAgfQorCisg
ICAgcmV0dXJuIDA7CiB9CiAKIGludCBfX2luaXQgYWNwaV9pdnJzX2luaXQodm9pZCkKQEAgLTIy
MCwxNyArMjQwLDYgQEAgaW50IGFtZF9pb21tdV9hbGxvY19yb290KHN0cnVjdCBkb21haW5faQog
ICAgIHJldHVybiAwOwogfQogCi1zdGF0aWMgaW50IF9fbXVzdF9jaGVjayBhbGxvY2F0ZV9kb21h
aW5fcmVzb3VyY2VzKHN0cnVjdCBkb21haW5faW9tbXUgKmhkKQotewotICAgIGludCByYzsKLQot
ICAgIHNwaW5fbG9jaygmaGQtPmFyY2gubWFwcGluZ19sb2NrKTsKLSAgICByYyA9IGFtZF9pb21t
dV9hbGxvY19yb290KGhkKTsKLSAgICBzcGluX3VubG9jaygmaGQtPmFyY2gubWFwcGluZ19sb2Nr
KTsKLQotICAgIHJldHVybiByYzsKLX0KLQogaW50IGFtZF9pb21tdV9nZXRfcGFnaW5nX21vZGUo
dW5zaWduZWQgbG9uZyBlbnRyaWVzKQogewogICAgIGludCBsZXZlbCA9IDE7CkBAIC0yODcsNiAr
Mjk2LDEwIEBAIHN0YXRpYyB2b2lkIGFtZF9pb21tdV9kaXNhYmxlX2RvbWFpbl9kZXYKICAgICBp
bnQgcmVxX2lkOwogICAgIHU4IGJ1cyA9IHBkZXYtPmJ1czsKIAorICAgIC8qIGRvbV9pbyBpcyB1
c2VkIGFzIGEgc2VudGluZWwgZm9yIHF1YXJhbnRpbmVkIGRldmljZXMgKi8KKyAgICBpZiAoIGRv
bWFpbiA9PSBkb21faW8gJiYgIWRvbV9pb21tdShkb21haW4pLT5hcmNoLnJvb3RfdGFibGUgKQor
ICAgICAgICByZXR1cm47CisKICAgICBCVUdfT04gKCBpb21tdS0+ZGV2X3RhYmxlLmJ1ZmZlciA9
PSBOVUxMICk7CiAgICAgcmVxX2lkID0gZ2V0X2RtYV9yZXF1ZXN0b3JfaWQoaW9tbXUtPnNlZywg
UENJX0JERjIoYnVzLCBkZXZmbikpOwogICAgIHRhYmxlID0gaW9tbXUtPmRldl90YWJsZS5idWZm
ZXI7CkBAIC0zMzMsNyArMzQ2LDYgQEAgc3RhdGljIGludCByZWFzc2lnbl9kZXZpY2Uoc3RydWN0
IGRvbWFpbgogewogICAgIHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11OwogICAgIGludCBiZGYsIHJj
OwotICAgIHN0cnVjdCBkb21haW5faW9tbXUgKnQgPSBkb21faW9tbXUodGFyZ2V0KTsKIAogICAg
IGJkZiA9IFBDSV9CREYyKHBkZXYtPmJ1cywgcGRldi0+ZGV2Zm4pOwogICAgIGlvbW11ID0gZmlu
ZF9pb21tdV9mb3JfZGV2aWNlKHBkZXYtPnNlZywgYmRmKTsKQEAgLTM1NCwxMSArMzY2LDEwIEBA
IHN0YXRpYyBpbnQgcmVhc3NpZ25fZGV2aWNlKHN0cnVjdCBkb21haW4KICAgICAgICAgcGRldi0+
ZG9tYWluID0gdGFyZ2V0OwogICAgIH0KIAotICAgIHJjID0gYWxsb2NhdGVfZG9tYWluX3Jlc291
cmNlcyh0KTsKKyAgICByYyA9IGFtZF9pb21tdV9zZXR1cF9kb21haW5fZGV2aWNlKHRhcmdldCwg
aW9tbXUsIGRldmZuLCBwZGV2KTsKICAgICBpZiAoIHJjICkKICAgICAgICAgcmV0dXJuIHJjOwog
Ci0gICAgYW1kX2lvbW11X3NldHVwX2RvbWFpbl9kZXZpY2UodGFyZ2V0LCBpb21tdSwgZGV2Zm4s
IHBkZXYpOwogICAgIEFNRF9JT01NVV9ERUJVRygiUmUtYXNzaWduICUwNHg6JTAyeDolMDJ4LiV1
IGZyb20gZG9tJWQgdG8gZG9tJWRcbiIsCiAgICAgICAgICAgICAgICAgICAgIHBkZXYtPnNlZywg
cGRldi0+YnVzLCBQQ0lfU0xPVChkZXZmbiksIFBDSV9GVU5DKGRldmZuKSwKICAgICAgICAgICAg
ICAgICAgICAgc291cmNlLT5kb21haW5faWQsIHRhcmdldC0+ZG9tYWluX2lkKTsKQEAgLTUxNSw4
ICs1MjYsNyBAQCBzdGF0aWMgaW50IGFtZF9pb21tdV9hZGRfZGV2aWNlKHU4IGRldmZuCiAgICAg
ICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmlvbW11LT5sb2NrLCBmbGFncyk7CiAgICAgfQog
Ci0gICAgYW1kX2lvbW11X3NldHVwX2RvbWFpbl9kZXZpY2UocGRldi0+ZG9tYWluLCBpb21tdSwg
ZGV2Zm4sIHBkZXYpOwotICAgIHJldHVybiAwOworICAgIHJldHVybiBhbWRfaW9tbXVfc2V0dXBf
ZG9tYWluX2RldmljZShwZGV2LT5kb21haW4sIGlvbW11LCBkZXZmbiwgcGRldik7CiB9CiAKIHN0
YXRpYyBpbnQgYW1kX2lvbW11X3JlbW92ZV9kZXZpY2UodTggZGV2Zm4sIHN0cnVjdCBwY2lfZGV2
ICpwZGV2KQotLS0gYS94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9pb21tdS5jCisrKyBiL3hlbi9k
cml2ZXJzL3Bhc3N0aHJvdWdoL2lvbW11LmMKQEAgLTMwLDEzICszMCwxNyBAQCBib29sX3QgX19p
bml0ZGF0YSBpb21tdV9lbmFibGUgPSAxOwogYm9vbF90IF9fcmVhZF9tb3N0bHkgaW9tbXVfZW5h
YmxlZDsKIGJvb2xfdCBfX3JlYWRfbW9zdGx5IGZvcmNlX2lvbW11OwogYm9vbF90IF9fcmVhZF9t
b3N0bHkgaW9tbXVfdmVyYm9zZTsKLWJvb2wgX19yZWFkX21vc3RseSBpb21tdV9xdWFyYW50aW5l
ID0gdHJ1ZTsKIGJvb2xfdCBfX3JlYWRfbW9zdGx5IGlvbW11X2lnZnggPSAxOwogYm9vbF90IF9f
cmVhZF9tb3N0bHkgaW9tbXVfc25vb3AgPSAxOwogYm9vbF90IF9fcmVhZF9tb3N0bHkgaW9tbXVf
cWludmFsID0gMTsKIGJvb2xfdCBfX3JlYWRfbW9zdGx5IGlvbW11X2ludHJlbWFwID0gMTsKIGJv
b2xfdCBfX3JlYWRfbW9zdGx5IGlvbW11X2NyYXNoX2Rpc2FibGU7CiAKKyNkZWZpbmUgSU9NTVVf
cXVhcmFudGluZV9ub25lICBmYWxzZQorI2RlZmluZSBJT01NVV9xdWFyYW50aW5lX2Jhc2ljIHRy
dWUKKyNkZWZpbmUgSU9NTVVfcXVhcmFudGluZV9mdWxsICAyCit1aW50OF90IF9fcmVhZF9tb3N0
bHkgaW9tbXVfcXVhcmFudGluZSA9IElPTU1VX3F1YXJhbnRpbmVfYmFzaWM7CisKIHN0YXRpYyBi
b29sIF9faHdkb21faW5pdGRhdGEgaW9tbXVfaHdkb21fbm9uZTsKIGJvb2wgX19od2RvbV9pbml0
ZGF0YSBpb21tdV9od2RvbV9zdHJpY3Q7CiBib29sIF9fcmVhZF9tb3N0bHkgaW9tbXVfaHdkb21f
cGFzc3Rocm91Z2g7CkBAIC04MSw2ICs4NSw4IEBAIHN0YXRpYyBpbnQgX19pbml0IHBhcnNlX2lv
bW11X3BhcmFtKGNvbnMKICAgICAgICAgICAgIGZvcmNlX2lvbW11ID0gdmFsOwogICAgICAgICBl
bHNlIGlmICggKHZhbCA9IHBhcnNlX2Jvb2xlYW4oInF1YXJhbnRpbmUiLCBzLCBzcykpID49IDAg
KQogICAgICAgICAgICAgaW9tbXVfcXVhcmFudGluZSA9IHZhbDsKKyAgICAgICAgZWxzZSBpZiAo
IHNzID09IHMgKyAxNSAmJiAhc3RybmNtcChzLCAicXVhcmFudGluZT1mdWxsIiwgMTUpICkKKyAg
ICAgICAgICAgIGlvbW11X3F1YXJhbnRpbmUgPSBJT01NVV9xdWFyYW50aW5lX2Z1bGw7CiAgICAg
ICAgIGVsc2UgaWYgKCAodmFsID0gcGFyc2VfYm9vbGVhbigiaWdmeCIsIHMsIHNzKSkgPj0gMCAp
CiAgICAgICAgICAgICBpb21tdV9pZ2Z4ID0gdmFsOwogICAgICAgICBlbHNlIGlmICggKHZhbCA9
IHBhcnNlX2Jvb2xlYW4oInZlcmJvc2UiLCBzLCBzcykpID49IDAgKQpAQCAtNDUxLDcgKzQ1Nyw3
IEBAIHN0YXRpYyBpbnQgX19pbml0IGlvbW11X3F1YXJhbnRpbmVfaW5pdCgKICAgICBkb21faW8t
Pm9wdGlvbnMgfD0gWEVOX0RPTUNUTF9DREZfaW9tbXU7CiAKICAgICByYyA9IGlvbW11X2RvbWFp
bl9pbml0KGRvbV9pbywgMCk7Ci0gICAgaWYgKCByYyApCisgICAgaWYgKCByYyB8fCBpb21tdV9x
dWFyYW50aW5lIDwgSU9NTVVfcXVhcmFudGluZV9mdWxsICkKICAgICAgICAgcmV0dXJuIHJjOwog
CiAgICAgaWYgKCAhaGQtPnBsYXRmb3JtX29wcy0+cXVhcmFudGluZV9pbml0ICkKLS0tIGEveGVu
L2RyaXZlcnMvcGFzc3Rocm91Z2gvdnRkL2lvbW11LmMKKysrIGIveGVuL2RyaXZlcnMvcGFzc3Ro
cm91Z2gvdnRkL2lvbW11LmMKQEAgLTEyOTEsNiArMTI5MSwxMCBAQCBpbnQgZG9tYWluX2NvbnRl
eHRfbWFwcGluZ19vbmUoCiAgICAgaW50IGFnYXcsIHJjLCByZXQ7CiAgICAgYm9vbF90IGZsdXNo
X2Rldl9pb3RsYjsKIAorICAgIC8qIGRvbV9pbyBpcyB1c2VkIGFzIGEgc2VudGluZWwgZm9yIHF1
YXJhbnRpbmVkIGRldmljZXMgKi8KKyAgICBpZiAoIGRvbWFpbiA9PSBkb21faW8gJiYgIWhkLT5h
cmNoLnBnZF9tYWRkciApCisgICAgICAgIHJldHVybiAwOworCiAgICAgQVNTRVJUKHBjaWRldnNf
bG9ja2VkKCkpOwogICAgIHNwaW5fbG9jaygmaW9tbXUtPmxvY2spOwogICAgIG1hZGRyID0gYnVz
X3RvX2NvbnRleHRfbWFkZHIoaW9tbXUsIGJ1cyk7CkBAIC0xNTM3LDYgKzE1NDEsMTAgQEAgaW50
IGRvbWFpbl9jb250ZXh0X3VubWFwX29uZSgKICAgICBpbnQgaW9tbXVfZG9taWQsIHJjLCByZXQ7
CiAgICAgYm9vbF90IGZsdXNoX2Rldl9pb3RsYjsKIAorICAgIC8qIGRvbV9pbyBpcyB1c2VkIGFz
IGEgc2VudGluZWwgZm9yIHF1YXJhbnRpbmVkIGRldmljZXMgKi8KKyAgICBpZiAoIGRvbWFpbiA9
PSBkb21faW8gJiYgIWRvbV9pb21tdShkb21haW4pLT5hcmNoLnBnZF9tYWRkciApCisgICAgICAg
IHJldHVybiAwOworCiAgICAgQVNTRVJUKHBjaWRldnNfbG9ja2VkKCkpOwogICAgIHNwaW5fbG9j
aygmaW9tbXUtPmxvY2spOwogCkBAIC0xNTk4LDcgKzE2MDYsNyBAQCBzdGF0aWMgaW50IGRvbWFp
bl9jb250ZXh0X3VubWFwKHN0cnVjdCBkCiB7CiAgICAgc3RydWN0IGFjcGlfZHJoZF91bml0ICpk
cmhkOwogICAgIHN0cnVjdCB2dGRfaW9tbXUgKmlvbW11OwotICAgIGludCByZXQgPSAwOworICAg
IGludCByZXQ7CiAgICAgdTggc2VnID0gcGRldi0+c2VnLCBidXMgPSBwZGV2LT5idXMsIHRtcF9i
dXMsIHRtcF9kZXZmbiwgc2VjYnVzOwogICAgIGludCBmb3VuZCA9IDA7CiAKQEAgLTE2MTQsMTQg
KzE2MjIsMTIgQEAgc3RhdGljIGludCBkb21haW5fY29udGV4dF91bm1hcChzdHJ1Y3QgZAogICAg
ICAgICAgICAgcHJpbnRrKFZURFBSRUZJWCAiZCVkOkhvc3RicmlkZ2U6IHNraXAgJTA0eDolMDJ4
OiUwMnguJXUgdW5tYXBcbiIsCiAgICAgICAgICAgICAgICAgICAgZG9tYWluLT5kb21haW5faWQs
IHNlZywgYnVzLAogICAgICAgICAgICAgICAgICAgIFBDSV9TTE9UKGRldmZuKSwgUENJX0ZVTkMo
ZGV2Zm4pKTsKLSAgICAgICAgaWYgKCAhaXNfaGFyZHdhcmVfZG9tYWluKGRvbWFpbikgKQotICAg
ICAgICAgICAgcmV0dXJuIC1FUEVSTTsKLSAgICAgICAgZ290byBvdXQ7CisgICAgICAgIHJldHVy
biBpc19oYXJkd2FyZV9kb21haW4oZG9tYWluKSA/IDAgOiAtRVBFUk07CiAKICAgICBjYXNlIERF
Vl9UWVBFX1BDSWVfQlJJREdFOgogICAgIGNhc2UgREVWX1RZUEVfUENJZTJQQ0lfQlJJREdFOgog
ICAgIGNhc2UgREVWX1RZUEVfTEVHQUNZX1BDSV9CUklER0U6Ci0gICAgICAgIGdvdG8gb3V0Owor
ICAgICAgICByZXR1cm4gMDsKIAogICAgIGNhc2UgREVWX1RZUEVfUENJZV9FTkRQT0lOVDoKICAg
ICAgICAgaWYgKCBpb21tdV9kZWJ1ZyApCkBAIC0xNjY1LDEwICsxNjcxLDEzIEBAIHN0YXRpYyBp
bnQgZG9tYWluX2NvbnRleHRfdW5tYXAoc3RydWN0IGQKICAgICAgICAgZHByaW50ayhYRU5MT0df
RVJSIFZURFBSRUZJWCwgImQlZDp1bmtub3duKCV1KTogJTA0eDolMDJ4OiUwMnguJXVcbiIsCiAg
ICAgICAgICAgICAgICAgZG9tYWluLT5kb21haW5faWQsIHBkZXYtPnR5cGUsCiAgICAgICAgICAg
ICAgICAgc2VnLCBidXMsIFBDSV9TTE9UKGRldmZuKSwgUENJX0ZVTkMoZGV2Zm4pKTsKLSAgICAg
ICAgcmV0ID0gLUVJTlZBTDsKLSAgICAgICAgZ290byBvdXQ7CisgICAgICAgIHJldHVybiAtRUlO
VkFMOwogICAgIH0KIAorICAgIC8qIGRvbV9pbyBpcyB1c2VkIGFzIGEgc2VudGluZWwgZm9yIHF1
YXJhbnRpbmVkIGRldmljZXMgKi8KKyAgICBpZiAoIGRvbWFpbiA9PSBkb21faW8gJiYgIWRvbV9p
b21tdShkb21haW4pLT5hcmNoLnBnZF9tYWRkciApCisgICAgICAgIHJldHVybiByZXQ7CisKICAg
ICAvKgogICAgICAqIGlmIG5vIG90aGVyIGRldmljZXMgdW5kZXIgdGhlIHNhbWUgaW9tbXUgb3du
ZWQgYnkgdGhpcyBkb21haW4sCiAgICAgICogY2xlYXIgaW9tbXUgaW4gaW9tbXVfYml0bWFwIGFu
ZCBjbGVhciBkb21haW5faWQgaW4gZG9taWRfYml0bXAKQEAgLTE2OTQsMTYgKzE3MDMsMTIgQEAg
c3RhdGljIGludCBkb21haW5fY29udGV4dF91bm1hcChzdHJ1Y3QgZAogCiAgICAgICAgIGlvbW11
X2RvbWlkID0gZG9tYWluX2lvbW11X2RvbWlkKGRvbWFpbiwgaW9tbXUpOwogICAgICAgICBpZiAo
IGlvbW11X2RvbWlkID09IC0xICkKLSAgICAgICAgewotICAgICAgICAgICAgcmV0ID0gLUVJTlZB
TDsKLSAgICAgICAgICAgIGdvdG8gb3V0OwotICAgICAgICB9CisgICAgICAgICAgICByZXR1cm4g
LUVJTlZBTDsKIAogICAgICAgICBjbGVhcl9iaXQoaW9tbXVfZG9taWQsIGlvbW11LT5kb21pZF9i
aXRtYXApOwogICAgICAgICBpb21tdS0+ZG9taWRfbWFwW2lvbW11X2RvbWlkXSA9IDA7CiAgICAg
fQogCi1vdXQ6CiAgICAgcmV0dXJuIHJldDsKIH0KIAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vaW9t
bXUuaAorKysgYi94ZW4vaW5jbHVkZS94ZW4vaW9tbXUuaApAQCAtNTMsOCArNTMsOSBAQCBzdGF0
aWMgaW5saW5lIGJvb2xfdCBkZm5fZXEoZGZuX3QgeCwgZGZuCiB9CiAKIGV4dGVybiBib29sX3Qg
aW9tbXVfZW5hYmxlLCBpb21tdV9lbmFibGVkOwotZXh0ZXJuIGJvb2wgZm9yY2VfaW9tbXUsIGlv
bW11X3F1YXJhbnRpbmUsIGlvbW11X3ZlcmJvc2UsIGlvbW11X2lnZng7CitleHRlcm4gYm9vbCBm
b3JjZV9pb21tdSwgaW9tbXVfdmVyYm9zZSwgaW9tbXVfaWdmeDsKIGV4dGVybiBib29sX3QgaW9t
bXVfc25vb3AsIGlvbW11X3FpbnZhbCwgaW9tbXVfaW50cmVtYXAsIGlvbW11X2ludHBvc3Q7Citl
eHRlcm4gdWludDhfdCBpb21tdV9xdWFyYW50aW5lOwogCiAjaWYgZGVmaW5lZChDT05GSUdfSU9N
TVVfRk9SQ0VfUFRfU0hBUkUpCiAjZGVmaW5lIGlvbW11X2hhcF9wdF9zaGFyZSB0cnVlCgpfX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFp
bGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhl
bnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

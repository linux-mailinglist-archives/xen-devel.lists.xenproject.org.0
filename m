Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 46627789D6
	for <lists+xen-devel@lfdr.de>; Mon, 29 Jul 2019 12:53:00 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hs3DS-00083J-39; Mon, 29 Jul 2019 10:49:18 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=+N/T=V2=suse.com=dfaggioli@srs-us1.protection.inumbo.net>)
 id 1hs3DQ-00083E-0G
 for xen-devel@lists.xenproject.org; Mon, 29 Jul 2019 10:49:16 +0000
X-Inumbo-ID: 7f6388a4-b1ee-11e9-b5e3-cbf56ce58823
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 7f6388a4-b1ee-11e9-b5e3-cbf56ce58823;
 Mon, 29 Jul 2019 10:49:11 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 88E91B616;
 Mon, 29 Jul 2019 10:49:10 +0000 (UTC)
From: Dario Faggioli <dfaggioli@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 29 Jul 2019 12:49:09 +0200
Message-ID: <156439734950.9656.3257482583234913248.stgit@Palanthas>
User-Agent: StGit/0.17.1-dirty
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2] xen: credit2: avoid using cpumask_weight()
 in hot-paths
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Andrii Anisov <andrii.anisov@gmail.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Y3B1bWFza193ZWlnaHQoKSBpcyBrbm93biB0byBiZSBleHBlbnNpdmUuIEluIENyZWRpdDIsIHdl
IHVzZSBpdCBpbgpsb2FkLWJhbGFuY2luZywgYnV0IG9ubHkgZm9yIGtub3dpbmcgaG93IG1hbnkg
Q1BVcyBhcmUgYWN0aXZlIGluIGEKcnVucXVldWUuCgpLZWVwaW5nIHN1Y2ggY291bnQgaW4gYW4g
aW50ZWdlciBmaWVsZCBvZiB0aGUgcGVyLXJ1bnF1ZXVlIGRhdGEKc3RydWN0dXJlIHdlIGhhdmUs
IGNvbXBsZXRlbHkgYXZvaWRzIHRoZSBuZWVkIGZvciBjcHVtYXNrX3dlaWdodCgpLgoKV2hpbGUg
dGhlcmUsIHJlbW92ZSBhcyBtdWNoIG90aGVyIHVzZXMgb2YgaXQgYXMgd2UgY2FuLCBldmVuIGlm
IG5vdCBpbgpob3QtcGF0aHMuCgpTaWduZWQtb2ZmLWJ5OiBEYXJpbyBGYWdnaW9saSA8ZGZhZ2dp
b2xpQHN1c2UuY29tPgotLS0KQ2M6IEdlb3JnZSBEdW5sYXAgPGdlb3JnZS5kdW5sYXBAZXUuY2l0
cml4LmNvbT4KQ2M6IEFuZHJldyBDb29wZXIgPGFuZHJldy5jb29wZXIzQGNpdHJpeC5jb20+CkNj
OiBBbmRyaWkgQW5pc292IDxhbmRyaWkuYW5pc292QGdtYWlsLmNvbT4KLS0tCkkganVzdCByZWFs
aXplZCB0aGlzIHBhdGNoIGZlbGwgdGhyb3VnaCB0aGUgY3JhY2tzISA6LU8KCkkgc2VudCBpdCBx
dWl0ZSBhIHdoaWxlIGFnbywgSSBnb3Qgc29tZSBjb21tZW50cyBmcm9tIEFuZHJldyBhbmQKQW5k
cmlpLCBidXQgdGhlbiBuZXZlciByZWFsbHkgZm9sbG93ZWQgdXAuCgpTbyBoZXJlIHdlIGhhcmUh
CgpDaGFuZ2VzIGZyb20gdjE6CiogbnJfY3B1cyBpcyBub3cgdW5zaWduZWQKKiBjb2Rpbmcgc3R5
bGUgKG5vIGhhcmQgdGFicykKKiBraWxsZWQgYSBjb3VwbGUgb2YgcmVkdW5kYW50IEFTU0VSVCgp
cwotLS0KIHhlbi9jb21tb24vc2NoZWRfY3JlZGl0Mi5jIHwgICAxOSArKysrKysrKysrKysrLS0t
LS0tCiAxIGZpbGUgY2hhbmdlZCwgMTMgaW5zZXJ0aW9ucygrKSwgNiBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdDIuYyBiL3hlbi9jb21tb24vc2NoZWRf
Y3JlZGl0Mi5jCmluZGV4IDhlNDM4MWQ4YTcuLmZiZGM0NjE4Y2IgMTAwNjQ0Ci0tLSBhL3hlbi9j
b21tb24vc2NoZWRfY3JlZGl0Mi5jCisrKyBiL3hlbi9jb21tb24vc2NoZWRfY3JlZGl0Mi5jCkBA
IC00NjYsNiArNDY2LDcgQEAgc3RydWN0IGNzY2hlZDJfcnVucXVldWVfZGF0YSB7CiAgICAgc3Bp
bmxvY2tfdCBsb2NrOyAgICAgICAgICAgLyogTG9jayBmb3IgdGhpcyBydW5xdWV1ZSAgICAgICAg
ICAgICAgICAgICAgICovCiAKICAgICBzdHJ1Y3QgbGlzdF9oZWFkIHJ1bnE7ICAgICAvKiBPcmRl
cmVkIGxpc3Qgb2YgcnVubmFibGUgdm1zICAgICAgICAgICAgICAgKi8KKyAgICB1bnNpZ25lZCBp
bnQgbnJfY3B1czsgICAgICAvKiBIb3cgbWFueSBDUFVzIGFyZSBzaGFyaW5nIHRoaXMgcnVucXVl
dWUgICAgKi8KICAgICBpbnQgaWQ7ICAgICAgICAgICAgICAgICAgICAvKiBJRCBvZiB0aGlzIHJ1
bnF1ZXVlICgtMSBpZiBpbnZhbGlkKSAgICAgICAgKi8KIAogICAgIGludCBsb2FkOyAgICAgICAg
ICAgICAgICAgIC8qIEluc3RhbnRhbmVvdXMgbG9hZCAobnVtIG9mIG5vbi1pZGxlIHZjcHVzKSAq
LwpAQCAtMjYxMyw4ICsyNjE0LDggQEAgcmV0cnk6CiAgICAgICAgIGlmICggc3Qub3JxZC0+Yl9h
dmdsb2FkID4gbG9hZF9tYXggKQogICAgICAgICAgICAgbG9hZF9tYXggPSBzdC5vcnFkLT5iX2F2
Z2xvYWQ7CiAKLSAgICAgICAgY3B1c19tYXggPSBjcHVtYXNrX3dlaWdodCgmc3QubHJxZC0+YWN0
aXZlKTsKLSAgICAgICAgaSA9IGNwdW1hc2tfd2VpZ2h0KCZzdC5vcnFkLT5hY3RpdmUpOworICAg
ICAgICBjcHVzX21heCA9IHN0LmxycWQtPm5yX2NwdXM7CisgICAgICAgIGkgPSBzdC5vcnFkLT5u
cl9jcHVzOwogICAgICAgICBpZiAoIGkgPiBjcHVzX21heCApCiAgICAgICAgICAgICBjcHVzX21h
eCA9IGk7CiAKQEAgLTM2OTcsNyArMzY5OCw3IEBAIGNzY2hlZDJfZHVtcChjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMpCiAgICAgICAgICAgICAgICAiXHRpbnN0bG9hZCAgICAgICAgICAgPSAl
ZFxuIgogICAgICAgICAgICAgICAgIlx0YXZlbG9hZCAgICAgICAgICAgID0gJSJQUklfc3RpbWUi
ICh+JSJQUklfc3RpbWUiJSUpXG4iLAogICAgICAgICAgICAgICAgaSwKLSAgICAgICAgICAgICAg
IGNwdW1hc2tfd2VpZ2h0KCZwcnYtPnJxZFtpXS5hY3RpdmUpLAorICAgICAgICAgICAgICAgcHJ2
LT5ycWRbaV0ubnJfY3B1cywKICAgICAgICAgICAgICAgIG5yX2NwdV9pZHMsIGNwdW1hc2tfYml0
cygmcHJ2LT5ycWRbaV0uYWN0aXZlKSwKICAgICAgICAgICAgICAgIHBydi0+cnFkW2ldLm1heF93
ZWlnaHQsCiAgICAgICAgICAgICAgICBwcnYtPnJxZFtpXS5waWNrX2JpYXMsCkBAIC0zODE1LDcg
KzM4MTYsNyBAQCBpbml0X3BkYXRhKHN0cnVjdCBjc2NoZWQyX3ByaXZhdGUgKnBydiwgc3RydWN0
IGNzY2hlZDJfcGNwdSAqc3BjLAogCiAgICAgX19jcHVtYXNrX3NldF9jcHUoY3B1LCAmc3BjLT5z
aWJsaW5nX21hc2spOwogCi0gICAgaWYgKCBjcHVtYXNrX3dlaWdodCgmcnFkLT5hY3RpdmUpID4g
MCApCisgICAgaWYgKCBycWQtPm5yX2NwdXMgPiAwICkKICAgICAgICAgZm9yX2VhY2hfY3B1ICgg
cmNwdSwgcGVyX2NwdShjcHVfc2libGluZ19tYXNrLCBjcHUpICkKICAgICAgICAgICAgIGlmICgg
Y3B1bWFza190ZXN0X2NwdShyY3B1LCAmcnFkLT5hY3RpdmUpICkKICAgICAgICAgICAgIHsKQEAg
LTM4MjgsNyArMzgyOSwxMCBAQCBpbml0X3BkYXRhKHN0cnVjdCBjc2NoZWQyX3ByaXZhdGUgKnBy
diwgc3RydWN0IGNzY2hlZDJfcGNwdSAqc3BjLAogICAgIF9fY3B1bWFza19zZXRfY3B1KGNwdSwg
JnBydi0+aW5pdGlhbGl6ZWQpOwogICAgIF9fY3B1bWFza19zZXRfY3B1KGNwdSwgJnJxZC0+c210
X2lkbGUpOwogCi0gICAgaWYgKCBjcHVtYXNrX3dlaWdodCgmcnFkLT5hY3RpdmUpID09IDEgKQor
ICAgIHJxZC0+bnJfY3B1cysrOworICAgIEFTU0VSVChjcHVtYXNrX3dlaWdodCgmcnFkLT5hY3Rp
dmUpID09IHJxZC0+bnJfY3B1cyk7CisKKyAgICBpZiAoIHJxZC0+bnJfY3B1cyA9PSAxICkKICAg
ICAgICAgcnFkLT5waWNrX2JpYXMgPSBjcHU7CiAKICAgICByZXR1cm4gc3BjLT5ydW5xX2lkOwpA
QCAtMzkzNCw3ICszOTM4LDEwIEBAIGNzY2hlZDJfZGVpbml0X3BkYXRhKGNvbnN0IHN0cnVjdCBz
Y2hlZHVsZXIgKm9wcywgdm9pZCAqcGNwdSwgaW50IGNwdSkKICAgICBmb3JfZWFjaF9jcHUgKCBy
Y3B1LCAmcnFkLT5hY3RpdmUgKQogICAgICAgICBfX2NwdW1hc2tfY2xlYXJfY3B1KGNwdSwgJmNz
Y2hlZDJfcGNwdShyY3B1KS0+c2libGluZ19tYXNrKTsKIAotICAgIGlmICggY3B1bWFza19lbXB0
eSgmcnFkLT5hY3RpdmUpICkKKyAgICBycWQtPm5yX2NwdXMtLTsKKyAgICBBU1NFUlQoY3B1bWFz
a193ZWlnaHQoJnJxZC0+YWN0aXZlKSA9PSBycWQtPm5yX2NwdXMpOworCisgICAgaWYgKCBycWQt
Pm5yX2NwdXMgPT0gMCApCiAgICAgewogICAgICAgICBwcmludGsoWEVOTE9HX0lORk8gIiBObyBj
cHVzIGxlZnQgb24gcnVucXVldWUsIGRpc2FibGluZ1xuIik7CiAgICAgICAgIGRlYWN0aXZhdGVf
cnVucXVldWUocHJ2LCBzcGMtPnJ1bnFfaWQpOwoKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxp
c3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9s
aXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id BC4E511D426
	for <lists+xen-devel@lfdr.de>; Thu, 12 Dec 2019 18:35:55 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ifSKA-0002SP-FU; Thu, 12 Dec 2019 17:32:26 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=NkF/=2C=citrix.com=george.dunlap@srs-us1.protection.inumbo.net>)
 id 1ifSK8-0002SK-S1
 for xen-devel@lists.xenproject.org; Thu, 12 Dec 2019 17:32:24 +0000
X-Inumbo-ID: 5b563bf0-1d05-11ea-8dd6-12813bfff9fa
Received: from esa5.hc3370-68.iphmx.com (unknown [216.71.155.168])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 5b563bf0-1d05-11ea-8dd6-12813bfff9fa;
 Thu, 12 Dec 2019 17:32:23 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1576171943;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=BONvafvW7Xehu3KlD6QfL+lTUEkUwUanZ7dAlhNMZG4=;
 b=e/j2Y4qCBEzSMlpja0h6fi0gKdKZjDPaZ5EjClO+l3mDsHYxgdPq12ZO
 18UAtTx9QVrhq7XrTAM+wYpDdGxgJz8cev6KSTPvNl6YTNRG9HG22uTxI
 3Y8uUAi3UHbvdWRYuo0TPRQgnkdNHR6C9cNNjTmVfoV3GBhgz0z3do6l2 c=;
Authentication-Results: esa5.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=george.dunlap@citrix.com;
 spf=Pass smtp.mailfrom=George.Dunlap@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa5.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 george.dunlap@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa5.hc3370-68.iphmx.com;
 envelope-from="George.Dunlap@citrix.com";
 x-sender="george.dunlap@citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa5.hc3370-68.iphmx.com: domain of
 George.Dunlap@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa5.hc3370-68.iphmx.com;
 envelope-from="George.Dunlap@citrix.com";
 x-sender="George.Dunlap@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83
 ip4:168.245.78.127 ~all"
Received-SPF: None (esa5.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa5.hc3370-68.iphmx.com;
 envelope-from="George.Dunlap@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: XFd0hG5L7Ta2/CtgTkT82O25vEaz0c45jBuJz0anPaDKnR/cBGhVnwUTs19KosdsnKoCcSGlmk
 LZTtxSiGZ3UgijgSwwM1EFOg5dzue7yca73JUlFJBrjme5hR5QRpQAAYUjsWzVTft/E1UTz/Dm
 5Sw1vD9T2jfj0SS+OibAgKb9adLxWcGqGTVpRzoOMMVpX0ugd6bwm96B9GBEOuYRb4fR22ez6X
 bO6awkJOr3q7NUgU7V3sGH0G+SdGVIiUTc3kXEdnw5YbYDPJY+apmOVlMIqgP1BEIwnHRElSPY
 TeU=
X-SBRS: 2.7
X-MesageID: 9961409
X-Ironport-Server: esa5.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.69,306,1571716800"; 
   d="scan'208";a="9961409"
From: George Dunlap <george.dunlap@citrix.com>
To: <xen-devel@lists.xenproject.org>
Date: Thu, 12 Dec 2019 17:32:00 +0000
Message-ID: <20191212173203.1692762-2-george.dunlap@citrix.com>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191212173203.1692762-1-george.dunlap@citrix.com>
References: <20191212173203.1692762-1-george.dunlap@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH 1/4] x86/mm: Refactor put_page_from_l*e to
 reduce code duplication
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 George Dunlap <george.dunlap@citrix.com>, Jan Beulich <jbeulich@suse.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

cHV0X3BhZ2VfZnJvbV9sWzIzNF1lIGhhdmUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGRl
dmFsaWRhdGluZyBhbgpOLTEgZW50cnkgd2hpY2ggaXMgYSBwYWdldGFibGUuICBCdXQgbXlzdGlm
eWluZ2x5LCB0aGV5IGR1cGxpY2F0ZSB0aGUKY29kZSBpbiBzbGlnaHRseSBkaWZmZXJlbnQgYXJy
YW5nZW1lbnRzIHRoYXQgbWFrZSBpdCBoYXJkIHRvIHRlbGwgdGhhdAppdCdzIHRoZSBzYW1lLgoK
Q3JlYXRlIGEgbmV3IGZ1bmN0aW9uLCBwdXRfcHRfcGFnZSgpLCB3aGljaCBoYW5kbGVzIHRoZSBj
b21tb24KZnVuY3Rpb25hbGl0eTsgYW5kIHJlZmFjdG9yIGFsbCB0aGUgZnVuY3Rpb25zIHRvIGJl
IHN5bW1ldHJpYywKZGlmZmVyaW5nIG9ubHkgaW4gdGhlIGxldmVsIG9mIHBhZ2V0YWJsZSBleHBl
Y3RlZCAoYW5kIGluIHdoZXRoZXIgdGhleQpoYW5kbGUgc3VwZXJwYWdlcykuCgpObyBmdW5jdGlv
bmFsIGNoYW5nZSBpbnRlbmRlZC4KClNpZ25lZC1vZmYtYnk6IEdlb3JnZSBEdW5sYXAgPGdlb3Jn
ZS5kdW5sYXBAY2l0cml4LmNvbT4KLS0tCkNDOiBBbmRyZXcgQ29vcGVyIDxhbmRyZXcuY29vcGVy
M0BjaXRyaXguY29tPgpDQzogSmFuIEJldWxpY2ggPGpiZXVsaWNoQHN1c2UuY29tPgotLS0KIHhl
bi9hcmNoL3g4Ni9tbS5jIHwgODkgKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAyOCBpbnNlcnRpb25zKCspLCA2MSBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvbW0uYyBiL3hlbi9hcmNoL3g4Ni9tbS5j
CmluZGV4IDdkNGRkODBhODUuLmQ4YTBlYjJhYTUgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9t
bS5jCisrKyBiL3hlbi9hcmNoL3g4Ni9tbS5jCkBAIC0xMjk3LDYgKzEyOTcsMjggQEAgc3RhdGlj
IHZvaWQgcHV0X2RhdGFfcGFnZShzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlLCBib29sIHdyaXRlYWJs
ZSkKICAgICAgICAgcHV0X3BhZ2UocGFnZSk7CiB9CiAKK3N0YXRpYyBpbnQgcHV0X3B0X3BhZ2Uo
c3RydWN0IHBhZ2VfaW5mbyAqcGcsIHN0cnVjdCBwYWdlX2luZm8gKnB0cGcsCisgICAgICAgICAg
ICAgICAgICAgICAgIHVuc2lnbmVkIGludCBmbGFncykKK3sKKyAgICBpbnQgcmMgPSAwOworCisg
ICAgaWYgKCBmbGFncyAmIFBURl9kZWZlciApCisgICAgeworICAgICAgICBBU1NFUlQoIShmbGFn
cyAmIFBURl9wYXJ0aWFsX3NldCkpOworICAgICAgICBjdXJyZW50LT5hcmNoLm9sZF9ndWVzdF9w
dHBnID0gcHRwZzsKKyAgICAgICAgY3VycmVudC0+YXJjaC5vbGRfZ3Vlc3RfdGFibGUgPSBwZzsK
KyAgICAgICAgY3VycmVudC0+YXJjaC5vbGRfZ3Vlc3RfdGFibGVfcGFydGlhbCA9IGZhbHNlOwor
ICAgIH0KKyAgICBlbHNlCisgICAgeworICAgICAgICByYyA9IF9wdXRfcGFnZV90eXBlKHBnLCBm
bGFncyB8IFBURl9wcmVlbXB0aWJsZSwgcHRwZyk7CisgICAgICAgIGlmICggbGlrZWx5KCFyYykg
KQorICAgICAgICAgICAgcHV0X3BhZ2UocGcpOworICAgIH0KKworICAgIHJldHVybiByYzsKK30K
KwogLyoKICAqIE5CLiBWaXJ0dWFsIGFkZHJlc3MgJ2wyZScgbWFwcyB0byBhIG1hY2hpbmUgYWRk
cmVzcyB3aXRoaW4gZnJhbWUgJ3BmbicuCiAgKiBOb3RlIGFsc28gdGhhdCB0aGlzIGF1dG9tYXRp
Y2FsbHkgZGVhbHMgY29ycmVjdGx5IHdpdGggbGluZWFyIHAudC4ncy4KQEAgLTEzMDQsOCArMTMy
Niw2IEBAIHN0YXRpYyB2b2lkIHB1dF9kYXRhX3BhZ2Uoc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSwg
Ym9vbCB3cml0ZWFibGUpCiBzdGF0aWMgaW50IHB1dF9wYWdlX2Zyb21fbDJlKGwyX3BnZW50cnlf
dCBsMmUsIHVuc2lnbmVkIGxvbmcgcGZuLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1
bnNpZ25lZCBpbnQgZmxhZ3MpCiB7Ci0gICAgaW50IHJjID0gMDsKLQogICAgIGlmICggIShsMmVf
Z2V0X2ZsYWdzKGwyZSkgJiBfUEFHRV9QUkVTRU5UKSB8fCAobDJlX2dldF9wZm4obDJlKSA9PSBw
Zm4pICkKICAgICAgICAgcmV0dXJuIDE7CiAKQEAgLTEzMTksMzUgKzEzMzksMTYgQEAgc3RhdGlj
IGludCBwdXRfcGFnZV9mcm9tX2wyZShsMl9wZ2VudHJ5X3QgbDJlLCB1bnNpZ25lZCBsb25nIHBm
biwKICAgICAgICAgICAgICAgICAgKCgxVUwgPDwgKEwyX1BBR0VUQUJMRV9TSElGVCAtIFBBR0Vf
U0hJRlQpKSAtIDEpKSk7CiAgICAgICAgIGZvciAoIGkgPSAwOyBpIDwgKDF1IDw8IFBBR0VUQUJM
RV9PUkRFUik7IGkrKywgcGFnZSsrICkKICAgICAgICAgICAgIHB1dF9kYXRhX3BhZ2UocGFnZSwg
d3JpdGVhYmxlKTsKLSAgICB9Ci0gICAgZWxzZQotICAgIHsKLSAgICAgICAgc3RydWN0IHBhZ2Vf
aW5mbyAqcGcgPSBsMmVfZ2V0X3BhZ2UobDJlKTsKLSAgICAgICAgc3RydWN0IHBhZ2VfaW5mbyAq
cHRwZyA9IG1mbl90b19wYWdlKF9tZm4ocGZuKSk7CiAKLSAgICAgICAgaWYgKCBmbGFncyAmIFBU
Rl9kZWZlciApCi0gICAgICAgIHsKLSAgICAgICAgICAgIGN1cnJlbnQtPmFyY2gub2xkX2d1ZXN0
X3B0cGcgPSBwdHBnOwotICAgICAgICAgICAgY3VycmVudC0+YXJjaC5vbGRfZ3Vlc3RfdGFibGUg
PSBwZzsKLSAgICAgICAgICAgIGN1cnJlbnQtPmFyY2gub2xkX2d1ZXN0X3RhYmxlX3BhcnRpYWwg
PSBmYWxzZTsKLSAgICAgICAgfQotICAgICAgICBlbHNlCi0gICAgICAgIHsKLSAgICAgICAgICAg
IHJjID0gX3B1dF9wYWdlX3R5cGUocGcsIGZsYWdzIHwgUFRGX3ByZWVtcHRpYmxlLCBwdHBnKTsK
LSAgICAgICAgICAgIGlmICggbGlrZWx5KCFyYykgKQotICAgICAgICAgICAgICAgIHB1dF9wYWdl
KHBnKTsKLSAgICAgICAgfQorICAgICAgICByZXR1cm4gMDsKICAgICB9CiAKLSAgICByZXR1cm4g
cmM7CisgICAgcmV0dXJuIHB1dF9wdF9wYWdlKGwyZV9nZXRfcGFnZShsMmUpLCBtZm5fdG9fcGFn
ZShfbWZuKHBmbikpLCBmbGFncyk7CiB9CiAKIHN0YXRpYyBpbnQgcHV0X3BhZ2VfZnJvbV9sM2Uo
bDNfcGdlbnRyeV90IGwzZSwgdW5zaWduZWQgbG9uZyBwZm4sCiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHVuc2lnbmVkIGludCBmbGFncykKIHsKLSAgICBzdHJ1Y3QgcGFnZV9pbmZvICpw
ZzsKLSAgICBpbnQgcmM7Ci0KICAgICBpZiAoICEobDNlX2dldF9mbGFncyhsM2UpICYgX1BBR0Vf
UFJFU0VOVCkgfHwgKGwzZV9nZXRfcGZuKGwzZSkgPT0gcGZuKSApCiAgICAgICAgIHJldHVybiAx
OwogCkBAIC0xMzY1LDUwICsxMzY2LDE2IEBAIHN0YXRpYyBpbnQgcHV0X3BhZ2VfZnJvbV9sM2Uo
bDNfcGdlbnRyeV90IGwzZSwgdW5zaWduZWQgbG9uZyBwZm4sCiAgICAgICAgIHJldHVybiAwOwog
ICAgIH0KIAotICAgIHBnID0gbDNlX2dldF9wYWdlKGwzZSk7Ci0KLSAgICBpZiAoIGZsYWdzICYg
UFRGX2RlZmVyICkKLSAgICB7Ci0gICAgICAgIEFTU0VSVCghKGZsYWdzICYgUFRGX3BhcnRpYWxf
c2V0KSk7Ci0gICAgICAgIGN1cnJlbnQtPmFyY2gub2xkX2d1ZXN0X3B0cGcgPSBtZm5fdG9fcGFn
ZShfbWZuKHBmbikpOwotICAgICAgICBjdXJyZW50LT5hcmNoLm9sZF9ndWVzdF90YWJsZSA9IHBn
OwotICAgICAgICBjdXJyZW50LT5hcmNoLm9sZF9ndWVzdF90YWJsZV9wYXJ0aWFsID0gZmFsc2U7
Ci0gICAgICAgIHJldHVybiAwOwotICAgIH0KLQotICAgIHJjID0gX3B1dF9wYWdlX3R5cGUocGcs
IGZsYWdzIHwgUFRGX3ByZWVtcHRpYmxlLCBtZm5fdG9fcGFnZShfbWZuKHBmbikpKTsKLSAgICBp
ZiAoIGxpa2VseSghcmMpICkKLSAgICAgICAgcHV0X3BhZ2UocGcpOwotCi0gICAgcmV0dXJuIHJj
OworICAgIHJldHVybiBwdXRfcHRfcGFnZShsM2VfZ2V0X3BhZ2UobDNlKSwgbWZuX3RvX3BhZ2Uo
X21mbihwZm4pKSwgZmxhZ3MpOwogfQogCiBzdGF0aWMgaW50IHB1dF9wYWdlX2Zyb21fbDRlKGw0
X3BnZW50cnlfdCBsNGUsIHVuc2lnbmVkIGxvbmcgcGZuLAogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB1bnNpZ25lZCBpbnQgZmxhZ3MpCiB7Ci0gICAgaW50IHJjID0gMTsKLQotICAgIGlm
ICggKGw0ZV9nZXRfZmxhZ3MobDRlKSAmIF9QQUdFX1BSRVNFTlQpICYmCi0gICAgICAgICAobDRl
X2dldF9wZm4obDRlKSAhPSBwZm4pICkKLSAgICB7Ci0gICAgICAgIHN0cnVjdCBwYWdlX2luZm8g
KnBnID0gbDRlX2dldF9wYWdlKGw0ZSk7Ci0KLSAgICAgICAgaWYgKCBmbGFncyAmIFBURl9kZWZl
ciApCi0gICAgICAgIHsKLSAgICAgICAgICAgIEFTU0VSVCghKGZsYWdzICYgUFRGX3BhcnRpYWxf
c2V0KSk7Ci0gICAgICAgICAgICBjdXJyZW50LT5hcmNoLm9sZF9ndWVzdF9wdHBnID0gbWZuX3Rv
X3BhZ2UoX21mbihwZm4pKTsKLSAgICAgICAgICAgIGN1cnJlbnQtPmFyY2gub2xkX2d1ZXN0X3Rh
YmxlID0gcGc7Ci0gICAgICAgICAgICBjdXJyZW50LT5hcmNoLm9sZF9ndWVzdF90YWJsZV9wYXJ0
aWFsID0gZmFsc2U7Ci0gICAgICAgICAgICByZXR1cm4gMDsKLSAgICAgICAgfQotCi0gICAgICAg
IHJjID0gX3B1dF9wYWdlX3R5cGUocGcsIGZsYWdzIHwgUFRGX3ByZWVtcHRpYmxlLAotICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIG1mbl90b19wYWdlKF9tZm4ocGZuKSkpOwotICAgICAgICBp
ZiAoIGxpa2VseSghcmMpICkKLSAgICAgICAgICAgIHB1dF9wYWdlKHBnKTsKLSAgICB9CisgICAg
aWYgKCAhKGw0ZV9nZXRfZmxhZ3MobDRlKSAmIF9QQUdFX1BSRVNFTlQpIHx8IChsNGVfZ2V0X3Bm
bihsNGUpID09IHBmbikgKQorICAgICAgICByZXR1cm4gMTsKIAotICAgIHJldHVybiByYzsKKyAg
ICByZXR1cm4gcHV0X3B0X3BhZ2UobDRlX2dldF9wYWdlKGw0ZSksIG1mbl90b19wYWdlKF9tZm4o
cGZuKSksIGZsYWdzKTsKIH0KIAogc3RhdGljIGludCBhbGxvY19sMV90YWJsZShzdHJ1Y3QgcGFn
ZV9pbmZvICpwYWdlKQotLSAKMi4yNC4wCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMu
eGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL3hlbi1kZXZlbA==

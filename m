Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id B4FF1136E1E
	for <lists+xen-devel@lfdr.de>; Fri, 10 Jan 2020 14:32:13 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ipuLs-00022V-J2; Fri, 10 Jan 2020 13:29:24 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=0O1r=27=citrix.com=ian.jackson@srs-us1.protection.inumbo.net>)
 id 1ipuLq-000220-UE
 for xen-devel@lists.xenproject.org; Fri, 10 Jan 2020 13:29:22 +0000
X-Inumbo-ID: 2ebce332-33ad-11ea-b89f-bc764e2007e4
Received: from esa3.hc3370-68.iphmx.com (unknown [216.71.145.155])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 2ebce332-33ad-11ea-b89f-bc764e2007e4;
 Fri, 10 Jan 2020 13:29:10 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1578662950;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version;
 bh=tldUzIpqW259HNlP4sDhwClv5zBMPQrjoeXdLGkijiY=;
 b=hL8RPhplTbVLIUPN9+yytOTF9KHem8Ev0TFN4mp9N5cE13XOlFREPiaJ
 bmWmahBA6OZAjEOKmDwpDyi0w6zGnBTnBV/XDQnw7iNtTp37IA6gs2M4n
 qZIR5JLNDZspmve4eDdC1fX3zR3O9xBZ4bzEsSMNpvZr646YSdiZuNjx/ 8=;
Authentication-Results: esa3.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=ian.jackson@eu.citrix.com;
 spf=Pass smtp.mailfrom=Ian.Jackson@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa3.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 ian.jackson@eu.citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="Ian.Jackson@citrix.com";
 x-sender="ian.jackson@eu.citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa3.hc3370-68.iphmx.com: domain of
 Ian.Jackson@citrix.com designates 162.221.158.21 as permitted
 sender) identity=mailfrom; client-ip=162.221.158.21;
 receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="Ian.Jackson@citrix.com";
 x-sender="Ian.Jackson@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83
 ip4:168.245.78.127 ~all"
Received-SPF: None (esa3.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="Ian.Jackson@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: f8IU3UlIfR4o62I84iI1o5RbjLKf9uOL+JmrpXc1MHa2QtN/WDB6fYCJXa3Z44Qh6mV0ncvRYT
 vmkCWzwmFvjL307KSroTTFW5uTTl2y0s33dp/DR6E5Jy5cZ8HnBI3XqEcFlvwS5K8LZWpknGGA
 wTldvoSnqSsAdTQOw1vs54VOaGDsxkyLMUKMLo/esH4P6lcE7ugHLYdMdBlVdof5Aah50thLu9
 5hEmor/ge8n7N865UQi+HAO4D270JEgmBo0Kd+e4HHTWdPTwqtn5p0YsYCnoM0eHas/flidarn
 2vk=
X-SBRS: 2.7
X-MesageID: 10724855
X-Ironport-Server: esa3.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.69,417,1571716800"; d="scan'208";a="10724855"
From: Ian Jackson <ian.jackson@eu.citrix.com>
To: <xen-devel@lists.xenproject.org>
Date: Fri, 10 Jan 2020 13:28:58 +0000
Message-ID: <20200110132902.29295-5-ian.jackson@eu.citrix.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <20200110132902.29295-1-ian.jackson@eu.citrix.com>
References: <20200110132902.29295-1-ian.jackson@eu.citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH 4/8] libxl: event: Fix hang when mixing blocking
 and eventy calls
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>,
 George Dunlap <george.dunlap@citrix.com>, Wei Liu <wl@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SWYgdGhlIGFwcGxpY2F0aW9uIGNhbGxzIGxpYnhsIHdpdGggYW9faG93PT0wIGFuZCBhbHNvIG1h
a2VzIGNhbGxzCmxpa2UgX29jY3VycmVkLCBsaWJ4bCB3aWxsIHNvbWV0aW1lcyBnZXQgc3R1Y2su
CgpUaGUgYnVnIGhhcHBlbnMgYXMgZm9sbG93cyAoZm9yIGV4YW1wbGUpOgoKICBUaHJlYWQgQQog
ICAgICAgbGlieGxfZG9fdGhpbmcoLGFvX2hvdz09MCkKICAgICAgIGxpYnhsX2RvX3RoaW5nIHN0
YXJ0cywgc2V0cyB1cCBzb21lIGNhbGxiYWNrcwogICAgICAgbGlieGxfZG9fdGhpbmcgZXhpdCBw
YXRoIGNhbGxzIEFPX0lOUFJPR1JFU1MKICAgICAgIGxpYnhsX19hb19pbnByb2dyZXNzIGdvZXMg
aW50byBldmVudCBsb29wCiAgICAgICBldmVudGxvb3BfaXRlcmF0aW9uIHNsZWVwcyBvbjoKICAg
ICAgICAgIC0gZG9fdGhpbmcncyBjdXJyZW50IGZkIHNldAogICAgICAgICAgLSBzaWdjaGxkIHBp
cGUgaWYgYXBwbGljYWJsZQogICAgICAgICAgLSBpdHMgcG9sbGVyCgogIFRocmVhZCBCCiAgICAg
ICBsaWJ4bF9zb21ldGhpbmdfb2NjdXJyZWQKICAgICAgIHRoZSBzb21ldGhpbmcgaXMgdG8gZG8g
d2l0aCBkb190aGluZywgYWJvdmUKICAgICAgIGRvX3RoaW5nX25leHRfY2FsbGJhY2sgZG9lcyBz
b21lIG1vcmUgd29yawogICAgICAgZG9fdGhpbmdfbmV4dF9jYWxsYmFjayBiZWNvbWVzIGludGVy
ZXN0ZWQgaW4gZmQgTgogICAgICAgdGhyZWFkIEIgcmV0dXJucyB0byBhcHBsaWNhdGlvbgoKTm90
ZSB0aGF0IG5vdGhpbmcgd2FrZXMgdXAgdGhyZWFkIEEuICBBIGlzIG5vdCBsaXN0ZW5pbmcgb24g
ZmQgTi4gIFNvCmRvX3RoaW5nXyogd2lsbCBub3Qgc3BvdCB3aGVuIGZkIE4gc2lnbmFscy4gIGRv
X3RoaW5nIHdpbGwgbm90IG1ha2UKZnVydGhlciB0aW1lbHkgcHJvZ3Jlc3MuICBJZiB0aGVyZSBp
cyBubyB0aW1lb3V0IHRocmVhZCBBIHdpbGwgbmV2ZXIKd2FrZSB1cC4KClRoZSBwcm9ibGVtIGhl
cmUgb2NjdXJzIGJlY2F1c2UgdGhyZWFkIEEgaXMgd2FpdGluZyBvbiBhbiBvdXQgb2YgZGF0ZQpv
c2V2ZW50IHNldC4gIFdlIG5lZWQgdGhlIGZvbGxvd2luZyBwcm9wZXJ0eTogd2hlbmV2ZXIgYW55
IHRocmVhZCBpcwpibG9ja2luZyBpbiB0aGUgbGlieGwgZXZlbnQgbG9vcCwgYXQgbGVhc3Qgb25l
IHRocmVhZCBtdXN0IGJlIHVzaW5nIGFuCnVwIHRvIGRhdGUgb3NldmVudCBzZXQuICBJdCBpcyBP
SyBmb3IgYWxsIGJ1dCBvbmUgdGhyZWFkcyB0byBoYXZlCnN0YWxlIGV2ZW50IHNldHMsIGJlY2F1
c2Ugc28gbG9uZyBhcyBvbmUgd2FpdGluZyB0aHJlYWQgaGFzIHRoZSByaWdodApldmVudCBzZXQs
IGFueSBhY3R1YWxseSBpbnRlcmVzdGluZyBldmVudCB3aWxsLCBpZiBub3RoaW5nIGVsc2UsIHdh
a2UKdGhhdCAicmlnaHQiIHRocmVhZCB1cC4gIEl0IHdpbGwgdGhlbiBtYWtlIHNvbWUgcHJvZ3Jl
c3MgYW5kL29yLCBpZiBpdApleGl0cywgZW5zdXJlIHRoYXQgc29tZSBvdGhlciB0aHJlYWQgYmVj
b21lcyB0aGUgInJpZ2h0IiB0aHJlYWQuCgpUaGVyZSBpcyBhbHNvIHRoZSBwb3NzaWJpbGl0eSB0
aGF0IGEgdGhyZWFkIG1pZ2h0IGJsb2NrIHdhaXRpbmcgZm9yCmxpYnhsIG9zZXZlbnRzIGJ1dCBv
dXRzaWRlIGxpYnhsLCBlZyBpZiB0aGUgYXBwbGljYXRpb24gdXNlZApsaWJ4bF9vc2V2ZW50X2Jl
Zm9yZXBvbGwuICBXZSB3aWxsIGRlYWwgd2l0aCB0aGF0IGluIGEgbW9tZW50LgoKUmVwb3J0ZWQt
Ynk6IEdlb3JnZSBEdW5sYXAgPGdlb3JnZS5kdW5sYXBAY2l0cml4LmNvbT4KU2lnbmVkLW9mZi1i
eTogSWFuIEphY2tzb24gPGlhbi5qYWNrc29uQGV1LmNpdHJpeC5jb20+Ci0tLQogdG9vbHMvbGli
eGwvbGlieGxfZXZlbnQuYyAgICB8IDcyICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKystLS0tLS0tCiB0b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5oIHwgMzMgKysrKysrKysr
KysrKysrKy0tLS0KIDIgZmlsZXMgY2hhbmdlZCwgODggaW5zZXJ0aW9ucygrKSwgMTcgZGVsZXRp
b25zKC0pCgpkaWZmIC0tZ2l0IGEvdG9vbHMvbGlieGwvbGlieGxfZXZlbnQuYyBiL3Rvb2xzL2xp
YnhsL2xpYnhsX2V2ZW50LmMKaW5kZXggYmUzN2UxMmJiMC4uMThkYjA5MWE2ZSAxMDA2NDQKLS0t
IGEvdG9vbHMvbGlieGwvbGlieGxfZXZlbnQuYworKysgYi90b29scy9saWJ4bC9saWJ4bF9ldmVu
dC5jCkBAIC0zNiw2ICszNiw0MiBAQCBzdGF0aWMgbGlieGxfX2FvICphb19uZXN0ZWRfcm9vdChs
aWJ4bF9fYW8gKmFvKTsKIHN0YXRpYyB2b2lkIGFvX19jaGVja19kZXN0cm95KGxpYnhsX2N0eCAq
Y3R4LCBsaWJ4bF9fYW8gKmFvKTsKIAogCitzdGF0aWMgdm9pZCBwb2xsZXJzX25vdGVfb3NldmVu
dF9hZGRlZChsaWJ4bF9jdHggKmN0eCkgeworICAgIGxpYnhsX19wb2xsZXIgKnBvbGxlcjsKKyAg
ICBMSUJYTF9MSVNUX0ZPUkVBQ0gocG9sbGVyLCAmY3R4LT5wb2xsZXJzX2FjdGl2ZSwgYWN0aXZl
X2VudHJ5KQorICAgICAgICBwb2xsZXItPm9zZXZlbnRzX2FkZGVkID0gMTsKK30KKwordm9pZCBs
aWJ4bF9fZWdjX2NsZWFudXBfMV9iYXRvbihsaWJ4bF9fZWdjICplZ2MpCit7CisgICAgRUdDX0dD
OworICAgIGxpYnhsX19wb2xsZXIgKnNlYXJjaCwgKndha2U9MDsKKworICAgIExJQlhMX0xJU1Rf
Rk9SRUFDSChzZWFyY2gsICZDVFgtPnBvbGxlcnNfYWN0aXZlLCBhY3RpdmVfZW50cnkpIHsKKyAg
ICAgICAgaWYgKHNlYXJjaCA9PSBDVFgtPnBvbGxlcl9hcHApCisgICAgICAgICAgICAvKiBUaGlz
IG9uZSBpcyBzcGVjaWFsLiAgV2UgY2FuJ3QgZ2l2ZSBpdCB0aGUgYmF0b24uICovCisgICAgICAg
ICAgICBjb250aW51ZTsKKyAgICAgICAgaWYgKCFzZWFyY2gtPm9zZXZlbnRzX2FkZGVkKQorICAg
ICAgICAgICAgLyogVGhpcyBwb2xsZXIgaXMgdXAgdG8gZGF0ZSBhbmQgd2lsbCB3YWtlIHVwIGFz
IG5lZWRlZC4gKi8KKyAgICAgICAgICAgIHJldHVybjsKKyAgICAgICAgaWYgKCF3YWtlKQorICAg
ICAgICAgICAgd2FrZSA9IHNlYXJjaDsKKyAgICB9CisKKyAgICBpZiAoIXdha2UpCisgICAgICAg
IC8qIG5vLW9uZSBpbiBsaWJ4bCB3YWl0aW5nIGZvciBhbnkgZXZlbnRzICovCisgICAgICAgIHJl
dHVybjsKKworICAgIGxpYnhsX19wb2xsZXJfd2FrZXVwKGVnYywgd2FrZSk7CisKKyAgICB3YWtl
LT5vc2V2ZW50c19hZGRlZCA9IDA7CisgICAgLyogVGhpcyBzZXJ2ZXMgdG8gbWFrZSBfMV9iYXRv
biBpZGVtcG90ZW50LiAgSXQgaXMgT0sgZXZlbiB0aG91Z2gKKyAgICAgKiB0aGF0IHBvbGxlciBt
YXkgY3VycmVudGx5IGJlIHNsZWVwaW5nIG9uIG9ubHkgb2xkIG9zZXZlbnRzLAorICAgICAqIGJl
Y2F1c2UgaXQgaXMgZ29pbmcgdG8gd2FrZSB1cCBiZWNhdXNlIHdlJ3ZlIGp1c3QgcHJvZGRlZCBp
dCwKKyAgICAgKiBhbmQgaXQgcGljayB1cCBuZXcgb3NldmVudHMgb24gaXRzIG5leHQgaXRlcmF0
aW9uIChvciBwYXNzCisgICAgICogb24gdGhlIGJhdG9uKS4gKi8KK30KKwogLyoKICAqIFRoZSBj
b3VudGVyIG9zZXZlbnRfaW5faG9vayBpcyB1c2VkIHRvIGVuc3VyZSB0aGF0IHRoZSBhcHBsaWNh
dGlvbgogICogaG9ub3VycyB0aGUgcmVlbnRyYW5jeSByZXN0cmljdGlvbiBkb2N1bWVudGVkIGlu
IGxpYnhsX2V2ZW50LmguCkBAIC0xOTQsNiArMjMwLDcgQEAgaW50IGxpYnhsX19ldl9mZF9yZWdp
c3RlcihsaWJ4bF9fZ2MgKmdjLCBsaWJ4bF9fZXZfZmQgKmV2LAogICAgIGV2LT5mdW5jID0gZnVu
YzsKIAogICAgIExJQlhMX0xJU1RfSU5TRVJUX0hFQUQoJkNUWC0+ZWZkcywgZXYsIGVudHJ5KTsK
KyAgICBwb2xsZXJzX25vdGVfb3NldmVudF9hZGRlZChDVFgpOwogCiAgICAgcmMgPSAwOwogCkBA
IC0yMTQsNiArMjUxLDggQEAgaW50IGxpYnhsX19ldl9mZF9tb2RpZnkobGlieGxfX2djICpnYywg
bGlieGxfX2V2X2ZkICpldiwgc2hvcnQgZXZlbnRzKQogICAgIHJjID0gT1NFVkVOVF9IT09LKGZk
LG1vZGlmeSwgbm9vcCwgZXYtPmZkLCAmZXYtPm5leHVzLT5mb3JfYXBwX3JlZywgZXZlbnRzKTsK
ICAgICBpZiAocmMpIGdvdG8gb3V0OwogCisgICAgaWYgKChldmVudHMgJiB+ZXYtPmV2ZW50cykp
CisgICAgICAgIHBvbGxlcnNfbm90ZV9vc2V2ZW50X2FkZGVkKENUWCk7CiAgICAgZXYtPmV2ZW50
cyA9IGV2ZW50czsKIAogICAgIHJjID0gMDsKQEAgLTMxNSw2ICszNTQsNyBAQCBzdGF0aWMgaW50
IHRpbWVfcmVnaXN0ZXJfZmluaXRlKGxpYnhsX19nYyAqZ2MsIGxpYnhsX19ldl90aW1lICpldiwK
ICAgICBMSUJYTF9UQUlMUV9JTlNFUlRfU09SVEVEKCZDVFgtPmV0aW1lcywgZW50cnksIGV2LCBl
dnNlYXJjaCwgLyplbXB0eSovLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXJj
bXAoJmV2LT5hYnMsICZldnNlYXJjaC0+YWJzLCA+KSk7CiAKKyAgICBwb2xsZXJzX25vdGVfb3Nl
dmVudF9hZGRlZChDVFgpOwogICAgIHJldHVybiAwOwogfQogCkBAIC0xMTIxLDYgKzExNjEsNyBA
QCBzdGF0aWMgaW50IGJlZm9yZXBvbGxfaW50ZXJuYWwobGlieGxfX2djICpnYywgbGlieGxfX3Bv
bGxlciAqcG9sbGVyLAogICAgICpuZmRzX2lvID0gdXNlZDsKIAogICAgIHBvbGxlci0+ZmRzX2Rl
cmVnaXN0ZXJlZCA9IDA7CisgICAgcG9sbGVyLT5vc2V2ZW50c19hZGRlZCA9IDA7CiAKICAgICBs
aWJ4bF9fZXZfdGltZSAqZXRpbWUgPSBMSUJYTF9UQUlMUV9GSVJTVCgmQ1RYLT5ldGltZXMpOwog
ICAgIGlmIChldGltZSkgewpAQCAtMTQ0NCw3ICsxNDg1LDcgQEAgc3RhdGljIHZvaWQgZWdjX3J1
bl9jYWxsYmFja3MobGlieGxfX2VnYyAqZWdjKQogICAgIH0KIH0KIAotdm9pZCBsaWJ4bF9fZWdj
X2NsZWFudXAobGlieGxfX2VnYyAqZWdjKQordm9pZCBsaWJ4bF9fZWdjX2NsZWFudXBfMl91bF9j
Yl9nYyhsaWJ4bF9fZWdjICplZ2MpCiB7CiAgICAgRUdDX0dDOwogICAgIGVnY19ydW5fY2FsbGJh
Y2tzKGVnYyk7CkBAIC0xNzU0LDEzICsxNzk1LDE1IEBAIGludCBsaWJ4bF9ldmVudF93YWl0KGxp
YnhsX2N0eCAqY3R4LCBsaWJ4bF9ldmVudCAqKmV2ZW50X3IsCiAgICAgICAgIHJjID0gZXZlbnRs
b29wX2l0ZXJhdGlvbihlZ2MsIHBvbGxlcik7CiAgICAgICAgIGlmIChyYykgZ290byBvdXQ7CiAK
LSAgICAgICAgLyogd2UgdW5sb2NrIGFuZCBjbGVhbnVwIHRoZSBlZ2MgZWFjaCB0aW1lIHdlIGdv
IHRocm91Z2ggdGhpcyBsb29wLAotICAgICAgICAgKiBzbyB0aGF0IChhKSB3ZSBkb24ndCBhY2N1
bXVsYXRlIGdhcmJhZ2UgYW5kIChiKSBhbnkgZXZlbnRzCi0gICAgICAgICAqIHdoaWNoIGFyZSB0
byBiZSBkaXNwYXRjaGVkIGJ5IGNhbGxiYWNrIGFyZSBhY3R1YWxseSBkZWxpdmVyZWQKLSAgICAg
ICAgICogaW4gYSB0aW1lbHkgZmFzaGlvbi4KKyAgICAgICAgLyogd2UgdW5sb2NrIGFuZCBjbGVh
bnVwIHRoZSBlZ2MgZWFjaCB0aW1lIHdlIGdvIHRocm91Z2ggdGhpcworICAgICAgICAgKiBsb29w
LCBzbyB0aGF0IChhKSB3ZSBkb24ndCBhY2N1bXVsYXRlIGdhcmJhZ2UgYW5kIChiKSBhbnkKKyAg
ICAgICAgICogZXZlbnRzIHdoaWNoIGFyZSB0byBiZSBkaXNwYXRjaGVkIGJ5IGNhbGxiYWNrIGFy
ZSBhY3R1YWxseQorICAgICAgICAgKiBkZWxpdmVyZWQgaW4gYSB0aW1lbHkgZmFzaGlvbi4gIF8x
X2JhdG9uIHdpbGwgYmUKKyAgICAgICAgICogY2FsbGVkIHRvIHBhc3MgdGhlIGJhdG9uIGlmZiB3
ZSBhY3R1YWxseSBsZWF2ZTsgb3RoZXJ3aXNlCisgICAgICAgICAqIHdlIGFyZSBzdGlsbCBjYXJy
eWluZyBpdC4KICAgICAgICAgICovCiAgICAgICAgIENUWF9VTkxPQ0s7Ci0gICAgICAgIGxpYnhs
X19lZ2NfY2xlYW51cChlZ2MpOworICAgICAgICBsaWJ4bF9fZWdjX2NsZWFudXBfMl91bF9jYl9n
YyhlZ2MpOwogICAgICAgICBDVFhfTE9DSzsKICAgICB9CiAKQEAgLTIwMzMsMTAgKzIwNzYsMTIg
QEAgaW50IGxpYnhsX19hb19pbnByb2dyZXNzKGxpYnhsX19hbyAqYW8sCiAgICAgICAgICAgICAg
ICAgICogc3luY2hyb25vdXMgY2FuY2VsbGF0aW9uIGFiaWxpdHkuICovCiAgICAgICAgICAgICB9
CiAKKyAgICAgICAgICAgIC8qIFRoZSBjYWxsIHRvIGVnYy4uMV9iYXRvbiBpcyBiZWxvdywgb25s
eSBpZiB3ZSBhcmUgbGVhdmluZy4gKi8KICAgICAgICAgICAgIENUWF9VTkxPQ0s7Ci0gICAgICAg
ICAgICBsaWJ4bF9fZWdjX2NsZWFudXAoJmVnYyk7CisgICAgICAgICAgICBsaWJ4bF9fZWdjX2Ns
ZWFudXBfMl91bF9jYl9nYygmZWdjKTsKICAgICAgICAgICAgIENUWF9MT0NLOwogICAgICAgICB9
CisgICAgICAgIGxpYnhsX19lZ2NfY2xlYW51cF8xX2JhdG9uKCZlZ2MpOwogICAgIH0gZWxzZSB7
CiAgICAgICAgIHJjID0gMDsKICAgICB9CkBAIC0yMDUzLDYgKzIwOTgsOSBAQCBpbnQgbGlieGxf
X2FvX2lucHJvZ3Jlc3MobGlieGxfX2FvICphbywKIHN0YXRpYyBpbnQgYW9fX2Fib3J0KGxpYnhs
X2N0eCAqY3R4LCBsaWJ4bF9fYW8gKnBhcmVudCkKIC8qIFRlbXBvcmFyaWx5IHVubG9ja3MgY3R4
LCB3aGljaCBtdXN0IGJlIGxvY2tlZCBleGFjdGx5IG9uY2Ugb24gZW50cnkuICovCiB7CisgICAg
bGlieGxfX2VnYyBlZ2M7CisgICAgTElCWExfSU5JVF9FR0MoZWdjLGN0eCk7CisKICAgICBpbnQg
cmM7CiAgICAgYW9fX21hbmlwX2VudGVyKHBhcmVudCk7CiAKQEAgLTIwNzMsOSArMjEyMSw2IEBA
IHN0YXRpYyBpbnQgYW9fX2Fib3J0KGxpYnhsX2N0eCAqY3R4LCBsaWJ4bF9fYW8gKnBhcmVudCkK
IAogICAgIC8qIFdlIGtlZXAgY2FsbGluZyBhYm9ydCBob29rcyB1bnRpbCB0aGVyZSBhcmUgbm9u
ZSBsZWZ0ICovCiAgICAgd2hpbGUgKCFMSUJYTF9MSVNUX0VNUFRZKCZwYXJlbnQtPmFib3J0YWJs
ZXMpKSB7Ci0gICAgICAgIGxpYnhsX19lZ2MgZWdjOwotICAgICAgICBMSUJYTF9JTklUX0VHQyhl
Z2MsY3R4KTsKLQogICAgICAgICBhc3NlcnQoIXBhcmVudC0+Y29tcGxldGUpOwogCiAgICAgICAg
IGxpYnhsX19hb19hYm9ydGFibGUgKmFicnQgPSBMSUJYTF9MSVNUX0ZJUlNUKCZwYXJlbnQtPmFi
b3J0YWJsZXMpOwpAQCAtMjA4OCw4ICsyMTMzLDkgQEAgc3RhdGljIGludCBhb19fYWJvcnQobGli
eGxfY3R4ICpjdHgsIGxpYnhsX19hbyAqcGFyZW50KQogICAgICAgICAgICAgICAgICAgICJhbyAl
cDogYWJydD0lcDogYWJvcnRpbmciLCBwYXJlbnQsIGFicnQtPmFvKTsKICAgICAgICAgYWJydC0+
Y2FsbGJhY2soJmVnYywgYWJydCwgRVJST1JfQUJPUlRFRCk7CiAKKyAgICAgICAgLyogVGhlIGNh
bGwgdG8gZWdjLi4xX2JhdG9uIGlzIGluIHRoZSBvdXQgYmxvY2sgYmVsb3cuICovCiAgICAgICAg
IGxpYnhsX19jdHhfdW5sb2NrKGN0eCk7Ci0gICAgICAgIGxpYnhsX19lZ2NfY2xlYW51cCgmZWdj
KTsKKyAgICAgICAgbGlieGxfX2VnY19jbGVhbnVwXzJfdWxfY2JfZ2MoJmVnYyk7CiAgICAgICAg
IGxpYnhsX19jdHhfbG9jayhjdHgpOwogICAgIH0KIApAQCAtMjA5Nyw2ICsyMTQzLDEwIEBAIHN0
YXRpYyBpbnQgYW9fX2Fib3J0KGxpYnhsX2N0eCAqY3R4LCBsaWJ4bF9fYW8gKnBhcmVudCkKIAog
IG91dDoKICAgICBhb19fbWFuaXBfbGVhdmUoY3R4LCBwYXJlbnQpOworICAgIC8qIFRoZSBjYWxs
IHRvIGVnYy4uMl91bF9jYl9nYyBpcyBhYm92ZS4gIFRoaXMgaXMgc3VmZmljaWVudAorICAgICAq
IGJlY2F1c2Ugb25seSBjb2RlIGluc2lkZSB0aGUgbG9vcCBhZGRzIGFueXRoaW5nIHRvIHRoZSBl
Z2MsIGFuZAorICAgICAqIHdlIGVuc3VyZXMgdGhhdCB0aGUgZWdjIGlzIGNsZWFuIHdoZW4gd2Ug
bGVhdmUgdGhlIGxvb3AuICovCisgICAgbGlieGxfX2VnY19jbGVhbnVwXzFfYmF0b24oJmVnYyk7
CiAgICAgcmV0dXJuIHJjOwogfQogCmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9pbnRl
cm5hbC5oIGIvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaAppbmRleCA5ODNmZmZhYzdhLi5i
OWM0MDMxODYzIDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5oCisrKyBi
L3Rvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmgKQEAgLTYzNCw5ICs2MzQsMjMgQEAgc3RydWN0
IGxpYnhsX19wb2xsZXIgewogICAgICAqIGV2ZW50IGlzIGRlcmVnaXN0ZXJlZCwgd2Ugc2V0IHRo
ZSBmZHNfZGVyZWdpc3RlcmVkIG9mIGFsbCBub24taWRsZQogICAgICAqIHBvbGxlcnMuICBTbyBh
ZnRlcnBvbGwgY2FuIHRlbGwgd2hldGhlciBhbnkgUE9MTE5WQUwgaXMKICAgICAgKiBwbGF1c2li
bHkgZHVlIHRvIGFuIGZkIGJlaW5nIGNsb3NlZCBhbmQgcmVvcGVuZWQuCisgICAgICoKKyAgICAg
KiBBZGRpdGlvbmFsbHksIHdlIHJlY29yZCB3aGV0aGVyIGFueSBmZCBvciB0aW1lIGV2ZW50IHNv
dXJjZXMKKyAgICAgKiBoYXZlIGJlZW4gcmVnaXN0ZXJlZC4gIFRoaXMgaXMgbmVjZXNzYXJ5IGJl
Y2F1c2Ugc29tZXRpbWVzIHdlCisgICAgICogbmVlZCB0byB3YWtlIHVwIHRoZSBvbmx5IGxpYnhs
IHRocmVhZCBzdHVjayBpbgorICAgICAqIGV2ZW50bG9vcF9pdGVyYXRpb24gc28gdGhhdCBpdCB3
aWxsIHBpY2sgdXAgbmV3IGZkcyBvciBlYXJsaWVyCisgICAgICogdGltZW91dHMuICBvc2V2ZW50
c19hZGRlZCBpcyBjbGVhcmVkIGJ5IGJlZm9yZXBvbGwsIGFuZCBzZXQgYnkKKyAgICAgKiBmZCBv
ciB0aW1lb3V0IGV2ZW50IHJlZ2lzdHJhdGlvbi4gIFdoZW4gd2UgYXJlIGFib3V0IHRvIGxlYXZl
CisgICAgICogbGlieGwgKHN0cmljdGx5LCB3aGVuIHdlIGFyZSBhYm91dCB0byBnaXZlIHVwIGFu
IGVnYyksIHdlIGNoZWNrCisgICAgICogd2hldGhlciB0aGVyZSBhcmUgYW55IHBvbGxlcnMuICBJ
ZiB0aGVyZSBhcmUsIHRoZW4gYXQgbGVhc3Qgb25lCisgICAgICogb2YgdGhlbSBtdXN0IGhhdmUg
b3NldmVudHNfYWRkZWQgY2xlYXIuICBJZiBub3QsIHdlIHdha2UgdXAgdGhlCisgICAgICogZmly
c3Qgb25lIG9uIHRoZSBsaXN0LiAgQW55IGVudHJ5IG9uIHBvbGxlcnNfYWN0aXZlIGNvbnN0aXR1
dGVzCisgICAgICogYSBwcm9taXNlIHRvIGFsc28gbWFrZSB0aGlzIGNoZWNrLCBzbyB0aGUgYmF0
b24gd2lsbCBuZXZlciBiZQorICAgICAqIGRyb3BwZWQuCiAgICAgICovCiAgICAgTElCWExfTElT
VF9FTlRSWShsaWJ4bF9fcG9sbGVyKSBhY3RpdmVfZW50cnk7CiAgICAgYm9vbCBmZHNfZGVyZWdp
c3RlcmVkOworICAgIGJvb2wgb3NldmVudHNfYWRkZWQ7CiB9OwogCiBzdHJ1Y3QgbGlieGxfX2dj
IHsKQEAgLTIzNTAsNyArMjM2NCwxMCBAQCBfaGlkZGVuIGxpYnhsX2RldmljZV9tb2RlbF92ZXJz
aW9uIGxpYnhsX19kZWZhdWx0X2RldmljZV9tb2RlbChsaWJ4bF9fZ2MgKmdjKTsKICAgICAgICAg
TElCWExfU1RBSUxRX0lOSVQoJihlZ2MpLmV2X2ltbWVkaWF0ZXMpOyAgICAgICAgXAogICAgIH0g
d2hpbGUoMCkKIAotX2hpZGRlbiB2b2lkIGxpYnhsX19lZ2NfY2xlYW51cChsaWJ4bF9fZWdjICpl
Z2MpOworX2hpZGRlbiB2b2lkIGxpYnhsX19lZ2NfY2xlYW51cF8xX2JhdG9uKGxpYnhsX19lZ2Mg
KmVnYyk7CisgIC8qIFBhc3NlcyB0aGUgYmF0b24gZm9yIGFkZGVkIG9zZXZlbnRzLiAgU2VlIGNv
bW1lbnQgZm9yCisgICAqIG9zZXZlbnRzX2FkZGVkIGluIHN0cnVjdCBsaWJ4bF9fcG9sbGVyLiAq
LworX2hpZGRlbiB2b2lkIGxpYnhsX19lZ2NfY2xlYW51cF8yX3VsX2NiX2djKGxpYnhsX19lZ2Mg
KmVnYyk7CiAgIC8qIEZyZWVzIG1lbW9yeSBhbGxvY2F0ZWQgd2l0aGluIHRoaXMgZWdjJ3MgZ2Ms
IGFuZCBhbmQgcmVwb3J0IGFsbAogICAgKiBvY2N1cnJlZCBldmVudHMgdmlhIGNhbGxiYWNrLCBp
ZiBhcHBsaWNhYmxlLiAgTWF5IHJlZW50ZXIgdGhlCiAgICAqIGFwcGxpY2F0aW9uOyBzZWUgcmVz
dHJpY3Rpb25zIGFib3ZlLiAgVGhlIGN0eCBtdXN0IGJlIFVOTE9DS0VELiAqLwpAQCAtMjM2MSw5
ICsyMzc4LDExIEBAIF9oaWRkZW4gdm9pZCBsaWJ4bF9fZWdjX2NsZWFudXAobGlieGxfX2VnYyAq
ZWdjKTsKICAgICBsaWJ4bF9fZWdjIGVnY1sxXTsgTElCWExfSU5JVF9FR0MoZWdjWzBdLGN0eCk7
ICAgICAgXAogICAgIEVHQ19HQwogCi0jZGVmaW5lIEVHQ19GUkVFICAgICAgICAgICBsaWJ4bF9f
ZWdjX2NsZWFudXAoZWdjKQotCi0jZGVmaW5lIENUWF9VTkxPQ0tfRUdDX0ZSRUUgIGRveyBDVFhf
VU5MT0NLOyBFR0NfRlJFRTsgfXdoaWxlKDApCisjZGVmaW5lIENUWF9VTkxPQ0tfRUdDX0ZSRUUg
IGRveyAgICAgICAgICAgICAgICBcCisgICAgICAgIGxpYnhsX19lZ2NfY2xlYW51cF8xX2JhdG9u
KGVnYyk7ICAgICAgICBcCisgICAgICAgIENUWF9VTkxPQ0s7ICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBcCisgICAgICAgIGxpYnhsX19lZ2NfY2xlYW51cF8yX3VsX2NiX2djKGVnYyk7ICAg
ICBcCisgICAgfXdoaWxlKDApCiAKIAogLyoKQEAgLTI0NjgsOCArMjQ4Nyw5IEBAIF9oaWRkZW4g
dm9pZCBsaWJ4bF9fZWdjX2NsZWFudXAobGlieGxfX2VnYyAqZWdjKTsKIAogI2RlZmluZSBBT19J
TlBST0dSRVNTICh7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAg
ICAgICAgbGlieGxfY3R4ICphb19fY3R4ID0gbGlieGxfX2djX293bmVyKCZhby0+Z2MpOyAgICAg
ICAgICBcCisgICAgICAgIC8qIF9fYW9faW5wcm9ncmVzcyB3aWxsIGRvIGVnYy4uMV9iYXRvbiBp
ZiBuZWVkZWQgKi8JXAogICAgICAgICBDVFhfVU5MT0NLOyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIFwKLSAgICAgICAgRUdDX0ZSRUU7ICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCisgICAgICAgIGxpYnhsX19lZ2NfY2xl
YW51cF8yX3VsX2NiX2djKGVnYyk7ICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICBDVFhf
TE9DSzsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAg
ICAgICAgaW50IGFvX19yYyA9IGxpYnhsX19hb19pbnByb2dyZXNzKGFvLCAgICAgICAgICAgICAg
ICAgICBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX19GSUxFX18sIF9fTElORV9f
LCBfX2Z1bmNfXyk7ICAgXApAQCAtMjQ4MSw4ICsyNTAxLDkgQEAgX2hpZGRlbiB2b2lkIGxpYnhs
X19lZ2NfY2xlYW51cChsaWJ4bF9fZWdjICplZ2MpOwogICAgICAgICBsaWJ4bF9jdHggKmFvX19j
dHggPSBsaWJ4bF9fZ2Nfb3duZXIoJmFvLT5nYyk7ICAgICAgICAgIFwKICAgICAgICAgYXNzZXJ0
KHJjKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAg
ICAgIGxpYnhsX19hb19jcmVhdGVfZmFpbChhbyk7ICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgXAorICAgICAgICBsaWJ4bF9fZWdjX2NsZWFudXBfMV9iYXRvbihlZ2MpOyAgICAgICAgICAg
ICAgICAgICAgICAgIFwKICAgICAgICAgbGlieGxfX2N0eF91bmxvY2soYW9fX2N0eCk7IC8qIGdj
IGlzIG5vdyBpbnZhbGlkICovICAgICBcCi0gICAgICAgIEVHQ19GUkVFOyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAorICAgICAgICBsaWJ4bF9fZWdjX2Ns
ZWFudXBfMl91bF9jYl9nYyhlZ2MpOyAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICAgKHJj
KTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAg
ICAgfSkKIAotLSAKMi4xMS4wCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJv
amVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hl
bi1kZXZlbA==

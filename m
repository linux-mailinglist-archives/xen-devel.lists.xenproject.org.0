Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 2F970B2A90
	for <lists+xen-devel@lfdr.de>; Sat, 14 Sep 2019 10:55:20 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i93nk-0007Vr-AD; Sat, 14 Sep 2019 08:53:04 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=rDpt=XJ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1i93ni-0007V9-Tc
 for xen-devel@lists.xenproject.org; Sat, 14 Sep 2019 08:53:02 +0000
X-Inumbo-ID: 0d80fb78-d6cd-11e9-b299-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 0d80fb78-d6cd-11e9-b299-bc764e2007e4;
 Sat, 14 Sep 2019 08:52:59 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 12CDDB660;
 Sat, 14 Sep 2019 08:52:58 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Sat, 14 Sep 2019 10:52:14 +0200
Message-Id: <20190914085251.18816-11-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190914085251.18816-1-jgross@suse.com>
References: <20190914085251.18816-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v3 10/47] xen/sched: add scheduler helpers
 hiding vcpu
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QWRkIHRoZSBmb2xsb3dpbmcgaGVscGVycyB1c2luZyBhIHNjaGVkX3VuaXQgYXMgaW5wdXQgaW5z
dGVhZCBvZiBhCnZjcHU6CgotIGlzX2lkbGVfdW5pdCgpIHNpbWlsYXIgdG8gaXNfaWRsZV92Y3B1
KCkKLSBpc191bml0X29ubGluZSgpIHNpbWlsYXIgdG8gaXNfdmNwdV9vbmxpbmUoKSAocmV0dXJu
cyB0cnVlIHdoZW4gYW55CiAgb2YgaXRzIHZjcHVzIGlzIG9ubGluZSkKLSB1bml0X3J1bm5hYmxl
KCkgbGlrZSB2Y3B1X3J1bm5hYmxlKCkgKHJldHVybnMgdHJ1ZSBpZiBhbnkgb2YgaXRzCiAgdmNw
dXMgaXMgcnVubmFibGUpCi0gc2NoZWRfc2V0X3JlcygpIHRvIHNldCB0aGUgY3VycmVudCBzY2hl
ZHVsaW5nIHJlc291cmNlIG9mIGEgdW5pdAotIHNjaGVkX3VuaXRfY3B1KCkgdG8gZ2V0IHRoZSBj
dXJyZW50IHByb2Nlc3NvciBvZiBhIHVuaXQgKHJldHVybnMKICB0aGUgbWFzdGVyX2NwdSBvZiB0
aGUgc2NoZWR1bGluZyByZXNvdXJjZSBvZiBhIHVuaXQpCi0gc2NoZWRfe3NldHxjbGVhcn1fcGF1
c2VfZmxhZ3NbX2F0b21pY10oKSB0byBtb2RpZnkgcGF1c2VfZmxhZ3Mgb2YgdGhlCiAgYXNzb2Np
YXRlZCB2Y3B1KHMpIChtb2RpZmllcyB0aGUgcGF1c2VfZmxhZ3Mgb2YgYWxsIHZjcHVzIG9mIHRo
ZQogIHVuaXQpCi0gc2NoZWRfaWRsZV91bml0KCkgdG8gZ2V0IHRoZSBzY2hlZF91bml0IHBvaW50
ZXIgb2YgdGhlIGlkbGUgdmNwdSBvZiBhCiAgc3BlY2lmaWMgcGh5c2ljYWwgY3B1CgpTaWduZWQt
b2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+Ci0tLQpWMzoKLSBtYWtlIHVu
aXQgcGFyYW1ldGVyIG9mIHNjaGVkX3VuaXRfY3B1KCkgY29uc3QKLS0tCiB4ZW4vY29tbW9uL3Nj
aGVkX2NyZWRpdC5jICB8ICAzICstLQogeGVuL2NvbW1vbi9zY2hlZHVsZS5jICAgICAgfCAyMSAr
KysrKysrKy0tLS0tLS0tCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaCB8IDYxICsrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0KIDMgZmlsZXMgY2hhbmdlZCwg
NjggaW5zZXJ0aW9ucygrKSwgMTcgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2NvbW1v
bi9zY2hlZF9jcmVkaXQuYyBiL3hlbi9jb21tb24vc2NoZWRfY3JlZGl0LmMKaW5kZXggMGJjMWY3
MGYzMi4uNWIyYzhlYzBkMSAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hlZF9jcmVkaXQuYwor
KysgYi94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jCkBAIC0xNjYwLDggKzE2NjAsNyBAQCBjc2No
ZWRfcnVucV9zdGVhbChpbnQgcGVlcl9jcHUsIGludCBjcHUsIGludCBwcmksIGludCBiYWxhbmNl
X3N0ZXApCiAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3JhdGVfcXVldWVkKTsKICAg
ICAgICAgICAgIFdBUk5fT04odmMtPmlzX3VyZ2VudCk7CiAgICAgICAgICAgICBydW5xX3JlbW92
ZShzcGVlcik7Ci0gICAgICAgICAgICB2Yy0+cHJvY2Vzc29yID0gY3B1OwotICAgICAgICAgICAg
dmMtPnNjaGVkX3VuaXQtPnJlcyA9IGdldF9zY2hlZF9yZXMoY3B1KTsKKyAgICAgICAgICAgIHNj
aGVkX3NldF9yZXModmMtPnNjaGVkX3VuaXQsIGdldF9zY2hlZF9yZXMoY3B1KSk7CiAgICAgICAg
ICAgICAvKgogICAgICAgICAgICAgICogc3BlZXIgd2lsbCBzdGFydCBleGVjdXRpbmcgZGlyZWN0
bHkgb24gY3B1LCB3aXRob3V0IGhhdmluZyB0bwogICAgICAgICAgICAgICogZ28gdGhyb3VnaCBy
dW5xX2luc2VydCgpLiBTbyB3ZSBtdXN0IHVwZGF0ZSB0aGUgcnVubmFibGUgY291bnQKZGlmZiAt
LWdpdCBhL3hlbi9jb21tb24vc2NoZWR1bGUuYyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwppbmRl
eCAxMWU1YzI4OTViLi4xNTJiNzZjY2Q2IDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkdWxl
LmMKKysrIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCkBAIC04NCw3ICs4NCw3IEBAIHN0YXRpYyBz
cGlubG9ja190ICoKIHNjaGVkX2lkbGVfc3dpdGNoX3NjaGVkKHN0cnVjdCBzY2hlZHVsZXIgKm5l
d19vcHMsIHVuc2lnbmVkIGludCBjcHUsCiAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpw
ZGF0YSwgdm9pZCAqdmRhdGEpCiB7Ci0gICAgaWRsZV92Y3B1W2NwdV0tPnNjaGVkX3VuaXQtPnBy
aXYgPSBOVUxMOworICAgIHNjaGVkX2lkbGVfdW5pdChjcHUpLT5wcml2ID0gTlVMTDsKIAogICAg
IHJldHVybiAmc2NoZWRfZnJlZV9jcHVfbG9jazsKIH0KQEAgLTM3NiwxMiArMzc2LDExIEBAIGlu
dCBzY2hlZF9pbml0X3ZjcHUoc3RydWN0IHZjcHUgKnYsIHVuc2lnbmVkIGludCBwcm9jZXNzb3Ip
CiAgICAgc3RydWN0IGRvbWFpbiAqZCA9IHYtPmRvbWFpbjsKICAgICBzdHJ1Y3Qgc2NoZWRfdW5p
dCAqdW5pdDsKIAotICAgIHYtPnByb2Nlc3NvciA9IHByb2Nlc3NvcjsKLQogICAgIGlmICggKHVu
aXQgPSBzY2hlZF9hbGxvY191bml0KHYpKSA9PSBOVUxMICkKICAgICAgICAgcmV0dXJuIDE7CiAK
LSAgICB1bml0LT5yZXMgPSBnZXRfc2NoZWRfcmVzKHByb2Nlc3Nvcik7CisgICAgc2NoZWRfc2V0
X3Jlcyh1bml0LCBnZXRfc2NoZWRfcmVzKHByb2Nlc3NvcikpOworCiAgICAgLyogSW5pdGlhbGlz
ZSB0aGUgcGVyLXZjcHUgdGltZXJzLiAqLwogICAgIHNwaW5fbG9ja19pbml0KCZ2LT5wZXJpb2Rp
Y190aW1lcl9sb2NrKTsKICAgICBpbml0X3RpbWVyKCZ2LT5wZXJpb2RpY190aW1lciwgdmNwdV9w
ZXJpb2RpY190aW1lcl9mbiwKQEAgLTQ5Niw4ICs0OTUsNyBAQCBpbnQgc2NoZWRfbW92ZV9kb21h
aW4oc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wgKmMpCiAKICAgICAgICAgc2NoZWRf
c2V0X2FmZmluaXR5KHYsICZjcHVtYXNrX2FsbCwgJmNwdW1hc2tfYWxsKTsKIAotICAgICAgICB2
LT5wcm9jZXNzb3IgPSBuZXdfcDsKLSAgICAgICAgdi0+c2NoZWRfdW5pdC0+cmVzID0gZ2V0X3Nj
aGVkX3JlcyhuZXdfcCk7CisgICAgICAgIHNjaGVkX3NldF9yZXModi0+c2NoZWRfdW5pdCwgZ2V0
X3NjaGVkX3JlcyhuZXdfcCkpOwogICAgICAgICAvKgogICAgICAgICAgKiBXaXRoIHYtPnByb2Nl
c3NvciBtb2RpZmllZCB3ZSBtdXN0IG5vdAogICAgICAgICAgKiAtIG1ha2UgYW55IGZ1cnRoZXIg
Y2hhbmdlcyBhc3N1bWluZyB3ZSBob2xkIHRoZSBzY2hlZHVsZXIgbG9jaywKQEAgLTgxNyw4ICs4
MTUsOSBAQCB2b2lkIHJlc3RvcmVfdmNwdV9hZmZpbml0eShzdHJ1Y3QgZG9tYWluICpkKQogICAg
ICAgICBzcGlubG9ja190ICpsb2NrOwogICAgICAgICB1bnNpZ25lZCBpbnQgb2xkX2NwdSA9IHYt
PnByb2Nlc3NvcjsKICAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSB2LT5zY2hlZF91
bml0OworICAgICAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnJlczsKIAotICAgICAgICBBU1NF
UlQoIXZjcHVfcnVubmFibGUodikpOworICAgICAgICBBU1NFUlQoIXVuaXRfcnVubmFibGUodW5p
dCkpOwogCiAgICAgICAgIC8qCiAgICAgICAgICAqIFJlLWFzc2lnbiB0aGUgaW5pdGlhbCBwcm9j
ZXNzb3IgYXMgYWZ0ZXIgcmVzdW1lIHdlIGhhdmUgbm8KQEAgLTg1MSwxNSArODUwLDE1IEBAIHZv
aWQgcmVzdG9yZV92Y3B1X2FmZmluaXR5KHN0cnVjdCBkb21haW4gKmQpCiAgICAgICAgICAgICB9
CiAgICAgICAgIH0KIAotICAgICAgICB2LT5wcm9jZXNzb3IgPSBjcHVtYXNrX2FueShjcHVtYXNr
X3NjcmF0Y2hfY3B1KGNwdSkpOwotICAgICAgICB1bml0LT5yZXMgPSBnZXRfc2NoZWRfcmVzKHYt
PnByb2Nlc3Nvcik7CisgICAgICAgIHJlcyA9IGdldF9zY2hlZF9yZXMoY3B1bWFza19hbnkoY3B1
bWFza19zY3JhdGNoX2NwdShjcHUpKSk7CisgICAgICAgIHNjaGVkX3NldF9yZXModW5pdCwgcmVz
KTsKIAogICAgICAgICBzcGluX3VubG9ja19pcnEobG9jayk7CiAKICAgICAgICAgLyogdi0+cHJv
Y2Vzc29yIG1pZ2h0IGhhdmUgY2hhbmdlZCwgc28gcmVhY3F1aXJlIHRoZSBsb2NrLiAqLwogICAg
ICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2NrX2lycSh1bml0KTsKLSAgICAgICAgdW5pdC0+
cmVzID0gc2NoZWRfcGlja19yZXNvdXJjZSh2Y3B1X3NjaGVkdWxlcih2KSwgdW5pdCk7Ci0gICAg
ICAgIHYtPnByb2Nlc3NvciA9IHVuaXQtPnJlcy0+bWFzdGVyX2NwdTsKKyAgICAgICAgcmVzID0g
c2NoZWRfcGlja19yZXNvdXJjZSh2Y3B1X3NjaGVkdWxlcih2KSwgdW5pdCk7CisgICAgICAgIHNj
aGVkX3NldF9yZXModW5pdCwgcmVzKTsKICAgICAgICAgc3Bpbl91bmxvY2tfaXJxKGxvY2spOwog
CiAgICAgICAgIGlmICggb2xkX2NwdSAhPSB2LT5wcm9jZXNzb3IgKQpkaWZmIC0tZ2l0IGEveGVu
L2luY2x1ZGUveGVuL3NjaGVkLWlmLmggYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaAppbmRl
eCBjMzIwODU0NTI3Li5mYTNjYTUxYTkwIDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vc2No
ZWQtaWYuaAorKysgYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaApAQCAtNjAsNiArNjAsNjIg
QEAgc3RhdGljIGlubGluZSB2b2lkIHNldF9zY2hlZF9yZXModW5zaWduZWQgaW50IGNwdSwgc3Ry
dWN0IHNjaGVkX3Jlc291cmNlICpyZXMpCiAgICAgcGVyX2NwdShzY2hlZF9yZXMsIGNwdSkgPSBy
ZXM7CiB9CiAKK3N0YXRpYyBpbmxpbmUgYm9vbCBpc19pZGxlX3VuaXQoY29uc3Qgc3RydWN0IHNj
aGVkX3VuaXQgKnVuaXQpCit7CisgICAgcmV0dXJuIGlzX2lkbGVfdmNwdSh1bml0LT52Y3B1X2xp
c3QpOworfQorCitzdGF0aWMgaW5saW5lIGJvb2wgaXNfdW5pdF9vbmxpbmUoY29uc3Qgc3RydWN0
IHNjaGVkX3VuaXQgKnVuaXQpCit7CisgICAgcmV0dXJuIGlzX3ZjcHVfb25saW5lKHVuaXQtPnZj
cHVfbGlzdCk7Cit9CisKK3N0YXRpYyBpbmxpbmUgYm9vbCB1bml0X3J1bm5hYmxlKGNvbnN0IHN0
cnVjdCBzY2hlZF91bml0ICp1bml0KQoreworICAgIHJldHVybiB2Y3B1X3J1bm5hYmxlKHVuaXQt
PnZjcHVfbGlzdCk7Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9pZCBzY2hlZF9zZXRfcmVzKHN0cnVj
dCBzY2hlZF91bml0ICp1bml0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Ry
dWN0IHNjaGVkX3Jlc291cmNlICpyZXMpCit7CisgICAgdW5pdC0+dmNwdV9saXN0LT5wcm9jZXNz
b3IgPSByZXMtPm1hc3Rlcl9jcHU7CisgICAgdW5pdC0+cmVzID0gcmVzOworfQorCitzdGF0aWMg
aW5saW5lIHVuc2lnbmVkIGludCBzY2hlZF91bml0X2NwdShjb25zdCBzdHJ1Y3Qgc2NoZWRfdW5p
dCAqdW5pdCkKK3sKKyAgICByZXR1cm4gdW5pdC0+cmVzLT5tYXN0ZXJfY3B1OworfQorCitzdGF0
aWMgaW5saW5lIHZvaWQgc2NoZWRfc2V0X3BhdXNlX2ZsYWdzKHN0cnVjdCBzY2hlZF91bml0ICp1
bml0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBp
bnQgYml0KQoreworICAgIF9fc2V0X2JpdChiaXQsICZ1bml0LT52Y3B1X2xpc3QtPnBhdXNlX2Zs
YWdzKTsKK30KKworc3RhdGljIGlubGluZSB2b2lkIHNjaGVkX2NsZWFyX3BhdXNlX2ZsYWdzKHN0
cnVjdCBzY2hlZF91bml0ICp1bml0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHVuc2lnbmVkIGludCBiaXQpCit7CisgICAgX19jbGVhcl9iaXQoYml0LCAmdW5p
dC0+dmNwdV9saXN0LT5wYXVzZV9mbGFncyk7Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9pZCBzY2hl
ZF9zZXRfcGF1c2VfZmxhZ3NfYXRvbWljKHN0cnVjdCBzY2hlZF91bml0ICp1bml0LAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGJp
dCkKK3sKKyAgICBzZXRfYml0KGJpdCwgJnVuaXQtPnZjcHVfbGlzdC0+cGF1c2VfZmxhZ3MpOwor
fQorCitzdGF0aWMgaW5saW5lIHZvaWQgc2NoZWRfY2xlYXJfcGF1c2VfZmxhZ3NfYXRvbWljKHN0
cnVjdCBzY2hlZF91bml0ICp1bml0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgYml0KQoreworICAgIGNsZWFyX2JpdChiaXQs
ICZ1bml0LT52Y3B1X2xpc3QtPnBhdXNlX2ZsYWdzKTsKK30KKworc3RhdGljIGlubGluZSBzdHJ1
Y3Qgc2NoZWRfdW5pdCAqc2NoZWRfaWRsZV91bml0KHVuc2lnbmVkIGludCBjcHUpCit7CisgICAg
cmV0dXJuIGlkbGVfdmNwdVtjcHVdLT5zY2hlZF91bml0OworfQorCiAvKgogICogU2NyYXRjaCBz
cGFjZSwgZm9yIGF2b2lkaW5nIGhhdmluZyB0b28gbWFueSBjcHVtYXNrX3Qgb24gdGhlIHN0YWNr
LgogICogV2l0aGluIGVhY2ggc2NoZWR1bGVyLCB3aGVuIHVzaW5nIHRoZSBzY3JhdGNoIG1hc2sg
b2Ygb25lIHBDUFU6CkBAIC0zNDYsMTAgKzQwMiw3IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBzY2hl
ZF9taWdyYXRlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKnMsCiAgICAgaWYgKCBzLT5taWdyYXRl
ICkKICAgICAgICAgcy0+bWlncmF0ZShzLCB1bml0LCBjcHUpOwogICAgIGVsc2UKLSAgICB7Ci0g
ICAgICAgIHVuaXQtPnZjcHVfbGlzdC0+cHJvY2Vzc29yID0gY3B1OwotICAgICAgICB1bml0LT5y
ZXMgPSBnZXRfc2NoZWRfcmVzKGNwdSk7Ci0gICAgfQorICAgICAgICBzY2hlZF9zZXRfcmVzKHVu
aXQsIGdldF9zY2hlZF9yZXMoY3B1KSk7CiB9CiAKIHN0YXRpYyBpbmxpbmUgc3RydWN0IHNjaGVk
X3Jlc291cmNlICpzY2hlZF9waWNrX3Jlc291cmNlKAotLSAKMi4xNi40CgoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlz
dApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

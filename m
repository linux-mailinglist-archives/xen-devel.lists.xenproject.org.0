Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id F025A150A99
	for <lists+xen-devel@lfdr.de>; Mon,  3 Feb 2020 17:14:51 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iyeKu-0007Z8-Ml; Mon, 03 Feb 2020 16:12:32 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=ZuA2=3X=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1iyeKs-0007YK-Qg
 for xen-devel@lists.xenproject.org; Mon, 03 Feb 2020 16:12:30 +0000
X-Inumbo-ID: f4b6c3be-469f-11ea-b211-bc764e2007e4
Received: from mga02.intel.com (unknown [134.134.136.20])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id f4b6c3be-469f-11ea-b211-bc764e2007e4;
 Mon, 03 Feb 2020 16:12:20 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga001.fm.intel.com ([10.253.24.23])
 by orsmga101.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 03 Feb 2020 08:12:18 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.70,398,1574150400"; d="scan'208";a="337726409"
Received: from kchen27-mobl.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.251.20.224])
 by fmsmga001.fm.intel.com with ESMTP; 03 Feb 2020 08:12:18 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Mon,  3 Feb 2020 08:12:04 -0800
Message-Id: <4533b6750698ec7f3c4721261c6584a2e3285cc5.1580746020.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1580746020.git.tamas.lengyel@intel.com>
References: <cover.1580746020.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v7 2/7] x86/hvm: introduce
 hvm_copy_context_and_params
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q3VycmVudGx5IHRoZSBodm0gcGFyYW1ldGVycyBhcmUgb25seSBhY2Nlc3NpYmxlIHZpYSB0aGUg
SFZNT1AgaHlwZXJjYWxscy4gSW4KdGhpcyBwYXRjaCB3ZSBpbnRyb2R1Y2UgYSBuZXcgZnVuY3Rp
b24gdGhhdCBjYW4gY29weSBib3RoIHRoZSBodm0gY29udGV4dCBhbmQKcGFyYW1ldGVycyBkaXJl
Y3RseSBpbnRvIGEgdGFyZ2V0IGRvbWFpbi4KClNpZ25lZC1vZmYtYnk6IFRhbWFzIEsgTGVuZ3ll
bCA8dGFtYXMubGVuZ3llbEBpbnRlbC5jb20+Ci0tLQp2NzogZ2V0IHJpZCBvZiBnb3RvJ3MgZHVy
aW5nIGNvZGUtbW92ZW1lbnQgYXMgcmVxdWVzdGVkIGJ5IEphbgogICAgdXNlIGRpZmZlcmVudCBv
cmRlciBvZiBvcGVyYXRpb24gaW4gaHZtX2NvcHlfY29udGV4dF9hbmRfcGFyYW1zCi0tLQogeGVu
L2FyY2gveDg2L2h2bS9odm0uYyAgICAgICAgfCAyNTMgKysrKysrKysrKysrKysrKysrKystLS0t
LS0tLS0tLS0tLQogeGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vaHZtLmggfCAgIDIgKwogMiBmaWxl
cyBjaGFuZ2VkLCAxNTIgaW5zZXJ0aW9ucygrKSwgMTAzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdp
dCBhL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMgYi94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCmluZGV4
IDJmZWU1NjlhNWYuLjAxMDg2NjM5NWEgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9odm0vaHZt
LmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS9odm0uYwpAQCAtNDA4MSwxNiArNDA4MSwxNyBAQCBz
dGF0aWMgaW50IGh2bW9wX3NldF9ldnRjaG5fdXBjYWxsX3ZlY3RvcigKIH0KIAogc3RhdGljIGlu
dCBodm1fYWxsb3dfc2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsCi0gICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgY29uc3Qgc3RydWN0IHhlbl9odm1fcGFyYW0gKmEpCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgaW5kZXgsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgdWludDY0X3QgbmV3X3ZhbHVlKQogewotICAgIHVpbnQ2NF90IHZhbHVlID0g
ZC0+YXJjaC5odm0ucGFyYW1zW2EtPmluZGV4XTsKKyAgICB1aW50NjRfdCB2YWx1ZSA9IGQtPmFy
Y2guaHZtLnBhcmFtc1tpbmRleF07CiAgICAgaW50IHJjOwogCiAgICAgcmMgPSB4c21faHZtX3Bh
cmFtKFhTTV9UQVJHRVQsIGQsIEhWTU9QX3NldF9wYXJhbSk7CiAgICAgaWYgKCByYyApCiAgICAg
ICAgIHJldHVybiByYzsKIAotICAgIHN3aXRjaCAoIGEtPmluZGV4ICkKKyAgICBzd2l0Y2ggKCBp
bmRleCApCiAgICAgewogICAgIC8qIFRoZSBmb2xsb3dpbmcgcGFyYW1ldGVycyBjYW4gYmUgc2V0
IGJ5IHRoZSBndWVzdC4gKi8KICAgICBjYXNlIEhWTV9QQVJBTV9DQUxMQkFDS19JUlE6CkBAIC00
MTIzLDcgKzQxMjQsNyBAQCBzdGF0aWMgaW50IGh2bV9hbGxvd19zZXRfcGFyYW0oc3RydWN0IGRv
bWFpbiAqZCwKICAgICBpZiAoIHJjICkKICAgICAgICAgcmV0dXJuIHJjOwogCi0gICAgc3dpdGNo
ICggYS0+aW5kZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAgICB7CiAgICAgLyogVGhlIGZv
bGxvd2luZyBwYXJhbWV0ZXJzIHNob3VsZCBvbmx5IGJlIGNoYW5nZWQgb25jZS4gKi8KICAgICBj
YXNlIEhWTV9QQVJBTV9WSVJJRElBTjoKQEAgLTQxMzMsNyArNDEzNCw3IEBAIHN0YXRpYyBpbnQg
aHZtX2FsbG93X3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIGNhc2UgSFZNX1BBUkFN
X05SX0lPUkVRX1NFUlZFUl9QQUdFUzoKICAgICBjYXNlIEhWTV9QQVJBTV9BTFRQMk06CiAgICAg
Y2FzZSBIVk1fUEFSQU1fTUNBX0NBUDoKLSAgICAgICAgaWYgKCB2YWx1ZSAhPSAwICYmIGEtPnZh
bHVlICE9IHZhbHVlICkKKyAgICAgICAgaWYgKCB2YWx1ZSAhPSAwICYmIG5ld192YWx1ZSAhPSB2
YWx1ZSApCiAgICAgICAgICAgICByYyA9IC1FRVhJU1Q7CiAgICAgICAgIGJyZWFrOwogICAgIGRl
ZmF1bHQ6CkBAIC00MTQzLDQ5ICs0MTQ0LDMyIEBAIHN0YXRpYyBpbnQgaHZtX2FsbG93X3NldF9w
YXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHJldHVybiByYzsKIH0KIAotc3RhdGljIGludCBo
dm1vcF9zZXRfcGFyYW0oCi0gICAgWEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5faHZtX3BhcmFt
X3QpIGFyZykKK3N0YXRpYyBpbnQgaHZtX3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLCB1aW50
MzJfdCBpbmRleCwgdWludDY0X3QgdmFsdWUpCiB7CiAgICAgc3RydWN0IGRvbWFpbiAqY3Vycl9k
ID0gY3VycmVudC0+ZG9tYWluOwotICAgIHN0cnVjdCB4ZW5faHZtX3BhcmFtIGE7Ci0gICAgc3Ry
dWN0IGRvbWFpbiAqZDsKICAgICBzdHJ1Y3QgdmNwdSAqdjsKICAgICBpbnQgcmM7CiAKLSAgICBp
ZiAoIGNvcHlfZnJvbV9ndWVzdCgmYSwgYXJnLCAxKSApCi0gICAgICAgIHJldHVybiAtRUZBVUxU
OwotCi0gICAgaWYgKCBhLmluZGV4ID49IEhWTV9OUl9QQVJBTVMgKQorICAgIGlmICggaW5kZXgg
Pj0gSFZNX05SX1BBUkFNUyApCiAgICAgICAgIHJldHVybiAtRUlOVkFMOwogCi0gICAgLyogTWFr
ZSBzdXJlIHRoZSBhYm92ZSBib3VuZCBjaGVjayBpcyBub3QgYnlwYXNzZWQgZHVyaW5nIHNwZWN1
bGF0aW9uLiAqLwotICAgIGJsb2NrX3NwZWN1bGF0aW9uKCk7Ci0KLSAgICBkID0gcmN1X2xvY2tf
ZG9tYWluX2J5X2FueV9pZChhLmRvbWlkKTsKLSAgICBpZiAoIGQgPT0gTlVMTCApCi0gICAgICAg
IHJldHVybiAtRVNSQ0g7Ci0KLSAgICByYyA9IC1FSU5WQUw7Ci0gICAgaWYgKCAhaXNfaHZtX2Rv
bWFpbihkKSApCi0gICAgICAgIGdvdG8gb3V0OwotCi0gICAgcmMgPSBodm1fYWxsb3dfc2V0X3Bh
cmFtKGQsICZhKTsKKyAgICByYyA9IGh2bV9hbGxvd19zZXRfcGFyYW0oZCwgaW5kZXgsIHZhbHVl
KTsKICAgICBpZiAoIHJjICkKLSAgICAgICAgZ290byBvdXQ7CisgICAgICAgIHJldHVybiByYzsK
IAotICAgIHN3aXRjaCAoIGEuaW5kZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAgICB7CiAg
ICAgY2FzZSBIVk1fUEFSQU1fQ0FMTEJBQ0tfSVJROgotICAgICAgICBodm1fc2V0X2NhbGxiYWNr
X3ZpYShkLCBhLnZhbHVlKTsKKyAgICAgICAgaHZtX3NldF9jYWxsYmFja192aWEoZCwgdmFsdWUp
OwogICAgICAgICBodm1fbGF0Y2hfc2hpbmZvX3NpemUoZCk7CiAgICAgICAgIGJyZWFrOwogICAg
IGNhc2UgSFZNX1BBUkFNX1RJTUVSX01PREU6Ci0gICAgICAgIGlmICggYS52YWx1ZSA+IEhWTVBU
TV9vbmVfbWlzc2VkX3RpY2tfcGVuZGluZyApCisgICAgICAgIGlmICggdmFsdWUgPiBIVk1QVE1f
b25lX21pc3NlZF90aWNrX3BlbmRpbmcgKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAg
ICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJBTV9WSVJJRElBTjoKLSAgICAgICAgaWYgKCAo
YS52YWx1ZSAmIH5IVk1QVl9mZWF0dXJlX21hc2spIHx8Ci0gICAgICAgICAgICAgIShhLnZhbHVl
ICYgSFZNUFZfYmFzZV9mcmVxKSApCisgICAgICAgIGlmICggKHZhbHVlICYgfkhWTVBWX2ZlYXR1
cmVfbWFzaykgfHwKKyAgICAgICAgICAgICAhKHZhbHVlICYgSFZNUFZfYmFzZV9mcmVxKSApCiAg
ICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BB
UkFNX0lERU5UX1BUOgpAQCAtNDE5NSw3ICs0MTc5LDcgQEAgc3RhdGljIGludCBodm1vcF9zZXRf
cGFyYW0oCiAgICAgICAgICAqLwogICAgICAgICBpZiAoICFwYWdpbmdfbW9kZV9oYXAoZCkgfHwg
IWNwdV9oYXNfdm14ICkKICAgICAgICAgewotICAgICAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1z
W2EuaW5kZXhdID0gYS52YWx1ZTsKKyAgICAgICAgICAgIGQtPmFyY2guaHZtLnBhcmFtc1tpbmRl
eF0gPSB2YWx1ZTsKICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICB9CiAKQEAgLTQyMTAsNyAr
NDE5NCw3IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogCiAgICAgICAgIHJjID0gMDsK
ICAgICAgICAgZG9tYWluX3BhdXNlKGQpOwotICAgICAgICBkLT5hcmNoLmh2bS5wYXJhbXNbYS5p
bmRleF0gPSBhLnZhbHVlOworICAgICAgICBkLT5hcmNoLmh2bS5wYXJhbXNbaW5kZXhdID0gdmFs
dWU7CiAgICAgICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKICAgICAgICAgICAgIHBhZ2luZ191
cGRhdGVfY3IzKHYsIGZhbHNlKTsKICAgICAgICAgZG9tYWluX3VucGF1c2UoZCk7CkBAIC00MjE5
LDIzICs0MjAzLDIzIEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogICAgICAgICBicmVh
azsKICAgICBjYXNlIEhWTV9QQVJBTV9ETV9ET01BSU46CiAgICAgICAgIC8qIFRoZSBvbmx5IHZh
bHVlIHRoaXMgc2hvdWxkIGV2ZXIgYmUgc2V0IHRvIGlzIERPTUlEX1NFTEYgKi8KLSAgICAgICAg
aWYgKCBhLnZhbHVlICE9IERPTUlEX1NFTEYgKQorICAgICAgICBpZiAoIHZhbHVlICE9IERPTUlE
X1NFTEYgKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogCi0gICAgICAgIGEudmFsdWUgPSBj
dXJyX2QtPmRvbWFpbl9pZDsKKyAgICAgICAgdmFsdWUgPSBjdXJyX2QtPmRvbWFpbl9pZDsKICAg
ICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fQUNQSV9TX1NUQVRFOgogICAgICAgICBy
YyA9IDA7Ci0gICAgICAgIGlmICggYS52YWx1ZSA9PSAzICkKKyAgICAgICAgaWYgKCB2YWx1ZSA9
PSAzICkKICAgICAgICAgICAgIGh2bV9zM19zdXNwZW5kKGQpOwotICAgICAgICBlbHNlIGlmICgg
YS52YWx1ZSA9PSAwICkKKyAgICAgICAgZWxzZSBpZiAoIHZhbHVlID09IDAgKQogICAgICAgICAg
ICAgaHZtX3MzX3Jlc3VtZShkKTsKICAgICAgICAgZWxzZQogICAgICAgICAgICAgcmMgPSAtRUlO
VkFMOwogCiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX0FDUElfSU9QT1JUU19M
T0NBVElPTjoKLSAgICAgICAgcmMgPSBwbXRpbWVyX2NoYW5nZV9pb3BvcnQoZCwgYS52YWx1ZSk7
CisgICAgICAgIHJjID0gcG10aW1lcl9jaGFuZ2VfaW9wb3J0KGQsIHZhbHVlKTsKICAgICAgICAg
YnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fTUVNT1JZX0VWRU5UX0NSMDoKICAgICBjYXNlIEhW
TV9QQVJBTV9NRU1PUllfRVZFTlRfQ1IzOgpAQCAtNDI1MCwyNCArNDIzNCwyNCBAQCBzdGF0aWMg
aW50IGh2bW9wX3NldF9wYXJhbSgKICAgICAgICAgcmMgPSB4c21faHZtX3BhcmFtX25lc3RlZChY
U01fUFJJViwgZCk7CiAgICAgICAgIGlmICggcmMgKQogICAgICAgICAgICAgYnJlYWs7Ci0gICAg
ICAgIGlmICggYS52YWx1ZSA+IDEgKQorICAgICAgICBpZiAoIHZhbHVlID4gMSApCiAgICAgICAg
ICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgIC8qCiAgICAgICAgICAqIFJlbW92ZSB0aGUgY2hl
Y2sgYmVsb3cgb25jZSB3ZSBoYXZlCiAgICAgICAgICAqIHNoYWRvdy1vbi1zaGFkb3cuCiAgICAg
ICAgICAqLwotICAgICAgICBpZiAoICFwYWdpbmdfbW9kZV9oYXAoZCkgJiYgYS52YWx1ZSApCisg
ICAgICAgIGlmICggIXBhZ2luZ19tb2RlX2hhcChkKSAmJiB2YWx1ZSApCiAgICAgICAgICAgICBy
YyA9IC1FSU5WQUw7Ci0gICAgICAgIGlmICggYS52YWx1ZSAmJgorICAgICAgICBpZiAoIHZhbHVl
ICYmCiAgICAgICAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9BTFRQMk1dICkK
ICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAgICAgICAgLyogU2V0IHVwIE5IVk0gc3RhdGUg
Zm9yIGFueSB2Y3B1cyB0aGF0IGFyZSBhbHJlYWR5IHVwLiAqLwotICAgICAgICBpZiAoIGEudmFs
dWUgJiYKKyAgICAgICAgaWYgKCB2YWx1ZSAmJgogICAgICAgICAgICAgICFkLT5hcmNoLmh2bS5w
YXJhbXNbSFZNX1BBUkFNX05FU1RFREhWTV0gKQogICAgICAgICAgICAgZm9yX2VhY2hfdmNwdShk
LCB2KQogICAgICAgICAgICAgICAgIGlmICggcmMgPT0gMCApCiAgICAgICAgICAgICAgICAgICAg
IHJjID0gbmVzdGVkaHZtX3ZjcHVfaW5pdGlhbGlzZSh2KTsKLSAgICAgICAgaWYgKCAhYS52YWx1
ZSB8fCByYyApCisgICAgICAgIGlmICggIXZhbHVlIHx8IHJjICkKICAgICAgICAgICAgIGZvcl9l
YWNoX3ZjcHUoZCwgdikKICAgICAgICAgICAgICAgICBuZXN0ZWRodm1fdmNwdV9kZXN0cm95KHYp
OwogICAgICAgICBicmVhazsKQEAgLTQyNzUsMzAgKzQyNTksMzAgQEAgc3RhdGljIGludCBodm1v
cF9zZXRfcGFyYW0oCiAgICAgICAgIHJjID0geHNtX2h2bV9wYXJhbV9hbHRwMm1odm0oWFNNX1BS
SVYsIGQpOwogICAgICAgICBpZiAoIHJjICkKICAgICAgICAgICAgIGJyZWFrOwotICAgICAgICBp
ZiAoIGEudmFsdWUgPiBYRU5fQUxUUDJNX2xpbWl0ZWQgKQorICAgICAgICBpZiAoIHZhbHVlID4g
WEVOX0FMVFAyTV9saW1pdGVkICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKLSAgICAgICAg
aWYgKCBhLnZhbHVlICYmCisgICAgICAgIGlmICggdmFsdWUgJiYKICAgICAgICAgICAgICBkLT5h
cmNoLmh2bS5wYXJhbXNbSFZNX1BBUkFNX05FU1RFREhWTV0gKQogICAgICAgICAgICAgcmMgPSAt
RUlOVkFMOwogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJBTV9UUklQTEVfRkFVTFRf
UkVBU09OOgotICAgICAgICBpZiAoIGEudmFsdWUgPiBTSFVURE9XTl9NQVggKQorICAgICAgICBp
ZiAoIHZhbHVlID4gU0hVVERPV05fTUFYICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAg
ICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fSU9SRVFfU0VSVkVSX1BGTjoKLSAgICAg
ICAgZC0+YXJjaC5odm0uaW9yZXFfZ2ZuLmJhc2UgPSBhLnZhbHVlOworICAgICAgICBkLT5hcmNo
Lmh2bS5pb3JlcV9nZm4uYmFzZSA9IHZhbHVlOwogICAgICAgICBicmVhazsKICAgICBjYXNlIEhW
TV9QQVJBTV9OUl9JT1JFUV9TRVJWRVJfUEFHRVM6CiAgICAgewogICAgICAgICB1bnNpZ25lZCBp
bnQgaTsKIAotICAgICAgICBpZiAoIGEudmFsdWUgPT0gMCB8fAotICAgICAgICAgICAgIGEudmFs
dWUgPiBzaXplb2YoZC0+YXJjaC5odm0uaW9yZXFfZ2ZuLm1hc2spICogOCApCisgICAgICAgIGlm
ICggdmFsdWUgPT0gMCB8fAorICAgICAgICAgICAgIHZhbHVlID4gc2l6ZW9mKGQtPmFyY2guaHZt
LmlvcmVxX2dmbi5tYXNrKSAqIDggKQogICAgICAgICB7CiAgICAgICAgICAgICByYyA9IC1FSU5W
QUw7CiAgICAgICAgICAgICBicmVhazsKICAgICAgICAgfQotICAgICAgICBmb3IgKCBpID0gMDsg
aSA8IGEudmFsdWU7IGkrKyApCisgICAgICAgIGZvciAoIGkgPSAwOyBpIDwgdmFsdWU7IGkrKyAp
CiAgICAgICAgICAgICBzZXRfYml0KGksICZkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubWFzayk7CiAK
ICAgICAgICAgYnJlYWs7CkBAIC00MzEwLDM1ICs0Mjk0LDM1IEBAIHN0YXRpYyBpbnQgaHZtb3Bf
c2V0X3BhcmFtKAogICAgICAgICAgICAgICAgICAgICAgc2l6ZW9mKGQtPmFyY2guaHZtLmlvcmVx
X2dmbi5sZWdhY3lfbWFzaykgKiA4KTsKICAgICAgICAgQlVJTERfQlVHX09OKEhWTV9QQVJBTV9C
VUZJT1JFUV9QRk4gPgogICAgICAgICAgICAgICAgICAgICAgc2l6ZW9mKGQtPmFyY2guaHZtLmlv
cmVxX2dmbi5sZWdhY3lfbWFzaykgKiA4KTsKLSAgICAgICAgaWYgKCBhLnZhbHVlICkKLSAgICAg
ICAgICAgIHNldF9iaXQoYS5pbmRleCwgJmQtPmFyY2guaHZtLmlvcmVxX2dmbi5sZWdhY3lfbWFz
ayk7CisgICAgICAgIGlmICggdmFsdWUgKQorICAgICAgICAgICAgc2V0X2JpdChpbmRleCwgJmQt
PmFyY2guaHZtLmlvcmVxX2dmbi5sZWdhY3lfbWFzayk7CiAgICAgICAgIGJyZWFrOwogCiAgICAg
Y2FzZSBIVk1fUEFSQU1fWDg3X0ZJUF9XSURUSDoKLSAgICAgICAgaWYgKCBhLnZhbHVlICE9IDAg
JiYgYS52YWx1ZSAhPSA0ICYmIGEudmFsdWUgIT0gOCApCisgICAgICAgIGlmICggdmFsdWUgIT0g
MCAmJiB2YWx1ZSAhPSA0ICYmIHZhbHVlICE9IDggKQogICAgICAgICB7CiAgICAgICAgICAgICBy
YyA9IC1FSU5WQUw7CiAgICAgICAgICAgICBicmVhazsKICAgICAgICAgfQotICAgICAgICBkLT5h
cmNoLng4N19maXBfd2lkdGggPSBhLnZhbHVlOworICAgICAgICBkLT5hcmNoLng4N19maXBfd2lk
dGggPSB2YWx1ZTsKICAgICAgICAgYnJlYWs7CiAKICAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RT
UzoKICAgICAgICAgLyogSGFyZHdhcmUgd291bGQgc2lsZW50bHkgdHJ1bmNhdGUgaGlnaCBiaXRz
LiAqLwotICAgICAgICBpZiAoIGEudmFsdWUgIT0gKHVpbnQzMl90KWEudmFsdWUgKQorICAgICAg
ICBpZiAoIHZhbHVlICE9ICh1aW50MzJfdCl2YWx1ZSApCiAgICAgICAgIHsKICAgICAgICAgICAg
IGlmICggZCA9PSBjdXJyX2QgKQogICAgICAgICAgICAgICAgIGRvbWFpbl9jcmFzaChkKTsKICAg
ICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAgICAgICAgfQogICAgICAgICAvKiBPbGQgaHZtbG9h
ZGVyIGJpbmFyaWVzIGhhcmRjb2RlIHRoZSBzaXplIHRvIDEyOCBieXRlcy4gKi8KLSAgICAgICAg
aWYgKCBhLnZhbHVlICkKLSAgICAgICAgICAgIGEudmFsdWUgfD0gKDEyOFVMTCA8PCAzMikgfCBW
TTg2X1RTU19VUERBVEVEOwotICAgICAgICBhLmluZGV4ID0gSFZNX1BBUkFNX1ZNODZfVFNTX1NJ
WkVEOworICAgICAgICBpZiAoIHZhbHVlICkKKyAgICAgICAgICAgIHZhbHVlIHw9ICgxMjhVTEwg
PDwgMzIpIHwgVk04Nl9UU1NfVVBEQVRFRDsKKyAgICAgICAgaW5kZXggPSBIVk1fUEFSQU1fVk04
Nl9UU1NfU0laRUQ7CiAgICAgICAgIGJyZWFrOwogCiAgICAgY2FzZSBIVk1fUEFSQU1fVk04Nl9U
U1NfU0laRUQ6Ci0gICAgICAgIGlmICggKGEudmFsdWUgPj4gMzIpIDwgc2l6ZW9mKHN0cnVjdCB0
c3MzMikgKQorICAgICAgICBpZiAoICh2YWx1ZSA+PiAzMikgPCBzaXplb2Yoc3RydWN0IHRzczMy
KSApCiAgICAgICAgIHsKICAgICAgICAgICAgIGlmICggZCA9PSBjdXJyX2QgKQogICAgICAgICAg
ICAgICAgIGRvbWFpbl9jcmFzaChkKTsKQEAgLTQzNDksMzQgKzQzMzMsNjAgQEAgc3RhdGljIGlu
dCBodm1vcF9zZXRfcGFyYW0oCiAgICAgICAgICAqIDI1NiBiaXRzIGludGVycnVwdCByZWRpcmVj
dGlvbiBiaXRtYXAgKyA2NGsgYml0cyBJL08gYml0bWFwCiAgICAgICAgICAqIHBsdXMgb25lIHBh
ZGRpbmcgYnl0ZSkuCiAgICAgICAgICAqLwotICAgICAgICBpZiAoIChhLnZhbHVlID4+IDMyKSA+
IHNpemVvZihzdHJ1Y3QgdHNzMzIpICsKKyAgICAgICAgaWYgKCAodmFsdWUgPj4gMzIpID4gc2l6
ZW9mKHN0cnVjdCB0c3MzMikgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgweDEw
MCAvIDgpICsgKDB4MTAwMDAgLyA4KSArIDEgKQotICAgICAgICAgICAgYS52YWx1ZSA9ICh1aW50
MzJfdClhLnZhbHVlIHwKKyAgICAgICAgICAgIHZhbHVlID0gKHVpbnQzMl90KXZhbHVlIHwKICAg
ICAgICAgICAgICAgICAgICAgICAoKHNpemVvZihzdHJ1Y3QgdHNzMzIpICsgKDB4MTAwIC8gOCkg
KwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMHgxMDAw
MCAvIDgpICsgMSkgPDwgMzIpOwotICAgICAgICBhLnZhbHVlIHw9IFZNODZfVFNTX1VQREFURUQ7
CisgICAgICAgIHZhbHVlIHw9IFZNODZfVFNTX1VQREFURUQ7CiAgICAgICAgIGJyZWFrOwogCiAg
ICAgY2FzZSBIVk1fUEFSQU1fTUNBX0NBUDoKLSAgICAgICAgcmMgPSB2bWNlX2VuYWJsZV9tY2Ff
Y2FwKGQsIGEudmFsdWUpOworICAgICAgICByYyA9IHZtY2VfZW5hYmxlX21jYV9jYXAoZCwgdmFs
dWUpOwogICAgICAgICBicmVhazsKICAgICB9CiAKLSAgICBpZiAoIHJjICE9IDAgKQotICAgICAg
ICBnb3RvIG91dDsKKyAgICBpZiAoICFyYyApCisgICAgeworICAgICAgICBkLT5hcmNoLmh2bS5w
YXJhbXNbaW5kZXhdID0gdmFsdWU7CiAKLSAgICBkLT5hcmNoLmh2bS5wYXJhbXNbYS5pbmRleF0g
PSBhLnZhbHVlOworICAgICAgICBIVk1fREJHX0xPRyhEQkdfTEVWRUxfSENBTEwsICJzZXQgcGFy
YW0gJXUgPSAlIlBSSXg2NCwKKyAgICAgICAgICAgICAgICAgICAgaW5kZXgsIHZhbHVlKTsKKyAg
ICB9CiAKLSAgICBIVk1fREJHX0xPRyhEQkdfTEVWRUxfSENBTEwsICJzZXQgcGFyYW0gJXUgPSAl
IlBSSXg2NCwKLSAgICAgICAgICAgICAgICBhLmluZGV4LCBhLnZhbHVlKTsKKyAgICByZXR1cm4g
cmM7Cit9CisKK2ludCBodm1vcF9zZXRfcGFyYW0oCisgICAgWEVOX0dVRVNUX0hBTkRMRV9QQVJB
TSh4ZW5faHZtX3BhcmFtX3QpIGFyZykKK3sKKyAgICBzdHJ1Y3QgeGVuX2h2bV9wYXJhbSBhOwor
ICAgIHN0cnVjdCBkb21haW4gKmQ7CisgICAgaW50IHJjOworCisgICAgaWYgKCBjb3B5X2Zyb21f
Z3Vlc3QoJmEsIGFyZywgMSkgKQorICAgICAgICByZXR1cm4gLUVGQVVMVDsKKworICAgIGlmICgg
YS5pbmRleCA+PSBIVk1fTlJfUEFSQU1TICkKKyAgICAgICAgcmV0dXJuIC1FSU5WQUw7CisKKyAg
ICAvKiBNYWtlIHN1cmUgdGhlIGFib3ZlIGJvdW5kIGNoZWNrIGlzIG5vdCBieXBhc3NlZCBkdXJp
bmcgc3BlY3VsYXRpb24uICovCisgICAgYmxvY2tfc3BlY3VsYXRpb24oKTsKKworICAgIGQgPSBy
Y3VfbG9ja19kb21haW5fYnlfYW55X2lkKGEuZG9taWQpOworICAgIGlmICggZCA9PSBOVUxMICkK
KyAgICAgICAgcmV0dXJuIC1FU1JDSDsKKworICAgIHJjID0gLUVJTlZBTDsKKyAgICBpZiAoIGlz
X2h2bV9kb21haW4oZCkgKQorICAgICAgICByYyA9IGh2bV9zZXRfcGFyYW0oZCwgYS5pbmRleCwg
YS52YWx1ZSk7CiAKLSBvdXQ6CiAgICAgcmN1X3VubG9ja19kb21haW4oZCk7CiAgICAgcmV0dXJu
IHJjOwogfQogCiBzdGF0aWMgaW50IGh2bV9hbGxvd19nZXRfcGFyYW0oc3RydWN0IGRvbWFpbiAq
ZCwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJ1Y3QgeGVuX2h2bV9w
YXJhbSAqYSkKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50MzJfdCBpbmRleCkK
IHsKICAgICBpbnQgcmM7CiAKQEAgLTQzODQsNyArNDM5NCw3IEBAIHN0YXRpYyBpbnQgaHZtX2Fs
bG93X2dldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIGlmICggcmMgKQogICAgICAgICBy
ZXR1cm4gcmM7CiAKLSAgICBzd2l0Y2ggKCBhLT5pbmRleCApCisgICAgc3dpdGNoICggaW5kZXgg
KQogICAgIHsKICAgICAvKiBUaGUgZm9sbG93aW5nIHBhcmFtZXRlcnMgY2FuIGJlIHJlYWQgYnkg
dGhlIGd1ZXN0LiAqLwogICAgIGNhc2UgSFZNX1BBUkFNX0NBTExCQUNLX0lSUToKQEAgLTQ0MTQs
NiArNDQyNCw0MCBAQCBzdGF0aWMgaW50IGh2bV9hbGxvd19nZXRfcGFyYW0oc3RydWN0IGRvbWFp
biAqZCwKICAgICByZXR1cm4gcmM7CiB9CiAKK3N0YXRpYyBpbnQgaHZtX2dldF9wYXJhbShzdHJ1
Y3QgZG9tYWluICpkLCB1aW50MzJfdCBpbmRleCwgdWludDY0X3QgKnZhbHVlKQoreworICAgIGlu
dCByYzsKKworICAgIHJjID0gaHZtX2FsbG93X2dldF9wYXJhbShkLCBpbmRleCk7CisgICAgaWYg
KCByYyApCisgICAgICAgIHJldHVybiByYzsKKworICAgIHN3aXRjaCAoIGluZGV4ICkKKyAgICB7
CisgICAgY2FzZSBIVk1fUEFSQU1fQUNQSV9TX1NUQVRFOgorICAgICAgICAqdmFsdWUgPSBkLT5h
cmNoLmh2bS5pc19zM19zdXNwZW5kZWQgPyAzIDogMDsKKyAgICAgICAgYnJlYWs7CisKKyAgICBj
YXNlIEhWTV9QQVJBTV9WTTg2X1RTUzoKKyAgICAgICAgKnZhbHVlID0gKHVpbnQzMl90KWQtPmFy
Y2guaHZtLnBhcmFtc1tIVk1fUEFSQU1fVk04Nl9UU1NfU0laRURdOworICAgICAgICBicmVhazsK
KworICAgIGNhc2UgSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEOgorICAgICAgICAqdmFsdWUgPSBk
LT5hcmNoLmh2bS5wYXJhbXNbSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEXSAmCisgICAgICAgICAg
ICAgICAgICAgflZNODZfVFNTX1VQREFURUQ7CisgICAgICAgIGJyZWFrOworCisgICAgY2FzZSBI
Vk1fUEFSQU1fWDg3X0ZJUF9XSURUSDoKKyAgICAgICAgKnZhbHVlID0gZC0+YXJjaC54ODdfZmlw
X3dpZHRoOworICAgICAgICBicmVhazsKKyAgICBkZWZhdWx0OgorICAgICAgICAqdmFsdWUgPSBk
LT5hcmNoLmh2bS5wYXJhbXNbaW5kZXhdOworICAgICAgICBicmVhazsKKyAgICB9CisKKyAgICBy
ZXR1cm4gMDsKK307CisKIHN0YXRpYyBpbnQgaHZtb3BfZ2V0X3BhcmFtKAogICAgIFhFTl9HVUVT
VF9IQU5ETEVfUEFSQU0oeGVuX2h2bV9wYXJhbV90KSBhcmcpCiB7CkBAIC00NDM1LDQyICs0NDc5
LDE0IEBAIHN0YXRpYyBpbnQgaHZtb3BfZ2V0X3BhcmFtKAogICAgICAgICByZXR1cm4gLUVTUkNI
OwogCiAgICAgcmMgPSAtRUlOVkFMOwotICAgIGlmICggIWlzX2h2bV9kb21haW4oZCkgKQotICAg
ICAgICBnb3RvIG91dDsKLQotICAgIHJjID0gaHZtX2FsbG93X2dldF9wYXJhbShkLCAmYSk7Ci0g
ICAgaWYgKCByYyApCi0gICAgICAgIGdvdG8gb3V0OwotCi0gICAgc3dpdGNoICggYS5pbmRleCAp
CisgICAgaWYgKCBpc19odm1fZG9tYWluKGQpICYmICEocmMgPSBodm1fZ2V0X3BhcmFtKGQsIGEu
aW5kZXgsICZhLnZhbHVlKSkgKQogICAgIHsKLSAgICBjYXNlIEhWTV9QQVJBTV9BQ1BJX1NfU1RB
VEU6Ci0gICAgICAgIGEudmFsdWUgPSBkLT5hcmNoLmh2bS5pc19zM19zdXNwZW5kZWQgPyAzIDog
MDsKLSAgICAgICAgYnJlYWs7Ci0KLSAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RTUzoKLSAgICAg
ICAgYS52YWx1ZSA9ICh1aW50MzJfdClkLT5hcmNoLmh2bS5wYXJhbXNbSFZNX1BBUkFNX1ZNODZf
VFNTX1NJWkVEXTsKLSAgICAgICAgYnJlYWs7Ci0KLSAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RT
U19TSVpFRDoKLSAgICAgICAgYS52YWx1ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1f
Vk04Nl9UU1NfU0laRURdICYKLSAgICAgICAgICAgICAgICAgIH5WTTg2X1RTU19VUERBVEVEOwot
ICAgICAgICBicmVhazsKKyAgICAgICAgcmMgPSBfX2NvcHlfdG9fZ3Vlc3QoYXJnLCAmYSwgMSkg
PyAtRUZBVUxUIDogMDsKIAotICAgIGNhc2UgSFZNX1BBUkFNX1g4N19GSVBfV0lEVEg6Ci0gICAg
ICAgIGEudmFsdWUgPSBkLT5hcmNoLng4N19maXBfd2lkdGg7Ci0gICAgICAgIGJyZWFrOwotICAg
IGRlZmF1bHQ6Ci0gICAgICAgIGEudmFsdWUgPSBkLT5hcmNoLmh2bS5wYXJhbXNbYS5pbmRleF07
Ci0gICAgICAgIGJyZWFrOworICAgICAgICBIVk1fREJHX0xPRyhEQkdfTEVWRUxfSENBTEwsICJn
ZXQgcGFyYW0gJXUgPSAlIlBSSXg2NCwKKyAgICAgICAgICAgICAgICAgICAgYS5pbmRleCwgYS52
YWx1ZSk7CiAgICAgfQogCi0gICAgcmMgPSBfX2NvcHlfdG9fZ3Vlc3QoYXJnLCAmYSwgMSkgPyAt
RUZBVUxUIDogMDsKLQotICAgIEhWTV9EQkdfTE9HKERCR19MRVZFTF9IQ0FMTCwgImdldCBwYXJh
bSAldSA9ICUiUFJJeDY0LAotICAgICAgICAgICAgICAgIGEuaW5kZXgsIGEudmFsdWUpOwotCi0g
b3V0OgogICAgIHJjdV91bmxvY2tfZG9tYWluKGQpOwogICAgIHJldHVybiByYzsKIH0KQEAgLTUz
MDEsNiArNTMxNywzNyBAQCB2b2lkIGh2bV9zZXRfc2VnbWVudF9yZWdpc3RlcihzdHJ1Y3QgdmNw
dSAqdiwgZW51bSB4ODZfc2VnbWVudCBzZWcsCiAgICAgYWx0ZXJuYXRpdmVfdmNhbGwoaHZtX2Z1
bmNzLnNldF9zZWdtZW50X3JlZ2lzdGVyLCB2LCBzZWcsIHJlZyk7CiB9CiAKK2ludCBodm1fY29w
eV9jb250ZXh0X2FuZF9wYXJhbXMoc3RydWN0IGRvbWFpbiAqZHN0LCBzdHJ1Y3QgZG9tYWluICpz
cmMpCit7CisgICAgaW50IHJjOworICAgIHVuc2lnbmVkIGludCBpOworICAgIHN0cnVjdCBodm1f
ZG9tYWluX2NvbnRleHQgYyA9IHsgfTsKKworICAgIGMuc2l6ZSA9IGh2bV9zYXZlX3NpemUoc3Jj
KTsKKyAgICBpZiAoIChjLmRhdGEgPSB2bWFsbG9jKGMuc2l6ZSkpID09IE5VTEwgKQorICAgICAg
ICByZXR1cm4gLUVOT01FTTsKKworICAgIGlmICggKHJjID0gaHZtX3NhdmUoc3JjLCAmYykpICkK
KyAgICAgICAgcmV0dXJuIHJjOworCisgICAgZm9yICggaSA9IDA7IGkgPCBIVk1fTlJfUEFSQU1T
OyBpKysgKQorICAgIHsKKyAgICAgICAgdWludDY0X3QgdmFsdWUgPSAwOworCisgICAgICAgIGlm
ICggaHZtX2dldF9wYXJhbShzcmMsIGksICZ2YWx1ZSkgfHwgIXZhbHVlICkKKyAgICAgICAgICAg
IGNvbnRpbnVlOworCisgICAgICAgIGlmICggKHJjID0gaHZtX3NldF9wYXJhbShkc3QsIGksIHZh
bHVlKSkgKQorICAgICAgICAgICAgcmV0dXJuIHJjOworICAgIH0KKworICAgIGMuY3VyID0gMDsK
KyAgICByYyA9IGh2bV9sb2FkKGRzdCwgJmMpOworICAgIHZmcmVlKGMuZGF0YSk7CisKKyAgICBy
ZXR1cm4gcmM7Cit9CisKIC8qCiAgKiBMb2NhbCB2YXJpYWJsZXM6CiAgKiBtb2RlOiBDCmRpZmYg
LS1naXQgYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaCBiL3hlbi9pbmNsdWRlL2FzbS14
ODYvaHZtL2h2bS5oCmluZGV4IDllYWIxZDc0OTMuLjI0ZGE4MjRjYmYgMTAwNjQ0Ci0tLSBhL3hl
bi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oCisrKyBiL3hlbi9pbmNsdWRlL2FzbS14ODYvaHZt
L2h2bS5oCkBAIC0zMzcsNiArMzM3LDggQEAgdW5zaWduZWQgbG9uZyBodm1fY3I0X2d1ZXN0X3Zh
bGlkX2JpdHMoY29uc3Qgc3RydWN0IGRvbWFpbiAqZCwgYm9vbCByZXN0b3JlKTsKIGJvb2wgaHZt
X2ZsdXNoX3ZjcHVfdGxiKGJvb2wgKCpmbHVzaF92Y3B1KSh2b2lkICpjdHh0LCBzdHJ1Y3QgdmNw
dSAqdiksCiAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpjdHh0KTsKIAoraW50IGh2bV9j
b3B5X2NvbnRleHRfYW5kX3BhcmFtcyhzdHJ1Y3QgZG9tYWluICpzcmMsIHN0cnVjdCBkb21haW4g
KmRzdCk7CisKICNpZmRlZiBDT05GSUdfSFZNCiAKICNkZWZpbmUgaHZtX2dldF9ndWVzdF90c2Mo
dikgaHZtX2dldF9ndWVzdF90c2NfZml4ZWQodiwgMCkKLS0gCjIuMjAuMQoKCl9fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxp
c3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVj
dC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 4DB1314A9DC
	for <lists+xen-devel@lfdr.de>; Mon, 27 Jan 2020 19:36:23 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iw9Db-0002C8-PJ; Mon, 27 Jan 2020 18:34:39 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=5jYl=3Q=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1iw9Da-0002BN-4R
 for xen-devel@lists.xenproject.org; Mon, 27 Jan 2020 18:34:38 +0000
X-Inumbo-ID: 9f40f132-4133-11ea-b45d-bc764e2007e4
Received: from mga07.intel.com (unknown [134.134.136.100])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 9f40f132-4133-11ea-b45d-bc764e2007e4;
 Mon, 27 Jan 2020 18:34:16 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 27 Jan 2020 10:06:49 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.70,370,1574150400"; d="scan'208";a="231562375"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.254.183.124])
 by orsmga006.jf.intel.com with ESMTP; 27 Jan 2020 10:06:48 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 27 Jan 2020 10:06:34 -0800
Message-Id: <addd75af0bd87985f369f7aab9a4001a559d1f9e.1580148227.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1580148227.git.tamas.lengyel@intel.com>
References: <cover.1580148227.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v6 6/9] xen/mem_sharing: VM forking
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Tamas K Lengyel <tamas.lengyel@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Vk0gZm9ya2luZyBpcyB0aGUgcHJvY2VzcyBvZiBjcmVhdGluZyBhIGRvbWFpbiB3aXRoIGFuIGVt
cHR5IG1lbW9yeSBzcGFjZSBhbmQgYQpwYXJlbnQgZG9tYWluIHNwZWNpZmllZCBmcm9tIHdoaWNo
IHRvIHBvcHVsYXRlIHRoZSBtZW1vcnkgd2hlbiBuZWNlc3NhcnkuIEZvcgp0aGUgbmV3IGRvbWFp
biB0byBiZSBmdW5jdGlvbmFsIHRoZSBWTSBzdGF0ZSBpcyBjb3BpZWQgb3ZlciBhcyBwYXJ0IG9m
IHRoZSBmb3JrCm9wZXJhdGlvbiAoSFZNIHBhcmFtcywgaGFwIGFsbG9jYXRpb24sIGV0YykuCgpT
aWduZWQtb2ZmLWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxAaW50ZWwuY29tPgot
LS0KdjY6IHVzZSBnZXRfZG9tYWluL3B1dF9kb21haW4gb24gcGFyZW50IHRvIG1ha2Ugc3VyZSBp
dCdzIG5vdCBkZXN0cm95ZWQKLS0tCiB4ZW4vYXJjaC94ODYvZG9tYWluLmMgICAgICAgICAgICAg
fCAgMTEgKysKIHhlbi9hcmNoL3g4Ni9odm0vaHZtLmMgICAgICAgICAgICB8ICAgMiArLQogeGVu
L2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMgICAgIHwgMjIyICsrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKwogeGVuL2FyY2gveDg2L21tL3AybS5jICAgICAgICAgICAgIHwgIDExICstCiB4
ZW4vaW5jbHVkZS9hc20teDg2L21lbV9zaGFyaW5nLmggfCAgMjAgKystCiB4ZW4vaW5jbHVkZS9w
dWJsaWMvbWVtb3J5LmggICAgICAgfCAgIDUgKwogeGVuL2luY2x1ZGUveGVuL3NjaGVkLmggICAg
ICAgICAgIHwgICAyICsKIDcgZmlsZXMgY2hhbmdlZCwgMjY5IGluc2VydGlvbnMoKyksIDQgZGVs
ZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2RvbWFpbi5jIGIveGVuL2FyY2gv
eDg2L2RvbWFpbi5jCmluZGV4IDI4ZmVmYTFmODEuLjYwZDExMGMwOGYgMTAwNjQ0Ci0tLSBhL3hl
bi9hcmNoL3g4Ni9kb21haW4uYworKysgYi94ZW4vYXJjaC94ODYvZG9tYWluLmMKQEAgLTIxOTgs
NiArMjE5OCwxNyBAQCBpbnQgZG9tYWluX3JlbGlucXVpc2hfcmVzb3VyY2VzKHN0cnVjdCBkb21h
aW4gKmQpCiAgICAgICAgICAgICByZXQgPSByZWxpbnF1aXNoX3NoYXJlZF9wYWdlcyhkKTsKICAg
ICAgICAgICAgIGlmICggcmV0ICkKICAgICAgICAgICAgICAgICByZXR1cm4gcmV0OworCisgICAg
ICAgICAgICAvKgorICAgICAgICAgICAgICogSWYgdGhlIGRvbWFpbiBpcyBmb3JrZWQsIGRlY3Jl
bWVudCB0aGUgcGFyZW50J3MgcGF1c2UgY291bnQKKyAgICAgICAgICAgICAqIGFuZCByZWxlYXNl
IHRoZSBkb21haW4uCisgICAgICAgICAgICAgKi8KKyAgICAgICAgICAgIGlmICggZC0+cGFyZW50
ICkKKyAgICAgICAgICAgIHsKKyAgICAgICAgICAgICAgICBkb21haW5fdW5wYXVzZShkLT5wYXJl
bnQpOworICAgICAgICAgICAgICAgIHB1dF9kb21haW4oZC0+cGFyZW50KTsKKyAgICAgICAgICAg
ICAgICBkLT5wYXJlbnQgPSBOVUxMOworICAgICAgICAgICAgfQogICAgICAgICB9CiAjZW5kaWYK
IApkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2h2bS9odm0uYyBiL3hlbi9hcmNoL3g4Ni9odm0v
aHZtLmMKaW5kZXggMDUwNWM3NTY2MS4uZGZmYWI3ZTg5OSAxMDA2NDQKLS0tIGEveGVuL2FyY2gv
eDg2L2h2bS9odm0uYworKysgYi94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCkBAIC0xOTExLDcgKzE5
MTEsNyBAQCBpbnQgaHZtX2hhcF9uZXN0ZWRfcGFnZV9mYXVsdChwYWRkcl90IGdwYSwgdW5zaWdu
ZWQgbG9uZyBnbGEsCiAgICAgfQogI2VuZGlmCiAKLSAgICAvKiBTcHVyaW91cyBmYXVsdD8gUG9E
IGFuZCBsb2ctZGlydHkgYWxzbyB0YWtlIHRoaXMgcGF0aC4gKi8KKyAgICAvKiBTcHVyaW91cyBm
YXVsdD8gUG9ELCBsb2ctZGlydHkgYW5kIFZNIGZvcmtpbmcgYWxzbyB0YWtlIHRoaXMgcGF0aC4g
Ki8KICAgICBpZiAoIHAybV9pc19yYW0ocDJtdCkgKQogICAgIHsKICAgICAgICAgcmMgPSAxOwpk
aWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMgYi94ZW4vYXJjaC94ODYv
bW0vbWVtX3NoYXJpbmcuYwppbmRleCA1MmIxMzljMWJiLi5iNmJlNzg0ODZkIDEwMDY0NAotLS0g
YS94ZW4vYXJjaC94ODYvbW0vbWVtX3NoYXJpbmcuYworKysgYi94ZW4vYXJjaC94ODYvbW0vbWVt
X3NoYXJpbmcuYwpAQCAtMjIsNiArMjIsNyBAQAogCiAjaW5jbHVkZSA8eGVuL3R5cGVzLmg+CiAj
aW5jbHVkZSA8eGVuL2RvbWFpbl9wYWdlLmg+CisjaW5jbHVkZSA8eGVuL2V2ZW50Lmg+CiAjaW5j
bHVkZSA8eGVuL3NwaW5sb2NrLmg+CiAjaW5jbHVkZSA8eGVuL3J3bG9jay5oPgogI2luY2x1ZGUg
PHhlbi9tbS5oPgpAQCAtMzYsNiArMzcsOSBAQAogI2luY2x1ZGUgPGFzbS9hbHRwMm0uaD4KICNp
bmNsdWRlIDxhc20vYXRvbWljLmg+CiAjaW5jbHVkZSA8YXNtL2V2ZW50Lmg+CisjaW5jbHVkZSA8
YXNtL2hhcC5oPgorI2luY2x1ZGUgPGFzbS9odm0vaHZtLmg+CisjaW5jbHVkZSA8YXNtL2h2bS9z
YXZlLmg+CiAjaW5jbHVkZSA8eHNtL3hzbS5oPgogCiAjaW5jbHVkZSAibW0tbG9ja3MuaCIKQEAg
LTE0MjEsNiArMTQyNSwxOTQgQEAgc3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfY29udHJv
bChzdHJ1Y3QgZG9tYWluICpkLCBib29sIGVuYWJsZSkKICAgICByZXR1cm4gMDsKIH0KIAorLyoK
KyAqIEZvcmtpbmcgYSBwYWdlIG9ubHkgZ2V0cyBjYWxsZWQgd2hlbiB0aGUgVk0gZmF1bHRzIGR1
ZSB0byBubyBlbnRyeSBiZWluZworICogaW4gdGhlIEVQVCBmb3IgdGhlIGFjY2Vzcy4gRGVwZW5k
aW5nIG9uIHRoZSB0eXBlIG9mIGFjY2VzcyB3ZSBlaXRoZXIKKyAqIHBvcHVsYXRlIHRoZSBwaHlz
bWFwIHdpdGggYSBzaGFyZWQgZW50cnkgZm9yIHJlYWQtb25seSBhY2Nlc3Mgb3IKKyAqIGZvcmsg
dGhlIHBhZ2UgaWYgaXRzIGEgd3JpdGUgYWNjZXNzLgorICoKKyAqIFRoZSBjbGllbnQgcDJtIGlz
IGFscmVhZHkgbG9ja2VkIHNvIHdlIG9ubHkgbmVlZCB0byBsb2NrCisgKiB0aGUgcGFyZW50J3Mg
aGVyZS4KKyAqLworaW50IG1lbV9zaGFyaW5nX2ZvcmtfcGFnZShzdHJ1Y3QgZG9tYWluICpkLCBn
Zm5fdCBnZm4sIGJvb2wgdW5zaGFyaW5nKQoreworICAgIGludCByYyA9IC1FTk9FTlQ7CisgICAg
c2hyX2hhbmRsZV90IGhhbmRsZTsKKyAgICBzdHJ1Y3QgZG9tYWluICpwYXJlbnQ7CisgICAgc3Ry
dWN0IHAybV9kb21haW4gKnAybTsKKyAgICB1bnNpZ25lZCBsb25nIGdmbl9sID0gZ2ZuX3goZ2Zu
KTsKKyAgICBtZm5fdCBtZm4sIG5ld19tZm47CisgICAgcDJtX3R5cGVfdCBwMm10OworICAgIHN0
cnVjdCBwYWdlX2luZm8gKnBhZ2U7CisKKyAgICBpZiAoICFtZW1fc2hhcmluZ19pc19mb3JrKGQp
ICkKKyAgICAgICAgcmV0dXJuIC1FTk9FTlQ7CisKKyAgICBwYXJlbnQgPSBkLT5wYXJlbnQ7CisK
KyAgICBpZiAoICF1bnNoYXJpbmcgKQorICAgIHsKKyAgICAgICAgLyogRm9yIHJlYWQtb25seSBh
Y2Nlc3NlcyB3ZSBqdXN0IGFkZCBhIHNoYXJlZCBlbnRyeSB0byB0aGUgcGh5c21hcCAqLworICAg
ICAgICB3aGlsZSAoIHBhcmVudCApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggIShyYyA9
IG5vbWluYXRlX3BhZ2UocGFyZW50LCBnZm4sIDAsICZoYW5kbGUpKSApCisgICAgICAgICAgICAg
ICAgYnJlYWs7CisKKyAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC0+cGFyZW50OworICAgICAg
ICB9CisKKyAgICAgICAgaWYgKCAhcmMgKQorICAgICAgICB7CisgICAgICAgICAgICAvKiBUaGUg
Y2xpZW50J3MgcDJtIGlzIGFscmVhZHkgbG9ja2VkICovCisgICAgICAgICAgICBzdHJ1Y3QgcDJt
X2RvbWFpbiAqcHAybSA9IHAybV9nZXRfaG9zdHAybShwYXJlbnQpOworCisgICAgICAgICAgICBw
Mm1fbG9jayhwcDJtKTsKKyAgICAgICAgICAgIHJjID0gYWRkX3RvX3BoeXNtYXAocGFyZW50LCBn
Zm5fbCwgaGFuZGxlLCBkLCBnZm5fbCwgZmFsc2UpOworICAgICAgICAgICAgcDJtX3VubG9jayhw
cDJtKTsKKworICAgICAgICAgICAgaWYgKCAhcmMgKQorICAgICAgICAgICAgICAgIHJldHVybiAw
OworICAgICAgICB9CisgICAgfQorCisgICAgLyoKKyAgICAgKiBJZiBpdCdzIGEgd3JpdGUgYWNj
ZXNzIChpZS4gdW5zaGFyaW5nKSBvciBpZiBhZGRpbmcgYSBzaGFyZWQgZW50cnkgdG8KKyAgICAg
KiB0aGUgcGh5c21hcCBmYWlsZWQgd2UnbGwgZm9yayB0aGUgcGFnZSBkaXJlY3RseS4KKyAgICAg
Ki8KKyAgICBwMm0gPSBwMm1fZ2V0X2hvc3RwMm0oZCk7CisgICAgcGFyZW50ID0gZC0+cGFyZW50
OworCisgICAgd2hpbGUgKCBwYXJlbnQgKQorICAgIHsKKyAgICAgICAgbWZuID0gZ2V0X2dmbl9x
dWVyeShwYXJlbnQsIGdmbl9sLCAmcDJtdCk7CisKKyAgICAgICAgaWYgKCBtZm5fdmFsaWQobWZu
KSAmJiBwMm1faXNfYW55X3JhbShwMm10KSApCisgICAgICAgICAgICBicmVhazsKKworICAgICAg
ICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworICAgICAgICBwYXJlbnQgPSBwYXJlbnQtPnBhcmVu
dDsKKyAgICB9CisKKyAgICBpZiAoICFwYXJlbnQgKQorICAgICAgICByZXR1cm4gLUVOT0VOVDsK
KworICAgIGlmICggIShwYWdlID0gYWxsb2NfZG9taGVhcF9wYWdlKGQsIDApKSApCisgICAgewor
ICAgICAgICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworICAgICAgICByZXR1cm4gLUVOT01FTTsK
KyAgICB9CisKKyAgICBuZXdfbWZuID0gcGFnZV90b19tZm4ocGFnZSk7CisgICAgY29weV9kb21h
aW5fcGFnZShuZXdfbWZuLCBtZm4pOworICAgIHNldF9ncGZuX2Zyb21fbWZuKG1mbl94KG5ld19t
Zm4pLCBnZm5fbCk7CisKKyAgICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworCisgICAgcmV0dXJu
IHAybS0+c2V0X2VudHJ5KHAybSwgZ2ZuLCBuZXdfbWZuLCBQQUdFX09SREVSXzRLLCBwMm1fcmFt
X3J3LAorICAgICAgICAgICAgICAgICAgICAgICAgICBwMm0tPmRlZmF1bHRfYWNjZXNzLCAtMSk7
Cit9CisKK3N0YXRpYyBpbnQgYnJpbmdfdXBfdmNwdXMoc3RydWN0IGRvbWFpbiAqY2QsIHN0cnVj
dCBjcHVwb29sICpjcHVwb29sKQoreworICAgIGludCByZXQ7CisgICAgdW5zaWduZWQgaW50IGk7
CisKKyAgICBpZiAoIChyZXQgPSBjcHVwb29sX21vdmVfZG9tYWluKGNkLCBjcHVwb29sKSkgKQor
ICAgICAgICByZXR1cm4gcmV0OworCisgICAgZm9yICggaSA9IDA7IGkgPCBjZC0+bWF4X3ZjcHVz
OyBpKysgKQorICAgIHsKKyAgICAgICAgaWYgKCBjZC0+dmNwdVtpXSApCisgICAgICAgICAgICBj
b250aW51ZTsKKworICAgICAgICBpZiAoICF2Y3B1X2NyZWF0ZShjZCwgaSkgKQorICAgICAgICAg
ICAgcmV0dXJuIC1FSU5WQUw7CisgICAgfQorCisgICAgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmlu
aXR5KGNkKTsKKyAgICByZXR1cm4gMDsKK30KKworc3RhdGljIGludCBmb3JrX2hhcF9hbGxvY2F0
aW9uKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkKQoreworICAgIGludCByYzsK
KyAgICBib29sIHByZWVtcHRlZDsKKyAgICB1bnNpZ25lZCBsb25nIG1iID0gaGFwX2dldF9hbGxv
Y2F0aW9uKGQpOworCisgICAgaWYgKCBtYiA9PSBoYXBfZ2V0X2FsbG9jYXRpb24oY2QpICkKKyAg
ICAgICAgcmV0dXJuIDA7CisKKyAgICBwYWdpbmdfbG9jayhjZCk7CisgICAgcmMgPSBoYXBfc2V0
X2FsbG9jYXRpb24oY2QsIG1iIDw8ICgyMCAtIFBBR0VfU0hJRlQpLCAmcHJlZW1wdGVkKTsKKyAg
ICBwYWdpbmdfdW5sb2NrKGNkKTsKKworICAgIGlmICggcmMgKQorICAgICAgICByZXR1cm4gcmM7
CisKKyAgICBpZiAoIHByZWVtcHRlZCApCisgICAgICAgIHJldHVybiAtRVJFU1RBUlQ7CisKKyAg
ICByZXR1cm4gMDsKK30KKworc3RhdGljIHZvaWQgZm9ya190c2Moc3RydWN0IGRvbWFpbiAqZCwg
c3RydWN0IGRvbWFpbiAqY2QpCit7CisgICAgdWludDMyX3QgdHNjX21vZGU7CisgICAgdWludDMy
X3QgZ3RzY19raHo7CisgICAgdWludDMyX3QgaW5jYXJuYXRpb247CisgICAgdWludDY0X3QgZWxh
cHNlZF9uc2VjOworCisgICAgdHNjX2dldF9pbmZvKGQsICZ0c2NfbW9kZSwgJmVsYXBzZWRfbnNl
YywgJmd0c2Nfa2h6LCAmaW5jYXJuYXRpb24pOworICAgIHRzY19zZXRfaW5mbyhjZCwgdHNjX21v
ZGUsIGVsYXBzZWRfbnNlYywgZ3RzY19raHosIGluY2FybmF0aW9uKTsKK30KKworc3RhdGljIGlu
dCBtZW1fc2hhcmluZ19mb3JrKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkKQor
eworICAgIGludCByYyA9IC1FSU5WQUw7CisKKyAgICBpZiAoICFjZC0+Y29udHJvbGxlcl9wYXVz
ZV9jb3VudCApCisgICAgICAgIHJldHVybiByYzsKKworICAgIC8qCisgICAgICogV2Ugb25seSB3
YW50IHRvIGdldCBhbmQgcGF1c2UgdGhlIHBhcmVudCBvbmNlLCBub3QgZWFjaCB0aW1lIHRoaXMK
KyAgICAgKiBvcGVyYXRpb24gaXMgcmVzdGFydGVkIGR1ZSB0byBwcmVlbXB0aW9uLgorICAgICAq
LworICAgIGlmICggIWNkLT5wYXJlbnRfcGF1c2VkICkKKyAgICB7CisgICAgICAgIGlmICggZ2V0
X2RvbWFpbihkKSApCisgICAgICAgICAgICByZXR1cm4gcmM7CisKKyAgICAgICAgZG9tYWluX3Bh
dXNlKGQpOworICAgICAgICBjZC0+cGFyZW50X3BhdXNlZCA9IHRydWU7CisgICAgfQorCisgICAg
Y2QtPm1heF9wYWdlcyA9IGQtPm1heF9wYWdlczsKKyAgICBjZC0+bWF4X3ZjcHVzID0gZC0+bWF4
X3ZjcHVzOworCisgICAgLyogdGhpcyBpcyBwcmVlbXB0aWJsZSBzbyBpdCdzIHRoZSBmaXJzdCB0
byBnZXQgZG9uZSAqLworICAgIGlmICggKHJjID0gZm9ya19oYXBfYWxsb2NhdGlvbihkLCBjZCkp
ICkKKyAgICAgICAgZ290byBkb25lOworCisgICAgaWYgKCAocmMgPSBicmluZ191cF92Y3B1cyhj
ZCwgZC0+Y3B1cG9vbCkpICkKKyAgICAgICAgZ290byBkb25lOworCisgICAgaWYgKCAocmMgPSBo
dm1fY29weV9jb250ZXh0X2FuZF9wYXJhbXMoY2QsIGQpKSApCisgICAgICAgIGdvdG8gZG9uZTsK
KworICAgIGZvcmtfdHNjKGQsIGNkKTsKKworICAgIGNkLT5wYXJlbnQgPSBkOworCisgZG9uZToK
KyAgICBpZiAoIHJjICYmIHJjICE9IC1FUkVTVEFSVCApCisgICAgeworICAgICAgICBkb21haW5f
dW5wYXVzZShkKTsKKyAgICAgICAgY2QtPnBhcmVudF9wYXVzZWQgPSBmYWxzZTsKKyAgICB9CisK
KyAgICByZXR1cm4gcmM7Cit9CisKIGludCBtZW1fc2hhcmluZ19tZW1vcChYRU5fR1VFU1RfSEFO
RExFX1BBUkFNKHhlbl9tZW1fc2hhcmluZ19vcF90KSBhcmcpCiB7CiAgICAgaW50IHJjOwpAQCAt
MTY3NSw2ICsxODY3LDM2IEBAIGludCBtZW1fc2hhcmluZ19tZW1vcChYRU5fR1VFU1RfSEFORExF
X1BBUkFNKHhlbl9tZW1fc2hhcmluZ19vcF90KSBhcmcpCiAgICAgICAgIHJjID0gZGVidWdfZ3Jl
ZihkLCBtc28udS5kZWJ1Zy51LmdyZWYpOwogICAgICAgICBicmVhazsKIAorICAgIGNhc2UgWEVO
TUVNX3NoYXJpbmdfb3BfZm9yazoKKyAgICB7CisgICAgICAgIHN0cnVjdCBkb21haW4gKnBkOwor
CisgICAgICAgIHJjID0gLUVJTlZBTDsKKyAgICAgICAgaWYgKCBtc28udS5mb3JrLl9wYWRbMF0g
fHwgbXNvLnUuZm9yay5fcGFkWzFdIHx8CisgICAgICAgICAgICAgbXNvLnUuZm9yay5fcGFkWzJd
ICkKKyAgICAgICAgICAgIGdvdG8gb3V0OworCisgICAgICAgIHJjID0gcmN1X2xvY2tfbGl2ZV9y
ZW1vdGVfZG9tYWluX2J5X2lkKG1zby51LmZvcmsucGFyZW50X2RvbWFpbiwKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJnBkKTsKKyAgICAgICAgaWYgKCBy
YyApCisgICAgICAgICAgICBnb3RvIG91dDsKKworICAgICAgICBpZiAoICFtZW1fc2hhcmluZ19l
bmFibGVkKHBkKSApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggKHJjID0gbWVtX3NoYXJp
bmdfY29udHJvbChwZCwgdHJ1ZSkpICkKKyAgICAgICAgICAgICAgICBnb3RvIG91dDsKKyAgICAg
ICAgfQorCisgICAgICAgIHJjID0gbWVtX3NoYXJpbmdfZm9yayhwZCwgZCk7CisKKyAgICAgICAg
aWYgKCByYyA9PSAtRVJFU1RBUlQgKQorICAgICAgICAgICAgcmMgPSBoeXBlcmNhbGxfY3JlYXRl
X2NvbnRpbnVhdGlvbihfX0hZUEVSVklTT1JfbWVtb3J5X29wLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGgiLCBYRU5NRU1fc2hhcmluZ19vcCwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnKTsKKyAgICAg
ICAgcmN1X3VubG9ja19kb21haW4ocGQpOworICAgICAgICBicmVhazsKKyAgICB9CisKICAgICBk
ZWZhdWx0OgogICAgICAgICByYyA9IC1FTk9TWVM7CiAgICAgICAgIGJyZWFrOwpkaWZmIC0tZ2l0
IGEveGVuL2FyY2gveDg2L21tL3AybS5jIGIveGVuL2FyY2gveDg2L21tL3AybS5jCmluZGV4IGY1
NDM2MGI0M2QuLmQxMjg5NjMwMzYgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9tbS9wMm0uYwor
KysgYi94ZW4vYXJjaC94ODYvbW0vcDJtLmMKQEAgLTUwOSw2ICs1MDksMTQgQEAgbWZuX3QgX19n
ZXRfZ2ZuX3R5cGVfYWNjZXNzKHN0cnVjdCBwMm1fZG9tYWluICpwMm0sIHVuc2lnbmVkIGxvbmcg
Z2ZuX2wsCiAKICAgICBtZm4gPSBwMm0tPmdldF9lbnRyeShwMm0sIGdmbiwgdCwgYSwgcSwgcGFn
ZV9vcmRlciwgTlVMTCk7CiAKKyAgICAvKiBDaGVjayBpZiB3ZSBuZWVkIHRvIGZvcmsgdGhlIHBh
Z2UgKi8KKyAgICBpZiAoIChxICYgUDJNX0FMTE9DKSAmJiBwMm1faXNfaG9sZSgqdCkgJiYKKyAg
ICAgICAgICFtZW1fc2hhcmluZ19mb3JrX3BhZ2UocDJtLT5kb21haW4sIGdmbiwgISEocSAmIFAy
TV9VTlNIQVJFKSkgKQorICAgIHsKKyAgICAgICAgbWZuID0gcDJtLT5nZXRfZW50cnkocDJtLCBn
Zm4sIHQsIGEsIHEsIHBhZ2Vfb3JkZXIsIE5VTEwpOworICAgIH0KKworICAgIC8qIENoZWNrIGlm
IHdlIG5lZWQgdG8gdW5zaGFyZSB0aGUgcGFnZSAqLwogICAgIGlmICggKHEgJiBQMk1fVU5TSEFS
RSkgJiYgcDJtX2lzX3NoYXJlZCgqdCkgKQogICAgIHsKICAgICAgICAgQVNTRVJUKHAybV9pc19o
b3N0cDJtKHAybSkpOwpAQCAtNTg3LDcgKzU5NSw4IEBAIHN0cnVjdCBwYWdlX2luZm8gKnAybV9n
ZXRfcGFnZV9mcm9tX2dmbigKICAgICAgICAgICAgIHJldHVybiBwYWdlOwogCiAgICAgICAgIC8q
IEVycm9yIHBhdGg6IG5vdCBhIHN1aXRhYmxlIEdGTiBhdCBhbGwgKi8KLSAgICAgICAgaWYgKCAh
cDJtX2lzX3JhbSgqdCkgJiYgIXAybV9pc19wYWdpbmcoKnQpICYmICFwMm1faXNfcG9kKCp0KSAp
CisgICAgICAgIGlmICggIXAybV9pc19yYW0oKnQpICYmICFwMm1faXNfcGFnaW5nKCp0KSAmJiAh
cDJtX2lzX3BvZCgqdCkgJiYKKyAgICAgICAgICAgICAhbWVtX3NoYXJpbmdfaXNfZm9yayhwMm0t
PmRvbWFpbikgKQogICAgICAgICAgICAgcmV0dXJuIE5VTEw7CiAgICAgfQogCmRpZmYgLS1naXQg
YS94ZW4vaW5jbHVkZS9hc20teDg2L21lbV9zaGFyaW5nLmggYi94ZW4vaW5jbHVkZS9hc20teDg2
L21lbV9zaGFyaW5nLmgKaW5kZXggNTM3NjBhMjg5Ni4uODEyMTcxMjg0ZiAxMDA2NDQKLS0tIGEv
eGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oCisrKyBiL3hlbi9pbmNsdWRlL2FzbS14
ODYvbWVtX3NoYXJpbmcuaApAQCAtMjYsOCArMjYsNyBAQAogCiAjaWZkZWYgQ09ORklHX01FTV9T
SEFSSU5HCiAKLXN0cnVjdCBtZW1fc2hhcmluZ19kb21haW4KLXsKK3N0cnVjdCBtZW1fc2hhcmlu
Z19kb21haW4gewogICAgIGJvb2wgZW5hYmxlZDsKIAogICAgIC8qCkBAIC0zOSw2ICszOCw5IEBA
IHN0cnVjdCBtZW1fc2hhcmluZ19kb21haW4KIAogI2RlZmluZSBtZW1fc2hhcmluZ19lbmFibGVk
KGQpICgoZCktPmFyY2guaHZtLm1lbV9zaGFyaW5nLmVuYWJsZWQpCiAKKyNkZWZpbmUgbWVtX3No
YXJpbmdfaXNfZm9yayhkKSBcCisgICAgKG1lbV9zaGFyaW5nX2VuYWJsZWQoZCkgJiYgISEoKGQp
LT5wYXJlbnQpKQorCiAvKiBBdWRpdGluZyBvZiBtZW1vcnkgc2hhcmluZyBjb2RlPyAqLwogI2lm
bmRlZiBOREVCVUcKICNkZWZpbmUgTUVNX1NIQVJJTkdfQVVESVQgMQpAQCAtODgsNiArOTAsOSBA
QCBzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ191bnNoYXJlX3BhZ2Uoc3RydWN0IGRvbWFp
biAqZCwKICAgICByZXR1cm4gcmM7CiB9CiAKK2ludCBtZW1fc2hhcmluZ19mb3JrX3BhZ2Uoc3Ry
dWN0IGRvbWFpbiAqZCwgZ2ZuX3QgZ2ZuLAorICAgICAgICAgICAgICAgICAgICAgICAgICBib29s
IHVuc2hhcmluZyk7CisKIC8qCiAgKiBJZiBjYWxsZWQgYnkgYSBmb3JlaWduIGRvbWFpbiwgcG9z
c2libGUgZXJyb3JzIGFyZQogICogICAtRUJVU1kgLT4gcmluZyBmdWxsCkBAIC0xMTcsNiArMTIy
LDcgQEAgaW50IHJlbGlucXVpc2hfc2hhcmVkX3BhZ2VzKHN0cnVjdCBkb21haW4gKmQpOwogI2Vs
c2UKIAogI2RlZmluZSBtZW1fc2hhcmluZ19lbmFibGVkKGQpIGZhbHNlCisjZGVmaW5lIG1lbV9z
aGFyaW5nX2lzX2ZvcmsocDJtKSBmYWxzZQogCiBzdGF0aWMgaW5saW5lIHVuc2lnbmVkIGludCBt
ZW1fc2hhcmluZ19nZXRfbnJfc2F2ZWRfbWZucyh2b2lkKQogewpAQCAtMTQxLDYgKzE0NywxNiBA
QCBzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ19ub3RpZnlfZW5vbWVtKHN0cnVjdCBkb21h
aW4gKmQsIHVuc2lnbmVkIGxvbmcgZ2ZuLAogICAgIHJldHVybiAtRU9QTk9UU1VQUDsKIH0KIAor
c3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfZm9yayhzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1
Y3QgZG9tYWluICpjZCwgYm9vbCB2Y3B1KQoreworICAgIHJldHVybiAtRU9QTk9UU1VQUDsKK30K
Kworc3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfZm9ya19wYWdlKHN0cnVjdCBkb21haW4g
KmQsIGdmbl90IGdmbiwgYm9vbCBsb2NrKQoreworICAgIHJldHVybiAtRU9QTk9UU1VQUDsKK30K
KwogI2VuZGlmCiAKICNlbmRpZiAvKiBfX01FTV9TSEFSSU5HX0hfXyAqLwpkaWZmIC0tZ2l0IGEv
eGVuL2luY2x1ZGUvcHVibGljL21lbW9yeS5oIGIveGVuL2luY2x1ZGUvcHVibGljL21lbW9yeS5o
CmluZGV4IGNmZGRhNmUyYTguLjkwYTNmNDQ5OGUgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3B1
YmxpYy9tZW1vcnkuaAorKysgYi94ZW4vaW5jbHVkZS9wdWJsaWMvbWVtb3J5LmgKQEAgLTQ4Miw2
ICs0ODIsNyBAQCBERUZJTkVfWEVOX0dVRVNUX0hBTkRMRSh4ZW5fbWVtX2FjY2Vzc19vcF90KTsK
ICNkZWZpbmUgWEVOTUVNX3NoYXJpbmdfb3BfYWRkX3BoeXNtYXAgICAgICAgNgogI2RlZmluZSBY
RU5NRU1fc2hhcmluZ19vcF9hdWRpdCAgICAgICAgICAgICA3CiAjZGVmaW5lIFhFTk1FTV9zaGFy
aW5nX29wX3JhbmdlX3NoYXJlICAgICAgIDgKKyNkZWZpbmUgWEVOTUVNX3NoYXJpbmdfb3BfZm9y
ayAgICAgICAgICAgICAgOQogCiAjZGVmaW5lIFhFTk1FTV9TSEFSSU5HX09QX1NfSEFORExFX0lO
VkFMSUQgICgtMTApCiAjZGVmaW5lIFhFTk1FTV9TSEFSSU5HX09QX0NfSEFORExFX0lOVkFMSUQg
ICgtOSkKQEAgLTUzMiw2ICs1MzMsMTAgQEAgc3RydWN0IHhlbl9tZW1fc2hhcmluZ19vcCB7CiAg
ICAgICAgICAgICAgICAgdWludDMyX3QgZ3JlZjsgICAgIC8qIElOOiBncmVmIHRvIGRlYnVnICAg
ICAgICAgKi8KICAgICAgICAgICAgIH0gdTsKICAgICAgICAgfSBkZWJ1ZzsKKyAgICAgICAgc3Ry
dWN0IG1lbV9zaGFyaW5nX29wX2ZvcmsgeworICAgICAgICAgICAgZG9taWRfdCBwYXJlbnRfZG9t
YWluOworICAgICAgICAgICAgdWludDE2X3QgX3BhZFszXTsgICAgICAgICAgICAgICAgLyogTXVz
dCBiZSBzZXQgdG8gMCAqLworICAgICAgICB9IGZvcms7CiAgICAgfSB1OwogfTsKIHR5cGVkZWYg
c3RydWN0IHhlbl9tZW1fc2hhcmluZ19vcCB4ZW5fbWVtX3NoYXJpbmdfb3BfdDsKZGlmZiAtLWdp
dCBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKaW5k
ZXggN2M1YzQzNzI0Ny4uOGVkNzI3ZTEwYyAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3Nj
aGVkLmgKKysrIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKQEAgLTUwNyw2ICs1MDcsOCBAQCBz
dHJ1Y3QgZG9tYWluCiAgICAgLyogTWVtb3J5IHNoYXJpbmcgc3VwcG9ydCAqLwogI2lmZGVmIENP
TkZJR19NRU1fU0hBUklORwogICAgIHN0cnVjdCB2bV9ldmVudF9kb21haW4gKnZtX2V2ZW50X3No
YXJlOworICAgIHN0cnVjdCBkb21haW4gKnBhcmVudDsgLyogVk0gZm9yayBwYXJlbnQgKi8KKyAg
ICBib29sIHBhcmVudF9wYXVzZWQ7CiAjZW5kaWYKICAgICAvKiBNZW1vcnkgcGFnaW5nIHN1cHBv
cnQgKi8KICNpZmRlZiBDT05GSUdfSEFTX01FTV9QQUdJTkcKLS0gCjIuMjAuMQoKCl9fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5n
IGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJv
amVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

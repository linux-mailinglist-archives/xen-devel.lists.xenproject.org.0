Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 7D67B1348F1
	for <lists+xen-devel@lfdr.de>; Wed,  8 Jan 2020 18:16:52 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ipEum-0000TO-FS; Wed, 08 Jan 2020 17:14:40 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=uSPe=25=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1ipEuk-0000T4-Q2
 for xen-devel@lists.xenproject.org; Wed, 08 Jan 2020 17:14:38 +0000
X-Inumbo-ID: 5603e6bd-323a-11ea-b85f-12813bfff9fa
Received: from mga14.intel.com (unknown [192.55.52.115])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 5603e6bd-323a-11ea-b85f-12813bfff9fa;
 Wed, 08 Jan 2020 17:14:33 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga005.jf.intel.com ([10.7.209.41])
 by fmsmga103.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 08 Jan 2020 09:14:31 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,410,1571727600"; d="scan'208";a="395806065"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.251.132.23])
 by orsmga005.jf.intel.com with ESMTP; 08 Jan 2020 09:14:31 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Wed,  8 Jan 2020 09:13:58 -0800
Message-Id: <b1d48d7dd680041709d5fc4ca2562560690c8db4.1578503483.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1578503483.git.tamas.lengyel@intel.com>
References: <cover.1578503483.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v4 01/18] x86/hvm: introduce
 hvm_copy_context_and_params
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q3VycmVudGx5IHRoZSBodm0gcGFyYW1ldGVycyBhcmUgb25seSBhY2Nlc3NpYmxlIHZpYSB0aGUg
SFZNT1AgaHlwZXJjYWxscy4gSW4KdGhpcyBwYXRjaCB3ZSBpbnRyb2R1Y2UgYSBuZXcgZnVuY3Rp
b24gdGhhdCBjYW4gY29weSBib3RoIHRoZSBodm0gY29udGV4dCBhbmQKcGFyYW1ldGVycyBkaXJl
Y3RseSBpbnRvIGEgdGFyZ2V0IGRvbWFpbi4KClNpZ25lZC1vZmYtYnk6IFRhbWFzIEsgTGVuZ3ll
bCA8dGFtYXMubGVuZ3llbEBpbnRlbC5jb20+Ci0tLQogeGVuL2FyY2gveDg2L2h2bS9odm0uYyAg
ICAgICAgfCAyNDEgKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLQogeGVuL2luY2x1
ZGUvYXNtLXg4Ni9odm0vaHZtLmggfCAgIDIgKwogMiBmaWxlcyBjaGFuZ2VkLCAxNTIgaW5zZXJ0
aW9ucygrKSwgOTEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2h2bS9o
dm0uYyBiL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMKaW5kZXggNDcyM2Y1ZDA5Yy4uMjRmMDhkNzA0
MyAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L2h2bS9odm0uYworKysgYi94ZW4vYXJjaC94ODYv
aHZtL2h2bS5jCkBAIC00MDY3LDE2ICs0MDY3LDE3IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X2V2
dGNobl91cGNhbGxfdmVjdG9yKAogfQogCiBzdGF0aWMgaW50IGh2bV9hbGxvd19zZXRfcGFyYW0o
c3RydWN0IGRvbWFpbiAqZCwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBz
dHJ1Y3QgeGVuX2h2bV9wYXJhbSAqYSkKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1
aW50MzJfdCBpbmRleCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50NjRfdCBu
ZXdfdmFsdWUpCiB7Ci0gICAgdWludDY0X3QgdmFsdWUgPSBkLT5hcmNoLmh2bS5wYXJhbXNbYS0+
aW5kZXhdOworICAgIHVpbnQ2NF90IHZhbHVlID0gZC0+YXJjaC5odm0ucGFyYW1zW2luZGV4XTsK
ICAgICBpbnQgcmM7CiAKICAgICByYyA9IHhzbV9odm1fcGFyYW0oWFNNX1RBUkdFVCwgZCwgSFZN
T1Bfc2V0X3BhcmFtKTsKICAgICBpZiAoIHJjICkKICAgICAgICAgcmV0dXJuIHJjOwogCi0gICAg
c3dpdGNoICggYS0+aW5kZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAgICB7CiAgICAgLyog
VGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzIGNhbiBiZSBzZXQgYnkgdGhlIGd1ZXN0LiAqLwogICAg
IGNhc2UgSFZNX1BBUkFNX0NBTExCQUNLX0lSUToKQEAgLTQxMDksNyArNDExMCw3IEBAIHN0YXRp
YyBpbnQgaHZtX2FsbG93X3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIGlmICggcmMg
KQogICAgICAgICByZXR1cm4gcmM7CiAKLSAgICBzd2l0Y2ggKCBhLT5pbmRleCApCisgICAgc3dp
dGNoICggaW5kZXggKQogICAgIHsKICAgICAvKiBUaGUgZm9sbG93aW5nIHBhcmFtZXRlcnMgc2hv
dWxkIG9ubHkgYmUgY2hhbmdlZCBvbmNlLiAqLwogICAgIGNhc2UgSFZNX1BBUkFNX1ZJUklESUFO
OgpAQCAtNDExOSw3ICs0MTIwLDcgQEAgc3RhdGljIGludCBodm1fYWxsb3dfc2V0X3BhcmFtKHN0
cnVjdCBkb21haW4gKmQsCiAgICAgY2FzZSBIVk1fUEFSQU1fTlJfSU9SRVFfU0VSVkVSX1BBR0VT
OgogICAgIGNhc2UgSFZNX1BBUkFNX0FMVFAyTToKICAgICBjYXNlIEhWTV9QQVJBTV9NQ0FfQ0FQ
OgotICAgICAgICBpZiAoIHZhbHVlICE9IDAgJiYgYS0+dmFsdWUgIT0gdmFsdWUgKQorICAgICAg
ICBpZiAoIHZhbHVlICE9IDAgJiYgbmV3X3ZhbHVlICE9IHZhbHVlICkKICAgICAgICAgICAgIHJj
ID0gLUVFWElTVDsKICAgICAgICAgYnJlYWs7CiAgICAgZGVmYXVsdDoKQEAgLTQxMjksNDkgKzQx
MzAsMzIgQEAgc3RhdGljIGludCBodm1fYWxsb3dfc2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQs
CiAgICAgcmV0dXJuIHJjOwogfQogCi1zdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgKLSAgICBY
RU5fR1VFU1RfSEFORExFX1BBUkFNKHhlbl9odm1fcGFyYW1fdCkgYXJnKQorc3RhdGljIGludCBo
dm1fc2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsIHVpbnQzMl90IGluZGV4LCB1aW50NjRfdCB2
YWx1ZSkKIHsKICAgICBzdHJ1Y3QgZG9tYWluICpjdXJyX2QgPSBjdXJyZW50LT5kb21haW47Ci0g
ICAgc3RydWN0IHhlbl9odm1fcGFyYW0gYTsKLSAgICBzdHJ1Y3QgZG9tYWluICpkOwotICAgIHN0
cnVjdCB2Y3B1ICp2OwogICAgIGludCByYzsKKyAgICBzdHJ1Y3QgdmNwdSAqdjsKIAotICAgIGlm
ICggY29weV9mcm9tX2d1ZXN0KCZhLCBhcmcsIDEpICkKLSAgICAgICAgcmV0dXJuIC1FRkFVTFQ7
Ci0KLSAgICBpZiAoIGEuaW5kZXggPj0gSFZNX05SX1BBUkFNUyApCisgICAgaWYgKCBpbmRleCA+
PSBIVk1fTlJfUEFSQU1TICkKICAgICAgICAgcmV0dXJuIC1FSU5WQUw7CiAKLSAgICAvKiBNYWtl
IHN1cmUgdGhlIGFib3ZlIGJvdW5kIGNoZWNrIGlzIG5vdCBieXBhc3NlZCBkdXJpbmcgc3BlY3Vs
YXRpb24uICovCi0gICAgYmxvY2tfc3BlY3VsYXRpb24oKTsKLQotICAgIGQgPSByY3VfbG9ja19k
b21haW5fYnlfYW55X2lkKGEuZG9taWQpOwotICAgIGlmICggZCA9PSBOVUxMICkKLSAgICAgICAg
cmV0dXJuIC1FU1JDSDsKLQotICAgIHJjID0gLUVJTlZBTDsKLSAgICBpZiAoICFpc19odm1fZG9t
YWluKGQpICkKLSAgICAgICAgZ290byBvdXQ7Ci0KLSAgICByYyA9IGh2bV9hbGxvd19zZXRfcGFy
YW0oZCwgJmEpOworICAgIHJjID0gaHZtX2FsbG93X3NldF9wYXJhbShkLCBpbmRleCwgdmFsdWUp
OwogICAgIGlmICggcmMgKQogICAgICAgICBnb3RvIG91dDsKIAotICAgIHN3aXRjaCAoIGEuaW5k
ZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAgICB7CiAgICAgY2FzZSBIVk1fUEFSQU1fQ0FM
TEJBQ0tfSVJROgotICAgICAgICBodm1fc2V0X2NhbGxiYWNrX3ZpYShkLCBhLnZhbHVlKTsKKyAg
ICAgICAgaHZtX3NldF9jYWxsYmFja192aWEoZCwgdmFsdWUpOwogICAgICAgICBodm1fbGF0Y2hf
c2hpbmZvX3NpemUoZCk7CiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX1RJTUVS
X01PREU6Ci0gICAgICAgIGlmICggYS52YWx1ZSA+IEhWTVBUTV9vbmVfbWlzc2VkX3RpY2tfcGVu
ZGluZyApCisgICAgICAgIGlmICggdmFsdWUgPiBIVk1QVE1fb25lX21pc3NlZF90aWNrX3BlbmRp
bmcgKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAgICBicmVhazsKICAgICBjYXNl
IEhWTV9QQVJBTV9WSVJJRElBTjoKLSAgICAgICAgaWYgKCAoYS52YWx1ZSAmIH5IVk1QVl9mZWF0
dXJlX21hc2spIHx8Ci0gICAgICAgICAgICAgIShhLnZhbHVlICYgSFZNUFZfYmFzZV9mcmVxKSAp
CisgICAgICAgIGlmICggKHZhbHVlICYgfkhWTVBWX2ZlYXR1cmVfbWFzaykgfHwKKyAgICAgICAg
ICAgICAhKHZhbHVlICYgSFZNUFZfYmFzZV9mcmVxKSApCiAgICAgICAgICAgICByYyA9IC1FSU5W
QUw7CiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX0lERU5UX1BUOgpAQCAtNDE4
MSw3ICs0MTY1LDcgQEAgc3RhdGljIGludCBodm1vcF9zZXRfcGFyYW0oCiAgICAgICAgICAqLwog
ICAgICAgICBpZiAoICFwYWdpbmdfbW9kZV9oYXAoZCkgfHwgIWNwdV9oYXNfdm14ICkKICAgICAg
ICAgewotICAgICAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1zW2EuaW5kZXhdID0gYS52YWx1ZTsK
KyAgICAgICAgICAgIGQtPmFyY2guaHZtLnBhcmFtc1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICAg
ICAgIGJyZWFrOwogICAgICAgICB9CiAKQEAgLTQxOTYsNyArNDE4MCw3IEBAIHN0YXRpYyBpbnQg
aHZtb3Bfc2V0X3BhcmFtKAogCiAgICAgICAgIHJjID0gMDsKICAgICAgICAgZG9tYWluX3BhdXNl
KGQpOwotICAgICAgICBkLT5hcmNoLmh2bS5wYXJhbXNbYS5pbmRleF0gPSBhLnZhbHVlOworICAg
ICAgICBkLT5hcmNoLmh2bS5wYXJhbXNbaW5kZXhdID0gdmFsdWU7CiAgICAgICAgIGZvcl9lYWNo
X3ZjcHUgKCBkLCB2ICkKICAgICAgICAgICAgIHBhZ2luZ191cGRhdGVfY3IzKHYsIGZhbHNlKTsK
ICAgICAgICAgZG9tYWluX3VucGF1c2UoZCk7CkBAIC00MjA1LDIzICs0MTg5LDIzIEBAIHN0YXRp
YyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJB
TV9ETV9ET01BSU46CiAgICAgICAgIC8qIFRoZSBvbmx5IHZhbHVlIHRoaXMgc2hvdWxkIGV2ZXIg
YmUgc2V0IHRvIGlzIERPTUlEX1NFTEYgKi8KLSAgICAgICAgaWYgKCBhLnZhbHVlICE9IERPTUlE
X1NFTEYgKQorICAgICAgICBpZiAoIHZhbHVlICE9IERPTUlEX1NFTEYgKQogICAgICAgICAgICAg
cmMgPSAtRUlOVkFMOwogCi0gICAgICAgIGEudmFsdWUgPSBjdXJyX2QtPmRvbWFpbl9pZDsKKyAg
ICAgICAgdmFsdWUgPSBjdXJyX2QtPmRvbWFpbl9pZDsKICAgICAgICAgYnJlYWs7CiAgICAgY2Fz
ZSBIVk1fUEFSQU1fQUNQSV9TX1NUQVRFOgogICAgICAgICByYyA9IDA7Ci0gICAgICAgIGlmICgg
YS52YWx1ZSA9PSAzICkKKyAgICAgICAgaWYgKCB2YWx1ZSA9PSAzICkKICAgICAgICAgICAgIGh2
bV9zM19zdXNwZW5kKGQpOwotICAgICAgICBlbHNlIGlmICggYS52YWx1ZSA9PSAwICkKKyAgICAg
ICAgZWxzZSBpZiAoIHZhbHVlID09IDAgKQogICAgICAgICAgICAgaHZtX3MzX3Jlc3VtZShkKTsK
ICAgICAgICAgZWxzZQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogCiAgICAgICAgIGJyZWFr
OwogICAgIGNhc2UgSFZNX1BBUkFNX0FDUElfSU9QT1JUU19MT0NBVElPTjoKLSAgICAgICAgcmMg
PSBwbXRpbWVyX2NoYW5nZV9pb3BvcnQoZCwgYS52YWx1ZSk7CisgICAgICAgIHJjID0gcG10aW1l
cl9jaGFuZ2VfaW9wb3J0KGQsIHZhbHVlKTsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1f
UEFSQU1fTUVNT1JZX0VWRU5UX0NSMDoKICAgICBjYXNlIEhWTV9QQVJBTV9NRU1PUllfRVZFTlRf
Q1IzOgpAQCAtNDIzNiwyNCArNDIyMCwyNCBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgK
ICAgICAgICAgcmMgPSB4c21faHZtX3BhcmFtX25lc3RlZChYU01fUFJJViwgZCk7CiAgICAgICAg
IGlmICggcmMgKQogICAgICAgICAgICAgYnJlYWs7Ci0gICAgICAgIGlmICggYS52YWx1ZSA+IDEg
KQorICAgICAgICBpZiAoIHZhbHVlID4gMSApCiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAg
ICAgICAgIC8qCiAgICAgICAgICAqIFJlbW92ZSB0aGUgY2hlY2sgYmVsb3cgb25jZSB3ZSBoYXZl
CiAgICAgICAgICAqIHNoYWRvdy1vbi1zaGFkb3cuCiAgICAgICAgICAqLwotICAgICAgICBpZiAo
ICFwYWdpbmdfbW9kZV9oYXAoZCkgJiYgYS52YWx1ZSApCisgICAgICAgIGlmICggIXBhZ2luZ19t
b2RlX2hhcChkKSAmJiB2YWx1ZSApCiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7Ci0gICAgICAg
IGlmICggYS52YWx1ZSAmJgorICAgICAgICBpZiAoIHZhbHVlICYmCiAgICAgICAgICAgICAgZC0+
YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9BTFRQMk1dICkKICAgICAgICAgICAgIHJjID0gLUVJ
TlZBTDsKICAgICAgICAgLyogU2V0IHVwIE5IVk0gc3RhdGUgZm9yIGFueSB2Y3B1cyB0aGF0IGFy
ZSBhbHJlYWR5IHVwLiAqLwotICAgICAgICBpZiAoIGEudmFsdWUgJiYKKyAgICAgICAgaWYgKCB2
YWx1ZSAmJgogICAgICAgICAgICAgICFkLT5hcmNoLmh2bS5wYXJhbXNbSFZNX1BBUkFNX05FU1RF
REhWTV0gKQogICAgICAgICAgICAgZm9yX2VhY2hfdmNwdShkLCB2KQogICAgICAgICAgICAgICAg
IGlmICggcmMgPT0gMCApCiAgICAgICAgICAgICAgICAgICAgIHJjID0gbmVzdGVkaHZtX3ZjcHVf
aW5pdGlhbGlzZSh2KTsKLSAgICAgICAgaWYgKCAhYS52YWx1ZSB8fCByYyApCisgICAgICAgIGlm
ICggIXZhbHVlIHx8IHJjICkKICAgICAgICAgICAgIGZvcl9lYWNoX3ZjcHUoZCwgdikKICAgICAg
ICAgICAgICAgICBuZXN0ZWRodm1fdmNwdV9kZXN0cm95KHYpOwogICAgICAgICBicmVhazsKQEAg
LTQyNjEsMzAgKzQyNDUsMzAgQEAgc3RhdGljIGludCBodm1vcF9zZXRfcGFyYW0oCiAgICAgICAg
IHJjID0geHNtX2h2bV9wYXJhbV9hbHRwMm1odm0oWFNNX1BSSVYsIGQpOwogICAgICAgICBpZiAo
IHJjICkKICAgICAgICAgICAgIGJyZWFrOwotICAgICAgICBpZiAoIGEudmFsdWUgPiBYRU5fQUxU
UDJNX2xpbWl0ZWQgKQorICAgICAgICBpZiAoIHZhbHVlID4gWEVOX0FMVFAyTV9saW1pdGVkICkK
ICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKLSAgICAgICAgaWYgKCBhLnZhbHVlICYmCisgICAg
ICAgIGlmICggdmFsdWUgJiYKICAgICAgICAgICAgICBkLT5hcmNoLmh2bS5wYXJhbXNbSFZNX1BB
UkFNX05FU1RFREhWTV0gKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAgICBicmVh
azsKICAgICBjYXNlIEhWTV9QQVJBTV9UUklQTEVfRkFVTFRfUkVBU09OOgotICAgICAgICBpZiAo
IGEudmFsdWUgPiBTSFVURE9XTl9NQVggKQorICAgICAgICBpZiAoIHZhbHVlID4gU0hVVERPV05f
TUFYICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAgICAgICAgYnJlYWs7CiAgICAgY2Fz
ZSBIVk1fUEFSQU1fSU9SRVFfU0VSVkVSX1BGTjoKLSAgICAgICAgZC0+YXJjaC5odm0uaW9yZXFf
Z2ZuLmJhc2UgPSBhLnZhbHVlOworICAgICAgICBkLT5hcmNoLmh2bS5pb3JlcV9nZm4uYmFzZSA9
IHZhbHVlOwogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJBTV9OUl9JT1JFUV9TRVJW
RVJfUEFHRVM6CiAgICAgewogICAgICAgICB1bnNpZ25lZCBpbnQgaTsKIAotICAgICAgICBpZiAo
IGEudmFsdWUgPT0gMCB8fAotICAgICAgICAgICAgIGEudmFsdWUgPiBzaXplb2YoZC0+YXJjaC5o
dm0uaW9yZXFfZ2ZuLm1hc2spICogOCApCisgICAgICAgIGlmICggdmFsdWUgPT0gMCB8fAorICAg
ICAgICAgICAgIHZhbHVlID4gc2l6ZW9mKGQtPmFyY2guaHZtLmlvcmVxX2dmbi5tYXNrKSAqIDgg
KQogICAgICAgICB7CiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgICAgICBicmVh
azsKICAgICAgICAgfQotICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGEudmFsdWU7IGkrKyApCisg
ICAgICAgIGZvciAoIGkgPSAwOyBpIDwgdmFsdWU7IGkrKyApCiAgICAgICAgICAgICBzZXRfYml0
KGksICZkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubWFzayk7CiAKICAgICAgICAgYnJlYWs7CkBAIC00
Mjk2LDM1ICs0MjgwLDM1IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogICAgICAgICAg
ICAgICAgICAgICAgc2l6ZW9mKGQtPmFyY2guaHZtLmlvcmVxX2dmbi5sZWdhY3lfbWFzaykgKiA4
KTsKICAgICAgICAgQlVJTERfQlVHX09OKEhWTV9QQVJBTV9CVUZJT1JFUV9QRk4gPgogICAgICAg
ICAgICAgICAgICAgICAgc2l6ZW9mKGQtPmFyY2guaHZtLmlvcmVxX2dmbi5sZWdhY3lfbWFzaykg
KiA4KTsKLSAgICAgICAgaWYgKCBhLnZhbHVlICkKLSAgICAgICAgICAgIHNldF9iaXQoYS5pbmRl
eCwgJmQtPmFyY2guaHZtLmlvcmVxX2dmbi5sZWdhY3lfbWFzayk7CisgICAgICAgIGlmICggdmFs
dWUgKQorICAgICAgICAgICAgc2V0X2JpdChpbmRleCwgJmQtPmFyY2guaHZtLmlvcmVxX2dmbi5s
ZWdhY3lfbWFzayk7CiAgICAgICAgIGJyZWFrOwogCiAgICAgY2FzZSBIVk1fUEFSQU1fWDg3X0ZJ
UF9XSURUSDoKLSAgICAgICAgaWYgKCBhLnZhbHVlICE9IDAgJiYgYS52YWx1ZSAhPSA0ICYmIGEu
dmFsdWUgIT0gOCApCisgICAgICAgIGlmICggdmFsdWUgIT0gMCAmJiB2YWx1ZSAhPSA0ICYmIHZh
bHVlICE9IDggKQogICAgICAgICB7CiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAg
ICAgICBicmVhazsKICAgICAgICAgfQotICAgICAgICBkLT5hcmNoLng4N19maXBfd2lkdGggPSBh
LnZhbHVlOworICAgICAgICBkLT5hcmNoLng4N19maXBfd2lkdGggPSB2YWx1ZTsKICAgICAgICAg
YnJlYWs7CiAKICAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RTUzoKICAgICAgICAgLyogSGFyZHdh
cmUgd291bGQgc2lsZW50bHkgdHJ1bmNhdGUgaGlnaCBiaXRzLiAqLwotICAgICAgICBpZiAoIGEu
dmFsdWUgIT0gKHVpbnQzMl90KWEudmFsdWUgKQorICAgICAgICBpZiAoIHZhbHVlICE9ICh1aW50
MzJfdCl2YWx1ZSApCiAgICAgICAgIHsKICAgICAgICAgICAgIGlmICggZCA9PSBjdXJyX2QgKQog
ICAgICAgICAgICAgICAgIGRvbWFpbl9jcmFzaChkKTsKICAgICAgICAgICAgIHJjID0gLUVJTlZB
TDsKICAgICAgICAgfQogICAgICAgICAvKiBPbGQgaHZtbG9hZGVyIGJpbmFyaWVzIGhhcmRjb2Rl
IHRoZSBzaXplIHRvIDEyOCBieXRlcy4gKi8KLSAgICAgICAgaWYgKCBhLnZhbHVlICkKLSAgICAg
ICAgICAgIGEudmFsdWUgfD0gKDEyOFVMTCA8PCAzMikgfCBWTTg2X1RTU19VUERBVEVEOwotICAg
ICAgICBhLmluZGV4ID0gSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEOworICAgICAgICBpZiAoIHZh
bHVlICkKKyAgICAgICAgICAgIHZhbHVlIHw9ICgxMjhVTEwgPDwgMzIpIHwgVk04Nl9UU1NfVVBE
QVRFRDsKKyAgICAgICAgaW5kZXggPSBIVk1fUEFSQU1fVk04Nl9UU1NfU0laRUQ7CiAgICAgICAg
IGJyZWFrOwogCiAgICAgY2FzZSBIVk1fUEFSQU1fVk04Nl9UU1NfU0laRUQ6Ci0gICAgICAgIGlm
ICggKGEudmFsdWUgPj4gMzIpIDwgc2l6ZW9mKHN0cnVjdCB0c3MzMikgKQorICAgICAgICBpZiAo
ICh2YWx1ZSA+PiAzMikgPCBzaXplb2Yoc3RydWN0IHRzczMyKSApCiAgICAgICAgIHsKICAgICAg
ICAgICAgIGlmICggZCA9PSBjdXJyX2QgKQogICAgICAgICAgICAgICAgIGRvbWFpbl9jcmFzaChk
KTsKQEAgLTQzMzUsMjYgKzQzMTksNTYgQEAgc3RhdGljIGludCBodm1vcF9zZXRfcGFyYW0oCiAg
ICAgICAgICAqIDI1NiBiaXRzIGludGVycnVwdCByZWRpcmVjdGlvbiBiaXRtYXAgKyA2NGsgYml0
cyBJL08gYml0bWFwCiAgICAgICAgICAqIHBsdXMgb25lIHBhZGRpbmcgYnl0ZSkuCiAgICAgICAg
ICAqLwotICAgICAgICBpZiAoIChhLnZhbHVlID4+IDMyKSA+IHNpemVvZihzdHJ1Y3QgdHNzMzIp
ICsKKyAgICAgICAgaWYgKCAodmFsdWUgPj4gMzIpID4gc2l6ZW9mKHN0cnVjdCB0c3MzMikgKwog
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgweDEwMCAvIDgpICsgKDB4MTAwMDAgLyA4
KSArIDEgKQotICAgICAgICAgICAgYS52YWx1ZSA9ICh1aW50MzJfdClhLnZhbHVlIHwKKyAgICAg
ICAgICAgIHZhbHVlID0gKHVpbnQzMl90KXZhbHVlIHwKICAgICAgICAgICAgICAgICAgICAgICAo
KHNpemVvZihzdHJ1Y3QgdHNzMzIpICsgKDB4MTAwIC8gOCkgKwogICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMHgxMDAwMCAvIDgpICsgMSkgPDwgMzIpOwot
ICAgICAgICBhLnZhbHVlIHw9IFZNODZfVFNTX1VQREFURUQ7CisgICAgICAgIHZhbHVlIHw9IFZN
ODZfVFNTX1VQREFURUQ7CiAgICAgICAgIGJyZWFrOwogCiAgICAgY2FzZSBIVk1fUEFSQU1fTUNB
X0NBUDoKLSAgICAgICAgcmMgPSB2bWNlX2VuYWJsZV9tY2FfY2FwKGQsIGEudmFsdWUpOworICAg
ICAgICByYyA9IHZtY2VfZW5hYmxlX21jYV9jYXAoZCwgdmFsdWUpOwogICAgICAgICBicmVhazsK
ICAgICB9CiAKICAgICBpZiAoIHJjICE9IDAgKQogICAgICAgICBnb3RvIG91dDsKIAotICAgIGQt
PmFyY2guaHZtLnBhcmFtc1thLmluZGV4XSA9IGEudmFsdWU7CisgICAgZC0+YXJjaC5odm0ucGFy
YW1zW2luZGV4XSA9IHZhbHVlOwogCiAgICAgSFZNX0RCR19MT0coREJHX0xFVkVMX0hDQUxMLCAi
c2V0IHBhcmFtICV1ID0gJSJQUkl4NjQsCi0gICAgICAgICAgICAgICAgYS5pbmRleCwgYS52YWx1
ZSk7CisgICAgICAgICAgICAgICAgaW5kZXgsIHZhbHVlKTsKKworIG91dDoKKyAgICByZXR1cm4g
cmM7Cit9CisKK2ludCBodm1vcF9zZXRfcGFyYW0oCisgICAgWEVOX0dVRVNUX0hBTkRMRV9QQVJB
TSh4ZW5faHZtX3BhcmFtX3QpIGFyZykKK3sKKyAgICBzdHJ1Y3QgeGVuX2h2bV9wYXJhbSBhOwor
ICAgIHN0cnVjdCBkb21haW4gKmQ7CisgICAgaW50IHJjOworCisgICAgaWYgKCBjb3B5X2Zyb21f
Z3Vlc3QoJmEsIGFyZywgMSkgKQorICAgICAgICByZXR1cm4gLUVGQVVMVDsKKworICAgIGlmICgg
YS5pbmRleCA+PSBIVk1fTlJfUEFSQU1TICkKKyAgICAgICAgcmV0dXJuIC1FSU5WQUw7CisKKyAg
ICAvKiBNYWtlIHN1cmUgdGhlIGFib3ZlIGJvdW5kIGNoZWNrIGlzIG5vdCBieXBhc3NlZCBkdXJp
bmcgc3BlY3VsYXRpb24uICovCisgICAgYmxvY2tfc3BlY3VsYXRpb24oKTsKKworICAgIGQgPSBy
Y3VfbG9ja19kb21haW5fYnlfYW55X2lkKGEuZG9taWQpOworICAgIGlmICggZCA9PSBOVUxMICkK
KyAgICAgICAgcmV0dXJuIC1FU1JDSDsKKworICAgIHJjID0gLUVJTlZBTDsKKyAgICBpZiAoICFp
c19odm1fZG9tYWluKGQpICkKKyAgICAgICAgZ290byBvdXQ7CisKKyAgICByYyA9IGh2bV9zZXRf
cGFyYW0oZCwgYS5pbmRleCwgYS52YWx1ZSk7CiAKICBvdXQ6CiAgICAgcmN1X3VubG9ja19kb21h
aW4oZCk7CkBAIC00MzYyLDcgKzQzNzYsNyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgK
IH0KIAogc3RhdGljIGludCBodm1fYWxsb3dfZ2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsCi0g
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RydWN0IHhlbl9odm1fcGFyYW0g
KmEpCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgaW5kZXgpCiB7CiAg
ICAgaW50IHJjOwogCkBAIC00MzcwLDcgKzQzODQsNyBAQCBzdGF0aWMgaW50IGh2bV9hbGxvd19n
ZXRfcGFyYW0oc3RydWN0IGRvbWFpbiAqZCwKICAgICBpZiAoIHJjICkKICAgICAgICAgcmV0dXJu
IHJjOwogCi0gICAgc3dpdGNoICggYS0+aW5kZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAg
ICB7CiAgICAgLyogVGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzIGNhbiBiZSByZWFkIGJ5IHRoZSBn
dWVzdC4gKi8KICAgICBjYXNlIEhWTV9QQVJBTV9DQUxMQkFDS19JUlE6CkBAIC00NDAwLDYgKzQ0
MTQsNDMgQEAgc3RhdGljIGludCBodm1fYWxsb3dfZ2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQs
CiAgICAgcmV0dXJuIHJjOwogfQogCitzdGF0aWMgaW50IGh2bV9nZXRfcGFyYW0oc3RydWN0IGRv
bWFpbiAqZCwgdWludDMyX3QgaW5kZXgsIHVpbnQ2NF90ICp2YWx1ZSkKK3sKKyAgICBpbnQgcmM7
CisKKyAgICBpZiAoIGluZGV4ID49IEhWTV9OUl9QQVJBTVMgfHwgIXZhbHVlICkKKyAgICAgICAg
cmV0dXJuIC1FSU5WQUw7CisKKyAgICByYyA9IGh2bV9hbGxvd19nZXRfcGFyYW0oZCwgaW5kZXgp
OworICAgIGlmICggcmMgKQorICAgICAgICByZXR1cm4gcmM7CisKKyAgICBzd2l0Y2ggKCBpbmRl
eCApCisgICAgeworICAgIGNhc2UgSFZNX1BBUkFNX0FDUElfU19TVEFURToKKyAgICAgICAgKnZh
bHVlID0gZC0+YXJjaC5odm0uaXNfczNfc3VzcGVuZGVkID8gMyA6IDA7CisgICAgICAgIGJyZWFr
OworCisgICAgY2FzZSBIVk1fUEFSQU1fVk04Nl9UU1M6CisgICAgICAgICp2YWx1ZSA9ICh1aW50
MzJfdClkLT5hcmNoLmh2bS5wYXJhbXNbSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEXTsKKyAgICAg
ICAgYnJlYWs7CisKKyAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RTU19TSVpFRDoKKyAgICAgICAg
KnZhbHVlID0gZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9WTTg2X1RTU19TSVpFRF0gJgor
ICAgICAgICAgICAgICAgICAgIH5WTTg2X1RTU19VUERBVEVEOworICAgICAgICBicmVhazsKKwor
ICAgIGNhc2UgSFZNX1BBUkFNX1g4N19GSVBfV0lEVEg6CisgICAgICAgICp2YWx1ZSA9IGQtPmFy
Y2gueDg3X2ZpcF93aWR0aDsKKyAgICAgICAgYnJlYWs7CisgICAgZGVmYXVsdDoKKyAgICAgICAg
KnZhbHVlID0gZC0+YXJjaC5odm0ucGFyYW1zW2luZGV4XTsKKyAgICAgICAgYnJlYWs7CisgICAg
fQorCisgICAgcmV0dXJuIDA7Cit9OworCiBzdGF0aWMgaW50IGh2bW9wX2dldF9wYXJhbSgKICAg
ICBYRU5fR1VFU1RfSEFORExFX1BBUkFNKHhlbl9odm1fcGFyYW1fdCkgYXJnKQogewpAQCAtNDQy
NCwzMyArNDQ3NSwxMCBAQCBzdGF0aWMgaW50IGh2bW9wX2dldF9wYXJhbSgKICAgICBpZiAoICFp
c19odm1fZG9tYWluKGQpICkKICAgICAgICAgZ290byBvdXQ7CiAKLSAgICByYyA9IGh2bV9hbGxv
d19nZXRfcGFyYW0oZCwgJmEpOworICAgIHJjID0gaHZtX2dldF9wYXJhbShkLCBhLmluZGV4LCAm
YS52YWx1ZSk7CiAgICAgaWYgKCByYyApCiAgICAgICAgIGdvdG8gb3V0OwogCi0gICAgc3dpdGNo
ICggYS5pbmRleCApCi0gICAgewotICAgIGNhc2UgSFZNX1BBUkFNX0FDUElfU19TVEFURToKLSAg
ICAgICAgYS52YWx1ZSA9IGQtPmFyY2guaHZtLmlzX3MzX3N1c3BlbmRlZCA/IDMgOiAwOwotICAg
ICAgICBicmVhazsKLQotICAgIGNhc2UgSFZNX1BBUkFNX1ZNODZfVFNTOgotICAgICAgICBhLnZh
bHVlID0gKHVpbnQzMl90KWQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1fVk04Nl9UU1NfU0la
RURdOwotICAgICAgICBicmVhazsKLQotICAgIGNhc2UgSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVE
OgotICAgICAgICBhLnZhbHVlID0gZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9WTTg2X1RT
U19TSVpFRF0gJgotICAgICAgICAgICAgICAgICAgflZNODZfVFNTX1VQREFURUQ7Ci0gICAgICAg
IGJyZWFrOwotCi0gICAgY2FzZSBIVk1fUEFSQU1fWDg3X0ZJUF9XSURUSDoKLSAgICAgICAgYS52
YWx1ZSA9IGQtPmFyY2gueDg3X2ZpcF93aWR0aDsKLSAgICAgICAgYnJlYWs7Ci0gICAgZGVmYXVs
dDoKLSAgICAgICAgYS52YWx1ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1thLmluZGV4XTsKLSAgICAg
ICAgYnJlYWs7Ci0gICAgfQotCiAgICAgcmMgPSBfX2NvcHlfdG9fZ3Vlc3QoYXJnLCAmYSwgMSkg
PyAtRUZBVUxUIDogMDsKIAogICAgIEhWTV9EQkdfTE9HKERCR19MRVZFTF9IQ0FMTCwgImdldCBw
YXJhbSAldSA9ICUiUFJJeDY0LApAQCAtNTI2Niw2ICs1Mjk0LDM3IEBAIHZvaWQgaHZtX3NldF9z
ZWdtZW50X3JlZ2lzdGVyKHN0cnVjdCB2Y3B1ICp2LCBlbnVtIHg4Nl9zZWdtZW50IHNlZywKICAg
ICBhbHRlcm5hdGl2ZV92Y2FsbChodm1fZnVuY3Muc2V0X3NlZ21lbnRfcmVnaXN0ZXIsIHYsIHNl
ZywgcmVnKTsKIH0KIAoraW50IGh2bV9jb3B5X2NvbnRleHRfYW5kX3BhcmFtcyhzdHJ1Y3QgZG9t
YWluICpzcmMsIHN0cnVjdCBkb21haW4gKmRzdCkKK3sKKyAgICBpbnQgcmMsIGk7CisgICAgc3Ry
dWN0IGh2bV9kb21haW5fY29udGV4dCBjID0geyB9OworCisgICAgYy5zaXplID0gaHZtX3NhdmVf
c2l6ZShzcmMpOworICAgIGlmICggKGMuZGF0YSA9IHhtYWxsb2NfYnl0ZXMoYy5zaXplKSkgPT0g
TlVMTCApCisgICAgICAgIHJldHVybiAtRU5PTUVNOworCisgICAgZm9yICggaSA9IDA7IGkgPCBI
Vk1fTlJfUEFSQU1TOyBpKysgKQorICAgIHsKKyAgICAgICAgdWludDY0X3QgdmFsdWUgPSAwOwor
CisgICAgICAgIGlmICggaHZtX2dldF9wYXJhbShzcmMsIGksICZ2YWx1ZSkgfHwgIXZhbHVlICkK
KyAgICAgICAgICAgIGNvbnRpbnVlOworCisgICAgICAgIGlmICggKHJjID0gaHZtX3NldF9wYXJh
bShkc3QsIGksIHZhbHVlKSkgKQorICAgICAgICAgICAgZ290byBvdXQ7CisgICAgfQorCisgICAg
aWYgKCAocmMgPSBodm1fc2F2ZShzcmMsICZjKSkgKQorICAgICAgICBnb3RvIG91dDsKKworICAg
IGMuY3VyID0gMDsKKyAgICByYyA9IGh2bV9sb2FkKGRzdCwgJmMpOworCitvdXQ6CisgICAgeGZy
ZWUoYy5kYXRhKTsKKyAgICByZXR1cm4gcmM7Cit9CisKIC8qCiAgKiBMb2NhbCB2YXJpYWJsZXM6
CiAgKiBtb2RlOiBDCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaCBi
L3hlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oCmluZGV4IDA5NzkzYzEyZTkuLjYxMDZiODJj
OTUgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oCisrKyBiL3hlbi9p
bmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oCkBAIC0zMzYsNiArMzM2LDggQEAgdW5zaWduZWQgbG9u
ZyBodm1fY3I0X2d1ZXN0X3ZhbGlkX2JpdHMoY29uc3Qgc3RydWN0IGRvbWFpbiAqZCwgYm9vbCBy
ZXN0b3JlKTsKIGJvb2wgaHZtX2ZsdXNoX3ZjcHVfdGxiKGJvb2wgKCpmbHVzaF92Y3B1KSh2b2lk
ICpjdHh0LCBzdHJ1Y3QgdmNwdSAqdiksCiAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpj
dHh0KTsKIAoraW50IGh2bV9jb3B5X2NvbnRleHRfYW5kX3BhcmFtcyhzdHJ1Y3QgZG9tYWluICpz
cmMsIHN0cnVjdCBkb21haW4gKmRzdCk7CisKICNpZmRlZiBDT05GSUdfSFZNCiAKICNkZWZpbmUg
aHZtX2dldF9ndWVzdF90c2ModikgaHZtX2dldF9ndWVzdF90c2NfZml4ZWQodiwgMCkKLS0gCjIu
MjAuMQoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhl
bi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBz
Oi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 062F817A480
	for <lists+xen-devel@lfdr.de>; Thu,  5 Mar 2020 12:43:45 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j9orz-0002vW-2M; Thu, 05 Mar 2020 11:40:51 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=eGB2=4W=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1j9ory-0002vP-5O
 for xen-devel@lists.xenproject.org; Thu, 05 Mar 2020 11:40:50 +0000
X-Inumbo-ID: 2792a232-5ed6-11ea-a573-12813bfff9fa
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 2792a232-5ed6-11ea-a573-12813bfff9fa;
 Thu, 05 Mar 2020 11:40:47 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id 54379AC44;
 Thu,  5 Mar 2020 11:40:46 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org, linux-block@vger.kernel.org,
 linux-kernel@vger.kernel.org
Date: Thu,  5 Mar 2020 12:40:44 +0100
Message-Id: <20200305114044.20235-1-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
Subject: [Xen-devel] [PATCH v2] xen/blkfront: fix ring info addressing
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Jens Axboe <axboe@kernel.dk>,
 Stefano Stabellini <sstabellini@kernel.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 Boris Ostrovsky <boris.ostrovsky@oracle.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q29tbWl0IDAyNjVkNmU4ZGRiODkwICgieGVuL2Jsa2Zyb250OiBsaW1pdCBhbGxvY2F0ZWQgbWVt
b3J5IHNpemUgdG8KYWN0dWFsIHVzZSBjYXNlIikgbWFkZSBzdHJ1Y3QgYmxrZnJvbnRfcmluZ19p
bmZvIHNpemUgZHluYW1pYy4gVGhpcyBpcwpmaW5lIHdoZW4gcnVubmluZyB3aXRoIG9ubHkgb25l
IHF1ZXVlLCBidXQgd2l0aCBtdWx0aXBsZSBxdWV1ZXMgdGhlCmFkZHJlc3Npbmcgb2YgdGhlIHNp
bmdsZSBxdWV1ZXMgaGFzIHRvIGJlIGFkYXB0ZWQgYXMgdGhlIHN0cnVjdHMgYXJlCmFsbG9jYXRl
ZCBpbiBhbiBhcnJheS4KCkZpeGVzOiAwMjY1ZDZlOGRkYjg5MCAoInhlbi9ibGtmcm9udDogbGlt
aXQgYWxsb2NhdGVkIG1lbW9yeSBzaXplIHRvIGFjdHVhbCB1c2UgY2FzZSIpClJlcG9ydGVkLWJ5
OiBTYW5kZXIgRWlrZWxlbmJvb20gPGxpbnV4QGVpa2VsZW5ib29tLml0PgpTaWduZWQtb2ZmLWJ5
OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+Ci0tLQpWMjoKLSBnZXQgcmlkIG9mIHJp
bmZvX3B0cigpIGhlbHBlcgotIHVzZSBwcm9wZXIgcGFyZW50aGVzaXMgaW4gZm9yX2VhY2hfcmlu
Zm8oKQotIHJlbmFtZSByaW5mbyBwYXJhbWV0ZXIgb2YgZm9yX2VhY2hfcmluZm8oKQotLS0KIGRy
aXZlcnMvYmxvY2sveGVuLWJsa2Zyb250LmMgfCA3OSArKysrKysrKysrKysrKysrKysrKysrKy0t
LS0tLS0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDQyIGluc2VydGlvbnMoKyksIDM3
IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvYmxvY2sveGVuLWJsa2Zyb250LmMg
Yi9kcml2ZXJzL2Jsb2NrL3hlbi1ibGtmcm9udC5jCmluZGV4IGUyYWQ2YmJhMjI4MS4uOGU4NDRk
YTgyNmRiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2Jsb2NrL3hlbi1ibGtmcm9udC5jCisrKyBiL2Ry
aXZlcnMvYmxvY2sveGVuLWJsa2Zyb250LmMKQEAgLTIxMyw2ICsyMTMsNyBAQCBzdHJ1Y3QgYmxr
ZnJvbnRfaW5mbwogCXN0cnVjdCBibGtfbXFfdGFnX3NldCB0YWdfc2V0OwogCXN0cnVjdCBibGtm
cm9udF9yaW5nX2luZm8gKnJpbmZvOwogCXVuc2lnbmVkIGludCBucl9yaW5nczsKKwl1bnNpZ25l
ZCBpbnQgcmluZm9fc2l6ZTsKIAkvKiBTYXZlIHVuY29tcGxldGUgcmVxcyBhbmQgYmlvcyBmb3Ig
bWlncmF0aW9uLiAqLwogCXN0cnVjdCBsaXN0X2hlYWQgcmVxdWVzdHM7CiAJc3RydWN0IGJpb19s
aXN0IGJpb19saXN0OwpAQCAtMjU5LDYgKzI2MCwxOCBAQCBzdGF0aWMgaW50IGJsa2Zyb250X3Nl
dHVwX2luZGlyZWN0KHN0cnVjdCBibGtmcm9udF9yaW5nX2luZm8gKnJpbmZvKTsKIHN0YXRpYyB2
b2lkIGJsa2Zyb250X2dhdGhlcl9iYWNrZW5kX2ZlYXR1cmVzKHN0cnVjdCBibGtmcm9udF9pbmZv
ICppbmZvKTsKIHN0YXRpYyBpbnQgbmVnb3RpYXRlX21xKHN0cnVjdCBibGtmcm9udF9pbmZvICpp
bmZvKTsKIAorI2RlZmluZSBmb3JfZWFjaF9yaW5mbyhpbmZvLCBwdHIsIGlkeCkJCQkJXAorCWZv
ciAoKHB0cikgPSAoaW5mbyktPnJpbmZvLCAoaWR4KSA9IDA7CQkJXAorCSAgICAgKGlkeCkgPCAo
aW5mbyktPm5yX3JpbmdzOwkJCQlcCisJICAgICAoaWR4KSsrLCAocHRyKSA9ICh2b2lkICopKHB0
cikgKyAoaW5mbyktPnJpbmZvX3NpemUpCisKK3N0YXRpYyBzdHJ1Y3QgYmxrZnJvbnRfcmluZ19p
bmZvICpnZXRfcmluZm8oc3RydWN0IGJsa2Zyb250X2luZm8gKmluZm8sCisJCQkJCSAgICB1bnNp
Z25lZCBpbnQgaSkKK3sKKwlCVUdfT04oaSA+PSBpbmZvLT5ucl9yaW5ncyk7CisJcmV0dXJuICh2
b2lkICopaW5mby0+cmluZm8gKyBpICogaW5mby0+cmluZm9fc2l6ZTsKK30KKwogc3RhdGljIGlu
dCBnZXRfaWRfZnJvbV9mcmVlbGlzdChzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbykK
IHsKIAl1bnNpZ25lZCBsb25nIGZyZWUgPSByaW5mby0+c2hhZG93X2ZyZWU7CkBAIC04ODMsOCAr
ODk2LDcgQEAgc3RhdGljIGJsa19zdGF0dXNfdCBibGtpZl9xdWV1ZV9ycShzdHJ1Y3QgYmxrX21x
X2h3X2N0eCAqaGN0eCwKIAlzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbyA9IGhjdHgtPnF1ZXVl
LT5xdWV1ZWRhdGE7CiAJc3RydWN0IGJsa2Zyb250X3JpbmdfaW5mbyAqcmluZm8gPSBOVUxMOwog
Ci0JQlVHX09OKGluZm8tPm5yX3JpbmdzIDw9IHFpZCk7Ci0JcmluZm8gPSAmaW5mby0+cmluZm9b
cWlkXTsKKwlyaW5mbyA9IGdldF9yaW5mbyhpbmZvLCBxaWQpOwogCWJsa19tcV9zdGFydF9yZXF1
ZXN0KHFkLT5ycSk7CiAJc3Bpbl9sb2NrX2lycXNhdmUoJnJpbmZvLT5yaW5nX2xvY2ssIGZsYWdz
KTsKIAlpZiAoUklOR19GVUxMKCZyaW5mby0+cmluZykpCkBAIC0xMTgxLDYgKzExOTMsNyBAQCBz
dGF0aWMgaW50IHhsdmJkX2FsbG9jX2dlbmRpc2soYmxraWZfc2VjdG9yX3QgY2FwYWNpdHksCiBz
dGF0aWMgdm9pZCB4bHZiZF9yZWxlYXNlX2dlbmRpc2soc3RydWN0IGJsa2Zyb250X2luZm8gKmlu
Zm8pCiB7CiAJdW5zaWduZWQgaW50IG1pbm9yLCBucl9taW5vcnMsIGk7CisJc3RydWN0IGJsa2Zy
b250X3JpbmdfaW5mbyAqcmluZm87CiAKIAlpZiAoaW5mby0+cnEgPT0gTlVMTCkKIAkJcmV0dXJu
OwpAQCAtMTE4OCw4ICsxMjAxLDcgQEAgc3RhdGljIHZvaWQgeGx2YmRfcmVsZWFzZV9nZW5kaXNr
KHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvKQogCS8qIE5vIG1vcmUgYmxraWZfcmVxdWVzdCgp
LiAqLwogCWJsa19tcV9zdG9wX2h3X3F1ZXVlcyhpbmZvLT5ycSk7CiAKLQlmb3IgKGkgPSAwOyBp
IDwgaW5mby0+bnJfcmluZ3M7IGkrKykgewotCQlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpy
aW5mbyA9ICZpbmZvLT5yaW5mb1tpXTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5mbywgaSkg
ewogCiAJCS8qIE5vIG1vcmUgZ250dGFiIGNhbGxiYWNrIHdvcmsuICovCiAJCWdudHRhYl9jYW5j
ZWxfZnJlZV9jYWxsYmFjaygmcmluZm8tPmNhbGxiYWNrKTsKQEAgLTEzMzksNiArMTM1MSw3IEBA
IHN0YXRpYyB2b2lkIGJsa2lmX2ZyZWVfcmluZyhzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpy
aW5mbykKIHN0YXRpYyB2b2lkIGJsa2lmX2ZyZWUoc3RydWN0IGJsa2Zyb250X2luZm8gKmluZm8s
IGludCBzdXNwZW5kKQogewogCXVuc2lnbmVkIGludCBpOworCXN0cnVjdCBibGtmcm9udF9yaW5n
X2luZm8gKnJpbmZvOwogCiAJLyogUHJldmVudCBuZXcgcmVxdWVzdHMgYmVpbmcgaXNzdWVkIHVu
dGlsIHdlIGZpeCB0aGluZ3MgdXAuICovCiAJaW5mby0+Y29ubmVjdGVkID0gc3VzcGVuZCA/CkBA
IC0xMzQ3LDggKzEzNjAsOCBAQCBzdGF0aWMgdm9pZCBibGtpZl9mcmVlKHN0cnVjdCBibGtmcm9u
dF9pbmZvICppbmZvLCBpbnQgc3VzcGVuZCkKIAlpZiAoaW5mby0+cnEpCiAJCWJsa19tcV9zdG9w
X2h3X3F1ZXVlcyhpbmZvLT5ycSk7CiAKLQlmb3IgKGkgPSAwOyBpIDwgaW5mby0+bnJfcmluZ3M7
IGkrKykKLQkJYmxraWZfZnJlZV9yaW5nKCZpbmZvLT5yaW5mb1tpXSk7CisJZm9yX2VhY2hfcmlu
Zm8oaW5mbywgcmluZm8sIGkpCisJCWJsa2lmX2ZyZWVfcmluZyhyaW5mbyk7CiAKIAlrdmZyZWUo
aW5mby0+cmluZm8pOwogCWluZm8tPnJpbmZvID0gTlVMTDsKQEAgLTE3NzUsNiArMTc4OCw3IEBA
IHN0YXRpYyBpbnQgdGFsa190b19ibGtiYWNrKHN0cnVjdCB4ZW5idXNfZGV2aWNlICpkZXYsCiAJ
aW50IGVycjsKIAl1bnNpZ25lZCBpbnQgaSwgbWF4X3BhZ2Vfb3JkZXI7CiAJdW5zaWduZWQgaW50
IHJpbmdfcGFnZV9vcmRlcjsKKwlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbzsKIAog
CWlmICghaW5mbykKIAkJcmV0dXJuIC1FTk9ERVY7CkBAIC0xNzg4LDkgKzE4MDIsNyBAQCBzdGF0
aWMgaW50IHRhbGtfdG9fYmxrYmFjayhzdHJ1Y3QgeGVuYnVzX2RldmljZSAqZGV2LAogCWlmIChl
cnIpCiAJCWdvdG8gZGVzdHJveV9ibGtyaW5nOwogCi0JZm9yIChpID0gMDsgaSA8IGluZm8tPm5y
X3JpbmdzOyBpKyspIHsKLQkJc3RydWN0IGJsa2Zyb250X3JpbmdfaW5mbyAqcmluZm8gPSAmaW5m
by0+cmluZm9baV07Ci0KKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5mbywgaSkgewogCQkvKiBD
cmVhdGUgc2hhcmVkIHJpbmcsIGFsbG9jIGV2ZW50IGNoYW5uZWwuICovCiAJCWVyciA9IHNldHVw
X2Jsa3JpbmcoZGV2LCByaW5mbyk7CiAJCWlmIChlcnIpCkBAIC0xODE1LDcgKzE4MjcsNyBAQCBz
dGF0aWMgaW50IHRhbGtfdG9fYmxrYmFjayhzdHJ1Y3QgeGVuYnVzX2RldmljZSAqZGV2LAogCiAJ
LyogV2UgYWxyZWFkeSBnb3QgdGhlIG51bWJlciBvZiBxdWV1ZXMvcmluZ3MgaW4gX3Byb2JlICov
CiAJaWYgKGluZm8tPm5yX3JpbmdzID09IDEpIHsKLQkJZXJyID0gd3JpdGVfcGVyX3Jpbmdfbm9k
ZXMoeGJ0LCAmaW5mby0+cmluZm9bMF0sIGRldi0+bm9kZW5hbWUpOworCQllcnIgPSB3cml0ZV9w
ZXJfcmluZ19ub2Rlcyh4YnQsIGluZm8tPnJpbmZvLCBkZXYtPm5vZGVuYW1lKTsKIAkJaWYgKGVy
cikKIAkJCWdvdG8gZGVzdHJveV9ibGtyaW5nOwogCX0gZWxzZSB7CkBAIC0xODM3LDEwICsxODQ5
LDEwIEBAIHN0YXRpYyBpbnQgdGFsa190b19ibGtiYWNrKHN0cnVjdCB4ZW5idXNfZGV2aWNlICpk
ZXYsCiAJCQlnb3RvIGFib3J0X3RyYW5zYWN0aW9uOwogCQl9CiAKLQkJZm9yIChpID0gMDsgaSA8
IGluZm8tPm5yX3JpbmdzOyBpKyspIHsKKwkJZm9yX2VhY2hfcmluZm8oaW5mbywgcmluZm8sIGkp
IHsKIAkJCW1lbXNldChwYXRoLCAwLCBwYXRoc2l6ZSk7CiAJCQlzbnByaW50ZihwYXRoLCBwYXRo
c2l6ZSwgIiVzL3F1ZXVlLSV1IiwgZGV2LT5ub2RlbmFtZSwgaSk7Ci0JCQllcnIgPSB3cml0ZV9w
ZXJfcmluZ19ub2Rlcyh4YnQsICZpbmZvLT5yaW5mb1tpXSwgcGF0aCk7CisJCQllcnIgPSB3cml0
ZV9wZXJfcmluZ19ub2Rlcyh4YnQsIHJpbmZvLCBwYXRoKTsKIAkJCWlmIChlcnIpIHsKIAkJCQlr
ZnJlZShwYXRoKTsKIAkJCQlnb3RvIGRlc3Ryb3lfYmxrcmluZzsKQEAgLTE4NjgsOSArMTg4MCw4
IEBAIHN0YXRpYyBpbnQgdGFsa190b19ibGtiYWNrKHN0cnVjdCB4ZW5idXNfZGV2aWNlICpkZXYs
CiAJCWdvdG8gZGVzdHJveV9ibGtyaW5nOwogCX0KIAotCWZvciAoaSA9IDA7IGkgPCBpbmZvLT5u
cl9yaW5nczsgaSsrKSB7CisJZm9yX2VhY2hfcmluZm8oaW5mbywgcmluZm8sIGkpIHsKIAkJdW5z
aWduZWQgaW50IGo7Ci0JCXN0cnVjdCBibGtmcm9udF9yaW5nX2luZm8gKnJpbmZvID0gJmluZm8t
PnJpbmZvW2ldOwogCiAJCWZvciAoaiA9IDA7IGogPCBCTEtfUklOR19TSVpFKGluZm8pOyBqKysp
CiAJCQlyaW5mby0+c2hhZG93W2pdLnJlcS51LnJ3LmlkID0gaiArIDE7CkBAIC0xOTAwLDYgKzE5
MTEsNyBAQCBzdGF0aWMgaW50IG5lZ290aWF0ZV9tcShzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5m
bykKIHsKIAl1bnNpZ25lZCBpbnQgYmFja2VuZF9tYXhfcXVldWVzOwogCXVuc2lnbmVkIGludCBp
OworCXN0cnVjdCBibGtmcm9udF9yaW5nX2luZm8gKnJpbmZvOwogCiAJQlVHX09OKGluZm8tPm5y
X3JpbmdzKTsKIApAQCAtMTkxMSwyMCArMTkyMywxNiBAQCBzdGF0aWMgaW50IG5lZ290aWF0ZV9t
cShzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbykKIAlpZiAoIWluZm8tPm5yX3JpbmdzKQogCQlp
bmZvLT5ucl9yaW5ncyA9IDE7CiAKLQlpbmZvLT5yaW5mbyA9IGt2Y2FsbG9jKGluZm8tPm5yX3Jp
bmdzLAotCQkJICAgICAgIHN0cnVjdF9zaXplKGluZm8tPnJpbmZvLCBzaGFkb3csCi0JCQkJCSAg
IEJMS19SSU5HX1NJWkUoaW5mbykpLAotCQkJICAgICAgIEdGUF9LRVJORUwpOworCWluZm8tPnJp
bmZvX3NpemUgPSBzdHJ1Y3Rfc2l6ZShpbmZvLT5yaW5mbywgc2hhZG93LAorCQkJCSAgICAgICBC
TEtfUklOR19TSVpFKGluZm8pKTsKKwlpbmZvLT5yaW5mbyA9IGt2Y2FsbG9jKGluZm8tPm5yX3Jp
bmdzLCBpbmZvLT5yaW5mb19zaXplLCBHRlBfS0VSTkVMKTsKIAlpZiAoIWluZm8tPnJpbmZvKSB7
CiAJCXhlbmJ1c19kZXZfZmF0YWwoaW5mby0+eGJkZXYsIC1FTk9NRU0sICJhbGxvY2F0aW5nIHJp
bmdfaW5mbyBzdHJ1Y3R1cmUiKTsKIAkJaW5mby0+bnJfcmluZ3MgPSAwOwogCQlyZXR1cm4gLUVO
T01FTTsKIAl9CiAKLQlmb3IgKGkgPSAwOyBpIDwgaW5mby0+bnJfcmluZ3M7IGkrKykgewotCQlz
dHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbzsKLQotCQlyaW5mbyA9ICZpbmZvLT5yaW5m
b1tpXTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5mbywgaSkgewogCQlJTklUX0xJU1RfSEVB
RCgmcmluZm8tPmluZGlyZWN0X3BhZ2VzKTsKIAkJSU5JVF9MSVNUX0hFQUQoJnJpbmZvLT5ncmFu
dHMpOwogCQlyaW5mby0+ZGV2X2luZm8gPSBpbmZvOwpAQCAtMjAxNyw2ICsyMDI1LDcgQEAgc3Rh
dGljIGludCBibGtpZl9yZWNvdmVyKHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvKQogCWludCBy
YzsKIAlzdHJ1Y3QgYmlvICpiaW87CiAJdW5zaWduZWQgaW50IHNlZ3M7CisJc3RydWN0IGJsa2Zy
b250X3JpbmdfaW5mbyAqcmluZm87CiAKIAlibGtmcm9udF9nYXRoZXJfYmFja2VuZF9mZWF0dXJl
cyhpbmZvKTsKIAkvKiBSZXNldCBsaW1pdHMgY2hhbmdlZCBieSBibGtfbXFfdXBkYXRlX25yX2h3
X3F1ZXVlcygpLiAqLwpAQCAtMjAyNCw5ICsyMDMzLDcgQEAgc3RhdGljIGludCBibGtpZl9yZWNv
dmVyKHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvKQogCXNlZ3MgPSBpbmZvLT5tYXhfaW5kaXJl
Y3Rfc2VnbWVudHMgPyA6IEJMS0lGX01BWF9TRUdNRU5UU19QRVJfUkVRVUVTVDsKIAlibGtfcXVl
dWVfbWF4X3NlZ21lbnRzKGluZm8tPnJxLCBzZWdzIC8gR1JBTlRTX1BFUl9QU0VHKTsKIAotCWZv
ciAocl9pbmRleCA9IDA7IHJfaW5kZXggPCBpbmZvLT5ucl9yaW5nczsgcl9pbmRleCsrKSB7Ci0J
CXN0cnVjdCBibGtmcm9udF9yaW5nX2luZm8gKnJpbmZvID0gJmluZm8tPnJpbmZvW3JfaW5kZXhd
OwotCisJZm9yX2VhY2hfcmluZm8oaW5mbywgcmluZm8sIHJfaW5kZXgpIHsKIAkJcmMgPSBibGtm
cm9udF9zZXR1cF9pbmRpcmVjdChyaW5mbyk7CiAJCWlmIChyYykKIAkJCXJldHVybiByYzsKQEAg
LTIwMzYsMTAgKzIwNDMsNyBAQCBzdGF0aWMgaW50IGJsa2lmX3JlY292ZXIoc3RydWN0IGJsa2Zy
b250X2luZm8gKmluZm8pCiAJLyogTm93IHNhZmUgZm9yIHVzIHRvIHVzZSB0aGUgc2hhcmVkIHJp
bmcgKi8KIAlpbmZvLT5jb25uZWN0ZWQgPSBCTEtJRl9TVEFURV9DT05ORUNURUQ7CiAKLQlmb3Ig
KHJfaW5kZXggPSAwOyByX2luZGV4IDwgaW5mby0+bnJfcmluZ3M7IHJfaW5kZXgrKykgewotCQlz
dHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbzsKLQotCQlyaW5mbyA9ICZpbmZvLT5yaW5m
b1tyX2luZGV4XTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5mbywgcl9pbmRleCkgewogCQkv
KiBLaWNrIGFueSBvdGhlciBuZXcgcmVxdWVzdHMgcXVldWVkIHNpbmNlIHdlIHJlc3VtZWQgKi8K
IAkJa2lja19wZW5kaW5nX3JlcXVlc3RfcXVldWVzKHJpbmZvKTsKIAl9CkBAIC0yMDcyLDEzICsy
MDc2LDEzIEBAIHN0YXRpYyBpbnQgYmxrZnJvbnRfcmVzdW1lKHN0cnVjdCB4ZW5idXNfZGV2aWNl
ICpkZXYpCiAJc3RydWN0IGJsa2Zyb250X2luZm8gKmluZm8gPSBkZXZfZ2V0X2RydmRhdGEoJmRl
di0+ZGV2KTsKIAlpbnQgZXJyID0gMDsKIAl1bnNpZ25lZCBpbnQgaSwgajsKKwlzdHJ1Y3QgYmxr
ZnJvbnRfcmluZ19pbmZvICpyaW5mbzsKIAogCWRldl9kYmcoJmRldi0+ZGV2LCAiYmxrZnJvbnRf
cmVzdW1lOiAlc1xuIiwgZGV2LT5ub2RlbmFtZSk7CiAKIAliaW9fbGlzdF9pbml0KCZpbmZvLT5i
aW9fbGlzdCk7CiAJSU5JVF9MSVNUX0hFQUQoJmluZm8tPnJlcXVlc3RzKTsKLQlmb3IgKGkgPSAw
OyBpIDwgaW5mby0+bnJfcmluZ3M7IGkrKykgewotCQlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZv
ICpyaW5mbyA9ICZpbmZvLT5yaW5mb1tpXTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5mbywg
aSkgewogCQlzdHJ1Y3QgYmlvX2xpc3QgbWVyZ2VfYmlvOwogCQlzdHJ1Y3QgYmxrX3NoYWRvdyAq
c2hhZG93ID0gcmluZm8tPnNoYWRvdzsKIApAQCAtMjMzNyw2ICsyMzQxLDcgQEAgc3RhdGljIHZv
aWQgYmxrZnJvbnRfY29ubmVjdChzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbykKIAl1bnNpZ25l
ZCBpbnQgYmluZm87CiAJY2hhciAqZW52cFtdID0geyAiUkVTSVpFPTEiLCBOVUxMIH07CiAJaW50
IGVyciwgaTsKKwlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbzsKIAogCXN3aXRjaCAo
aW5mby0+Y29ubmVjdGVkKSB7CiAJY2FzZSBCTEtJRl9TVEFURV9DT05ORUNURUQ6CkBAIC0yMzk0
LDggKzIzOTksOCBAQCBzdGF0aWMgdm9pZCBibGtmcm9udF9jb25uZWN0KHN0cnVjdCBibGtmcm9u
dF9pbmZvICppbmZvKQogCQkJCQkJICAgICJwaHlzaWNhbC1zZWN0b3Itc2l6ZSIsCiAJCQkJCQkg
ICAgc2VjdG9yX3NpemUpOwogCWJsa2Zyb250X2dhdGhlcl9iYWNrZW5kX2ZlYXR1cmVzKGluZm8p
OwotCWZvciAoaSA9IDA7IGkgPCBpbmZvLT5ucl9yaW5nczsgaSsrKSB7Ci0JCWVyciA9IGJsa2Zy
b250X3NldHVwX2luZGlyZWN0KCZpbmZvLT5yaW5mb1tpXSk7CisJZm9yX2VhY2hfcmluZm8oaW5m
bywgcmluZm8sIGkpIHsKKwkJZXJyID0gYmxrZnJvbnRfc2V0dXBfaW5kaXJlY3QocmluZm8pOwog
CQlpZiAoZXJyKSB7CiAJCQl4ZW5idXNfZGV2X2ZhdGFsKGluZm8tPnhiZGV2LCBlcnIsICJzZXR1
cF9pbmRpcmVjdCBhdCAlcyIsCiAJCQkJCSBpbmZvLT54YmRldi0+b3RoZXJlbmQpOwpAQCAtMjQx
Niw4ICsyNDIxLDggQEAgc3RhdGljIHZvaWQgYmxrZnJvbnRfY29ubmVjdChzdHJ1Y3QgYmxrZnJv
bnRfaW5mbyAqaW5mbykKIAogCS8qIEtpY2sgcGVuZGluZyByZXF1ZXN0cy4gKi8KIAlpbmZvLT5j
b25uZWN0ZWQgPSBCTEtJRl9TVEFURV9DT05ORUNURUQ7Ci0JZm9yIChpID0gMDsgaSA8IGluZm8t
Pm5yX3JpbmdzOyBpKyspCi0JCWtpY2tfcGVuZGluZ19yZXF1ZXN0X3F1ZXVlcygmaW5mby0+cmlu
Zm9baV0pOworCWZvcl9lYWNoX3JpbmZvKGluZm8sIHJpbmZvLCBpKQorCQlraWNrX3BlbmRpbmdf
cmVxdWVzdF9xdWV1ZXMocmluZm8pOwogCiAJZGV2aWNlX2FkZF9kaXNrKCZpbmZvLT54YmRldi0+
ZGV2LCBpbmZvLT5nZCwgTlVMTCk7CiAKQEAgLTI2NTIsOSArMjY1Nyw5IEBAIHN0YXRpYyB2b2lk
IHB1cmdlX3BlcnNpc3RlbnRfZ3JhbnRzKHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvKQogewog
CXVuc2lnbmVkIGludCBpOwogCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisJc3RydWN0IGJsa2Zyb250
X3JpbmdfaW5mbyAqcmluZm87CiAKLQlmb3IgKGkgPSAwOyBpIDwgaW5mby0+bnJfcmluZ3M7IGkr
KykgewotCQlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbyA9ICZpbmZvLT5yaW5mb1tp
XTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5mbywgaSkgewogCQlzdHJ1Y3QgZ3JhbnQgKmdu
dF9saXN0X2VudHJ5LCAqdG1wOwogCiAJCXNwaW5fbG9ja19pcnFzYXZlKCZyaW5mby0+cmluZ19s
b2NrLCBmbGFncyk7Ci0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54
ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGlu
Zm8veGVuLWRldmVs

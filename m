Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 00C3956AE3
	for <lists+xen-devel@lfdr.de>; Wed, 26 Jun 2019 15:40:17 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hg87A-0005ah-VT; Wed, 26 Jun 2019 13:37:32 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=3S3C=UZ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hg878-0005aZ-PL
 for xen-devel@lists.xenproject.org; Wed, 26 Jun 2019 13:37:30 +0000
X-Inumbo-ID: 8ac20c52-9817-11e9-a981-2bca2498b7ef
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 8ac20c52-9817-11e9-a981-2bca2498b7ef;
 Wed, 26 Jun 2019 13:37:29 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id D8478AFB2;
 Wed, 26 Jun 2019 13:37:28 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Wed, 26 Jun 2019 15:37:26 +0200
Message-Id: <20190626133726.29896-1-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
Subject: [Xen-devel] [PATCH] libxl: fix pci device re-assigning after domain
 reboot
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Ian Jackson <ian.jackson@eu.citrix.com>,
 Wei Liu <wl@xen.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QWZ0ZXIgYSByZWJvb3Qgb2YgYSBndWVzdCBvbmx5IHRoZSBmaXJzdCBwY2kgZGV2aWNlIGNvbmZp
Z3VyYXRpb24gd2lsbApiZSByZXRyaWV2ZWQgZnJvbSBYZW5zdG9yZSByZXN1bHRpbmcgaW4gbG9z
cyBvZiBhbnkgZnVydGhlciBhc3NpZ25lZApwYXNzZWQgdGhyb3VnaCBwY2kgZGV2aWNlcy4KClRo
ZSBtYWluIHJlYXNvbiBpcyB0aGF0IGFsbCBwYXNzZWQgdGhyb3VnaCBwY2kgZGV2aWNlcyByZXNp
ZGUgdW5kZXIgYQpjb21tb24gcm9vdCBkZXZpY2UgIjAiIGluIFhlbnN0b3JlLiBTbyB3aGVuIHRo
ZSBkZXZpY2UgbGlzdCBpcyByZWJ1aWx0CmZyb20gWGVuc3RvcmUgYWZ0ZXIgYSByZWJvb3QgdGhl
IHN1Yi1kZXZpY2VzIGJlbG93IHRoYXQgcm9vdCBkZXZpY2UKbmVlZCB0byBiZSBzZWxlY3RlZCBp
bnN0ZWFkIG9mIHVzaW5nIHRoZSByb290IGRldmljZSBudW1iZXIgYXMgYQpzZWxlY3Rvci4KCkZp
eCB0aGF0IGJ5IGFkZGluZyBhIG5ldyBtZW1iZXIgdG8gc3RydWN0IGxpYnhsX2RldmljZV90eXBl
IHdoaWNoIHdoZW4Kc2V0IGlzIHVzZWQgdG8gZ2V0IHRoZSBudW1iZXIgb2YgZGV2aWNlcy4gQWRk
IHN1Y2ggYSBtZW1iZXIgZm9yIHBjaSB0bwpnZXQgdGhlIGNvcnJlY3QgbnVtYmVyIG9mIHBjaSBk
ZXZpY2VzIGluc3RlYWQgb2YgaW1wbHlpbmcgaXQgZnJvbSB0aGUKbnVtYmVyIG9mIHBjaSByb290
IGRldmljZXMgKHdoaWNoIHdpbGwgYWx3YXlzIGJlIDEpLgoKV2hpbGUgYXQgaXQgZml4IHRoZSB0
eXBlIG9mIGxpYnhsX19kZXZpY2VfcGNpX2Zyb21feHNfYmUoKSB0byBtYXRjaAp0aGUgb25lIG9m
IHRoZSAuZnJvbV94ZW5zdG9yZSBtZW1iZXIgb2Ygc3RydWN0IGxpYnhsX2RldmljZV90eXBlLiBU
aGlzCmZpeGVzIGEgbGF0ZW50IGJ1ZyBjaGVja2luZyB0aGUgcmV0dXJuIHZhbHVlIG9mIGEgZnVu
Y3Rpb24gcmV0dXJuaW5nCnZvaWQuCgpTaWduZWQtb2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jv
c3NAc3VzZS5jb20+ClRlc3RlZC1ieTogQ2hhbyBHYW8gPGNoYW8uZ2FvQGludGVsLmNvbT4KLS0t
CiB0b29scy9saWJ4bC9saWJ4bF9kZXZpY2UuYyAgIHwgMjQgKysrKysrKysrKysrKysrKysrKy0t
LS0tCiB0b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5oIHwgIDIgKysKIHRvb2xzL2xpYnhsL2xp
YnhsX3BjaS5jICAgICAgfCAzNSArKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLQog
MyBmaWxlcyBjaGFuZ2VkLCA0NyBpbnNlcnRpb25zKCspLCAxNCBkZWxldGlvbnMoLSkKCmRpZmYg
LS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9kZXZpY2UuYyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2Rl
dmljZS5jCmluZGV4IGRiNmMwMjAzYjcuLmEyNTY5MTAyZWUgMTAwNjQ0Ci0tLSBhL3Rvb2xzL2xp
YnhsL2xpYnhsX2RldmljZS5jCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2RldmljZS5jCkBAIC0y
MDI2LDYgKzIwMjYsNyBAQCB2b2lkICpsaWJ4bF9fZGV2aWNlX2xpc3QobGlieGxfX2djICpnYywg
Y29uc3Qgc3RydWN0IGxpYnhsX2RldmljZV90eXBlICpkdCwKICAgICBjaGFyICpsaWJ4bF9wYXRo
OwogICAgIGNoYXIgKipkaXIgPSBOVUxMOwogICAgIHVuc2lnbmVkIGludCBuZGlycyA9IDA7Cisg
ICAgdW5zaWduZWQgaW50IG5kZXZzID0gMDsKICAgICBpbnQgcmM7CiAKICAgICAqbnVtID0gMDsK
QEAgLTIwMzcsMjEgKzIwMzgsMzQgQEAgdm9pZCAqbGlieGxfX2RldmljZV9saXN0KGxpYnhsX19n
YyAqZ2MsIGNvbnN0IHN0cnVjdCBsaWJ4bF9kZXZpY2VfdHlwZSAqZHQsCiAgICAgZGlyID0gbGli
eGxfX3hzX2RpcmVjdG9yeShnYywgWEJUX05VTEwsIGxpYnhsX3BhdGgsICZuZGlycyk7CiAKICAg
ICBpZiAoZGlyICYmIG5kaXJzKSB7Ci0gICAgICAgIGxpc3QgPSBsaWJ4bF9fbWFsbG9jKE5PR0Ms
IGR0LT5kZXZfZWxlbV9zaXplICogbmRpcnMpOworICAgICAgICBpZiAoZHQtPmdldF9udW0pIHsK
KyAgICAgICAgICAgIGlmIChuZGlycyAhPSAxKSB7CisgICAgICAgICAgICAgICAgTE9HRChFUlJP
UiwgZG9taWQsICJtdWx0aXBsZSBlbnRyaWVzIGluICVzXG4iLCBsaWJ4bF9wYXRoKTsKKyAgICAg
ICAgICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CisgICAgICAgICAgICAgICAgZ290byBvdXQ7Cisg
ICAgICAgICAgICB9CisgICAgICAgICAgICByYyA9IGR0LT5nZXRfbnVtKGdjLCBHQ1NQUklOVEYo
IiVzLyVzIiwgbGlieGxfcGF0aCwgKmRpciksICZuZGV2cyk7CisgICAgICAgICAgICBpZiAocmMp
IGdvdG8gb3V0OworICAgICAgICB9IGVsc2UgeworICAgICAgICAgICAgbmRldnMgPSBuZGlyczsK
KyAgICAgICAgfQorICAgICAgICBsaXN0ID0gbGlieGxfX21hbGxvYyhOT0dDLCBkdC0+ZGV2X2Vs
ZW1fc2l6ZSAqIG5kZXZzKTsKICAgICAgICAgaXRlbSA9IGxpc3Q7CiAKLSAgICAgICAgd2hpbGUg
KCpudW0gPCBuZGlycykgeworICAgICAgICB3aGlsZSAoKm51bSA8IG5kZXZzKSB7CiAgICAgICAg
ICAgICBkdC0+aW5pdChpdGVtKTsKLSAgICAgICAgICAgICsrKCpudW0pOwogCiAgICAgICAgICAg
ICBpZiAoZHQtPmZyb21feGVuc3RvcmUpIHsKKyAgICAgICAgICAgICAgICBpbnQgbnIgPSBkdC0+
Z2V0X251bSA/ICpudW0gOiBhdG9pKCpkaXIpOwogICAgICAgICAgICAgICAgIGNoYXIgKmRldmlj
ZV9saWJ4bF9wYXRoID0gR0NTUFJJTlRGKCIlcy8lcyIsIGxpYnhsX3BhdGgsICpkaXIpOwotICAg
ICAgICAgICAgICAgIHJjID0gZHQtPmZyb21feGVuc3RvcmUoZ2MsIGRldmljZV9saWJ4bF9wYXRo
LCBhdG9pKCpkaXIpLCBpdGVtKTsKKyAgICAgICAgICAgICAgICByYyA9IGR0LT5mcm9tX3hlbnN0
b3JlKGdjLCBkZXZpY2VfbGlieGxfcGF0aCwgbnIsIGl0ZW0pOwogICAgICAgICAgICAgICAgIGlm
IChyYykgZ290byBvdXQ7CiAgICAgICAgICAgICB9CiAKICAgICAgICAgICAgIGl0ZW0gPSAodWlu
dDhfdCAqKWl0ZW0gKyBkdC0+ZGV2X2VsZW1fc2l6ZTsKLSAgICAgICAgICAgICsrZGlyOworICAg
ICAgICAgICAgKysoKm51bSk7CisgICAgICAgICAgICBpZiAoIWR0LT5nZXRfbnVtKQorICAgICAg
ICAgICAgICAgICsrZGlyOwogICAgICAgICB9CiAgICAgfQogCmRpZmYgLS1naXQgYS90b29scy9s
aWJ4bC9saWJ4bF9pbnRlcm5hbC5oIGIvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaAppbmRl
eCAzYmU1YzY0NGMxLi5hMzEwMjg3MWYzIDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9p
bnRlcm5hbC5oCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmgKQEAgLTM3MDcsNiAr
MzcwNyw3IEBAIHR5cGVkZWYgdm9pZCAoKmRldmljZV9tZXJnZV9mbl90KShsaWJ4bF9jdHggKiwg
dm9pZCAqLCB2b2lkICopOwogdHlwZWRlZiBpbnQgKCpkZXZpY2VfZG1fbmVlZGVkX2ZuX3QpKHZv
aWQgKiwgdW5zaWduZWQpOwogdHlwZWRlZiB2b2lkICgqZGV2aWNlX3VwZGF0ZV9jb25maWdfZm5f
dCkobGlieGxfX2djICosIHZvaWQgKiwgdm9pZCAqKTsKIHR5cGVkZWYgaW50ICgqZGV2aWNlX3Vw
ZGF0ZV9kZXZpZF9mbl90KShsaWJ4bF9fZ2MgKiwgdWludDMyX3QsIHZvaWQgKik7Cit0eXBlZGVm
IGludCAoKmRldmljZV9nZXRfbnVtX2ZuX3QpKGxpYnhsX19nYyAqLCBjb25zdCBjaGFyICosIHVu
c2lnbmVkIGludCAqKTsKIHR5cGVkZWYgaW50ICgqZGV2aWNlX2Zyb21feGVuc3RvcmVfZm5fdCko
bGlieGxfX2djICosIGNvbnN0IGNoYXIgKiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgbGlieGxfZGV2aWQsIHZvaWQgKik7CiB0eXBlZGVmIGludCAoKmRldmljZV9z
ZXRfeGVuc3RvcmVfY29uZmlnX2ZuX3QpKGxpYnhsX19nYyAqLCB1aW50MzJfdCwgdm9pZCAqLApA
QCAtMzczMCw2ICszNzMxLDcgQEAgc3RydWN0IGxpYnhsX2RldmljZV90eXBlIHsKICAgICBkZXZp
Y2VfZG1fbmVlZGVkX2ZuX3QgICAgICAgICAgIGRtX25lZWRlZDsKICAgICBkZXZpY2VfdXBkYXRl
X2NvbmZpZ19mbl90ICAgICAgIHVwZGF0ZV9jb25maWc7CiAgICAgZGV2aWNlX3VwZGF0ZV9kZXZp
ZF9mbl90ICAgICAgICB1cGRhdGVfZGV2aWQ7CisgICAgZGV2aWNlX2dldF9udW1fZm5fdCAgICAg
ICAgICAgICBnZXRfbnVtOwogICAgIGRldmljZV9mcm9tX3hlbnN0b3JlX2ZuX3QgICAgICAgZnJv
bV94ZW5zdG9yZTsKICAgICBkZXZpY2Vfc2V0X3hlbnN0b3JlX2NvbmZpZ19mbl90IHNldF94ZW5z
dG9yZV9jb25maWc7CiB9OwpkaWZmIC0tZ2l0IGEvdG9vbHMvbGlieGwvbGlieGxfcGNpLmMgYi90
b29scy9saWJ4bC9saWJ4bF9wY2kuYwppbmRleCA0ZWM2ODcyNzk4Li4wM2JlYjg2NWQ5IDEwMDY0
NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9wY2kuYworKysgYi90b29scy9saWJ4bC9saWJ4bF9w
Y2kuYwpAQCAtMTU0NywxMiArMTU0NywxMyBAQCBpbnQgbGlieGxfZGV2aWNlX3BjaV9kZXN0cm95
KGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBkb21pZCwKICAgICByZXR1cm4gQU9fSU5QUk9HUkVT
UzsKIH0KIAotc3RhdGljIHZvaWQgbGlieGxfX2RldmljZV9wY2lfZnJvbV94c19iZShsaWJ4bF9f
Z2MgKmdjLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBj
aGFyICpiZV9wYXRoLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBp
bnQgbnIsIGxpYnhsX2RldmljZV9wY2kgKnBjaSkKK3N0YXRpYyBpbnQgbGlieGxfX2RldmljZV9w
Y2lfZnJvbV94c19iZShsaWJ4bF9fZ2MgKmdjLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGNvbnN0IGNoYXIgKmJlX3BhdGgsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgbGlieGxfZGV2aWQgbnIsIHZvaWQgKmRhdGEpCiB7CiAgICAgY2hh
ciAqczsKICAgICB1bnNpZ25lZCBpbnQgZG9tYWluID0gMCwgYnVzID0gMCwgZGV2ID0gMCwgZnVu
YyA9IDAsIHZkZXZmbiA9IDA7CisgICAgbGlieGxfZGV2aWNlX3BjaSAqcGNpID0gZGF0YTsKIAog
ICAgIHMgPSBsaWJ4bF9feHNfcmVhZChnYywgWEJUX05VTEwsIEdDU1BSSU5URigiJXMvZGV2LSVk
IiwgYmVfcGF0aCwgbnIpKTsKICAgICBzc2NhbmYocywgUENJX0JERiwgJmRvbWFpbiwgJmJ1cywg
JmRldiwgJmZ1bmMpOwpAQCAtMTU4MiwyNCArMTU4MywzOSBAQCBzdGF0aWMgdm9pZCBsaWJ4bF9f
ZGV2aWNlX3BjaV9mcm9tX3hzX2JlKGxpYnhsX19nYyAqZ2MsCiAgICAgICAgICAgICB9CiAgICAg
ICAgIH0gd2hpbGUgKChwID0gc3RydG9rX3IoTlVMTCwgIiw9IiwgJnNhdmVwdHIpKSAhPSBOVUxM
KTsKICAgICB9CisKKyAgICByZXR1cm4gMDsKK30KKworc3RhdGljIGludCBsaWJ4bF9fZGV2aWNl
X3BjaV9nZXRfbnVtKGxpYnhsX19nYyAqZ2MsIGNvbnN0IGNoYXIgKmJlX3BhdGgsCisgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50ICpudW0pCit7CisgICAg
Y2hhciAqbnVtX2RldnM7CisgICAgaW50IHJjID0gMDsKKworICAgIG51bV9kZXZzID0gbGlieGxf
X3hzX3JlYWQoZ2MsIFhCVF9OVUxMLCBHQ1NQUklOVEYoIiVzL251bV9kZXZzIiwgYmVfcGF0aCkp
OworICAgIGlmICghbnVtX2RldnMpCisgICAgICAgIHJjID0gRVJST1JfRkFJTDsKKyAgICBlbHNl
CisgICAgICAgICpudW0gPSBhdG9pKG51bV9kZXZzKTsKKworICAgIHJldHVybiByYzsKIH0KIAog
bGlieGxfZGV2aWNlX3BjaSAqbGlieGxfZGV2aWNlX3BjaV9saXN0KGxpYnhsX2N0eCAqY3R4LCB1
aW50MzJfdCBkb21pZCwgaW50ICpudW0pCiB7CiAgICAgR0NfSU5JVChjdHgpOwotICAgIGNoYXIg
KmJlX3BhdGgsICpudW1fZGV2czsKLSAgICBpbnQgbiwgaTsKKyAgICBjaGFyICpiZV9wYXRoOwor
ICAgIHVuc2lnbmVkIGludCBuLCBpOwogICAgIGxpYnhsX2RldmljZV9wY2kgKnBjaWRldnMgPSBO
VUxMOwogCiAgICAgKm51bSA9IDA7CiAKICAgICBiZV9wYXRoID0gbGlieGxfX2RvbWFpbl9kZXZp
Y2VfYmFja2VuZF9wYXRoKGdjLCAwLCBkb21pZCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIExJQlhMX19ERVZJQ0VfS0lORF9QQ0kpOwotICAgIG51
bV9kZXZzID0gbGlieGxfX3hzX3JlYWQoZ2MsIFhCVF9OVUxMLCBHQ1NQUklOVEYoIiVzL251bV9k
ZXZzIiwgYmVfcGF0aCkpOwotICAgIGlmICghbnVtX2RldnMpCisgICAgaWYgKGxpYnhsX19kZXZp
Y2VfcGNpX2dldF9udW0oZ2MsIGJlX3BhdGgsICZuKSkKICAgICAgICAgZ290byBvdXQ7CiAKLSAg
ICBuID0gYXRvaShudW1fZGV2cyk7CiAgICAgcGNpZGV2cyA9IGNhbGxvYyhuLCBzaXplb2YobGli
eGxfZGV2aWNlX3BjaSkpOwogCiAgICAgZm9yIChpID0gMDsgaSA8IG47IGkrKykKQEAgLTE2ODgs
NyArMTcwNCw4IEBAIHN0YXRpYyBpbnQgbGlieGxfZGV2aWNlX3BjaV9jb21wYXJlKGNvbnN0IGxp
YnhsX2RldmljZV9wY2kgKmQxLAogI2RlZmluZSBsaWJ4bF9fZGV2aWNlX3BjaV91cGRhdGVfZGV2
aWQgTlVMTAogCiBERUZJTkVfREVWSUNFX1RZUEVfU1RSVUNUX1gocGNpZGV2LCBwY2ksIFBDSSwK
LSAgICAuZnJvbV94ZW5zdG9yZSA9IChkZXZpY2VfZnJvbV94ZW5zdG9yZV9mbl90KWxpYnhsX19k
ZXZpY2VfcGNpX2Zyb21feHNfYmUsCisgICAgLmdldF9udW0gPSBsaWJ4bF9fZGV2aWNlX3BjaV9n
ZXRfbnVtLAorICAgIC5mcm9tX3hlbnN0b3JlID0gbGlieGxfX2RldmljZV9wY2lfZnJvbV94c19i
ZSwKICk7CiAKIC8qCi0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54
ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGlu
Zm8veGVuLWRldmVs

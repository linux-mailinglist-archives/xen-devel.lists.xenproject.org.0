Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 979F9B1995
	for <lists+xen-devel@lfdr.de>; Fri, 13 Sep 2019 10:25:45 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i8gqD-0003Pl-Hy; Fri, 13 Sep 2019 08:22:05 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=Qndu=XI=citrix.com=paul.durrant@srs-us1.protection.inumbo.net>)
 id 1i8gqB-0003Pg-SB
 for xen-devel@lists.xenproject.org; Fri, 13 Sep 2019 08:22:03 +0000
X-Inumbo-ID: 90083238-d5ff-11e9-978d-bc764e2007e4
Received: from esa5.hc3370-68.iphmx.com (unknown [216.71.155.168])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 90083238-d5ff-11e9-978d-bc764e2007e4;
 Fri, 13 Sep 2019 08:22:02 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1568362922;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=eLGcxY10AzEoEcFv4IR8/MmpdTtjmJMTD2W3sUX56d4=;
 b=K7otE8lOi3CAeE6wdXST84QsWRTrLHFOjjj2gG+nLoVsYOltxTKao23W
 RB5eCURvX9eErgQbZegHD59NIsBzvpJ4CvSiyOJgQuj7fqwNoYcrbHZHd
 UL2/uMsF+BR1L86MPuNX0LQezzRtuuoaehEjQ3vWHU/j9UdrnRvUH0f93 Y=;
Authentication-Results: esa5.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=paul.durrant@citrix.com;
 spf=Pass smtp.mailfrom=Paul.Durrant@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa5.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 paul.durrant@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa5.hc3370-68.iphmx.com;
 envelope-from="Paul.Durrant@citrix.com";
 x-sender="paul.durrant@citrix.com"; x-conformance=sidf_compatible
Received-SPF: Pass (esa5.hc3370-68.iphmx.com: domain of
 Paul.Durrant@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa5.hc3370-68.iphmx.com;
 envelope-from="Paul.Durrant@citrix.com";
 x-sender="Paul.Durrant@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83 ~all"
Received-SPF: None (esa5.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa5.hc3370-68.iphmx.com;
 envelope-from="Paul.Durrant@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: R3MHdUrbByLAa+rHP6XVE5w6NjeBrTksryQX3D4Azz0gmolamnLDVoSfgvOX3CirQzVHAGPHbR
 5xVV2oTX7zF/3I9HJUCr2L7puWX+4pnRTx6n1Mu1QcaOXyYnxnOpirJK4J59ruCkaj0WFUjwKF
 dSMBxh/rUXqPiRTL3dSLLXMSYixzFIPYEzGGCVUzzHT3I/dN7n5dKmJUyG3V++sCuYHGAcYEtm
 ohHGDzKWWpuMy0tY1nsxrQuzzp4ANUVfHri58lsiaB9IHUUIXIwzMVtKlqPDI0TstQQ579mATm
 cFM=
X-SBRS: 2.7
X-MesageID: 5722665
X-Ironport-Server: esa5.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.64,500,1559534400"; 
   d="scan'208";a="5722665"
From: Paul Durrant <paul.durrant@citrix.com>
To: <qemu-devel@nongnu.org>, <xen-devel@lists.xenproject.org>
Date: Fri, 13 Sep 2019 09:21:58 +0100
Message-ID: <20190913082159.31338-4-paul.durrant@citrix.com>
X-Mailer: git-send-email 2.20.1.2.gb21ebb6
In-Reply-To: <20190913082159.31338-1-paul.durrant@citrix.com>
References: <20190913082159.31338-1-paul.durrant@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v3 3/3] xen: perform XenDevice clean-up in
 XenBus watch handler
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony Perard <anthony.perard@citrix.com>,
 Paul Durrant <paul.durrant@citrix.com>,
 Stefano Stabellini <sstabellini@kernel.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q2xlYW5pbmcgdXAgb2ZmbGluZSBYZW5EZXZpY2Ugb2JqZWN0cyBkaXJlY3RseSBpbgp4ZW5fZGV2
aWNlX2JhY2tlbmRfY2hhbmdlZCgpIGlzIGRhbmdlcm91cyBhcyB4ZW5fZGV2aWNlX3VucmVhbGl6
ZSgpIHdpbGwKbW9kaWZ5IHRoZSB3YXRjaCBsaXN0IHRoYXQgaXMgYmVpbmcgd2Fsa2VkLiBFdmVu
IHRoZSBRTElTVF9GT1JFQUNIX1NBRkUoKQp1c2VkIGluIG5vdGlmaWVyX2xpc3Rfbm90aWZ5KCkg
aXMgaW5zdWZmaWNpZW50IGFzICp0d28qIG5vdGlmaWVycyAoZm9yCnRoZSBmcm9udGVuZCBhbmQg
YmFja2VuZCB3YXRjaGVzKSBhcmUgcmVtb3ZlZCwgdGh1cyBwb3RlbnRpYWxseSByZW5kZXJpbmcK
dGhlICduZXh0JyBwb2ludGVyIHVuc2FmZS4KClRoZSBzb2x1dGlvbiBpcyB0byB1c2UgdGhlIFhl
bkJ1cyBiYWNrZW5kX3dhdGNoIGhhbmRsZXIgdG8gZG8gdGhlIGNsZWFuLXVwCmluc3RlYWQsIGFz
IGl0IGlzIGludm9rZWQgd2hpbHN0IHdhbGtpbmcgYSBzZXBhcmF0ZSB3YXRjaCBsaXN0LgoKVGhp
cyBwYXRjaCB0aGVyZWZvcmUgYWRkcyBhIG5ldyAnaW5hY3RpdmVfZGV2aWNlcycgbGlzdCB0byBY
ZW5CdXMsIHRvIHdoaWNoCm9mZmxpbmUgZGV2aWNlcyBhcmUgYWRkZWQgYnkgeGVuX2RldmljZV9i
YWNrZW5kX2NoYW5nZWQoKS4gVGhlIFhlbkJ1cwpiYWNrZW5kX3dhdGNoIHJlZ2lzdHJhdGlvbiBp
cyBhbHNvIGNoYW5nZWQgdG8gbm90IG9ubHkgaW52b2tlCnhlbl9idXNfZW51bWVyYXRlKCkgYnV0
IGFsc28gYSBuZXcgeGVuX2J1c19jbGVhbnVwKCkgZnVuY3Rpb24sIHdoaWNoIHdpbGwKd2FsayAn
aW5hY3RpdmVfZGV2aWNlcycgYW5kIHBlcmZvcm0gdGhlIG5lY2Vzc2FyeSBhY3Rpb25zLgpGb3Ig
c2FmZXR5IGFuIGV4dHJhICdvbmxpbmUnIGNoZWNrIGlzIGFsc28gYWRkZWQgdG8geGVuX2J1c190
eXBlX2VudW1lcmF0ZSgpCnRvIG1ha2Ugc3VyZSB0aGF0IG5vIGF0dGVtcHQgaXMgbWFkZSB0byBj
cmVhdGUgYSBuZXcgWGVuRGV2aWNlIG9iamVjdCBmb3IgYQpiYWNrZW5kIHRoYXQgaXMgb2ZmbGlu
ZS4KCk5PVEU6IFRoaXMgcGF0Y2ggYWxzbyBpbmNsdWRlcyBzb21lIGNvc21ldGljIGNoYW5nZXM6
CiAgICAgIC0gc3Vic3RpdHV0ZSB0aGUgbG9jYWwgdmFyaWFibGUgbmFtZSAnYmFja2VuZF9zdGF0
ZScKICAgICAgICBpbiB4ZW5fYnVzX3R5cGVfZW51bWVyYXRlKCkgd2l0aCAnc3RhdGUnLCBzaW5j
ZSB0aGVyZQogICAgICAgIGlzIG5vIGFtYmlndWl0eSB3aXRoIGFueSBvdGhlciBzdGF0ZSBpbiB0
aGF0IGNvbnRleHQuCiAgICAgIC0gY2hhbmdlIHhlbl9kZXZpY2Vfc3RhdGVfaXNfYWN0aXZlKCkg
dG8KICAgICAgICB4ZW5fZGV2aWNlX2Zyb250ZW5kX2lzX2FjdGl2ZSgpIChhbmQgcGFzcyBhIFhl
bkRldmljZSBkaXJlY3RseSkKICAgICAgICBzaW5jZSB0aGUgc3RhdGUgdGVzdHMgY29udGFpbmVk
IHRoZXJlaW4gb25seSBhcHBseSB0byBhIGZyb250ZW5kLgogICAgICAtIHVzZSAnc3RhdGUnIHJh
dGhlciB0aGVuICd4ZW5kZXYtPmJhY2tlbmRfc3RhdGUnIGluCiAgICAgICAgeGVuX2RldmljZV9i
YWNrZW5kX2NoYW5nZWQoKSB0byBzaG9ydGVuIHRoZSBjb2RlLgoKU2lnbmVkLW9mZi1ieTogUGF1
bCBEdXJyYW50IDxwYXVsLmR1cnJhbnRAY2l0cml4LmNvbT4KLS0tCkNjOiBTdGVmYW5vIFN0YWJl
bGxpbmkgPHNzdGFiZWxsaW5pQGtlcm5lbC5vcmc+CkNjOiBBbnRob255IFBlcmFyZCA8YW50aG9u
eS5wZXJhcmRAY2l0cml4LmNvbT4KCnYzOgogLSBzL29mZmxpbmVfZGV2aWNlcy9pbmFjdGl2ZV9k
ZXZpY2VzL2cKIC0gQWxzbyBhZGQgYW4gJ2luYWN0aXZlJyBib29sZWFuIHRvIFhlbkRldmljZSB3
aGljaCBpcyBzZXQgd2hlbiB0aGUKICAgZGV2aWNlIGlzIGFkZGVkIHRvIHRoZSBpbmFjdGl2ZSBs
aXN0IHNvIHdlIHJlYWxseSBjYW4gbWFrZSBzdXJlIHRoYXQgaXQKICAgZG9lc24ndCBoYXBwZW4g
bW9yZSB0aGFuIG9uY2UKCnYyOgogLSBNYWtlIHN1cmUgd2UgZG9uJ3QgdHJ5IHRvIGFkZCBhIFhl
bkRldmljZSB0byAnb2ZmbGluZV9kZXZpY2VzJyBtb3JlIHRoYW4KICAgb25jZQotLS0KIGh3L3hl
bi90cmFjZS1ldmVudHMgICAgICB8ICAyICsKIGh3L3hlbi94ZW4tYnVzLmMgICAgICAgICB8IDk0
ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0KIGluY2x1ZGUvaHcveGVu
L3hlbi1idXMuaCB8ICAzICsrCiAzIGZpbGVzIGNoYW5nZWQsIDc0IGluc2VydGlvbnMoKyksIDI1
IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2h3L3hlbi90cmFjZS1ldmVudHMgYi9ody94ZW4v
dHJhY2UtZXZlbnRzCmluZGV4IDgwY2UzZGFmYWQuLmU2ODg1YmM3NTEgMTAwNjQ0Ci0tLSBhL2h3
L3hlbi90cmFjZS1ldmVudHMKKysrIGIvaHcveGVuL3RyYWNlLWV2ZW50cwpAQCAtMTcsOCArMTcs
MTAgQEAgeGVuX2RvbWlkX3Jlc3RyaWN0KGludCBlcnIpICJlcnI6ICV1IgogeGVuX2J1c19yZWFs
aXplKHZvaWQpICIiCiB4ZW5fYnVzX3VucmVhbGl6ZSh2b2lkKSAiIgogeGVuX2J1c19lbnVtZXJh
dGUodm9pZCkgIiIKK3hlbl9idXNfY2xlYW51cCh2b2lkKSAiIgogeGVuX2J1c190eXBlX2VudW1l
cmF0ZShjb25zdCBjaGFyICp0eXBlKSAidHlwZTogJXMiCiB4ZW5fYnVzX2JhY2tlbmRfY3JlYXRl
KGNvbnN0IGNoYXIgKnR5cGUsIGNvbnN0IGNoYXIgKnBhdGgpICJ0eXBlOiAlcyBwYXRoOiAlcyIK
K3hlbl9idXNfZGV2aWNlX2NsZWFudXAoY29uc3QgY2hhciAqdHlwZSwgY2hhciAqbmFtZSkgInR5
cGU6ICVzIG5hbWU6ICVzIgogeGVuX2J1c19hZGRfd2F0Y2goY29uc3QgY2hhciAqbm9kZSwgY29u
c3QgY2hhciAqa2V5KSAibm9kZTogJXMga2V5OiAlcyIKIHhlbl9idXNfcmVtb3ZlX3dhdGNoKGNv
bnN0IGNoYXIgKm5vZGUsIGNvbnN0IGNoYXIgKmtleSkgIm5vZGU6ICVzIGtleTogJXMiCiB4ZW5f
ZGV2aWNlX3JlYWxpemUoY29uc3QgY2hhciAqdHlwZSwgY2hhciAqbmFtZSkgInR5cGU6ICVzIG5h
bWU6ICVzIgpkaWZmIC0tZ2l0IGEvaHcveGVuL3hlbi1idXMuYyBiL2h3L3hlbi94ZW4tYnVzLmMK
aW5kZXggODEwYTRlMmRmMy4uNTVjMTU3MzkzZCAxMDA2NDQKLS0tIGEvaHcveGVuL3hlbi1idXMu
YworKysgYi9ody94ZW4veGVuLWJ1cy5jCkBAIC0zNDAsMTMgKzM0MCwxOCBAQCBzdGF0aWMgdm9p
ZCB4ZW5fYnVzX3R5cGVfZW51bWVyYXRlKFhlbkJ1cyAqeGVuYnVzLCBjb25zdCBjaGFyICp0eXBl
KQogICAgIGZvciAoaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgICAgY2hhciAqYmFja2VuZF9w
YXRoID0gZ19zdHJkdXBfcHJpbnRmKCIlcy8lcyIsIGRvbWFpbl9wYXRoLAogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2VuZFtpXSk7Ci0gICAgICAgIGVu
dW0geGVuYnVzX3N0YXRlIGJhY2tlbmRfc3RhdGU7CisgICAgICAgIGVudW0geGVuYnVzX3N0YXRl
IHN0YXRlOworICAgICAgICB1bnNpZ25lZCBpbnQgb25saW5lOwogCiAgICAgICAgIGlmICh4c19u
b2RlX3NjYW5mKHhlbmJ1cy0+eHNoLCBYQlRfTlVMTCwgYmFja2VuZF9wYXRoLCAic3RhdGUiLAot
ICAgICAgICAgICAgICAgICAgICAgICAgICBOVUxMLCAiJXUiLCAmYmFja2VuZF9zdGF0ZSkgIT0g
MSkKLSAgICAgICAgICAgIGJhY2tlbmRfc3RhdGUgPSBYZW5idXNTdGF0ZVVua25vd247CisgICAg
ICAgICAgICAgICAgICAgICAgICAgIE5VTEwsICIldSIsICZzdGF0ZSkgIT0gMSkKKyAgICAgICAg
ICAgIHN0YXRlID0gWGVuYnVzU3RhdGVVbmtub3duOwogCi0gICAgICAgIGlmIChiYWNrZW5kX3N0
YXRlID09IFhlbmJ1c1N0YXRlSW5pdGlhbGlzaW5nKSB7CisgICAgICAgIGlmICh4c19ub2RlX3Nj
YW5mKHhlbmJ1cy0+eHNoLCBYQlRfTlVMTCwgYmFja2VuZF9wYXRoLCAib25saW5lIiwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgTlVMTCwgIiV1IiwgJm9ubGluZSkgIT0gMSkKKyAgICAgICAg
ICAgIG9ubGluZSA9IDA7CisKKyAgICAgICAgaWYgKG9ubGluZSAmJiBzdGF0ZSA9PSBYZW5idXNT
dGF0ZUluaXRpYWxpc2luZykgewogICAgICAgICAgICAgRXJyb3IgKmxvY2FsX2VyciA9IE5VTEw7
CiAKICAgICAgICAgICAgIHhlbl9idXNfYmFja2VuZF9jcmVhdGUoeGVuYnVzLCB0eXBlLCBiYWNr
ZW5kW2ldLCBiYWNrZW5kX3BhdGgsCkBAIC0zNjUsOSArMzcwLDggQEAgb3V0OgogICAgIGdfZnJl
ZShkb21haW5fcGF0aCk7CiB9CiAKLXN0YXRpYyB2b2lkIHhlbl9idXNfZW51bWVyYXRlKHZvaWQg
Km9wYXF1ZSkKK3N0YXRpYyB2b2lkIHhlbl9idXNfZW51bWVyYXRlKFhlbkJ1cyAqeGVuYnVzKQog
ewotICAgIFhlbkJ1cyAqeGVuYnVzID0gb3BhcXVlOwogICAgIGNoYXIgKip0eXBlOwogICAgIHVu
c2lnbmVkIGludCBpLCBuOwogCkBAIC0zODUsNiArMzg5LDQ1IEBAIHN0YXRpYyB2b2lkIHhlbl9i
dXNfZW51bWVyYXRlKHZvaWQgKm9wYXF1ZSkKICAgICBmcmVlKHR5cGUpOwogfQogCitzdGF0aWMg
dm9pZCB4ZW5fYnVzX2RldmljZV9jbGVhbnVwKFhlbkRldmljZSAqeGVuZGV2KQoreworICAgIGNv
bnN0IGNoYXIgKnR5cGUgPSBvYmplY3RfZ2V0X3R5cGVuYW1lKE9CSkVDVCh4ZW5kZXYpKTsKKyAg
ICBFcnJvciAqbG9jYWxfZXJyID0gTlVMTDsKKworICAgIHRyYWNlX3hlbl9idXNfZGV2aWNlX2Ns
ZWFudXAodHlwZSwgeGVuZGV2LT5uYW1lKTsKKworICAgIGdfYXNzZXJ0KCF4ZW5kZXYtPmJhY2tl
bmRfb25saW5lKTsKKworICAgIGlmICgheGVuX2JhY2tlbmRfdHJ5X2RldmljZV9kZXN0cm95KHhl
bmRldiwgJmxvY2FsX2VycikpIHsKKyAgICAgICAgb2JqZWN0X3VucGFyZW50KE9CSkVDVCh4ZW5k
ZXYpKTsKKyAgICB9CisKKyAgICBpZiAobG9jYWxfZXJyKSB7CisgICAgICAgIGVycm9yX3JlcG9y
dF9lcnIobG9jYWxfZXJyKTsKKyAgICB9Cit9CisKK3N0YXRpYyB2b2lkIHhlbl9idXNfY2xlYW51
cChYZW5CdXMgKnhlbmJ1cykKK3sKKyAgICBYZW5EZXZpY2UgKnhlbmRldiwgKm5leHQ7CisKKyAg
ICB0cmFjZV94ZW5fYnVzX2NsZWFudXAoKTsKKworICAgIFFMSVNUX0ZPUkVBQ0hfU0FGRSh4ZW5k
ZXYsICZ4ZW5idXMtPmluYWN0aXZlX2RldmljZXMsIGxpc3QsIG5leHQpIHsKKyAgICAgICAgZ19h
c3NlcnQoeGVuZGV2LT5pbmFjdGl2ZSk7CisgICAgICAgIFFMSVNUX1JFTU9WRSh4ZW5kZXYsIGxp
c3QpOworICAgICAgICB4ZW5fYnVzX2RldmljZV9jbGVhbnVwKHhlbmRldik7CisgICAgfQorfQor
CitzdGF0aWMgdm9pZCB4ZW5fYnVzX2JhY2tlbmRfY2hhbmdlZCh2b2lkICpvcGFxdWUpCit7Cisg
ICAgWGVuQnVzICp4ZW5idXMgPSBvcGFxdWU7CisKKyAgICB4ZW5fYnVzX2VudW1lcmF0ZSh4ZW5i
dXMpOworICAgIHhlbl9idXNfY2xlYW51cCh4ZW5idXMpOworfQorCiBzdGF0aWMgdm9pZCB4ZW5f
YnVzX3VucmVhbGl6ZShCdXNTdGF0ZSAqYnVzLCBFcnJvciAqKmVycnApCiB7CiAgICAgWGVuQnVz
ICp4ZW5idXMgPSBYRU5fQlVTKGJ1cyk7CkBAIC00MzMsNyArNDc2LDcgQEAgc3RhdGljIHZvaWQg
eGVuX2J1c19yZWFsaXplKEJ1c1N0YXRlICpidXMsIEVycm9yICoqZXJycCkKIAogICAgIHhlbmJ1
cy0+YmFja2VuZF93YXRjaCA9CiAgICAgICAgIHhlbl9idXNfYWRkX3dhdGNoKHhlbmJ1cywgIiIs
IC8qIGRvbWFpbiByb290IG5vZGUgKi8KLSAgICAgICAgICAgICAgICAgICAgICAgICAgImJhY2tl
bmQiLCB4ZW5fYnVzX2VudW1lcmF0ZSwgJmxvY2FsX2Vycik7CisgICAgICAgICAgICAgICAgICAg
ICAgICAgICJiYWNrZW5kIiwgeGVuX2J1c19iYWNrZW5kX2NoYW5nZWQsICZsb2NhbF9lcnIpOwog
ICAgIGlmIChsb2NhbF9lcnIpIHsKICAgICAgICAgLyogVGhpcyBuZWVkIG5vdCBiZSB0cmVhdGVk
IGFzIGEgaGFyZCBlcnJvciBzbyBkb24ndCBwcm9wYWdhdGUgKi8KICAgICAgICAgZXJyb3JfcmVw
b3J0Zl9lcnIobG9jYWxfZXJyLApAQCAtNTU1LDkgKzU5OCw5IEBAIHN0YXRpYyB2b2lkIHhlbl9k
ZXZpY2VfYmFja2VuZF9zZXRfb25saW5lKFhlbkRldmljZSAqeGVuZGV2LCBib29sIG9ubGluZSkK
ICAqIFRlbGwgZnJvbSB0aGUgc3RhdGUgd2hldGhlciB0aGUgZnJvbnRlbmQgaXMgbGlrZWx5IGFs
aXZlLAogICogaS5lLiBpdCB3aWxsIHJlYWN0IHRvIGEgY2hhbmdlIG9mIHN0YXRlIG9mIHRoZSBi
YWNrZW5kLgogICovCi1zdGF0aWMgYm9vbCB4ZW5fZGV2aWNlX3N0YXRlX2lzX2FjdGl2ZShlbnVt
IHhlbmJ1c19zdGF0ZSBzdGF0ZSkKK3N0YXRpYyBib29sIHhlbl9kZXZpY2VfZnJvbnRlbmRfaXNf
YWN0aXZlKFhlbkRldmljZSAqeGVuZGV2KQogewotICAgIHN3aXRjaCAoc3RhdGUpIHsKKyAgICBz
d2l0Y2ggKHhlbmRldi0+ZnJvbnRlbmRfc3RhdGUpIHsKICAgICBjYXNlIFhlbmJ1c1N0YXRlSW5p
dFdhaXQ6CiAgICAgY2FzZSBYZW5idXNTdGF0ZUluaXRpYWxpc2VkOgogICAgIGNhc2UgWGVuYnVz
U3RhdGVDb25uZWN0ZWQ6CkBAIC01OTQsMzAgKzYzNywzMSBAQCBzdGF0aWMgdm9pZCB4ZW5fZGV2
aWNlX2JhY2tlbmRfY2hhbmdlZCh2b2lkICpvcGFxdWUpCiAgICAgICogc3RhdGUgdG8gQ2xvc2lu
ZywgYnV0IHRoZXJlIGlzIG5vIGFjdGl2ZSBmcm9udGVuZCB0aGVuIHNldCB0aGUKICAgICAgKiBi
YWNrZW5kIHN0YXRlIHRvIENsb3NlZC4KICAgICAgKi8KLSAgICBpZiAoeGVuZGV2LT5iYWNrZW5k
X3N0YXRlID09IFhlbmJ1c1N0YXRlQ2xvc2luZyAmJgotICAgICAgICAheGVuX2RldmljZV9zdGF0
ZV9pc19hY3RpdmUoeGVuZGV2LT5mcm9udGVuZF9zdGF0ZSkpIHsKKyAgICBpZiAoc3RhdGUgPT0g
WGVuYnVzU3RhdGVDbG9zaW5nICYmCisgICAgICAgICF4ZW5fZGV2aWNlX2Zyb250ZW5kX2lzX2Fj
dGl2ZSh4ZW5kZXYpKSB7CiAgICAgICAgIHhlbl9kZXZpY2VfYmFja2VuZF9zZXRfc3RhdGUoeGVu
ZGV2LCBYZW5idXNTdGF0ZUNsb3NlZCk7CiAgICAgfQogCiAgICAgLyoKICAgICAgKiBJZiBhIGJh
Y2tlbmQgaXMgc3RpbGwgJ29ubGluZScgdGhlbiB3ZSBzaG91bGQgbGVhdmUgaXQgYWxvbmUgYnV0
LAotICAgICAqIGlmIGEgYmFja2VuZCBpcyBub3QgJ29ubGluZScsIHRoZW4gdGhlIGRldmljZSBz
aG91bGQgYmUgZGVzdHJveWVkCi0gICAgICogb25jZSB0aGUgc3RhdGUgaXMgQ2xvc2VkLgorICAg
ICAqIGlmIGEgYmFja2VuZCBpcyBub3QgJ29ubGluZScsIHRoZW4gdGhlIGRldmljZSBpcyBhIGNh
bmRpZGF0ZQorICAgICAqIGZvciBkZXN0cnVjdGlvbi4gSGVuY2UgYWRkIGl0IHRvIHRoZSAnaW5h
Y3RpdmUnIGxpc3QgdG8gYmUgY2xlYW5lZAorICAgICAqIGJ5IHhlbl9idXNfY2xlYW51cCgpLgog
ICAgICAqLwotICAgIGlmICgheGVuZGV2LT5iYWNrZW5kX29ubGluZSAmJgotICAgICAgICAoeGVu
ZGV2LT5iYWNrZW5kX3N0YXRlID09IFhlbmJ1c1N0YXRlQ2xvc2VkIHx8Ci0gICAgICAgICB4ZW5k
ZXYtPmJhY2tlbmRfc3RhdGUgPT0gWGVuYnVzU3RhdGVJbml0aWFsaXNpbmcgfHwKLSAgICAgICAg
IHhlbmRldi0+YmFja2VuZF9zdGF0ZSA9PSBYZW5idXNTdGF0ZUluaXRXYWl0IHx8Ci0gICAgICAg
ICB4ZW5kZXYtPmJhY2tlbmRfc3RhdGUgPT0gWGVuYnVzU3RhdGVVbmtub3duKSkgewotICAgICAg
ICBFcnJvciAqbG9jYWxfZXJyID0gTlVMTDsKKyAgICBpZiAoIW9ubGluZSAmJgorICAgICAgICAo
c3RhdGUgPT0gWGVuYnVzU3RhdGVDbG9zZWQgfHwgIHN0YXRlID09IFhlbmJ1c1N0YXRlSW5pdGlh
bGlzaW5nIHx8CisgICAgICAgICBzdGF0ZSA9PSBYZW5idXNTdGF0ZUluaXRXYWl0IHx8IHN0YXRl
ID09IFhlbmJ1c1N0YXRlVW5rbm93bikgJiYKKyAgICAgICAgIXhlbmRldi0+aW5hY3RpdmUpIHsK
KyAgICAgICAgWGVuQnVzICp4ZW5idXMgPSBYRU5fQlVTKHFkZXZfZ2V0X3BhcmVudF9idXMoREVW
SUNFKHhlbmRldikpKTsKIAotICAgICAgICBpZiAoIXhlbl9iYWNrZW5kX3RyeV9kZXZpY2VfZGVz
dHJveSh4ZW5kZXYsICZsb2NhbF9lcnIpKSB7Ci0gICAgICAgICAgICBvYmplY3RfdW5wYXJlbnQo
T0JKRUNUKHhlbmRldikpOwotICAgICAgICB9CisgICAgICAgIHhlbmRldi0+aW5hY3RpdmUgPSB0
cnVlOworICAgICAgICBRTElTVF9JTlNFUlRfSEVBRCgmeGVuYnVzLT5pbmFjdGl2ZV9kZXZpY2Vz
LCB4ZW5kZXYsIGxpc3QpOwogCi0gICAgICAgIGlmIChsb2NhbF9lcnIpIHsKLSAgICAgICAgICAg
IGVycm9yX3JlcG9ydF9lcnIobG9jYWxfZXJyKTsKLSAgICAgICAgfQorICAgICAgICAvKgorICAg
ICAgICAgKiBSZS13cml0ZSB0aGUgc3RhdGUgdG8gY2F1c2UgYSBYZW5CdXMgYmFja2VuZF93YXRj
aCBub3RpZmljYXRpb24sCisgICAgICAgICAqIHJlc3VsdGluZyBpbiBhIGNhbGwgdG8geGVuX2J1
c19jbGVhbnVwKCkuCisgICAgICAgICAqLworICAgICAgICB4ZW5fZGV2aWNlX2JhY2tlbmRfcHJp
bnRmKHhlbmRldiwgInN0YXRlIiwgIiV1Iiwgc3RhdGUpOwogICAgIH0KIH0KIApkaWZmIC0tZ2l0
IGEvaW5jbHVkZS9ody94ZW4veGVuLWJ1cy5oIGIvaW5jbHVkZS9ody94ZW4veGVuLWJ1cy5oCmlu
ZGV4IDBkMTk4MTQ4ZjYuLjNkNTUzMjI1OGQgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvaHcveGVuL3hl
bi1idXMuaAorKysgYi9pbmNsdWRlL2h3L3hlbi94ZW4tYnVzLmgKQEAgLTMyLDcgKzMyLDkgQEAg
dHlwZWRlZiBzdHJ1Y3QgWGVuRGV2aWNlIHsKICAgICBYZW5XYXRjaCAqYmFja2VuZF9vbmxpbmVf
d2F0Y2g7CiAgICAgeGVuZ250dGFiX2hhbmRsZSAqeGd0aDsKICAgICBib29sIGZlYXR1cmVfZ3Jh
bnRfY29weTsKKyAgICBib29sIGluYWN0aXZlOwogICAgIFFMSVNUX0hFQUQoLCBYZW5FdmVudENo
YW5uZWwpIGV2ZW50X2NoYW5uZWxzOworICAgIFFMSVNUX0VOVFJZKFhlbkRldmljZSkgbGlzdDsK
IH0gWGVuRGV2aWNlOwogCiB0eXBlZGVmIGNoYXIgKigqWGVuRGV2aWNlR2V0TmFtZSkoWGVuRGV2
aWNlICp4ZW5kZXYsIEVycm9yICoqZXJycCk7CkBAIC02OCw2ICs3MCw3IEBAIHR5cGVkZWYgc3Ry
dWN0IFhlbkJ1cyB7CiAgICAgc3RydWN0IHhzX2hhbmRsZSAqeHNoOwogICAgIFhlbldhdGNoTGlz
dCAqd2F0Y2hfbGlzdDsKICAgICBYZW5XYXRjaCAqYmFja2VuZF93YXRjaDsKKyAgICBRTElTVF9I
RUFEKCwgWGVuRGV2aWNlKSBpbmFjdGl2ZV9kZXZpY2VzOwogfSBYZW5CdXM7CiAKIHR5cGVkZWYg
c3RydWN0IFhlbkJ1c0NsYXNzIHsKLS0gCjIuMjAuMS4yLmdiMjFlYmI2CgoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlz
dApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

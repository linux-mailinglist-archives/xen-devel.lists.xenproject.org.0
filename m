Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 8291A14B4BF
	for <lists+xen-devel@lfdr.de>; Tue, 28 Jan 2020 14:19:54 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iwQjg-0003aW-Ql; Tue, 28 Jan 2020 13:16:56 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=iQoc=3R=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1iwQjf-0003aR-H0
 for xen-devel@lists.xenproject.org; Tue, 28 Jan 2020 13:16:55 +0000
X-Inumbo-ID: 73cfdda4-41d0-11ea-b211-bc764e2007e4
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 73cfdda4-41d0-11ea-b211-bc764e2007e4;
 Tue, 28 Jan 2020 13:16:54 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id 6CFB2B188;
 Tue, 28 Jan 2020 13:16:53 +0000 (UTC)
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
From: Jan Beulich <jbeulich@suse.com>
Message-ID: <93b4ae81-6bfb-f7bd-06be-62032fd9a445@suse.com>
Date: Tue, 28 Jan 2020 14:16:53 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:68.0) Gecko/20100101
 Thunderbird/68.4.2
MIME-Version: 1.0
Content-Language: en-US
Subject: [Xen-devel] [PATCH] x86/HVM: relinquish resources also from
 hvm_domain_destroy()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>, Paul Durrant <paul@xen.org>,
 Wei Liu <wl@xen.org>, =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

RG9tYWluIGNyZWF0aW9uIGZhaWx1cmUgcGF0aHMgZG9uJ3QgY2FsbCBkb21haW5fcmVsaW5xdWlz
aF9yZXNvdXJjZXMoKSwKeWV0IGFsbG9jYXRpb25zIGFuZCBhbGlrZSBkb25lIGZyb20gaHZtX2Rv
bWFpbl9pbml0aWFsaXplKCkgbmVlZCB0byBiZQp1bmRvbmUgbmV2ZXJ0aGVsZXNzLiBDYWxsIHRo
ZSBmdW5jdGlvbiBhbHNvIGZyb20gaHZtX2RvbWFpbl9kZXN0cm95KCksCmFmdGVyIG1ha2luZyBz
dXJlIGFsbCBkZXNjZW5kYW50cyBhcmUgaWRlbXBvdGVudC4KCk5vdGUgdGhhdCB3aGlsZSB2aXJp
ZGlhbl97ZG9tYWluLHZjcHV9X2RlaW5pdCgpIHdlcmUgYWxyZWFkeSB1c2VkIGluCndheXMgc3Vn
Z2VzdGluZyB0aGV5J3JlIGlkZW1wb3RlbnQsIHZpcmlkaWFuX3RpbWVfdmNwdV9kZWluaXQoKSBh
Y3R1YWxseQp3YXNuJ3Q6IE9uZSBjYW4ndCBraWxsIGEgdGltZXIgdGhhdCB3YXMgbmV2ZXIgaW5p
dGlhbGl6ZWQuCgpGb3IgaHZtX2Rlc3Ryb3lfYWxsX2lvcmVxX3NlcnZlcnMoKSdzIHB1cnBvc2Vz
IG1ha2UKcmVsb2NhdGVfcG9ydGlvX2hhbmRsZXIoKSByZXR1cm4gd2hldGhlciB0aGUgdG8gYmUg
cmVsb2NhdGVkIHBvcnQgcmFuZ2UKd2FzIGFjdHVhbGx5IGZvdW5kLiBUaGlzIHNlZW1zIGNoZWFw
ZXIgdGhhbiBpbnRyb2R1Y2luZyBhIGZsYWcgaW50bwpzdHJ1Y3QgaHZtX2RvbWFpbidzIGlvcmVx
X3NlcnZlciBzdWItc3RydWN0dXJlLgoKSW4gaHZtX2RvbWFpbl9pbml0aWFsaXNlKCkgYWRkaXRp
b25hbGx5Ci0gdXNlIFhGUkVFKCkgYWxzbyB0byByZXBsYWNlIGFkamFjZW50IHhmcmVlKCksCi0g
dXNlIGh2bV9kb21haW5fcmVsaW5xdWlzaF9yZXNvdXJjZXMoKSBhcyBiZWluZyBpZGVtcG90ZW50
IG5vdy4KCkZpeGVzOiBlN2E5YjVlNzJmMjYgKCJ2aXJpZGlhbjogc2VwYXJhdGVseSBhbGxvY2F0
ZSBkb21haW4gYW5kIHZjcHUgc3RydWN0dXJlcyIpCkZpeGVzOiAyNmZiYTNjODU1NzEgKCJ2aXJp
ZGlhbjogYWRkIGltcGxlbWVudGF0aW9uIG9mIHN5bnRoZXRpYyB0aW1lcnMiKQpTaWduZWQtb2Zm
LWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+CgotLS0gYS94ZW4vYXJjaC94ODYv
aHZtL2hwZXQuYworKysgYi94ZW4vYXJjaC94ODYvaHZtL2hwZXQuYwpAQCAtNzUxLDcgKzc1MSw3
IEBAIHZvaWQgaHBldF9kZWluaXQoc3RydWN0IGRvbWFpbiAqZCkKICAgICBpbnQgaTsKICAgICBI
UEVUU3RhdGUgKmggPSBkb21haW5fdmhwZXQoZCk7CiAKLSAgICBpZiAoICFoYXNfdmhwZXQoZCkg
KQorICAgIGlmICggIWhhc192aHBldChkKSB8fCAhZC0+YXJjaC5odm0ucGxfdGltZSB8fCAhaC0+
c3RpbWVfZnJlcSApCiAgICAgICAgIHJldHVybjsKIAogICAgIHdyaXRlX2xvY2soJmgtPmxvY2sp
OwpAQCAtNzYzLDYgKzc2Myw4IEBAIHZvaWQgaHBldF9kZWluaXQoc3RydWN0IGRvbWFpbiAqZCkK
ICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBIUEVUX1RJTUVSX05VTTsgaSsrICkKICAgICAgICAg
ICAgIGlmICggdGltZXJfZW5hYmxlZChoLCBpKSApCiAgICAgICAgICAgICAgICAgaHBldF9zdG9w
X3RpbWVyKGgsIGksIGd1ZXN0X3RpbWUpOworCisgICAgICAgIGgtPmhwZXQuY29uZmlnID0gMDsK
ICAgICB9CiAKICAgICB3cml0ZV91bmxvY2soJmgtPmxvY2spOwotLS0gYS94ZW4vYXJjaC94ODYv
aHZtL2h2bS5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMKQEAgLTY5NiwyNCArNjk2LDI0
IEBAIGludCBodm1fZG9tYWluX2luaXRpYWxpc2Uoc3RydWN0IGRvbWFpbgogICAgIHJldHVybiAw
OwogCiAgZmFpbDI6Ci0gICAgcnRjX2RlaW5pdChkKTsKICAgICBzdGR2Z2FfZGVpbml0KGQpOwog
ICAgIHZpb2FwaWNfZGVpbml0KGQpOwogIGZhaWwxOgogICAgIGlmICggaXNfaGFyZHdhcmVfZG9t
YWluKGQpICkKICAgICAgICAgeGZyZWUoZC0+YXJjaC5odm0uaW9fYml0bWFwKTsKLSAgICB4ZnJl
ZShkLT5hcmNoLmh2bS5pb19oYW5kbGVyKTsKLSAgICB4ZnJlZShkLT5hcmNoLmh2bS5wYXJhbXMp
OwotICAgIHhmcmVlKGQtPmFyY2guaHZtLnBsX3RpbWUpOwotICAgIHhmcmVlKGQtPmFyY2guaHZt
LmlycSk7CisgICAgWEZSRUUoZC0+YXJjaC5odm0uaW9faGFuZGxlcik7CisgICAgWEZSRUUoZC0+
YXJjaC5odm0ucGFyYW1zKTsKKyAgICBYRlJFRShkLT5hcmNoLmh2bS5wbF90aW1lKTsKKyAgICBY
RlJFRShkLT5hcmNoLmh2bS5pcnEpOwogIGZhaWwwOgogICAgIGh2bV9kZXN0cm95X2NhY2hlYXR0
cl9yZWdpb25fbGlzdChkKTsKICAgICBkZXN0cm95X3BlcmRvbWFpbl9tYXBwaW5nKGQsIFBFUkRP
TUFJTl9WSVJUX1NUQVJULCAwKTsKICBmYWlsOgotICAgIHZpcmlkaWFuX2RvbWFpbl9kZWluaXQo
ZCk7CisgICAgaHZtX2RvbWFpbl9yZWxpbnF1aXNoX3Jlc291cmNlcyhkKTsKICAgICByZXR1cm4g
cmM7CiB9CiAKKy8qIFRoaXMgZnVuY3Rpb24gYW5kIGFsbCBpdHMgZGVzY2VuZGFudHMgbmVlZCB0
byBiZSB0byBiZSBpZGVtcG90ZW50LiAqLwogdm9pZCBodm1fZG9tYWluX3JlbGlucXVpc2hfcmVz
b3VyY2VzKHN0cnVjdCBkb21haW4gKmQpCiB7CiAgICAgaWYgKCBodm1fZnVuY3MuZG9tYWluX3Jl
bGlucXVpc2hfcmVzb3VyY2VzICkKQEAgLTc0Miw2ICs3NDIsMTMgQEAgdm9pZCBodm1fZG9tYWlu
X2Rlc3Ryb3koc3RydWN0IGRvbWFpbiAqZAogICAgIHN0cnVjdCBsaXN0X2hlYWQgKmlvcG9ydF9s
aXN0LCAqdG1wOwogICAgIHN0cnVjdCBnMm1faW9wb3J0ICppb3BvcnQ7CiAKKyAgICAvKgorICAg
ICAqIFRoaXMgZnVuY3Rpb24gd291bGQgbm90IGJlIGNhbGxlZCB3aGVuIGRvbWFpbiBpbml0aWFs
aXphdGlvbiBmYWlscworICAgICAqIChsYXRlIGVub3VnaCksIHNvIGRvIHNvIGhlcmUuIFRoaXMg
cmVxdWlyZXMgdGhlIGZ1bmN0aW9uIGFuZCBhbGwgaXRzCisgICAgICogZGVzY2VuZGFudHMgdG8g
YmUgaWRlbXBvdGVudC4KKyAgICAgKi8KKyAgICBodm1fZG9tYWluX3JlbGlucXVpc2hfcmVzb3Vy
Y2VzKGQpOworCiAgICAgWEZSRUUoZC0+YXJjaC5odm0uaW9faGFuZGxlcik7CiAgICAgWEZSRUUo
ZC0+YXJjaC5odm0ucGFyYW1zKTsKIAotLS0gYS94ZW4vYXJjaC94ODYvaHZtL2lvcmVxLmMKKysr
IGIveGVuL2FyY2gveDg2L2h2bS9pb3JlcS5jCkBAIC0xMjI4LDYgKzEyMjgsOSBAQCB2b2lkIGh2
bV9kZXN0cm95X2FsbF9pb3JlcV9zZXJ2ZXJzKHN0cnVjCiAgICAgc3RydWN0IGh2bV9pb3JlcV9z
ZXJ2ZXIgKnM7CiAgICAgdW5zaWduZWQgaW50IGlkOwogCisgICAgaWYgKCAhcmVsb2NhdGVfcG9y
dGlvX2hhbmRsZXIoZCwgMHhjZjgsIDB4Y2Y4LCA0KSApCisgICAgICAgIHJldHVybjsKKwogICAg
IHNwaW5fbG9ja19yZWN1cnNpdmUoJmQtPmFyY2guaHZtLmlvcmVxX3NlcnZlci5sb2NrKTsKIAog
ICAgIC8qIE5vIG5lZWQgdG8gZG9tYWluX3BhdXNlKCkgYXMgdGhlIGRvbWFpbiBpcyBiZWluZyB0
b3JuIGRvd24gKi8KLS0tIGEveGVuL2FyY2gveDg2L2h2bS9pbnRlcmNlcHQuYworKysgYi94ZW4v
YXJjaC94ODYvaHZtL2ludGVyY2VwdC5jCkBAIC0zMDAsNyArMzAwLDcgQEAgdm9pZCByZWdpc3Rl
cl9wb3J0aW9faGFuZGxlcihzdHJ1Y3QgZG9tYQogICAgIGhhbmRsZXItPnBvcnRpby5hY3Rpb24g
PSBhY3Rpb247CiB9CiAKLXZvaWQgcmVsb2NhdGVfcG9ydGlvX2hhbmRsZXIoc3RydWN0IGRvbWFp
biAqZCwgdW5zaWduZWQgaW50IG9sZF9wb3J0LAorYm9vbCByZWxvY2F0ZV9wb3J0aW9faGFuZGxl
cihzdHJ1Y3QgZG9tYWluICpkLCB1bnNpZ25lZCBpbnQgb2xkX3BvcnQsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBuZXdfcG9ydCwgdW5zaWduZWQgaW50IHNpemUp
CiB7CiAgICAgdW5zaWduZWQgaW50IGk7CkBAIC0zMTcsOSArMzE3LDExIEBAIHZvaWQgcmVsb2Nh
dGVfcG9ydGlvX2hhbmRsZXIoc3RydWN0IGRvbWEKICAgICAgICAgICAgICAoaGFuZGxlci0+cG9y
dGlvLnNpemUgPSBzaXplKSApCiAgICAgICAgIHsKICAgICAgICAgICAgIGhhbmRsZXItPnBvcnRp
by5wb3J0ID0gbmV3X3BvcnQ7Ci0gICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgIHJldHVy
biB0cnVlOwogICAgICAgICB9CiAgICAgfQorCisgICAgcmV0dXJuIGZhbHNlOwogfQogCiBib29s
X3QgaHZtX21taW9faW50ZXJuYWwocGFkZHJfdCBncGEpCi0tLSBhL3hlbi9hcmNoL3g4Ni9odm0v
cG10aW1lci5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vcG10aW1lci5jCkBAIC0zNzMsNyArMzcz
LDcgQEAgdm9pZCBwbXRpbWVyX2RlaW5pdChzdHJ1Y3QgZG9tYWluICpkKQogewogICAgIFBNVFN0
YXRlICpzID0gJmQtPmFyY2guaHZtLnBsX3RpbWUtPnZwbXQ7CiAKLSAgICBpZiAoICFoYXNfdnBt
KGQpICkKKyAgICBpZiAoICFoYXNfdnBtKGQpIHx8ICFkLT5hcmNoLmh2bS5wbF90aW1lIHx8ICFz
LT52Y3B1ICkKICAgICAgICAgcmV0dXJuOwogCiAgICAga2lsbF90aW1lcigmcy0+dGltZXIpOwot
LS0gYS94ZW4vYXJjaC94ODYvaHZtL3J0Yy5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vcnRjLmMK
QEAgLTg0NCw3ICs4NDQsOCBAQCB2b2lkIHJ0Y19kZWluaXQoc3RydWN0IGRvbWFpbiAqZCkKIHsK
ICAgICBSVENTdGF0ZSAqcyA9IGRvbWFpbl92cnRjKGQpOwogCi0gICAgaWYgKCAhaGFzX3ZydGMo
ZCkgKQorICAgIGlmICggIWhhc192cnRjKGQpIHx8ICFkLT5hcmNoLmh2bS5wbF90aW1lIHx8Cisg
ICAgICAgICBzLT51cGRhdGVfdGltZXIuc3RhdHVzID09IFRJTUVSX1NUQVRVU19pbnZhbGlkICkK
ICAgICAgICAgcmV0dXJuOwogCiAgICAgc3Bpbl9iYXJyaWVyKCZzLT5sb2NrKTsKLS0tIGEveGVu
L2FyY2gveDg2L2h2bS92aXJpZGlhbi90aW1lLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS92aXJp
ZGlhbi90aW1lLmMKQEAgLTUyNCw2ICs1MjQsOCBAQCB2b2lkIHZpcmlkaWFuX3RpbWVfdmNwdV9k
ZWluaXQoY29uc3Qgc3RyCiAgICAgewogICAgICAgICBzdHJ1Y3QgdmlyaWRpYW5fc3RpbWVyICp2
cyA9ICZ2di0+c3RpbWVyW2ldOwogCisgICAgICAgIGlmICggIXZzLT52ICkKKyAgICAgICAgICAg
IGNvbnRpbnVlOwogICAgICAgICBraWxsX3RpbWVyKCZ2cy0+dGltZXIpOwogICAgICAgICB2cy0+
diA9IE5VTEw7CiAgICAgfQotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9pby5oCisrKyBi
L3hlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2lvLmgKQEAgLTExMiw3ICsxMTIsNyBAQCB2b2lkIHJl
Z2lzdGVyX3BvcnRpb19oYW5kbGVyKAogICAgIHN0cnVjdCBkb21haW4gKmQsIHVuc2lnbmVkIGlu
dCBwb3J0LCB1bnNpZ25lZCBpbnQgc2l6ZSwKICAgICBwb3J0aW9fYWN0aW9uX3QgYWN0aW9uKTsK
IAotdm9pZCByZWxvY2F0ZV9wb3J0aW9faGFuZGxlcigKK2Jvb2wgcmVsb2NhdGVfcG9ydGlvX2hh
bmRsZXIoCiAgICAgc3RydWN0IGRvbWFpbiAqZCwgdW5zaWduZWQgaW50IG9sZF9wb3J0LCB1bnNp
Z25lZCBpbnQgbmV3X3BvcnQsCiAgICAgdW5zaWduZWQgaW50IHNpemUpOwogCgpfX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBs
aXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2pl
Y3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

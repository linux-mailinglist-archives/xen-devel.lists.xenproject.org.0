Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 8210A6AD68
	for <lists+xen-devel@lfdr.de>; Tue, 16 Jul 2019 19:09:38 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hnQuQ-0005os-8Q; Tue, 16 Jul 2019 17:06:34 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=v+lg=VN=bitdefender.com=ppircalabu@srs-us1.protection.inumbo.net>)
 id 1hnQuO-0005oJ-9q
 for xen-devel@lists.xenproject.org; Tue, 16 Jul 2019 17:06:32 +0000
X-Inumbo-ID: 0cfbd976-a7ec-11e9-abc5-eb10bd455aa4
Received: from mx01.bbu.dsd.mx.bitdefender.com (unknown [91.199.104.161])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 0cfbd976-a7ec-11e9-abc5-eb10bd455aa4;
 Tue, 16 Jul 2019 17:06:29 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp02.buh.bitdefender.net [10.17.80.76])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 EF0EA305FFA4; Tue, 16 Jul 2019 20:06:25 +0300 (EEST)
Received: from bitdefender.com (unknown [195.189.155.70])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id DBCEB304F602;
 Tue, 16 Jul 2019 20:06:25 +0300 (EEST)
From: Petre Pircalabu <ppircalabu@bitdefender.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 16 Jul 2019 20:06:20 +0300
Message-Id: <880b61f88b9d19b3ef2bd43713caaab0528a190e.1563293545.git.ppircalabu@bitdefender.com>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <cover.1563293545.git.ppircalabu@bitdefender.com>
References: <cover.1563293545.git.ppircalabu@bitdefender.com>
In-Reply-To: <cover.1563293545.git.ppircalabu@bitdefender.com>
References: <cover.1563293545.git.ppircalabu@bitdefender.com>
Subject: [Xen-devel] [PATCH v2 06/10] vm_event: Decouple implementation
 details from interface.
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Petre Pircalabu <ppircalabu@bitdefender.com>,
 Alexandru Isaila <aisaila@bitdefender.com>,
 Tamas K Lengyel <tamas@tklengyel.com>,
 Razvan Cojocaru <rcojocaru@bitdefender.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VG8gYWNjb21tb2RhdGUgYSBzZWNvbmQgaW1wbGVtZW50YXRpb24gb2YgdGhlIHZtX2V2ZW50IHN1
YnN5c3RlbSwgdGhlCmN1cnJlbnQgb25lIChyaW5nKSBzaG91bGQgYmUgZGVjb3VwbGVkIGZyb20g
dGhlIHhlbi92bV9ldmVudC5oIGludGVyZmFjZS4KClNpZ25lZC1vZmYtYnk6IFBldHJlIFBpcmNh
bGFidSA8cHBpcmNhbGFidUBiaXRkZWZlbmRlci5jb20+Ci0tLQogeGVuL2NvbW1vbi92bV9ldmVu
dC5jICAgICAgfCAzNjggKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tCiB4ZW4vaW5jbHVkZS94ZW4vdm1fZXZlbnQuaCB8ICA2MCArKysrKysrLQogMiBmaWxlcyBj
aGFuZ2VkLCAyMzYgaW5zZXJ0aW9ucygrKSwgMTkyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBh
L3hlbi9jb21tb24vdm1fZXZlbnQuYyBiL3hlbi9jb21tb24vdm1fZXZlbnQuYwppbmRleCAyMTg5
NWMyLi5lNmE3YTI5IDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3ZtX2V2ZW50LmMKKysrIGIveGVu
L2NvbW1vbi92bV9ldmVudC5jCkBAIC0zNSwxMiArMzUsMTMgQEAKICNkZWZpbmUgeGVuX3JtYigp
ICBzbXBfcm1iKCkKICNkZWZpbmUgeGVuX3dtYigpICBzbXBfd21iKCkKIAotLyogVk0gZXZlbnQg
Ki8KLXN0cnVjdCB2bV9ldmVudF9kb21haW4KKyNkZWZpbmUgdG9fcmluZyhfdmVkKSBjb250YWlu
ZXJfb2YoKF92ZWQpLCBzdHJ1Y3Qgdm1fZXZlbnRfcmluZ19kb21haW4sIHZlZCkKKworLyogVk0g
ZXZlbnQgcmluZyBpbXBsZW1lbnRhdGlvbiAqLworc3RydWN0IHZtX2V2ZW50X3JpbmdfZG9tYWlu
CiB7Ci0gICAgLyogRG9tYWluIHJlZmVyZW5jZSAqLwotICAgIHN0cnVjdCBkb21haW4gKmQ7Ci0g
ICAgc3BpbmxvY2tfdCBsb2NrOworICAgIC8qIFZNIGV2ZW50IGRvbWFpbiAqLworICAgIHN0cnVj
dCB2bV9ldmVudF9kb21haW4gdmVkOwogICAgIC8qIFRoZSByaW5nIGhhcyA2NCBlbnRyaWVzICov
CiAgICAgdW5zaWduZWQgY2hhciBmb3JlaWduX3Byb2R1Y2VyczsKICAgICB1bnNpZ25lZCBjaGFy
IHRhcmdldF9wcm9kdWNlcnM7CkBAIC02MSw3ICs2Miw5IEBAIHN0cnVjdCB2bV9ldmVudF9kb21h
aW4KICAgICB1bnNpZ25lZCBpbnQgbGFzdF92Y3B1X3dha2VfdXA7CiB9OwogCi1zdGF0aWMgaW50
IHZtX2V2ZW50X2VuYWJsZSgKK3N0YXRpYyBjb25zdCBzdHJ1Y3Qgdm1fZXZlbnRfb3BzIHZtX2V2
ZW50X3Jpbmdfb3BzOworCitzdGF0aWMgaW50IHZtX2V2ZW50X3JpbmdfZW5hYmxlKAogICAgIHN0
cnVjdCBkb21haW4gKmQsCiAgICAgc3RydWN0IHhlbl9kb21jdGxfdm1fZXZlbnRfb3AgKnZlYywK
ICAgICBzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICoqcF92ZWQsCkBAIC03MSw3ICs3NCw3IEBAIHN0
YXRpYyBpbnQgdm1fZXZlbnRfZW5hYmxlKAogewogICAgIGludCByYzsKICAgICB1bnNpZ25lZCBs
b25nIHJpbmdfZ2ZuID0gZC0+YXJjaC5odm0ucGFyYW1zW3BhcmFtXTsKLSAgICBzdHJ1Y3Qgdm1f
ZXZlbnRfZG9tYWluICp2ZWQ7CisgICAgc3RydWN0IHZtX2V2ZW50X3JpbmdfZG9tYWluICppbXBs
OwogCiAgICAgLyoKICAgICAgKiBPbmx5IG9uZSBjb25uZWN0ZWQgYWdlbnQgYXQgYSB0aW1lLiAg
SWYgdGhlIGhlbHBlciBjcmFzaGVkLCB0aGUgcmluZyBpcwpAQCAtODQsMjggKzg3LDI4IEBAIHN0
YXRpYyBpbnQgdm1fZXZlbnRfZW5hYmxlKAogICAgIGlmICggcmluZ19nZm4gPT0gMCApCiAgICAg
ICAgIHJldHVybiAtRU9QTk9UU1VQUDsKIAotICAgIHZlZCA9IHh6YWxsb2Moc3RydWN0IHZtX2V2
ZW50X2RvbWFpbik7Ci0gICAgaWYgKCAhdmVkICkKKyAgICBpbXBsID0geHphbGxvYyhzdHJ1Y3Qg
dm1fZXZlbnRfcmluZ19kb21haW4pOworICAgIGlmICggIWltcGwgKQogICAgICAgICByZXR1cm4g
LUVOT01FTTsKIAogICAgIC8qIFRyaXZpYWwgc2V0dXAuICovCi0gICAgc3Bpbl9sb2NrX2luaXQo
JnZlZC0+bG9jayk7Ci0gICAgaW5pdF93YWl0cXVldWVfaGVhZCgmdmVkLT53cSk7Ci0gICAgdmVk
LT5wYXVzZV9mbGFnID0gcGF1c2VfZmxhZzsKKyAgICBzcGluX2xvY2tfaW5pdCgmaW1wbC0+dmVk
LmxvY2spOworICAgIGluaXRfd2FpdHF1ZXVlX2hlYWQoJmltcGwtPndxKTsKKyAgICBpbXBsLT52
ZWQuZCA9IGQ7CisgICAgaW1wbC0+dmVkLm9wcyA9ICZ2bV9ldmVudF9yaW5nX29wczsKKyAgICBp
bXBsLT5wYXVzZV9mbGFnID0gcGF1c2VfZmxhZzsKIAogICAgIHJjID0gdm1fZXZlbnRfaW5pdF9k
b21haW4oZCk7CiAgICAgaWYgKCByYyA8IDAgKQogICAgICAgICBnb3RvIGVycjsKIAotICAgIHZl
ZC0+ZCA9IGQ7Ci0KLSAgICByYyA9IHByZXBhcmVfcmluZ19mb3JfaGVscGVyKGQsIHJpbmdfZ2Zu
LCAmdmVkLT5yaW5nX3BnX3N0cnVjdCwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICZ2ZWQtPnJpbmdfcGFnZSk7CisgICAgcmMgPSBwcmVwYXJlX3JpbmdfZm9yX2hlbHBlcihkLCBy
aW5nX2dmbiwgJmltcGwtPnJpbmdfcGdfc3RydWN0LAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgJmltcGwtPnJpbmdfcGFnZSk7CiAgICAgaWYgKCByYyA8IDAgKQogICAgICAgICBn
b3RvIGVycjsKIAotICAgIEZST05UX1JJTkdfSU5JVCgmdmVkLT5mcm9udF9yaW5nLAotICAgICAg
ICAgICAgICAgICAgICAodm1fZXZlbnRfc3JpbmdfdCAqKXZlZC0+cmluZ19wYWdlLAorICAgIEZS
T05UX1JJTkdfSU5JVCgmaW1wbC0+ZnJvbnRfcmluZywKKyAgICAgICAgICAgICAgICAgICAgKHZt
X2V2ZW50X3NyaW5nX3QgKilpbXBsLT5yaW5nX3BhZ2UsCiAgICAgICAgICAgICAgICAgICAgIFBB
R0VfU0laRSk7CiAKICAgICByYyA9IGFsbG9jX3VuYm91bmRfeGVuX2V2ZW50X2NoYW5uZWwoZCwg
MCwgY3VycmVudC0+ZG9tYWluLT5kb21haW5faWQsCkBAIC0xMTMsMjYgKzExNiwyNiBAQCBzdGF0
aWMgaW50IHZtX2V2ZW50X2VuYWJsZSgKICAgICBpZiAoIHJjIDwgMCApCiAgICAgICAgIGdvdG8g
ZXJyOwogCi0gICAgdmVkLT54ZW5fcG9ydCA9IHZlYy0+dS5lbmFibGUucG9ydCA9IHJjOworICAg
IGltcGwtPnhlbl9wb3J0ID0gdmVjLT51LmVuYWJsZS5wb3J0ID0gcmM7CiAKICAgICAvKiBTdWNj
ZXNzLiAgRmlsbCBpbiB0aGUgZG9tYWluJ3MgYXBwcm9wcmlhdGUgdmVkLiAqLwotICAgICpwX3Zl
ZCA9IHZlZDsKKyAgICAqcF92ZWQgPSAmaW1wbC0+dmVkOwogCiAgICAgcmV0dXJuIDA7CiAKICBl
cnI6Ci0gICAgZGVzdHJveV9yaW5nX2Zvcl9oZWxwZXIoJnZlZC0+cmluZ19wYWdlLCB2ZWQtPnJp
bmdfcGdfc3RydWN0KTsKLSAgICB4ZnJlZSh2ZWQpOworICAgIGRlc3Ryb3lfcmluZ19mb3JfaGVs
cGVyKCZpbXBsLT5yaW5nX3BhZ2UsIGltcGwtPnJpbmdfcGdfc3RydWN0KTsKKyAgICB4ZnJlZShp
bXBsKTsKIAogICAgIHJldHVybiByYzsKIH0KIAotc3RhdGljIHVuc2lnbmVkIGludCB2bV9ldmVu
dF9yaW5nX2F2YWlsYWJsZShzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQpCitzdGF0aWMgdW5z
aWduZWQgaW50IHZtX2V2ZW50X3JpbmdfYXZhaWxhYmxlKHN0cnVjdCB2bV9ldmVudF9yaW5nX2Rv
bWFpbiAqaW1wbCkKIHsKLSAgICBpbnQgYXZhaWxfcmVxID0gUklOR19GUkVFX1JFUVVFU1RTKCZ2
ZWQtPmZyb250X3JpbmcpOworICAgIGludCBhdmFpbF9yZXEgPSBSSU5HX0ZSRUVfUkVRVUVTVFMo
JmltcGwtPmZyb250X3JpbmcpOwogCi0gICAgYXZhaWxfcmVxIC09IHZlZC0+dGFyZ2V0X3Byb2R1
Y2VyczsKLSAgICBhdmFpbF9yZXEgLT0gdmVkLT5mb3JlaWduX3Byb2R1Y2VyczsKKyAgICBhdmFp
bF9yZXEgLT0gaW1wbC0+dGFyZ2V0X3Byb2R1Y2VyczsKKyAgICBhdmFpbF9yZXEgLT0gaW1wbC0+
Zm9yZWlnbl9wcm9kdWNlcnM7CiAKICAgICBCVUdfT04oYXZhaWxfcmVxIDwgMCk7CiAKQEAgLTE0
MCwzOCArMTQzLDM4IEBAIHN0YXRpYyB1bnNpZ25lZCBpbnQgdm1fZXZlbnRfcmluZ19hdmFpbGFi
bGUoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQogfQogCiAvKgotICogdm1fZXZlbnRfd2Fr
ZV9ibG9ja2VkKCkgd2lsbCB3YWtldXAgdmNwdXMgd2FpdGluZyBmb3Igcm9vbSBpbiB0aGUKKyAq
IHZtX2V2ZW50X3Jpbmdfd2FrZV9ibG9ja2VkKCkgd2lsbCB3YWtldXAgdmNwdXMgd2FpdGluZyBm
b3Igcm9vbSBpbiB0aGUKICAqIHJpbmcuIFRoZXNlIHZDUFVzIHdlcmUgcGF1c2VkIG9uIHRoZWly
IHdheSBvdXQgYWZ0ZXIgcGxhY2luZyBhbiBldmVudCwKICAqIGJ1dCBuZWVkIHRvIGJlIHJlc3Vt
ZWQgd2hlcmUgdGhlIHJpbmcgaXMgY2FwYWJsZSBvZiBwcm9jZXNzaW5nIGF0IGxlYXN0CiAgKiBv
bmUgZXZlbnQgZnJvbSB0aGVtLgogICovCi1zdGF0aWMgdm9pZCB2bV9ldmVudF93YWtlX2Jsb2Nr
ZWQoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQorc3RhdGljIHZvaWQgdm1fZXZlbnRfcmlu
Z193YWtlX2Jsb2NrZWQoc3RydWN0IHZtX2V2ZW50X3JpbmdfZG9tYWluICppbXBsKQogewogICAg
IHN0cnVjdCB2Y3B1ICp2OwotICAgIHVuc2lnbmVkIGludCBpLCBqLCBrLCBhdmFpbF9yZXEgPSB2
bV9ldmVudF9yaW5nX2F2YWlsYWJsZSh2ZWQpOwotICAgIHN0cnVjdCBkb21haW4gKmQgPSB2ZWQt
PmQ7CisgICAgdW5zaWduZWQgaW50IGksIGosIGssIGF2YWlsX3JlcSA9IHZtX2V2ZW50X3Jpbmdf
YXZhaWxhYmxlKGltcGwpOworICAgIHN0cnVjdCBkb21haW4gKmQgPSBpbXBsLT52ZWQuZDsKIAot
ICAgIGlmICggYXZhaWxfcmVxID09IDAgfHwgdmVkLT5ibG9ja2VkID09IDAgKQorICAgIGlmICgg
YXZhaWxfcmVxID09IDAgfHwgaW1wbC0+YmxvY2tlZCA9PSAwICkKICAgICAgICAgcmV0dXJuOwog
CiAgICAgLyogV2UgcmVtZW1iZXIgd2hpY2ggdmNwdSBsYXN0IHdva2UgdXAgdG8gYXZvaWQgc2Nh
bm5pbmcgYWx3YXlzIGxpbmVhcmx5CiAgICAgICogZnJvbSB6ZXJvIGFuZCBzdGFydmluZyBoaWdo
ZXItbnVtYmVyZWQgdmNwdXMgdW5kZXIgaGlnaCBsb2FkICovCi0gICAgZm9yICggaSA9IHZlZC0+
bGFzdF92Y3B1X3dha2VfdXAgKyAxLCBqID0gMDsgaiA8IGQtPm1heF92Y3B1czsgaSsrLCBqKysg
KQorICAgIGZvciAoIGkgPSBpbXBsLT5sYXN0X3ZjcHVfd2FrZV91cCArIDEsIGogPSAwOyBqIDwg
ZC0+bWF4X3ZjcHVzOyBpKyssIGorKyApCiAgICAgewogICAgICAgICBrID0gaSAlIGQtPm1heF92
Y3B1czsKICAgICAgICAgdiA9IGQtPnZjcHVba107CiAgICAgICAgIGlmICggIXYgKQogICAgICAg
ICAgICAgY29udGludWU7CiAKLSAgICAgICAgaWYgKCAhdmVkLT5ibG9ja2VkIHx8IGF2YWlsX3Jl
cSA9PSAwICkKKyAgICAgICAgaWYgKCAhaW1wbC0+YmxvY2tlZCB8fCBhdmFpbF9yZXEgPT0gMCAp
CiAgICAgICAgICAgICBicmVhazsKIAotICAgICAgICBpZiAoIHRlc3RfYW5kX2NsZWFyX2JpdCh2
ZWQtPnBhdXNlX2ZsYWcsICZ2LT5wYXVzZV9mbGFncykgKQorICAgICAgICBpZiAoIHRlc3RfYW5k
X2NsZWFyX2JpdChpbXBsLT5wYXVzZV9mbGFnLCAmdi0+cGF1c2VfZmxhZ3MpICkKICAgICAgICAg
ewogICAgICAgICAgICAgdmNwdV91bnBhdXNlKHYpOwogICAgICAgICAgICAgYXZhaWxfcmVxLS07
Ci0gICAgICAgICAgICB2ZWQtPmJsb2NrZWQtLTsKLSAgICAgICAgICAgIHZlZC0+bGFzdF92Y3B1
X3dha2VfdXAgPSBrOworICAgICAgICAgICAgaW1wbC0+YmxvY2tlZC0tOworICAgICAgICAgICAg
aW1wbC0+bGFzdF92Y3B1X3dha2VfdXAgPSBrOwogICAgICAgICB9CiAgICAgfQogfQpAQCAtMTgx
LDkzICsxODQsOTAgQEAgc3RhdGljIHZvaWQgdm1fZXZlbnRfd2FrZV9ibG9ja2VkKHN0cnVjdCB2
bV9ldmVudF9kb21haW4gKnZlZCkKICAqIHdhcyB1bmFibGUgdG8gZG8gc28sIGl0IGlzIHF1ZXVl
ZCBvbiBhIHdhaXQgcXVldWUuICBUaGVzZSBhcmUgd29rZW4gYXMKICAqIG5lZWRlZCwgYW5kIHRh
a2UgcHJlY2VkZW5jZSBvdmVyIHRoZSBibG9ja2VkIHZDUFVzLgogICovCi1zdGF0aWMgdm9pZCB2
bV9ldmVudF93YWtlX3F1ZXVlZChzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQpCitzdGF0aWMg
dm9pZCB2bV9ldmVudF9yaW5nX3dha2VfcXVldWVkKHN0cnVjdCB2bV9ldmVudF9yaW5nX2RvbWFp
biAqaW1wbCkKIHsKLSAgICB1bnNpZ25lZCBpbnQgYXZhaWxfcmVxID0gdm1fZXZlbnRfcmluZ19h
dmFpbGFibGUodmVkKTsKKyAgICB1bnNpZ25lZCBpbnQgYXZhaWxfcmVxID0gdm1fZXZlbnRfcmlu
Z19hdmFpbGFibGUoaW1wbCk7CiAKICAgICBpZiAoIGF2YWlsX3JlcSA+IDAgKQotICAgICAgICB3
YWtlX3VwX25yKCZ2ZWQtPndxLCBhdmFpbF9yZXEpOworICAgICAgICB3YWtlX3VwX25yKCZpbXBs
LT53cSwgYXZhaWxfcmVxKTsKIH0KIAogLyoKLSAqIHZtX2V2ZW50X3dha2UoKSB3aWxsIHdha2V1
cCBhbGwgdmNwdXMgd2FpdGluZyBmb3IgdGhlIHJpbmcgdG8KKyAqIHZtX2V2ZW50X3Jpbmdfd2Fr
ZSgpIHdpbGwgd2FrZXVwIGFsbCB2Y3B1cyB3YWl0aW5nIGZvciB0aGUgcmluZyB0bwogICogYmVj
b21lIGF2YWlsYWJsZS4gIElmIHdlIGhhdmUgcXVldWVkIHZDUFVzLCB0aGV5IGdldCB0b3AgcHJp
b3JpdHkuIFdlCiAgKiBhcmUgZ3VhcmFudGVlZCB0aGF0IHRoZXkgd2lsbCBnbyB0aHJvdWdoIGNv
ZGUgcGF0aHMgdGhhdCB3aWxsIGV2ZW50dWFsbHkKLSAqIGNhbGwgdm1fZXZlbnRfd2FrZSgpIGFn
YWluLCBlbnN1cmluZyB0aGF0IGFueSBibG9ja2VkIHZDUFVzIHdpbGwgZ2V0CisgKiBjYWxsIHZt
X2V2ZW50X3Jpbmdfd2FrZSgpIGFnYWluLCBlbnN1cmluZyB0aGF0IGFueSBibG9ja2VkIHZDUFVz
IHdpbGwgZ2V0CiAgKiB1bnBhdXNlZCBvbmNlIGFsbCB0aGUgcXVldWVkIHZDUFVzIGhhdmUgbWFk
ZSBpdCB0aHJvdWdoLgogICovCi12b2lkIHZtX2V2ZW50X3dha2Uoc3RydWN0IHZtX2V2ZW50X2Rv
bWFpbiAqdmVkKQorc3RhdGljIHZvaWQgdm1fZXZlbnRfcmluZ193YWtlKHN0cnVjdCB2bV9ldmVu
dF9yaW5nX2RvbWFpbiAqaW1wbCkKIHsKLSAgICBpZiAoICFsaXN0X2VtcHR5KCZ2ZWQtPndxLmxp
c3QpICkKLSAgICAgICAgdm1fZXZlbnRfd2FrZV9xdWV1ZWQodmVkKTsKKyAgICBpZiAoICFsaXN0
X2VtcHR5KCZpbXBsLT53cS5saXN0KSApCisgICAgICAgIHZtX2V2ZW50X3Jpbmdfd2FrZV9xdWV1
ZWQoaW1wbCk7CiAgICAgZWxzZQotICAgICAgICB2bV9ldmVudF93YWtlX2Jsb2NrZWQodmVkKTsK
KyAgICAgICAgdm1fZXZlbnRfcmluZ193YWtlX2Jsb2NrZWQoaW1wbCk7CiB9CiAKLXN0YXRpYyBp
bnQgdm1fZXZlbnRfZGlzYWJsZShzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3Qgdm1fZXZlbnRfZG9t
YWluICoqcF92ZWQpCitzdGF0aWMgaW50IHZtX2V2ZW50X3JpbmdfZGlzYWJsZShzdHJ1Y3Qgdm1f
ZXZlbnRfZG9tYWluICoqcF92ZWQpCiB7Ci0gICAgc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVk
ID0gKnBfdmVkOwotCi0gICAgaWYgKCB2bV9ldmVudF9jaGVjayh2ZWQpICkKLSAgICB7Ci0gICAg
ICAgIHN0cnVjdCB2Y3B1ICp2OworICAgIHN0cnVjdCB2Y3B1ICp2OworICAgIHN0cnVjdCBkb21h
aW4gKmQgPSAoKnBfdmVkKS0+ZDsKKyAgICBzdHJ1Y3Qgdm1fZXZlbnRfcmluZ19kb21haW4gKmlt
cGwgPSB0b19yaW5nKCpwX3ZlZCk7CiAKLSAgICAgICAgc3Bpbl9sb2NrKCZ2ZWQtPmxvY2spOwor
ICAgIHNwaW5fbG9jaygmaW1wbC0+dmVkLmxvY2spOwogCi0gICAgICAgIGlmICggIWxpc3RfZW1w
dHkoJnZlZC0+d3EubGlzdCkgKQotICAgICAgICB7Ci0gICAgICAgICAgICBzcGluX3VubG9jaygm
dmVkLT5sb2NrKTsKLSAgICAgICAgICAgIHJldHVybiAtRUJVU1k7Ci0gICAgICAgIH0KKyAgICBp
ZiAoICFsaXN0X2VtcHR5KCZpbXBsLT53cS5saXN0KSApCisgICAgeworICAgICAgICBzcGluX3Vu
bG9jaygmaW1wbC0+dmVkLmxvY2spOworICAgICAgICByZXR1cm4gLUVCVVNZOworICAgIH0KIAot
ICAgICAgICAvKiBGcmVlIGRvbVUncyBldmVudCBjaGFubmVsIGFuZCBsZWF2ZSB0aGUgb3RoZXIg
b25lIHVuYm91bmQgKi8KLSAgICAgICAgZnJlZV94ZW5fZXZlbnRfY2hhbm5lbChkLCB2ZWQtPnhl
bl9wb3J0KTsKKyAgICAvKiBGcmVlIGRvbVUncyBldmVudCBjaGFubmVsIGFuZCBsZWF2ZSB0aGUg
b3RoZXIgb25lIHVuYm91bmQgKi8KKyAgICBmcmVlX3hlbl9ldmVudF9jaGFubmVsKGQsIGltcGwt
Pnhlbl9wb3J0KTsKIAotICAgICAgICAvKiBVbmJsb2NrIGFsbCB2Q1BVcyAqLwotICAgICAgICBm
b3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgLyogVW5ibG9jayBhbGwgdkNQVXMgKi8KKyAgICBm
b3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgeworICAgICAgICBpZiAoIHRlc3RfYW5kX2NsZWFy
X2JpdChpbXBsLT5wYXVzZV9mbGFnLCAmdi0+cGF1c2VfZmxhZ3MpICkKICAgICAgICAgewotICAg
ICAgICAgICAgaWYgKCB0ZXN0X2FuZF9jbGVhcl9iaXQodmVkLT5wYXVzZV9mbGFnLCAmdi0+cGF1
c2VfZmxhZ3MpICkKLSAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAgICB2Y3B1X3VucGF1c2Uo
dik7Ci0gICAgICAgICAgICAgICAgdmVkLT5ibG9ja2VkLS07Ci0gICAgICAgICAgICB9CisgICAg
ICAgICAgICB2Y3B1X3VucGF1c2Uodik7CisgICAgICAgICAgICBpbXBsLT5ibG9ja2VkLS07CiAg
ICAgICAgIH0KKyAgICB9CiAKLSAgICAgICAgZGVzdHJveV9yaW5nX2Zvcl9oZWxwZXIoJnZlZC0+
cmluZ19wYWdlLCB2ZWQtPnJpbmdfcGdfc3RydWN0KTsKKyAgICBkZXN0cm95X3JpbmdfZm9yX2hl
bHBlcigmaW1wbC0+cmluZ19wYWdlLCBpbXBsLT5yaW5nX3BnX3N0cnVjdCk7CiAKLSAgICAgICAg
dm1fZXZlbnRfY2xlYW51cF9kb21haW4oZCk7CisgICAgdm1fZXZlbnRfY2xlYW51cF9kb21haW4o
ZCk7CiAKLSAgICAgICAgc3Bpbl91bmxvY2soJnZlZC0+bG9jayk7Ci0gICAgfQorICAgIHNwaW5f
dW5sb2NrKCZpbXBsLT52ZWQubG9jayk7CiAKLSAgICB4ZnJlZSh2ZWQpOworICAgIHhmcmVlKGlt
cGwpOwogICAgICpwX3ZlZCA9IE5VTEw7Ci0KICAgICByZXR1cm4gMDsKIH0KIAotc3RhdGljIHZv
aWQgdm1fZXZlbnRfcmVsZWFzZV9zbG90KHN0cnVjdCB2bV9ldmVudF9kb21haW4gKnZlZCkKK3N0
YXRpYyB2b2lkIHZtX2V2ZW50X3JpbmdfcmVsZWFzZV9zbG90KHN0cnVjdCB2bV9ldmVudF9yaW5n
X2RvbWFpbiAqaW1wbCkKIHsKICAgICAvKiBVcGRhdGUgdGhlIGFjY291bnRpbmcgKi8KLSAgICBp
ZiAoIGN1cnJlbnQtPmRvbWFpbiA9PSB2ZWQtPmQgKQotICAgICAgICB2ZWQtPnRhcmdldF9wcm9k
dWNlcnMtLTsKKyAgICBpZiAoIGN1cnJlbnQtPmRvbWFpbiA9PSBpbXBsLT52ZWQuZCApCisgICAg
ICAgIGltcGwtPnRhcmdldF9wcm9kdWNlcnMtLTsKICAgICBlbHNlCi0gICAgICAgIHZlZC0+Zm9y
ZWlnbl9wcm9kdWNlcnMtLTsKKyAgICAgICAgaW1wbC0+Zm9yZWlnbl9wcm9kdWNlcnMtLTsKIAog
ICAgIC8qIEtpY2sgYW55IHdhaXRlcnMgKi8KLSAgICB2bV9ldmVudF93YWtlKHZlZCk7CisgICAg
dm1fZXZlbnRfcmluZ193YWtlKGltcGwpOwogfQogCiAvKgotICogdm1fZXZlbnRfbWFya19hbmRf
cGF1c2UoKSB0YWdzIHZjcHUgYW5kIHB1dCBpdCB0byBzbGVlcC4KLSAqIFRoZSB2Y3B1IHdpbGwg
cmVzdW1lIGV4ZWN1dGlvbiBpbiB2bV9ldmVudF93YWtlX2Jsb2NrZWQoKS4KKyAqIHZtX2V2ZW50
X3JpbmdfbWFya19hbmRfcGF1c2UoKSB0YWdzIHZjcHUgYW5kIHB1dCBpdCB0byBzbGVlcC4KKyAq
IFRoZSB2Y3B1IHdpbGwgcmVzdW1lIGV4ZWN1dGlvbiBpbiB2bV9ldmVudF9yaW5nX3dha2VfYmxv
Y2tlZCgpLgogICovCi1zdGF0aWMgdm9pZCB2bV9ldmVudF9tYXJrX2FuZF9wYXVzZShzdHJ1Y3Qg
dmNwdSAqdiwgc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQorc3RhdGljIHZvaWQgdm1fZXZl
bnRfcmluZ19tYXJrX2FuZF9wYXVzZShzdHJ1Y3QgdmNwdSAqdiwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHZtX2V2ZW50X3JpbmdfZG9tYWluICppbXBs
KQogewotICAgIGlmICggIXRlc3RfYW5kX3NldF9iaXQodmVkLT5wYXVzZV9mbGFnLCAmdi0+cGF1
c2VfZmxhZ3MpICkKKyAgICBpZiAoICF0ZXN0X2FuZF9zZXRfYml0KGltcGwtPnBhdXNlX2ZsYWcs
ICZ2LT5wYXVzZV9mbGFncykgKQogICAgIHsKICAgICAgICAgdmNwdV9wYXVzZV9ub3N5bmModik7
Ci0gICAgICAgIHZlZC0+YmxvY2tlZCsrOworICAgICAgICBpbXBsLT5ibG9ja2VkKys7CiAgICAg
fQogfQogCkBAIC0yNzcsMzQgKzI3NywzMSBAQCBzdGF0aWMgdm9pZCB2bV9ldmVudF9tYXJrX2Fu
ZF9wYXVzZShzdHJ1Y3QgdmNwdSAqdiwgc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQogICog
b3Zlcmx5IGZ1bGwgYW5kIGl0cyBjb250aW51ZWQgZXhlY3V0aW9uIHdvdWxkIGNhdXNlIHN0YWxs
aW5nIGFuZCBleGNlc3NpdmUKICAqIHdhaXRpbmcuICBUaGUgdkNQVSB3aWxsIGJlIGF1dG9tYXRp
Y2FsbHkgdW5wYXVzZWQgd2hlbiB0aGUgcmluZyBjbGVhcnMuCiAgKi8KLXZvaWQgdm1fZXZlbnRf
cHV0X3JlcXVlc3Qoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkLAotICAgICAgICAgICAgICAg
ICAgICAgICAgICB2bV9ldmVudF9yZXF1ZXN0X3QgKnJlcSkKK3N0YXRpYyB2b2lkIHZtX2V2ZW50
X3JpbmdfcHV0X3JlcXVlc3Qoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bV9ldmVudF9yZXF1ZXN0X3QgKnJlcSkKIHsK
ICAgICB2bV9ldmVudF9mcm9udF9yaW5nX3QgKmZyb250X3Jpbmc7CiAgICAgaW50IGZyZWVfcmVx
OwogICAgIHVuc2lnbmVkIGludCBhdmFpbF9yZXE7CiAgICAgUklOR19JRFggcmVxX3Byb2Q7CiAg
ICAgc3RydWN0IHZjcHUgKmN1cnIgPSBjdXJyZW50OwotICAgIHN0cnVjdCBkb21haW4gKmQgPSB2
ZWQtPmQ7Ci0KLSAgICBpZiggIXZtX2V2ZW50X2NoZWNrKHZlZCkgKQotICAgICAgICByZXR1cm47
CisgICAgc3RydWN0IHZtX2V2ZW50X3JpbmdfZG9tYWluICppbXBsID0gdG9fcmluZyh2ZWQpOwog
Ci0gICAgaWYgKCBjdXJyLT5kb21haW4gIT0gZCApCisgICAgaWYgKCBjdXJyLT5kb21haW4gIT0g
dmVkLT5kICkKICAgICB7CiAgICAgICAgIHJlcS0+ZmxhZ3MgfD0gVk1fRVZFTlRfRkxBR19GT1JF
SUdOOwogCiAgICAgICAgIGlmICggIShyZXEtPmZsYWdzICYgVk1fRVZFTlRfRkxBR19WQ1BVX1BB
VVNFRCkgKQogICAgICAgICAgICAgZ2RwcmludGsoWEVOTE9HX1dBUk5JTkcsICJkJWR2JWQgd2Fz
IG5vdCBwYXVzZWQuXG4iLAotICAgICAgICAgICAgICAgICAgICAgZC0+ZG9tYWluX2lkLCByZXEt
PnZjcHVfaWQpOworICAgICAgICAgICAgICAgICAgICAgdmVkLT5kLT5kb21haW5faWQsIHJlcS0+
dmNwdV9pZCk7CiAgICAgfQogCiAgICAgcmVxLT52ZXJzaW9uID0gVk1fRVZFTlRfSU5URVJGQUNF
X1ZFUlNJT047CiAKLSAgICBzcGluX2xvY2soJnZlZC0+bG9jayk7CisgICAgc3Bpbl9sb2NrKCZp
bXBsLT52ZWQubG9jayk7CiAKICAgICAvKiBEdWUgdG8gdGhlIHJlc2VydmF0aW9ucywgdGhpcyBz
dGVwIG11c3Qgc3VjY2VlZC4gKi8KLSAgICBmcm9udF9yaW5nID0gJnZlZC0+ZnJvbnRfcmluZzsK
KyAgICBmcm9udF9yaW5nID0gJmltcGwtPmZyb250X3Jpbmc7CiAgICAgZnJlZV9yZXEgPSBSSU5H
X0ZSRUVfUkVRVUVTVFMoZnJvbnRfcmluZyk7CiAgICAgQVNTRVJUKGZyZWVfcmVxID4gMCk7CiAK
QEAgLTMxOCwzMSArMzE1LDMxIEBAIHZvaWQgdm1fZXZlbnRfcHV0X3JlcXVlc3Qoc3RydWN0IHZt
X2V2ZW50X2RvbWFpbiAqdmVkLAogICAgIFJJTkdfUFVTSF9SRVFVRVNUUyhmcm9udF9yaW5nKTsK
IAogICAgIC8qIFdlJ3ZlIGFjdHVhbGx5ICp1c2VkKiBvdXIgcmVzZXJ2YXRpb24sIHNvIHJlbGVh
c2UgdGhlIHNsb3QuICovCi0gICAgdm1fZXZlbnRfcmVsZWFzZV9zbG90KHZlZCk7CisgICAgdm1f
ZXZlbnRfcmluZ19yZWxlYXNlX3Nsb3QoaW1wbCk7CiAKICAgICAvKiBHaXZlIHRoaXMgdkNQVSBh
IGJsYWNrIGV5ZSBpZiBuZWNlc3NhcnksIG9uIHRoZSB3YXkgb3V0LgogICAgICAqIFNlZSB0aGUg
Y29tbWVudHMgYWJvdmUgd2FrZV9ibG9ja2VkKCkgZm9yIG1vcmUgaW5mb3JtYXRpb24KICAgICAg
KiBvbiBob3cgdGhpcyBtZWNoYW5pc20gd29ya3MgdG8gYXZvaWQgd2FpdGluZy4gKi8KLSAgICBh
dmFpbF9yZXEgPSB2bV9ldmVudF9yaW5nX2F2YWlsYWJsZSh2ZWQpOwotICAgIGlmKCBjdXJyLT5k
b21haW4gPT0gZCAmJiBhdmFpbF9yZXEgPCBkLT5tYXhfdmNwdXMgJiYKKyAgICBhdmFpbF9yZXEg
PSB2bV9ldmVudF9yaW5nX2F2YWlsYWJsZShpbXBsKTsKKyAgICBpZiggY3Vyci0+ZG9tYWluID09
IHZlZC0+ZCAmJiBhdmFpbF9yZXEgPCB2ZWQtPmQtPm1heF92Y3B1cyAmJgogICAgICAgICAhYXRv
bWljX3JlYWQoJmN1cnItPnZtX2V2ZW50X3BhdXNlX2NvdW50KSApCi0gICAgICAgIHZtX2V2ZW50
X21hcmtfYW5kX3BhdXNlKGN1cnIsIHZlZCk7CisgICAgICAgIHZtX2V2ZW50X3JpbmdfbWFya19h
bmRfcGF1c2UoY3VyciwgaW1wbCk7CiAKLSAgICBzcGluX3VubG9jaygmdmVkLT5sb2NrKTsKKyAg
ICBzcGluX3VubG9jaygmaW1wbC0+dmVkLmxvY2spOwogCi0gICAgbm90aWZ5X3ZpYV94ZW5fZXZl
bnRfY2hhbm5lbChkLCB2ZWQtPnhlbl9wb3J0KTsKKyAgICBub3RpZnlfdmlhX3hlbl9ldmVudF9j
aGFubmVsKHZlZC0+ZCwgaW1wbC0+eGVuX3BvcnQpOwogfQogCi1zdGF0aWMgaW50IHZtX2V2ZW50
X2dldF9yZXNwb25zZShzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2
ZWQsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bV9ldmVudF9yZXNwb25zZV90
ICpyc3ApCitzdGF0aWMgaW50IHZtX2V2ZW50X3JpbmdfZ2V0X3Jlc3BvbnNlKHN0cnVjdCB2bV9l
dmVudF9yaW5nX2RvbWFpbiAqaW1wbCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgdm1fZXZlbnRfcmVzcG9uc2VfdCAqcnNwKQogewogICAgIHZtX2V2ZW50X2Zyb250X3Jp
bmdfdCAqZnJvbnRfcmluZzsKICAgICBSSU5HX0lEWCByc3BfY29uczsKICAgICBpbnQgcmMgPSAw
OwogCi0gICAgc3Bpbl9sb2NrKCZ2ZWQtPmxvY2spOworICAgIHNwaW5fbG9jaygmaW1wbC0+dmVk
LmxvY2spOwogCi0gICAgZnJvbnRfcmluZyA9ICZ2ZWQtPmZyb250X3Jpbmc7CisgICAgZnJvbnRf
cmluZyA9ICZpbXBsLT5mcm9udF9yaW5nOwogICAgIHJzcF9jb25zID0gZnJvbnRfcmluZy0+cnNw
X2NvbnM7CiAKICAgICBpZiAoICFSSU5HX0hBU19VTkNPTlNVTUVEX1JFU1BPTlNFUyhmcm9udF9y
aW5nKSApCkBAIC0zNTgsMTIgKzM1NSwxMiBAQCBzdGF0aWMgaW50IHZtX2V2ZW50X2dldF9yZXNw
b25zZShzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQsCiAKICAg
ICAvKiBLaWNrIGFueSB3YWl0ZXJzIC0tIHNpbmNlIHdlJ3ZlIGp1c3QgY29uc3VtZWQgYW4gZXZl
bnQsCiAgICAgICogdGhlcmUgbWF5IGJlIGFkZGl0aW9uYWwgc3BhY2UgYXZhaWxhYmxlIGluIHRo
ZSByaW5nLiAqLwotICAgIHZtX2V2ZW50X3dha2UodmVkKTsKKyAgICB2bV9ldmVudF9yaW5nX3dh
a2UoaW1wbCk7CiAKICAgICByYyA9IDE7CiAKICBvdXQ6Ci0gICAgc3Bpbl91bmxvY2soJnZlZC0+
bG9jayk7CisgICAgc3Bpbl91bmxvY2soJmltcGwtPnZlZC5sb2NrKTsKIAogICAgIHJldHVybiBy
YzsKIH0KQEAgLTM3NiwxMCArMzczLDEzIEBAIHN0YXRpYyBpbnQgdm1fZXZlbnRfZ2V0X3Jlc3Bv
bnNlKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCB2bV9ldmVudF9kb21haW4gKnZlZCwKICAqIE5v
dGU6IHJlc3BvbnNlcyBhcmUgaGFuZGxlZCB0aGUgc2FtZSB3YXkgcmVnYXJkbGVzcyBvZiB3aGlj
aCByaW5nIHRoZXkKICAqIGFycml2ZSBvbi4KICAqLwotc3RhdGljIGludCB2bV9ldmVudF9yZXN1
bWUoc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQorc3RhdGlj
IGludCB2bV9ldmVudF9yaW5nX3Jlc3VtZShzdHJ1Y3Qgdm1fZXZlbnRfcmluZ19kb21haW4gKmlt
cGwpCiB7CiAgICAgdm1fZXZlbnRfcmVzcG9uc2VfdCByc3A7CiAKKyAgICBpZiAoIHVubGlrZWx5
KCFpbXBsIHx8ICF2bV9ldmVudF9jaGVjaygmaW1wbC0+dmVkKSkgKQorICAgICAgICAgcmV0dXJu
IC1FTk9ERVY7CisKICAgICAvKgogICAgICAqIHZtX2V2ZW50X3Jlc3VtZSgpIHJ1bnMgaW4gZWl0
aGVyIFhFTl9WTV9FVkVOVF8qIGRvbWN0bHMsIG9yCiAgICAgICogRVZUQ0hOX3NlbmQgY29udGV4
dCBmcm9tIHRoZSBpbnRyb3NwZWN0aW9uIGNvbnN1bWVyLiBCb3RoIGNvbnRleHRzCkBAIC0zODgs
MTMgKzM4OCwxMCBAQCBzdGF0aWMgaW50IHZtX2V2ZW50X3Jlc3VtZShzdHJ1Y3QgZG9tYWluICpk
LCBzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQpCiAgICAgICogYmVsb3csIHRoaXMgY292ZXJz
IHRoZSBjYXNlIHdoZXJlIHdlIHdvdWxkIG5lZWQgdG8gaXRlcmF0ZSBvdmVyIGFsbAogICAgICAq
IG9mIHRoZW0gbW9yZSBzdWNjaW50bHkuCiAgICAgICovCi0gICAgQVNTRVJUKGQgIT0gY3VycmVu
dC0+ZG9tYWluKTsKLQotICAgIGlmICggdW5saWtlbHkoIXZtX2V2ZW50X2NoZWNrKHZlZCkpICkK
LSAgICAgICAgIHJldHVybiAtRU5PREVWOworICAgIEFTU0VSVChpbXBsLT52ZWQuZCAhPSBjdXJy
ZW50LT5kb21haW4pOwogCiAgICAgLyogUHVsbCBhbGwgcmVzcG9uc2VzIG9mZiB0aGUgcmluZy4g
Ki8KLSAgICB3aGlsZSAoIHZtX2V2ZW50X2dldF9yZXNwb25zZShkLCB2ZWQsICZyc3ApICkKKyAg
ICB3aGlsZSAoIHZtX2V2ZW50X3JpbmdfZ2V0X3Jlc3BvbnNlKGltcGwsICZyc3ApICkKICAgICB7
CiAgICAgICAgIHN0cnVjdCB2Y3B1ICp2OwogCkBAIC00MDUsNyArNDAyLDcgQEAgc3RhdGljIGlu
dCB2bV9ldmVudF9yZXN1bWUoc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IHZtX2V2ZW50X2RvbWFp
biAqdmVkKQogICAgICAgICB9CiAKICAgICAgICAgLyogVmFsaWRhdGUgdGhlIHZjcHVfaWQgaW4g
dGhlIHJlc3BvbnNlLiAqLwotICAgICAgICB2ID0gZG9tYWluX3ZjcHUoZCwgcnNwLnZjcHVfaWQp
OworICAgICAgICB2ID0gZG9tYWluX3ZjcHUoaW1wbC0+dmVkLmQsIHJzcC52Y3B1X2lkKTsKICAg
ICAgICAgaWYgKCAhdiApCiAgICAgICAgICAgICBjb250aW51ZTsKIApAQCAtNDE5LDcgKzQxNiw3
IEBAIHN0YXRpYyBpbnQgdm1fZXZlbnRfcmVzdW1lKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCB2
bV9ldmVudF9kb21haW4gKnZlZCkKICAgICAgICAgewogI2lmZGVmIENPTkZJR19IQVNfTUVNX1BB
R0lORwogICAgICAgICAgICAgaWYgKCByc3AucmVhc29uID09IFZNX0VWRU5UX1JFQVNPTl9NRU1f
UEFHSU5HICkKLSAgICAgICAgICAgICAgICBwMm1fbWVtX3BhZ2luZ19yZXN1bWUoZCwgJnJzcCk7
CisgICAgICAgICAgICAgICAgcDJtX21lbV9wYWdpbmdfcmVzdW1lKGltcGwtPnZlZC5kLCAmcnNw
KTsKICNlbmRpZgogCiAgICAgICAgICAgICAvKgpAQCAtNDM5LDcgKzQzNiw3IEBAIHN0YXRpYyBp
bnQgdm1fZXZlbnRfcmVzdW1lKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCB2bV9ldmVudF9kb21h
aW4gKnZlZCkKICAgICAgICAgICAgICAqIENoZWNrIGluIGFyY2gtc3BlY2lmaWMgaGFuZGxlciB0
byBhdm9pZCBiaXRtYXNrIG92ZXJoZWFkIHdoZW4KICAgICAgICAgICAgICAqIG5vdCBzdXBwb3J0
ZWQuCiAgICAgICAgICAgICAgKi8KLSAgICAgICAgICAgIHZtX2V2ZW50X3RvZ2dsZV9zaW5nbGVz
dGVwKGQsIHYsICZyc3ApOworICAgICAgICAgICAgdm1fZXZlbnRfdG9nZ2xlX3NpbmdsZXN0ZXAo
aW1wbC0+dmVkLmQsIHYsICZyc3ApOwogCiAgICAgICAgICAgICAvKiBDaGVjayBmb3IgYWx0cDJt
IHN3aXRjaCAqLwogICAgICAgICAgICAgaWYgKCByc3AuZmxhZ3MgJiBWTV9FVkVOVF9GTEFHX0FM
VEVSTkFURV9QMk0gKQpAQCAtNDU5LDcyICs0NTYsNjkgQEAgc3RhdGljIGludCB2bV9ldmVudF9y
ZXN1bWUoc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQogICAg
IHJldHVybiAwOwogfQogCi12b2lkIHZtX2V2ZW50X2NhbmNlbF9zbG90KHN0cnVjdCB2bV9ldmVu
dF9kb21haW4gKnZlZCkKK3N0YXRpYyB2b2lkIHZtX2V2ZW50X3JpbmdfY2FuY2VsX3Nsb3Qoc3Ry
dWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQogewotICAgIGlmKCAhdm1fZXZlbnRfY2hlY2sodmVk
KSApCi0gICAgICAgIHJldHVybjsKLQogICAgIHNwaW5fbG9jaygmdmVkLT5sb2NrKTsKLSAgICB2
bV9ldmVudF9yZWxlYXNlX3Nsb3QodmVkKTsKKyAgICB2bV9ldmVudF9yaW5nX3JlbGVhc2Vfc2xv
dCh0b19yaW5nKHZlZCkpOwogICAgIHNwaW5fdW5sb2NrKCZ2ZWQtPmxvY2spOwogfQogCi1zdGF0
aWMgaW50IHZtX2V2ZW50X2dyYWJfc2xvdChzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQsIGlu
dCBmb3JlaWduKQorc3RhdGljIGludCB2bV9ldmVudF9yaW5nX2dyYWJfc2xvdChzdHJ1Y3Qgdm1f
ZXZlbnRfcmluZ19kb21haW4gKmltcGwsIGludCBmb3JlaWduKQogewogICAgIHVuc2lnbmVkIGlu
dCBhdmFpbF9yZXE7CiAgICAgaW50IHJjOwogCi0gICAgaWYgKCAhdmVkLT5yaW5nX3BhZ2UgKQor
ICAgIGlmICggIWltcGwtPnJpbmdfcGFnZSApCiAgICAgICAgIHJldHVybiAtRU9QTk9UU1VQUDsK
IAotICAgIHNwaW5fbG9jaygmdmVkLT5sb2NrKTsKKyAgICBzcGluX2xvY2soJmltcGwtPnZlZC5s
b2NrKTsKIAotICAgIGF2YWlsX3JlcSA9IHZtX2V2ZW50X3JpbmdfYXZhaWxhYmxlKHZlZCk7Cisg
ICAgYXZhaWxfcmVxID0gdm1fZXZlbnRfcmluZ19hdmFpbGFibGUoaW1wbCk7CiAKICAgICByYyA9
IC1FQlVTWTsKICAgICBpZiAoIGF2YWlsX3JlcSA9PSAwICkKICAgICAgICAgZ290byBvdXQ7CiAK
ICAgICBpZiAoICFmb3JlaWduICkKLSAgICAgICAgdmVkLT50YXJnZXRfcHJvZHVjZXJzKys7Cisg
ICAgICAgIGltcGwtPnRhcmdldF9wcm9kdWNlcnMrKzsKICAgICBlbHNlCi0gICAgICAgIHZlZC0+
Zm9yZWlnbl9wcm9kdWNlcnMrKzsKKyAgICAgICAgaW1wbC0+Zm9yZWlnbl9wcm9kdWNlcnMrKzsK
IAogICAgIHJjID0gMDsKIAogIG91dDoKLSAgICBzcGluX3VubG9jaygmdmVkLT5sb2NrKTsKKyAg
ICBzcGluX3VubG9jaygmaW1wbC0+dmVkLmxvY2spOwogCiAgICAgcmV0dXJuIHJjOwogfQogCiAv
KiBTaW1wbGUgdHJ5X2dyYWIgd3JhcHBlciBmb3IgdXNlIGluIHRoZSB3YWl0X2V2ZW50KCkgbWFj
cm8uICovCi1zdGF0aWMgaW50IHZtX2V2ZW50X3dhaXRfdHJ5X2dyYWIoc3RydWN0IHZtX2V2ZW50
X2RvbWFpbiAqdmVkLCBpbnQgKnJjKQorc3RhdGljIGludCB2bV9ldmVudF9yaW5nX3dhaXRfdHJ5
X2dyYWIoc3RydWN0IHZtX2V2ZW50X3JpbmdfZG9tYWluICppbXBsLCBpbnQgKnJjKQogewotICAg
ICpyYyA9IHZtX2V2ZW50X2dyYWJfc2xvdCh2ZWQsIDApOworICAgICpyYyA9IHZtX2V2ZW50X3Jp
bmdfZ3JhYl9zbG90KGltcGwsIDApOwogCiAgICAgcmV0dXJuICpyYzsKIH0KIAotLyogQ2FsbCB2
bV9ldmVudF9ncmFiX3Nsb3QoKSB1bnRpbCB0aGUgcmluZyBkb2Vzbid0IGV4aXN0LCBvciBpcyBh
dmFpbGFibGUuICovCi1zdGF0aWMgaW50IHZtX2V2ZW50X3dhaXRfc2xvdChzdHJ1Y3Qgdm1fZXZl
bnRfZG9tYWluICp2ZWQpCisvKiBDYWxsIHZtX2V2ZW50X3JpbmdfZ3JhYl9zbG90KCkgdW50aWwg
dGhlIHJpbmcgZG9lc24ndCBleGlzdCwgb3IgaXMgYXZhaWxhYmxlLiAqLworc3RhdGljIGludCB2
bV9ldmVudF9yaW5nX3dhaXRfc2xvdChzdHJ1Y3Qgdm1fZXZlbnRfcmluZ19kb21haW4gKmltcGwp
CiB7CiAgICAgaW50IHJjID0gLUVCVVNZOwogCi0gICAgd2FpdF9ldmVudCh2ZWQtPndxLCB2bV9l
dmVudF93YWl0X3RyeV9ncmFiKHZlZCwgJnJjKSAhPSAtRUJVU1kpOworICAgIHdhaXRfZXZlbnQo
aW1wbC0+d3EsIHZtX2V2ZW50X3Jpbmdfd2FpdF90cnlfZ3JhYihpbXBsLCAmcmMpICE9IC1FQlVT
WSk7CiAKICAgICByZXR1cm4gcmM7CiB9CiAKLWJvb2wgdm1fZXZlbnRfY2hlY2soc3RydWN0IHZt
X2V2ZW50X2RvbWFpbiAqdmVkKQorc3RhdGljIGJvb2wgdm1fZXZlbnRfcmluZ19jaGVjayhzdHJ1
Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQpCiB7Ci0gICAgcmV0dXJuIHZlZCAmJiB2ZWQtPnJpbmdf
cGFnZTsKKyAgICByZXR1cm4gdG9fcmluZyh2ZWQpLT5yaW5nX3BhZ2UgIT0gTlVMTDsKIH0KIAog
LyoKICAqIERldGVybWluZXMgd2hldGhlciBvciBub3QgdGhlIGN1cnJlbnQgdkNQVSBiZWxvbmdz
IHRvIHRoZSB0YXJnZXQgZG9tYWluLAogICogYW5kIGNhbGxzIHRoZSBhcHByb3ByaWF0ZSB3YWl0
IGZ1bmN0aW9uLiAgSWYgaXQgaXMgYSBndWVzdCB2Q1BVLCB0aGVuIHdlCi0gKiB1c2Ugdm1fZXZl
bnRfd2FpdF9zbG90KCkgdG8gcmVzZXJ2ZSBhIHNsb3QuICBBcyBsb25nIGFzIHRoZXJlIGlzIGEg
cmluZywKKyAqIHVzZSB2bV9ldmVudF9yaW5nX3dhaXRfc2xvdCgpIHRvIHJlc2VydmUgYSBzbG90
LiAgQXMgbG9uZyBhcyB0aGVyZSBpcyBhIHJpbmcsCiAgKiB0aGlzIGZ1bmN0aW9uIHdpbGwgYWx3
YXlzIHJldHVybiAwIGZvciBhIGd1ZXN0LiAgRm9yIGEgbm9uLWd1ZXN0LCB3ZSBjaGVjawogICog
Zm9yIHNwYWNlIGFuZCByZXR1cm4gLUVCVVNZIGlmIHRoZSByaW5nIGlzIG5vdCBhdmFpbGFibGUu
CiAgKgpAQCAtNTMzLDM2ICs1MjcsMzMgQEAgYm9vbCB2bV9ldmVudF9jaGVjayhzdHJ1Y3Qgdm1f
ZXZlbnRfZG9tYWluICp2ZWQpCiAgKiAgICAgICAgICAgICAgIDA6IGEgc3BvdCBoYXMgYmVlbiBy
ZXNlcnZlZAogICoKICAqLwotaW50IF9fdm1fZXZlbnRfY2xhaW1fc2xvdChzdHJ1Y3Qgdm1fZXZl
bnRfZG9tYWluICp2ZWQsIGJvb2wgYWxsb3dfc2xlZXApCitzdGF0aWMgaW50IHZtX2V2ZW50X3Jp
bmdfY2xhaW1fc2xvdChzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQsIGJvb2wgYWxsb3dfc2xl
ZXApCiB7Ci0gICAgaWYgKCAhdm1fZXZlbnRfY2hlY2sodmVkKSApCi0gICAgICAgIHJldHVybiAt
RU9QTk9UU1VQUDsKLQogICAgIGlmICggKGN1cnJlbnQtPmRvbWFpbiA9PSB2ZWQtPmQpICYmIGFs
bG93X3NsZWVwICkKLSAgICAgICAgcmV0dXJuIHZtX2V2ZW50X3dhaXRfc2xvdCh2ZWQpOworICAg
ICAgICByZXR1cm4gdm1fZXZlbnRfcmluZ193YWl0X3Nsb3QodG9fcmluZyh2ZWQpKTsKICAgICBl
bHNlCi0gICAgICAgIHJldHVybiB2bV9ldmVudF9ncmFiX3Nsb3QodmVkLCBjdXJyZW50LT5kb21h
aW4gIT0gdmVkLT5kKTsKKyAgICAgICAgcmV0dXJuIHZtX2V2ZW50X3JpbmdfZ3JhYl9zbG90KHRv
X3JpbmcodmVkKSwgY3VycmVudC0+ZG9tYWluICE9IHZlZC0+ZCk7CiB9CiAKICNpZmRlZiBDT05G
SUdfSEFTX01FTV9QQUdJTkcKIC8qIFJlZ2lzdGVyZWQgd2l0aCBYZW4tYm91bmQgZXZlbnQgY2hh
bm5lbCBmb3IgaW5jb21pbmcgbm90aWZpY2F0aW9ucy4gKi8KIHN0YXRpYyB2b2lkIG1lbV9wYWdp
bmdfbm90aWZpY2F0aW9uKHN0cnVjdCB2Y3B1ICp2LCB1bnNpZ25lZCBpbnQgcG9ydCkKIHsKLSAg
ICB2bV9ldmVudF9yZXN1bWUodi0+ZG9tYWluLCB2LT5kb21haW4tPnZtX2V2ZW50X3BhZ2luZyk7
CisgICAgdm1fZXZlbnRfcmluZ19yZXN1bWUodG9fcmluZyh2LT5kb21haW4tPnZtX2V2ZW50X3Bh
Z2luZykpOwogfQogI2VuZGlmCiAKIC8qIFJlZ2lzdGVyZWQgd2l0aCBYZW4tYm91bmQgZXZlbnQg
Y2hhbm5lbCBmb3IgaW5jb21pbmcgbm90aWZpY2F0aW9ucy4gKi8KIHN0YXRpYyB2b2lkIG1vbml0
b3Jfbm90aWZpY2F0aW9uKHN0cnVjdCB2Y3B1ICp2LCB1bnNpZ25lZCBpbnQgcG9ydCkKIHsKLSAg
ICB2bV9ldmVudF9yZXN1bWUodi0+ZG9tYWluLCB2LT5kb21haW4tPnZtX2V2ZW50X21vbml0b3Ip
OworICAgIHZtX2V2ZW50X3JpbmdfcmVzdW1lKHRvX3Jpbmcodi0+ZG9tYWluLT52bV9ldmVudF9t
b25pdG9yKSk7CiB9CiAKICNpZmRlZiBDT05GSUdfSEFTX01FTV9TSEFSSU5HCiAvKiBSZWdpc3Rl
cmVkIHdpdGggWGVuLWJvdW5kIGV2ZW50IGNoYW5uZWwgZm9yIGluY29taW5nIG5vdGlmaWNhdGlv
bnMuICovCiBzdGF0aWMgdm9pZCBtZW1fc2hhcmluZ19ub3RpZmljYXRpb24oc3RydWN0IHZjcHUg
KnYsIHVuc2lnbmVkIGludCBwb3J0KQogewotICAgIHZtX2V2ZW50X3Jlc3VtZSh2LT5kb21haW4s
IHYtPmRvbWFpbi0+dm1fZXZlbnRfc2hhcmUpOworICAgIHZtX2V2ZW50X3JpbmdfcmVzdW1lKHRv
X3Jpbmcodi0+ZG9tYWluLT52bV9ldmVudF9zaGFyZSkpOwogfQogI2VuZGlmCiAKQEAgLTU3MSwz
MiArNTYyLDMyIEBAIHZvaWQgdm1fZXZlbnRfY2xlYW51cChzdHJ1Y3QgZG9tYWluICpkKQogewog
I2lmZGVmIENPTkZJR19IQVNfTUVNX1BBR0lORwogICAgIGlmICggdm1fZXZlbnRfY2hlY2soZC0+
dm1fZXZlbnRfcGFnaW5nKSApCi0gICAgewotICAgICAgICAvKiBEZXN0cm95aW5nIHRoZSB3YWl0
IHF1ZXVlIGhlYWQgbWVhbnMgd2FraW5nIHVwIGFsbAotICAgICAgICAgKiBxdWV1ZWQgdmNwdXMu
IFRoaXMgd2lsbCBkcmFpbiB0aGUgbGlzdCwgYWxsb3dpbmcKLSAgICAgICAgICogdGhlIGRpc2Fi
bGUgcm91dGluZSB0byBjb21wbGV0ZS4gSXQgd2lsbCBhbHNvIGRyb3AKLSAgICAgICAgICogYWxs
IGRvbWFpbiByZWZzIHRoZSB3YWl0LXF1ZXVlZCB2Y3B1cyBhcmUgaG9sZGluZy4KLSAgICAgICAg
ICogRmluYWxseSwgYmVjYXVzZSB0aGlzIGNvZGUgcGF0aCBpbnZvbHZlcyBwcmV2aW91c2x5Ci0g
ICAgICAgICAqIHBhdXNpbmcgdGhlIGRvbWFpbiAoZG9tYWluX2tpbGwpLCB1bnBhdXNpbmcgdGhl
Ci0gICAgICAgICAqIHZjcHVzIGNhdXNlcyBubyBoYXJtLiAqLwotICAgICAgICBkZXN0cm95X3dh
aXRxdWV1ZV9oZWFkKCZkLT52bV9ldmVudF9wYWdpbmctPndxKTsKLSAgICAgICAgKHZvaWQpdm1f
ZXZlbnRfZGlzYWJsZShkLCAmZC0+dm1fZXZlbnRfcGFnaW5nKTsKLSAgICB9CisgICAgICAgIGQt
PnZtX2V2ZW50X3BhZ2luZy0+b3BzLT5jbGVhbnVwKCZkLT52bV9ldmVudF9wYWdpbmcpOwogI2Vu
ZGlmCisKICAgICBpZiAoIHZtX2V2ZW50X2NoZWNrKGQtPnZtX2V2ZW50X21vbml0b3IpICkKLSAg
ICB7Ci0gICAgICAgIGRlc3Ryb3lfd2FpdHF1ZXVlX2hlYWQoJmQtPnZtX2V2ZW50X21vbml0b3It
PndxKTsKLSAgICAgICAgKHZvaWQpdm1fZXZlbnRfZGlzYWJsZShkLCAmZC0+dm1fZXZlbnRfbW9u
aXRvcik7Ci0gICAgfQorICAgICAgICBkLT52bV9ldmVudF9tb25pdG9yLT5vcHMtPmNsZWFudXAo
JmQtPnZtX2V2ZW50X21vbml0b3IpOworCiAjaWZkZWYgQ09ORklHX0hBU19NRU1fU0hBUklORwog
ICAgIGlmICggdm1fZXZlbnRfY2hlY2soZC0+dm1fZXZlbnRfc2hhcmUpICkKLSAgICB7Ci0gICAg
ICAgIGRlc3Ryb3lfd2FpdHF1ZXVlX2hlYWQoJmQtPnZtX2V2ZW50X3NoYXJlLT53cSk7Ci0gICAg
ICAgICh2b2lkKXZtX2V2ZW50X2Rpc2FibGUoZCwgJmQtPnZtX2V2ZW50X3NoYXJlKTsKLSAgICB9
CisgICAgICAgIGQtPnZtX2V2ZW50X3NoYXJlLT5vcHMtPmNsZWFudXAoJmQtPnZtX2V2ZW50X3No
YXJlKTsKICNlbmRpZgogfQogCitzdGF0aWMgdm9pZCB2bV9ldmVudF9yaW5nX2NsZWFudXAoc3Ry
dWN0IHZtX2V2ZW50X2RvbWFpbiAqKl92ZWQpCit7CisgICAgc3RydWN0IHZtX2V2ZW50X3Jpbmdf
ZG9tYWluICppbXBsID0gdG9fcmluZygqX3ZlZCk7CisgICAgLyogRGVzdHJveWluZyB0aGUgd2Fp
dCBxdWV1ZSBoZWFkIG1lYW5zIHdha2luZyB1cCBhbGwKKyAgICAgKiBxdWV1ZWQgdmNwdXMuIFRo
aXMgd2lsbCBkcmFpbiB0aGUgbGlzdCwgYWxsb3dpbmcKKyAgICAgKiB0aGUgZGlzYWJsZSByb3V0
aW5lIHRvIGNvbXBsZXRlLiBJdCB3aWxsIGFsc28gZHJvcAorICAgICAqIGFsbCBkb21haW4gcmVm
cyB0aGUgd2FpdC1xdWV1ZWQgdmNwdXMgYXJlIGhvbGRpbmcuCisgICAgICogRmluYWxseSwgYmVj
YXVzZSB0aGlzIGNvZGUgcGF0aCBpbnZvbHZlcyBwcmV2aW91c2x5CisgICAgICogcGF1c2luZyB0
aGUgZG9tYWluIChkb21haW5fa2lsbCksIHVucGF1c2luZyB0aGUKKyAgICAgKiB2Y3B1cyBjYXVz
ZXMgbm8gaGFybS4gKi8KKyAgICBkZXN0cm95X3dhaXRxdWV1ZV9oZWFkKCZpbXBsLT53cSk7Cisg
ICAgKHZvaWQpdm1fZXZlbnRfcmluZ19kaXNhYmxlKF92ZWQpOworfQorCiBpbnQgdm1fZXZlbnRf
ZG9tY3RsKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCB4ZW5fZG9tY3RsX3ZtX2V2ZW50X29wICp2
ZWMpCiB7CiAgICAgaW50IHJjOwpAQCAtNjY2LDIzICs2NTcsMjIgQEAgaW50IHZtX2V2ZW50X2Rv
bWN0bChzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgeGVuX2RvbWN0bF92bV9ldmVudF9vcCAqdmVj
KQogICAgICAgICAgICAgICAgIGJyZWFrOwogCiAgICAgICAgICAgICAvKiBkb21haW5fcGF1c2Uo
KSBub3QgcmVxdWlyZWQgaGVyZSwgc2VlIFhTQS05OSAqLwotICAgICAgICAgICAgcmMgPSB2bV9l
dmVudF9lbmFibGUoZCwgdmVjLCAmZC0+dm1fZXZlbnRfcGFnaW5nLCBfVlBGX21lbV9wYWdpbmcs
CisgICAgICAgICAgICByYyA9IHZtX2V2ZW50X3JpbmdfZW5hYmxlKGQsIHZlYywgJmQtPnZtX2V2
ZW50X3BhZ2luZywgX1ZQRl9tZW1fcGFnaW5nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgSFZNX1BBUkFNX1BBR0lOR19SSU5HX1BGTiwKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIG1lbV9wYWdpbmdfbm90aWZpY2F0aW9uKTsKICAgICAgICAgfQogICAgICAgICBi
cmVhazsKIAogICAgICAgICBjYXNlIFhFTl9WTV9FVkVOVF9ESVNBQkxFOgotICAgICAgICAgICAg
aWYgKCB2bV9ldmVudF9jaGVjayhkLT52bV9ldmVudF9wYWdpbmcpICkKLSAgICAgICAgICAgIHsK
LSAgICAgICAgICAgICAgICBkb21haW5fcGF1c2UoZCk7Ci0gICAgICAgICAgICAgICAgcmMgPSB2
bV9ldmVudF9kaXNhYmxlKGQsICZkLT52bV9ldmVudF9wYWdpbmcpOwotICAgICAgICAgICAgICAg
IGRvbWFpbl91bnBhdXNlKGQpOwotICAgICAgICAgICAgfQorICAgICAgICAgICAgaWYgKCAhdm1f
ZXZlbnRfY2hlY2soZC0+dm1fZXZlbnRfcGFnaW5nKSApCisgICAgICAgICAgICAgICAgYnJlYWs7
CisgICAgICAgICAgICBkb21haW5fcGF1c2UoZCk7CisgICAgICAgICAgICByYyA9IHZtX2V2ZW50
X3JpbmdfZGlzYWJsZSgmZC0+dm1fZXZlbnRfcGFnaW5nKTsKKyAgICAgICAgICAgIGRvbWFpbl91
bnBhdXNlKGQpOwogICAgICAgICAgICAgYnJlYWs7CiAKICAgICAgICAgY2FzZSBYRU5fVk1fRVZF
TlRfUkVTVU1FOgotICAgICAgICAgICAgcmMgPSB2bV9ldmVudF9yZXN1bWUoZCwgZC0+dm1fZXZl
bnRfcGFnaW5nKTsKKyAgICAgICAgICAgIHJjID0gdm1fZXZlbnRfcmluZ19yZXN1bWUodG9fcmlu
ZyhkLT52bV9ldmVudF9wYWdpbmcpKTsKICAgICAgICAgICAgIGJyZWFrOwogCiAgICAgICAgIGRl
ZmF1bHQ6CkBAIC03MDQsMjMgKzY5NCwyMiBAQCBpbnQgdm1fZXZlbnRfZG9tY3RsKHN0cnVjdCBk
b21haW4gKmQsIHN0cnVjdCB4ZW5fZG9tY3RsX3ZtX2V2ZW50X29wICp2ZWMpCiAgICAgICAgICAg
ICByYyA9IGFyY2hfbW9uaXRvcl9pbml0X2RvbWFpbihkKTsKICAgICAgICAgICAgIGlmICggcmMg
KQogICAgICAgICAgICAgICAgIGJyZWFrOwotICAgICAgICAgICAgcmMgPSB2bV9ldmVudF9lbmFi
bGUoZCwgdmVjLCAmZC0+dm1fZXZlbnRfbW9uaXRvciwgX1ZQRl9tZW1fYWNjZXNzLAorICAgICAg
ICAgICAgcmMgPSB2bV9ldmVudF9yaW5nX2VuYWJsZShkLCB2ZWMsICZkLT52bV9ldmVudF9tb25p
dG9yLCBfVlBGX21lbV9hY2Nlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBI
Vk1fUEFSQU1fTU9OSVRPUl9SSU5HX1BGTiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIG1vbml0b3Jfbm90aWZpY2F0aW9uKTsKICAgICAgICAgICAgIGJyZWFrOwogCiAgICAgICAg
IGNhc2UgWEVOX1ZNX0VWRU5UX0RJU0FCTEU6Ci0gICAgICAgICAgICBpZiAoIHZtX2V2ZW50X2No
ZWNrKGQtPnZtX2V2ZW50X21vbml0b3IpICkKLSAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAg
ICBkb21haW5fcGF1c2UoZCk7Ci0gICAgICAgICAgICAgICAgcmMgPSB2bV9ldmVudF9kaXNhYmxl
KGQsICZkLT52bV9ldmVudF9tb25pdG9yKTsKLSAgICAgICAgICAgICAgICBhcmNoX21vbml0b3Jf
Y2xlYW51cF9kb21haW4oZCk7Ci0gICAgICAgICAgICAgICAgZG9tYWluX3VucGF1c2UoZCk7Ci0g
ICAgICAgICAgICB9CisgICAgICAgICAgICBpZiAoICF2bV9ldmVudF9jaGVjayhkLT52bV9ldmVu
dF9tb25pdG9yKSApCisgICAgICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICBkb21haW5f
cGF1c2UoZCk7CisgICAgICAgICAgICByYyA9IHZtX2V2ZW50X3JpbmdfZGlzYWJsZSgmZC0+dm1f
ZXZlbnRfbW9uaXRvcik7CisgICAgICAgICAgICBhcmNoX21vbml0b3JfY2xlYW51cF9kb21haW4o
ZCk7CisgICAgICAgICAgICBkb21haW5fdW5wYXVzZShkKTsKICAgICAgICAgICAgIGJyZWFrOwog
CiAgICAgICAgIGNhc2UgWEVOX1ZNX0VWRU5UX1JFU1VNRToKLSAgICAgICAgICAgIHJjID0gdm1f
ZXZlbnRfcmVzdW1lKGQsIGQtPnZtX2V2ZW50X21vbml0b3IpOworICAgICAgICAgICAgcmMgPSB2
bV9ldmVudF9yaW5nX3Jlc3VtZSh0b19yaW5nKGQtPnZtX2V2ZW50X21vbml0b3IpKTsKICAgICAg
ICAgICAgIGJyZWFrOwogCiAgICAgICAgIGRlZmF1bHQ6CkBAIC03NDksMjIgKzczOCwyMSBAQCBp
bnQgdm1fZXZlbnRfZG9tY3RsKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCB4ZW5fZG9tY3RsX3Zt
X2V2ZW50X29wICp2ZWMpCiAgICAgICAgICAgICAgICAgYnJlYWs7CiAKICAgICAgICAgICAgIC8q
IGRvbWFpbl9wYXVzZSgpIG5vdCByZXF1aXJlZCBoZXJlLCBzZWUgWFNBLTk5ICovCi0gICAgICAg
ICAgICByYyA9IHZtX2V2ZW50X2VuYWJsZShkLCB2ZWMsICZkLT52bV9ldmVudF9zaGFyZSwgX1ZQ
Rl9tZW1fc2hhcmluZywKKyAgICAgICAgICAgIHJjID0gdm1fZXZlbnRfcmluZ19lbmFibGUoZCwg
dmVjLCAmZC0+dm1fZXZlbnRfc2hhcmUsIF9WUEZfbWVtX3NoYXJpbmcsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBIVk1fUEFSQU1fU0hBUklOR19SSU5HX1BGTiwKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIG1lbV9zaGFyaW5nX25vdGlmaWNhdGlvbik7CiAgICAg
ICAgICAgICBicmVhazsKIAogICAgICAgICBjYXNlIFhFTl9WTV9FVkVOVF9ESVNBQkxFOgotICAg
ICAgICAgICAgaWYgKCB2bV9ldmVudF9jaGVjayhkLT52bV9ldmVudF9zaGFyZSkgKQotICAgICAg
ICAgICAgewotICAgICAgICAgICAgICAgIGRvbWFpbl9wYXVzZShkKTsKLSAgICAgICAgICAgICAg
ICByYyA9IHZtX2V2ZW50X2Rpc2FibGUoZCwgJmQtPnZtX2V2ZW50X3NoYXJlKTsKLSAgICAgICAg
ICAgICAgICBkb21haW5fdW5wYXVzZShkKTsKLSAgICAgICAgICAgIH0KKyAgICAgICAgICAgIGlm
ICggIXZtX2V2ZW50X2NoZWNrKGQtPnZtX2V2ZW50X3NoYXJlKSApCisgICAgICAgICAgICAgICAg
YnJlYWs7CisgICAgICAgICAgICBkb21haW5fcGF1c2UoZCk7CisgICAgICAgICAgICByYyA9IHZt
X2V2ZW50X3JpbmdfZGlzYWJsZSgmZC0+dm1fZXZlbnRfc2hhcmUpOworICAgICAgICAgICAgZG9t
YWluX3VucGF1c2UoZCk7CiAgICAgICAgICAgICBicmVhazsKIAogICAgICAgICBjYXNlIFhFTl9W
TV9FVkVOVF9SRVNVTUU6Ci0gICAgICAgICAgICByYyA9IHZtX2V2ZW50X3Jlc3VtZShkLCBkLT52
bV9ldmVudF9zaGFyZSk7CisgICAgICAgICAgICByYyA9IHZtX2V2ZW50X3JpbmdfcmVzdW1lKHRv
X3JpbmcoZC0+dm1fZXZlbnRfc2hhcmUpKTsKICAgICAgICAgICAgIGJyZWFrOwogCiAgICAgICAg
IGRlZmF1bHQ6CkBAIC04MTYsNiArODA0LDE0IEBAIHZvaWQgdm1fZXZlbnRfdmNwdV91bnBhdXNl
KHN0cnVjdCB2Y3B1ICp2KQogICAgIHZjcHVfdW5wYXVzZSh2KTsKIH0KIAorc3RhdGljIGNvbnN0
IHN0cnVjdCB2bV9ldmVudF9vcHMgdm1fZXZlbnRfcmluZ19vcHMgPSB7CisgICAgLmNoZWNrID0g
dm1fZXZlbnRfcmluZ19jaGVjaywKKyAgICAuY2xlYW51cCA9IHZtX2V2ZW50X3JpbmdfY2xlYW51
cCwKKyAgICAuY2xhaW1fc2xvdCA9IHZtX2V2ZW50X3JpbmdfY2xhaW1fc2xvdCwKKyAgICAuY2Fu
Y2VsX3Nsb3QgPSB2bV9ldmVudF9yaW5nX2NhbmNlbF9zbG90LAorICAgIC5wdXRfcmVxdWVzdCA9
IHZtX2V2ZW50X3JpbmdfcHV0X3JlcXVlc3QKK307CisKIC8qCiAgKiBMb2NhbCB2YXJpYWJsZXM6
CiAgKiBtb2RlOiBDCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS94ZW4vdm1fZXZlbnQuaCBiL3hl
bi9pbmNsdWRlL3hlbi92bV9ldmVudC5oCmluZGV4IGZmMzA5OTkuLjIxYTNmNTAgMTAwNjQ0Ci0t
LSBhL3hlbi9pbmNsdWRlL3hlbi92bV9ldmVudC5oCisrKyBiL3hlbi9pbmNsdWRlL3hlbi92bV9l
dmVudC5oCkBAIC0yMywxNCArMjMsNDMgQEAKICNpZm5kZWYgX19WTV9FVkVOVF9IX18KICNkZWZp
bmUgX19WTV9FVkVOVF9IX18KIAotI2luY2x1ZGUgPHhlbi9zY2hlZC5oPgorI2luY2x1ZGUgPHhl
bi9lcnJuby5oPgorI2luY2x1ZGUgPHhlbi9zcGlubG9jay5oPgorI2luY2x1ZGUgPHhlbi90eXBl
cy5oPgogI2luY2x1ZGUgPHB1YmxpYy92bV9ldmVudC5oPgogCitzdHJ1Y3QgZG9tYWluOworc3Ry
dWN0IHZtX2V2ZW50X2RvbWFpbjsKKworc3RydWN0IHZtX2V2ZW50X29wcworeworICAgIGJvb2wg
KCpjaGVjaykoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKTsKKyAgICB2b2lkICgqY2xlYW51
cCkoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqKl92ZWQpOworICAgIGludCAoKmNsYWltX3Nsb3Qp
KHN0cnVjdCB2bV9ldmVudF9kb21haW4gKnZlZCwgYm9vbCBhbGxvd19zbGVlcCk7CisgICAgdm9p
ZCAoKmNhbmNlbF9zbG90KShzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluICp2ZWQpOworICAgIHZvaWQg
KCpwdXRfcmVxdWVzdCkoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkLCB2bV9ldmVudF9yZXF1
ZXN0X3QgKnJlcSk7Cit9OworCitzdHJ1Y3Qgdm1fZXZlbnRfZG9tYWluCit7CisgICAgLyogRG9t
YWluIHJlZmVyZW5jZSAqLworICAgIHN0cnVjdCBkb21haW4gKmQ7CisKKyAgICAvKiB2bV9ldmVu
dF9vcHMgKi8KKyAgICBjb25zdCBzdHJ1Y3Qgdm1fZXZlbnRfb3BzICpvcHM7CisKKyAgICAvKiB2
bV9ldmVudCBkb21haW4gbG9jayAqLworICAgIHNwaW5sb2NrX3QgbG9jazsKK307CisKIC8qIENs
ZWFuIHVwIG9uIGRvbWFpbiBkZXN0cnVjdGlvbiAqLwogdm9pZCB2bV9ldmVudF9jbGVhbnVwKHN0
cnVjdCBkb21haW4gKmQpOwogCiAvKiBSZXR1cm5zIHdoZXRoZXIgdGhlIFZNIGV2ZW50IGRvbWFp
biBoYXMgYmVlbiBzZXQgdXAgKi8KLWJvb2wgdm1fZXZlbnRfY2hlY2soc3RydWN0IHZtX2V2ZW50
X2RvbWFpbiAqdmVkKTsKK3N0YXRpYyBpbmxpbmUgYm9vbCB2bV9ldmVudF9jaGVjayhzdHJ1Y3Qg
dm1fZXZlbnRfZG9tYWluICp2ZWQpCit7CisgICAgcmV0dXJuICh2ZWQpICYmIHZlZC0+b3BzLT5j
aGVjayh2ZWQpOworfQogCiAvKiBSZXR1cm5zIDAgb24gc3VjY2VzcywgLUVOT1NZUyBpZiB0aGVy
ZSBpcyBubyByaW5nLCAtRUJVU1kgaWYgdGhlcmUgaXMgbm8KICAqIGF2YWlsYWJsZSBzcGFjZSBh
bmQgdGhlIGNhbGxlciBpcyBhIGZvcmVpZ24gZG9tYWluLiBJZiB0aGUgZ3Vlc3QgaXRzZWxmCkBA
IC00NSw3ICs3NCwxNCBAQCBib29sIHZtX2V2ZW50X2NoZWNrKHN0cnVjdCB2bV9ldmVudF9kb21h
aW4gKnZlZCk7CiAgKiBjYW5jZWxfc2xvdCgpLCBib3RoIG9mIHdoaWNoIGFyZSBndWFyYW50ZWVk
IHRvCiAgKiBzdWNjZWVkLgogICovCi1pbnQgX192bV9ldmVudF9jbGFpbV9zbG90KHN0cnVjdCB2
bV9ldmVudF9kb21haW4gKnZlZCwgYm9vbCBhbGxvd19zbGVlcCk7CitzdGF0aWMgaW5saW5lIGlu
dCBfX3ZtX2V2ZW50X2NsYWltX3Nsb3Qoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkLCBib29s
IGFsbG93X3NsZWVwKQoreworICAgIGlmICggIXZtX2V2ZW50X2NoZWNrKHZlZCkgKQorICAgICAg
ICByZXR1cm4gLUVPUE5PVFNVUFA7CisKKyAgICByZXR1cm4gdmVkLT5vcHMtPmNsYWltX3Nsb3Qo
dmVkLCBhbGxvd19zbGVlcCk7Cit9CisKIHN0YXRpYyBpbmxpbmUgaW50IHZtX2V2ZW50X2NsYWlt
X3Nsb3Qoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVkKQogewogICAgIHJldHVybiBfX3ZtX2V2
ZW50X2NsYWltX3Nsb3QodmVkLCB0cnVlKTsKQEAgLTU2LDEwICs5MiwyMiBAQCBzdGF0aWMgaW5s
aW5lIGludCB2bV9ldmVudF9jbGFpbV9zbG90X25vc2xlZXAoc3RydWN0IHZtX2V2ZW50X2RvbWFp
biAqdmVkKQogICAgIHJldHVybiBfX3ZtX2V2ZW50X2NsYWltX3Nsb3QodmVkLCBmYWxzZSk7CiB9
CiAKLXZvaWQgdm1fZXZlbnRfY2FuY2VsX3Nsb3Qoc3RydWN0IHZtX2V2ZW50X2RvbWFpbiAqdmVk
KTsKK3N0YXRpYyBpbmxpbmUgdm9pZCB2bV9ldmVudF9jYW5jZWxfc2xvdChzdHJ1Y3Qgdm1fZXZl
bnRfZG9tYWluICp2ZWQpCit7CisgICAgaWYgKCAhdm1fZXZlbnRfY2hlY2sodmVkKSApCisgICAg
ICAgIHJldHVybjsKIAotdm9pZCB2bV9ldmVudF9wdXRfcmVxdWVzdChzdHJ1Y3Qgdm1fZXZlbnRf
ZG9tYWluICp2ZWQsCi0gICAgICAgICAgICAgICAgICAgICAgICAgIHZtX2V2ZW50X3JlcXVlc3Rf
dCAqcmVxKTsKKyAgICB2ZWQtPm9wcy0+Y2FuY2VsX3Nsb3QodmVkKTsKK30KKworc3RhdGljIGlu
bGluZSB2b2lkIHZtX2V2ZW50X3B1dF9yZXF1ZXN0KHN0cnVjdCB2bV9ldmVudF9kb21haW4gKnZl
ZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bV9ldmVudF9yZXF1
ZXN0X3QgKnJlcSkKK3sKKyAgICBpZiAoICF2bV9ldmVudF9jaGVjayh2ZWQpICkKKyAgICAgICAg
cmV0dXJuOworCisgICAgdmVkLT5vcHMtPnB1dF9yZXF1ZXN0KHZlZCwgcmVxKTsKK30KIAogaW50
IHZtX2V2ZW50X2RvbWN0bChzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgeGVuX2RvbWN0bF92bV9l
dmVudF9vcCAqdmVjKTsKIAotLSAKMi43LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0
cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlz
dGluZm8veGVuLWRldmVs

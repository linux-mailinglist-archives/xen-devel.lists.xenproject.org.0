Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id C3D361508B0
	for <lists+xen-devel@lfdr.de>; Mon,  3 Feb 2020 15:46:27 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iycx4-0006C5-Jj; Mon, 03 Feb 2020 14:43:50 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=ac3p=3X=citrix.com=andrew.cooper3@srs-us1.protection.inumbo.net>)
 id 1iycx2-0006Bh-MI
 for xen-devel@lists.xenproject.org; Mon, 03 Feb 2020 14:43:48 +0000
X-Inumbo-ID: 95b3aca8-4693-11ea-a933-bc764e2007e4
Received: from esa6.hc3370-68.iphmx.com (unknown [216.71.155.175])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 95b3aca8-4693-11ea-a933-bc764e2007e4;
 Mon, 03 Feb 2020 14:43:47 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1580741027;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=rzhlrZ6V5p5NSQFknGK68fglT5wG/u1QFxy5g2VbrtI=;
 b=e5USQzLBAPYQ4EHrj07WDCKVnmJsZtG0mXfpi0CaTo+q6CbgekeHWIn+
 AmkKlwBp7PSscUNwJ0OlhdK1x7KM7qGvahnzZDTvWsz1y7ON1PuDLMdg7
 uK3ezTYn7Sd+/sEKcOSarS7FClhEQbUWGm819Dk6QrEf3Bnp1J54sMWXp M=;
Authentication-Results: esa6.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=andrew.cooper3@citrix.com;
 spf=Pass smtp.mailfrom=Andrew.Cooper3@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa6.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 andrew.cooper3@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa6.hc3370-68.iphmx.com;
 envelope-from="Andrew.Cooper3@citrix.com";
 x-sender="andrew.cooper3@citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa6.hc3370-68.iphmx.com: domain of
 Andrew.Cooper3@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa6.hc3370-68.iphmx.com;
 envelope-from="Andrew.Cooper3@citrix.com";
 x-sender="Andrew.Cooper3@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83
 ip4:168.245.78.127 ~all"
Received-SPF: None (esa6.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa6.hc3370-68.iphmx.com;
 envelope-from="Andrew.Cooper3@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: Att/ZydR5zMLdmObFVHJXIAK1/YyKlZHCudrRw+l2dYYcRUmyVMtKyl22A6qkLt7W0Y1qMTodo
 sHSEkQBT2ND9Sf9sytTz1ZDrLIuhpbCw1+vUDkqh/H/pT4pTd466t2ma5t21Nz3EEyTuxFdySc
 CyDTDUaGYJ97aMN5nooijpgO1uG4ZXyfk2AFt3Iq7aREcI4EiOOzyTzeOjDfWA9gUp8pQ+iDCb
 aUj9kBa5caX0KJfPWfdhG4vnG5Ju03JX5cRCqMMlFGzoXsyW7MhnDPyDmsf+3fzMn88wiJsgtC
 3bk=
X-SBRS: 2.7
X-MesageID: 12285437
X-Ironport-Server: esa6.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.70,398,1574139600"; d="scan'208";a="12285437"
From: Andrew Cooper <andrew.cooper3@citrix.com>
To: Xen-devel <xen-devel@lists.xenproject.org>
Date: Mon, 3 Feb 2020 14:43:40 +0000
Message-ID: <20200203144340.4614-5-andrew.cooper3@citrix.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <20200203144340.4614-1-andrew.cooper3@citrix.com>
References: <20200203144340.4614-1-andrew.cooper3@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH 4/4] AMD/IOMMU: Treat head/tail pointers as byte
 offsets
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>, Wei Liu <wl@xen.org>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhlIE1NSU8gcmVnaXN0ZXJzIGFzIGFscmVhZHkgYnl0ZSBvZmZzZXRzLiAgVXNpbmcgdGhlbSBp
biB0aGlzIGZvcm0gcmVtb3Zlcwp0aGUgbmVlZCB0byBzaGlmdCB0aGVpciB2YWx1ZXMgZm9yIHVz
ZS4KCkl0IGlzIGFsc28gaW5lZmZpY2llbnQgdG8gc3RvcmUgYm90aCBlbnRyaWVzIGFuZCBhbGxv
Y19zaXplICh3aGljaCBkaWZmZXIgYnkgYQpmaXhlZCBlbnRyeV9zaXplKS4gIFJlbmFtZSBhbGxv
Y19zaXplIHRvIHNpemUsIGFuZCBkcm9wIGVudHJpZXMgZW50aXJlbHksCndoaWNoIHNpbXBsaWZp
ZXMgdGhlIGFsbG9jYXRpb24vZGVhbGxvY2F0aW9uIGhlbHBlcnMgc2xpZ2h0bHkuCgpNYXJrIHNl
bmRfaW9tbXVfY29tbWFuZCgpIGFuZCBpbnZhbGlkYXRlX2lvbW11X2FsbCgpIGFzIHN0YXRpYywg
YXMgdGhleSBoYXZlCm5vIGV4dGVybmFsIGRlY2xhcmF0aW9uIG9yIGNhbGxlcnMuCgpPdmVyYWxs
LCB0aGlzIHNpbXBsaWZpY2F0aW9uIGFsbG93cyBHQ0MgdG8gb3B0aW1pc2Ugc3VmZmljaWVudGx5
IHRvIGNvbnN0cnVjdApjb21tYW5kcyBkaXJlY3RseSBpbiB0aGUgY29tbWFuZCByaW5nLCByYXRo
ZXIgdGhhbiBvbiB0aGUgc3RhY2sgYW5kIGNvcHlpbmcKdGhlbSBpbnRvIHBsYWNlLgoKU2lnbmVk
LW9mZi1ieTogQW5kcmV3IENvb3BlciA8YW5kcmV3LmNvb3BlcjNAY2l0cml4LmNvbT4KLS0tCkND
OiBKYW4gQmV1bGljaCA8SkJldWxpY2hAc3VzZS5jb20+CkNDOiBXZWkgTGl1IDx3bEB4ZW4ub3Jn
PgpDQzogUm9nZXIgUGF1IE1vbm7DqSA8cm9nZXIucGF1QGNpdHJpeC5jb20+CgpUZXN0ZWQgb24g
YSBSb21lIHN5c3RlbS4KLS0tCiB4ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXUtZGVm
cy5oIHwgIDEgLQogeGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LmggICAgICB8IDE4
ICsrLS0tLS0tLS0tLS0tLS0tLQogeGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11X2Nt
ZC5jICB8IDIwICsrKysrKysrLS0tLS0tLS0tLS0tCiB4ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9h
bWQvaW9tbXVfaW5pdC5jIHwgMzAgKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tCiA0IGZp
bGVzIGNoYW5nZWQsIDIzIGluc2VydGlvbnMoKyksIDQ2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdp
dCBhL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdS1kZWZzLmggYi94ZW4vZHJpdmVy
cy9wYXNzdGhyb3VnaC9hbWQvaW9tbXUtZGVmcy5oCmluZGV4IDk2MzAwOWRlNmEuLjUwNjEzY2Ex
NTAgMTAwNjQ0Ci0tLSBhL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdS1kZWZzLmgK
KysrIGIveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LWRlZnMuaApAQCAtNDgxLDcg
KzQ4MSw2IEBAIHN0cnVjdCBhbWRfaW9tbXVfcHRlIHsKICNkZWZpbmUgSU5WX0lPTU1VX0FMTF9Q
QUdFU19BRERSRVNTICAgICAgKCgxVUxMIDw8IDYzKSAtIDEpCiAKICNkZWZpbmUgSU9NTVVfUklO
R19CVUZGRVJfUFRSX01BU0sgICAgICAgICAgICAgICAgICAweDAwMDdGRkYwCi0jZGVmaW5lIElP
TU1VX1JJTkdfQlVGRkVSX1BUUl9TSElGVCAgICAgICAgICAgICAgICAgNAogCiAjZGVmaW5lIElP
TU1VX0NNRF9ERVZJQ0VfSURfTUFTSyAgICAgICAgICAgICAgICAgICAgMHgwMDAwRkZGRgogI2Rl
ZmluZSBJT01NVV9DTURfREVWSUNFX0lEX1NISUZUICAgICAgICAgICAgICAgICAgIDAKZGlmZiAt
LWdpdCBhL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdS5oIGIveGVuL2RyaXZlcnMv
cGFzc3Rocm91Z2gvYW1kL2lvbW11LmgKaW5kZXggMGI1OThkMDZmOC4uMWFiZmRjNjg1YSAxMDA2
NDQKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LmgKKysrIGIveGVuL2Ry
aXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11LmgKQEAgLTU4LDEyICs1OCwxMSBAQCBzdHJ1Y3Qg
dGFibGVfc3RydWN0IHsKIH07CiAKIHN0cnVjdCByaW5nX2J1ZmZlciB7CisgICAgc3BpbmxvY2tf
dCBsb2NrOyAgICAvKiBwcm90ZWN0IGJ1ZmZlciBwb2ludGVycyAqLwogICAgIHZvaWQgKmJ1ZmZl
cjsKLSAgICB1bnNpZ25lZCBsb25nIGVudHJpZXM7Ci0gICAgdW5zaWduZWQgbG9uZyBhbGxvY19z
aXplOwogICAgIHVpbnQzMl90IHRhaWw7CiAgICAgdWludDMyX3QgaGVhZDsKLSAgICBzcGlubG9j
a190IGxvY2s7ICAgIC8qIHByb3RlY3QgYnVmZmVyIHBvaW50ZXJzICovCisgICAgdWludDMyX3Qg
c2l6ZTsKIH07CiAKIHR5cGVkZWYgc3RydWN0IGlvbW11X2NhcCB7CkBAIC0zNzksMTkgKzM3OCw2
IEBAIHN0YXRpYyBpbmxpbmUgaW50IGlvbW11X2hhc19jYXAoc3RydWN0IGFtZF9pb21tdSAqaW9t
bXUsIHVpbnQzMl90IGJpdCkKICAgICByZXR1cm4gISEoaW9tbXUtPmNhcC5oZWFkZXIgJiAoMXUg
PDwgYml0KSk7CiB9CiAKLS8qIGFjY2VzcyB0YWlsIG9yIGhlYWQgcG9pbnRlciBvZiByaW5nIGJ1
ZmZlciAqLwotc3RhdGljIGlubGluZSB1aW50MzJfdCBpb21tdV9nZXRfcmJfcG9pbnRlcih1aW50
MzJfdCByZWcpCi17Ci0gICAgcmV0dXJuIGdldF9maWVsZF9mcm9tX3JlZ191MzIocmVnLCBJT01N
VV9SSU5HX0JVRkZFUl9QVFJfTUFTSywKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBJT01NVV9SSU5HX0JVRkZFUl9QVFJfU0hJRlQpOwotfQotCi1zdGF0aWMgaW5saW5lIHZvaWQg
aW9tbXVfc2V0X3JiX3BvaW50ZXIodWludDMyX3QgKnJlZywgdWludDMyX3QgdmFsKQotewotICAg
IHNldF9maWVsZF9pbl9yZWdfdTMyKHZhbCwgKnJlZywgSU9NTVVfUklOR19CVUZGRVJfUFRSX01B
U0ssCi0gICAgICAgICAgICAgICAgICAgICAgICAgSU9NTVVfUklOR19CVUZGRVJfUFRSX1NISUZU
LCByZWcpOwotfQotCiAvKiBhY2Nlc3MgZGV2aWNlIGlkIGZpZWxkIGZyb20gaW9tbXUgY21kICov
CiBzdGF0aWMgaW5saW5lIHVpbnQxNl90IGlvbW11X2dldF9kZXZpZF9mcm9tX2NtZCh1aW50MzJf
dCBjbWQpCiB7CmRpZmYgLS1naXQgYS94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVf
Y21kLmMgYi94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfY21kLmMKaW5kZXggMTY2
ZjBlNzI2My4uMjRlZjU5ZDQzNiAxMDA2NDQKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gv
YW1kL2lvbW11X2NtZC5jCisrKyBiL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdV9j
bWQuYwpAQCAtMjQsMTYgKzI0LDE0IEBAIHN0YXRpYyBpbnQgcXVldWVfaW9tbXVfY29tbWFuZChz
dHJ1Y3QgYW1kX2lvbW11ICppb21tdSwgdTMyIGNtZFtdKQogewogICAgIHVpbnQzMl90IHRhaWws
IGhlYWQ7CiAKLSAgICB0YWlsID0gaW9tbXUtPmNtZF9idWZmZXIudGFpbDsKLSAgICBpZiAoICsr
dGFpbCA9PSBpb21tdS0+Y21kX2J1ZmZlci5lbnRyaWVzICkKKyAgICB0YWlsID0gaW9tbXUtPmNt
ZF9idWZmZXIudGFpbCArIElPTU1VX0NNRF9CVUZGRVJfRU5UUllfU0laRTsKKyAgICBpZiAoIHRh
aWwgPT0gaW9tbXUtPmNtZF9idWZmZXIuc2l6ZSApCiAgICAgICAgIHRhaWwgPSAwOwogCi0gICAg
aGVhZCA9IGlvbW11X2dldF9yYl9wb2ludGVyKHJlYWRsKGlvbW11LT5tbWlvX2Jhc2UgKwotICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJT01NVV9DTURfQlVGRkVSX0hFQURf
T0ZGU0VUKSk7CisgICAgaGVhZCA9IHJlYWRsKGlvbW11LT5tbWlvX2Jhc2UgKyBJT01NVV9DTURf
QlVGRkVSX0hFQURfT0ZGU0VUKTsKICAgICBpZiAoIGhlYWQgIT0gdGFpbCApCiAgICAgewotICAg
ICAgICBtZW1jcHkoaW9tbXUtPmNtZF9idWZmZXIuYnVmZmVyICsKLSAgICAgICAgICAgICAgIChp
b21tdS0+Y21kX2J1ZmZlci50YWlsICogSU9NTVVfQ01EX0JVRkZFUl9FTlRSWV9TSVpFKSwKKyAg
ICAgICAgbWVtY3B5KGlvbW11LT5jbWRfYnVmZmVyLmJ1ZmZlciArIGlvbW11LT5jbWRfYnVmZmVy
LnRhaWwsCiAgICAgICAgICAgICAgICBjbWQsIElPTU1VX0NNRF9CVUZGRVJfRU5UUllfU0laRSk7
CiAKICAgICAgICAgaW9tbXUtPmNtZF9idWZmZXIudGFpbCA9IHRhaWw7CkBAIC00NSwxMyArNDMs
MTEgQEAgc3RhdGljIGludCBxdWV1ZV9pb21tdV9jb21tYW5kKHN0cnVjdCBhbWRfaW9tbXUgKmlv
bW11LCB1MzIgY21kW10pCiAKIHN0YXRpYyB2b2lkIGNvbW1pdF9pb21tdV9jb21tYW5kX2J1ZmZl
cihzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSkKIHsKLSAgICB1MzIgdGFpbCA9IDA7Ci0KLSAgICBp
b21tdV9zZXRfcmJfcG9pbnRlcigmdGFpbCwgaW9tbXUtPmNtZF9idWZmZXIudGFpbCk7Ci0gICAg
d3JpdGVsKHRhaWwsIGlvbW11LT5tbWlvX2Jhc2UrSU9NTVVfQ01EX0JVRkZFUl9UQUlMX09GRlNF
VCk7CisgICAgd3JpdGVsKGlvbW11LT5jbWRfYnVmZmVyLnRhaWwsCisgICAgICAgICAgIGlvbW11
LT5tbWlvX2Jhc2UgKyBJT01NVV9DTURfQlVGRkVSX1RBSUxfT0ZGU0VUKTsKIH0KIAotaW50IHNl
bmRfaW9tbXVfY29tbWFuZChzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSwgdTMyIGNtZFtdKQorc3Rh
dGljIGludCBzZW5kX2lvbW11X2NvbW1hbmQoc3RydWN0IGFtZF9pb21tdSAqaW9tbXUsIHUzMiBj
bWRbXSkKIHsKICAgICBpZiAoIHF1ZXVlX2lvbW11X2NvbW1hbmQoaW9tbXUsIGNtZCkgKQogICAg
IHsKQEAgLTI2MSw3ICsyNTcsNyBAQCBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlX2ludGVycnVwdF90
YWJsZShzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSwgdTE2IGRldmljZV9pZCkKICAgICBzZW5kX2lv
bW11X2NvbW1hbmQoaW9tbXUsIGNtZCk7CiB9CiAKLXZvaWQgaW52YWxpZGF0ZV9pb21tdV9hbGwo
c3RydWN0IGFtZF9pb21tdSAqaW9tbXUpCitzdGF0aWMgdm9pZCBpbnZhbGlkYXRlX2lvbW11X2Fs
bChzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSkKIHsKICAgICB1MzIgY21kWzRdLCBlbnRyeTsKIApk
aWZmIC0tZ2l0IGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11X2luaXQuYyBiL3hl
bi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdV9pbml0LmMKaW5kZXggN2JmNmZlZjNlZS4u
Y2ZkZWVlZmMyZCAxMDA2NDQKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11
X2luaXQuYworKysgYi94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfaW5pdC5jCkBA
IC0xMTcsNyArMTE3LDcgQEAgc3RhdGljIHZvaWQgcmVnaXN0ZXJfaW9tbXVfY21kX2J1ZmZlcl9p
bl9tbWlvX3NwYWNlKHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11KQogICAgIGlvbW11X3NldF9hZGRy
X2xvX3RvX3JlZygmZW50cnksIGFkZHJfbG8gPj4gUEFHRV9TSElGVCk7CiAgICAgd3JpdGVsKGVu
dHJ5LCBpb21tdS0+bW1pb19iYXNlICsgSU9NTVVfQ01EX0JVRkZFUl9CQVNFX0xPV19PRkZTRVQp
OwogCi0gICAgcG93ZXJfb2YyX2VudHJpZXMgPSBnZXRfb3JkZXJfZnJvbV9ieXRlcyhpb21tdS0+
Y21kX2J1ZmZlci5hbGxvY19zaXplKSArCisgICAgcG93ZXJfb2YyX2VudHJpZXMgPSBnZXRfb3Jk
ZXJfZnJvbV9ieXRlcyhpb21tdS0+Y21kX2J1ZmZlci5zaXplKSArCiAgICAgICAgIElPTU1VX0NN
RF9CVUZGRVJfUE9XRVJfT0YyX0VOVFJJRVNfUEVSX1BBR0U7CiAKICAgICBlbnRyeSA9IDA7CkBA
IC0xNDUsNyArMTQ1LDcgQEAgc3RhdGljIHZvaWQgcmVnaXN0ZXJfaW9tbXVfZXZlbnRfbG9nX2lu
X21taW9fc3BhY2Uoc3RydWN0IGFtZF9pb21tdSAqaW9tbXUpCiAgICAgaW9tbXVfc2V0X2FkZHJf
bG9fdG9fcmVnKCZlbnRyeSwgYWRkcl9sbyA+PiBQQUdFX1NISUZUKTsKICAgICB3cml0ZWwoZW50
cnksIGlvbW11LT5tbWlvX2Jhc2UgKyBJT01NVV9FVkVOVF9MT0dfQkFTRV9MT1dfT0ZGU0VUKTsK
IAotICAgIHBvd2VyX29mMl9lbnRyaWVzID0gZ2V0X29yZGVyX2Zyb21fYnl0ZXMoaW9tbXUtPmV2
ZW50X2xvZy5hbGxvY19zaXplKSArCisgICAgcG93ZXJfb2YyX2VudHJpZXMgPSBnZXRfb3JkZXJf
ZnJvbV9ieXRlcyhpb21tdS0+ZXZlbnRfbG9nLnNpemUpICsKICAgICAgICAgICAgICAgICAgICAg
ICAgIElPTU1VX0VWRU5UX0xPR19QT1dFUl9PRjJfRU5UUklFU19QRVJfUEFHRTsKIAogICAgIGVu
dHJ5ID0gMDsKQEAgLTE3Myw3ICsxNzMsNyBAQCBzdGF0aWMgdm9pZCByZWdpc3Rlcl9pb21tdV9w
cHJfbG9nX2luX21taW9fc3BhY2Uoc3RydWN0IGFtZF9pb21tdSAqaW9tbXUpCiAgICAgaW9tbXVf
c2V0X2FkZHJfbG9fdG9fcmVnKCZlbnRyeSwgYWRkcl9sbyA+PiBQQUdFX1NISUZUKTsKICAgICB3
cml0ZWwoZW50cnksIGlvbW11LT5tbWlvX2Jhc2UgKyBJT01NVV9QUFJfTE9HX0JBU0VfTE9XX09G
RlNFVCk7CiAKLSAgICBwb3dlcl9vZjJfZW50cmllcyA9IGdldF9vcmRlcl9mcm9tX2J5dGVzKGlv
bW11LT5wcHJfbG9nLmFsbG9jX3NpemUpICsKKyAgICBwb3dlcl9vZjJfZW50cmllcyA9IGdldF9v
cmRlcl9mcm9tX2J5dGVzKGlvbW11LT5wcHJfbG9nLnNpemUpICsKICAgICAgICAgICAgICAgICAg
ICAgICAgIElPTU1VX1BQUl9MT0dfUE9XRVJfT0YyX0VOVFJJRVNfUEVSX1BBR0U7CiAKICAgICBl
bnRyeSA9IDA7CkBAIC0zMDAsNyArMzAwLDcgQEAgc3RhdGljIGludCBpb21tdV9yZWFkX2xvZyhz
dHJ1Y3QgYW1kX2lvbW11ICppb21tdSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWdu
ZWQgaW50IGVudHJ5X3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgKCpwYXJz
ZV9mdW5jKShzdHJ1Y3QgYW1kX2lvbW11ICosIHUzMiAqKSkKIHsKLSAgICB1MzIgdGFpbCwgaGVh
ZCwgKmVudHJ5LCB0YWlsX29mZmVzdCwgaGVhZF9vZmZzZXQ7CisgICAgdTMyIHRhaWwsICplbnRy
eSwgdGFpbF9vZmZlc3QsIGhlYWRfb2Zmc2V0OwogCiAgICAgQlVHX09OKCFpb21tdSB8fCAoKGxv
ZyAhPSAmaW9tbXUtPmV2ZW50X2xvZykgJiYgKGxvZyAhPSAmaW9tbXUtPnBwcl9sb2cpKSk7CiAg
ICAgCkBAIC0zMTYsMjIgKzMxNiwyMCBAQCBzdGF0aWMgaW50IGlvbW11X3JlYWRfbG9nKHN0cnVj
dCBhbWRfaW9tbXUgKmlvbW11LAogICAgICAgICBJT01NVV9QUFJfTE9HX0hFQURfT0ZGU0VUOwog
CiAgICAgdGFpbCA9IHJlYWRsKGlvbW11LT5tbWlvX2Jhc2UgKyB0YWlsX29mZmVzdCk7Ci0gICAg
dGFpbCA9IGlvbW11X2dldF9yYl9wb2ludGVyKHRhaWwpOwogCiAgICAgd2hpbGUgKCB0YWlsICE9
IGxvZy0+aGVhZCApCiAgICAgewogICAgICAgICAvKiByZWFkIGV2ZW50IGxvZyBlbnRyeSAqLwot
ICAgICAgICBlbnRyeSA9ICh1MzIgKikobG9nLT5idWZmZXIgKyBsb2ctPmhlYWQgKiBlbnRyeV9z
aXplKTsKKyAgICAgICAgZW50cnkgPSAodTMyICopKGxvZy0+YnVmZmVyICsgbG9nLT5oZWFkKTsK
IAogICAgICAgICBwYXJzZV9mdW5jKGlvbW11LCBlbnRyeSk7Ci0gICAgICAgIGlmICggKytsb2ct
PmhlYWQgPT0gbG9nLT5lbnRyaWVzICkKKworICAgICAgICBsb2ctPmhlYWQgKz0gZW50cnlfc2l6
ZTsKKyAgICAgICAgaWYgKCBsb2ctPmhlYWQgPT0gbG9nLT5zaXplICkKICAgICAgICAgICAgIGxv
Zy0+aGVhZCA9IDA7CiAKICAgICAgICAgLyogdXBkYXRlIGhlYWQgcG9pbnRlciAqLwotICAgICAg
ICBoZWFkID0gMDsKLSAgICAgICAgaW9tbXVfc2V0X3JiX3BvaW50ZXIoJmhlYWQsIGxvZy0+aGVh
ZCk7Ci0KLSAgICAgICAgd3JpdGVsKGhlYWQsIGlvbW11LT5tbWlvX2Jhc2UgKyBoZWFkX29mZnNl
dCk7CisgICAgICAgIHdyaXRlbChsb2ctPmhlYWQsIGlvbW11LT5tbWlvX2Jhc2UgKyBoZWFkX29m
ZnNldCk7CiAgICAgfQogCiAgICAgc3Bpbl91bmxvY2soJmxvZy0+bG9jayk7CkBAIC0xMDAxLDcg
Kzk5OSw3IEBAIHN0YXRpYyB2b2lkIF9faW5pdCBkZWFsbG9jYXRlX2J1ZmZlcih2b2lkICpidWYs
IHVuc2lnbmVkIGxvbmcgc3opCiAKIHN0YXRpYyB2b2lkIF9faW5pdCBkZWFsbG9jYXRlX3Jpbmdf
YnVmZmVyKHN0cnVjdCByaW5nX2J1ZmZlciAqcmluZ19idWYpCiB7Ci0gICAgZGVhbGxvY2F0ZV9i
dWZmZXIocmluZ19idWYtPmJ1ZmZlciwgcmluZ19idWYtPmFsbG9jX3NpemUpOworICAgIGRlYWxs
b2NhdGVfYnVmZmVyKHJpbmdfYnVmLT5idWZmZXIsIHJpbmdfYnVmLT5zaXplKTsKICAgICByaW5n
X2J1Zi0+YnVmZmVyID0gTlVMTDsKICAgICByaW5nX2J1Zi0+aGVhZCA9IDA7CiAgICAgcmluZ19i
dWYtPnRhaWwgPSAwOwpAQCAtMTAzNiwxMSArMTAzNCw5IEBAIHN0YXRpYyB2b2lkICpfX2luaXQg
YWxsb2NhdGVfcmluZ19idWZmZXIoc3RydWN0IHJpbmdfYnVmZmVyICpyaW5nX2J1ZiwKICAgICBy
aW5nX2J1Zi0+dGFpbCA9IDA7CiAKICAgICBzcGluX2xvY2tfaW5pdCgmcmluZ19idWYtPmxvY2sp
OwotICAgIAotICAgIHJpbmdfYnVmLT5hbGxvY19zaXplID0gUEFHRV9TSVpFIDw8IGdldF9vcmRl
cl9mcm9tX2J5dGVzKGVudHJpZXMgKgotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5X3NpemUpOwotICAgIHJpbmdfYnVmLT5l
bnRyaWVzID0gcmluZ19idWYtPmFsbG9jX3NpemUgLyBlbnRyeV9zaXplOwotICAgIHJpbmdfYnVm
LT5idWZmZXIgPSBhbGxvY2F0ZV9idWZmZXIocmluZ19idWYtPmFsbG9jX3NpemUsIG5hbWUsIGNs
ZWFyKTsKKworICAgIHJpbmdfYnVmLT5zaXplID0gUEFHRV9TSVpFIDw8IGdldF9vcmRlcl9mcm9t
X2J5dGVzKGVudHJpZXMgKiBlbnRyeV9zaXplKTsKKyAgICByaW5nX2J1Zi0+YnVmZmVyID0gYWxs
b2NhdGVfYnVmZmVyKHJpbmdfYnVmLT5zaXplLCBuYW1lLCBjbGVhcik7CiAKICAgICByZXR1cm4g
cmluZ19idWYtPmJ1ZmZlcjsKIH0KLS0gCjIuMTEuMAoKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVs
QGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1h
bi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 59B85C1AE6
	for <lists+xen-devel@lfdr.de>; Mon, 30 Sep 2019 07:24:01 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iEo8P-0002Bp-EU; Mon, 30 Sep 2019 05:22:09 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=hbFO=XZ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iEo8N-0002Aj-IA
 for xen-devel@lists.xenproject.org; Mon, 30 Sep 2019 05:22:07 +0000
X-Inumbo-ID: 31b6aa70-e342-11e9-96c8-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 31b6aa70-e342-11e9-96c8-12813bfff9fa;
 Mon, 30 Sep 2019 05:21:45 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 8191BB11F;
 Mon, 30 Sep 2019 05:21:43 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 30 Sep 2019 07:21:32 +0200
Message-Id: <20190930052135.11257-17-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190930052135.11257-1-jgross@suse.com>
References: <20190930052135.11257-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v5 16/19] xen/sched: support differing
 granularity in schedule_cpu_[add/rm]()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2l0aCBjb3JlIHNjaGVkdWxpbmcgYWN0aXZlIHNjaGVkdWxlX2NwdV9bYWRkL3JtXSgpIGhhcyB0
byBjb3BlIHdpdGgKZGlmZmVyZW50IHNjaGVkdWxpbmcgZ3JhbnVsYXJpdHk6IGEgY3B1IG5vdCBp
biBhbnkgY3B1cG9vbCBpcyBzdWJqZWN0CnRvIGdyYW51bGFyaXR5IDEgKGNwdSBzY2hlZHVsaW5n
KSwgd2hpbGUgYSBjcHUgaW4gYSBjcHVwb29sIG1pZ2h0IGJlCmluIGEgc2NoZWR1bGluZyByZXNv
dXJjZSB3aXRoIG1vcmUgdGhhbiBvbmUgY3B1LgoKSGFuZGxlIHRoYXQgYnkgaGF2aW5nIGFycmF5
cyBvZiBvbGQvbmV3IHBkYXRhIGFuZCB2ZGF0YSBhbmQgbG9vcCBvdmVyCnRob3NlIHdoZXJlIGFw
cHJvcHJpYXRlLgoKQWRkaXRpb25hbGx5IHRoZSBzY2hlZHVsaW5nIHJlc291cmNlKHMpIG11c3Qg
ZWl0aGVyIGJlIG1lcmdlZCBvcgpzcGxpdC4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3Mg
PGpncm9zc0BzdXNlLmNvbT4KUmV2aWV3ZWQtYnk6IERhcmlvIEZhZ2dpb2xpIDxkZmFnZ2lvbGlA
c3VzZS5jb20+Ci0tLQogeGVuL2NvbW1vbi9jcHVwb29sLmMgIHwgIDE4ICsrLS0KIHhlbi9jb21t
b24vc2NoZWR1bGUuYyB8IDIyNiArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrLS0tLS0tLQogMiBmaWxlcyBjaGFuZ2VkLCAyMDQgaW5zZXJ0aW9ucygrKSwgNDAgZGVs
ZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9jcHVwb29sLmMgYi94ZW4vY29tbW9u
L2NwdXBvb2wuYwppbmRleCAxM2RmZmFhZGNmLi4wNGMzYjNjMDRiIDEwMDY0NAotLS0gYS94ZW4v
Y29tbW9uL2NwdXBvb2wuYworKysgYi94ZW4vY29tbW9uL2NwdXBvb2wuYwpAQCAtNTM2LDYgKzUz
Niw3IEBAIHN0YXRpYyB2b2lkIGNwdXBvb2xfY3B1X3JlbW92ZSh1bnNpZ25lZCBpbnQgY3B1KQog
ICAgICAgICByZXQgPSBjcHVwb29sX3VuYXNzaWduX2NwdV9maW5pc2goY3B1cG9vbDApOwogICAg
ICAgICBCVUdfT04ocmV0KTsKICAgICB9CisgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1LCAmY3B1
cG9vbF9mcmVlX2NwdXMpOwogfQogCiAvKgpAQCAtNTg1LDIwICs1ODYsMTkgQEAgc3RhdGljIHZv
aWQgY3B1cG9vbF9jcHVfcmVtb3ZlX2ZvcmNlZCh1bnNpZ25lZCBpbnQgY3B1KQogICAgIHN0cnVj
dCBjcHVwb29sICoqYzsKICAgICBpbnQgcmV0OwogCi0gICAgaWYgKCBjcHVtYXNrX3Rlc3RfY3B1
KGNwdSwgJmNwdXBvb2xfZnJlZV9jcHVzKSApCi0gICAgICAgIGNwdW1hc2tfY2xlYXJfY3B1KGNw
dSwgJmNwdXBvb2xfZnJlZV9jcHVzKTsKLSAgICBlbHNlCisgICAgZm9yX2VhY2hfY3B1cG9vbCAo
IGMgKQogICAgIHsKLSAgICAgICAgZm9yX2VhY2hfY3B1cG9vbChjKQorICAgICAgICBpZiAoIGNw
dW1hc2tfdGVzdF9jcHUoY3B1LCAoKmMpLT5jcHVfdmFsaWQpICkKICAgICAgICAgewotICAgICAg
ICAgICAgaWYgKCBjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgKCpjKS0+Y3B1X3ZhbGlkKSApCi0gICAg
ICAgICAgICB7Ci0gICAgICAgICAgICAgICAgcmV0ID0gY3B1cG9vbF91bmFzc2lnbl9jcHUoKmMs
IGNwdSk7Ci0gICAgICAgICAgICAgICAgQlVHX09OKHJldCk7Ci0gICAgICAgICAgICB9CisgICAg
ICAgICAgICByZXQgPSBjcHVwb29sX3VuYXNzaWduX2NwdV9zdGFydCgqYywgY3B1KTsKKyAgICAg
ICAgICAgIEJVR19PTihyZXQpOworICAgICAgICAgICAgcmV0ID0gY3B1cG9vbF91bmFzc2lnbl9j
cHVfZmluaXNoKCpjKTsKKyAgICAgICAgICAgIEJVR19PTihyZXQpOwogICAgICAgICB9CiAgICAg
fQogCisgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1LCAmY3B1cG9vbF9mcmVlX2NwdXMpOworCiAg
ICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAgIHNjaGVkX3JtX2NwdShj
cHUpOwogICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwpkaWZmIC0tZ2l0
IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCmluZGV4IGVm
ZTA3N2IwMWYuLmU0MTFiNmQwM2UgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWR1bGUuYwor
KysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTQyNSwyNyArNDI1LDMwIEBAIHN0YXRpYyB2
b2lkIHNjaGVkX3VuaXRfYWRkX3ZjcHUoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsIHN0cnVjdCB2
Y3B1ICp2KQogICAgIHVuaXQtPnJ1bnN0YXRlX2NudFt2LT5ydW5zdGF0ZS5zdGF0ZV0rKzsKIH0K
IAotc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9hbGxvY191bml0KHN0cnVjdCB2Y3B1
ICp2KQorc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9hbGxvY191bml0X21lbSh2b2lk
KQogewotICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0LCAqKnByZXZfdW5pdDsKLSAgICBzdHJ1
Y3QgZG9tYWluICpkID0gdi0+ZG9tYWluOwotICAgIHVuc2lnbmVkIGludCBncmFuID0gY3B1cG9v
bF9nZXRfZ3JhbnVsYXJpdHkoZC0+Y3B1cG9vbCk7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVu
aXQ7CiAKLSAgICBmb3JfZWFjaF9zY2hlZF91bml0ICggZCwgdW5pdCApCi0gICAgICAgIGlmICgg
dW5pdC0+dW5pdF9pZCAvIGdyYW4gPT0gdi0+dmNwdV9pZCAvIGdyYW4gKQotICAgICAgICAgICAg
YnJlYWs7CisgICAgdW5pdCA9IHh6YWxsb2Moc3RydWN0IHNjaGVkX3VuaXQpOworICAgIGlmICgg
IXVuaXQgKQorICAgICAgICByZXR1cm4gTlVMTDsKIAotICAgIGlmICggdW5pdCApCisgICAgaWYg
KCAhemFsbG9jX2NwdW1hc2tfdmFyKCZ1bml0LT5jcHVfaGFyZF9hZmZpbml0eSkgfHwKKyAgICAg
ICAgICF6YWxsb2NfY3B1bWFza192YXIoJnVuaXQtPmNwdV9oYXJkX2FmZmluaXR5X3NhdmVkKSB8
fAorICAgICAgICAgIXphbGxvY19jcHVtYXNrX3ZhcigmdW5pdC0+Y3B1X3NvZnRfYWZmaW5pdHkp
ICkKICAgICB7Ci0gICAgICAgIHNjaGVkX3VuaXRfYWRkX3ZjcHUodW5pdCwgdik7Ci0gICAgICAg
IHJldHVybiB1bml0OworICAgICAgICBzY2hlZF9mcmVlX3VuaXRfbWVtKHVuaXQpOworICAgICAg
ICB1bml0ID0gTlVMTDsKICAgICB9CiAKLSAgICBpZiAoICh1bml0ID0geHphbGxvYyhzdHJ1Y3Qg
c2NoZWRfdW5pdCkpID09IE5VTEwgKQotICAgICAgICByZXR1cm4gTlVMTDsKKyAgICByZXR1cm4g
dW5pdDsKK30KKworc3RhdGljIHZvaWQgc2NoZWRfZG9tYWluX2luc2VydF91bml0KHN0cnVjdCBz
Y2hlZF91bml0ICp1bml0LCBzdHJ1Y3QgZG9tYWluICpkKQoreworICAgIHN0cnVjdCBzY2hlZF91
bml0ICoqcHJldl91bml0OwogCiAgICAgdW5pdC0+ZG9tYWluID0gZDsKLSAgICBzY2hlZF91bml0
X2FkZF92Y3B1KHVuaXQsIHYpOwogCiAgICAgZm9yICggcHJldl91bml0ID0gJmQtPnNjaGVkX3Vu
aXRfbGlzdDsgKnByZXZfdW5pdDsKICAgICAgICAgICBwcmV2X3VuaXQgPSAmKCpwcmV2X3VuaXQp
LT5uZXh0X2luX2xpc3QgKQpAQCAtNDU1LDE3ICs0NTgsMzEgQEAgc3RhdGljIHN0cnVjdCBzY2hl
ZF91bml0ICpzY2hlZF9hbGxvY191bml0KHN0cnVjdCB2Y3B1ICp2KQogCiAgICAgdW5pdC0+bmV4
dF9pbl9saXN0ID0gKnByZXZfdW5pdDsKICAgICAqcHJldl91bml0ID0gdW5pdDsKK30KIAotICAg
IGlmICggIXphbGxvY19jcHVtYXNrX3ZhcigmdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHkpIHx8Ci0g
ICAgICAgICAhemFsbG9jX2NwdW1hc2tfdmFyKCZ1bml0LT5jcHVfaGFyZF9hZmZpbml0eV9zYXZl
ZCkgfHwKLSAgICAgICAgICF6YWxsb2NfY3B1bWFza192YXIoJnVuaXQtPmNwdV9zb2Z0X2FmZmlu
aXR5KSApCi0gICAgICAgIGdvdG8gZmFpbDsKK3N0YXRpYyBzdHJ1Y3Qgc2NoZWRfdW5pdCAqc2No
ZWRfYWxsb2NfdW5pdChzdHJ1Y3QgdmNwdSAqdikKK3sKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAq
dW5pdDsKKyAgICBzdHJ1Y3QgZG9tYWluICpkID0gdi0+ZG9tYWluOworICAgIHVuc2lnbmVkIGlu
dCBncmFuID0gY3B1cG9vbF9nZXRfZ3JhbnVsYXJpdHkoZC0+Y3B1cG9vbCk7CiAKLSAgICByZXR1
cm4gdW5pdDsKKyAgICBmb3JfZWFjaF9zY2hlZF91bml0ICggZCwgdW5pdCApCisgICAgICAgIGlm
ICggdW5pdC0+dW5pdF9pZCAvIGdyYW4gPT0gdi0+dmNwdV9pZCAvIGdyYW4gKQorICAgICAgICAg
ICAgYnJlYWs7CiAKLSBmYWlsOgotICAgIHNjaGVkX2ZyZWVfdW5pdCh1bml0LCB2KTsKLSAgICBy
ZXR1cm4gTlVMTDsKKyAgICBpZiAoIHVuaXQgKQorICAgIHsKKyAgICAgICAgc2NoZWRfdW5pdF9h
ZGRfdmNwdSh1bml0LCB2KTsKKyAgICAgICAgcmV0dXJuIHVuaXQ7CisgICAgfQorCisgICAgaWYg
KCAodW5pdCA9IHNjaGVkX2FsbG9jX3VuaXRfbWVtKCkpID09IE5VTEwgKQorICAgICAgICByZXR1
cm4gTlVMTDsKKworICAgIHNjaGVkX3VuaXRfYWRkX3ZjcHUodW5pdCwgdik7CisgICAgc2NoZWRf
ZG9tYWluX2luc2VydF91bml0KHVuaXQsIGQpOworCisgICAgcmV0dXJuIHVuaXQ7CiB9CiAKIHN0
YXRpYyB1bnNpZ25lZCBpbnQgc2NoZWRfc2VsZWN0X2luaXRpYWxfY3B1KGNvbnN0IHN0cnVjdCB2
Y3B1ICp2KQpAQCAtMjQxOSwxOCArMjQzNiwyOCBAQCBzdGF0aWMgdm9pZCBwb2xsX3RpbWVyX2Zu
KHZvaWQgKmRhdGEpCiAgICAgICAgIHZjcHVfdW5ibG9jayh2KTsKIH0KIAotc3RhdGljIGludCBj
cHVfc2NoZWR1bGVfdXAodW5zaWduZWQgaW50IGNwdSkKK3N0YXRpYyBzdHJ1Y3Qgc2NoZWRfcmVz
b3VyY2UgKnNjaGVkX2FsbG9jX3Jlcyh2b2lkKQogewogICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJj
ZSAqc3I7CiAKICAgICBzciA9IHh6YWxsb2Moc3RydWN0IHNjaGVkX3Jlc291cmNlKTsKICAgICBp
ZiAoIHNyID09IE5VTEwgKQotICAgICAgICByZXR1cm4gLUVOT01FTTsKKyAgICAgICAgcmV0dXJu
IE5VTEw7CiAgICAgaWYgKCAhemFsbG9jX2NwdW1hc2tfdmFyKCZzci0+Y3B1cykgKQogICAgIHsK
ICAgICAgICAgeGZyZWUoc3IpOwotICAgICAgICByZXR1cm4gLUVOT01FTTsKKyAgICAgICAgcmV0
dXJuIE5VTEw7CiAgICAgfQorICAgIHJldHVybiBzcjsKK30KKworc3RhdGljIGludCBjcHVfc2No
ZWR1bGVfdXAodW5zaWduZWQgaW50IGNwdSkKK3sKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2Ug
KnNyOworCisgICAgc3IgPSBzY2hlZF9hbGxvY19yZXMoKTsKKyAgICBpZiAoIHNyID09IE5VTEwg
KQorICAgICAgICByZXR1cm4gLUVOT01FTTsKIAogICAgIHNyLT5tYXN0ZXJfY3B1ID0gY3B1Owog
ICAgIGNwdW1hc2tfY29weShzci0+Y3B1cywgY3B1bWFza19vZihjcHUpKTsKQEAgLTI0ODAsNiAr
MjUwNyw4IEBAIHN0YXRpYyB2b2lkIHNjaGVkX3Jlc19mcmVlKHN0cnVjdCByY3VfaGVhZCAqaGVh
ZCkKICAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyID0gY29udGFpbmVyX29mKGhlYWQsIHN0
cnVjdCBzY2hlZF9yZXNvdXJjZSwgcmN1KTsKIAogICAgIGZyZWVfY3B1bWFza192YXIoc3ItPmNw
dXMpOworICAgIGlmICggc3ItPnNjaGVkX3VuaXRfaWRsZSApCisgICAgICAgIHNjaGVkX2ZyZWVf
dW5pdF9tZW0oc3ItPnNjaGVkX3VuaXRfaWRsZSk7CiAgICAgeGZyZWUoc3IpOwogfQogCkBAIC0y
NDk2LDYgKzI1MjUsOCBAQCBzdGF0aWMgdm9pZCBjcHVfc2NoZWR1bGVfZG93bih1bnNpZ25lZCBp
bnQgY3B1KQogICAgIGNwdW1hc2tfY2xlYXJfY3B1KGNwdSwgJnNjaGVkX3Jlc19tYXNrKTsKICAg
ICBzZXRfc2NoZWRfcmVzKGNwdSwgTlVMTCk7CiAKKyAgICAvKiBLZWVwIGlkbGUgdW5pdC4gKi8K
KyAgICBzci0+c2NoZWRfdW5pdF9pZGxlID0gTlVMTDsKICAgICBjYWxsX3JjdSgmc3ItPnJjdSwg
c2NoZWRfcmVzX2ZyZWUpOwogCiAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9j
ayk7CkBAIC0yNTc1LDYgKzI2MDYsMzAgQEAgc3RhdGljIHN0cnVjdCBub3RpZmllcl9ibG9jayBj
cHVfc2NoZWR1bGVfbmZiID0gewogICAgIC5ub3RpZmllcl9jYWxsID0gY3B1X3NjaGVkdWxlX2Nh
bGxiYWNrCiB9OwogCitzdGF0aWMgY29uc3QgY3B1bWFza190ICpzY2hlZF9nZXRfb3B0X2NwdW1h
c2soZW51bSBzY2hlZF9ncmFuIG9wdCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgY3B1KQoreworICAgIGNvbnN0IGNwdW1hc2tfdCAq
bWFzazsKKworICAgIHN3aXRjaCAoIG9wdCApCisgICAgeworICAgIGNhc2UgU0NIRURfR1JBTl9j
cHU6CisgICAgICAgIG1hc2sgPSBjcHVtYXNrX29mKGNwdSk7CisgICAgICAgIGJyZWFrOworICAg
IGNhc2UgU0NIRURfR1JBTl9jb3JlOgorICAgICAgICBtYXNrID0gcGVyX2NwdShjcHVfc2libGlu
Z19tYXNrLCBjcHUpOworICAgICAgICBicmVhazsKKyAgICBjYXNlIFNDSEVEX0dSQU5fc29ja2V0
OgorICAgICAgICBtYXNrID0gcGVyX2NwdShjcHVfY29yZV9tYXNrLCBjcHUpOworICAgICAgICBi
cmVhazsKKyAgICBkZWZhdWx0OgorICAgICAgICBBU1NFUlRfVU5SRUFDSEFCTEUoKTsKKyAgICAg
ICAgcmV0dXJuIE5VTEw7CisgICAgfQorCisgICAgcmV0dXJuIG1hc2s7Cit9CisKIC8qIEluaXRp
YWxpc2UgdGhlIGRhdGEgc3RydWN0dXJlcy4gKi8KIHZvaWQgX19pbml0IHNjaGVkdWxlcl9pbml0
KHZvaWQpCiB7CkBAIC0yNzMwLDYgKzI3ODUsNDYgQEAgaW50IHNjaGVkdWxlX2NwdV9hZGQodW5z
aWduZWQgaW50IGNwdSwgc3RydWN0IGNwdXBvb2wgKmMpCiAgICAgICovCiAgICAgb2xkX2xvY2sg
PSBwY3B1X3NjaGVkdWxlX2xvY2tfaXJxc2F2ZShjcHUsICZmbGFncyk7CiAKKyAgICBpZiAoIGNw
dXBvb2xfZ2V0X2dyYW51bGFyaXR5KGMpID4gMSApCisgICAgeworICAgICAgICBjb25zdCBjcHVt
YXNrX3QgKm1hc2s7CisgICAgICAgIHVuc2lnbmVkIGludCBjcHVfaXRlciwgaWR4ID0gMDsKKyAg
ICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKm9sZF91bml0LCAqbWFzdGVyX3VuaXQ7CisgICAgICAg
IHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3Jfb2xkOworCisgICAgICAgIC8qCisgICAgICAgICAq
IFdlIG5lZWQgdG8gbWVyZ2UgbXVsdGlwbGUgaWRsZV92Y3B1IHVuaXRzIGFuZCBzY2hlZF9yZXNv
dXJjZSBzdHJ1Y3RzCisgICAgICAgICAqIGludG8gb25lLiBBcyB0aGUgZnJlZSBjcHVzIGFsbCBz
aGFyZSB0aGUgc2FtZSBsb2NrIHdlIGFyZSBmaW5lIGRvaW5nCisgICAgICAgICAqIHRoYXQgbm93
LiBUaGUgd29yc3Qgd2hpY2ggY291bGQgaGFwcGVuIHdvdWxkIGJlIHNvbWVvbmUgd2FpdGluZyBm
b3IKKyAgICAgICAgICogdGhlIGxvY2ssIHRodXMgZGVyZWZlcmVuY2luZyBzY2hlZF9yZXMtPnNj
aGVkdWxlX2xvY2suIFRoaXMgaXMgdGhlCisgICAgICAgICAqIHJlYXNvbiB3ZSBhcmUgZnJlZWlu
ZyBzdHJ1Y3Qgc2NoZWRfcmVzIHZpYSBjYWxsX3JjdSgpIHRvIGF2b2lkIHRoZQorICAgICAgICAg
KiBsb2NrIHBvaW50ZXIgc3VkZGVubHkgZGlzYXBwZWFyaW5nLgorICAgICAgICAgKi8KKyAgICAg
ICAgbWFzayA9IHNjaGVkX2dldF9vcHRfY3B1bWFzayhjLT5ncmFuLCBjcHUpOworICAgICAgICBt
YXN0ZXJfdW5pdCA9IGlkbGVfdmNwdVtjcHVdLT5zY2hlZF91bml0OworCisgICAgICAgIGZvcl9l
YWNoX2NwdSAoIGNwdV9pdGVyLCBtYXNrICkKKyAgICAgICAgeworICAgICAgICAgICAgaWYgKCBp
ZHggKQorICAgICAgICAgICAgICAgIGNwdW1hc2tfY2xlYXJfY3B1KGNwdV9pdGVyLCAmc2NoZWRf
cmVzX21hc2spOworCisgICAgICAgICAgICBwZXJfY3B1KHNjaGVkX3Jlc19pZHgsIGNwdV9pdGVy
KSA9IGlkeCsrOworCisgICAgICAgICAgICBpZiAoIGNwdSA9PSBjcHVfaXRlciApCisgICAgICAg
ICAgICAgICAgY29udGludWU7CisKKyAgICAgICAgICAgIG9sZF91bml0ID0gaWRsZV92Y3B1W2Nw
dV9pdGVyXS0+c2NoZWRfdW5pdDsKKyAgICAgICAgICAgIHNyX29sZCA9IGdldF9zY2hlZF9yZXMo
Y3B1X2l0ZXIpOworICAgICAgICAgICAga2lsbF90aW1lcigmc3Jfb2xkLT5zX3RpbWVyKTsKKyAg
ICAgICAgICAgIGlkbGVfdmNwdVtjcHVfaXRlcl0tPnNjaGVkX3VuaXQgPSBtYXN0ZXJfdW5pdDsK
KyAgICAgICAgICAgIG1hc3Rlcl91bml0LT5ydW5zdGF0ZV9jbnRbUlVOU1RBVEVfcnVubmluZ10r
KzsKKyAgICAgICAgICAgIHNldF9zY2hlZF9yZXMoY3B1X2l0ZXIsIHNyKTsKKyAgICAgICAgICAg
IGNwdW1hc2tfc2V0X2NwdShjcHVfaXRlciwgc3ItPmNwdXMpOworCisgICAgICAgICAgICBjYWxs
X3JjdSgmc3Jfb2xkLT5yY3UsIHNjaGVkX3Jlc19mcmVlKTsKKyAgICAgICAgfQorICAgIH0KKwog
ICAgIG5ld19sb2NrID0gc2NoZWRfc3dpdGNoX3NjaGVkKG5ld19vcHMsIGNwdSwgcHByaXYsIHZw
cml2KTsKIAogICAgIHNyLT5zY2hlZHVsZXIgPSBuZXdfb3BzOwpAQCAtMjc2NywzMyArMjg2Miwx
MDAgQEAgb3V0OgogICovCiBpbnQgc2NoZWR1bGVfY3B1X3JtKHVuc2lnbmVkIGludCBjcHUpCiB7
Ci0gICAgc3RydWN0IHZjcHUgKmlkbGU7CiAgICAgdm9pZCAqcHByaXZfb2xkLCAqdnByaXZfb2xk
OwotICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3I7CisgICAgc3RydWN0IHNjaGVkX3Jlc291
cmNlICpzciwgKipzcl9uZXcgPSBOVUxMOworICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0Owog
ICAgIHN0cnVjdCBzY2hlZHVsZXIgKm9sZF9vcHM7CiAgICAgc3BpbmxvY2tfdCAqb2xkX2xvY2s7
CiAgICAgdW5zaWduZWQgbG9uZyBmbGFnczsKKyAgICBpbnQgaWR4LCByZXQgPSAtRU5PTUVNOwor
ICAgIHVuc2lnbmVkIGludCBjcHVfaXRlcjsKIAogICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jl
c19yY3Vsb2NrKTsKIAogICAgIHNyID0gZ2V0X3NjaGVkX3JlcyhjcHUpOwogICAgIG9sZF9vcHMg
PSBzci0+c2NoZWR1bGVyOwogCisgICAgaWYgKCBzci0+Z3JhbnVsYXJpdHkgPiAxICkKKyAgICB7
CisgICAgICAgIHNyX25ldyA9IHhtYWxsb2NfYXJyYXkoc3RydWN0IHNjaGVkX3Jlc291cmNlICos
IHNyLT5ncmFudWxhcml0eSAtIDEpOworICAgICAgICBpZiAoICFzcl9uZXcgKQorICAgICAgICAg
ICAgZ290byBvdXQ7CisgICAgICAgIGZvciAoIGlkeCA9IDA7IGlkeCA8IHNyLT5ncmFudWxhcml0
eSAtIDE7IGlkeCsrICkKKyAgICAgICAgeworICAgICAgICAgICAgc3JfbmV3W2lkeF0gPSBzY2hl
ZF9hbGxvY19yZXMoKTsKKyAgICAgICAgICAgIGlmICggc3JfbmV3W2lkeF0gKQorICAgICAgICAg
ICAgeworICAgICAgICAgICAgICAgIHNyX25ld1tpZHhdLT5zY2hlZF91bml0X2lkbGUgPSBzY2hl
ZF9hbGxvY191bml0X21lbSgpOworICAgICAgICAgICAgICAgIGlmICggIXNyX25ld1tpZHhdLT5z
Y2hlZF91bml0X2lkbGUgKQorICAgICAgICAgICAgICAgIHsKKyAgICAgICAgICAgICAgICAgICAg
c2NoZWRfcmVzX2ZyZWUoJnNyX25ld1tpZHhdLT5yY3UpOworICAgICAgICAgICAgICAgICAgICBz
cl9uZXdbaWR4XSA9IE5VTEw7CisgICAgICAgICAgICAgICAgfQorICAgICAgICAgICAgfQorICAg
ICAgICAgICAgaWYgKCAhc3JfbmV3W2lkeF0gKQorICAgICAgICAgICAgeworICAgICAgICAgICAg
ICAgIGZvciAoIGlkeC0tOyBpZHggPj0gMDsgaWR4LS0gKQorICAgICAgICAgICAgICAgICAgICBz
Y2hlZF9yZXNfZnJlZSgmc3JfbmV3W2lkeF0tPnJjdSk7CisgICAgICAgICAgICAgICAgZ290byBv
dXQ7CisgICAgICAgICAgICB9CisgICAgICAgICAgICBzcl9uZXdbaWR4XS0+Y3VyciA9IHNyX25l
d1tpZHhdLT5zY2hlZF91bml0X2lkbGU7CisgICAgICAgICAgICBzcl9uZXdbaWR4XS0+c2NoZWR1
bGVyID0gJnNjaGVkX2lkbGVfb3BzOworICAgICAgICAgICAgc3JfbmV3W2lkeF0tPmdyYW51bGFy
aXR5ID0gMTsKKworICAgICAgICAgICAgLyogV2Ugd2FudCB0aGUgbG9jayBub3QgdG8gY2hhbmdl
IHdoZW4gcmVwbGFjaW5nIHRoZSByZXNvdXJjZS4gKi8KKyAgICAgICAgICAgIHNyX25ld1tpZHhd
LT5zY2hlZHVsZV9sb2NrID0gc3ItPnNjaGVkdWxlX2xvY2s7CisgICAgICAgIH0KKyAgICB9CisK
KyAgICByZXQgPSAwOwogICAgIEFTU0VSVChzci0+Y3B1cG9vbCAhPSBOVUxMKTsKICAgICBBU1NF
UlQoY3B1bWFza190ZXN0X2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1cykpOwogICAgIEFTU0VS
VCghY3B1bWFza190ZXN0X2NwdShjcHUsIHNyLT5jcHVwb29sLT5jcHVfdmFsaWQpKTsKIAotICAg
IGlkbGUgPSBpZGxlX3ZjcHVbY3B1XTsKLQogICAgIHNjaGVkX2RvX3RpY2tfc3VzcGVuZChvbGRf
b3BzLCBjcHUpOwogCiAgICAgLyogU2VlIGNvbW1lbnQgaW4gc2NoZWR1bGVfY3B1X2FkZCgpIHJl
Z2FyZGluZyBsb2NrIHN3aXRjaGluZy4gKi8KICAgICBvbGRfbG9jayA9IHBjcHVfc2NoZWR1bGVf
bG9ja19pcnFzYXZlKGNwdSwgJmZsYWdzKTsKIAotICAgIHZwcml2X29sZCA9IGlkbGUtPnNjaGVk
X3VuaXQtPnByaXY7CisgICAgdnByaXZfb2xkID0gaWRsZV92Y3B1W2NwdV0tPnNjaGVkX3VuaXQt
PnByaXY7CiAgICAgcHByaXZfb2xkID0gc3ItPnNjaGVkX3ByaXY7CiAKLSAgICBpZGxlLT5zY2hl
ZF91bml0LT5wcml2ID0gTlVMTDsKKyAgICBpZHggPSAwOworICAgIGZvcl9lYWNoX2NwdSAoIGNw
dV9pdGVyLCBzci0+Y3B1cyApCisgICAgeworICAgICAgICBwZXJfY3B1KHNjaGVkX3Jlc19pZHgs
IGNwdV9pdGVyKSA9IDA7CisgICAgICAgIGlmICggY3B1X2l0ZXIgPT0gY3B1ICkKKyAgICAgICAg
eworICAgICAgICAgICAgaWRsZV92Y3B1W2NwdV9pdGVyXS0+c2NoZWRfdW5pdC0+cHJpdiA9IE5V
TEw7CisgICAgICAgIH0KKyAgICAgICAgZWxzZQorICAgICAgICB7CisgICAgICAgICAgICAvKiBJ
bml0aWFsaXplIHVuaXQuICovCisgICAgICAgICAgICB1bml0ID0gc3JfbmV3W2lkeF0tPnNjaGVk
X3VuaXRfaWRsZTsKKyAgICAgICAgICAgIHVuaXQtPnJlcyA9IHNyX25ld1tpZHhdOworICAgICAg
ICAgICAgdW5pdC0+aXNfcnVubmluZyA9IHRydWU7CisgICAgICAgICAgICBzY2hlZF91bml0X2Fk
ZF92Y3B1KHVuaXQsIGlkbGVfdmNwdVtjcHVfaXRlcl0pOworICAgICAgICAgICAgc2NoZWRfZG9t
YWluX2luc2VydF91bml0KHVuaXQsIGlkbGVfdmNwdVtjcHVfaXRlcl0tPmRvbWFpbik7CisKKyAg
ICAgICAgICAgIC8qIEFkanVzdCBjcHUgbWFza3Mgb2YgcmVzb3VyY2VzIChvbGQgYW5kIG5ldyku
ICovCisgICAgICAgICAgICBjcHVtYXNrX2NsZWFyX2NwdShjcHVfaXRlciwgc3ItPmNwdXMpOwor
ICAgICAgICAgICAgY3B1bWFza19zZXRfY3B1KGNwdV9pdGVyLCBzcl9uZXdbaWR4XS0+Y3B1cyk7
CisKKyAgICAgICAgICAgIC8qIEluaXQgdGltZXIuICovCisgICAgICAgICAgICBpbml0X3RpbWVy
KCZzcl9uZXdbaWR4XS0+c190aW1lciwgc190aW1lcl9mbiwgTlVMTCwgY3B1X2l0ZXIpOworCisg
ICAgICAgICAgICAvKiBMYXN0IHJlc291cmNlIGluaXRpYWxpemF0aW9ucyBhbmQgaW5zZXJ0IHJl
c291cmNlIHBvaW50ZXIuICovCisgICAgICAgICAgICBzcl9uZXdbaWR4XS0+bWFzdGVyX2NwdSA9
IGNwdV9pdGVyOworICAgICAgICAgICAgc2V0X3NjaGVkX3JlcyhjcHVfaXRlciwgc3JfbmV3W2lk
eF0pOworCisgICAgICAgICAgICAvKiBMYXN0IGFjdGlvbjogc2V0IHRoZSBuZXcgbG9jayBwb2lu
dGVyLiAqLworICAgICAgICAgICAgc21wX21iKCk7CisgICAgICAgICAgICBzcl9uZXdbaWR4XS0+
c2NoZWR1bGVfbG9jayA9ICZzY2hlZF9mcmVlX2NwdV9sb2NrOworCisgICAgICAgICAgICBpZHgr
KzsKKyAgICAgICAgfQorICAgIH0KICAgICBzci0+c2NoZWR1bGVyID0gJnNjaGVkX2lkbGVfb3Bz
OwogICAgIHNyLT5zY2hlZF9wcml2ID0gTlVMTDsKIApAQCAtMjgxMSw5ICsyOTczLDExIEBAIGlu
dCBzY2hlZHVsZV9jcHVfcm0odW5zaWduZWQgaW50IGNwdSkKICAgICBzci0+Z3JhbnVsYXJpdHkg
PSAxOwogICAgIHNyLT5jcHVwb29sID0gTlVMTDsKIAorb3V0OgogICAgIHJjdV9yZWFkX3VubG9j
aygmc2NoZWRfcmVzX3JjdWxvY2spOworICAgIHhmcmVlKHNyX25ldyk7CiAKLSAgICByZXR1cm4g
MDsKKyAgICByZXR1cm4gcmV0OwogfQogCiBzdHJ1Y3Qgc2NoZWR1bGVyICpzY2hlZHVsZXJfZ2V0
X2RlZmF1bHQodm9pZCkKLS0gCjIuMTYuNAoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3Rz
LnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0
aW5mby94ZW4tZGV2ZWw=

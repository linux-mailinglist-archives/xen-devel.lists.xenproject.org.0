Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id A245BC8BAD
	for <lists+xen-devel@lfdr.de>; Wed,  2 Oct 2019 16:46:36 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iFfqt-0001zc-8b; Wed, 02 Oct 2019 14:43:39 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=lglc=X3=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iFfqr-0001zX-O8
 for xen-devel@lists.xenproject.org; Wed, 02 Oct 2019 14:43:37 +0000
X-Inumbo-ID: 0333231c-e523-11e9-9718-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 0333231c-e523-11e9-9718-12813bfff9fa;
 Wed, 02 Oct 2019 14:43:35 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 67157ABBE;
 Wed,  2 Oct 2019 14:43:33 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Wed,  2 Oct 2019 16:43:30 +0200
Message-Id: <20191002144330.21392-1-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
Subject: [Xen-devel] [PATCH v6.1 08/20] xen/sched: make vcpu_wake() and
 vcpu_sleep() core scheduling aware
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Julien Grall <julien@xen.org>,
 Wei Liu <wl@xen.org>, Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

dmNwdV93YWtlKCkgYW5kIHZjcHVfc2xlZXAoKSBuZWVkIHRvIGJlIG1hZGUgY29yZSBzY2hlZHVs
aW5nIGF3YXJlOgp0aGV5IG1pZ2h0IG5lZWQgdG8gc3dpdGNoIGEgc2luZ2xlIHZjcHUgb2YgYW4g
YWxyZWFkeSBzY2hlZHVsZWQgdW5pdApiZXR3ZWVuIHJ1bm5pbmcgYW5kIG5vdCBydW5uaW5nLgoK
RXNwZWNpYWxseSB3aGVuIHZjcHVfc2xlZXAoKSBmb3IgYSB2Y3B1IGlzIGJlaW5nIGNhbGxlZCBi
eSBhIHZjcHUgb2YKdGhlIHNhbWUgc2NoZWR1bGluZyB1bml0IHNwZWNpYWwgY2FyZSBtdXN0IGJl
IHRha2VuIGluIG9yZGVyIHRvIGF2b2lkCmEgZGVhZGxvY2s6IHRoZSB2Y3B1IHRvIGJlIHB1dCBh
c2xlZXAgbXVzdCBiZSBmb3JjZWQgdGhyb3VnaCBhCmNvbnRleHQgc3dpdGNoIHdpdGhvdXQgZG9p
bmcgc28gZm9yIHRoZSBjYWxsaW5nIHZjcHUuIEZvciB0aGlzCnB1cnBvc2UgYWRkIGEgdmNwdSBm
bGFnIGhhbmRsZWQgaW4gc2NoZWRfc2xhdmUoKSBhbmQgaW4Kc2NoZWRfd2FpdF9yZW5kZXp2b3Vz
X2luKCkgYWxsb3dpbmcgYSB2Y3B1IG9mIHRoZSBjdXJyZW50bHkgcnVubmluZwp1bml0IHRvIHN3
aXRjaCBzdGF0ZSBhdCBhIGhpZ2hlciBwcmlvcml0eSB0aGFuIGEgbm9ybWFsIHNjaGVkdWxlCmV2
ZW50LgoKVXNlIHRoZSBzYW1lIG1lY2hhbmlzbSB3aGVuIHdha2luZyB1cCBhIHZjcHUgb2YgYSBj
dXJyZW50bHkgYWN0aXZlCnVuaXQuCgpXaGlsZSBhdCBpdCBtYWtlIHZjcHVfc2xlZXBfbm9zeW5j
X2xvY2tlZCgpIHN0YXRpYyBhcyBpdCBpcyB1c2VkIGluCnNjaGVkdWxlLmMgb25seS4KClNpZ25l
ZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KUmV2aWV3ZWQtYnk6IERh
cmlvIEZhZ2dpb2xpIDxkZmFnZ2lvbGlAc3VzZS5jb20+Ci0tLQpSRkMgVjI6IGFkZCB2Y3B1X3Ns
ZWVwKCkgaGFuZGxpbmcgYW5kIGZvcmNlX2NvbnRleHRfc3dpdGNoIGZsYWcKVjI6IGZpeCBydW5z
dGF0ZSBjaGFuZ2UgaW4gc2NoZWRfZm9yY2VfY29udGV4dF9zd2l0Y2goKQpWNDoKLSB1c2UgdW5p
dF9zY2hlZHVsZXIoKSB3aGVyZSBhcHByb3ByaWF0ZSAoSmFuIEJldWxpY2gpCi0gbWFrZSBjcHUg
cGFyYW1ldGVyIHVuc2lnbmVkIGludCAoSmFuIEJldWxpY2gpCi0gY29tbWVudHMgKEphbiBCZXVs
aWNoKQotIHVzZSB0cnVlIGluc3RlYWQgMSBmb3Igc2V0dGluZyBib29sIChKYW4gQmV1bGljaCkK
LSBjb25zdCBwYXJhbWV0ZXIgKEphbiBCZXVsaWNoKQpWNToKLSBhZGQgY29tbWVudHMgKERhcmlv
IEZhZ2dpb2xpKQpWNi4xOgotIGhhbmRsZSBjb250ZXh0X3N3aXRjaCByZXR1cm5pbmcgKEp1bGll
biBHcmFsbCkKLS0tCiB4ZW4vY29tbW9uL3NjaGVkdWxlLmMgICAgICB8IDEzOCArKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0KIHhlbi9pbmNsdWRlL3hlbi9zY2hl
ZC1pZi5oIHwgICA5ICsrLQogeGVuL2luY2x1ZGUveGVuL3NjaGVkLmggICAgfCAgIDIgKwogMyBm
aWxlcyBjaGFuZ2VkLCAxNDAgaW5zZXJ0aW9ucygrKSwgOSBkZWxldGlvbnMoLSkKCmRpZmYgLS1n
aXQgYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKaW5kZXgg
YjRjNGIwNGViZS4uYTZlNDFiZTliMyAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hlZHVsZS5j
CisrKyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwpAQCAtNzUxLDggKzc1MSwxMCBAQCB2b2lkIHNj
aGVkX2Rlc3Ryb3lfZG9tYWluKHN0cnVjdCBkb21haW4gKmQpCiAgICAgfQogfQogCi12b2lkIHZj
cHVfc2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKK3N0YXRpYyB2b2lkIHZjcHVf
c2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKIHsKKyAgICBzdHJ1Y3Qgc2NoZWRf
dW5pdCAqdW5pdCA9IHYtPnNjaGVkX3VuaXQ7CisKICAgICBBU1NFUlQoc3Bpbl9pc19sb2NrZWQo
Z2V0X3NjaGVkX3Jlcyh2LT5wcm9jZXNzb3IpLT5zY2hlZHVsZV9sb2NrKSk7CiAKICAgICBpZiAo
IGxpa2VseSghdmNwdV9ydW5uYWJsZSh2KSkgKQpAQCAtNzYwLDcgKzc2MiwxNSBAQCB2b2lkIHZj
cHVfc2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAgaWYgKCB2LT5y
dW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uYWJsZSApCiAgICAgICAgICAgICB2Y3B1X3J1
bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9vZmZsaW5lLCBOT1coKSk7CiAKLSAgICAgICAgc2No
ZWRfc2xlZXAodmNwdV9zY2hlZHVsZXIodiksIHYtPnNjaGVkX3VuaXQpOworICAgICAgICAvKiBP
bmx5IHB1dCB1bml0IHRvIHNsZWVwIGluIGNhc2UgYWxsIHZjcHVzIGFyZSBub3QgcnVubmFibGUu
ICovCisgICAgICAgIGlmICggbGlrZWx5KCF1bml0X3J1bm5hYmxlKHVuaXQpKSApCisgICAgICAg
ICAgICBzY2hlZF9zbGVlcCh1bml0X3NjaGVkdWxlcih1bml0KSwgdW5pdCk7CisgICAgICAgIGVs
c2UgaWYgKCB1bml0X3J1bm5pbmcodW5pdCkgPiAxICYmIHYtPmlzX3J1bm5pbmcgJiYKKyAgICAg
ICAgICAgICAgICAgICF2LT5mb3JjZV9jb250ZXh0X3N3aXRjaCApCisgICAgICAgIHsKKyAgICAg
ICAgICAgIHYtPmZvcmNlX2NvbnRleHRfc3dpdGNoID0gdHJ1ZTsKKyAgICAgICAgICAgIGNwdV9y
YWlzZV9zb2Z0aXJxKHYtPnByb2Nlc3NvciwgU0NIRURfU0xBVkVfU09GVElSUSk7CisgICAgICAg
IH0KICAgICB9CiB9CiAKQEAgLTc5MiwxNiArODAyLDI3IEBAIHZvaWQgdmNwdV93YWtlKHN0cnVj
dCB2Y3B1ICp2KQogewogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAgICAgc3BpbmxvY2tfdCAq
bG9jazsKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCA9IHYtPnNjaGVkX3VuaXQ7CiAKICAg
ICBUUkFDRV8yRChUUkNfU0NIRURfV0FLRSwgdi0+ZG9tYWluLT5kb21haW5faWQsIHYtPnZjcHVf
aWQpOwogCi0gICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnFzYXZlKHYtPnNjaGVkX3Vu
aXQsICZmbGFncyk7CisgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnFzYXZlKHVuaXQs
ICZmbGFncyk7CiAKICAgICBpZiAoIGxpa2VseSh2Y3B1X3J1bm5hYmxlKHYpKSApCiAgICAgewog
ICAgICAgICBpZiAoIHYtPnJ1bnN0YXRlLnN0YXRlID49IFJVTlNUQVRFX2Jsb2NrZWQgKQogICAg
ICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UodiwgUlVOU1RBVEVfcnVubmFibGUsIE5PVygp
KTsKLSAgICAgICAgc2NoZWRfd2FrZSh2Y3B1X3NjaGVkdWxlcih2KSwgdi0+c2NoZWRfdW5pdCk7
CisgICAgICAgIC8qCisgICAgICAgICAqIENhbGwgc2NoZWRfd2FrZSgpIHVuY29uZGl0aW9uYWxs
eSwgZXZlbiBpZiB1bml0IGlzIHJ1bm5pbmcgYWxyZWFkeS4KKyAgICAgICAgICogV2UgbWlnaHQg
aGF2ZSBub3QgYmVlbiBkZS1zY2hlZHVsZWQgYWZ0ZXIgdmNwdV9zbGVlcF9ub3N5bmNfbG9ja2Vk
KCkKKyAgICAgICAgICogYW5kIGFyZSBub3cgdG8gYmUgd29rZW4gdXAgYWdhaW4uCisgICAgICAg
ICAqLworICAgICAgICBzY2hlZF93YWtlKHVuaXRfc2NoZWR1bGVyKHVuaXQpLCB1bml0KTsKKyAg
ICAgICAgaWYgKCB1bml0LT5pc19ydW5uaW5nICYmICF2LT5pc19ydW5uaW5nICYmICF2LT5mb3Jj
ZV9jb250ZXh0X3N3aXRjaCApCisgICAgICAgIHsKKyAgICAgICAgICAgIHYtPmZvcmNlX2NvbnRl
eHRfc3dpdGNoID0gdHJ1ZTsKKyAgICAgICAgICAgIGNwdV9yYWlzZV9zb2Z0aXJxKHYtPnByb2Nl
c3NvciwgU0NIRURfU0xBVkVfU09GVElSUSk7CisgICAgICAgIH0KICAgICB9CiAgICAgZWxzZSBp
ZiAoICEodi0+cGF1c2VfZmxhZ3MgJiBWUEZfYmxvY2tlZCkgKQogICAgIHsKQEAgLTgwOSw3ICs4
MzAsNyBAQCB2b2lkIHZjcHVfd2FrZShzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAgICAgIHZjcHVf
cnVuc3RhdGVfY2hhbmdlKHYsIFJVTlNUQVRFX29mZmxpbmUsIE5PVygpKTsKICAgICB9CiAKLSAg
ICB1bml0X3NjaGVkdWxlX3VubG9ja19pcnFyZXN0b3JlKGxvY2ssIGZsYWdzLCB2LT5zY2hlZF91
bml0KTsKKyAgICB1bml0X3NjaGVkdWxlX3VubG9ja19pcnFyZXN0b3JlKGxvY2ssIGZsYWdzLCB1
bml0KTsKIH0KIAogdm9pZCB2Y3B1X3VuYmxvY2soc3RydWN0IHZjcHUgKnYpCkBAIC0yMDI3LDYg
KzIwNDgsNjUgQEAgc3RhdGljIHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUg
KnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQsCiAgICAgY29udGV4dF9zd2l0Y2godnByZXYsIHZu
ZXh0KTsKIH0KIAorLyoKKyAqIEZvcmNlIGEgY29udGV4dCBzd2l0Y2ggb2YgYSBzaW5nbGUgdmNw
dSBvZiBhbiB1bml0LgorICogTWlnaHQgYmUgY2FsbGVkIGVpdGhlciBpZiBhIHZjcHUgb2YgYW4g
YWxyZWFkeSBydW5uaW5nIHVuaXQgaXMgd29rZW4gdXAKKyAqIG9yIGlmIGEgdmNwdSBvZiBhIHJ1
bm5pbmcgdW5pdCBpcyBwdXQgYXNsZWVwIHdpdGggb3RoZXIgdmNwdXMgb2YgdGhlIHNhbWUKKyAq
IHVuaXQgc3RpbGwgcnVubmluZy4KKyAqIFJldHVybnMgZWl0aGVyIE5VTEwgaWYgdiBpcyBhbHJl
YWR5IGluIHRoZSBjb3JyZWN0IHN0YXRlIG9yIHRoZSB2Y3B1IHRvCisgKiBydW4gbmV4dC4KKyAq
Lworc3RhdGljIHN0cnVjdCB2Y3B1ICpzY2hlZF9mb3JjZV9jb250ZXh0X3N3aXRjaChzdHJ1Y3Qg
dmNwdSAqdnByZXYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHN0cnVjdCB2Y3B1ICp2LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICB1bnNpZ25lZCBpbnQgY3B1LCBzX3RpbWVfdCBub3cpCit7CisgICAgdi0+Zm9y
Y2VfY29udGV4dF9zd2l0Y2ggPSBmYWxzZTsKKworICAgIGlmICggdmNwdV9ydW5uYWJsZSh2KSA9
PSB2LT5pc19ydW5uaW5nICkKKyAgICAgICAgcmV0dXJuIE5VTEw7CisKKyAgICBpZiAoIHZjcHVf
cnVubmFibGUodikgKQorICAgIHsKKyAgICAgICAgaWYgKCBpc19pZGxlX3ZjcHUodnByZXYpICkK
KyAgICAgICAgeworICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UodnByZXYsIFJVTlNU
QVRFX3J1bm5hYmxlLCBub3cpOworICAgICAgICAgICAgdnByZXYtPnNjaGVkX3VuaXQgPSBnZXRf
c2NoZWRfcmVzKGNwdSktPnNjaGVkX3VuaXRfaWRsZTsKKyAgICAgICAgfQorICAgICAgICB2Y3B1
X3J1bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9ydW5uaW5nLCBub3cpOworICAgIH0KKyAgICBl
bHNlCisgICAgeworICAgICAgICAvKiBNYWtlIHN1cmUgbm90IHRvIHN3aXRjaCBsYXN0IHZjcHUg
b2YgYW4gdW5pdCBhd2F5LiAqLworICAgICAgICBpZiAoIHVuaXRfcnVubmluZyh2LT5zY2hlZF91
bml0KSA9PSAxICkKKyAgICAgICAgICAgIHJldHVybiBOVUxMOworCisgICAgICAgIHYtPm5ld19z
dGF0ZSA9IHZjcHVfcnVuc3RhdGVfYmxvY2tlZCh2KTsKKyAgICAgICAgdmNwdV9ydW5zdGF0ZV9j
aGFuZ2Uodiwgdi0+bmV3X3N0YXRlLCBub3cpOworICAgICAgICB2ID0gc2NoZWRfdW5pdDJ2Y3B1
X2NwdSh2cHJldi0+c2NoZWRfdW5pdCwgY3B1KTsKKyAgICAgICAgaWYgKCB2ICE9IHZwcmV2ICkK
KyAgICAgICAgeworICAgICAgICAgICAgaWYgKCBpc19pZGxlX3ZjcHUodnByZXYpICkKKyAgICAg
ICAgICAgIHsKKyAgICAgICAgICAgICAgICB2Y3B1X3J1bnN0YXRlX2NoYW5nZSh2cHJldiwgUlVO
U1RBVEVfcnVubmFibGUsIG5vdyk7CisgICAgICAgICAgICAgICAgdnByZXYtPnNjaGVkX3VuaXQg
PSBnZXRfc2NoZWRfcmVzKGNwdSktPnNjaGVkX3VuaXRfaWRsZTsKKyAgICAgICAgICAgIH0KKyAg
ICAgICAgICAgIGVsc2UKKyAgICAgICAgICAgIHsKKyAgICAgICAgICAgICAgICB2LT5zY2hlZF91
bml0ID0gdnByZXYtPnNjaGVkX3VuaXQ7CisgICAgICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9j
aGFuZ2UodiwgUlVOU1RBVEVfcnVubmluZywgbm93KTsKKyAgICAgICAgICAgIH0KKyAgICAgICAg
fQorICAgIH0KKworICAgIC8qIFRoaXMgdmNwdSB3aWxsIGJlIHN3aXRjaGVkIHRvLiAqLworICAg
IHYtPmlzX3J1bm5pbmcgPSB0cnVlOworCisgICAgLyogTWFrZSBzdXJlIG5vdCB0byBsb29zZSBh
bm90aGVyIHNsYXZlIGNhbGwuICovCisgICAgcmFpc2Vfc29mdGlycShTQ0hFRF9TTEFWRV9TT0ZU
SVJRKTsKKworICAgIHJldHVybiB2OworfQorCiAvKgogICogUmVuZGV6dm91cyBiZWZvcmUgdGFr
aW5nIGEgc2NoZWR1bGluZyBkZWNpc2lvbi4KICAqIENhbGxlZCB3aXRoIHNjaGVkdWxlIGxvY2sg
aGVsZCwgc28gYWxsIGFjY2Vzc2VzIHRvIHRoZSByZW5kZXp2b3VzIGNvdW50ZXIKQEAgLTIwNDIs
NiArMjEyMiw3IEBAIHN0YXRpYyBzdHJ1Y3Qgc2NoZWRfdW5pdCAqc2NoZWRfd2FpdF9yZW5kZXp2
b3VzX2luKHN0cnVjdCBzY2hlZF91bml0ICpwcmV2LAogICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgc190aW1lX3Qgbm93KQogewogICAgIHN0cnVjdCBz
Y2hlZF91bml0ICpuZXh0OworICAgIHN0cnVjdCB2Y3B1ICp2OwogCiAgICAgaWYgKCAhLS1wcmV2
LT5yZW5kZXp2b3VzX2luX2NudCApCiAgICAgewpAQCAtMjA1MCw4ICsyMTMxLDMwIEBAIHN0YXRp
YyBzdHJ1Y3Qgc2NoZWRfdW5pdCAqc2NoZWRfd2FpdF9yZW5kZXp2b3VzX2luKHN0cnVjdCBzY2hl
ZF91bml0ICpwcmV2LAogICAgICAgICByZXR1cm4gbmV4dDsKICAgICB9CiAKKyAgICB2ID0gdW5p
dDJ2Y3B1X2NwdShwcmV2LCBjcHUpOwogICAgIHdoaWxlICggcHJldi0+cmVuZGV6dm91c19pbl9j
bnQgKQogICAgIHsKKyAgICAgICAgaWYgKCB2ICYmIHYtPmZvcmNlX2NvbnRleHRfc3dpdGNoICkK
KyAgICAgICAgeworICAgICAgICAgICAgc3RydWN0IHZjcHUgKnZwcmV2ID0gY3VycmVudDsKKwor
ICAgICAgICAgICAgdiA9IHNjaGVkX2ZvcmNlX2NvbnRleHRfc3dpdGNoKHZwcmV2LCB2LCBjcHUs
IG5vdyk7CisKKyAgICAgICAgICAgIGlmICggdiApCisgICAgICAgICAgICB7CisgICAgICAgICAg
ICAgICAgLyogV2UnbGwgY29tZSBiYWNrIGFub3RoZXIgdGltZSwgc28gYWRqdXN0IHJlbmRlenZv
dXNfaW5fY250LiAqLworICAgICAgICAgICAgICAgIHByZXYtPnJlbmRlenZvdXNfaW5fY250Kys7
CisgICAgICAgICAgICAgICAgYXRvbWljX3NldCgmcHJldi0+cmVuZGV6dm91c19vdXRfY250LCAw
KTsKKworICAgICAgICAgICAgICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycSgqbG9jaywgY3B1
KTsKKworICAgICAgICAgICAgICAgIHNjaGVkX2NvbnRleHRfc3dpdGNoKHZwcmV2LCB2LCBmYWxz
ZSwgbm93KTsKKworICAgICAgICAgICAgICAgIHJldHVybiBOVUxMOyAgICAgLyogQVJNIG9ubHku
ICovCisgICAgICAgICAgICB9CisKKyAgICAgICAgICAgIHYgPSB1bml0MnZjcHVfY3B1KHByZXYs
IGNwdSk7CisgICAgICAgIH0KICAgICAgICAgLyoKICAgICAgICAgICogQ29taW5nIGZyb20gaWRs
ZSBtaWdodCBuZWVkIHRvIGRvIHRhc2tsZXQgd29yay4KICAgICAgICAgICogSW4gb3JkZXIgdG8g
YXZvaWQgZGVhZGxvY2tzIHdlIGNhbid0IGRvIHRoYXQgaGVyZSwgYnV0IGhhdmUgdG8KQEAgLTIw
ODYsMTAgKzIxODksMTEgQEAgc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF93YWl0X3Jl
bmRlenZvdXNfaW4oc3RydWN0IHNjaGVkX3VuaXQgKnByZXYsCiAKIHN0YXRpYyB2b2lkIHNjaGVk
X3NsYXZlKHZvaWQpCiB7Ci0gICAgc3RydWN0IHZjcHUgICAgICAgICAgKnZwcmV2ID0gY3VycmVu
dDsKKyAgICBzdHJ1Y3QgdmNwdSAgICAgICAgICAqdiwgKnZwcmV2ID0gY3VycmVudDsKICAgICBz
dHJ1Y3Qgc2NoZWRfdW5pdCAgICAqcHJldiA9IHZwcmV2LT5zY2hlZF91bml0LCAqbmV4dDsKICAg
ICBzX3RpbWVfdCAgICAgICAgICAgICAgbm93OwogICAgIHNwaW5sb2NrX3QgICAgICAgICAgICps
b2NrOworICAgIGJvb2wgICAgICAgICAgICAgICAgICBkb19zb2Z0aXJxID0gZmFsc2U7CiAgICAg
dW5zaWduZWQgaW50ICAgICAgICAgIGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKIAogICAgIEFT
U0VSVF9OT1RfSU5fQVRPTUlDKCk7CkBAIC0yMDk4LDkgKzIyMDIsMzEgQEAgc3RhdGljIHZvaWQg
c2NoZWRfc2xhdmUodm9pZCkKIAogICAgIG5vdyA9IE5PVygpOwogCisgICAgdiA9IHVuaXQydmNw
dV9jcHUocHJldiwgY3B1KTsKKyAgICBpZiAoIHYgJiYgdi0+Zm9yY2VfY29udGV4dF9zd2l0Y2gg
KQorICAgIHsKKyAgICAgICAgdiA9IHNjaGVkX2ZvcmNlX2NvbnRleHRfc3dpdGNoKHZwcmV2LCB2
LCBjcHUsIG5vdyk7CisKKyAgICAgICAgaWYgKCB2ICkKKyAgICAgICAgeworICAgICAgICAgICAg
cGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CisKKyAgICAgICAgICAgIHNjaGVk
X2NvbnRleHRfc3dpdGNoKHZwcmV2LCB2LCBmYWxzZSwgbm93KTsKKworICAgICAgICAgICAgcmV0
dXJuOworICAgICAgICB9CisKKyAgICAgICAgZG9fc29mdGlycSA9IHRydWU7CisgICAgfQorCiAg
ICAgaWYgKCAhcHJldi0+cmVuZGV6dm91c19pbl9jbnQgKQogICAgIHsKICAgICAgICAgcGNwdV9z
Y2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CisKKyAgICAgICAgLyogQ2hlY2sgZm9yIGZh
aWxlZCBmb3JjZWQgY29udGV4dCBzd2l0Y2guICovCisgICAgICAgIGlmICggZG9fc29mdGlycSAp
CisgICAgICAgICAgICByYWlzZV9zb2Z0aXJxKFNDSEVEVUxFX1NPRlRJUlEpOworCiAgICAgICAg
IHJldHVybjsKICAgICB9CiAKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5o
IGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKaW5kZXggNDFhMTA4M2EwOC4uMDIxYzFkN2My
YyAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKKysrIGIveGVuL2luY2x1
ZGUveGVuL3NjaGVkLWlmLmgKQEAgLTEwMiw2ICsxMDIsMTEgQEAgc3RhdGljIGlubGluZSBib29s
IHVuaXRfcnVubmFibGUoY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAgICAgcmV0dXJu
IGZhbHNlOwogfQogCitzdGF0aWMgaW5saW5lIGludCB2Y3B1X3J1bnN0YXRlX2Jsb2NrZWQoY29u
c3Qgc3RydWN0IHZjcHUgKnYpCit7CisgICAgcmV0dXJuICh2LT5wYXVzZV9mbGFncyAmIFZQRl9i
bG9ja2VkKSA/IFJVTlNUQVRFX2Jsb2NrZWQgOiBSVU5TVEFURV9vZmZsaW5lOworfQorCiAvKgog
ICogUmV0dXJucyB3aGV0aGVyIGEgc2NoZWRfdW5pdCBpcyBydW5uYWJsZSBhbmQgc2V0cyBuZXdf
c3RhdGUgZm9yIGVhY2ggb2YgaXRzCiAgKiB2Y3B1cy4gSXQgaXMgbWFuZGF0b3J5IHRvIGRldGVy
bWluZSB0aGUgbmV3IHJ1bnN0YXRlIGZvciBhbGwgdmNwdXMgb2YgYSB1bml0CkBAIC0xMjEsOSAr
MTI2LDcgQEAgc3RhdGljIGlubGluZSBib29sIHVuaXRfcnVubmFibGVfc3RhdGUoY29uc3Qgc3Ry
dWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAgICAgewogICAgICAgICBydW5uYWJsZSA9IHZjcHVfcnVu
bmFibGUodik7CiAKLSAgICAgICAgdi0+bmV3X3N0YXRlID0gcnVubmFibGUgPyBSVU5TVEFURV9y
dW5uaW5nCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHYtPnBhdXNlX2ZsYWdz
ICYgVlBGX2Jsb2NrZWQpCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBSVU5T
VEFURV9ibG9ja2VkIDogUlVOU1RBVEVfb2ZmbGluZTsKKyAgICAgICAgdi0+bmV3X3N0YXRlID0g
cnVubmFibGUgPyBSVU5TVEFURV9ydW5uaW5nIDogdmNwdV9ydW5zdGF0ZV9ibG9ja2VkKHYpOwog
CiAgICAgICAgIGlmICggcnVubmFibGUgKQogICAgICAgICAgICAgcmV0ID0gdHJ1ZTsKZGlmZiAt
LWdpdCBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgK
aW5kZXggY2U0MzI5ZGI3Mi4uZjk3MzAzNjY4YSAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVu
L3NjaGVkLmgKKysrIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKQEAgLTE4Niw2ICsxODYsOCBA
QCBzdHJ1Y3QgdmNwdQogICAgIGJvb2wgICAgICAgICAgICAgaXNfcnVubmluZzsKICAgICAvKiBW
Q1BVIHNob3VsZCB3YWtlIGZhc3QgKGRvIG5vdCBkZWVwIHNsZWVwIHRoZSBDUFUpLiAqLwogICAg
IGJvb2wgICAgICAgICAgICAgaXNfdXJnZW50OworICAgIC8qIFZDUFUgbXVzdCBjb250ZXh0X3N3
aXRjaCB3aXRob3V0IHNjaGVkdWxpbmcgdW5pdC4gKi8KKyAgICBib29sICAgICAgICAgICAgIGZv
cmNlX2NvbnRleHRfc3dpdGNoOwogCiAjaWZkZWYgVkNQVV9UUkFQX0xBU1QKICNkZWZpbmUgVkNQ
VV9UUkFQX05PTkUgICAgMAotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlz
dHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xp
c3RpbmZvL3hlbi1kZXZlbA==

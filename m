Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id B180A144C6
	for <lists+xen-devel@lfdr.de>; Mon,  6 May 2019 09:00:01 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hNXZA-0003De-2D; Mon, 06 May 2019 06:57:36 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=XZcu=TG=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hNXYn-0002Kn-Tu
 for xen-devel@lists.xenproject.org; Mon, 06 May 2019 06:57:13 +0000
X-Inumbo-ID: 27acffe4-6fcc-11e9-843c-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 27acffe4-6fcc-11e9-843c-bc764e045a96;
 Mon, 06 May 2019 06:57:04 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 56C17AF41;
 Mon,  6 May 2019 06:57:00 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon,  6 May 2019 08:56:42 +0200
Message-Id: <20190506065644.7415-44-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190506065644.7415-1-jgross@suse.com>
References: <20190506065644.7415-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH RFC V2 43/45] xen/sched: make vcpu_wake() and
 vcpu_sleep() core scheduling aware
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wei.liu2@citrix.com>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

dmNwdV93YWtlKCkgYW5kIHZjcHVfc2xlZXAoKSBuZWVkIHRvIGJlIG1hZGUgY29yZSBzY2hlZHVs
aW5nIGF3YXJlOgp0aGV5IG1pZ2h0IG5lZWQgdG8gc3dpdGNoIGEgc2luZ2xlIHZjcHUgb2YgYW4g
YWxyZWFkeSBzY2hlZHVsZWQgaXRlbQpiZXR3ZWVuIHJ1bm5pbmcgYW5kIG5vdCBydW5uaW5nLgoK
RXNwZWNpYWxseSB3aGVuIHZjcHVfc2xlZXAoKSBmb3IgYSB2Y3B1IGlzIGJlaW5nIGNhbGxlZCBi
eSBhIHZjcHUgb2YKdGhlIHNhbWUgc2NoZWR1bGluZyBpdGVtIHNwZWNpYWwgY2FyZSBtdXN0IGJl
IHRha2VuIGluIG9yZGVyIHRvIGF2b2lkCmEgZGVhZGxvY2s6IHRoZSB2Y3B1IHRvIGJlIHB1dCBh
c2xlZXAgbXVzdCBiZSBmb3JjZWQgdGhyb3VnaCBhCmNvbnRleHQgc3dpdGNoIHdpdGhvdXQgZG9p
bmcgc28gZm9yIHRoZSBjYWxsaW5nIHZjcHUuIEZvciB0aGlzCnB1cnBvc2UgYWRkIGEgdmNwdSBm
bGFnIGhhbmRsZWQgaW4gc2NoZWRfc2xhdmUoKSBhbmQgaW4Kc2NoZWRfd2FpdF9yZW5kZXp2b3Vz
X2luKCkgYWxsb3dpbmcgYSB2Y3B1IG9mIHRoZSBjdXJyZW50bHkgcnVubmluZwppdGVtIHRvIHN3
aXRjaCBzdGF0ZSBhdCBhIGhpZ2hlciBwcmlvcml0eSB0aGFuIGEgbm9ybWFsIHNjaGVkdWxlCmV2
ZW50LgoKVXNlIHRoZSBzYW1lIG1lY2hhbmlzbSB3aGVuIHdha2luZyB1cCBhIHZjcHUgb2YgYSBj
dXJyZW50bHkgYWN0aXZlCml0ZW0uCgpXaGlsZSBhdCBpdCBtYWtlIHZjcHVfc2xlZXBfbm9zeW5j
X2xvY2tlZCgpIHN0YXRpYyBhcyBpdCBpcyB1c2VkIGluCnNjaGVkdWxlLmMgb25seS4KClNpZ25l
ZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tClJGQyBWMjogYWRk
IHZjcHVfc2xlZXAoKSBoYW5kbGluZyBhbmQgZm9yY2VfY29udGV4dF9zd2l0Y2ggZmxhZwotLS0K
IHhlbi9jb21tb24vc2NoZWR1bGUuYyAgICAgIHwgMTQ0ICsrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKystLS0tLQogeGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmggfCAgIDkg
KystCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCAgICB8ICAgMiArCiAzIGZpbGVzIGNoYW5nZWQs
IDEzNiBpbnNlcnRpb25zKCspLCAxOSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29t
bW9uL3NjaGVkdWxlLmMgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKaW5kZXggNzg4ZWNjOWU4MS4u
NDllZDJiNTkwMCAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jCisrKyBiL3hlbi9j
b21tb24vc2NoZWR1bGUuYwpAQCAtNzksMjEgKzc5LDIxIEBAIGV4dGVybiBjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpfX3N0YXJ0X3NjaGVkdWxlcnNfYXJyYXlbXSwgKl9fZW5kX3NjaGVkdWxlcnNf
YXJyCiAKIHN0YXRpYyBzdHJ1Y3Qgc2NoZWR1bGVyIF9fcmVhZF9tb3N0bHkgb3BzOwogCi1zdGF0
aWMgaW5saW5lIHN0cnVjdCB2Y3B1ICpzY2hlZF9pdGVtMnZjcHVfY3B1KHN0cnVjdCBzY2hlZF9p
dGVtICppdGVtLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICB1bnNpZ25lZCBpbnQgY3B1KQorc3RhdGljIGlubGluZSBzdHJ1Y3QgdmNwdSAqaXRlbTJ2Y3B1
X2NwdShzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGNwdSkKIHsKICAgICB1bnNpZ25lZCBpbnQgaWR4
ID0gaXRlbS0+aXRlbV9pZCArIHBlcl9jcHUoc2NoZWRfcmVzX2lkeCwgY3B1KTsKICAgICBjb25z
dCBzdHJ1Y3QgZG9tYWluICpkID0gaXRlbS0+ZG9tYWluOwotICAgIHN0cnVjdCB2Y3B1ICp2Owog
Ci0gICAgaWYgKCBpZHggPCBkLT5tYXhfdmNwdXMgJiYgZC0+dmNwdVtpZHhdICkKLSAgICB7Ci0g
ICAgICAgIHYgPSBkLT52Y3B1W2lkeF07Ci0gICAgICAgIGlmICggdi0+bmV3X3N0YXRlID09IFJV
TlNUQVRFX3J1bm5pbmcgKQotICAgICAgICAgICAgcmV0dXJuIHY7Ci0gICAgfQorICAgIHJldHVy
biAoaWR4IDwgZC0+bWF4X3ZjcHVzICYmIGQtPnZjcHVbaWR4XSkgPyBkLT52Y3B1W2lkeF0gOiBO
VUxMOworfQogCi0gICAgcmV0dXJuIGlkbGVfdmNwdVtjcHVdOworc3RhdGljIGlubGluZSBzdHJ1
Y3QgdmNwdSAqc2NoZWRfaXRlbTJ2Y3B1X2NwdShzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50
IGNwdSkKK3sKKyAgICBzdHJ1Y3QgdmNwdSAqdiA9IGl0ZW0ydmNwdV9jcHUoaXRlbSwgY3B1KTsK
KworICAgIHJldHVybiAodiAmJiB2LT5uZXdfc3RhdGUgPT0gUlVOU1RBVEVfcnVubmluZykgPyB2
IDogaWRsZV92Y3B1W2NwdV07CiB9CiAKIHN0YXRpYyBpbmxpbmUgc3RydWN0IHNjaGVkdWxlciAq
ZG9tX3NjaGVkdWxlcihjb25zdCBzdHJ1Y3QgZG9tYWluICpkKQpAQCAtNjQ0LDggKzY0NCwxMCBA
QCB2b2lkIHNjaGVkX2Rlc3Ryb3lfZG9tYWluKHN0cnVjdCBkb21haW4gKmQpCiAgICAgfQogfQog
Ci12b2lkIHZjcHVfc2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKK3N0YXRpYyB2
b2lkIHZjcHVfc2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKIHsKKyAgICBzdHJ1
Y3Qgc2NoZWRfaXRlbSAqaXRlbSA9IHYtPnNjaGVkX2l0ZW07CisKICAgICBBU1NFUlQoc3Bpbl9p
c19sb2NrZWQocGVyX2NwdShzY2hlZF9yZXMsIHYtPnByb2Nlc3NvciktPnNjaGVkdWxlX2xvY2sp
KTsKIAogICAgIGlmICggbGlrZWx5KCF2Y3B1X3J1bm5hYmxlKHYpKSApCkBAIC02NTMsNyArNjU1
LDE0IEBAIHZvaWQgdmNwdV9zbGVlcF9ub3N5bmNfbG9ja2VkKHN0cnVjdCB2Y3B1ICp2KQogICAg
ICAgICBpZiAoIHYtPnJ1bnN0YXRlLnN0YXRlID09IFJVTlNUQVRFX3J1bm5hYmxlICkKICAgICAg
ICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdlKHYsIFJVTlNUQVRFX29mZmxpbmUsIE5PVygpKTsK
IAotICAgICAgICBzY2hlZF9zbGVlcCh2Y3B1X3NjaGVkdWxlcih2KSwgdi0+c2NoZWRfaXRlbSk7
CisgICAgICAgIGlmICggbGlrZWx5KCFpdGVtX3J1bm5hYmxlKGl0ZW0pKSApCisgICAgICAgICAg
ICBzY2hlZF9zbGVlcCh2Y3B1X3NjaGVkdWxlcih2KSwgaXRlbSk7CisgICAgICAgIGVsc2UgaWYg
KCBpdGVtX3J1bm5pbmcoaXRlbSkgPiAxICYmIHYtPmlzX3J1bm5pbmcgJiYKKyAgICAgICAgICAg
ICAgICAgICF2LT5mb3JjZV9jb250ZXh0X3N3aXRjaCApCisgICAgICAgIHsKKyAgICAgICAgICAg
IHYtPmZvcmNlX2NvbnRleHRfc3dpdGNoID0gdHJ1ZTsKKyAgICAgICAgICAgIGNwdV9yYWlzZV9z
b2Z0aXJxKHYtPnByb2Nlc3NvciwgU0NIRURfU0xBVkVfU09GVElSUSk7CisgICAgICAgIH0KICAg
ICB9CiB9CiAKQEAgLTY4NSwxNiArNjk0LDIyIEBAIHZvaWQgdmNwdV93YWtlKHN0cnVjdCB2Y3B1
ICp2KQogewogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAgICAgc3BpbmxvY2tfdCAqbG9jazsK
KyAgICBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSA9IHYtPnNjaGVkX2l0ZW07CiAKICAgICBUUkFD
RV8yRChUUkNfU0NIRURfV0FLRSwgdi0+ZG9tYWluLT5kb21haW5faWQsIHYtPnZjcHVfaWQpOwog
Ci0gICAgbG9jayA9IGl0ZW1fc2NoZWR1bGVfbG9ja19pcnFzYXZlKHYtPnNjaGVkX2l0ZW0sICZm
bGFncyk7CisgICAgbG9jayA9IGl0ZW1fc2NoZWR1bGVfbG9ja19pcnFzYXZlKGl0ZW0sICZmbGFn
cyk7CiAKICAgICBpZiAoIGxpa2VseSh2Y3B1X3J1bm5hYmxlKHYpKSApCiAgICAgewogICAgICAg
ICBpZiAoIHYtPnJ1bnN0YXRlLnN0YXRlID49IFJVTlNUQVRFX2Jsb2NrZWQgKQogICAgICAgICAg
ICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UodiwgUlVOU1RBVEVfcnVubmFibGUsIE5PVygpKTsKLSAg
ICAgICAgc2NoZWRfd2FrZSh2Y3B1X3NjaGVkdWxlcih2KSwgdi0+c2NoZWRfaXRlbSk7CisgICAg
ICAgIHNjaGVkX3dha2UodmNwdV9zY2hlZHVsZXIodiksIGl0ZW0pOworICAgICAgICBpZiAoIGl0
ZW0tPmlzX3J1bm5pbmcgJiYgIXYtPmlzX3J1bm5pbmcgJiYgIXYtPmZvcmNlX2NvbnRleHRfc3dp
dGNoICkKKyAgICAgICAgeworICAgICAgICAgICAgdi0+Zm9yY2VfY29udGV4dF9zd2l0Y2ggPSB0
cnVlOworICAgICAgICAgICAgY3B1X3JhaXNlX3NvZnRpcnEodi0+cHJvY2Vzc29yLCBTQ0hFRF9T
TEFWRV9TT0ZUSVJRKTsKKyAgICAgICAgfQogICAgIH0KICAgICBlbHNlIGlmICggISh2LT5wYXVz
ZV9mbGFncyAmIFZQRl9ibG9ja2VkKSApCiAgICAgewpAQCAtNzAyLDcgKzcxNyw3IEBAIHZvaWQg
dmNwdV93YWtlKHN0cnVjdCB2Y3B1ICp2KQogICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFu
Z2UodiwgUlVOU1RBVEVfb2ZmbGluZSwgTk9XKCkpOwogICAgIH0KIAotICAgIGl0ZW1fc2NoZWR1
bGVfdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIHYtPnNjaGVkX2l0ZW0pOworICAgIGl0
ZW1fc2NoZWR1bGVfdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIGl0ZW0pOwogfQogCiB2
b2lkIHZjcHVfdW5ibG9jayhzdHJ1Y3QgdmNwdSAqdikKQEAgLTE4MzUsNiArMTg1MCw2MSBAQCBz
dGF0aWMgdm9pZCBzY2hlZF9jb250ZXh0X3N3aXRjaChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVj
dCB2Y3B1ICp2bmV4dCwKICAgICBjb250ZXh0X3N3aXRjaCh2cHJldiwgdm5leHQpOwogfQogCisv
KgorICogRm9yY2UgYSBjb250ZXh0IHN3aXRjaCBvZiBhIHNpbmdsZSB2Y3B1IG9mIGFuIGl0ZW0u
CisgKiBNaWdodCBiZSBjYWxsZWQgZWl0aGVyIGlmIGEgdmNwdSBvZiBhbiBhbHJlYWR5IHJ1bm5p
bmcgaXRlbSBpcyB3b2tlbiB1cAorICogb3IgaWYgYSB2Y3B1IG9mIGEgcnVubmluZyBpdGVtIGlz
IHB1dCBhc2xlZXAgd2l0aCBvdGhlciB2Y3B1cyBvZiB0aGUgc2FtZQorICogaXRlbSBzdGlsbCBy
dW5uaW5nLgorICovCitzdGF0aWMgc3RydWN0IHZjcHUgKnNjaGVkX2ZvcmNlX2NvbnRleHRfc3dp
dGNoKHN0cnVjdCB2Y3B1ICp2cHJldiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgc3RydWN0IHZjcHUgKnYsCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGludCBjcHUsIHNfdGltZV90IG5vdykKK3sKKyAgICB2LT5m
b3JjZV9jb250ZXh0X3N3aXRjaCA9IGZhbHNlOworCisgICAgaWYgKCB2Y3B1X3J1bm5hYmxlKHYp
ID09IHYtPmlzX3J1bm5pbmcgKQorICAgICAgICByZXR1cm4gTlVMTDsKKworICAgIGlmICggdmNw
dV9ydW5uYWJsZSh2KSApCisgICAgeworICAgICAgICBpZiAoIGlzX2lkbGVfdmNwdSh2cHJldikg
KQorICAgICAgICB7CisgICAgICAgICAgICB2Y3B1X3J1bnN0YXRlX2NoYW5nZSh2cHJldiwgUlVO
U1RBVEVfcnVubmFibGUsIG5vdyk7CisgICAgICAgICAgICB2cHJldi0+c2NoZWRfaXRlbSA9IHRo
aXNfY3B1KHNjaGVkX3JlcyktPnNjaGVkX2l0ZW1faWRsZTsKKyAgICAgICAgfQorICAgICAgICB2
Y3B1X3J1bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9ydW5uaW5nLCBub3cpOworICAgIH0KKyAg
ICBlbHNlCisgICAgeworICAgICAgICAvKiBNYWtlIHN1cmUgbm90IHRvIHN3aXRjaCBsYXN0IHZj
cHUgb2YgYW4gaXRlbSBhd2F5LiAqLworICAgICAgICBpZiAoIGl0ZW1fcnVubmluZyh2LT5zY2hl
ZF9pdGVtKSA9PSAxICkKKyAgICAgICAgICAgIHJldHVybiBOVUxMOworCisgICAgICAgIHZjcHVf
cnVuc3RhdGVfY2hhbmdlKHYsIHZjcHVfcnVuc3RhdGVfYmxvY2tlZCh2KSwgbm93KTsKKyAgICAg
ICAgdiA9IHNjaGVkX2l0ZW0ydmNwdV9jcHUodnByZXYtPnNjaGVkX2l0ZW0sIGNwdSk7CisgICAg
ICAgIGlmICggdiAhPSB2cHJldiApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggaXNfaWRs
ZV92Y3B1KHZwcmV2KSApCisgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgdmNwdV9ydW5z
dGF0ZV9jaGFuZ2UodnByZXYsIFJVTlNUQVRFX3J1bm5hYmxlLCBub3cpOworICAgICAgICAgICAg
ICAgIHZwcmV2LT5zY2hlZF9pdGVtID0gdGhpc19jcHUoc2NoZWRfcmVzKS0+c2NoZWRfaXRlbV9p
ZGxlOworICAgICAgICAgICAgfQorICAgICAgICAgICAgZWxzZQorICAgICAgICAgICAgeworICAg
ICAgICAgICAgICAgIHYtPnNjaGVkX2l0ZW0gPSB2cHJldi0+c2NoZWRfaXRlbTsKKyAgICAgICAg
ICAgICAgICB2Y3B1X3J1bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9ydW5uaW5nLCBub3cpOwor
ICAgICAgICAgICAgfQorICAgICAgICB9CisgICAgfQorCisgICAgdi0+aXNfcnVubmluZyA9IDE7
CisKKyAgICAvKiBNYWtlIHN1cmUgbm90IHRvIGxvb3NlIGFub3RoZXIgc2xhdmUgY2FsbC4gKi8K
KyAgICByYWlzZV9zb2Z0aXJxKFNDSEVEX1NMQVZFX1NPRlRJUlEpOworCisgICAgcmV0dXJuIHY7
Cit9CisKIC8qCiAgKiBSZW5kZXp2b3VzIGJlZm9yZSB0YWtpbmcgYSBzY2hlZHVsaW5nIGRlY2lz
aW9uLgogICogQ2FsbGVkIHdpdGggc2NoZWR1bGUgbG9jayBoZWxkLCBzbyBhbGwgYWNjZXNzZXMg
dG8gdGhlIHJlbmRlenZvdXMgY291bnRlcgpAQCAtMTg1MCw2ICsxOTIwLDcgQEAgc3RhdGljIHN0
cnVjdCBzY2hlZF9pdGVtICpzY2hlZF93YWl0X3JlbmRlenZvdXNfaW4oc3RydWN0IHNjaGVkX2l0
ZW0gKnByZXYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBzX3RpbWVfdCBub3cpCiB7CiAgICAgc3RydWN0IHNjaGVkX2l0ZW0gKm5leHQ7CisgICAg
c3RydWN0IHZjcHUgKnY7CiAKICAgICBpZiAoICEtLXByZXYtPnJlbmRlenZvdXNfaW5fY250ICkK
ICAgICB7CkBAIC0xODU4LDggKzE5MjksMjggQEAgc3RhdGljIHN0cnVjdCBzY2hlZF9pdGVtICpz
Y2hlZF93YWl0X3JlbmRlenZvdXNfaW4oc3RydWN0IHNjaGVkX2l0ZW0gKnByZXYsCiAgICAgICAg
IHJldHVybiBuZXh0OwogICAgIH0KIAorICAgIHYgPSBpdGVtMnZjcHVfY3B1KHByZXYsIGNwdSk7
CiAgICAgd2hpbGUgKCBwcmV2LT5yZW5kZXp2b3VzX2luX2NudCApCiAgICAgeworICAgICAgICBp
ZiAoIHYgJiYgdi0+Zm9yY2VfY29udGV4dF9zd2l0Y2ggKQorICAgICAgICB7CisgICAgICAgICAg
ICBzdHJ1Y3QgdmNwdSAqdnByZXYgPSBjdXJyZW50OworCisgICAgICAgICAgICB2ID0gc2NoZWRf
Zm9yY2VfY29udGV4dF9zd2l0Y2godnByZXYsIHYsIGNwdSwgbm93KTsKKworICAgICAgICAgICAg
aWYgKCB2ICkKKyAgICAgICAgICAgIHsKKyAgICAgICAgICAgICAgICAvKiBXZSdsbCBjb21lIGJh
Y2sgYW5vdGhlciB0aW1lLCBzbyBhZGp1c3QgcmVuZGV6dm91c19pbl9jbnQuICovCisgICAgICAg
ICAgICAgICAgcHJldi0+cmVuZGV6dm91c19pbl9jbnQrKzsKKworICAgICAgICAgICAgICAgIHBj
cHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOworCisgICAgICAgICAgICAgICAgc2No
ZWRfY29udGV4dF9zd2l0Y2godnByZXYsIHYsIGZhbHNlLCBub3cpOworICAgICAgICAgICAgfQor
CisgICAgICAgICAgICB2ID0gaXRlbTJ2Y3B1X2NwdShwcmV2LCBjcHUpOworICAgICAgICB9CisK
ICAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CiAgICAgICAgIGNw
dV9yZWxheCgpOwogICAgICAgICBwY3B1X3NjaGVkdWxlX2xvY2tfaXJxKGNwdSk7CkBAIC0xODcw
LDEwICsxOTYxLDExIEBAIHN0YXRpYyBzdHJ1Y3Qgc2NoZWRfaXRlbSAqc2NoZWRfd2FpdF9yZW5k
ZXp2b3VzX2luKHN0cnVjdCBzY2hlZF9pdGVtICpwcmV2LAogCiBzdGF0aWMgdm9pZCBzY2hlZF9z
bGF2ZSh2b2lkKQogewotICAgIHN0cnVjdCB2Y3B1ICAgICAgICAgICp2cHJldiA9IGN1cnJlbnQ7
CisgICAgc3RydWN0IHZjcHUgICAgICAgICAgKnYsICp2cHJldiA9IGN1cnJlbnQ7CiAgICAgc3Ry
dWN0IHNjaGVkX2l0ZW0gICAgKnByZXYgPSB2cHJldi0+c2NoZWRfaXRlbSwgKm5leHQ7CiAgICAg
c190aW1lX3QgICAgICAgICAgICAgIG5vdzsKICAgICBzcGlubG9ja190ICAgICAgICAgICAqbG9j
azsKKyAgICBib29sICAgICAgICAgICAgICAgICAgZG9fc29mdGlycSA9IGZhbHNlOwogICAgIGlu
dCBjcHUgPSBzbXBfcHJvY2Vzc29yX2lkKCk7CiAKICAgICBBU1NFUlRfTk9UX0lOX0FUT01JQygp
OwpAQCAtMTg4Miw5ICsxOTc0LDI5IEBAIHN0YXRpYyB2b2lkIHNjaGVkX3NsYXZlKHZvaWQpCiAK
ICAgICBub3cgPSBOT1coKTsKIAorICAgIHYgPSBpdGVtMnZjcHVfY3B1KHByZXYsIGNwdSk7Cisg
ICAgaWYgKCB2ICYmIHYtPmZvcmNlX2NvbnRleHRfc3dpdGNoICkKKyAgICB7CisgICAgICAgIHYg
PSBzY2hlZF9mb3JjZV9jb250ZXh0X3N3aXRjaCh2cHJldiwgdiwgY3B1LCBub3cpOworCisgICAg
ICAgIGlmICggdiApCisgICAgICAgIHsKKyAgICAgICAgICAgIHBjcHVfc2NoZWR1bGVfdW5sb2Nr
X2lycShsb2NrLCBjcHUpOworCisgICAgICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJl
diwgdiwgZmFsc2UsIG5vdyk7CisgICAgICAgIH0KKworICAgICAgICBkb19zb2Z0aXJxID0gdHJ1
ZTsKKyAgICB9CisKICAgICBpZiAoICFwcmV2LT5yZW5kZXp2b3VzX2luX2NudCApCiAgICAgewog
ICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKKworICAgICAgICAv
KiBDaGVjayBmb3IgZmFpbGVkIGZvcmNlZCBjb250ZXh0IHN3aXRjaC4gKi8KKyAgICAgICAgaWYg
KCBkb19zb2Z0aXJxICkKKyAgICAgICAgICAgIHJhaXNlX3NvZnRpcnEoU0NIRURVTEVfU09GVElS
USk7CisKICAgICAgICAgcmV0dXJuOwogICAgIH0KIApkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUv
eGVuL3NjaGVkLWlmLmggYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaAppbmRleCA4OTgxZDQx
NjI5Li5mMTZkODFhYjRhIDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaAor
KysgYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaApAQCAtNzUsNiArNzUsMTEgQEAgc3RhdGlj
IGlubGluZSBib29sIGl0ZW1fcnVubmFibGUoY29uc3Qgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0p
CiAgICAgcmV0dXJuIGZhbHNlOwogfQogCitzdGF0aWMgaW5saW5lIGludCB2Y3B1X3J1bnN0YXRl
X2Jsb2NrZWQoc3RydWN0IHZjcHUgKnYpCit7CisgICAgcmV0dXJuICh2LT5wYXVzZV9mbGFncyAm
IFZQRl9ibG9ja2VkKSA/IFJVTlNUQVRFX2Jsb2NrZWQgOiBSVU5TVEFURV9vZmZsaW5lOworfQor
CiBzdGF0aWMgaW5saW5lIGJvb2wgaXRlbV9ydW5uYWJsZV9zdGF0ZShjb25zdCBzdHJ1Y3Qgc2No
ZWRfaXRlbSAqaXRlbSkKIHsKICAgICBzdHJ1Y3QgdmNwdSAqdjsKQEAgLTg0LDkgKzg5LDcgQEAg
c3RhdGljIGlubGluZSBib29sIGl0ZW1fcnVubmFibGVfc3RhdGUoY29uc3Qgc3RydWN0IHNjaGVk
X2l0ZW0gKml0ZW0pCiAgICAgewogICAgICAgICBydW5uYWJsZSA9IHZjcHVfcnVubmFibGUodik7
CiAKLSAgICAgICAgdi0+bmV3X3N0YXRlID0gcnVubmFibGUgPyBSVU5TVEFURV9ydW5uaW5nCi0g
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHYtPnBhdXNlX2ZsYWdzICYgVlBGX2Js
b2NrZWQpCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBSVU5TVEFURV9ibG9j
a2VkIDogUlVOU1RBVEVfb2ZmbGluZTsKKyAgICAgICAgdi0+bmV3X3N0YXRlID0gcnVubmFibGUg
PyBSVU5TVEFURV9ydW5uaW5nIDogdmNwdV9ydW5zdGF0ZV9ibG9ja2VkKHYpOwogCiAgICAgICAg
IGlmICggcnVubmFibGUgKQogICAgICAgICAgICAgcmV0ID0gdHJ1ZTsKZGlmZiAtLWdpdCBhL3hl
bi9pbmNsdWRlL3hlbi9zY2hlZC5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKaW5kZXggYjZh
MmZlMjhjYy4uNTYyOTYwMmRlNSAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgK
KysrIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKQEAgLTE4Niw2ICsxODYsOCBAQCBzdHJ1Y3Qg
dmNwdQogICAgIGJvb2wgICAgICAgICAgICAgaXNfcnVubmluZzsKICAgICAvKiBWQ1BVIHNob3Vs
ZCB3YWtlIGZhc3QgKGRvIG5vdCBkZWVwIHNsZWVwIHRoZSBDUFUpLiAqLwogICAgIGJvb2wgICAg
ICAgICAgICAgaXNfdXJnZW50OworICAgIC8qIFZDUFUgbXVzdCBjb250ZXh0X3N3aXRjaCB3aXRo
b3V0IHNjaGVkdWxpbmcgaXRlbS4gKi8KKyAgICBib29sICAgICAgICAgICAgIGZvcmNlX2NvbnRl
eHRfc3dpdGNoOwogCiAjaWZkZWYgVkNQVV9UUkFQX0xBU1QKICNkZWZpbmUgVkNQVV9UUkFQX05P
TkUgICAgMAotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJv
amVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hl
bi1kZXZlbA==

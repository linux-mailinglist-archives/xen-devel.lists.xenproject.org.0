Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id E7821AD5D2
	for <lists+xen-devel@lfdr.de>; Mon,  9 Sep 2019 11:35:58 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i7G3c-0006cY-V8; Mon, 09 Sep 2019 09:34:00 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=m/oR=XE=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1i7G3b-0006bs-Bx
 for xen-devel@lists.xenproject.org; Mon, 09 Sep 2019 09:33:59 +0000
X-Inumbo-ID: ea6b5b7e-d2e4-11e9-ac09-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id ea6b5b7e-d2e4-11e9-ac09-12813bfff9fa;
 Mon, 09 Sep 2019 09:33:44 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 4FE2EB660;
 Mon,  9 Sep 2019 09:33:43 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon,  9 Sep 2019 11:33:37 +0200
Message-Id: <20190909093339.7134-3-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190909093339.7134-1-jgross@suse.com>
References: <20190909093339.7134-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v3 2/4] xen/sched: remove cpu from pool0 before
 removing it
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VG9kYXkgYSBjcHUgd2hpY2ggaXMgcmVtb3ZlZCBmcm9tIHRoZSBzeXN0ZW0gaXMgdGFrZW4gZGly
ZWN0bHkgZnJvbQpQb29sMCB0byB0aGUgb2ZmbGluZSBzdGF0ZS4gVGhpcyB3aWxsIGNvbmZsaWN0
IHdpdGggdGhlIG5ldyBpZGxlCnNjaGVkdWxlciwgc28gcmVtb3ZlIGl0IGZyb20gUG9vbDAgZmly
c3QuIEFkZGl0aW9uYWxseSBhY2NlcHQgcmVtb3ZpbmcKYSBmcmVlIGNwdSBpbnN0ZWFkIG9mIHJl
cXVpcmluZyBpdCB0byBiZSBpbiBQb29sMC4KCkZvciB0aGUgcmVzdW1lIGZhaWxlZCBjYXNlIHdl
IG5lZWQgdG8gY2FsbCB0aGUgc2NoZWR1bGVyIGNvZGUgZm9yIHRoYXQKc2l0dWF0aW9uIGFmdGVy
IHRoZSBjcHVwb29sIGhhbmRsaW5nLCBzbyBtb3ZlIHRoZSBzY2hlZHVsZXIgY29kZSBpbnRvCmEg
ZnVuY3Rpb24gYW5kIGNhbGwgaXQgZnJvbSBjcHVwb29sX2NwdV9yZW1vdmVfZm9yY2VkKCkgYW5k
IHJlbW92ZSB0aGUKQ1BVX1JFU1VNRV9GQUlMRUQgY2FzZSBmcm9tIGNwdV9zY2hlZHVsZV9jYWxs
YmFjaygpLgoKTm90ZSB0aGF0IHdlIGFyZSBjYWxsaW5nIG5vdyBzY2hlZHVsZV9jcHVfc3dpdGNo
KCkgaW4gc3RvcF9tYWNoaW5lCmNvbnRleHQgc28gd2UgbmVlZCB0byBzd2l0Y2ggZnJvbSBzcGlu
bG9ja19pcnEgdG8gc3BpbmxvY2tfaXJxc2F2ZS4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jv
c3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tClYyOiByZW5hbWUgY3B1cG9vbF91bmFzc2lnbl9jcHVf
W2VwaXxwcm9dbG9ndWUoKSAoRGFyaW8gRmFnZ2lvbGkpCi0tLQogeGVuL2NvbW1vbi9jcHVwb29s
LmMgICAgICAgfCAxNzYgKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0t
LS0tCiB4ZW4vY29tbW9uL3NjaGVkdWxlLmMgICAgICB8ICAyNyArKysrLS0tCiB4ZW4vaW5jbHVk
ZS94ZW4vc2NoZWQtaWYuaCB8ICAgMiArCiAzIGZpbGVzIGNoYW5nZWQsIDEyOCBpbnNlcnRpb25z
KCspLCA3NyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL2NwdXBvb2wuYyBi
L3hlbi9jb21tb24vY3B1cG9vbC5jCmluZGV4IGNhZWE1YmQ4YjMuLjE1ZTcwMDRkZjQgMTAwNjQ0
Ci0tLSBhL3hlbi9jb21tb24vY3B1cG9vbC5jCisrKyBiL3hlbi9jb21tb24vY3B1cG9vbC5jCkBA
IC0yODIsMjIgKzI4MiwxNCBAQCBzdGF0aWMgaW50IGNwdXBvb2xfYXNzaWduX2NwdV9sb2NrZWQo
c3RydWN0IGNwdXBvb2wgKmMsIHVuc2lnbmVkIGludCBjcHUpCiAgICAgcmV0dXJuIDA7CiB9CiAK
LXN0YXRpYyBsb25nIGNwdXBvb2xfdW5hc3NpZ25fY3B1X2hlbHBlcih2b2lkICppbmZvKQorc3Rh
dGljIGludCBjcHVwb29sX3VuYXNzaWduX2NwdV9maW5pc2goc3RydWN0IGNwdXBvb2wgKmMpCiB7
CiAgICAgaW50IGNwdSA9IGNwdXBvb2xfbW92aW5nX2NwdTsKLSAgICBzdHJ1Y3QgY3B1cG9vbCAq
YyA9IGluZm87CiAgICAgc3RydWN0IGRvbWFpbiAqZDsKLSAgICBsb25nIHJldDsKLQotICAgIGNw
dXBvb2xfZHByaW50aygiY3B1cG9vbF91bmFzc2lnbl9jcHUocG9vbD0lZCxjcHU9JWQpXG4iLAot
ICAgICAgICAgICAgICAgICAgICBjcHVwb29sX2NwdV9tb3ZpbmctPmNwdXBvb2xfaWQsIGNwdSk7
CisgICAgaW50IHJldDsKIAotICAgIHNwaW5fbG9jaygmY3B1cG9vbF9sb2NrKTsKICAgICBpZiAo
IGMgIT0gY3B1cG9vbF9jcHVfbW92aW5nICkKLSAgICB7Ci0gICAgICAgIHJldCA9IC1FQUREUk5P
VEFWQUlMOwotICAgICAgICBnb3RvIG91dDsKLSAgICB9CisgICAgICAgIHJldHVybiAtRUFERFJO
T1RBVkFJTDsKIAogICAgIC8qCiAgICAgICogV2UgbmVlZCB0aGlzIGZvciBzY2FubmluZyB0aGUg
ZG9tYWluIGxpc3QsIGJvdGggaW4KQEAgLTMzMiwzOSArMzI0LDE5IEBAIHN0YXRpYyBsb25nIGNw
dXBvb2xfdW5hc3NpZ25fY3B1X2hlbHBlcih2b2lkICppbmZvKQogICAgICAgICBkb21haW5fdXBk
YXRlX25vZGVfYWZmaW5pdHkoZCk7CiAgICAgfQogICAgIHJjdV9yZWFkX3VubG9jaygmZG9tbGlz
dF9yZWFkX2xvY2spOwotb3V0OgotICAgIHNwaW5fdW5sb2NrKCZjcHVwb29sX2xvY2spOwotICAg
IGNwdXBvb2xfZHByaW50aygiY3B1cG9vbF91bmFzc2lnbl9jcHUgcmV0PSVsZFxuIiwgcmV0KTsK
KwogICAgIHJldHVybiByZXQ7CiB9CiAKLS8qCi0gKiB1bmFzc2lnbiBhIHNwZWNpZmljIGNwdSBm
cm9tIGEgY3B1cG9vbAotICogd2UgbXVzdCBiZSBzdXJlIG5vdCB0byBydW4gb24gdGhlIGNwdSB0
byBiZSB1bmFzc2lnbmVkISB0byBhY2hpZXZlIHRoaXMKLSAqIHRoZSBtYWluIGZ1bmN0aW9uYWxp
dHkgaXMgcGVyZm9ybWVkIHZpYSBjb250aW51ZV9oeXBlcmNhbGxfb25fY3B1IG9uIGEKLSAqIHNw
ZWNpZmljIGNwdS4KLSAqIGlmIHRoZSBjcHUgdG8gYmUgcmVtb3ZlZCBpcyB0aGUgbGFzdCBvbmUg
b2YgdGhlIGNwdXBvb2wgbm8gYWN0aXZlIGRvbWFpbgotICogbXVzdCBiZSBib3VuZCB0byB0aGUg
Y3B1cG9vbC4gZHlpbmcgZG9tYWlucyBhcmUgbW92ZWQgdG8gY3B1cG9vbDAgYXMgdGhleQotICog
bWlnaHQgYmUgem9tYmllcy4KLSAqIHBvc3NpYmxlIGZhaWx1cmVzOgotICogLSBsYXN0IGNwdSBh
bmQgc3RpbGwgYWN0aXZlIGRvbWFpbnMgaW4gY3B1cG9vbAotICogLSBjcHUganVzdCBiZWluZyB1
bnBsdWdnZWQKLSAqLwotc3RhdGljIGludCBjcHVwb29sX3VuYXNzaWduX2NwdShzdHJ1Y3QgY3B1
cG9vbCAqYywgdW5zaWduZWQgaW50IGNwdSkKK3N0YXRpYyBpbnQgY3B1cG9vbF91bmFzc2lnbl9j
cHVfc3RhcnQoc3RydWN0IGNwdXBvb2wgKmMsIHVuc2lnbmVkIGludCBjcHUpCiB7Ci0gICAgaW50
IHdvcmtfY3B1OwogICAgIGludCByZXQ7CiAgICAgc3RydWN0IGRvbWFpbiAqZDsKIAotICAgIGNw
dXBvb2xfZHByaW50aygiY3B1cG9vbF91bmFzc2lnbl9jcHUocG9vbD0lZCxjcHU9JWQpXG4iLAot
ICAgICAgICAgICAgICAgICAgICBjLT5jcHVwb29sX2lkLCBjcHUpOwotCiAgICAgc3Bpbl9sb2Nr
KCZjcHVwb29sX2xvY2spOwogICAgIHJldCA9IC1FQUREUk5PVEFWQUlMOwogICAgIGlmICggKGNw
dXBvb2xfbW92aW5nX2NwdSAhPSAtMSkgJiYgKGNwdSAhPSBjcHVwb29sX21vdmluZ19jcHUpICkK
ICAgICAgICAgZ290byBvdXQ7Ci0gICAgaWYgKCBjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgJmNwdXBv
b2xfbG9ja2VkX2NwdXMpICkKLSAgICAgICAgZ290byBvdXQ7CiAKICAgICByZXQgPSAwOwogICAg
IGlmICggIWNwdW1hc2tfdGVzdF9jcHUoY3B1LCBjLT5jcHVfdmFsaWQpICYmIChjcHUgIT0gY3B1
cG9vbF9tb3ZpbmdfY3B1KSApCkBAIC0zNzYsNyArMzQ4LDcgQEAgc3RhdGljIGludCBjcHVwb29s
X3VuYXNzaWduX2NwdShzdHJ1Y3QgY3B1cG9vbCAqYywgdW5zaWduZWQgaW50IGNwdSkKICAgICAg
ICAgcmN1X3JlYWRfbG9jaygmZG9tbGlzdF9yZWFkX2xvY2spOwogICAgICAgICBmb3JfZWFjaF9k
b21haW5faW5fY3B1cG9vbChkLCBjKQogICAgICAgICB7Ci0gICAgICAgICAgICBpZiAoICFkLT5p
c19keWluZyApCisgICAgICAgICAgICBpZiAoICFkLT5pc19keWluZyAmJiBzeXN0ZW1fc3RhdGUg
PT0gU1lTX1NUQVRFX2FjdGl2ZSApCiAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgcmV0
ID0gLUVCVVNZOwogICAgICAgICAgICAgICAgIGJyZWFrOwpAQCAtMzkzLDcgKzM2NSw1NyBAQCBz
dGF0aWMgaW50IGNwdXBvb2xfdW5hc3NpZ25fY3B1KHN0cnVjdCBjcHVwb29sICpjLCB1bnNpZ25l
ZCBpbnQgY3B1KQogICAgIGF0b21pY19pbmMoJmMtPnJlZmNudCk7CiAgICAgY3B1cG9vbF9jcHVf
bW92aW5nID0gYzsKICAgICBjcHVtYXNrX2NsZWFyX2NwdShjcHUsIGMtPmNwdV92YWxpZCk7CisK
K291dDoKKyAgICBzcGluX3VubG9jaygmY3B1cG9vbF9sb2NrKTsKKworICAgIHJldHVybiByZXQ7
Cit9CisKK3N0YXRpYyBsb25nIGNwdXBvb2xfdW5hc3NpZ25fY3B1X2hlbHBlcih2b2lkICppbmZv
KQoreworICAgIHN0cnVjdCBjcHVwb29sICpjID0gaW5mbzsKKyAgICBsb25nIHJldDsKKworICAg
IGNwdXBvb2xfZHByaW50aygiY3B1cG9vbF91bmFzc2lnbl9jcHUocG9vbD0lZCxjcHU9JWQpXG4i
LAorICAgICAgICAgICAgICAgICAgICBjcHVwb29sX2NwdV9tb3ZpbmctPmNwdXBvb2xfaWQsIGNw
dXBvb2xfbW92aW5nX2NwdSk7CisgICAgc3Bpbl9sb2NrKCZjcHVwb29sX2xvY2spOworCisgICAg
cmV0ID0gY3B1cG9vbF91bmFzc2lnbl9jcHVfZmluaXNoKGMpOworCiAgICAgc3Bpbl91bmxvY2so
JmNwdXBvb2xfbG9jayk7CisgICAgY3B1cG9vbF9kcHJpbnRrKCJjcHVwb29sX3VuYXNzaWduX2Nw
dSByZXQ9JWxkXG4iLCByZXQpOworCisgICAgcmV0dXJuIHJldDsKK30KKworLyoKKyAqIHVuYXNz
aWduIGEgc3BlY2lmaWMgY3B1IGZyb20gYSBjcHVwb29sCisgKiB3ZSBtdXN0IGJlIHN1cmUgbm90
IHRvIHJ1biBvbiB0aGUgY3B1IHRvIGJlIHVuYXNzaWduZWQhIHRvIGFjaGlldmUgdGhpcworICog
dGhlIG1haW4gZnVuY3Rpb25hbGl0eSBpcyBwZXJmb3JtZWQgdmlhIGNvbnRpbnVlX2h5cGVyY2Fs
bF9vbl9jcHUgb24gYQorICogc3BlY2lmaWMgY3B1LgorICogaWYgdGhlIGNwdSB0byBiZSByZW1v
dmVkIGlzIHRoZSBsYXN0IG9uZSBvZiB0aGUgY3B1cG9vbCBubyBhY3RpdmUgZG9tYWluCisgKiBt
dXN0IGJlIGJvdW5kIHRvIHRoZSBjcHVwb29sLiBkeWluZyBkb21haW5zIGFyZSBtb3ZlZCB0byBj
cHVwb29sMCBhcyB0aGV5CisgKiBtaWdodCBiZSB6b21iaWVzLgorICogcG9zc2libGUgZmFpbHVy
ZXM6CisgKiAtIGxhc3QgY3B1IGFuZCBzdGlsbCBhY3RpdmUgZG9tYWlucyBpbiBjcHVwb29sCisg
KiAtIGNwdSBqdXN0IGJlaW5nIHVucGx1Z2dlZAorICovCitzdGF0aWMgaW50IGNwdXBvb2xfdW5h
c3NpZ25fY3B1KHN0cnVjdCBjcHVwb29sICpjLCB1bnNpZ25lZCBpbnQgY3B1KQoreworICAgIGlu
dCB3b3JrX2NwdTsKKyAgICBpbnQgcmV0OworCisgICAgY3B1cG9vbF9kcHJpbnRrKCJjcHVwb29s
X3VuYXNzaWduX2NwdShwb29sPSVkLGNwdT0lZClcbiIsCisgICAgICAgICAgICAgICAgICAgIGMt
PmNwdXBvb2xfaWQsIGNwdSk7CisKKyAgICByZXQgPSBjcHVwb29sX3VuYXNzaWduX2NwdV9zdGFy
dChjLCBjcHUpOworICAgIGlmICggcmV0ICkKKyAgICB7CisgICAgICAgIGNwdXBvb2xfZHByaW50
aygiY3B1cG9vbF91bmFzc2lnbl9jcHUocG9vbD0lZCxjcHU9JWQpIHJldCAlZFxuIiwKKyAgICAg
ICAgICAgICAgICAgICAgICAgIGMtPmNwdXBvb2xfaWQsIGNwdSwgcmV0KTsKKyAgICAgICAgcmV0
dXJuIHJldDsKKyAgICB9CiAKICAgICB3b3JrX2NwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKICAg
ICBpZiAoIHdvcmtfY3B1ID09IGNwdSApCkBAIC00MDMsMTIgKzQyNSw2IEBAIHN0YXRpYyBpbnQg
Y3B1cG9vbF91bmFzc2lnbl9jcHUoc3RydWN0IGNwdXBvb2wgKmMsIHVuc2lnbmVkIGludCBjcHUp
CiAgICAgICAgICAgICB3b3JrX2NwdSA9IGNwdW1hc2tfbmV4dChjcHUsIGNwdXBvb2wwLT5jcHVf
dmFsaWQpOwogICAgIH0KICAgICByZXR1cm4gY29udGludWVfaHlwZXJjYWxsX29uX2NwdSh3b3Jr
X2NwdSwgY3B1cG9vbF91bmFzc2lnbl9jcHVfaGVscGVyLCBjKTsKLQotb3V0OgotICAgIHNwaW5f
dW5sb2NrKCZjcHVwb29sX2xvY2spOwotICAgIGNwdXBvb2xfZHByaW50aygiY3B1cG9vbF91bmFz
c2lnbl9jcHUocG9vbD0lZCxjcHU9JWQpIHJldCAlZFxuIiwKLSAgICAgICAgICAgICAgICAgICAg
Yy0+Y3B1cG9vbF9pZCwgY3B1LCByZXQpOwotICAgIHJldHVybiByZXQ7CiB9CiAKIC8qCkBAIC00
OTIsMzAgKzUwOCw1NCBAQCBzdGF0aWMgaW50IGNwdXBvb2xfY3B1X2FkZCh1bnNpZ25lZCBpbnQg
Y3B1KQogfQogCiAvKgotICogQ2FsbGVkIHRvIHJlbW92ZSBhIENQVSBmcm9tIGEgcG9vbC4gVGhl
IENQVSBpcyBsb2NrZWQsIHRvIGZvcmJpZCByZW1vdmluZwotICogaXQgZnJvbSBwb29sMC4gSW4g
ZmFjdCwgaWYgd2Ugd2FudCB0byBob3QtdW5wbHVnIGEgQ1BVLCBpdCBtdXN0IGJlbG9uZyB0bwot
ICogcG9vbDAsIG9yIHdlIGZhaWwuCisgKiBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiBzdG9w
X21hY2hpbmUgY29udGV4dCwgc28gd2UgY2FuIGJlIHN1cmUgbm8KKyAqIG5vbi1pZGxlIHZjcHUg
aXMgYWN0aXZlIG9uIHRoZSBzeXN0ZW0uCiAgKi8KLXN0YXRpYyBpbnQgY3B1cG9vbF9jcHVfcmVt
b3ZlKHVuc2lnbmVkIGludCBjcHUpCitzdGF0aWMgdm9pZCBjcHVwb29sX2NwdV9yZW1vdmUodW5z
aWduZWQgaW50IGNwdSkKIHsKLSAgICBpbnQgcmV0ID0gLUVOT0RFVjsKKyAgICBpbnQgcmV0Owog
Ci0gICAgc3Bpbl9sb2NrKCZjcHVwb29sX2xvY2spOworICAgIEFTU0VSVChpc19pZGxlX3ZjcHUo
Y3VycmVudCkpOwogCi0gICAgaWYgKCBjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgY3B1cG9vbDAtPmNw
dV92YWxpZCkgKQorICAgIGlmICggIWNwdW1hc2tfdGVzdF9jcHUoY3B1LCAmY3B1cG9vbF9mcmVl
X2NwdXMpICkKICAgICB7Ci0gICAgICAgIC8qCi0gICAgICAgICAqIElmIHdlIGFyZSBub3Qgc3Vz
cGVuZGluZywgd2UgYXJlIGhvdC11bnBsdWdnaW5nIGNwdSwgYW5kIHRoYXQgaXMKLSAgICAgICAg
ICogYWxsb3dlZCBvbmx5IGZvciBDUFVzIGluIHBvb2wwLgotICAgICAgICAgKi8KLSAgICAgICAg
Y3B1bWFza19jbGVhcl9jcHUoY3B1LCBjcHVwb29sMC0+Y3B1X3ZhbGlkKTsKLSAgICAgICAgcmV0
ID0gMDsKKyAgICAgICAgcmV0ID0gY3B1cG9vbF91bmFzc2lnbl9jcHVfZmluaXNoKGNwdXBvb2ww
KTsKKyAgICAgICAgQlVHX09OKHJldCk7CiAgICAgfQorfQogCi0gICAgaWYgKCAhcmV0ICkKKy8q
CisgKiBDYWxsZWQgYmVmb3JlIGEgQ1BVIGlzIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgc3lzdGVt
LgorICogUmVtb3ZpbmcgYSBDUFUgaXMgYWxsb3dlZCBmb3IgZnJlZSBDUFVzIG9yIENQVXMgaW4g
UG9vbC0wICh0aG9zZSBhcmUgbW92ZWQKKyAqIHRvIGZyZWUgY3B1cyBhY3R1YWxseSBiZWZvcmUg
cmVtb3ZpbmcgdGhlbSkuCisgKiBUaGUgQ1BVIGlzIGxvY2tlZCwgdG8gZm9yYmlkIGFkZGluZyBp
dCBhZ2FpbiB0byBhbm90aGVyIGNwdXBvb2wuCisgKi8KK3N0YXRpYyBpbnQgY3B1cG9vbF9jcHVf
cmVtb3ZlX3Byb2xvZ3VlKHVuc2lnbmVkIGludCBjcHUpCit7CisgICAgaW50IHJldCA9IDA7CisK
KyAgICBzcGluX2xvY2soJmNwdXBvb2xfbG9jayk7CisKKyAgICBpZiAoIGNwdW1hc2tfdGVzdF9j
cHUoY3B1LCAmY3B1cG9vbF9sb2NrZWRfY3B1cykgKQorICAgICAgICByZXQgPSAtRUJVU1k7Cisg
ICAgZWxzZQogICAgICAgICBjcHVtYXNrX3NldF9jcHUoY3B1LCAmY3B1cG9vbF9sb2NrZWRfY3B1
cyk7CisKICAgICBzcGluX3VubG9jaygmY3B1cG9vbF9sb2NrKTsKIAorICAgIGlmICggcmV0ICkK
KyAgICAgICAgcmV0dXJuICByZXQ7CisKKyAgICBpZiAoIGNwdW1hc2tfdGVzdF9jcHUoY3B1LCBj
cHVwb29sMC0+Y3B1X3ZhbGlkKSApCisgICAgeworICAgICAgICAvKiBDcHVwb29sMCBpcyBwb3B1
bGF0ZWQgb25seSBhZnRlciBhbGwgY3B1cyBhcmUgdXAuICovCisgICAgICAgIEFTU0VSVChzeXN0
ZW1fc3RhdGUgPT0gU1lTX1NUQVRFX2FjdGl2ZSk7CisKKyAgICAgICAgcmV0ID0gY3B1cG9vbF91
bmFzc2lnbl9jcHVfc3RhcnQoY3B1cG9vbDAsIGNwdSk7CisgICAgfQorICAgIGVsc2UgaWYgKCAh
Y3B1bWFza190ZXN0X2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1cykgKQorICAgICAgICByZXQg
PSAtRU5PREVWOworCiAgICAgcmV0dXJuIHJldDsKIH0KIApAQCAtNTIzLDEzICs1NjMsMTMgQEAg
c3RhdGljIGludCBjcHVwb29sX2NwdV9yZW1vdmUodW5zaWduZWQgaW50IGNwdSkKICAqIENhbGxl
ZCBkdXJpbmcgcmVzdW1lIGZvciBhbGwgY3B1cyB3aGljaCBkaWRuJ3QgY29tZSB1cCBhZ2Fpbi4g
VGhlIGNwdSBtdXN0CiAgKiBiZSByZW1vdmVkIGZyb20gdGhlIGNwdXBvb2wgaXQgaXMgYXNzaWdu
ZWQgdG8uIEluIGNhc2UgYSBjcHVwb29sIHdpbGwgYmUKICAqIGxlZnQgd2l0aG91dCBjcHUgd2Ug
bW92ZSBhbGwgZG9tYWlucyBvZiB0aGF0IGNwdXBvb2wgdG8gY3B1cG9vbDAuCisgKiBBcyB3ZSBh
cmUgY2FsbGVkIHdpdGggYWxsIGRvbWFpbnMgc3RpbGwgZnJvemVuIHRoZXJlIGlzIG5vIG5lZWQg
dG8gdGFrZSB0aGUKKyAqIGNwdXBvb2wgbG9jayBoZXJlLgogICovCiBzdGF0aWMgdm9pZCBjcHVw
b29sX2NwdV9yZW1vdmVfZm9yY2VkKHVuc2lnbmVkIGludCBjcHUpCiB7CiAgICAgc3RydWN0IGNw
dXBvb2wgKipjOwotICAgIHN0cnVjdCBkb21haW4gKmQ7Ci0KLSAgICBzcGluX2xvY2soJmNwdXBv
b2xfbG9jayk7CisgICAgaW50IHJldDsKIAogICAgIGlmICggY3B1bWFza190ZXN0X2NwdShjcHUs
ICZjcHVwb29sX2ZyZWVfY3B1cykgKQogICAgICAgICBjcHVtYXNrX2NsZWFyX2NwdShjcHUsICZj
cHVwb29sX2ZyZWVfY3B1cyk7CkBAIC01MzksMTkgKzU3OSwxMyBAQCBzdGF0aWMgdm9pZCBjcHVw
b29sX2NwdV9yZW1vdmVfZm9yY2VkKHVuc2lnbmVkIGludCBjcHUpCiAgICAgICAgIHsKICAgICAg
ICAgICAgIGlmICggY3B1bWFza190ZXN0X2NwdShjcHUsICgqYyktPmNwdV92YWxpZCkgKQogICAg
ICAgICAgICAgewotICAgICAgICAgICAgICAgIGNwdW1hc2tfY2xlYXJfY3B1KGNwdSwgKCpjKS0+
Y3B1X3ZhbGlkKTsKLSAgICAgICAgICAgICAgICBpZiAoIGNwdW1hc2tfd2VpZ2h0KCgqYyktPmNw
dV92YWxpZCkgPT0gMCApCi0gICAgICAgICAgICAgICAgewotICAgICAgICAgICAgICAgICAgICBp
ZiAoICpjID09IGNwdXBvb2wwICkKLSAgICAgICAgICAgICAgICAgICAgICAgIHBhbmljKCJObyBj
cHUgbGVmdCBpbiBjcHVwb29sMFxuIik7Ci0gICAgICAgICAgICAgICAgICAgIGZvcl9lYWNoX2Rv
bWFpbl9pbl9jcHVwb29sKGQsICpjKQotICAgICAgICAgICAgICAgICAgICAgICAgY3B1cG9vbF9t
b3ZlX2RvbWFpbl9sb2NrZWQoZCwgY3B1cG9vbDApOwotICAgICAgICAgICAgICAgIH0KKyAgICAg
ICAgICAgICAgICByZXQgPSBjcHVwb29sX3VuYXNzaWduX2NwdSgqYywgY3B1KTsKKyAgICAgICAg
ICAgICAgICBCVUdfT04ocmV0KTsKICAgICAgICAgICAgIH0KICAgICAgICAgfQogICAgIH0KIAot
ICAgIHNwaW5fdW5sb2NrKCZjcHVwb29sX2xvY2spOworICAgIHNjaGVkX3JtX2NwdShjcHUpOwog
fQogCiAvKgpAQCAtNjE5LDcgKzY1Myw4IEBAIGludCBjcHVwb29sX2RvX3N5c2N0bChzdHJ1Y3Qg
eGVuX3N5c2N0bF9jcHVwb29sX29wICpvcCkKICAgICAgICAgaWYgKCBjcHUgPj0gbnJfY3B1X2lk
cyApCiAgICAgICAgICAgICBnb3RvIGFkZGNwdV9vdXQ7CiAgICAgICAgIHJldCA9IC1FTk9ERVY7
Ci0gICAgICAgIGlmICggIWNwdW1hc2tfdGVzdF9jcHUoY3B1LCAmY3B1cG9vbF9mcmVlX2NwdXMp
ICkKKyAgICAgICAgaWYgKCAhY3B1bWFza190ZXN0X2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1
cykgfHwKKyAgICAgICAgICAgICBjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgJmNwdXBvb2xfbG9ja2Vk
X2NwdXMpICkKICAgICAgICAgICAgIGdvdG8gYWRkY3B1X291dDsKICAgICAgICAgYyA9IGNwdXBv
b2xfZmluZF9ieV9pZChvcC0+Y3B1cG9vbF9pZCk7CiAgICAgICAgIHJldCA9IC1FTk9FTlQ7CkBA
IC03NDYsNyArNzgxLDEyIEBAIHN0YXRpYyBpbnQgY3B1X2NhbGxiYWNrKAogICAgIGNhc2UgQ1BV
X0RPV05fUFJFUEFSRToKICAgICAgICAgLyogU3VzcGVuZC9SZXN1bWUgZG9uJ3QgY2hhbmdlIGFz
c2lnbm1lbnRzIG9mIGNwdXMgdG8gY3B1cG9vbHMuICovCiAgICAgICAgIGlmICggc3lzdGVtX3N0
YXRlIDw9IFNZU19TVEFURV9hY3RpdmUgKQotICAgICAgICAgICAgcmMgPSBjcHVwb29sX2NwdV9y
ZW1vdmUoY3B1KTsKKyAgICAgICAgICAgIHJjID0gY3B1cG9vbF9jcHVfcmVtb3ZlX3Byb2xvZ3Vl
KGNwdSk7CisgICAgICAgIGJyZWFrOworICAgIGNhc2UgQ1BVX0RZSU5HOgorICAgICAgICAvKiBT
dXNwZW5kL1Jlc3VtZSBkb24ndCBjaGFuZ2UgYXNzaWdubWVudHMgb2YgY3B1cyB0byBjcHVwb29s
cy4gKi8KKyAgICAgICAgaWYgKCBzeXN0ZW1fc3RhdGUgPD0gU1lTX1NUQVRFX2FjdGl2ZSApCisg
ICAgICAgICAgICBjcHVwb29sX2NwdV9yZW1vdmUoY3B1KTsKICAgICAgICAgYnJlYWs7CiAgICAg
Y2FzZSBDUFVfUkVTVU1FX0ZBSUxFRDoKICAgICAgICAgY3B1cG9vbF9jcHVfcmVtb3ZlX2ZvcmNl
ZChjcHUpOwpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9z
Y2hlZHVsZS5jCmluZGV4IDdiNzE1ODE3NTYuLjkzMTY0YzY0ZjYgMTAwNjQ0Ci0tLSBhL3hlbi9j
b21tb24vc2NoZWR1bGUuYworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTE2NTQsNiAr
MTY1NCwyMCBAQCBzdGF0aWMgdm9pZCBjcHVfc2NoZWR1bGVfZG93bih1bnNpZ25lZCBpbnQgY3B1
KQogICAgIGtpbGxfdGltZXIoJnNkLT5zX3RpbWVyKTsKIH0KIAordm9pZCBzY2hlZF9ybV9jcHUo
dW5zaWduZWQgaW50IGNwdSkKK3sKKyAgICBpbnQgcmM7CisgICAgc3RydWN0IHNjaGVkdWxlX2Rh
dGEgKnNkID0gJnBlcl9jcHUoc2NoZWR1bGVfZGF0YSwgY3B1KTsKKyAgICBzdHJ1Y3Qgc2NoZWR1
bGVyICpzY2hlZCA9IHBlcl9jcHUoc2NoZWR1bGVyLCBjcHUpOworCisgICAgcmN1X3JlYWRfbG9j
aygmZG9tbGlzdF9yZWFkX2xvY2spOworICAgIHJjID0gY3B1X2Rpc2FibGVfc2NoZWR1bGVyKGNw
dSk7CisgICAgQlVHX09OKHJjKTsKKyAgICByY3VfcmVhZF91bmxvY2soJmRvbWxpc3RfcmVhZF9s
b2NrKTsKKyAgICBzY2hlZF9kZWluaXRfcGRhdGEoc2NoZWQsIHNkLT5zY2hlZF9wcml2LCBjcHUp
OworICAgIGNwdV9zY2hlZHVsZV9kb3duKGNwdSk7Cit9CisKIHN0YXRpYyBpbnQgY3B1X3NjaGVk
dWxlX2NhbGxiYWNrKAogICAgIHN0cnVjdCBub3RpZmllcl9ibG9jayAqbmZiLCB1bnNpZ25lZCBs
b25nIGFjdGlvbiwgdm9pZCAqaGNwdSkKIHsKQEAgLTE3MDksMTYgKzE3MjMsMTAgQEAgc3RhdGlj
IGludCBjcHVfc2NoZWR1bGVfY2FsbGJhY2soCiAgICAgICAgIHJjID0gY3B1X2Rpc2FibGVfc2No
ZWR1bGVyX2NoZWNrKGNwdSk7CiAgICAgICAgIHJjdV9yZWFkX3VubG9jaygmZG9tbGlzdF9yZWFk
X2xvY2spOwogICAgICAgICBicmVhazsKLSAgICBjYXNlIENQVV9SRVNVTUVfRkFJTEVEOgogICAg
IGNhc2UgQ1BVX0RFQUQ6CiAgICAgICAgIGlmICggc3lzdGVtX3N0YXRlID09IFNZU19TVEFURV9z
dXNwZW5kICkKICAgICAgICAgICAgIGJyZWFrOwotICAgICAgICByY3VfcmVhZF9sb2NrKCZkb21s
aXN0X3JlYWRfbG9jayk7Ci0gICAgICAgIHJjID0gY3B1X2Rpc2FibGVfc2NoZWR1bGVyKGNwdSk7
Ci0gICAgICAgIEJVR19PTihyYyk7Ci0gICAgICAgIHJjdV9yZWFkX3VubG9jaygmZG9tbGlzdF9y
ZWFkX2xvY2spOwotICAgICAgICBzY2hlZF9kZWluaXRfcGRhdGEoc2NoZWQsIHNkLT5zY2hlZF9w
cml2LCBjcHUpOwotICAgICAgICBjcHVfc2NoZWR1bGVfZG93bihjcHUpOworICAgICAgICBzY2hl
ZF9ybV9jcHUoY3B1KTsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBDUFVfVVBfQ0FOQ0VMRUQ6
CiAgICAgICAgIGlmICggc3lzdGVtX3N0YXRlICE9IFNZU19TVEFURV9yZXN1bWUgKQpAQCAtMTg0
MSw2ICsxODQ5LDcgQEAgaW50IHNjaGVkdWxlX2NwdV9zd2l0Y2godW5zaWduZWQgaW50IGNwdSwg
c3RydWN0IGNwdXBvb2wgKmMpCiAgICAgc3RydWN0IGNwdXBvb2wgKm9sZF9wb29sID0gcGVyX2Nw
dShjcHVwb29sLCBjcHUpOwogICAgIHN0cnVjdCBzY2hlZHVsZV9kYXRhICpzZCA9ICZwZXJfY3B1
KHNjaGVkdWxlX2RhdGEsIGNwdSk7CiAgICAgc3BpbmxvY2tfdCAqb2xkX2xvY2ssICpuZXdfbG9j
azsKKyAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwogCiAgICAgLyoKICAgICAgKiBwQ1BVcyBvbmx5
IG1vdmUgZnJvbSBhIHZhbGlkIGNwdXBvb2wgdG8gZnJlZSAoaS5lLiwgb3V0IG9mIGFueSBwb29s
KSwKQEAgLTE4OTUsNyArMTkwNCw3IEBAIGludCBzY2hlZHVsZV9jcHVfc3dpdGNoKHVuc2lnbmVk
IGludCBjcHUsIHN0cnVjdCBjcHVwb29sICpjKQogICAgICAqIHRoYXQgdGhlIGxvY2sgaXRzZWxm
IGNoYW5nZWQsIGFuZCByZXRyeSBhY3F1aXJpbmcgdGhlIG5ldyBvbmUgKHdoaWNoCiAgICAgICog
d2lsbCBiZSB0aGUgY29ycmVjdCwgcmVtYXBwZWQgb25lLCBhdCB0aGF0IHBvaW50KS4KICAgICAg
Ki8KLSAgICBvbGRfbG9jayA9IHBjcHVfc2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKKyAgICBvbGRf
bG9jayA9IHBjcHVfc2NoZWR1bGVfbG9ja19pcnFzYXZlKGNwdSwgJmZsYWdzKTsKIAogICAgIHZw
cml2X29sZCA9IGlkbGUtPnNjaGVkX3ByaXY7CiAgICAgcHByaXZfb2xkID0gc2QtPnNjaGVkX3By
aXY7CkBAIC0xOTEzLDcgKzE5MjIsNyBAQCBpbnQgc2NoZWR1bGVfY3B1X3N3aXRjaCh1bnNpZ25l
ZCBpbnQgY3B1LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICBzZC0+c2NoZWR1bGVfbG9jayA9IG5l
d19sb2NrOwogCiAgICAgLyogX05vdF8gcGNwdV9zY2hlZHVsZV91bmxvY2soKTogc2NoZWR1bGVf
bG9jayBtYXkgaGF2ZSBjaGFuZ2VkISAqLwotICAgIHNwaW5fdW5sb2NrX2lycShvbGRfbG9jayk7
CisgICAgc3Bpbl91bmxvY2tfaXJxcmVzdG9yZShvbGRfbG9jaywgZmxhZ3MpOwogCiAgICAgc2No
ZWRfZG9fdGlja19yZXN1bWUobmV3X29wcywgY3B1KTsKIApkaWZmIC0tZ2l0IGEveGVuL2luY2x1
ZGUveGVuL3NjaGVkLWlmLmggYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaAppbmRleCBkODJl
YWQ1ODZhLi5kYzI1NWIwNjRiIDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYu
aAorKysgYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaApAQCAtNDM3LDQgKzQzNyw2IEBAIGFm
ZmluaXR5X2JhbGFuY2VfY3B1bWFzayhjb25zdCBzdHJ1Y3QgdmNwdSAqdiwgaW50IHN0ZXAsIGNw
dW1hc2tfdCAqbWFzaykKICAgICAgICAgY3B1bWFza19jb3B5KG1hc2ssIHYtPmNwdV9oYXJkX2Fm
ZmluaXR5KTsKIH0KIAordm9pZCBzY2hlZF9ybV9jcHUodW5zaWduZWQgaW50IGNwdSk7CisKICNl
bmRpZiAvKiBfX1hFTl9TQ0hFRF9JRl9IX18gKi8KLS0gCjIuMTYuNAoKCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QK
WGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5v
cmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

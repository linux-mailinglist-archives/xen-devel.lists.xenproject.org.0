Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id C6AE164695
	for <lists+xen-devel@lfdr.de>; Wed, 10 Jul 2019 14:59:02 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hlC8h-0002vG-Hc; Wed, 10 Jul 2019 12:56:03 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=dFy6=VH=amazon.de=prvs=087c1bc88=nmanthey@srs-us1.protection.inumbo.net>)
 id 1hlC8g-0002vA-1z
 for xen-devel@lists.xenproject.org; Wed, 10 Jul 2019 12:56:02 +0000
X-Inumbo-ID: 102a4cba-a312-11e9-94a0-833051f95132
Received: from smtp-fw-6002.amazon.com (unknown [52.95.49.90])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 102a4cba-a312-11e9-94a0-833051f95132;
 Wed, 10 Jul 2019 12:55:58 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=amazon.de; i=@amazon.de; q=dns/txt; s=amazon201209;
 t=1562763358; x=1594299358;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version;
 bh=XBzH0W3OdXm3NeZI6TTckd79ApqaMOflFUazB8yVjO4=;
 b=nq/Q+T1rMNgIfToProzyKKureZGcpEhOlIMZn6OL4P3kNQmeV00iwMFo
 bKRYZdEOJeGSgku/UCYEnEF3NgszMk35mzF0muAbKFrpGIDAMPldCL46t
 wl4RfV/lW7CEe6zQZ4ZYXQ6EVVw4o+pilSgE0O1NN4n43PrfBYGV7pnWa Q=;
X-IronPort-AV: E=Sophos;i="5.62,474,1554768000"; d="scan'208";a="410093182"
Received: from iad6-co-svc-p1-lb1-vlan3.amazon.com (HELO
 email-inbound-relay-1d-f273de60.us-east-1.amazon.com) ([10.124.125.6])
 by smtp-border-fw-out-6002.iad6.amazon.com with ESMTP;
 10 Jul 2019 12:55:57 +0000
Received: from EX13MTAUEB001.ant.amazon.com
 (iad55-ws-svc-p15-lb9-vlan2.iad.amazon.com [10.40.159.162])
 by email-inbound-relay-1d-f273de60.us-east-1.amazon.com (Postfix) with ESMTPS
 id 368ACA25DA; Wed, 10 Jul 2019 12:55:53 +0000 (UTC)
Received: from EX13D08UEB001.ant.amazon.com (10.43.60.245) by
 EX13MTAUEB001.ant.amazon.com (10.43.60.129) with Microsoft SMTP Server (TLS)
 id 15.0.1367.3; Wed, 10 Jul 2019 12:55:38 +0000
Received: from EX13MTAUEB001.ant.amazon.com (10.43.60.96) by
 EX13D08UEB001.ant.amazon.com (10.43.60.245) with Microsoft SMTP Server (TLS)
 id 15.0.1367.3; Wed, 10 Jul 2019 12:55:37 +0000
Received: from uc1a35a69ae4659.ant.amazon.com (10.95.156.35) by
 mail-relay.amazon.com (10.43.60.129) with Microsoft SMTP Server id
 15.0.1367.3 via Frontend Transport; Wed, 10 Jul 2019 12:55:34 +0000
From: Norbert Manthey <nmanthey@amazon.de>
To: <xen-devel@lists.xenproject.org>
Date: Wed, 10 Jul 2019 14:54:36 +0200
Message-ID: <1562763277-11674-2-git-send-email-nmanthey@amazon.de>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <1562763277-11674-1-git-send-email-nmanthey@amazon.de>
References: <1562763277-11674-1-git-send-email-nmanthey@amazon.de>
MIME-Version: 1.0
Precedence: Bulk
Subject: [Xen-devel] [PATCH L1TF MDS GT v2 1/2] common/grant_table: harden
 bound accesses
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wei.liu2@citrix.com>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Ian
 Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Martin Pohlack <mpohlack@amazon.de>, Pawel Wieczorkiewicz <wipawel@amazon.de>,
 Julien Grall <julien.grall@arm.com>, David Woodhouse <dwmw@amazon.co.uk>,
 Jan Beulich <jbeulich@suse.com>, Martin Mazein <amazein@amazon.de>,
 Bjoern Doebel <doebel@amazon.de>, Norbert Manthey <nmanthey@amazon.de>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

R3Vlc3RzIGNhbiBpc3N1ZSBncmFudCB0YWJsZSBvcGVyYXRpb25zIGFuZCBwcm92aWRlIGd1ZXN0
IGNvbnRyb2xsZWQKZGF0YSB0byB0aGVtLiBUaGlzIGRhdGEgaXMgdXNlZCBhcyBpbmRleCBmb3Ig
bWVtb3J5IGxvYWRzIGFmdGVyIGJvdW5kCmNoZWNrcyBoYXZlIGJlZW4gZG9uZS4gVG8gYXZvaWQg
c3BlY3VsYXRpdmUgb3V0LW9mLWJvdW5kIGFjY2Vzc2VzLCB3ZQp1c2UgdGhlIGFycmF5X2luZGV4
X25vc3BlYyBtYWNybyB3aGVyZSBhcHBsaWNhYmxlLCBvciB0aGUgbWFjcm8KYmxvY2tfc3BlY3Vs
YXRpb24uIE5vdGUsIHRoZSBibG9ja19zcGVjdWxhdGlvbiBtYWNybyBpcyB1c2VkIG9uIGFsbApw
YXRoIGluIHNoYXJlZF9lbnRyeV9oZWFkZXIgYW5kIG5yX2dyYW50X2VudHJpZXMuIFRoaXMgd2F5
LCBhZnRlciBhCmNhbGwgdG8gc3VjaCBhIGZ1bmN0aW9uLCBhbGwgYm91bmQgY2hlY2tzIHRoYXQg
aGFwcGVuZWQgYmVmb3JlIGJlY29tZQphcmNoaXRlY3R1cmFsIHZpc2libGUsIHNvIHRoYXQgbm8g
YWRkaXRpb25hbCBwcm90ZWN0aW9uIGlzIHJlcXVpcmVkCmZvciBjb3JyZXNwb25kaW5nIGFycmF5
IGFjY2Vzc2VzLiBBcyB0aGUgd2F5IHdlIGludHJvZHVjZSBhbiBsZmVuY2UKaW5zdHJ1Y3Rpb24g
bWlnaHQgYWxsb3cgdGhlIGNvbXBpbGVyIHRvIHJlbG9hZCBjZXJ0YWluIHZhbHVlcyBmcm9tCm1l
bW9yeSBtdWx0aXBsZSB0aW1lcywgd2UgdHJ5IHRvIGF2b2lkIHNwZWN1bGF0aXZlbHkgY29udGlu
dWluZwpleGVjdXRpb24gd2l0aCBzdGFsZSByZWdpc3RlciBkYXRhIGJ5IG1vdmluZyByZWxldmFu
dCBkYXRhIGludG8KZnVuY3Rpb24gbG9jYWwgdmFyaWFibGVzLgoKU3BlY3VsYXRpdmUgZXhlY3V0
aW9uIGlzIG5vdCBibG9ja2VkIGluIGNhc2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcKcHJvcGVydGll
cyBpcyB0cnVlOgogLSBwYXRoIGNhbm5vdCBiZSB0cmlnZ2VyZWQgYnkgdGhlIGd1ZXN0CiAtIHBh
dGggZG9lcyBub3QgcmV0dXJuIHRvIHRoZSBndWVzdAogLSBwYXRoIGRvZXMgbm90IHJlc3VsdCBp
biBhbiBvdXQtb2YtYm91bmQgYWNjZXNzCiAtIHBhdGggY2Fubm90IGJlIGV4ZWN1dGVkIHJlcGVh
dGVkbHkKT25seSB0aGUgY29tYmluYXRpb24gb2YgdGhlIGFib3ZlIHByb3BlcnRpZXMgYWxsb3dz
IHRvIGFjdHVhbGx5IGxlYWsKY29udGludW91cyBjaHVua3Mgb2YgbWVtb3J5LiBUaGVyZWZvcmUs
IHdlIG9ubHkgYWRkIHRoZSBwZW5hbHR5IG9mCnByb3RlY3RpdmUgbWVjaGFuaXNtcyBpbiBjYXNl
IGEgcG90ZW50aWFsIHNwZWN1bGF0aXZlIG91dC1vZi1ib3VuZAphY2Nlc3MgbWF0Y2hlcyBhbGwg
dGhlIGFib3ZlIHByb3BlcnRpZXMuCgpUaGlzIGNvbW1pdCBhZGRyZXNzZXMgb25seSBvdXQtb2Yt
Ym91bmQgYWNjZXNzZXMgd2hvc2UgaW5kZXggaXMKZGlyZWN0bHkgY29udHJvbGxlZCBieSB0aGUg
Z3Vlc3QsIGFuZCB0aGUgaW5kZXggaXMgY2hlY2tlZCBiZWZvcmUuClBvdGVudGlhbCBvdXQtb2Yt
Ym91bmQgYWNjZXNzZXMgdGhhdCBhcmUgY2F1c2VkIGJ5IHNwZWN1bGF0aXZlbHkKZXZhbHVhdGlu
ZyB0aGUgdmVyc2lvbiBvZiB0aGUgY3VycmVudCB0YWJsZSBhcmUgbm90IGFkZHJlc3NlZCBpbiB0
aGlzCmNvbW1pdC4gSGVuY2UsIHNwZWN1bGF0aXZlIG91dC1vZi1ib3VuZCBhY2Nlc3NlcyBtaWdo
dCBzdGlsbCBiZQpwb3NzaWJsZSwgZm9yIGV4YW1wbGUgaW4gZ250dGFiX2dldF9zdGF0dXNfZnJh
bWVfbWZuLCB3aGVuIGNhbGxpbmcKZ250dGFiX2dyb3dfdGFibGUsIHRoZSBhc3NlcnRpb24gdGhh
dCB0aGUgZ3JhbnQgdGFibGUgdmVyc2lvbiBlcXVhbHMKdHdvIG1pZ2h0IG5vdCBob2xkIHVuZGVy
IHNwZWN1bGF0aW9uLgoKVGhpcyBpcyBwYXJ0IG9mIHRoZSBzcGVjdWxhdGl2ZSBoYXJkZW5pbmcg
ZWZmb3J0LgoKU2lnbmVkLW9mZi1ieTogTm9yYmVydCBNYW50aGV5IDxubWFudGhleUBhbWF6b24u
ZGU+Ci0tLQoKTm90ZXM6CiAgdjI6ICBNZW50aW9uIHZlcnNpb24gYmFzZWQgYmxvY2tpbmcgZm9y
IHVwY29taW5nIGNvbW1pdAogICAgICAgSW50cm9kdWNlIGxvY2FsIHZhcmlhYmxlIGFzIG9wLT5y
ZWYgcmVwbGFjZW1lbnQKICAgICAgIFVzZSBhcnJheV9ub3NwZWNfaW5kZXggaW4gZ250dGFiX2dl
dF9zdGF0dXNfZnJhbWVfbWZuCgogeGVuL2NvbW1vbi9ncmFudF90YWJsZS5jIHwgODAgKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdl
ZCwgNTUgaW5zZXJ0aW9ucygrKSwgMjUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2Nv
bW1vbi9ncmFudF90YWJsZS5jIGIveGVuL2NvbW1vbi9ncmFudF90YWJsZS5jCi0tLSBhL3hlbi9j
b21tb24vZ3JhbnRfdGFibGUuYworKysgYi94ZW4vY29tbW9uL2dyYW50X3RhYmxlLmMKQEAgLTkx
Miw2ICs5MTIsNyBAQCBtYXBfZ3JhbnRfcmVmKAogewogICAgIHN0cnVjdCBkb21haW4gKmxkLCAq
cmQsICpvd25lciA9IE5VTEw7CiAgICAgc3RydWN0IGdyYW50X3RhYmxlICpsZ3QsICpyZ3Q7Cisg
ICAgZ3JhbnRfcmVmX3QgcmVmOwogICAgIHN0cnVjdCB2Y3B1ICAgKmxlZDsKICAgICBncmFudF9o
YW5kbGVfdCBoYW5kbGU7CiAgICAgbWZuX3QgbWZuOwpAQCAtOTc1LDEzICs5NzYsMTUgQEAgbWFw
X2dyYW50X3JlZigKICAgICBncmFudF9yZWFkX2xvY2socmd0KTsKIAogICAgIC8qIEJvdW5kcyBj
aGVjayBvbiB0aGUgZ3JhbnQgcmVmICovCi0gICAgaWYgKCB1bmxpa2VseShvcC0+cmVmID49IG5y
X2dyYW50X2VudHJpZXMocmd0KSkpCisgICAgcmVmID0gb3AtPnJlZjsKKyAgICBpZiAoIHVubGlr
ZWx5KHJlZiA+PSBucl9ncmFudF9lbnRyaWVzKHJndCkpKQogICAgICAgICBQSU5fRkFJTCh1bmxv
Y2tfb3V0LCBHTlRTVF9iYWRfZ250cmVmLCAiQmFkIHJlZiAlI3ggZm9yIGQlZFxuIiwKLSAgICAg
ICAgICAgICAgICAgb3AtPnJlZiwgcmd0LT5kb21haW4tPmRvbWFpbl9pZCk7CisgICAgICAgICAg
ICAgICAgIHJlZiwgcmd0LT5kb21haW4tPmRvbWFpbl9pZCk7CiAKLSAgICBhY3QgPSBhY3RpdmVf
ZW50cnlfYWNxdWlyZShyZ3QsIG9wLT5yZWYpOwotICAgIHNoYWggPSBzaGFyZWRfZW50cnlfaGVh
ZGVyKHJndCwgb3AtPnJlZik7Ci0gICAgc3RhdHVzID0gcmd0LT5ndF92ZXJzaW9uID09IDEgPyAm
c2hhaC0+ZmxhZ3MgOiAmc3RhdHVzX2VudHJ5KHJndCwgb3AtPnJlZik7CisgICAgLyogVGhpcyBj
YWxsIGFsc28gZW5zdXJlcyB0aGUgYWJvdmUgY2hlY2sgY2Fubm90IGJlIHBhc3NlZCBzcGVjdWxh
dGl2ZWx5ICovCisgICAgc2hhaCA9IHNoYXJlZF9lbnRyeV9oZWFkZXIocmd0LCByZWYpOworICAg
IHN0YXR1cyA9IHJndC0+Z3RfdmVyc2lvbiA9PSAxID8gJnNoYWgtPmZsYWdzIDogJnN0YXR1c19l
bnRyeShyZ3QsIHJlZik7CisgICAgYWN0ID0gYWN0aXZlX2VudHJ5X2FjcXVpcmUocmd0LCByZWYp
OwogCiAgICAgLyogSWYgYWxyZWFkeSBwaW5uZWQsIGNoZWNrIHRoZSBhY3RpdmUgZG9taWQgYW5k
IGF2b2lkIHJlZmNudCBvdmVyZmxvdy4gKi8KICAgICBpZiAoIGFjdC0+cGluICYmCkBAIC0xMDA0
LDggKzEwMDcsOCBAQCBtYXBfZ3JhbnRfcmVmKAogICAgICAgICBpZiAoICFhY3QtPnBpbiApCiAg
ICAgICAgIHsKICAgICAgICAgICAgIHVuc2lnbmVkIGxvbmcgZ2ZuID0gcmd0LT5ndF92ZXJzaW9u
ID09IDEgPwotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZWRfZW50cnlfdjEo
cmd0LCBvcC0+cmVmKS5mcmFtZSA6Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNo
YXJlZF9lbnRyeV92MihyZ3QsIG9wLT5yZWYpLmZ1bGxfcGFnZS5mcmFtZTsKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgc2hhcmVkX2VudHJ5X3YxKHJndCwgcmVmKS5mcmFtZSA6Cisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlZF9lbnRyeV92MihyZ3QsIHJlZiku
ZnVsbF9wYWdlLmZyYW1lOwogCiAgICAgICAgICAgICByYyA9IGdldF9wYWdlZF9mcmFtZShnZm4s
ICZtZm4sICZwZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wLT5mbGFncyAm
IEdOVE1BUF9yZWFkb25seSwgcmQpOwpAQCAtMTAxOCw3ICsxMDIxLDcgQEAgbWFwX2dyYW50X3Jl
ZigKICAgICAgICAgICAgIGFjdC0+bGVuZ3RoID0gUEFHRV9TSVpFOwogICAgICAgICAgICAgYWN0
LT5pc19zdWJfcGFnZSA9IGZhbHNlOwogICAgICAgICAgICAgYWN0LT50cmFuc19kb21haW4gPSBy
ZDsKLSAgICAgICAgICAgIGFjdC0+dHJhbnNfZ3JlZiA9IG9wLT5yZWY7CisgICAgICAgICAgICBh
Y3QtPnRyYW5zX2dyZWYgPSByZWY7CiAgICAgICAgIH0KICAgICB9CiAKQEAgLTEyNjYsNiArMTI2
OSw3IEBAIHVubWFwX2NvbW1vbigKICAgICBkb21pZF90ICAgICAgICAgIGRvbTsKICAgICBzdHJ1
Y3QgZG9tYWluICAgKmxkLCAqcmQ7CiAgICAgc3RydWN0IGdyYW50X3RhYmxlICpsZ3QsICpyZ3Q7
CisgICAgZ3JhbnRfcmVmX3QgcmVmOwogICAgIHN0cnVjdCBhY3RpdmVfZ3JhbnRfZW50cnkgKmFj
dDsKICAgICBzMTYgICAgICAgICAgICAgIHJjID0gMDsKICAgICBzdHJ1Y3QgZ3JhbnRfbWFwcGlu
ZyAqbWFwOwpAQCAtMTMxOSw2ICsxMzIzLDcgQEAgdW5tYXBfY29tbW9uKAogCiAgICAgb3AtPnJk
ID0gcmQ7CiAgICAgb3AtPnJlZiA9IG1hcC0+cmVmOworICAgIHJlZiA9IG1hcC0+cmVmOwogCiAg
ICAgLyoKICAgICAgKiBXZSBjYW4ndCBhc3N1bWUgdGhlcmUgd2FzIG5vIHJhY2luZyB1bm1hcCBm
b3IgdGhpcyBtYXB0cmFjayBlbnRyeSwKQEAgLTEzMjgsNyArMTMzMyw3IEBAIHVubWFwX2NvbW1v
bigKICAgICAgKiBpbnZhbGlkIGxvY2suCiAgICAgICovCiAgICAgc21wX3JtYigpOwotICAgIGlm
ICggdW5saWtlbHkob3AtPnJlZiA+PSBucl9ncmFudF9lbnRyaWVzKHJndCkpICkKKyAgICBpZiAo
IHVubGlrZWx5KHJlZiA+PSBucl9ncmFudF9lbnRyaWVzKHJndCkpICkKICAgICB7CiAgICAgICAg
IGdkcHJpbnRrKFhFTkxPR19XQVJOSU5HLCAiVW5zdGFibGUgZCVkIGhhbmRsZSAlI3hcbiIsCiAg
ICAgICAgICAgICAgICAgIHJndC0+ZG9tYWluLT5kb21haW5faWQsIG9wLT5oYW5kbGUpOwpAQCAt
MTMzNyw3ICsxMzQyLDEwIEBAIHVubWFwX2NvbW1vbigKICAgICAgICAgZ290byB1bmxvY2tfb3V0
OwogICAgIH0KIAotICAgIGFjdCA9IGFjdGl2ZV9lbnRyeV9hY3F1aXJlKHJndCwgb3AtPnJlZik7
CisgICAgLyogTWFrZSBzdXJlIHRoZSBhYm92ZSBib3VuZCBjaGVjayBjYW5ub3QgYmUgYnlwYXNz
ZWQgc3BlY3VsYXRpdmVseSAqLworICAgIGJsb2NrX3NwZWN1bGF0aW9uKCk7CisKKyAgICBhY3Qg
PSBhY3RpdmVfZW50cnlfYWNxdWlyZShyZ3QsIHJlZik7CiAKICAgICAvKgogICAgICAqIE5vdGUg
dGhhdCB3ZSAoYWIpdXNlIHRoZSBhY3RpdmUgZW50cnkgbG9jayBoZXJlIHRvIHByb3RlY3QgYWdh
aW5zdApAQCAtMTM1MCw3ICsxMzU4LDcgQEAgdW5tYXBfY29tbW9uKAogICAgIGZsYWdzID0gcmVh
ZF9hdG9taWMoJm1hcC0+ZmxhZ3MpOwogICAgIHNtcF9ybWIoKTsKICAgICBpZiAoIHVubGlrZWx5
KCFmbGFncykgfHwgdW5saWtlbHkobWFwLT5kb21pZCAhPSBkb20pIHx8Ci0gICAgICAgICB1bmxp
a2VseShtYXAtPnJlZiAhPSBvcC0+cmVmKSApCisgICAgICAgICB1bmxpa2VseShtYXAtPnJlZiAh
PSByZWYpICkKICAgICB7CiAgICAgICAgIGdkcHJpbnRrKFhFTkxPR19XQVJOSU5HLCAiVW5zdGFi
bGUgaGFuZGxlICUjeFxuIiwgb3AtPmhhbmRsZSk7CiAgICAgICAgIHJjID0gR05UU1RfYmFkX2hh
bmRsZTsKQEAgLTE0MzQsNyArMTQ0Miw3IEBAIHVubWFwX2NvbW1vbl9jb21wbGV0ZShzdHJ1Y3Qg
Z250dGFiX3VubWFwX2NvbW1vbiAqb3ApCiAgICAgc3RydWN0IHBhZ2VfaW5mbyAqcGc7CiAgICAg
dWludDE2X3QgKnN0YXR1czsKIAotICAgIGlmICggIW9wLT5kb25lICkKKyAgICBpZiAoIGV2YWx1
YXRlX25vc3BlYyghb3AtPmRvbmUpICkKICAgICB7CiAgICAgICAgIC8qIHVubWFwX2NvbW1vbigp
IGRpZG4ndCBkbyBhbnl0aGluZyAtIG5vdGhpbmcgdG8gY29tcGxldGUuICovCiAgICAgICAgIHJl
dHVybjsKQEAgLTIwNDIsNiArMjA1MCw3IEBAIGdudHRhYl9wcmVwYXJlX2Zvcl90cmFuc2ZlcigK
ICAgICAgICAgZ290byBmYWlsOwogICAgIH0KIAorICAgIC8qIFRoaXMgY2FsbCBhbHNvIGVuc3Vy
ZXMgdGhlIGFib3ZlIGNoZWNrIGNhbm5vdCBiZSBwYXNzZWQgc3BlY3VsYXRpdmVseSAqLwogICAg
IHJhd19zaGFoID0gKHVpbnQzMl90ICopc2hhcmVkX2VudHJ5X2hlYWRlcihyZ3QsIHJlZik7CiAg
ICAgc2NvbWJvLnJhdyA9IEFDQ0VTU19PTkNFKCpyYXdfc2hhaCk7CiAKQEAgLTIwOTEsNiArMjEw
MCw3IEBAIGdudHRhYl90cmFuc2ZlcigKICAgICBzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlOwogICAg
IGludCBpOwogICAgIHN0cnVjdCBnbnR0YWJfdHJhbnNmZXIgZ29wOworICAgIGdyYW50X3JlZl90
IHJlZjsKICAgICBtZm5fdCBtZm47CiAgICAgdW5zaWduZWQgaW50IG1heF9iaXRzaXplOwogICAg
IHN0cnVjdCBhY3RpdmVfZ3JhbnRfZW50cnkgKmFjdDsKQEAgLTIyMzcsOCArMjI0NywxNCBAQCBn
bnR0YWJfdHJhbnNmZXIoCiAgICAgICAgICAqLwogICAgICAgICBzcGluX3VubG9jaygmZS0+cGFn
ZV9hbGxvY19sb2NrKTsKICAgICAgICAgb2theSA9IGdudHRhYl9wcmVwYXJlX2Zvcl90cmFuc2Zl
cihlLCBkLCBnb3AucmVmKTsKKyAgICAgICAgcmVmID0gZ29wLnJlZjsKIAotICAgICAgICBpZiAo
IHVubGlrZWx5KCFva2F5IHx8IGFzc2lnbl9wYWdlcyhlLCBwYWdlLCAwLCBNRU1GX25vX3JlZmNv
dW50KSkgKQorICAgICAgICAvKgorICAgICAgICAgKiBNYWtlIHN1cmUgdGhlIHJlZmVyZW5jZSBi
b3VuZCBjaGVjayBpbiBnbnR0YWJfcHJlcGFyZV9mb3JfdHJhbnNmZXIKKyAgICAgICAgICogaXMg
cmVzcGVjdGVkIGFuZCBzcGVjdWxhdGl2ZSBleGVjdXRpb24gaXMgYmxvY2tlZCBhY2NvcmRpbmds
eQorICAgICAgICAgKi8KKyAgICAgICAgaWYgKCB1bmxpa2VseSghZXZhbHVhdGVfbm9zcGVjKG9r
YXkpKSB8fAorICAgICAgICAgICAgdW5saWtlbHkoYXNzaWduX3BhZ2VzKGUsIHBhZ2UsIDAsIE1F
TUZfbm9fcmVmY291bnQpKSApCiAgICAgICAgIHsKICAgICAgICAgICAgIGJvb2wgZHJvcF9kb21f
cmVmOwogCkBAIC0yMjY4LDExICsyMjg0LDExIEBAIGdudHRhYl90cmFuc2ZlcigKIAogICAgICAg
ICAvKiBUZWxsIHRoZSBndWVzdCBhYm91dCBpdHMgbmV3IHBhZ2UgZnJhbWUuICovCiAgICAgICAg
IGdyYW50X3JlYWRfbG9jayhlLT5ncmFudF90YWJsZSk7Ci0gICAgICAgIGFjdCA9IGFjdGl2ZV9l
bnRyeV9hY3F1aXJlKGUtPmdyYW50X3RhYmxlLCBnb3AucmVmKTsKKyAgICAgICAgYWN0ID0gYWN0
aXZlX2VudHJ5X2FjcXVpcmUoZS0+Z3JhbnRfdGFibGUsIHJlZik7CiAKICAgICAgICAgaWYgKCBl
LT5ncmFudF90YWJsZS0+Z3RfdmVyc2lvbiA9PSAxICkKICAgICAgICAgewotICAgICAgICAgICAg
Z3JhbnRfZW50cnlfdjFfdCAqc2hhID0gJnNoYXJlZF9lbnRyeV92MShlLT5ncmFudF90YWJsZSwg
Z29wLnJlZik7CisgICAgICAgICAgICBncmFudF9lbnRyeV92MV90ICpzaGEgPSAmc2hhcmVkX2Vu
dHJ5X3YxKGUtPmdyYW50X3RhYmxlLCByZWYpOwogCiAgICAgICAgICAgICBndWVzdF9waHlzbWFw
X2FkZF9wYWdlKGUsIF9nZm4oc2hhLT5mcmFtZSksIG1mbiwgMCk7CiAgICAgICAgICAgICBpZiAo
ICFwYWdpbmdfbW9kZV90cmFuc2xhdGUoZSkgKQpAQCAtMjI4MCwxNCArMjI5NiwxNCBAQCBnbnR0
YWJfdHJhbnNmZXIoCiAgICAgICAgIH0KICAgICAgICAgZWxzZQogICAgICAgICB7Ci0gICAgICAg
ICAgICBncmFudF9lbnRyeV92Ml90ICpzaGEgPSAmc2hhcmVkX2VudHJ5X3YyKGUtPmdyYW50X3Rh
YmxlLCBnb3AucmVmKTsKKyAgICAgICAgICAgIGdyYW50X2VudHJ5X3YyX3QgKnNoYSA9ICZzaGFy
ZWRfZW50cnlfdjIoZS0+Z3JhbnRfdGFibGUsIHJlZik7CiAKICAgICAgICAgICAgIGd1ZXN0X3Bo
eXNtYXBfYWRkX3BhZ2UoZSwgX2dmbihzaGEtPmZ1bGxfcGFnZS5mcmFtZSksIG1mbiwgMCk7CiAg
ICAgICAgICAgICBpZiAoICFwYWdpbmdfbW9kZV90cmFuc2xhdGUoZSkgKQogICAgICAgICAgICAg
ICAgIHNoYS0+ZnVsbF9wYWdlLmZyYW1lID0gbWZuX3gobWZuKTsKICAgICAgICAgfQogICAgICAg
ICBzbXBfd21iKCk7Ci0gICAgICAgIHNoYXJlZF9lbnRyeV9oZWFkZXIoZS0+Z3JhbnRfdGFibGUs
IGdvcC5yZWYpLT5mbGFncyB8PQorICAgICAgICBzaGFyZWRfZW50cnlfaGVhZGVyKGUtPmdyYW50
X3RhYmxlLCByZWYpLT5mbGFncyB8PQogICAgICAgICAgICAgR1RGX3RyYW5zZmVyX2NvbXBsZXRl
ZDsKIAogICAgICAgICBhY3RpdmVfZW50cnlfcmVsZWFzZShhY3QpOwpAQCAtMjQyNiw4ICsyNDQy
LDEwIEBAIGFjcXVpcmVfZ3JhbnRfZm9yX2NvcHkoCiAgICAgICAgIFBJTl9GQUlMKGd0X3VubG9j
a19vdXQsIEdOVFNUX2JhZF9nbnRyZWYsCiAgICAgICAgICAgICAgICAgICJCYWQgZ3JhbnQgcmVm
ZXJlbmNlICUjeFxuIiwgZ3JlZik7CiAKLSAgICBhY3QgPSBhY3RpdmVfZW50cnlfYWNxdWlyZShy
Z3QsIGdyZWYpOworICAgIC8qIFRoaXMgY2FsbCBhbHNvIGVuc3VyZXMgdGhlIGFib3ZlIGNoZWNr
IGNhbm5vdCBiZSBwYXNzZWQgc3BlY3VsYXRpdmVseSAqLwogICAgIHNoYWggPSBzaGFyZWRfZW50
cnlfaGVhZGVyKHJndCwgZ3JlZik7CisgICAgYWN0ID0gYWN0aXZlX2VudHJ5X2FjcXVpcmUocmd0
LCBncmVmKTsKKwogICAgIGlmICggcmd0LT5ndF92ZXJzaW9uID09IDEgKQogICAgIHsKICAgICAg
ICAgc2hhMiA9IE5VTEw7CkBAIC0yODQzLDYgKzI4NjEsOSBAQCBzdGF0aWMgaW50IGdudHRhYl9j
b3B5X2J1Zihjb25zdCBzdHJ1Y3QgZ250dGFiX2NvcHkgKm9wLAogICAgICAgICAgICAgICAgICBv
cC0+ZGVzdC5vZmZzZXQsIGRlc3QtPnB0ci5vZmZzZXQsCiAgICAgICAgICAgICAgICAgIG9wLT5s
ZW4sIGRlc3QtPmxlbik7CiAKKyAgICAvKiBNYWtlIHN1cmUgdGhlIGFib3ZlIGNoZWNrcyBhcmUg
bm90IGJ5cGFzc2VkIHNwZWN1bGF0aXZlbHkgKi8KKyAgICBibG9ja19zcGVjdWxhdGlvbigpOwor
CiAgICAgbWVtY3B5KGRlc3QtPnZpcnQgKyBvcC0+ZGVzdC5vZmZzZXQsIHNyYy0+dmlydCArIG9w
LT5zb3VyY2Uub2Zmc2V0LAogICAgICAgICAgICBvcC0+bGVuKTsKICAgICBnbnR0YWJfbWFya19k
aXJ0eShkZXN0LT5kb21haW4sIGRlc3QtPm1mbik7CkBAIC0yOTYyLDcgKzI5ODMsNyBAQCBnbnR0
YWJfc2V0X3ZlcnNpb24oWEVOX0dVRVNUX0hBTkRMRV9QQVJBTShnbnR0YWJfc2V0X3ZlcnNpb25f
dCkgdW9wKQogICAgIHN0cnVjdCBncmFudF90YWJsZSAqZ3QgPSBjdXJyZC0+Z3JhbnRfdGFibGU7
CiAgICAgZ3JhbnRfZW50cnlfdjFfdCByZXNlcnZlZF9lbnRyaWVzW0dOVFRBQl9OUl9SRVNFUlZF
RF9FTlRSSUVTXTsKICAgICBpbnQgcmVzOwotICAgIHVuc2lnbmVkIGludCBpOworICAgIHVuc2ln
bmVkIGludCBpLCBucl9lbnRzOwogCiAgICAgaWYgKCBjb3B5X2Zyb21fZ3Vlc3QoJm9wLCB1b3As
IDEpICkKICAgICAgICAgcmV0dXJuIC1FRkFVTFQ7CkBAIC0yOTg2LDcgKzMwMDcsOCBAQCBnbnR0
YWJfc2V0X3ZlcnNpb24oWEVOX0dVRVNUX0hBTkRMRV9QQVJBTShnbnR0YWJfc2V0X3ZlcnNpb25f
dCkgdW9wKQogICAgICAqIGFyZSBhbGxvd2VkIHRvIGJlIGluIHVzZSAoeGVuc3RvcmUveGVuY29u
c29sZSBrZWVwcyB0aGVtIG1hcHBlZCkuCiAgICAgICogKFlvdSBuZWVkIHRvIGNoYW5nZSB0aGUg
dmVyc2lvbiBudW1iZXIgZm9yIGUuZy4ga2V4ZWMuKQogICAgICAqLwotICAgIGZvciAoIGkgPSBH
TlRUQUJfTlJfUkVTRVJWRURfRU5UUklFUzsgaSA8IG5yX2dyYW50X2VudHJpZXMoZ3QpOyBpKysg
KQorICAgIG5yX2VudHMgPSBucl9ncmFudF9lbnRyaWVzKGd0KTsKKyAgICBmb3IgKCBpID0gR05U
VEFCX05SX1JFU0VSVkVEX0VOVFJJRVM7IGkgPCBucl9lbnRzOyBpKysgKQogICAgIHsKICAgICAg
ICAgaWYgKCByZWFkX2F0b21pYygmX2FjdGl2ZV9lbnRyeShndCwgaSkucGluKSAhPSAwICkKICAg
ICAgICAgewpAQCAtMzIyOCw2ICszMjUwLDkgQEAgc3dhcF9ncmFudF9yZWYoZ3JhbnRfcmVmX3Qg
cmVmX2EsIGdyYW50X3JlZl90IHJlZl9iKQogICAgIGlmICggdW5saWtlbHkocmVmX2IgPj0gbnJf
Z3JhbnRfZW50cmllcyhkLT5ncmFudF90YWJsZSkpKQogICAgICAgICBQSU5fRkFJTChvdXQsIEdO
VFNUX2JhZF9nbnRyZWYsICJCYWQgcmVmLWIgJSN4XG4iLCByZWZfYik7CiAKKyAgICAvKiBNYWtl
IHN1cmUgdGhlIGFib3ZlIGNoZWNrcyBhcmUgbm90IGJ5cGFzc2VkIHNwZWN1bGF0aXZlbHkgKi8K
KyAgICBibG9ja19zcGVjdWxhdGlvbigpOworCiAgICAgLyogU3dhcHBpbmcgdGhlIHNhbWUgcmVm
IGlzIGEgbm8tb3AuICovCiAgICAgaWYgKCByZWZfYSA9PSByZWZfYiApCiAgICAgICAgIGdvdG8g
b3V0OwpAQCAtMzY5NywxMyArMzcyMiwxNCBAQCB2b2lkIGdyYW50X3RhYmxlX3dhcm5fYWN0aXZl
X2dyYW50cyhzdHJ1Y3QgZG9tYWluICpkKQogICAgIHN0cnVjdCBncmFudF90YWJsZSAqZ3QgPSBk
LT5ncmFudF90YWJsZTsKICAgICBzdHJ1Y3QgYWN0aXZlX2dyYW50X2VudHJ5ICphY3Q7CiAgICAg
Z3JhbnRfcmVmX3QgcmVmOwotICAgIHVuc2lnbmVkIGludCBucl9hY3RpdmUgPSAwOworICAgIHVu
c2lnbmVkIGludCBucl9hY3RpdmUgPSAwLCBucl9lbnRzOwogCiAjZGVmaW5lIFdBUk5fR1JBTlRf
TUFYIDEwCiAKICAgICBncmFudF9yZWFkX2xvY2soZ3QpOwogCi0gICAgZm9yICggcmVmID0gMDsg
cmVmICE9IG5yX2dyYW50X2VudHJpZXMoZ3QpOyByZWYrKyApCisgICAgbnJfZW50cyA9IG5yX2dy
YW50X2VudHJpZXMoZ3QpOworICAgIGZvciAoIHJlZiA9IDA7IHJlZiAhPSBucl9lbnRzOyByZWYr
KyApCiAgICAgewogICAgICAgICBhY3QgPSBhY3RpdmVfZW50cnlfYWNxdWlyZShndCwgcmVmKTsK
ICAgICAgICAgaWYgKCAhYWN0LT5waW4gKQpAQCAtMzg1Myw3ICszODc5LDggQEAgc3RhdGljIGlu
dCBnbnR0YWJfZ2V0X3N0YXR1c19mcmFtZV9tZm4oc3RydWN0IGRvbWFpbiAqZCwKICAgICAgICAg
ICAgIHJldHVybiAtRUlOVkFMOwogICAgIH0KIAotICAgICptZm4gPSBfbWZuKHZpcnRfdG9fbWZu
KGd0LT5zdGF0dXNbaWR4XSkpOworICAgIC8qIE1ha2Ugc3VyZSBpZHggaXMgYm91bmRlZCB3cnQg
bnJfc3RhdHVzX2ZyYW1lcyAqLworICAgICptZm4gPSBfbWZuKHZpcnRfdG9fbWZuKGd0LT5zdGF0
dXNbYXJyYXlfaW5kZXhfbm9zcGVjKGlkeCwgbnJfc3RhdHVzX2ZyYW1lcyhndCkpXSkpOwogICAg
IHJldHVybiAwOwogfQogCkBAIC0zODgyLDcgKzM5MDksOCBAQCBzdGF0aWMgaW50IGdudHRhYl9n
ZXRfc2hhcmVkX2ZyYW1lX21mbihzdHJ1Y3QgZG9tYWluICpkLAogICAgICAgICAgICAgcmV0dXJu
IC1FSU5WQUw7CiAgICAgfQogCi0gICAgKm1mbiA9IF9tZm4odmlydF90b19tZm4oZ3QtPnNoYXJl
ZF9yYXdbaWR4XSkpOworICAgIC8qIE1ha2Ugc3VyZSBpZHggaXMgYm91bmRlZCB3cnQgbnJfc3Rh
dHVzX2ZyYW1lcyAqLworICAgICptZm4gPSBfbWZuKHZpcnRfdG9fbWZuKGd0LT5zaGFyZWRfcmF3
W2FycmF5X2luZGV4X25vc3BlYyhpZHgsIG5yX2dyYW50X2ZyYW1lcyhndCkpXSkpOwogICAgIHJl
dHVybiAwOwogfQogCkBAIC0zOTUyLDYgKzM5ODAsNyBAQCBzdGF0aWMgdm9pZCBnbnR0YWJfdXNh
Z2VfcHJpbnQoc3RydWN0IGRvbWFpbiAqcmQpCiAgICAgaW50IGZpcnN0ID0gMTsKICAgICBncmFu
dF9yZWZfdCByZWY7CiAgICAgc3RydWN0IGdyYW50X3RhYmxlICpndCA9IHJkLT5ncmFudF90YWJs
ZTsKKyAgICB1bnNpZ25lZCBpbnQgbnJfZW50czsKIAogICAgIHByaW50aygiICAgICAgLS0tLS0t
LS0gYWN0aXZlIC0tLS0tLS0tICAgICAgIC0tLS0tLS0tIHNoYXJlZCAtLS0tLS0tLVxuIik7CiAg
ICAgcHJpbnRrKCJbcmVmXSBsb2NhbGRvbSBtZm4gICAgICBwaW4gICAgICAgICAgbG9jYWxkb20g
Z21mbiAgICAgZmxhZ3NcbiIpOwpAQCAtMzk2NCw3ICszOTkzLDggQEAgc3RhdGljIHZvaWQgZ250
dGFiX3VzYWdlX3ByaW50KHN0cnVjdCBkb21haW4gKnJkKQogICAgICAgICAgICBucl9ncmFudF9m
cmFtZXMoZ3QpLCBndC0+bWF4X2dyYW50X2ZyYW1lcywKICAgICAgICAgICAgbnJfbWFwdHJhY2tf
ZnJhbWVzKGd0KSwgZ3QtPm1heF9tYXB0cmFja19mcmFtZXMpOwogCi0gICAgZm9yICggcmVmID0g
MDsgcmVmICE9IG5yX2dyYW50X2VudHJpZXMoZ3QpOyByZWYrKyApCisgICAgbnJfZW50cyA9IG5y
X2dyYW50X2VudHJpZXMoZ3QpOworICAgIGZvciAoIHJlZiA9IDA7IHJlZiAhPSBucl9lbnRzOyBy
ZWYrKyApCiAgICAgewogICAgICAgICBzdHJ1Y3QgYWN0aXZlX2dyYW50X2VudHJ5ICphY3Q7CiAg
ICAgICAgIHN0cnVjdCBncmFudF9lbnRyeV9oZWFkZXIgKnNoYTsKLS0gCjIuNy40CgoKCgpBbWF6
b24gRGV2ZWxvcG1lbnQgQ2VudGVyIEdlcm1hbnkgR21iSApLcmF1c2Vuc3RyLiAzOAoxMDExNyBC
ZXJsaW4KR2VzY2hhZWZ0c2Z1ZWhydW5nOiBDaHJpc3RpYW4gU2NobGFlZ2VyLCBSYWxmIEhlcmJy
aWNoCkVpbmdldHJhZ2VuIGFtIEFtdHNnZXJpY2h0IENoYXJsb3R0ZW5idXJnIHVudGVyIEhSQiAx
NDkxNzMgQgpTaXR6OiBCZXJsaW4KVXN0LUlEOiBERSAyODkgMjM3IDg3OQoKCgoKX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcg
bGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9q
ZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

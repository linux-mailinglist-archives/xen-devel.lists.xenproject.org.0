Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 16E686C18C
	for <lists+xen-devel@lfdr.de>; Wed, 17 Jul 2019 21:37:10 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hnpgf-0000Hd-72; Wed, 17 Jul 2019 19:34:01 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=K8rP=VO=gmail.com=tamas.k.lengyel@srs-us1.protection.inumbo.net>)
 id 1hnpgd-0000HL-KS
 for xen-devel@lists.xenproject.org; Wed, 17 Jul 2019 19:33:59 +0000
X-Inumbo-ID: d0043070-a8c9-11e9-be02-ebb5fa9022dc
Received: from mail-io1-f68.google.com (unknown [209.85.166.68])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id d0043070-a8c9-11e9-be02-ebb5fa9022dc;
 Wed, 17 Jul 2019 19:33:54 +0000 (UTC)
Received: by mail-io1-f68.google.com with SMTP id k20so47594701ios.10
 for <xen-devel@lists.xenproject.org>; Wed, 17 Jul 2019 12:33:54 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=JBw7l33La8xVqfg8L17ATjz/BcMg+hI1A6l2yXVZeo0=;
 b=Y3zTD7jqvwRSnSm5ATNyLUuheKGYsi1AD5YmxIE/F4OQUc3Q4wcfTT6cmG3Dgr3o58
 euNHSEUvjBEfKtQ+y7v02eFIH8YF9WE1H3KdjRMCSuQU0BWBOMkYt2H7v5HWv66s6xBn
 eNC1rJbvY82Bbx81fevk2vOu9TDayhssYJRIqDgYU+JNlHwpX+9nU6ubSx3BIANUMb5R
 J7xySNEulGo4+EBR++qrAnrV9YzAmcoQLhHMvEjN7pg0qBBs/8kMlC4XhNojR4H1HLx3
 FBsOkXVwtOVk4dmpPG9/mFBQqueKq1qRxTbfEXiway20YIjwAMIJkVM3P7/AHO0pxcrx
 n/oA==
X-Gm-Message-State: APjAAAVis7ZJD6SQiY0iK/X0JkX513j17YvQLIHY8YkrA6cg+lM9zx60
 ULIt25LZZOfQOfbO73QYFOsUExKq
X-Google-Smtp-Source: APXvYqxg5NYQFGxMFuUPXTARLsjdGTi74JswUYe2OqezGVQUMo2s4PVGcQioR4sbN17+sHslUc7/+g==
X-Received: by 2002:a6b:b985:: with SMTP id
 j127mr38797426iof.186.1563392033796; 
 Wed, 17 Jul 2019 12:33:53 -0700 (PDT)
Received: from l1.lan (c-71-205-12-124.hsd1.co.comcast.net. [71.205.12.124])
 by smtp.gmail.com with ESMTPSA id v13sm21743421ioq.13.2019.07.17.12.33.52
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Wed, 17 Jul 2019 12:33:53 -0700 (PDT)
From: Tamas K Lengyel <tamas@tklengyel.com>
To: xen-devel@lists.xenproject.org
Date: Wed, 17 Jul 2019 13:33:31 -0600
Message-Id: <20190717193335.11991-2-tamas@tklengyel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190717193335.11991-1-tamas@tklengyel.com>
References: <20190717193335.11991-1-tamas@tklengyel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v6 1/5] x86/mem_sharing: reorder when pages are
 unlocked and released
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Tamas K Lengyel <tamas@tklengyel.com>, Wei Liu <wei.liu2@citrix.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Jan Beulich <jbeulich@suse.com>,
 Roger Pau Monne <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q2FsbGluZyBfcHV0X3BhZ2VfdHlwZSB3aGlsZSBhbHNvIGhvbGRpbmcgdGhlIHBhZ2VfbG9jawpm
b3IgdGhhdCBwYWdlIGNhbiBjYXVzZSBhIGRlYWRsb2NrLgoKVGhlIGNvbW1lbnQgYmVpbmcgZHJv
cHBlZCBpcyBpbmNvcnJlY3Qgc2luY2UgaXQncyBub3cgb3V0LW9mLWRhdGUuCgpTaWduZWQtb2Zm
LWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzQHRrbGVuZ3llbC5jb20+CkNjOiBKYW4gQmV1bGlj
aCA8amJldWxpY2hAc3VzZS5jb20+CkNjOiBBbmRyZXcgQ29vcGVyIDxhbmRyZXcuY29vcGVyM0Bj
aXRyaXguY29tPgpDYzogR2VvcmdlIER1bmxhcCA8Z2VvcmdlLmR1bmxhcEBldS5jaXRyaXguY29t
PgpDYzogV2VpIExpdSA8d2VpLmxpdTJAY2l0cml4LmNvbT4KQ2M6IFJvZ2VyIFBhdSBNb25uZSA8
cm9nZXIucGF1QGNpdHJpeC5jb20+Ci0tLQp2NjogcmViYXNlIG9uIHN0YWdpbmcKdjU6IEJVR19P
TiBlYXJseSBiZWZvcmUgcmVsZWFzaW5nIHJlZmVyZW5jZXMKLS0tCiB4ZW4vYXJjaC94ODYvbW0v
bWVtX3NoYXJpbmcuYyB8IDQwICsrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAx
IGZpbGUgY2hhbmdlZCwgMTIgaW5zZXJ0aW9ucygrKSwgMjggZGVsZXRpb25zKC0pCgpkaWZmIC0t
Z2l0IGEveGVuL2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMgYi94ZW4vYXJjaC94ODYvbW0vbWVt
X3NoYXJpbmcuYwppbmRleCA1OGQ5MTU3ZmE4Li42YzAzM2QxNDg4IDEwMDY0NAotLS0gYS94ZW4v
YXJjaC94ODYvbW0vbWVtX3NoYXJpbmcuYworKysgYi94ZW4vYXJjaC94ODYvbW0vbWVtX3NoYXJp
bmcuYwpAQCAtNjQ4LDEwICs2NDgsNiBAQCBzdGF0aWMgaW50IHBhZ2VfbWFrZV9wcml2YXRlKHN0
cnVjdCBkb21haW4gKmQsIHN0cnVjdCBwYWdlX2luZm8gKnBhZ2UpCiAgICAgICAgIHJldHVybiAt
RUJVU1k7CiAgICAgfQogCi0gICAgLyogV2UgY2FuIG9ubHkgY2hhbmdlIHRoZSB0eXBlIGlmIGNv
dW50IGlzIG9uZSAqLwotICAgIC8qIEJlY2F1c2Ugd2UgYXJlIGxvY2tpbmcgcGFnZXMgaW5kaXZp
ZHVhbGx5LCB3ZSBuZWVkIHRvIGRyb3AKLSAgICAgKiB0aGUgbG9jayBoZXJlLCB3aGlsZSB0aGUg
cGFnZSBpcyB0eXBlZC4gV2UgY2Fubm90IHJpc2sgdGhlIAotICAgICAqIHJhY2Ugb2YgcGFnZV91
bmxvY2sgYW5kIHRoZW4gcHV0X3BhZ2VfdHlwZS4gKi8KICAgICBleHBlY3RlZF90eXBlID0gKFBH
VF9zaGFyZWRfcGFnZSB8IFBHVF92YWxpZGF0ZWQgfCBQR1RfbG9ja2VkIHwgMik7CiAgICAgaWYg
KCBwYWdlLT51LmludXNlLnR5cGVfaW5mbyAhPSBleHBlY3RlZF90eXBlICkKICAgICB7CkBAIC02
NjAsMTIgKzY1NiwxMSBAQCBzdGF0aWMgaW50IHBhZ2VfbWFrZV9wcml2YXRlKHN0cnVjdCBkb21h
aW4gKmQsIHN0cnVjdCBwYWdlX2luZm8gKnBhZ2UpCiAgICAgICAgIHJldHVybiAtRUVYSVNUOwog
ICAgIH0KIAorICAgIG1lbV9zaGFyaW5nX3BhZ2VfdW5sb2NrKHBhZ2UpOworCiAgICAgLyogRHJv
cCB0aGUgZmluYWwgdHlwZWNvdW50ICovCiAgICAgcHV0X3BhZ2VfYW5kX3R5cGUocGFnZSk7CiAK
LSAgICAvKiBOb3cgdGhhdCB3ZSd2ZSBkcm9wcGVkIHRoZSB0eXBlLCB3ZSBjYW4gdW5sb2NrICov
Ci0gICAgbWVtX3NoYXJpbmdfcGFnZV91bmxvY2socGFnZSk7Ci0KICAgICAvKiBDaGFuZ2UgdGhl
IG93bmVyICovCiAgICAgQVNTRVJUKHBhZ2VfZ2V0X293bmVyKHBhZ2UpID09IGRvbV9jb3cpOwog
ICAgIHBhZ2Vfc2V0X293bmVyKHBhZ2UsIGQpOwpAQCAtOTAwLDYgKzg5NSw3IEBAIHN0YXRpYyBp
bnQgc2hhcmVfcGFnZXMoc3RydWN0IGRvbWFpbiAqc2QsIGdmbl90IHNnZm4sIHNocl9oYW5kbGVf
dCBzaCwKICAgICBwMm1fdHlwZV90IHNtZm5fdHlwZSwgY21mbl90eXBlOwogICAgIHN0cnVjdCB0
d29fZ2ZucyB0ZzsKICAgICBzdHJ1Y3Qgcm1hcF9pdGVyYXRvciByaTsKKyAgICB1bnNpZ25lZCBs
b25nIHB1dF9jb3VudCA9IDA7CiAKICAgICBnZXRfdHdvX2dmbnMoc2QsIHNnZm4sICZzbWZuX3R5
cGUsIE5VTEwsICZzbWZuLAogICAgICAgICAgICAgICAgICBjZCwgY2dmbiwgJmNtZm5fdHlwZSwg
TlVMTCwgJmNtZm4sIDAsICZ0Zyk7CkBAIC05NjQsMTUgKzk2MCw2IEBAIHN0YXRpYyBpbnQgc2hh
cmVfcGFnZXMoc3RydWN0IGRvbWFpbiAqc2QsIGdmbl90IHNnZm4sIHNocl9oYW5kbGVfdCBzaCwK
ICAgICAgICAgZ290byBlcnJfb3V0OwogICAgIH0KIAotICAgIC8qIEFjcXVpcmUgYW4gZXh0cmEg
cmVmZXJlbmNlLCBmb3IgdGhlIGZyZWVpbmcgYmVsb3cgdG8gYmUgc2FmZS4gKi8KLSAgICBpZiAo
ICFnZXRfcGFnZShjcGFnZSwgZG9tX2NvdykgKQotICAgIHsKLSAgICAgICAgcmV0ID0gLUVPVkVS
RkxPVzsKLSAgICAgICAgbWVtX3NoYXJpbmdfcGFnZV91bmxvY2soc2Vjb25kcGcpOwotICAgICAg
ICBtZW1fc2hhcmluZ19wYWdlX3VubG9jayhmaXJzdHBnKTsKLSAgICAgICAgZ290byBlcnJfb3V0
OwotICAgIH0KLQogICAgIC8qIE1lcmdlIHRoZSBsaXN0cyB0b2dldGhlciAqLwogICAgIHJtYXBf
c2VlZF9pdGVyYXRvcihjcGFnZSwgJnJpKTsKICAgICB3aGlsZSAoIChnZm4gPSBybWFwX2l0ZXJh
dGUoY3BhZ2UsICZyaSkpICE9IE5VTEwpCkBAIC05ODQsMTMgKzk3MSwxNCBAQCBzdGF0aWMgaW50
IHNoYXJlX3BhZ2VzKHN0cnVjdCBkb21haW4gKnNkLCBnZm5fdCBzZ2ZuLCBzaHJfaGFuZGxlX3Qg
c2gsCiAgICAgICAgICAqIERvbid0IGNoYW5nZSB0aGUgdHlwZSBvZiBybWFwIGZvciB0aGUgY2xp
ZW50IHBhZ2UuICovCiAgICAgICAgIHJtYXBfZGVsKGdmbiwgY3BhZ2UsIDApOwogICAgICAgICBy
bWFwX2FkZChnZm4sIHNwYWdlKTsKLSAgICAgICAgcHV0X3BhZ2VfYW5kX3R5cGUoY3BhZ2UpOwor
ICAgICAgICBwdXRfY291bnQrKzsKICAgICAgICAgZCA9IGdldF9kb21haW5fYnlfaWQoZ2ZuLT5k
b21haW4pOwogICAgICAgICBCVUdfT04oIWQpOwogICAgICAgICBCVUdfT04oc2V0X3NoYXJlZF9w
Mm1fZW50cnkoZCwgZ2ZuLT5nZm4sIHNtZm4pKTsKICAgICAgICAgcHV0X2RvbWFpbihkKTsKICAg
ICB9CiAgICAgQVNTRVJUKGxpc3RfZW1wdHkoJmNwYWdlLT5zaGFyaW5nLT5nZm5zKSk7CisgICAg
QlVHX09OKCFwdXRfY291bnQpOwogCiAgICAgLyogQ2xlYXIgdGhlIHJlc3Qgb2YgdGhlIHNoYXJl
ZCBzdGF0ZSAqLwogICAgIHBhZ2Vfc2hhcmluZ19kaXNwb3NlKGNwYWdlKTsKQEAgLTEwMDEsNyAr
OTg5LDkgQEAgc3RhdGljIGludCBzaGFyZV9wYWdlcyhzdHJ1Y3QgZG9tYWluICpzZCwgZ2ZuX3Qg
c2dmbiwgc2hyX2hhbmRsZV90IHNoLAogCiAgICAgLyogRnJlZSB0aGUgY2xpZW50IHBhZ2UgKi8K
ICAgICBwdXRfcGFnZV9hbGxvY19yZWYoY3BhZ2UpOwotICAgIHB1dF9wYWdlKGNwYWdlKTsKKwor
ICAgIHdoaWxlICggcHV0X2NvdW50LS0gKQorICAgICAgICBwdXRfcGFnZV9hbmRfdHlwZShjcGFn
ZSk7CiAKICAgICAvKiBXZSBtYW5hZ2VkIHRvIGZyZWUgYSBkb21haW4gcGFnZS4gKi8KICAgICBh
dG9taWNfZGVjKCZucl9zaGFyZWRfbWZucyk7CkBAIC0xMTY1LDE5ICsxMTU1LDEzIEBAIGludCBf
X21lbV9zaGFyaW5nX3Vuc2hhcmVfcGFnZShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHsKICAgICAg
ICAgaWYgKCAhbGFzdF9nZm4gKQogICAgICAgICAgICAgbWVtX3NoYXJpbmdfZ2ZuX2Rlc3Ryb3ko
cGFnZSwgZCwgZ2ZuX2luZm8pOwotICAgICAgICBwdXRfcGFnZV9hbmRfdHlwZShwYWdlKTsKKwog
ICAgICAgICBtZW1fc2hhcmluZ19wYWdlX3VubG9jayhwYWdlKTsKKwogICAgICAgICBpZiAoIGxh
c3RfZ2ZuICkKLSAgICAgICAgewotICAgICAgICAgICAgaWYgKCAhZ2V0X3BhZ2UocGFnZSwgZG9t
X2NvdykgKQotICAgICAgICAgICAgewotICAgICAgICAgICAgICAgIHB1dF9nZm4oZCwgZ2ZuKTsK
LSAgICAgICAgICAgICAgICBkb21haW5fY3Jhc2goZCk7Ci0gICAgICAgICAgICAgICAgcmV0dXJu
IC1FT1ZFUkZMT1c7Ci0gICAgICAgICAgICB9CiAgICAgICAgICAgICBwdXRfcGFnZV9hbGxvY19y
ZWYocGFnZSk7Ci0gICAgICAgICAgICBwdXRfcGFnZShwYWdlKTsKLSAgICAgICAgfQorCisgICAg
ICAgIHB1dF9wYWdlX2FuZF90eXBlKHBhZ2UpOwogICAgICAgICBwdXRfZ2ZuKGQsIGdmbik7CiAK
ICAgICAgICAgcmV0dXJuIDA7Ci0tIAoyLjIwLjEKCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBs
aXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4v
bGlzdGluZm8veGVuLWRldmVs

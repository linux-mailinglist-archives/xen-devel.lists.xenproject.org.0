Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 5FB843349B
	for <lists+xen-devel@lfdr.de>; Mon,  3 Jun 2019 18:08:11 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hXpRc-00026W-RW; Mon, 03 Jun 2019 16:04:20 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=fnY6=UC=arm.com=julien.grall@srs-us1.protection.inumbo.net>)
 id 1hXpRb-000257-EX
 for xen-devel@lists.xenproject.org; Mon, 03 Jun 2019 16:04:19 +0000
X-Inumbo-ID: 3e13eb24-8619-11e9-aa0b-8bfb69120422
Received: from foss.arm.com (unknown [217.140.101.70])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTP
 id 3e13eb24-8619-11e9-aa0b-8bfb69120422;
 Mon, 03 Jun 2019 16:04:18 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.72.51.249])
 by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 60C2A80D;
 Mon,  3 Jun 2019 09:04:18 -0700 (PDT)
Received: from e108454-lin.cambridge.arm.com (e108454-lin.cambridge.arm.com
 [10.1.196.50])
 by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id 2DE553F246;
 Mon,  3 Jun 2019 09:04:17 -0700 (PDT)
From: Julien Grall <julien.grall@arm.com>
To: xen-devel@lists.xenproject.org
Date: Mon,  3 Jun 2019 17:03:46 +0100
Message-Id: <20190603160350.29806-11-julien.grall@arm.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <20190603160350.29806-1-julien.grall@arm.com>
References: <20190603160350.29806-1-julien.grall@arm.com>
Subject: [Xen-devel] [PATCH v3 10/14] xen/x86: pv: Convert update_intpte()
 to use typesafe MFN
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Julien Grall <julien.grall@arm.com>, Wei Liu <wl@xen.org>,
 Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhlIHRoaXJkIHBhcmFtZXRlciBvZiB1cGRhdGVfaW50cHRlKCkgaXMgYSBNRk4sIHNvIGl0IGNh
biBiZSBzd2l0Y2hlZAp0byB1c2UgdGhlIHR5cGVzYWZlLgoKQXQgdGhlIHNhbWUgdGltZSwgdGhl
IHR5cGVzYWZlIGlzIHByb3BhZ2F0ZWQgYXMgZmFyIGFzIHBvc3NpYmxlIHdpdGhvdXQKbWFqb3Ig
bW9kaWZpY2F0aW9ucy4KClNpZ25lZC1vZmYtYnk6IEp1bGllbiBHcmFsbCA8anVsaWVuLmdyYWxs
QGFybS5jb20+ClJldmlld2VkLWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+Cgot
LS0KICAgIENoYW5nZXMgaW4gdjM6CiAgICAgICAgLSBSZW1vdmUgc3RyYXkgY2hhbmdlIGluIG1v
ZF9sMV9lbnRyeSgpCiAgICAgICAgLSBSZW1vdmUgc3RyYXkgcGFyZW50aGVzZXMgaW4gZG9fbW11
X3VwZGF0ZSgpCiAgICAgICAgLSBSZS1mbG93IHVwZGF0ZV9pbnRwdGUoKSBwcm90b3R5cGUKICAg
ICAgICAtIEFkZCBKYW4ncyByZXZpZXdlZC1ieQoKICAgIENoYW5nZXMgaW4gdjI6CiAgICAgICAg
LSBQYXRjaCBhZGRlZAotLS0KIHhlbi9hcmNoL3g4Ni9tbS5jICAgICAgICAgICAgICAgfCA4MCAr
KysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLQogeGVuL2FyY2gveDg2L3B2
L2dyYW50X3RhYmxlLmMgICB8ICA2ICsrLS0KIHhlbi9hcmNoL3g4Ni9wdi9tbS5oICAgICAgICAg
ICAgfCAgNyArKy0tCiB4ZW4vYXJjaC94ODYvcHYvcm8tcGFnZS1mYXVsdC5jIHwgIDIgKy0KIDQg
ZmlsZXMgY2hhbmdlZCwgNDcgaW5zZXJ0aW9ucygrKSwgNDggZGVsZXRpb25zKC0pCgpkaWZmIC0t
Z2l0IGEveGVuL2FyY2gveDg2L21tLmMgYi94ZW4vYXJjaC94ODYvbW0uYwppbmRleCAzZDNkOGJk
N2E4Li4zYmIxMjc4MmExIDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvbW0uYworKysgYi94ZW4v
YXJjaC94ODYvbW0uYwpAQCAtMjA3OCw3ICsyMDc4LDcgQEAgdm9pZCBwYWdlX3VubG9jayhzdHJ1
Y3QgcGFnZV9pbmZvICpwYWdlKQogCiAvKiBVcGRhdGUgdGhlIEwxIGVudHJ5IGF0IHBsMWUgdG8g
bmV3IHZhbHVlIG5sMWUuICovCiBzdGF0aWMgaW50IG1vZF9sMV9lbnRyeShsMV9wZ2VudHJ5X3Qg
KnBsMWUsIGwxX3BnZW50cnlfdCBubDFlLAotICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWdu
ZWQgbG9uZyBnbDFtZm4sIHVuc2lnbmVkIGludCBjbWQsCisgICAgICAgICAgICAgICAgICAgICAg
ICBtZm5fdCBnbDFtZm4sIHVuc2lnbmVkIGludCBjbWQsCiAgICAgICAgICAgICAgICAgICAgICAg
ICBzdHJ1Y3QgdmNwdSAqcHRfdmNwdSwgc3RydWN0IGRvbWFpbiAqcGdfZG9tKQogewogICAgIGJv
b2wgcHJlc2VydmVfYWQgPSAoY21kID09IE1NVV9QVF9VUERBVEVfUFJFU0VSVkVfQUQpOwpAQCAt
MjE4NiwxNiArMjE4NiwxNiBAQCBzdGF0aWMgaW50IG1vZF9sMV9lbnRyeShsMV9wZ2VudHJ5X3Qg
KnBsMWUsIGwxX3BnZW50cnlfdCBubDFlLAogfQogCiAKLS8qIFVwZGF0ZSB0aGUgTDIgZW50cnkg
YXQgcGwyZSB0byBuZXcgdmFsdWUgbmwyZS4gcGwyZSBpcyB3aXRoaW4gZnJhbWUgcGZuLiAqLwor
LyogVXBkYXRlIHRoZSBMMiBlbnRyeSBhdCBwbDJlIHRvIG5ldyB2YWx1ZSBubDJlLiBwbDJlIGlz
IHdpdGhpbiBmcmFtZSBtZm4uICovCiBzdGF0aWMgaW50IG1vZF9sMl9lbnRyeShsMl9wZ2VudHJ5
X3QgKnBsMmUsCiAgICAgICAgICAgICAgICAgICAgICAgICBsMl9wZ2VudHJ5X3QgbmwyZSwKLSAg
ICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGxvbmcgcGZuLAorICAgICAgICAgICAgICAg
ICAgICAgICAgbWZuX3QgbWZuLAogICAgICAgICAgICAgICAgICAgICAgICAgaW50IHByZXNlcnZl
X2FkLAogICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHZjcHUgKnZjcHUpCiB7CiAgICAg
bDJfcGdlbnRyeV90IG9sMmU7CiAgICAgc3RydWN0IGRvbWFpbiAqZCA9IHZjcHUtPmRvbWFpbjsK
LSAgICBzdHJ1Y3QgcGFnZV9pbmZvICpsMnBnID0gbWZuX3RvX3BhZ2UoX21mbihwZm4pKTsKKyAg
ICBzdHJ1Y3QgcGFnZV9pbmZvICpsMnBnID0gbWZuX3RvX3BhZ2UobWZuKTsKICAgICB1bnNpZ25l
ZCBsb25nIHR5cGUgPSBsMnBnLT51LmludXNlLnR5cGVfaW5mbzsKICAgICBpbnQgcmMgPSAwOwog
CkBAIC0yMjIyLDE2ICsyMjIyLDE2IEBAIHN0YXRpYyBpbnQgbW9kX2wyX2VudHJ5KGwyX3BnZW50
cnlfdCAqcGwyZSwKICAgICAgICAgaWYgKCAhbDJlX2hhc19jaGFuZ2VkKG9sMmUsIG5sMmUsIH5G
QVNUUEFUSF9GTEFHX1dISVRFTElTVCkgKQogICAgICAgICB7CiAgICAgICAgICAgICBubDJlID0g
YWRqdXN0X2d1ZXN0X2wyZShubDJlLCBkKTsKLSAgICAgICAgICAgIGlmICggVVBEQVRFX0VOVFJZ
KGwyLCBwbDJlLCBvbDJlLCBubDJlLCBwZm4sIHZjcHUsIHByZXNlcnZlX2FkKSApCisgICAgICAg
ICAgICBpZiAoIFVQREFURV9FTlRSWShsMiwgcGwyZSwgb2wyZSwgbmwyZSwgbWZuLCB2Y3B1LCBw
cmVzZXJ2ZV9hZCkgKQogICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgcmV0
dXJuIC1FQlVTWTsKICAgICAgICAgfQogCi0gICAgICAgIGlmICggdW5saWtlbHkoKHJjID0gZ2V0
X3BhZ2VfZnJvbV9sMmUobmwyZSwgcGZuLCBkLCAwKSkgPCAwKSApCisgICAgICAgIGlmICggdW5s
aWtlbHkoKHJjID0gZ2V0X3BhZ2VfZnJvbV9sMmUobmwyZSwgbWZuX3gobWZuKSwgZCwgMCkpIDwg
MCkgKQogICAgICAgICAgICAgcmV0dXJuIHJjOwogCiAgICAgICAgIG5sMmUgPSBhZGp1c3RfZ3Vl
c3RfbDJlKG5sMmUsIGQpOwotICAgICAgICBpZiAoIHVubGlrZWx5KCFVUERBVEVfRU5UUlkobDIs
IHBsMmUsIG9sMmUsIG5sMmUsIHBmbiwgdmNwdSwKKyAgICAgICAgaWYgKCB1bmxpa2VseSghVVBE
QVRFX0VOVFJZKGwyLCBwbDJlLCBvbDJlLCBubDJlLCBtZm4sIHZjcHUsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBwcmVzZXJ2ZV9hZCkpICkKICAgICAgICAgewogICAgICAg
ICAgICAgb2wyZSA9IG5sMmU7CkBAIC0yMjQwLDIxICsyMjQwLDIxIEBAIHN0YXRpYyBpbnQgbW9k
X2wyX2VudHJ5KGwyX3BnZW50cnlfdCAqcGwyZSwKICAgICB9CiAgICAgZWxzZSBpZiAoIHB2X2wx
dGZfY2hlY2tfbDJlKGQsIG5sMmUpICkKICAgICAgICAgcmV0dXJuIC1FUkVTVEFSVDsKLSAgICBl
bHNlIGlmICggdW5saWtlbHkoIVVQREFURV9FTlRSWShsMiwgcGwyZSwgb2wyZSwgbmwyZSwgcGZu
LCB2Y3B1LAorICAgIGVsc2UgaWYgKCB1bmxpa2VseSghVVBEQVRFX0VOVFJZKGwyLCBwbDJlLCBv
bDJlLCBubDJlLCBtZm4sIHZjcHUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgcHJlc2VydmVfYWQpKSApCiAgICAgewogICAgICAgICByZXR1cm4gLUVCVVNZOwogICAgIH0K
IAotICAgIHB1dF9wYWdlX2Zyb21fbDJlKG9sMmUsIHBmbiwgMCwgdHJ1ZSk7CisgICAgcHV0X3Bh
Z2VfZnJvbV9sMmUob2wyZSwgbWZuX3gobWZuKSwgMCwgdHJ1ZSk7CiAKICAgICByZXR1cm4gcmM7
CiB9CiAKLS8qIFVwZGF0ZSB0aGUgTDMgZW50cnkgYXQgcGwzZSB0byBuZXcgdmFsdWUgbmwzZS4g
cGwzZSBpcyB3aXRoaW4gZnJhbWUgcGZuLiAqLworLyogVXBkYXRlIHRoZSBMMyBlbnRyeSBhdCBw
bDNlIHRvIG5ldyB2YWx1ZSBubDNlLiBwbDNlIGlzIHdpdGhpbiBmcmFtZSBtZm4uICovCiBzdGF0
aWMgaW50IG1vZF9sM19lbnRyeShsM19wZ2VudHJ5X3QgKnBsM2UsCiAgICAgICAgICAgICAgICAg
ICAgICAgICBsM19wZ2VudHJ5X3QgbmwzZSwKLSAgICAgICAgICAgICAgICAgICAgICAgIHVuc2ln
bmVkIGxvbmcgcGZuLAorICAgICAgICAgICAgICAgICAgICAgICAgbWZuX3QgbWZuLAogICAgICAg
ICAgICAgICAgICAgICAgICAgaW50IHByZXNlcnZlX2FkLAogICAgICAgICAgICAgICAgICAgICAg
ICAgc3RydWN0IHZjcHUgKnZjcHUpCiB7CkBAIC0yMjg1LDE3ICsyMjg1LDE3IEBAIHN0YXRpYyBp
bnQgbW9kX2wzX2VudHJ5KGwzX3BnZW50cnlfdCAqcGwzZSwKICAgICAgICAgaWYgKCAhbDNlX2hh
c19jaGFuZ2VkKG9sM2UsIG5sM2UsIH5GQVNUUEFUSF9GTEFHX1dISVRFTElTVCkgKQogICAgICAg
ICB7CiAgICAgICAgICAgICBubDNlID0gYWRqdXN0X2d1ZXN0X2wzZShubDNlLCBkKTsKLSAgICAg
ICAgICAgIHJjID0gVVBEQVRFX0VOVFJZKGwzLCBwbDNlLCBvbDNlLCBubDNlLCBwZm4sIHZjcHUs
IHByZXNlcnZlX2FkKTsKKyAgICAgICAgICAgIHJjID0gVVBEQVRFX0VOVFJZKGwzLCBwbDNlLCBv
bDNlLCBubDNlLCBtZm4sIHZjcHUsIHByZXNlcnZlX2FkKTsKICAgICAgICAgICAgIHJldHVybiBy
YyA/IDAgOiAtRUZBVUxUOwogICAgICAgICB9CiAKLSAgICAgICAgcmMgPSBnZXRfcGFnZV9mcm9t
X2wzZShubDNlLCBwZm4sIGQsIDApOworICAgICAgICByYyA9IGdldF9wYWdlX2Zyb21fbDNlKG5s
M2UsIG1mbl94KG1mbiksIGQsIDApOwogICAgICAgICBpZiAoIHVubGlrZWx5KHJjIDwgMCkgKQog
ICAgICAgICAgICAgcmV0dXJuIHJjOwogICAgICAgICByYyA9IDA7CiAKICAgICAgICAgbmwzZSA9
IGFkanVzdF9ndWVzdF9sM2UobmwzZSwgZCk7Ci0gICAgICAgIGlmICggdW5saWtlbHkoIVVQREFU
RV9FTlRSWShsMywgcGwzZSwgb2wzZSwgbmwzZSwgcGZuLCB2Y3B1LAorICAgICAgICBpZiAoIHVu
bGlrZWx5KCFVUERBVEVfRU5UUlkobDMsIHBsM2UsIG9sM2UsIG5sM2UsIG1mbiwgdmNwdSwKICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNlcnZlX2FkKSkgKQogICAgICAg
ICB7CiAgICAgICAgICAgICBvbDNlID0gbmwzZTsKQEAgLTIzMDQsNyArMjMwNCw3IEBAIHN0YXRp
YyBpbnQgbW9kX2wzX2VudHJ5KGwzX3BnZW50cnlfdCAqcGwzZSwKICAgICB9CiAgICAgZWxzZSBp
ZiAoIHB2X2wxdGZfY2hlY2tfbDNlKGQsIG5sM2UpICkKICAgICAgICAgcmV0dXJuIC1FUkVTVEFS
VDsKLSAgICBlbHNlIGlmICggdW5saWtlbHkoIVVQREFURV9FTlRSWShsMywgcGwzZSwgb2wzZSwg
bmwzZSwgcGZuLCB2Y3B1LAorICAgIGVsc2UgaWYgKCB1bmxpa2VseSghVVBEQVRFX0VOVFJZKGwz
LCBwbDNlLCBvbDNlLCBubDNlLCBtZm4sIHZjcHUsCiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgcHJlc2VydmVfYWQpKSApCiAgICAgewogICAgICAgICByZXR1cm4gLUVGQVVM
VDsKQEAgLTIzMTQsMTQgKzIzMTQsMTQgQEAgc3RhdGljIGludCBtb2RfbDNfZW50cnkobDNfcGdl
bnRyeV90ICpwbDNlLAogICAgICAgICBpZiAoICFjcmVhdGVfcGFlX3hlbl9tYXBwaW5ncyhkLCBw
bDNlKSApCiAgICAgICAgICAgICBCVUcoKTsKIAotICAgIHB1dF9wYWdlX2Zyb21fbDNlKG9sM2Us
IHBmbiwgMCwgMSk7CisgICAgcHV0X3BhZ2VfZnJvbV9sM2Uob2wzZSwgbWZuX3gobWZuKSwgMCwg
MSk7CiAgICAgcmV0dXJuIHJjOwogfQogCi0vKiBVcGRhdGUgdGhlIEw0IGVudHJ5IGF0IHBsNGUg
dG8gbmV3IHZhbHVlIG5sNGUuIHBsNGUgaXMgd2l0aGluIGZyYW1lIHBmbi4gKi8KKy8qIFVwZGF0
ZSB0aGUgTDQgZW50cnkgYXQgcGw0ZSB0byBuZXcgdmFsdWUgbmw0ZS4gcGw0ZSBpcyB3aXRoaW4g
ZnJhbWUgbWZuLiAqLwogc3RhdGljIGludCBtb2RfbDRfZW50cnkobDRfcGdlbnRyeV90ICpwbDRl
LAogICAgICAgICAgICAgICAgICAgICAgICAgbDRfcGdlbnRyeV90IG5sNGUsCi0gICAgICAgICAg
ICAgICAgICAgICAgICB1bnNpZ25lZCBsb25nIHBmbiwKKyAgICAgICAgICAgICAgICAgICAgICAg
IG1mbl90IG1mbiwKICAgICAgICAgICAgICAgICAgICAgICAgIGludCBwcmVzZXJ2ZV9hZCwKICAg
ICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCB2Y3B1ICp2Y3B1KQogewpAQCAtMjM1MiwxNyAr
MjM1MiwxNyBAQCBzdGF0aWMgaW50IG1vZF9sNF9lbnRyeShsNF9wZ2VudHJ5X3QgKnBsNGUsCiAg
ICAgICAgIGlmICggIWw0ZV9oYXNfY2hhbmdlZChvbDRlLCBubDRlLCB+RkFTVFBBVEhfRkxBR19X
SElURUxJU1QpICkKICAgICAgICAgewogICAgICAgICAgICAgbmw0ZSA9IGFkanVzdF9ndWVzdF9s
NGUobmw0ZSwgZCk7Ci0gICAgICAgICAgICByYyA9IFVQREFURV9FTlRSWShsNCwgcGw0ZSwgb2w0
ZSwgbmw0ZSwgcGZuLCB2Y3B1LCBwcmVzZXJ2ZV9hZCk7CisgICAgICAgICAgICByYyA9IFVQREFU
RV9FTlRSWShsNCwgcGw0ZSwgb2w0ZSwgbmw0ZSwgbWZuLCB2Y3B1LCBwcmVzZXJ2ZV9hZCk7CiAg
ICAgICAgICAgICByZXR1cm4gcmMgPyAwIDogLUVGQVVMVDsKICAgICAgICAgfQogCi0gICAgICAg
IHJjID0gZ2V0X3BhZ2VfZnJvbV9sNGUobmw0ZSwgcGZuLCBkLCAwKTsKKyAgICAgICAgcmMgPSBn
ZXRfcGFnZV9mcm9tX2w0ZShubDRlLCBtZm5feChtZm4pLCBkLCAwKTsKICAgICAgICAgaWYgKCB1
bmxpa2VseShyYyA8IDApICkKICAgICAgICAgICAgIHJldHVybiByYzsKICAgICAgICAgcmMgPSAw
OwogCiAgICAgICAgIG5sNGUgPSBhZGp1c3RfZ3Vlc3RfbDRlKG5sNGUsIGQpOwotICAgICAgICBp
ZiAoIHVubGlrZWx5KCFVUERBVEVfRU5UUlkobDQsIHBsNGUsIG9sNGUsIG5sNGUsIHBmbiwgdmNw
dSwKKyAgICAgICAgaWYgKCB1bmxpa2VseSghVVBEQVRFX0VOVFJZKGw0LCBwbDRlLCBvbDRlLCBu
bDRlLCBtZm4sIHZjcHUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVz
ZXJ2ZV9hZCkpICkKICAgICAgICAgewogICAgICAgICAgICAgb2w0ZSA9IG5sNGU7CkBAIC0yMzcx
LDEzICsyMzcxLDEzIEBAIHN0YXRpYyBpbnQgbW9kX2w0X2VudHJ5KGw0X3BnZW50cnlfdCAqcGw0
ZSwKICAgICB9CiAgICAgZWxzZSBpZiAoIHB2X2wxdGZfY2hlY2tfbDRlKGQsIG5sNGUpICkKICAg
ICAgICAgcmV0dXJuIC1FUkVTVEFSVDsKLSAgICBlbHNlIGlmICggdW5saWtlbHkoIVVQREFURV9F
TlRSWShsNCwgcGw0ZSwgb2w0ZSwgbmw0ZSwgcGZuLCB2Y3B1LAorICAgIGVsc2UgaWYgKCB1bmxp
a2VseSghVVBEQVRFX0VOVFJZKGw0LCBwbDRlLCBvbDRlLCBubDRlLCBtZm4sIHZjcHUsCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2VydmVfYWQpKSApCiAgICAgewog
ICAgICAgICByZXR1cm4gLUVGQVVMVDsKICAgICB9CiAKLSAgICBwdXRfcGFnZV9mcm9tX2w0ZShv
bDRlLCBwZm4sIDAsIDEpOworICAgIHB1dF9wYWdlX2Zyb21fbDRlKG9sNGUsIG1mbl94KG1mbiks
IDAsIDEpOwogICAgIHJldHVybiByYzsKIH0KICNlbmRpZiAvKiBDT05GSUdfUFYgKi8KQEAgLTMw
NzksNyArMzA3OSw3IEBAIGludCBuZXdfZ3Vlc3RfY3IzKG1mbl90IG1mbikKICAgICAgICAgICAg
ICAgICAgICAgICAgICAgbDRlX2Zyb21fbWZuKG1mbiwKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIChfUEFHRV9QUkVTRU5UIHwgX1BBR0VfUlcgfAogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9QQUdFX1VTRVIgfCBfUEFHRV9BQ0NFU1NFRCkp
LAotICAgICAgICAgICAgICAgICAgICAgICAgICBtZm5feChndF9tZm4pLCAwLCBjdXJyKTsKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgZ3RfbWZuLCAwLCBjdXJyKTsKICAgICAgICAgdW5tYXBf
ZG9tYWluX3BhZ2UocGw0ZSk7CiAgICAgICAgIHN3aXRjaCAoIHJjICkKICAgICAgICAgewpAQCAt
Mzc0OCwxMiArMzc0OCwxMiBAQCBsb25nIGRvX21tdV91cGRhdGUoCiB7CiAgICAgc3RydWN0IG1t
dV91cGRhdGUgcmVxOwogICAgIHZvaWQgKnZhID0gTlVMTDsKLSAgICB1bnNpZ25lZCBsb25nIGdw
Zm4sIGdtZm4sIG1mbjsKKyAgICB1bnNpZ25lZCBsb25nIGdwZm4sIGdtZm47CiAgICAgc3RydWN0
IHBhZ2VfaW5mbyAqcGFnZTsKICAgICB1bnNpZ25lZCBpbnQgY21kLCBpID0gMCwgZG9uZSA9IDAs
IHB0X2RvbTsKICAgICBzdHJ1Y3QgdmNwdSAqY3VyciA9IGN1cnJlbnQsICp2ID0gY3VycjsKICAg
ICBzdHJ1Y3QgZG9tYWluICpkID0gdi0+ZG9tYWluLCAqcHRfb3duZXIgPSBkLCAqcGdfb3duZXI7
Ci0gICAgbWZuX3QgbWFwX21mbiA9IElOVkFMSURfTUZOOworICAgIG1mbl90IG1hcF9tZm4gPSBJ
TlZBTElEX01GTiwgbWZuOwogICAgIGJvb2wgc3luY19ndWVzdCA9IGZhbHNlOwogICAgIHVpbnQz
Ml90IHhzbV9uZWVkZWQgPSAwOwogICAgIHVpbnQzMl90IHhzbV9jaGVja2VkID0gMDsKQEAgLTM4
NzksMTQgKzM4NzksMTQgQEAgbG9uZyBkb19tbXVfdXBkYXRlKAogICAgICAgICAgICAgICAgIGJy
ZWFrOwogICAgICAgICAgICAgfQogCi0gICAgICAgICAgICBtZm4gPSBtZm5feChwYWdlX3RvX21m
bihwYWdlKSk7CisgICAgICAgICAgICBtZm4gPSBwYWdlX3RvX21mbihwYWdlKTsKIAotICAgICAg
ICAgICAgaWYgKCAhbWZuX2VxKF9tZm4obWZuKSwgbWFwX21mbikgKQorICAgICAgICAgICAgaWYg
KCAhbWZuX2VxKG1mbiwgbWFwX21mbikgKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAg
IGlmICggdmEgKQogICAgICAgICAgICAgICAgICAgICB1bm1hcF9kb21haW5fcGFnZSh2YSk7Ci0g
ICAgICAgICAgICAgICAgdmEgPSBtYXBfZG9tYWluX3BhZ2UoX21mbihtZm4pKTsKLSAgICAgICAg
ICAgICAgICBtYXBfbWZuID0gX21mbihtZm4pOworICAgICAgICAgICAgICAgIHZhID0gbWFwX2Rv
bWFpbl9wYWdlKG1mbik7CisgICAgICAgICAgICAgICAgbWFwX21mbiA9IG1mbjsKICAgICAgICAg
ICAgIH0KICAgICAgICAgICAgIHZhID0gX3AoKCh1bnNpZ25lZCBsb25nKXZhICYgUEFHRV9NQVNL
KSArIChyZXEucHRyICYgflBBR0VfTUFTSykpOwogCkBAIC0zOTIyLDcgKzM5MjIsOCBAQCBsb25n
IGRvX21tdV91cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAg
ICAgICAgIGJvb2wgbG9jYWxfaW5fdXNlID0gZmFsc2U7CiAKLSAgICAgICAgICAgICAgICAgICAg
ICAgIGlmICggcGFnZXRhYmxlX2dldF9wZm4oY3Vyci0+YXJjaC5ndWVzdF90YWJsZSkgPT0gbWZu
ICkKKyAgICAgICAgICAgICAgICAgICAgICAgIGlmICggbWZuX2VxKHBhZ2V0YWJsZV9nZXRfbWZu
KGN1cnItPmFyY2guZ3Vlc3RfdGFibGUpLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgbWZuKSApCiAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgbG9jYWxfaW5fdXNlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBnZXRfY3B1X2luZm8oKS0+cm9vdF9wZ3RfY2hhbmdlZCA9IHRydWU7CkBAIC0zOTM1LDE1
ICszOTM2LDE1IEBAIGxvbmcgZG9fbW11X3VwZGF0ZSgKICAgICAgICAgICAgICAgICAgICAgICAg
ICAqLwogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAocGFnZS0+dS5pbnVzZS50eXBlX2lu
Zm8gJiBQR1RfY291bnRfbWFzaykgPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMSAr
ICEhKHBhZ2UtPnUuaW51c2UudHlwZV9pbmZvICYgUEdUX3Bpbm5lZCkgKwotICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgKHBhZ2V0YWJsZV9nZXRfcGZuKGN1cnItPmFyY2guZ3Vlc3RfdGFi
bGVfdXNlcikgPT0KLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZm4pICsgbG9jYWxf
aW5fdXNlKSApCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZm5fZXEocGFnZXRhYmxl
X2dldF9tZm4oY3Vyci0+YXJjaC5ndWVzdF90YWJsZV91c2VyKSwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBtZm4pICsgbG9jYWxfaW5fdXNlKSApCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgc3luY19ndWVzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIH0K
ICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAKICAgICAgICAgICAgICAgICBjYXNlIFBHVF93
cml0YWJsZV9wYWdlOgogICAgICAgICAgICAgICAgICAgICBwZXJmY19pbmNyKHdyaXRhYmxlX21t
dV91cGRhdGVzKTsKLSAgICAgICAgICAgICAgICAgICAgaWYgKCBwYWdpbmdfd3JpdGVfZ3Vlc3Rf
ZW50cnkodiwgdmEsIHJlcS52YWwsIF9tZm4obWZuKSkgKQorICAgICAgICAgICAgICAgICAgICBp
ZiAoIHBhZ2luZ193cml0ZV9ndWVzdF9lbnRyeSh2LCB2YSwgcmVxLnZhbCwgbWZuKSApCiAgICAg
ICAgICAgICAgICAgICAgICAgICByYyA9IDA7CiAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwog
ICAgICAgICAgICAgICAgIH0KQEAgLTM5NTQsNyArMzk1NSw3IEBAIGxvbmcgZG9fbW11X3VwZGF0
ZSgKICAgICAgICAgICAgIGVsc2UgaWYgKCBnZXRfcGFnZV90eXBlKHBhZ2UsIFBHVF93cml0YWJs
ZV9wYWdlKSApCiAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgcGVyZmNfaW5jcih3cml0
YWJsZV9tbXVfdXBkYXRlcyk7Ci0gICAgICAgICAgICAgICAgaWYgKCBwYWdpbmdfd3JpdGVfZ3Vl
c3RfZW50cnkodiwgdmEsIHJlcS52YWwsIF9tZm4obWZuKSkgKQorICAgICAgICAgICAgICAgIGlm
ICggcGFnaW5nX3dyaXRlX2d1ZXN0X2VudHJ5KHYsIHZhLCByZXEudmFsLCBtZm4pICkKICAgICAg
ICAgICAgICAgICAgICAgcmMgPSAwOwogICAgICAgICAgICAgICAgIHB1dF9wYWdlX3R5cGUocGFn
ZSk7CiAgICAgICAgICAgICB9CkBAIC0zOTc2LDcgKzM5NzcsNyBAQCBsb25nIGRvX21tdV91cGRh
dGUoCiAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICB9CiAKLSAgICAgICAgICAg
IG1mbiA9IHJlcS5wdHIgPj4gUEFHRV9TSElGVDsKKyAgICAgICAgICAgIG1mbiA9IG1hZGRyX3Rv
X21mbihyZXEucHRyKTsKICAgICAgICAgICAgIGdwZm4gPSByZXEudmFsOwogCiAgICAgICAgICAg
ICB4c21fbmVlZGVkIHw9IFhTTV9NTVVfTUFDSFBIWVNfVVBEQVRFOwpAQCAtMzk4OCw3ICszOTg5
LDcgQEAgbG9uZyBkb19tbXVfdXBkYXRlKAogICAgICAgICAgICAgICAgIHhzbV9jaGVja2VkID0g
eHNtX25lZWRlZDsKICAgICAgICAgICAgIH0KIAotICAgICAgICAgICAgcGFnZSA9IGdldF9wYWdl
X2Zyb21fbWZuKF9tZm4obWZuKSwgcGdfb3duZXIpOworICAgICAgICAgICAgcGFnZSA9IGdldF9w
YWdlX2Zyb21fbWZuKG1mbiwgcGdfb3duZXIpOwogICAgICAgICAgICAgaWYgKCB1bmxpa2VseSgh
cGFnZSkgKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIGdkcHJpbnRrKFhFTkxPR19X
QVJOSU5HLApAQCAtMzk5Nyw3ICszOTk4LDcgQEAgbG9uZyBkb19tbXVfdXBkYXRlKAogICAgICAg
ICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgfQogCi0gICAgICAgICAgICBzZXRfZ3Bmbl9m
cm9tX21mbihtZm4sIGdwZm4pOworICAgICAgICAgICAgc2V0X2dwZm5fZnJvbV9tZm4obWZuX3go
bWZuKSwgZ3Bmbik7CiAgICAgICAgICAgICBwYWdpbmdfbWFya19wZm5fZGlydHkocGdfb3duZXIs
IF9wZm4oZ3BmbikpOwogCiAgICAgICAgICAgICBwdXRfcGFnZShwYWdlKTsKQEAgLTQyNTMsOCAr
NDI1NCw3IEBAIHN0YXRpYyBpbnQgX19kb191cGRhdGVfdmFfbWFwcGluZygKICAgICAgICAgZ290
byBvdXQ7CiAgICAgfQogCi0gICAgcmMgPSBtb2RfbDFfZW50cnkocGwxZSwgdmFsLCBtZm5feChn
bDFtZm4pLCBNTVVfTk9STUFMX1BUX1VQREFURSwgdiwKLSAgICAgICAgICAgICAgICAgICAgICBw
Z19vd25lcik7CisgICAgcmMgPSBtb2RfbDFfZW50cnkocGwxZSwgdmFsLCBnbDFtZm4sIE1NVV9O
T1JNQUxfUFRfVVBEQVRFLCB2LCBwZ19vd25lcik7CiAKICAgICBwYWdlX3VubG9jayhnbDFwZyk7
CiAgICAgcHV0X3BhZ2UoZ2wxcGcpOwpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L3B2L2dyYW50
X3RhYmxlLmMgYi94ZW4vYXJjaC94ODYvcHYvZ3JhbnRfdGFibGUuYwppbmRleCA1MTgwMzM0ZjQy
Li4wMzI1NjE4Yzk4IDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvcHYvZ3JhbnRfdGFibGUuYwor
KysgYi94ZW4vYXJjaC94ODYvcHYvZ3JhbnRfdGFibGUuYwpAQCAtMTA4LDcgKzEwOCw3IEBAIGlu
dCBjcmVhdGVfZ3JhbnRfcHZfbWFwcGluZyh1aW50NjRfdCBhZGRyLCBtZm5fdCBmcmFtZSwKICAg
ICAgICAgZ290byBvdXRfdW5sb2NrOwogCiAgICAgb2wxZSA9ICpwbDFlOwotICAgIGlmICggVVBE
QVRFX0VOVFJZKGwxLCBwbDFlLCBvbDFlLCBubDFlLCBtZm5feChnbDFtZm4pLCBjdXJyLCAwKSAp
CisgICAgaWYgKCBVUERBVEVfRU5UUlkobDEsIHBsMWUsIG9sMWUsIG5sMWUsIGdsMW1mbiwgY3Vy
ciwgMCkgKQogICAgICAgICByYyA9IEdOVFNUX29rYXk7CiAKICBvdXRfdW5sb2NrOgpAQCAtMTY1
LDcgKzE2NSw3IEBAIHN0YXRpYyBib29sIHN0ZWFsX2xpbmVhcl9hZGRyZXNzKHVuc2lnbmVkIGxv
bmcgbGluZWFyLCBsMV9wZ2VudHJ5X3QgKm91dCkKICAgICAgICAgZ290byBvdXRfdW5sb2NrOwog
CiAgICAgb2wxZSA9ICpwbDFlOwotICAgIG9rYXkgPSBVUERBVEVfRU5UUlkobDEsIHBsMWUsIG9s
MWUsIGwxZV9lbXB0eSgpLCBtZm5feChnbDFtZm4pLCBjdXJyLCAwKTsKKyAgICBva2F5ID0gVVBE
QVRFX0VOVFJZKGwxLCBwbDFlLCBvbDFlLCBsMWVfZW1wdHkoKSwgZ2wxbWZuLCBjdXJyLCAwKTsK
IAogICAgIGlmICggb2theSApCiAgICAgICAgICpvdXQgPSBvbDFlOwpAQCAtMjkzLDcgKzI5Myw3
IEBAIGludCByZXBsYWNlX2dyYW50X3B2X21hcHBpbmcodWludDY0X3QgYWRkciwgbWZuX3QgZnJh
bWUsCiAgICAgICAgICAgICAgICAgICJQVEUgZmxhZ3MgJXggZm9yICUiUFJJeDY0IiBkb24ndCBt
YXRjaCBncmFudCAoJXgpXG4iLAogICAgICAgICAgICAgICAgICBsMWVfZ2V0X2ZsYWdzKG9sMWUp
LCBhZGRyLCBncmFudF9wdGVfZmxhZ3MpOwogCi0gICAgaWYgKCBVUERBVEVfRU5UUlkobDEsIHBs
MWUsIG9sMWUsIG5sMWUsIG1mbl94KGdsMW1mbiksIGN1cnIsIDApICkKKyAgICBpZiAoIFVQREFU
RV9FTlRSWShsMSwgcGwxZSwgb2wxZSwgbmwxZSwgZ2wxbWZuLCBjdXJyLCAwKSApCiAgICAgICAg
IHJjID0gR05UU1Rfb2theTsKIAogIG91dF91bmxvY2s6CmRpZmYgLS1naXQgYS94ZW4vYXJjaC94
ODYvcHYvbW0uaCBiL3hlbi9hcmNoL3g4Ni9wdi9tbS5oCmluZGV4IDk3NjIwOWJhNGMuLjJkNDI3
YjQxOGQgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9wdi9tbS5oCisrKyBiL3hlbi9hcmNoL3g4
Ni9wdi9tbS5oCkBAIC0zNywxNSArMzcsMTQgQEAgc3RhdGljIGlubGluZSBsMV9wZ2VudHJ5X3Qg
Z3Vlc3RfZ2V0X2VmZl9sMWUodW5zaWduZWQgbG9uZyBsaW5lYXIpCiAgKiBSZXR1cm5zIGZhbHNl
IGZvciBmYWlsdXJlIChwb2ludGVyIG5vdCB2YWxpZCksIHRydWUgZm9yIHN1Y2Nlc3MuCiAgKi8K
IHN0YXRpYyBpbmxpbmUgYm9vbCB1cGRhdGVfaW50cHRlKGludHB0ZV90ICpwLCBpbnRwdGVfdCBv
bGQsIGludHB0ZV90IG5ldywKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2ln
bmVkIGxvbmcgbWZuLCBzdHJ1Y3QgdmNwdSAqdiwKLSAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIGJvb2wgcHJlc2VydmVfYWQpCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBtZm5fdCBtZm4sIHN0cnVjdCB2Y3B1ICp2LCBib29sIHByZXNlcnZlX2FkKQogewogICAgIGJv
b2wgcnYgPSB0cnVlOwogCiAjaWZuZGVmIFBURV9VUERBVEVfV0lUSF9DTVBYQ0hHCiAgICAgaWYg
KCAhcHJlc2VydmVfYWQgKQogICAgIHsKLSAgICAgICAgcnYgPSBwYWdpbmdfd3JpdGVfZ3Vlc3Rf
ZW50cnkodiwgcCwgbmV3LCBfbWZuKG1mbikpOworICAgICAgICBydiA9IHBhZ2luZ193cml0ZV9n
dWVzdF9lbnRyeSh2LCBwLCBuZXcsIG1mbik7CiAgICAgfQogICAgIGVsc2UKICNlbmRpZgpAQCAt
NTksNyArNTgsNyBAQCBzdGF0aWMgaW5saW5lIGJvb2wgdXBkYXRlX2ludHB0ZShpbnRwdGVfdCAq
cCwgaW50cHRlX3Qgb2xkLCBpbnRwdGVfdCBuZXcsCiAgICAgICAgICAgICBpZiAoIHByZXNlcnZl
X2FkICkKICAgICAgICAgICAgICAgICBfbmV3IHw9IG9sZCAmIChfUEFHRV9BQ0NFU1NFRCB8IF9Q
QUdFX0RJUlRZKTsKIAotICAgICAgICAgICAgcnYgPSBwYWdpbmdfY21weGNoZ19ndWVzdF9lbnRy
eSh2LCBwLCAmdCwgX25ldywgX21mbihtZm4pKTsKKyAgICAgICAgICAgIHJ2ID0gcGFnaW5nX2Nt
cHhjaGdfZ3Vlc3RfZW50cnkodiwgcCwgJnQsIF9uZXcsIG1mbik7CiAgICAgICAgICAgICBpZiAo
IHVubGlrZWx5KHJ2ID09IDApICkKICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICBnZHBy
aW50ayhYRU5MT0dfV0FSTklORywKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9wdi9yby1wYWdl
LWZhdWx0LmMgYi94ZW4vYXJjaC94ODYvcHYvcm8tcGFnZS1mYXVsdC5jCmluZGV4IGZhMzU4YTYy
ZTcuLmE5MjBmYjVlMTUgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9wdi9yby1wYWdlLWZhdWx0
LmMKKysrIGIveGVuL2FyY2gveDg2L3B2L3JvLXBhZ2UtZmF1bHQuYwpAQCAtMTk3LDcgKzE5Nyw3
IEBAIHN0YXRpYyBpbnQgcHR3cl9lbXVsYXRlZF91cGRhdGUodW5zaWduZWQgbG9uZyBhZGRyLCBp
bnRwdGVfdCAqcF9vbGQsCiAgICAgZWxzZQogICAgIHsKICAgICAgICAgb2wxZSA9ICpwbDFlOwot
ICAgICAgICBpZiAoICFVUERBVEVfRU5UUlkobDEsIHBsMWUsIG9sMWUsIG5sMWUsIG1mbl94KG1m
biksIHYsIDApICkKKyAgICAgICAgaWYgKCAhVVBEQVRFX0VOVFJZKGwxLCBwbDFlLCBvbDFlLCBu
bDFlLCBtZm4sIHYsIDApICkKICAgICAgICAgICAgIEJVRygpOwogICAgIH0KIAotLSAKMi4xMS4w
CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRl
dmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9s
aXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

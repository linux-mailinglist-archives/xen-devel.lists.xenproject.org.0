Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id A79891773D1
	for <lists+xen-devel@lfdr.de>; Tue,  3 Mar 2020 11:18:39 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j94bS-0000iD-Rg; Tue, 03 Mar 2020 10:16:42 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=TLdZ=4U=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1j94bR-0000i2-6C
 for xen-devel@lists.xenproject.org; Tue, 03 Mar 2020 10:16:41 +0000
X-Inumbo-ID: 123f0078-5d38-11ea-a0dd-12813bfff9fa
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 123f0078-5d38-11ea-a0dd-12813bfff9fa;
 Tue, 03 Mar 2020 10:16:39 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id DB1A5AE35;
 Tue,  3 Mar 2020 10:16:38 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <1e1ccd2a-526c-631b-7889-35f993b2005e@suse.com>
Message-ID: <146b8935-2a48-2de7-4c21-8390b6846c05@suse.com>
Date: Tue, 3 Mar 2020 11:16:38 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:68.0) Gecko/20100101
 Thunderbird/68.5.0
MIME-Version: 1.0
In-Reply-To: <1e1ccd2a-526c-631b-7889-35f993b2005e@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v5 1/4] x86/HVM: cancel emulation when register
 state got altered
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>, Wei Liu <wl@xen.org>,
 Paul Durrant <paul@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

UmUtZXhlY3V0aW9uIChhZnRlciBoYXZpbmcgcmVjZWl2ZWQgZGF0YSBmcm9tIGEgZGV2aWNlIG1v
ZGVsKSByZWxpZXMgb24KdGhlIHNhbWUgcmVnaXN0ZXIgc3RhdGUgc3RpbGwgYmVpbmcgaW4gcGxh
Y2UgYXMgaXQgd2FzIHdoZW4gdGhlIHJlcXVlc3QKd2FzIGZpcnN0IHNlbnQgdG8gdGhlIGRldmlj
ZSBtb2RlbC4gVGhlcmVmb3JlIHZDUFUgc3RhdGUgY2hhbmdlcwplZmZlY3RlZCBieSByZW1vdGUg
c291cmNlcyBuZWVkIHRvIHJlc3VsdCBpbiBubyBhdHRlbXB0IG9mIHJlLWV4ZWN1dGlvbi4KSW5z
dGVhZCB0aGUgcmV0dXJuZWQgZGF0YSBpcyB0byBzaW1wbHkgYmUgaWdub3JlZC4KCk5vdGUgdGhh
dCBhbnkgc3VjaCBhc3luY2hyb25vdXMgc3RhdGUgY2hhbmdlcyBoYXBwZW4gd2l0aCB0aGUgdkNQ
VSBhdApsZWFzdCBwYXVzZWQgKHBvdGVudGlhbGx5IGRvd24gYW5kL29yIG5vdCBtYXJrZWQgLT5p
c19pbml0aWFsaXNlZCksIHNvCnRoZXJlJ3Mgbm8gaXNzdWUgd2l0aCBmaWRkbGluZyB3aXRoIHJl
Z2lzdGVyIHN0YXRlIGJlaGluZCB0aGUgYWN0aXZlbHkKcnVubmluZyBlbXVsYXRvcidzIGJhY2su
IEhlbmNlIHRoZSBuZXcgZnVuY3Rpb24gZG9lc24ndCBuZWVkIHRvCnN5bmNocm9uaXplIHdpdGgg
dGhlIGNvcmUgZW11bGF0aW9uIGxvZ2ljLgoKU3VnZ2VzdGVkLWJ5OiBBbmRyZXcgQ29vcGVyIDxh
bmRyZXcuY29vcGVyM0BjaXRyaXguY29tPgpTaWduZWQtb2ZmLWJ5OiBKYW4gQmV1bGljaCA8amJl
dWxpY2hAc3VzZS5jb20+Ci0tLQp2NTogTmV3LgoKLS0tIGEveGVuL2FyY2gveDg2L2RvbWN0bC5j
CisrKyBiL3hlbi9hcmNoL3g4Ni9kb21jdGwuYwpAQCAtMjEsNiArMjEsNyBAQAogI2luY2x1ZGUg
PHhlbi9pb2NhcC5oPgogI2luY2x1ZGUgPHhlbi9wYWdpbmcuaD4KICNpbmNsdWRlIDxhc20vaXJx
Lmg+CisjaW5jbHVkZSA8YXNtL2h2bS9lbXVsYXRlLmg+CiAjaW5jbHVkZSA8YXNtL2h2bS9odm0u
aD4KICNpbmNsdWRlIDxhc20vaHZtL3N1cHBvcnQuaD4KICNpbmNsdWRlIDxhc20vcHJvY2Vzc29y
Lmg+CkBAIC0xMTQ3LDExICsxMTQ4LDE2IEBAIGxvbmcgYXJjaF9kb19kb21jdGwoCiAgICAgICAg
ICAgICBlbHNlCiAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgdmNwdV9wYXVzZSh2KTsK
KwogICAgICAgICAgICAgICAgIHYtPmFyY2gueGNyMCA9IF94Y3IwOwogICAgICAgICAgICAgICAg
IHYtPmFyY2gueGNyMF9hY2N1bSA9IF94Y3IwX2FjY3VtOwogICAgICAgICAgICAgICAgIHYtPmFy
Y2gubm9ubGF6eV94c3RhdGVfdXNlZCA9IF94Y3IwX2FjY3VtICYgWFNUQVRFX05PTkxBWlk7CiAg
ICAgICAgICAgICAgICAgY29tcHJlc3NfeHNhdmVfc3RhdGVzKHYsIF94c2F2ZV9hcmVhLAogICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmMtPnNpemUgLSBQVl9YU0FWRV9I
RFJfU0laRSk7CisKKyAgICAgICAgICAgICAgICBpZiAoIGlzX2h2bV9kb21haW4oZCkgKQorICAg
ICAgICAgICAgICAgICAgICBodm1lbXVsX2NhbmNlbCh2KTsKKwogICAgICAgICAgICAgICAgIHZj
cHVfdW5wYXVzZSh2KTsKICAgICAgICAgICAgIH0KIAotLS0gYS94ZW4vYXJjaC94ODYvaHZtL2Rv
bWFpbi5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vZG9tYWluLmMKQEAgLTIyLDYgKzIyLDggQEAK
ICNpbmNsdWRlIDx4ZW4vcGFnaW5nLmg+CiAjaW5jbHVkZSA8eGVuL3NjaGVkLmg+CiAKKyNpbmNs
dWRlIDxhc20vaHZtL2VtdWxhdGUuaD4KKwogI2luY2x1ZGUgPHB1YmxpYy9odm0vaHZtX3ZjcHUu
aD4KIAogc3RhdGljIGludCBjaGVja19zZWdtZW50KHN0cnVjdCBzZWdtZW50X3JlZ2lzdGVyICpy
ZWcsIGVudW0geDg2X3NlZ21lbnQgc2VnKQpAQCAtMzIzLDYgKzMyNSw4IEBAIGludCBhcmNoX3Nl
dF9pbmZvX2h2bV9ndWVzdChzdHJ1Y3QgdmNwdQogCiAgICAgcGFnaW5nX3VwZGF0ZV9wYWdpbmdf
bW9kZXModik7CiAKKyAgICBodm1lbXVsX2NhbmNlbCh2KTsKKwogICAgIHYtPmlzX2luaXRpYWxp
c2VkID0gMTsKICAgICBzZXRfYml0KF9WUEZfZG93biwgJnYtPnBhdXNlX2ZsYWdzKTsKIAotLS0g
YS94ZW4vYXJjaC94ODYvaHZtL2VtdWxhdGUuYworKysgYi94ZW4vYXJjaC94ODYvaHZtL2VtdWxh
dGUuYwpAQCAtMTIxLDYgKzEyMSwyMyBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IGh2bV9pb19oYW5k
bGVyIGlvcmVxCiAgICAgLm9wcyA9ICZpb3JlcV9zZXJ2ZXJfb3BzCiB9OwogCisvKgorICogRHJv
cCBhbGwgcmVjb3JkcyBvZiBpbi1mbGlnaHQgZW11bGF0aW9uLiBUaGlzIGlzIG5lZWRlZCB3aGVu
ZXZlciBhIHZDUFUncworICogcmVnaXN0ZXIgc3RhdGUgbWF5IGhhdmUgY2hhbmdlZCBiZWhpbmQg
dGhlIGVtdWxhdG9yJ3MgYmFjay4KKyAqLwordm9pZCBodm1lbXVsX2NhbmNlbChzdHJ1Y3QgdmNw
dSAqdikKK3sKKyAgICBzdHJ1Y3QgaHZtX3ZjcHVfaW8gKnZpbyA9ICZ2LT5hcmNoLmh2bS5odm1f
aW87CisKKyAgICB2aW8tPmlvX3JlcS5zdGF0ZSA9IFNUQVRFX0lPUkVRX05PTkU7CisgICAgdmlv
LT5pb19jb21wbGV0aW9uID0gSFZNSU9fbm9fY29tcGxldGlvbjsKKyAgICB2aW8tPm1taW9fY2Fj
aGVfY291bnQgPSAwOworICAgIHZpby0+bW1pb19pbnNuX2J5dGVzID0gMDsKKyAgICB2aW8tPm1t
aW9fYWNjZXNzID0gKHN0cnVjdCBucGZlYyl7fTsKKyAgICB2aW8tPm1taW9fcmV0cnkgPSBmYWxz
ZTsKKyAgICB2aW8tPmcybV9pb3BvcnQgPSBOVUxMOworfQorCiBzdGF0aWMgaW50IGh2bWVtdWxf
ZG9faW8oCiAgICAgYm9vbF90IGlzX21taW8sIHBhZGRyX3QgYWRkciwgdW5zaWduZWQgbG9uZyAq
cmVwcywgdW5zaWduZWQgaW50IHNpemUsCiAgICAgdWludDhfdCBkaXIsIGJvb2xfdCBkZiwgYm9v
bF90IGRhdGFfaXNfYWRkciwgdWludHB0cl90IGRhdGEpCi0tLSBhL3hlbi9hcmNoL3g4Ni9odm0v
aHZtLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS9odm0uYwpAQCAtNDc3LDYgKzQ3NywxNCBAQCB1
NjQgaHZtX2dldF9ndWVzdF90c2NfZml4ZWQoc3RydWN0IHZjcHUKICAgICByZXR1cm4gdHNjICsg
di0+YXJjaC5odm0uY2FjaGVfdHNjX29mZnNldDsKIH0KIAordm9pZCBodm1fc2V0X2luZm9fZ3Vl
c3Qoc3RydWN0IHZjcHUgKnYpCit7CisgICAgaWYgKCBodm1fZnVuY3Muc2V0X2luZm9fZ3Vlc3Qg
KQorICAgICAgICBhbHRlcm5hdGl2ZV92Y2FsbChodm1fZnVuY3Muc2V0X2luZm9fZ3Vlc3QsIHYp
OworCisgICAgaHZtZW11bF9jYW5jZWwodik7Cit9CisKIHZvaWQgaHZtX21pZ3JhdGVfdGltZXJz
KHN0cnVjdCB2Y3B1ICp2KQogewogICAgIHJ0Y19taWdyYXRlX3RpbWVycyh2KTsKQEAgLTExNjIs
NiArMTE3MCw4IEBAIHN0YXRpYyBpbnQgaHZtX2xvYWRfY3B1X2N0eHQoc3RydWN0IGRvbWEKICAg
ICB2LT5hcmNoLmRyNiAgID0gY3R4dC5kcjY7CiAgICAgdi0+YXJjaC5kcjcgICA9IGN0eHQuZHI3
OwogCisgICAgaHZtZW11bF9jYW5jZWwodik7CisKICAgICAvKiBBdXhpbGlhcnkgcHJvY2Vzc29y
cyBzaG91bGQgYmUgd29rZW4gaW1tZWRpYXRlbHkuICovCiAgICAgdi0+aXNfaW5pdGlhbGlzZWQg
PSAxOwogICAgIGNsZWFyX2JpdChfVlBGX2Rvd24sICZ2LT5wYXVzZV9mbGFncyk7Ci0tLSBhL3hl
bi9hcmNoL3g4Ni9odm0vdmxhcGljLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS92bGFwaWMuYwpA
QCAtMzMsNiArMzMsNyBAQAogI2luY2x1ZGUgPGFzbS9hcGljLmg+CiAjaW5jbHVkZSA8YXNtL2lv
X2FwaWMuaD4KICNpbmNsdWRlIDxhc20vdnBtdS5oPgorI2luY2x1ZGUgPGFzbS9odm0vZW11bGF0
ZS5oPgogI2luY2x1ZGUgPGFzbS9odm0vaHZtLmg+CiAjaW5jbHVkZSA8YXNtL2h2bS9pby5oPgog
I2luY2x1ZGUgPGFzbS9odm0vc3VwcG9ydC5oPgpAQCAtMzA2LDYgKzMwNyw4IEBAIHN0YXRpYyB2
b2lkIHZsYXBpY19pbml0X3NpcGlfb25lKHN0cnVjdAogICAgICAgICBCVUcoKTsKICAgICB9CiAK
KyAgICBodm1lbXVsX2NhbmNlbCh0YXJnZXQpOworCiAgICAgdmNwdV91bnBhdXNlKHRhcmdldCk7
CiB9CiAKLS0tIGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vZW11bGF0ZS5oCisrKyBiL3hlbi9p
bmNsdWRlL2FzbS14ODYvaHZtL2VtdWxhdGUuaApAQCAtNzYsNiArNzYsNyBAQCB2b2lkIGh2bV9l
bXVsYXRlX2luaXRfcGVyX2luc24oCiAgICAgdW5zaWduZWQgaW50IGluc25fYnl0ZXMpOwogdm9p
ZCBodm1fZW11bGF0ZV93cml0ZWJhY2soCiAgICAgc3RydWN0IGh2bV9lbXVsYXRlX2N0eHQgKmh2
bWVtdWxfY3R4dCk7Cit2b2lkIGh2bWVtdWxfY2FuY2VsKHN0cnVjdCB2Y3B1ICp2KTsKIHN0cnVj
dCBzZWdtZW50X3JlZ2lzdGVyICpodm1lbXVsX2dldF9zZWdfcmVnKAogICAgIGVudW0geDg2X3Nl
Z21lbnQgc2VnLAogICAgIHN0cnVjdCBodm1fZW11bGF0ZV9jdHh0ICpodm1lbXVsX2N0eHQpOwot
LS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaAorKysgYi94ZW4vaW5jbHVkZS9hc20t
eDg2L2h2bS9odm0uaApAQCAtMjc4LDYgKzI3OCw4IEBAIHZvaWQgaHZtX2dldF9zZWdtZW50X3Jl
Z2lzdGVyKHN0cnVjdCB2Y3AKIHZvaWQgaHZtX3NldF9zZWdtZW50X3JlZ2lzdGVyKHN0cnVjdCB2
Y3B1ICp2LCBlbnVtIHg4Nl9zZWdtZW50IHNlZywKICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHN0cnVjdCBzZWdtZW50X3JlZ2lzdGVyICpyZWcpOwogCit2b2lkIGh2bV9zZXRfaW5mb19n
dWVzdChzdHJ1Y3QgdmNwdSAqdik7CisKIGJvb2wgaHZtX3NldF9ndWVzdF9ibmRjZmdzKHN0cnVj
dCB2Y3B1ICp2LCB1NjQgdmFsKTsKIAogaW50IGh2bV92bWV4aXRfY3B1aWQoc3RydWN0IGNwdV91
c2VyX3JlZ3MgKnJlZ3MsIHVuc2lnbmVkIGludCBpbnN0X2xlbik7CkBAIC01NDYsMTIgKzU0OCw2
IEBAIHN0YXRpYyBpbmxpbmUgdW5zaWduZWQgaW50IGh2bV9nZXRfaW5zbl8KICAgICAgICAgICAg
ID8gYWx0ZXJuYXRpdmVfY2FsbChodm1fZnVuY3MuZ2V0X2luc25fYnl0ZXMsIHYsIGJ1ZikgOiAw
KTsKIH0KIAotc3RhdGljIGlubGluZSB2b2lkIGh2bV9zZXRfaW5mb19ndWVzdChzdHJ1Y3QgdmNw
dSAqdikKLXsKLSAgICBpZiAoIGh2bV9mdW5jcy5zZXRfaW5mb19ndWVzdCApCi0gICAgICAgIGFs
dGVybmF0aXZlX3ZjYWxsKGh2bV9mdW5jcy5zZXRfaW5mb19ndWVzdCwgdik7Ci19Ci0KIHN0YXRp
YyBpbmxpbmUgdm9pZCBodm1faW52YWxpZGF0ZV9yZWdzX2ZpZWxkcyhzdHJ1Y3QgY3B1X3VzZXJf
cmVncyAqcmVncykKIHsKICNpZm5kZWYgTkRFQlVHCkBAIC02ODIsNyArNjc4LDYgQEAgc3RhdGlj
IGlubGluZSBib29sIGFsdHAybV92Y3B1X2VtdWxhdGVfdgogICovCiBpbnQgaHZtX2d1ZXN0X3g4
Nl9tb2RlKHN0cnVjdCB2Y3B1ICp2KTsKIHVuc2lnbmVkIGxvbmcgaHZtX2dldF9zaGFkb3dfZ3Nf
YmFzZShzdHJ1Y3QgdmNwdSAqdik7Ci12b2lkIGh2bV9zZXRfaW5mb19ndWVzdChzdHJ1Y3QgdmNw
dSAqdik7CiB2b2lkIGh2bV9jcHVpZF9wb2xpY3lfY2hhbmdlZChzdHJ1Y3QgdmNwdSAqdik7CiB2
b2lkIGh2bV9zZXRfdHNjX29mZnNldChzdHJ1Y3QgdmNwdSAqdiwgdWludDY0X3Qgb2Zmc2V0LCB1
aW50NjRfdCBhdF90c2MpOwogYm9vbCBodm1fZ2V0X2d1ZXN0X2JuZGNmZ3Moc3RydWN0IHZjcHUg
KnYsIHVpbnQ2NF90ICp2YWwpOwoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnBy
b2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94
ZW4tZGV2ZWw=

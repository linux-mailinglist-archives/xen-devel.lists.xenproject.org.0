Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 30D1B8AE974
	for <lists+xen-devel@lfdr.de>; Tue, 23 Apr 2024 16:28:53 +0200 (CEST)
Received: from list by lists.xenproject.org with outflank-mailman.710667.1110013 (Exim 4.92)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1rzH8P-0005he-GV; Tue, 23 Apr 2024 14:28:37 +0000
X-Outflank-Mailman: Message body and most headers restored to incoming version
Received: by outflank-mailman (output) from mailman id 710667.1110013; Tue, 23 Apr 2024 14:28:37 +0000
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.92)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1rzH8P-0005eU-Da; Tue, 23 Apr 2024 14:28:37 +0000
Received: by outflank-mailman (input) for mailman id 710667;
 Tue, 23 Apr 2024 14:28:36 +0000
Received: from mail.xenproject.org ([104.130.215.37])
 by lists.xenproject.org with esmtp (Exim 4.92)
 (envelope-from <julien@xen.org>) id 1rzH8O-0005eO-DT
 for xen-devel@lists.xenproject.org; Tue, 23 Apr 2024 14:28:36 +0000
Received: from xenbits.xenproject.org ([104.239.192.120])
 by mail.xenproject.org with esmtp (Exim 4.92)
 (envelope-from <julien@xen.org>)
 id 1rzH8N-0001s0-Pk; Tue, 23 Apr 2024 14:28:35 +0000
Received: from [15.248.2.233] (helo=[10.24.67.33])
 by xenbits.xenproject.org with esmtpsa
 (TLS1.3:ECDHE_RSA_AES_128_GCM_SHA256:128) (Exim 4.92)
 (envelope-from <julien@xen.org>)
 id 1rzH8N-0003RL-Ez; Tue, 23 Apr 2024 14:28:35 +0000
X-BeenThere: xen-devel@lists.xenproject.org
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Errors-To: xen-devel-bounces@lists.xenproject.org
Precedence: list
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=xen.org;
	s=20200302mail; h=Content-Transfer-Encoding:Content-Type:In-Reply-To:From:
	References:Cc:To:Subject:MIME-Version:Date:Message-ID;
	bh=gzTOyQWEIuUjoakhhnZ0lv4DoaOTz8A4wGB9zMg9IMI=; b=1KpBDdYmtt4hYKDENIsUuLVG5U
	5+D3xNw2B9pQ8iXoUudk693bB0P7jo/bQXxzRLL8AaUWMArIHgRdn9Vee83tNeyWO84WyuxqM7MMx
	FPB6gTNPFtMMK9V/bA8wGP8vnwAWHEZLzh9n8uAQGCmek2/QuwKP2W0m2kKSiylhV86w=;
Message-ID: <195c1fe6-ed77-417f-bcb0-fdfaf687c4b0@xen.org>
Date: Tue, 23 Apr 2024 15:28:33 +0100
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: [XEN PATCH v2 4/5] xen/arm: allow dynamically assigned SGI
 handlers
Content-Language: en-GB
To: Bertrand Marquis <Bertrand.Marquis@arm.com>
Cc: Jens Wiklander <jens.wiklander@linaro.org>,
 Xen-devel <xen-devel@lists.xenproject.org>,
 "patches@linaro.org" <patches@linaro.org>,
 Stefano Stabellini <sstabellini@kernel.org>,
 Michal Orzel <michal.orzel@amd.com>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>
References: <20240422073708.3663529-1-jens.wiklander@linaro.org>
 <20240422073708.3663529-5-jens.wiklander@linaro.org>
 <89d268cc-bc49-4e22-b4e9-2e8dbe73124c@xen.org>
 <CAHUa44GAbBtczbVohVjC=66tqzjgeGLx44k9ddodDJL13KwVEQ@mail.gmail.com>
 <205a95f2-fdf6-4f38-b2e0-31e4fff9348b@xen.org>
 <756FEA03-7F16-48AE-8308-059EBF8638A0@arm.com>
 <27BADE00-E6EC-4BD6-AC5D-201DF1A76BCD@arm.com>
From: Julien Grall <julien@xen.org>
In-Reply-To: <27BADE00-E6EC-4BD6-AC5D-201DF1A76BCD@arm.com>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit

Hi Bertrand,

On 23/04/2024 14:23, Bertrand Marquis wrote:
> Hi Julien,
> 
>> On 23 Apr 2024, at 14:37, Bertrand Marquis <Bertrand.Marquis@arm.com> wrote:
>>
>> Hi Julien,
>>
>>> On 23 Apr 2024, at 13:05, Julien Grall <julien@xen.org> wrote:
>>>
>>>
>>>
>>> On 23/04/2024 10:35, Jens Wiklander wrote:
>>>> Hi Julien,
>>>
>>> Hi Jens,
>>>
>>>> On Mon, Apr 22, 2024 at 12:57â€¯PM Julien Grall <julien@xen.org> wrote:
>>>>>
>>>>> Hi Jens,
>>>>>
>>>>> On 22/04/2024 08:37, Jens Wiklander wrote:
>>>>>> Updates so request_irq() can be used with a dynamically assigned SGI irq
>>>>>> as input. This prepares for a later patch where an FF-A schedule
>>>>>> receiver interrupt handler is installed for an SGI generated by the
>>>>>> secure world.
>>>>>
>>>>> I would like to understand the use-case a bit more. Who is responsible
>>>>> to decide the SGI number? Is it Xen or the firmware?
>>>>>
>>>>> If the later, how can we ever guarantee the ID is not going to clash
>>>>> with what the OS/hypervisor is using? Is it described in a
>>>>> specification? If so, please give a pointer.
>>>> The firmware decides the SGI number. Given that the firmware doesn't
>>>> know which SGIs Xen is using it typically needs to donate one of the
>>>> secure SGIs, but that is transparent to Xen.
>>>
>>> Right this is my concern. The firmware decides the number, but at the same time Xen thinks that all the SGIs are available (AFAIK there is only one set).
>>>
>>> What I would like to see is some wording from a spec indicating that the SGIs ID reserved by the firmware will not be clashing with the one used by Xen.
>>
>> The idea is that the only SGI reserved for secure are used by the secure world (in fact it is the SPMC in the secure world who tells us which SGI it will generate).
>> So in theory that means it will always use an SGI between 8 and 15.
>>
>> Now it could make sense in fact to check that the number returned by the firmware (or SPMC) is not clashing with Xen as it is a recommendation in the spec and
>> in fact an implementation might do something different.
>>
>> Right now there is no spec that will say that it will never clash with the one used by Xen as the FF-A spec is not enforcing anything here so it would be a good idea
>> to check and disable FF-A with a proper error message if this happens.
> 
> 
> After some more digging here is what is recommended by Arm in the Arm Base System Architecture v1.0C [1]:
> 
> "The system shall implement at least eight Non-secure SGIs, assigned to interrupt IDs 0-7."

Thanks! Can we provide a link to the specification in the commit message?

> 
> So basically as long as Xen is using SGIs 0-7 it is safe as those shall never be used by the secure world.
> Now i do agree that we should check that whatever is returned by the firmware is not conflicting with what
> is used by Xen.
+1.

Cheers,

-- 
Julien Grall


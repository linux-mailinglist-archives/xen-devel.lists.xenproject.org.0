Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 20367B7A73
	for <lists+xen-devel@lfdr.de>; Thu, 19 Sep 2019 15:27:12 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iAwQJ-0008Pz-OU; Thu, 19 Sep 2019 13:24:39 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=5hYN=XO=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1iAwQH-0008PP-VA
 for xen-devel@lists.xenproject.org; Thu, 19 Sep 2019 13:24:37 +0000
X-Inumbo-ID: d37b6b80-dae0-11e9-965d-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id d37b6b80-dae0-11e9-965d-12813bfff9fa;
 Thu, 19 Sep 2019 13:24:37 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 732C0AFBB;
 Thu, 19 Sep 2019 13:24:36 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <aa62726c-5aa4-8bcd-dc35-61eb8dfeaee3@suse.com>
Message-ID: <e0a904bf-b6a0-6224-88f6-e89a95867718@suse.com>
Date: Thu, 19 Sep 2019 15:24:44 +0200
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.9.0
MIME-Version: 1.0
In-Reply-To: <aa62726c-5aa4-8bcd-dc35-61eb8dfeaee3@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v6 7/8] AMD/IOMMU: allocate one device table per
 PCI segment
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SGF2aW5nIGEgc2luZ2xlIGRldmljZSB0YWJsZSBmb3IgYWxsIHNlZ21lbnRzIGNhbid0IHBvc3Np
Ymx5IGJlIHJpZ2h0LgooRXZlbiB3b3JzZSwgdGhlIHN5bWJvbCB3YXNuJ3Qgc3RhdGljIGRlc3Bp
dGUgYmVpbmcgdXNlZCBpbiBqdXN0IG9uZQpzb3VyY2UgZmlsZS4pIEF0dGFjaCB0aGUgZGV2aWNl
IHRhYmxlcyB0byB0aGVpciByZXNwZWN0aXZlIElWUlMgbWFwcGluZwpvbmVzLgoKU2lnbmVkLW9m
Zi1ieTogSmFuIEJldWxpY2ggPGpiZXVsaWNoQHN1c2UuY29tPgotLS0KdjY6IE5ldy4KCi0tLQog
eGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11X2luaXQuYyB8ICAgODEgKysrKysrKysr
KysrKysrKy0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDQzIGluc2VydGlvbnMoKyks
IDM4IGRlbGV0aW9ucygtKQoKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11
X2luaXQuYworKysgYi94ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfaW5pdC5jCkBA
IC0zOSw3ICszOSw2IEBAIHVuc2lnbmVkIGludCBfX3JlYWRfbW9zdGx5IGl2cnNfYmRmX2VudHIK
IHU4IF9fcmVhZF9tb3N0bHkgaXZoZF90eXBlOwogc3RhdGljIHN0cnVjdCByYWRpeF90cmVlX3Jv
b3QgaXZyc19tYXBzOwogTElTVF9IRUFEX1JFQURfTU9TVExZKGFtZF9pb21tdV9oZWFkKTsKLXN0
cnVjdCB0YWJsZV9zdHJ1Y3QgZGV2aWNlX3RhYmxlOwogYm9vbF90IGlvbW11djJfZW5hYmxlZDsK
IAogc3RhdGljIGJvb2wgaW9tbXVfaGFzX2h0X2ZsYWcoc3RydWN0IGFtZF9pb21tdSAqaW9tbXUs
IHU4IG1hc2spCkBAIC05ODksNiArOTg4LDEyIEBAIHN0YXRpYyB2b2lkIGRpc2FibGVfaW9tbXUo
c3RydWN0IGFtZF9pb20KICAgICBzcGluX3VubG9ja19pcnFyZXN0b3JlKCZpb21tdS0+bG9jaywg
ZmxhZ3MpOwogfQogCitzdGF0aWMgdW5zaWduZWQgaW50IF9faW5pdCBkdF9hbGxvY19zaXplKHZv
aWQpCit7CisgICAgcmV0dXJuIFBBR0VfU0laRSA8PCBnZXRfb3JkZXJfZnJvbV9ieXRlcyhpdnJz
X2JkZl9lbnRyaWVzICoKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIElPTU1VX0RFVl9UQUJMRV9FTlRSWV9TSVpFKTsKK30KKwogc3RhdGljIHZvaWQgX19pbml0
IGRlYWxsb2NhdGVfYnVmZmVyKHZvaWQgKmJ1ZiwgdWludDMyX3Qgc3opCiB7CiAgICAgaW50IG9y
ZGVyID0gMDsKQEAgLTk5OSwxMiArMTAwNCw2IEBAIHN0YXRpYyB2b2lkIF9faW5pdCBkZWFsbG9j
YXRlX2J1ZmZlcih2b2kKICAgICB9CiB9CiAKLXN0YXRpYyB2b2lkIF9faW5pdCBkZWFsbG9jYXRl
X2RldmljZV90YWJsZShzdHJ1Y3QgdGFibGVfc3RydWN0ICp0YWJsZSkKLXsKLSAgICBkZWFsbG9j
YXRlX2J1ZmZlcih0YWJsZS0+YnVmZmVyLCB0YWJsZS0+YWxsb2Nfc2l6ZSk7Ci0gICAgdGFibGUt
PmJ1ZmZlciA9IE5VTEw7Ci19Ci0KIHN0YXRpYyB2b2lkIF9faW5pdCBkZWFsbG9jYXRlX3Jpbmdf
YnVmZmVyKHN0cnVjdCByaW5nX2J1ZmZlciAqcmluZ19idWYpCiB7CiAgICAgZGVhbGxvY2F0ZV9i
dWZmZXIocmluZ19idWYtPmJ1ZmZlciwgcmluZ19idWYtPmFsbG9jX3NpemUpOwpAQCAtMTA2OCw4
ICsxMDY3LDI5IEBAIHN0YXRpYyB2b2lkICogX19pbml0IGFsbG9jYXRlX3Bwcl9sb2coc3QKICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSU9NTVVfUFBSX0xPR19ERUZBVUxUX0VOVFJJ
RVMsICJQUFIgTG9nIik7CiB9CiAKKy8qCisgKiBXaXRoaW4gaXZyc19tYXBwaW5nc1tdIHdlIGFs
bG9jYXRlIGFuIGV4dHJhIGFycmF5IGVsZW1lbnQgdG8gc3RvcmUKKyAqIC0gc2VnbWVudCBudW1i
ZXIsCisgKiAtIGRldmljZSB0YWJsZS4KKyAqLworI2RlZmluZSBJVlJTX01BUFBJTkdTX1NFRyht
KSAobSlbaXZyc19iZGZfZW50cmllc10uZHRlX3JlcXVlc3Rvcl9pZAorI2RlZmluZSBJVlJTX01B
UFBJTkdTX0RFVlRBQihtKSAobSlbaXZyc19iZGZfZW50cmllc10uaW50cmVtYXBfdGFibGUKKwor
c3RhdGljIHZvaWQgX19pbml0IGZyZWVfaXZyc19tYXBwaW5nKHZvaWQgKnB0cikKK3sKKyAgICBj
b25zdCBzdHJ1Y3QgaXZyc19tYXBwaW5ncyAqaXZyc19tYXBwaW5ncyA9IHB0cjsKKworICAgIGlm
ICggSVZSU19NQVBQSU5HU19ERVZUQUIoaXZyc19tYXBwaW5ncykgKQorICAgICAgICBkZWFsbG9j
YXRlX2J1ZmZlcihJVlJTX01BUFBJTkdTX0RFVlRBQihpdnJzX21hcHBpbmdzKSwKKyAgICAgICAg
ICAgICAgICAgICAgICAgICAgZHRfYWxsb2Nfc2l6ZSgpKTsKKworICAgIHhmcmVlKHB0cik7Cit9
CisKIHN0YXRpYyBpbnQgX19pbml0IGFtZF9pb21tdV9pbml0X29uZShzdHJ1Y3QgYW1kX2lvbW11
ICppb21tdSwgYm9vbCBpbnRyKQogeworICAgIGNvbnN0IHN0cnVjdCBpdnJzX21hcHBpbmdzICpp
dnJzX21hcHBpbmdzOworCiAgICAgaWYgKCBhbGxvY2F0ZV9jbWRfYnVmZmVyKGlvbW11KSA9PSBO
VUxMICkKICAgICAgICAgZ290byBlcnJvcl9vdXQ7CiAKQEAgLTEwODIsMTMgKzExMDIsMTUgQEAg
c3RhdGljIGludCBfX2luaXQgYW1kX2lvbW11X2luaXRfb25lKHN0cgogICAgIGlmICggaW50ciAm
JiAhc2V0X2lvbW11X2ludGVycnVwdF9oYW5kbGVyKGlvbW11KSApCiAgICAgICAgIGdvdG8gZXJy
b3Jfb3V0OwogCi0gICAgLyogVG8gbWFrZSBzdXJlIHRoYXQgZGV2aWNlX3RhYmxlLmJ1ZmZlciBo
YXMgYmVlbiBzdWNjZXNzZnVsbHkgYWxsb2NhdGVkICovCi0gICAgaWYgKCBkZXZpY2VfdGFibGUu
YnVmZmVyID09IE5VTEwgKQorICAgIC8qIE1ha2Ugc3VyZSB0aGF0IHRoZSBkZXZpY2UgdGFibGUg
aGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGFsbG9jYXRlZC4gKi8KKyAgICBpdnJzX21hcHBpbmdzID0g
Z2V0X2l2cnNfbWFwcGluZ3MoaW9tbXUtPnNlZyk7CisgICAgaWYgKCAhSVZSU19NQVBQSU5HU19E
RVZUQUIoaXZyc19tYXBwaW5ncykgKQogICAgICAgICBnb3RvIGVycm9yX291dDsKIAotICAgIGlv
bW11LT5kZXZfdGFibGUuYWxsb2Nfc2l6ZSA9IGRldmljZV90YWJsZS5hbGxvY19zaXplOwotICAg
IGlvbW11LT5kZXZfdGFibGUuZW50cmllcyA9IGRldmljZV90YWJsZS5lbnRyaWVzOwotICAgIGlv
bW11LT5kZXZfdGFibGUuYnVmZmVyID0gZGV2aWNlX3RhYmxlLmJ1ZmZlcjsKKyAgICBpb21tdS0+
ZGV2X3RhYmxlLmFsbG9jX3NpemUgPSBkdF9hbGxvY19zaXplKCk7CisgICAgaW9tbXUtPmRldl90
YWJsZS5lbnRyaWVzID0gaW9tbXUtPmRldl90YWJsZS5hbGxvY19zaXplIC8KKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBJT01NVV9ERVZfVEFCTEVfRU5UUllfU0laRTsKKyAgICBpb21t
dS0+ZGV2X3RhYmxlLmJ1ZmZlciA9IElWUlNfTUFQUElOR1NfREVWVEFCKGl2cnNfbWFwcGluZ3Mp
OwogCiAgICAgZW5hYmxlX2lvbW11KGlvbW11KTsKICAgICBwcmludGsoIkFNRC1WaTogSU9NTVUg
JWQgRW5hYmxlZC5cbiIsIG5yX2FtZF9pb21tdXMgKTsKQEAgLTExMzUsMTEgKzExNTcsOCBAQCBz
dGF0aWMgdm9pZCBfX2luaXQgYW1kX2lvbW11X2luaXRfY2xlYW51CiAgICAgICAgIHhmcmVlKGlv
bW11KTsKICAgICB9CiAKLSAgICAvKiBmcmVlIGRldmljZSB0YWJsZSAqLwotICAgIGRlYWxsb2Nh
dGVfZGV2aWNlX3RhYmxlKCZkZXZpY2VfdGFibGUpOwotCi0gICAgLyogZnJlZSBpdnJzX21hcHBp
bmdzW10gKi8KLSAgICByYWRpeF90cmVlX2Rlc3Ryb3koJml2cnNfbWFwcywgeGZyZWUpOworICAg
IC8qIEZyZWUgaXZyc19tYXBwaW5nc1tdIGFuZCB0aGVpciBkZXZpY2UgdGFibGVzLiAqLworICAg
IHJhZGl4X3RyZWVfZGVzdHJveSgmaXZyc19tYXBzLCBmcmVlX2l2cnNfbWFwcGluZyk7CiAKICAg
ICBpb21tdV9lbmFibGVkID0gMDsKICAgICBpb21tdV9od2RvbV9wYXNzdGhyb3VnaCA9IGZhbHNl
OwpAQCAtMTE0NywxMiArMTE2Niw2IEBAIHN0YXRpYyB2b2lkIF9faW5pdCBhbWRfaW9tbXVfaW5p
dF9jbGVhbnUKICAgICBpb21tdXYyX2VuYWJsZWQgPSAwOwogfQogCi0vKgotICogV2UgYWxsb2Nh
dGUgYW4gZXh0cmEgYXJyYXkgZWxlbWVudCB0byBzdG9yZSB0aGUgc2VnbWVudCBudW1iZXIKLSAq
IChhbmQgaW4gdGhlIGZ1dHVyZSBwZXJoYXBzIG90aGVyIGdsb2JhbCBpbmZvcm1hdGlvbikuCi0g
Ki8KLSNkZWZpbmUgSVZSU19NQVBQSU5HU19TRUcobSkgbVtpdnJzX2JkZl9lbnRyaWVzXS5kdGVf
cmVxdWVzdG9yX2lkCi0KIHN0cnVjdCBpdnJzX21hcHBpbmdzICpnZXRfaXZyc19tYXBwaW5ncyh1
MTYgc2VnKQogewogICAgIHJldHVybiByYWRpeF90cmVlX2xvb2t1cCgmaXZyc19tYXBzLCBzZWcp
OwpAQCAtMTIzNSwyNCArMTI0OCwxOCBAQCBzdGF0aWMgaW50IF9faW5pdCBhbGxvY19pdnJzX21h
cHBpbmdzKHUxCiBzdGF0aWMgaW50IF9faW5pdCBhbWRfaW9tbXVfc2V0dXBfZGV2aWNlX3RhYmxl
KAogICAgIHUxNiBzZWcsIHN0cnVjdCBpdnJzX21hcHBpbmdzICppdnJzX21hcHBpbmdzKQogewor
ICAgIHN0cnVjdCBhbWRfaW9tbXVfZHRlICpkdCA9IElWUlNfTUFQUElOR1NfREVWVEFCKGl2cnNf
bWFwcGluZ3MpOwogICAgIHVuc2lnbmVkIGludCBiZGY7CiAKICAgICBCVUdfT04oIChpdnJzX2Jk
Zl9lbnRyaWVzID09IDApICk7CiAKLSAgICBpZiAoICFkZXZpY2VfdGFibGUuYnVmZmVyICkKKyAg
ICBpZiAoICFkdCApCiAgICAgewogICAgICAgICAvKiBhbGxvY2F0ZSAnZGV2aWNlIHRhYmxlJyBv
biBhIDRLIGJvdW5kYXJ5ICovCi0gICAgICAgIGRldmljZV90YWJsZS5hbGxvY19zaXplID0gUEFH
RV9TSVpFIDw8Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0X29yZGVyX2Zy
b21fYnl0ZXMoCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUEFHRV9BTElHTihp
dnJzX2JkZl9lbnRyaWVzICoKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJT01N
VV9ERVZfVEFCTEVfRU5UUllfU0laRSkpOwotICAgICAgICBkZXZpY2VfdGFibGUuZW50cmllcyA9
IGRldmljZV90YWJsZS5hbGxvY19zaXplIC8KLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBJT01NVV9ERVZfVEFCTEVfRU5UUllfU0laRTsKLQotICAgICAgICBkZXZpY2VfdGFibGUuYnVm
ZmVyID0gYWxsb2NhdGVfYnVmZmVyKGRldmljZV90YWJsZS5hbGxvY19zaXplLAotICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJEZXZpY2UgVGFibGUiKTsKKyAg
ICAgICAgZHQgPSBJVlJTX01BUFBJTkdTX0RFVlRBQihpdnJzX21hcHBpbmdzKSA9CisgICAgICAg
ICAgICBhbGxvY2F0ZV9idWZmZXIoZHRfYWxsb2Nfc2l6ZSgpLCAiRGV2aWNlIFRhYmxlIik7CiAg
ICAgfQotICAgIGlmICggIWRldmljZV90YWJsZS5idWZmZXIgKQorICAgIGlmICggIWR0ICkKICAg
ICAgICAgcmV0dXJuIC1FTk9NRU07CiAKICAgICAvKiBBZGQgZGV2aWNlIHRhYmxlIGVudHJpZXMg
Ki8KQEAgLTEyNjAsMTIgKzEyNjcsMTAgQEAgc3RhdGljIGludCBfX2luaXQgYW1kX2lvbW11X3Nl
dHVwX2RldmljZQogICAgIHsKICAgICAgICAgaWYgKCBpdnJzX21hcHBpbmdzW2JkZl0udmFsaWQg
KQogICAgICAgICB7Ci0gICAgICAgICAgICB2b2lkICpkdGU7CiAgICAgICAgICAgICBjb25zdCBz
dHJ1Y3QgcGNpX2RldiAqcGRldiA9IE5VTEw7CiAKICAgICAgICAgICAgIC8qIGFkZCBkZXZpY2Ug
dGFibGUgZW50cnkgKi8KLSAgICAgICAgICAgIGR0ZSA9IGRldmljZV90YWJsZS5idWZmZXIgKyAo
YmRmICogSU9NTVVfREVWX1RBQkxFX0VOVFJZX1NJWkUpOwotICAgICAgICAgICAgaW9tbXVfZHRl
X2FkZF9kZXZpY2VfZW50cnkoZHRlLCAmaXZyc19tYXBwaW5nc1tiZGZdKTsKKyAgICAgICAgICAg
IGlvbW11X2R0ZV9hZGRfZGV2aWNlX2VudHJ5KCZkdFtiZGZdLCAmaXZyc19tYXBwaW5nc1tiZGZd
KTsKIAogICAgICAgICAgICAgaWYgKCBpb21tdV9pbnRyZW1hcCAmJgogICAgICAgICAgICAgICAg
ICBpdnJzX21hcHBpbmdzW2JkZl0uZHRlX3JlcXVlc3Rvcl9pZCA9PSBiZGYgJiYKQEAgLTEzMDgs
NyArMTMxMyw3IEBAIHN0YXRpYyBpbnQgX19pbml0IGFtZF9pb21tdV9zZXR1cF9kZXZpY2UKICAg
ICAgICAgICAgIH0KIAogICAgICAgICAgICAgYW1kX2lvbW11X3NldF9pbnRyZW1hcF90YWJsZSgK
LSAgICAgICAgICAgICAgICBkdGUsIGl2cnNfbWFwcGluZ3NbYmRmXS5pbnRyZW1hcF90YWJsZSwK
KyAgICAgICAgICAgICAgICAmZHRbYmRmXSwgaXZyc19tYXBwaW5nc1tiZGZdLmludHJlbWFwX3Rh
YmxlLAogICAgICAgICAgICAgICAgIGl2cnNfbWFwcGluZ3NbYmRmXS5pb21tdSwgaW9tbXVfaW50
cmVtYXApOwogICAgICAgICB9CiAgICAgfQoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3Rz
LnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0
aW5mby94ZW4tZGV2ZWw=

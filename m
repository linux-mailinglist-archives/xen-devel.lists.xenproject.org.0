Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 6FFC3B473D
	for <lists+xen-devel@lfdr.de>; Tue, 17 Sep 2019 08:16:27 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iA6jz-0000dd-2R; Tue, 17 Sep 2019 06:13:31 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=+VJ/=XM=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1iA6jx-0000dR-9v
 for xen-devel@lists.xenproject.org; Tue, 17 Sep 2019 06:13:29 +0000
X-Inumbo-ID: 4398043a-d912-11e9-9601-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 4398043a-d912-11e9-9601-12813bfff9fa;
 Tue, 17 Sep 2019 06:13:28 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 8DFB2AC4D;
 Tue, 17 Sep 2019 06:13:27 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <625c29ba-cfb8-88ee-eb15-5f2019198865@suse.com>
Message-ID: <05363bde-6b5b-56e2-1f85-b64f995d82cf@suse.com>
Date: Tue, 17 Sep 2019 08:13:33 +0200
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.9.0
MIME-Version: 1.0
In-Reply-To: <625c29ba-cfb8-88ee-eb15-5f2019198865@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v2 2/9] x86: limit the amount of TLB flushing in
 switch_cr3_cr4()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Wei Liu <wl@xen.org>,
 =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2UgcmVhbGx5IG5lZWQgdG8gZmx1c2ggdGhlIFRMQiBqdXN0IG9uY2UsIGlmIHdlIGRvIHNvIHdp
dGggb3IgYWZ0ZXIgdGhlCkNSMyB3cml0ZS4gVGhlIG9ubHkgY2FzZSB3aGVyZSB0d28gZmx1c2hl
cyBhcmUgdW5hdm9pZGFibGUgaXMgd2hlbiB3ZQptZWFuIHRvIHR1cm4gb2ZmIENSNC5QR0UgKHBl
cmhhcHMganVzdCB0ZW1wb3JhcmlseTsgc2VlIHRoZSBjb2RlCmNvbW1lbnQpLgoKU2lnbmVkLW9m
Zi1ieTogSmFuIEJldWxpY2ggPGpiZXVsaWNoQHN1c2UuY29tPgpSZXZpZXdlZC1ieTogUm9nZXIg
UGF1IE1vbm7DqSA8cm9nZXIucGF1QGNpdHJpeC5jb20+CgotLS0gYS94ZW4vYXJjaC94ODYvZmx1
c2h0bGIuYworKysgYi94ZW4vYXJjaC94ODYvZmx1c2h0bGIuYwpAQCAtMTA0LDgyICsxMDQsNjUg
QEAgc3RhdGljIHZvaWQgZG9fdGxiX2ZsdXNoKHZvaWQpCiB2b2lkIHN3aXRjaF9jcjNfY3I0KHVu
c2lnbmVkIGxvbmcgY3IzLCB1bnNpZ25lZCBsb25nIGNyNCkKIHsKICAgICB1bnNpZ25lZCBsb25n
IGZsYWdzLCBvbGRfY3I0OwotICAgIHVuc2lnbmVkIGludCBvbGRfcGNpZDsKICAgICB1MzIgdDsK
IAorICAgIC8qIFRocm91Z2hvdXQgdGhpcyBmdW5jdGlvbiB3ZSBtYWtlIHRoaXMgYXNzdW1wdGlv
bjogKi8KKyAgICBBU1NFUlQoIShjcjQgJiBYODZfQ1I0X1BDSURFKSB8fCAhKGNyNCAmIFg4Nl9D
UjRfUEdFKSk7CisKICAgICAvKiBUaGlzIG5vbi1yZWVudHJhbnQgZnVuY3Rpb24gaXMgc29tZXRp
bWVzIGNhbGxlZCBpbiBpbnRlcnJ1cHQgY29udGV4dC4gKi8KICAgICBsb2NhbF9pcnFfc2F2ZShm
bGFncyk7CiAKICAgICB0ID0gcHJlX2ZsdXNoKCk7CiAKICAgICBvbGRfY3I0ID0gcmVhZF9jcjQo
KTsKLSAgICBpZiAoIG9sZF9jcjQgJiBYODZfQ1I0X1BHRSApCisgICAgQVNTRVJUKCEob2xkX2Ny
NCAmIFg4Nl9DUjRfUENJREUpIHx8ICEob2xkX2NyNCAmIFg4Nl9DUjRfUEdFKSk7CisKKyAgICAv
KgorICAgICAqIFdlIG5lZWQgdG8gd3JpdGUgQ1I0IGJlZm9yZSBDUjMgaWYgd2UncmUgYWJvdXQg
dG8gZW5hYmxlIFBDSURFLCBhdCB0aGUKKyAgICAgKiB2ZXJ5IGxlYXN0IHdoZW4gdGhlIG5ldyBQ
Q0lEIGlzIG5vbi16ZXJvLgorICAgICAqCisgICAgICogQXMgd2UgYWxzbyBuZWVkIHRvIGRvIHR3
byBDUjQgd3JpdGVzIGluIHRvdGFsIHdoZW4gUEdFIGlzIGVuYWJsZWQgYW5kCisgICAgICogaXMg
dG8gcmVtYWluIGVuYWJsZWQsIGRvIHRoZSBvbmUgdGVtcG9yYXJpbHkgdHVybmluZyBvZmYgdGhl
IGJpdCByaWdodAorICAgICAqIGhlcmUgYXMgd2VsbC4KKyAgICAgKgorICAgICAqIFRoZSBvbmx5
IFRMQiBmbHVzaGluZyBlZmZlY3Qgd2UgZGVwZW5kIG9uIGhlcmUgaXMgaW4gY2FzZSB3ZSBtb3Zl
IGZyb20KKyAgICAgKiBQR0Ugc2V0IHRvIFBDSURFIHNldCwgd2hlcmUgd2Ugd2FudCBnbG9iYWwg
cGFnZSBlbnRyaWVzIGdvbmUgKGFuZCBub25lCisgICAgICogdG8gcmUtYXBwZWFyKSBhZnRlciB0
aGlzIHdyaXRlLgorICAgICAqLworICAgIGlmICggIShvbGRfY3I0ICYgWDg2X0NSNF9QQ0lERSkg
JiYKKyAgICAgICAgICgoY3I0ICYgWDg2X0NSNF9QQ0lERSkgfHwgKGNyNCAmIG9sZF9jcjQgJiBY
ODZfQ1I0X1BHRSkpICkKICAgICB7Ci0gICAgICAgIC8qCi0gICAgICAgICAqIFg4Nl9DUjRfUEdF
IHNldCBtZWFucyBQQ0lEIGlzIGluYWN0aXZlLgotICAgICAgICAgKiBXZSBoYXZlIHRvIHB1cmdl
IHRoZSBUTEIgdmlhIGZsaXBwaW5nIGNyNC5wZ2UuCi0gICAgICAgICAqLwogICAgICAgICBvbGRf
Y3I0ID0gY3I0ICYgflg4Nl9DUjRfUEdFOwogICAgICAgICB3cml0ZV9jcjQob2xkX2NyNCk7CiAg
ICAgfQotICAgIGVsc2UgaWYgKCB1c2VfaW52cGNpZCApCi0gICAgewotICAgICAgICAvKgotICAg
ICAgICAgKiBGbHVzaGluZyB0aGUgVExCIHZpYSBJTlZQQ0lEIGlzIG5lY2Vzc2FyeSBvbmx5IGlu
IGNhc2UgUENJRHMgYXJlCi0gICAgICAgICAqIGluIHVzZSwgd2hpY2ggaXMgdHJ1ZSBvbmx5IHdp
dGggSU5WUENJRCBiZWluZyBhdmFpbGFibGUuCi0gICAgICAgICAqIFdpdGhvdXQgUENJRCB1c2Fn
ZSB0aGUgZm9sbG93aW5nIHdyaXRlX2NyMygpIHdpbGwgcHVyZ2UgdGhlIFRMQgotICAgICAgICAg
KiAod2UgYXJlIGluIHRoZSBjcjQucGdlIG9mZiBwYXRoKSBvZiBhbGwgZW50cmllcy4KLSAgICAg
ICAgICogVXNpbmcgaW52cGNpZF9mbHVzaF9hbGxfbm9uZ2xvYmFscygpIHNlZW1zIHRvIGJlIGZh
c3RlciB0aGFuCi0gICAgICAgICAqIGludnBjaWRfZmx1c2hfYWxsKCksIHNvIHVzZSB0aGF0Lgot
ICAgICAgICAgKi8KLSAgICAgICAgaW52cGNpZF9mbHVzaF9hbGxfbm9uZ2xvYmFscygpOwotCi0g
ICAgICAgIC8qCi0gICAgICAgICAqIENSNC5QQ0lERSBuZWVkcyB0byBiZSBzZXQgYmVmb3JlIHRo
ZSBDUjMgd3JpdGUgYmVsb3cuIE90aGVyd2lzZQotICAgICAgICAgKiAtIHRoZSBDUjMgd3JpdGUg
d2lsbCBmYXVsdCB3aGVuIENSMy5OT0ZMVVNIIGlzIHNldCAod2hpY2ggaXMgdGhlCi0gICAgICAg
ICAqICAgY2FzZSBub3JtYWxseSksCi0gICAgICAgICAqIC0gdGhlIHN1YnNlcXVlbnQgQ1I0IHdy
aXRlIHdpbGwgZmF1bHQgaWYgQ1IzLlBDSUQgIT0gMC4KLSAgICAgICAgICovCi0gICAgICAgIGlm
ICggKG9sZF9jcjQgJiBYODZfQ1I0X1BDSURFKSA8IChjcjQgJiBYODZfQ1I0X1BDSURFKSApCi0g
ICAgICAgIHsKLSAgICAgICAgICAgIHdyaXRlX2NyNChjcjQpOwotICAgICAgICAgICAgb2xkX2Ny
NCA9IGNyNDsKLSAgICAgICAgfQotICAgIH0KIAogICAgIC8qCi0gICAgICogSWYgd2UgZG9uJ3Qg
Y2hhbmdlIFBDSURzLCB0aGUgQ1IzIHdyaXRlIGJlbG93IG5lZWRzIHRvIGZsdXNoIHRoaXMgdmVy
eQotICAgICAqIFBDSUQsIGV2ZW4gd2hlbiBhIGZ1bGwgZmx1c2ggd2FzIHBlcmZvcm1lZCBhYm92
ZSwgYXMgd2UgYXJlIGN1cnJlbnRseQotICAgICAqIGFjY3VtdWxhdGluZyBUTEIgZW50cmllcyBh
Z2FpbiBmcm9tIHRoZSBvbGQgYWRkcmVzcyBzcGFjZS4KLSAgICAgKiBOQjogQ2xlYXJpbmcgdGhl
IGJpdCB3aGVuIHdlIGRvbid0IHVzZSBQQ0lEIGlzIGJlbmlnbiAoYXMgaXQgaXMgY2xlYXIKLSAg
ICAgKiBhbHJlYWR5IGluIHRoYXQgY2FzZSksIGJ1dCBhbGxvd3MgdGhlIGlmKCkgdG8gYmUgbW9y
ZSBzaW1wbGUuCisgICAgICogSWYgdGhlIENSNCB3cml0ZSBpcyB0byB0dXJuIG9mZiBQQ0lERSwg
d2UgZG9uJ3QgbmVlZCB0aGUgQ1IzIHdyaXRlIHRvCisgICAgICogZmx1c2ggYW55dGhpbmcsIGFz
IHRoYXQgdHJhbnNpdGlvbiBpcyBhIGZ1bGwgZmx1c2ggaXRzZWxmLgogICAgICAqLwotICAgIG9s
ZF9wY2lkID0gY3IzX3BjaWQocmVhZF9jcjMoKSk7Ci0gICAgaWYgKCBvbGRfcGNpZCA9PSBjcjNf
cGNpZChjcjMpICkKLSAgICAgICAgY3IzICY9IH5YODZfQ1IzX05PRkxVU0g7Ci0KKyAgICBpZiAo
IChvbGRfY3I0ICYgWDg2X0NSNF9QQ0lERSkgPiAoY3I0ICYgWDg2X0NSNF9QQ0lERSkgKQorICAg
ICAgICBjcjMgfD0gWDg2X0NSM19OT0ZMVVNIOwogICAgIHdyaXRlX2NyMyhjcjMpOwogCiAgICAg
aWYgKCBvbGRfY3I0ICE9IGNyNCApCiAgICAgICAgIHdyaXRlX2NyNChjcjQpOwogCiAgICAgLyoK
LSAgICAgKiBNYWtlIHN1cmUgbm8gVExCIGVudHJpZXMgcmVsYXRlZCB0byB0aGUgb2xkIFBDSUQg
Y3JlYXRlZCBiZXR3ZWVuCi0gICAgICogZmx1c2hpbmcgdGhlIFRMQiBhbmQgd3JpdGluZyB0aGUg
bmV3ICVjcjMgdmFsdWUgcmVtYWluIGluIHRoZSBUTEIuCi0gICAgICoKLSAgICAgKiBUaGUgd3Jp
dGUgdG8gQ1I0IGp1c3QgYWJvdmUgaGFzIHBlcmZvcm1lZCBhIHdpZGVyIGZsdXNoIGluIGNlcnRh
aW4KLSAgICAgKiBjYXNlcywgd2hpY2ggdGhlcmVmb3JlIGdldCBleGNsdWRlZCBoZXJlLiBTaW5j
ZSB0aGF0IHdyaXRlIGlzCi0gICAgICogY29uZGl0aW9uYWwsIG5vdGUgaW4gcGFydGljdWxhciB0
aGF0IGl0IHdvbid0IGJlIHNraXBwZWQgaWYgUENJREUKLSAgICAgKiB0cmFuc2l0aW9ucyBmcm9t
IDEgdG8gMC4gVGhpcyBpcyBiZWNhdXNlIHRoZSBDUjQgd3JpdGUgZnVydGhlciB1cCB3aWxsCi0g
ICAgICogaGF2ZSBiZWVuIHNraXBwZWQgaW4gdGhpcyBjYXNlLCBhcyBQQ0lERSBhbmQgUEdFIHdv
bid0IGJvdGggYmUgc2V0IGF0Ci0gICAgICogdGhlIHNhbWUgdGltZS4KLSAgICAgKgotICAgICAq
IE5vdGUgYWxzbyB0aGF0IFBHRSBpcyBhbHdheXMgY2xlYXIgaW4gb2xkX2NyNC4KKyAgICAgKiAg
UEdFICB8IFBDSURFIHwgZmx1c2ggYXQKKyAgICAgKiAtLS0tLS0rLS0tLS0tLSstLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0KKyAgICAgKiAgMC0+MCB8IDAtPjAgIHwgQ1IzIHdyaXRlCisgICAgICog
IDAtPjAgfCAwLT4xICB8IG4vYSAoc2VlIDFzdCBDUjQgd3JpdGUpCisgICAgICogIDAtPnggfCAx
LT4wICB8IENSNCB3cml0ZQorICAgICAqICB4LT4xIHwgeC0+MSAgfCBuL2EKKyAgICAgKiAgMC0+
MCB8IDEtPjEgIHwgSU5WUENJRAorICAgICAqICAwLT4xIHwgMC0+MCAgfCBDUjMgYW5kIENSNCB3
cml0ZXMKKyAgICAgKiAgMS0+MCB8IDAtPjAgIHwgQ1I0IHdyaXRlCisgICAgICogIDEtPjAgfCAw
LT4xICB8IG4vYSAoc2VlIDFzdCBDUjQgd3JpdGUpCisgICAgICogIDEtPjEgfCAwLT4wICB8IG4v
YSAoc2VlIDFzdCBDUjQgd3JpdGUpCisgICAgICogIDEtPnggfCAxLT54ICB8IG4vYQogICAgICAq
LwotICAgIGlmICggb2xkX3BjaWQgIT0gY3IzX3BjaWQoY3IzKSAmJgotICAgICAgICAgIShjcjQg
JiBYODZfQ1I0X1BHRSkgJiYKLSAgICAgICAgIChvbGRfY3I0ICYgWDg2X0NSNF9QQ0lERSkgPD0g
KGNyNCAmIFg4Nl9DUjRfUENJREUpICkKLSAgICAgICAgaW52cGNpZF9mbHVzaF9zaW5nbGVfY29u
dGV4dChvbGRfcGNpZCk7CisgICAgaWYgKCBjcjQgJiBYODZfQ1I0X1BDSURFICkKKyAgICAgICAg
aW52cGNpZF9mbHVzaF9hbGxfbm9uZ2xvYmFscygpOwogCiAgICAgcG9zdF9mbHVzaCh0KTsKIAoK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZl
bCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlz
dHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id EF0B8125214
	for <lists+xen-devel@lfdr.de>; Wed, 18 Dec 2019 20:43:50 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ihfCa-0007oC-Tb; Wed, 18 Dec 2019 19:41:44 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=wZRn=2I=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1ihfCZ-0007nC-HJ
 for xen-devel@lists.xenproject.org; Wed, 18 Dec 2019 19:41:43 +0000
X-Inumbo-ID: 62df30ca-21ce-11ea-b6f1-bc764e2007e4
Received: from mga04.intel.com (unknown [192.55.52.120])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 62df30ca-21ce-11ea-b6f1-bc764e2007e4;
 Wed, 18 Dec 2019 19:41:29 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga008.jf.intel.com ([10.7.209.65])
 by fmsmga104.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 18 Dec 2019 11:41:29 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,330,1571727600"; d="scan'208";a="210196408"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.254.103.7])
 by orsmga008.jf.intel.com with ESMTP; 18 Dec 2019 11:41:27 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Wed, 18 Dec 2019 11:40:54 -0800
Message-Id: <62ea55ed1aff2cea6e31c1da4ecd92981aff28d2.1576697796.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1576697796.git.tamas.lengyel@intel.com>
References: <cover.1576697796.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2 17/20] xen/mem_sharing: VM forking
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Stefano Stabellini <sstabellini@kernel.org>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tamas K Lengyel <tamas@tklengyel.com>,
 Jan Beulich <jbeulich@suse.com>, Julien Grall <julien@xen.org>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Vk0gZm9ya2luZyBpcyB0aGUgcHJvY2VzcyBvZiBjcmVhdGluZyBhIGRvbWFpbiB3aXRoIGFuIGVt
cHR5IG1lbW9yeSBzcGFjZSBhbmQgYQpwYXJlbnQgZG9tYWluIHNwZWNpZmllZCBmcm9tIHdoaWNo
IHRvIHBvcHVsYXRlIHRoZSBtZW1vcnkgd2hlbiBuZWNlc3NhcnkuIEZvcgp0aGUgbmV3IGRvbWFp
biB0byBiZSBmdW5jdGlvbmFsIHRoZSBWTSBzdGF0ZSBpcyBjb3BpZWQgb3ZlciBhcyBwYXJ0IG9m
IHRoZSBmb3JrCm9wZXJhdGlvbiAoSFZNIHBhcmFtcywgaGFwIGFsbG9jYXRpb24sIGV0YykuCgpT
aWduZWQtb2ZmLWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxAaW50ZWwuY29tPgot
LS0KIHhlbi9hcmNoL3g4Ni9odm0vaHZtLmMgICAgICAgICAgICB8ICAgMiArLQogeGVuL2FyY2gv
eDg2L21tL21lbV9zaGFyaW5nLmMgICAgIHwgMjI4ICsrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKwogeGVuL2FyY2gveDg2L21tL3AybS5jICAgICAgICAgICAgIHwgIDExICstCiB4ZW4vaW5j
bHVkZS9hc20teDg2L21lbV9zaGFyaW5nLmggfCAgMjAgKystCiB4ZW4vaW5jbHVkZS9wdWJsaWMv
bWVtb3J5LmggICAgICAgfCAgIDUgKwogeGVuL2luY2x1ZGUveGVuL3NjaGVkLmggICAgICAgICAg
IHwgICAxICsKIDYgZmlsZXMgY2hhbmdlZCwgMjYzIGluc2VydGlvbnMoKyksIDQgZGVsZXRpb25z
KC0pCgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2h2bS9odm0uYyBiL3hlbi9hcmNoL3g4Ni9o
dm0vaHZtLmMKaW5kZXggOGY5MDg0MTgxMy4uY2FmZDA3YzY3ZCAxMDA2NDQKLS0tIGEveGVuL2Fy
Y2gveDg2L2h2bS9odm0uYworKysgYi94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCkBAIC0xOTEzLDcg
KzE5MTMsNyBAQCBpbnQgaHZtX2hhcF9uZXN0ZWRfcGFnZV9mYXVsdChwYWRkcl90IGdwYSwgdW5z
aWduZWQgbG9uZyBnbGEsCiAgICAgfQogI2VuZGlmCiAKLSAgICAvKiBTcHVyaW91cyBmYXVsdD8g
UG9EIGFuZCBsb2ctZGlydHkgYWxzbyB0YWtlIHRoaXMgcGF0aC4gKi8KKyAgICAvKiBTcHVyaW91
cyBmYXVsdD8gUG9ELCBsb2ctZGlydHkgYW5kIFZNIGZvcmtpbmcgYWxzbyB0YWtlIHRoaXMgcGF0
aC4gKi8KICAgICBpZiAoIHAybV9pc19yYW0ocDJtdCkgKQogICAgIHsKICAgICAgICAgcmMgPSAx
OwpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMgYi94ZW4vYXJjaC94
ODYvbW0vbWVtX3NoYXJpbmcuYwppbmRleCBjNDRlN2YyMjk5Li5lOTNhZDJlYzVhIDEwMDY0NAot
LS0gYS94ZW4vYXJjaC94ODYvbW0vbWVtX3NoYXJpbmcuYworKysgYi94ZW4vYXJjaC94ODYvbW0v
bWVtX3NoYXJpbmcuYwpAQCAtMjIsMTEgKzIyLDEzIEBACiAKICNpbmNsdWRlIDx4ZW4vdHlwZXMu
aD4KICNpbmNsdWRlIDx4ZW4vZG9tYWluX3BhZ2UuaD4KKyNpbmNsdWRlIDx4ZW4vZXZlbnQuaD4K
ICNpbmNsdWRlIDx4ZW4vc3BpbmxvY2suaD4KICNpbmNsdWRlIDx4ZW4vcndsb2NrLmg+CiAjaW5j
bHVkZSA8eGVuL21tLmg+CiAjaW5jbHVkZSA8eGVuL2dyYW50X3RhYmxlLmg+CiAjaW5jbHVkZSA8
eGVuL3NjaGVkLmg+CisjaW5jbHVkZSA8eGVuL3NjaGVkLWlmLmg+CiAjaW5jbHVkZSA8eGVuL3Jj
dXBkYXRlLmg+CiAjaW5jbHVkZSA8eGVuL2d1ZXN0X2FjY2Vzcy5oPgogI2luY2x1ZGUgPHhlbi92
bV9ldmVudC5oPgpAQCAtMzYsNiArMzgsOSBAQAogI2luY2x1ZGUgPGFzbS9hbHRwMm0uaD4KICNp
bmNsdWRlIDxhc20vYXRvbWljLmg+CiAjaW5jbHVkZSA8YXNtL2V2ZW50Lmg+CisjaW5jbHVkZSA8
YXNtL2hhcC5oPgorI2luY2x1ZGUgPGFzbS9odm0vaHZtLmg+CisjaW5jbHVkZSA8YXNtL2h2bS9z
YXZlLmg+CiAjaW5jbHVkZSA8eHNtL3hzbS5oPgogCiAjaW5jbHVkZSAibW0tbG9ja3MuaCIKQEAg
LTE0MjMsNiArMTQyOCwyMDAgQEAgc3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfY29udHJv
bChzdHJ1Y3QgZG9tYWluICpkLCBib29sIGVuYWJsZSkKICAgICByZXR1cm4gMDsKIH0KIAorLyoK
KyAqIEZvcmtpbmcgYSBwYWdlIG9ubHkgZ2V0cyBjYWxsZWQgd2hlbiB0aGUgVk0gZmF1bHRzIGR1
ZSB0byBubyBlbnRyeSBiZWluZworICogaW4gdGhlIEVQVCBmb3IgdGhlIGFjY2Vzcy4gRGVwZW5k
aW5nIG9uIHRoZSB0eXBlIG9mIGFjY2VzcyB3ZSBlaXRoZXIKKyAqIHBvcHVsYXRlIHRoZSBwaHlz
bWFwIHdpdGggYSBzaGFyZWQgZW50cnkgZm9yIHJlYWQtb25seSBhY2Nlc3Mgb3IKKyAqIGZvcmsg
dGhlIHBhZ2UgaWYgaXRzIGEgd3JpdGUgYWNjZXNzLgorICoKKyAqIFRoZSBjbGllbnQgcDJtIGlz
IGFscmVhZHkgbG9ja2VkIHNvIHdlIG9ubHkgbmVlZCB0byBsb2NrCisgKiB0aGUgcGFyZW50J3Mg
aGVyZS4KKyAqLworaW50IG1lbV9zaGFyaW5nX2ZvcmtfcGFnZShzdHJ1Y3QgZG9tYWluICpkLCBn
Zm5fdCBnZm4sIGJvb2wgdW5zaGFyaW5nKQoreworICAgIGludCByYyA9IC1FTk9FTlQ7CisgICAg
c2hyX2hhbmRsZV90IGhhbmRsZTsKKyAgICBzdHJ1Y3QgZG9tYWluICpwYXJlbnQ7CisgICAgc3Ry
dWN0IHAybV9kb21haW4gKnAybTsKKyAgICB1bnNpZ25lZCBsb25nIGdmbl9sID0gZ2ZuX3goZ2Zu
KTsKKyAgICBtZm5fdCBtZm4sIG5ld19tZm47CisgICAgcDJtX3R5cGVfdCBwMm10OworICAgIHN0
cnVjdCBwYWdlX2luZm8gKnBhZ2U7CisKKyAgICBpZiAoICFtZW1fc2hhcmluZ19pc19mb3JrKGQp
ICkKKyAgICAgICAgcmV0dXJuIC1FTk9FTlQ7CisKKyAgICBwYXJlbnQgPSBkLT5wYXJlbnQ7CisK
KyAgICBpZiAoICF1bnNoYXJpbmcgKQorICAgIHsKKyAgICAgICAgLyogRm9yIHJlYWQtb25seSBh
Y2Nlc3NlcyB3ZSBqdXN0IGFkZCBhIHNoYXJlZCBlbnRyeSB0byB0aGUgcGh5c21hcCAqLworICAg
ICAgICB3aGlsZSAoIHBhcmVudCApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggIShyYyA9
IG5vbWluYXRlX3BhZ2UocGFyZW50LCBnZm4sIDAsICZoYW5kbGUpKSApCisgICAgICAgICAgICAg
ICAgYnJlYWs7CisKKyAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC0+cGFyZW50OworICAgICAg
ICB9CisKKyAgICAgICAgaWYgKCAhcmMgKQorICAgICAgICB7CisgICAgICAgICAgICAvKiBUaGUg
Y2xpZW50J3MgcDJtIGlzIGFscmVhZHkgbG9ja2VkICovCisgICAgICAgICAgICBzdHJ1Y3QgcDJt
X2RvbWFpbiAqcHAybSA9IHAybV9nZXRfaG9zdHAybShwYXJlbnQpOworCisgICAgICAgICAgICBw
Mm1fbG9jayhwcDJtKTsKKyAgICAgICAgICAgIHJjID0gYWRkX3RvX3BoeXNtYXAocGFyZW50LCBn
Zm5fbCwgaGFuZGxlLCBkLCBnZm5fbCwgZmFsc2UpOworICAgICAgICAgICAgcDJtX3VubG9jayhw
cDJtKTsKKworICAgICAgICAgICAgaWYgKCAhcmMgKQorICAgICAgICAgICAgICAgIHJldHVybiAw
OworICAgICAgICB9CisgICAgfQorCisgICAgLyoKKyAgICAgKiBJZiBpdCdzIGEgd3JpdGUgYWNj
ZXNzIChpZS4gdW5zaGFyaW5nKSBvciBpZiBhZGRpbmcgYSBzaGFyZWQgZW50cnkgdG8KKyAgICAg
KiB0aGUgcGh5c21hcCBmYWlsZWQgd2UnbGwgZm9yayB0aGUgcGFnZSBkaXJlY3RseS4KKyAgICAg
Ki8KKyAgICBwMm0gPSBwMm1fZ2V0X2hvc3RwMm0oZCk7CisgICAgcGFyZW50ID0gZC0+cGFyZW50
OworCisgICAgd2hpbGUgKCBwYXJlbnQgKQorICAgIHsKKyAgICAgICAgbWZuID0gZ2V0X2dmbl9x
dWVyeShwYXJlbnQsIGdmbl9sLCAmcDJtdCk7CisKKyAgICAgICAgaWYgKCBtZm5fdmFsaWQobWZu
KSAmJiBwMm1faXNfYW55X3JhbShwMm10KSApCisgICAgICAgICAgICBicmVhazsKKworICAgICAg
ICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworICAgICAgICBwYXJlbnQgPSBwYXJlbnQtPnBhcmVu
dDsKKyAgICB9CisKKyAgICBpZiAoICFwYXJlbnQgKQorICAgICAgICByZXR1cm4gLUVOT0VOVDsK
KworICAgIGlmICggIShwYWdlID0gYWxsb2NfZG9taGVhcF9wYWdlKGQsIDApKSApCisgICAgewor
ICAgICAgICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworICAgICAgICByZXR1cm4gLUVOT01FTTsK
KyAgICB9CisKKyAgICBuZXdfbWZuID0gcGFnZV90b19tZm4ocGFnZSk7CisgICAgY29weV9kb21h
aW5fcGFnZShuZXdfbWZuLCBtZm4pOworICAgIHNldF9ncGZuX2Zyb21fbWZuKG1mbl94KG5ld19t
Zm4pLCBnZm5fbCk7CisKKyAgICBwdXRfZ2ZuKHBhcmVudCwgZ2ZuX2wpOworCisgICAgcmV0dXJu
IHAybS0+c2V0X2VudHJ5KHAybSwgZ2ZuLCBuZXdfbWZuLCBQQUdFX09SREVSXzRLLCBwMm1fcmFt
X3J3LAorICAgICAgICAgICAgICAgICAgICAgICAgICBwMm0tPmRlZmF1bHRfYWNjZXNzLCAtMSk7
Cit9CisKK3N0YXRpYyBpbnQgYnJpbmdfdXBfdmNwdXMoc3RydWN0IGRvbWFpbiAqY2QsIHN0cnVj
dCBjcHVwb29sICpjcHVwb29sKQoreworICAgIGludCByZXQ7CisgICAgdW5zaWduZWQgaW50IGk7
CisKKyAgICBpZiAoIChyZXQgPSBjcHVwb29sX21vdmVfZG9tYWluKGNkLCBjcHVwb29sKSkgKQor
ICAgICAgICByZXR1cm4gcmV0OworCisgICAgZm9yICggaSA9IDA7IGkgPCBjZC0+bWF4X3ZjcHVz
OyBpKysgKQorICAgIHsKKyAgICAgICAgaWYgKCBjZC0+dmNwdVtpXSApCisgICAgICAgICAgICBj
b250aW51ZTsKKworICAgICAgICBpZiAoICF2Y3B1X2NyZWF0ZShjZCwgaSkgKQorICAgICAgICAg
ICAgcmV0dXJuIC1FSU5WQUw7CisgICAgfQorCisgICAgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmlu
aXR5KGNkKTsKKyAgICByZXR1cm4gMDsKK30KKworc3RhdGljIGludCBmb3JrX2hhcF9hbGxvY2F0
aW9uKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkKQoreworICAgIGludCByYzsK
KyAgICBib29sIHByZWVtcHRlZDsKKyAgICB1bnNpZ25lZCBsb25nIG1iID0gaGFwX2dldF9hbGxv
Y2F0aW9uKGQpOworCisgICAgaWYgKCBtYiA9PSBoYXBfZ2V0X2FsbG9jYXRpb24oY2QpICkKKyAg
ICAgICAgcmV0dXJuIDA7CisKKyAgICBwYWdpbmdfbG9jayhjZCk7CisgICAgcmMgPSBoYXBfc2V0
X2FsbG9jYXRpb24oY2QsIG1iIDw8ICgyMCAtIFBBR0VfU0hJRlQpLCAmcHJlZW1wdGVkKTsKKyAg
ICBwYWdpbmdfdW5sb2NrKGNkKTsKKworICAgIGlmICggcmMgKQorICAgICAgICByZXR1cm4gcmM7
CisKKyAgICBpZiAoIHByZWVtcHRlZCApCisgICAgICAgIHJldHVybiAtRVJFU1RBUlQ7CisKKyAg
ICByZXR1cm4gMDsKK30KKworc3RhdGljIGludCBmb3JrX2h2bShzdHJ1Y3QgZG9tYWluICpkLCBz
dHJ1Y3QgZG9tYWluICpjZCkKK3sKKyAgICBpbnQgcmMsIGk7CisgICAgc3RydWN0IGh2bV9kb21h
aW5fY29udGV4dCBjID0geyAwIH07CisgICAgdWludDMyX3QgdHNjX21vZGU7CisgICAgdWludDMy
X3QgZ3RzY19raHo7CisgICAgdWludDMyX3QgaW5jYXJuYXRpb247CisgICAgdWludDY0X3QgZWxh
cHNlZF9uc2VjOworCisgICAgYy5zaXplID0gaHZtX3NhdmVfc2l6ZShkKTsKKyAgICBpZiAoIChj
LmRhdGEgPSB4bWFsbG9jX2J5dGVzKGMuc2l6ZSkpID09IE5VTEwgKQorICAgICAgICByZXR1cm4g
LUVOT01FTTsKKworICAgIGZvciAoIGkgPSAwOyBpIDwgSFZNX05SX1BBUkFNUzsgaSsrICkKKyAg
ICB7CisgICAgICAgIHVpbnQ2NF90IHZhbHVlID0gMDsKKworICAgICAgICBpZiAoIGh2bV9nZXRf
cGFyYW0oZCwgaSwgJnZhbHVlKSB8fCAhdmFsdWUgKQorICAgICAgICAgICAgY29udGludWU7CisK
KyAgICAgICAgaWYgKCAocmMgPSBodm1fc2V0X3BhcmFtKGNkLCBpLCB2YWx1ZSkpICkKKyAgICAg
ICAgICAgIGdvdG8gb3V0OworICAgIH0KKworICAgIHRzY19nZXRfaW5mbyhkLCAmdHNjX21vZGUs
ICZlbGFwc2VkX25zZWMsICZndHNjX2toeiwgJmluY2FybmF0aW9uKTsKKyAgICB0c2Nfc2V0X2lu
Zm8oY2QsIHRzY19tb2RlLCBlbGFwc2VkX25zZWMsIGd0c2Nfa2h6LCBpbmNhcm5hdGlvbik7CisK
KyAgICBpZiAoIChyYyA9IGh2bV9zYXZlKGQsICZjKSkgKQorICAgICAgICBnb3RvIG91dDsKKwor
ICAgIGMuY3VyID0gMDsKKyAgICByYyA9IGh2bV9sb2FkKGNkLCAmYyk7CisKK291dDoKKyAgICB4
ZnJlZShjLmRhdGEpOworICAgIHJldHVybiByYzsKK30KKworc3RhdGljIGludCBtZW1fc2hhcmlu
Z19mb3JrKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkKQoreworICAgIGludCBy
YzsKKworICAgIGlmICggIWQtPmNvbnRyb2xsZXJfcGF1c2VfY291bnQgJiYKKyAgICAgICAgIChy
YyA9IGRvbWFpbl9wYXVzZV9ieV9zeXN0ZW1jb250cm9sbGVyKGQpKSApCisgICAgICAgIHJldHVy
biByYzsKKworICAgIGNkLT5tYXhfcGFnZXMgPSBkLT5tYXhfcGFnZXM7CisgICAgY2QtPm1heF92
Y3B1cyA9IGQtPm1heF92Y3B1czsKKworICAgIC8qIHRoaXMgaXMgcHJlZW1wdGlibGUgc28gaXQn
cyB0aGUgZmlyc3QgdG8gZ2V0IGRvbmUgKi8KKyAgICBpZiAoIChyYyA9IGZvcmtfaGFwX2FsbG9j
YXRpb24oZCwgY2QpKSApCisgICAgICAgIHJldHVybiByYzsKKworICAgIGlmICggKHJjID0gYnJp
bmdfdXBfdmNwdXMoY2QsIGQtPmNwdXBvb2wpKSApCisgICAgICAgIHJldHVybiByYzsKKworICAg
IGlmICggKHJjID0gZm9ya19odm0oZCwgY2QpKSApCisgICAgICAgIHJldHVybiByYzsKKworICAg
IGNkLT5wYXJlbnQgPSBkOworCisgICAgcmV0dXJuIDA7Cit9CisKIGludCBtZW1fc2hhcmluZ19t
ZW1vcChYRU5fR1VFU1RfSEFORExFX1BBUkFNKHhlbl9tZW1fc2hhcmluZ19vcF90KSBhcmcpCiB7
CiAgICAgaW50IHJjOwpAQCAtMTY3Nyw2ICsxODc2LDM1IEBAIGludCBtZW1fc2hhcmluZ19tZW1v
cChYRU5fR1VFU1RfSEFORExFX1BBUkFNKHhlbl9tZW1fc2hhcmluZ19vcF90KSBhcmcpCiAgICAg
ICAgICAgICByYyA9IGRlYnVnX2dyZWYoZCwgbXNvLnUuZGVidWcudS5ncmVmKTsKICAgICAgICAg
ICAgIGJyZWFrOwogCisgICAgICAgIGNhc2UgWEVOTUVNX3NoYXJpbmdfb3BfZm9yazoKKyAgICAg
ICAgeworICAgICAgICAgICAgc3RydWN0IGRvbWFpbiAqcGQ7CisKKyAgICAgICAgICAgIHJjID0g
LUVJTlZBTDsKKyAgICAgICAgICAgIGlmICggbXNvLnUuZm9yay5fcGFkWzBdIHx8IG1zby51LmZv
cmsuX3BhZFsxXSB8fAorICAgICAgICAgICAgICAgICBtc28udS5mb3JrLl9wYWRbMl0gKQorICAg
ICAgICAgICAgICAgICBnb3RvIG91dDsKKworICAgICAgICAgICAgcmMgPSByY3VfbG9ja19saXZl
X3JlbW90ZV9kb21haW5fYnlfaWQobXNvLnUuZm9yay5wYXJlbnRfZG9tYWluLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJnBkKTsKKyAgICAgICAg
ICAgIGlmICggcmMgKQorICAgICAgICAgICAgICAgIGdvdG8gb3V0OworCisgICAgICAgICAgICBp
ZiAoICFtZW1fc2hhcmluZ19lbmFibGVkKHBkKSApCisgICAgICAgICAgICB7CisgICAgICAgICAg
ICAgICAgaWYgKCAocmMgPSBtZW1fc2hhcmluZ19jb250cm9sKHBkLCB0cnVlKSkgKQorICAgICAg
ICAgICAgICAgICAgICBnb3RvIG91dDsKKyAgICAgICAgICAgIH0KKworICAgICAgICAgICAgcmMg
PSBtZW1fc2hhcmluZ19mb3JrKHBkLCBkKTsKKworICAgICAgICAgICAgaWYgKCByYyA9PSAtRVJF
U1RBUlQgKQorICAgICAgICAgICAgICAgIHJjID0gaHlwZXJjYWxsX2NyZWF0ZV9jb250aW51YXRp
b24oX19IWVBFUlZJU09SX21lbW9yeV9vcCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICJsaCIsIFhFTk1FTV9zaGFyaW5nX29wLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnKTsKKyAgICAgICAg
ICAgIHJjdV91bmxvY2tfZG9tYWluKHBkKTsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICB9
CiAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICByYyA9IC1FTk9TWVM7CiAgICAgICAgICAg
ICBicmVhazsKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9tbS9wMm0uYyBiL3hlbi9hcmNoL3g4
Ni9tbS9wMm0uYwppbmRleCA1M2VhNDRmZTNjLi41NWMyNjA3MzFlIDEwMDY0NAotLS0gYS94ZW4v
YXJjaC94ODYvbW0vcDJtLmMKKysrIGIveGVuL2FyY2gveDg2L21tL3AybS5jCkBAIC01MDgsNiAr
NTA4LDE0IEBAIG1mbl90IF9fZ2V0X2dmbl90eXBlX2FjY2VzcyhzdHJ1Y3QgcDJtX2RvbWFpbiAq
cDJtLCB1bnNpZ25lZCBsb25nIGdmbl9sLAogCiAgICAgbWZuID0gcDJtLT5nZXRfZW50cnkocDJt
LCBnZm4sIHQsIGEsIHEsIHBhZ2Vfb3JkZXIsIE5VTEwpOwogCisgICAgLyogQ2hlY2sgaWYgd2Ug
bmVlZCB0byBmb3JrIHRoZSBwYWdlICovCisgICAgaWYgKCAocSAmIFAyTV9BTExPQykgJiYgcDJt
X2lzX2hvbGUoKnQpICYmCisgICAgICAgICAhbWVtX3NoYXJpbmdfZm9ya19wYWdlKHAybS0+ZG9t
YWluLCBnZm4sICEhKHEgJiBQMk1fVU5TSEFSRSkpICkKKyAgICB7CisgICAgICAgIG1mbiA9IHAy
bS0+Z2V0X2VudHJ5KHAybSwgZ2ZuLCB0LCBhLCBxLCBwYWdlX29yZGVyLCBOVUxMKTsKKyAgICB9
CisKKyAgICAvKiBDaGVjayBpZiB3ZSBuZWVkIHRvIHVuc2hhcmUgdGhlIHBhZ2UgKi8KICAgICBp
ZiAoIChxICYgUDJNX1VOU0hBUkUpICYmIHAybV9pc19zaGFyZWQoKnQpICkKICAgICB7CiAgICAg
ICAgIEFTU0VSVChwMm1faXNfaG9zdHAybShwMm0pKTsKQEAgLTU4Niw3ICs1OTQsOCBAQCBzdHJ1
Y3QgcGFnZV9pbmZvICpwMm1fZ2V0X3BhZ2VfZnJvbV9nZm4oCiAgICAgICAgICAgICByZXR1cm4g
cGFnZTsKIAogICAgICAgICAvKiBFcnJvciBwYXRoOiBub3QgYSBzdWl0YWJsZSBHRk4gYXQgYWxs
ICovCi0gICAgICAgIGlmICggIXAybV9pc19yYW0oKnQpICYmICFwMm1faXNfcGFnaW5nKCp0KSAm
JiAhcDJtX2lzX3BvZCgqdCkgKQorICAgICAgICBpZiAoICFwMm1faXNfcmFtKCp0KSAmJiAhcDJt
X2lzX3BhZ2luZygqdCkgJiYgIXAybV9pc19wb2QoKnQpICYmCisgICAgICAgICAgICAgIW1lbV9z
aGFyaW5nX2lzX2ZvcmsocDJtLT5kb21haW4pICkKICAgICAgICAgICAgIHJldHVybiBOVUxMOwog
ICAgIH0KIApkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oIGIv
eGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oCmluZGV4IDRiOTgyYTQ4MDMuLmY4MGQz
YWNkZWIgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvbWVtX3NoYXJpbmcuaAorKysg
Yi94ZW4vaW5jbHVkZS9hc20teDg2L21lbV9zaGFyaW5nLmgKQEAgLTI2LDggKzI2LDcgQEAKIAog
I2lmZGVmIENPTkZJR19NRU1fU0hBUklORwogCi1zdHJ1Y3QgbWVtX3NoYXJpbmdfZG9tYWluCi17
CitzdHJ1Y3QgbWVtX3NoYXJpbmdfZG9tYWluIHsKICAgICBib29sIGVuYWJsZWQ7CiAKICAgICAv
KgpAQCAtNDAsNiArMzksOSBAQCBzdHJ1Y3QgbWVtX3NoYXJpbmdfZG9tYWluCiAjZGVmaW5lIG1l
bV9zaGFyaW5nX2VuYWJsZWQoZCkgXAogICAgIChoYXBfZW5hYmxlZChkKSAmJiAoZCktPmFyY2gu
aHZtLm1lbV9zaGFyaW5nLmVuYWJsZWQpCiAKKyNkZWZpbmUgbWVtX3NoYXJpbmdfaXNfZm9yayhk
KSBcCisgICAgKG1lbV9zaGFyaW5nX2VuYWJsZWQoZCkgJiYgISEoKGQpLT5wYXJlbnQpKQorCiAv
KiBBdWRpdGluZyBvZiBtZW1vcnkgc2hhcmluZyBjb2RlPyAqLwogI2lmbmRlZiBOREVCVUcKICNk
ZWZpbmUgTUVNX1NIQVJJTkdfQVVESVQgMQpAQCAtOTAsNiArOTIsOSBAQCBpbnQgbWVtX3NoYXJp
bmdfdW5zaGFyZV9wYWdlKHN0cnVjdCBkb21haW4gKmQsCiAgICAgcmV0dXJuIHJjOwogfQogCitp
bnQgbWVtX3NoYXJpbmdfZm9ya19wYWdlKHN0cnVjdCBkb21haW4gKmQsIGdmbl90IGdmbiwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgYm9vbCB1bnNoYXJpbmcpOworCiAvKgogICogSWYgY2Fs
bGVkIGJ5IGEgZm9yZWlnbiBkb21haW4sIHBvc3NpYmxlIGVycm9ycyBhcmUKICAqICAgLUVCVVNZ
IC0+IHJpbmcgZnVsbApAQCAtMTE5LDYgKzEyNCw3IEBAIGludCByZWxpbnF1aXNoX3NoYXJlZF9w
YWdlcyhzdHJ1Y3QgZG9tYWluICpkKTsKICNlbHNlCiAKICNkZWZpbmUgbWVtX3NoYXJpbmdfZW5h
YmxlZChkKSBmYWxzZQorI2RlZmluZSBtZW1fc2hhcmluZ19pc19mb3JrKHAybSkgZmFsc2UKIAog
c3RhdGljIGlubGluZSB1bnNpZ25lZCBpbnQgbWVtX3NoYXJpbmdfZ2V0X25yX3NhdmVkX21mbnMo
dm9pZCkKIHsKQEAgLTE0NSw2ICsxNTEsMTYgQEAgaW50IG1lbV9zaGFyaW5nX25vdGlmeV9lbm9t
ZW0oc3RydWN0IGRvbWFpbiAqZCwgdW5zaWduZWQgbG9uZyBnZm4sCiAgICAgcmV0dXJuIC1FT1BO
T1RTVVBQOwogfQogCitzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ19mb3JrKHN0cnVjdCBk
b21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkLCBib29sIHZjcHUpCit7CisgICAgcmV0dXJuIC1F
T1BOT1RTVVBQOworfQorCitzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ19mb3JrX3BhZ2Uo
c3RydWN0IGRvbWFpbiAqZCwgZ2ZuX3QgZ2ZuLCBib29sIGxvY2spCit7CisgICAgcmV0dXJuIC1F
T1BOT1RTVVBQOworfQorCiAjZW5kaWYKIAogI2VuZGlmIC8qIF9fTUVNX1NIQVJJTkdfSF9fICov
CmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS9wdWJsaWMvbWVtb3J5LmggYi94ZW4vaW5jbHVkZS9w
dWJsaWMvbWVtb3J5LmgKaW5kZXggY2ZkZGE2ZTJhOC4uOTBhM2Y0NDk4ZSAxMDA2NDQKLS0tIGEv
eGVuL2luY2x1ZGUvcHVibGljL21lbW9yeS5oCisrKyBiL3hlbi9pbmNsdWRlL3B1YmxpYy9tZW1v
cnkuaApAQCAtNDgyLDYgKzQ4Miw3IEBAIERFRklORV9YRU5fR1VFU1RfSEFORExFKHhlbl9tZW1f
YWNjZXNzX29wX3QpOwogI2RlZmluZSBYRU5NRU1fc2hhcmluZ19vcF9hZGRfcGh5c21hcCAgICAg
ICA2CiAjZGVmaW5lIFhFTk1FTV9zaGFyaW5nX29wX2F1ZGl0ICAgICAgICAgICAgIDcKICNkZWZp
bmUgWEVOTUVNX3NoYXJpbmdfb3BfcmFuZ2Vfc2hhcmUgICAgICAgOAorI2RlZmluZSBYRU5NRU1f
c2hhcmluZ19vcF9mb3JrICAgICAgICAgICAgICA5CiAKICNkZWZpbmUgWEVOTUVNX1NIQVJJTkdf
T1BfU19IQU5ETEVfSU5WQUxJRCAgKC0xMCkKICNkZWZpbmUgWEVOTUVNX1NIQVJJTkdfT1BfQ19I
QU5ETEVfSU5WQUxJRCAgKC05KQpAQCAtNTMyLDYgKzUzMywxMCBAQCBzdHJ1Y3QgeGVuX21lbV9z
aGFyaW5nX29wIHsKICAgICAgICAgICAgICAgICB1aW50MzJfdCBncmVmOyAgICAgLyogSU46IGdy
ZWYgdG8gZGVidWcgICAgICAgICAqLwogICAgICAgICAgICAgfSB1OwogICAgICAgICB9IGRlYnVn
OworICAgICAgICBzdHJ1Y3QgbWVtX3NoYXJpbmdfb3BfZm9yayB7CisgICAgICAgICAgICBkb21p
ZF90IHBhcmVudF9kb21haW47CisgICAgICAgICAgICB1aW50MTZfdCBfcGFkWzNdOyAgICAgICAg
ICAgICAgICAvKiBNdXN0IGJlIHNldCB0byAwICovCisgICAgICAgIH0gZm9yazsKICAgICB9IHU7
CiB9OwogdHlwZWRlZiBzdHJ1Y3QgeGVuX21lbV9zaGFyaW5nX29wIHhlbl9tZW1fc2hhcmluZ19v
cF90OwpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmggYi94ZW4vaW5jbHVkZS94
ZW4vc2NoZWQuaAppbmRleCA5ZjdiYzY5MjkzLi5mY2FkOTQ4OTYyIDEwMDY0NAotLS0gYS94ZW4v
aW5jbHVkZS94ZW4vc2NoZWQuaAorKysgYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaApAQCAtNTAx
LDYgKzUwMSw3IEBAIHN0cnVjdCBkb21haW4KICAgICAvKiBNZW1vcnkgc2hhcmluZyBzdXBwb3J0
ICovCiAjaWZkZWYgQ09ORklHX01FTV9TSEFSSU5HCiAgICAgc3RydWN0IHZtX2V2ZW50X2RvbWFp
biAqdm1fZXZlbnRfc2hhcmU7CisgICAgc3RydWN0IGRvbWFpbiAqcGFyZW50OyAvKiBWTSBmb3Jr
IHBhcmVudCAqLwogI2VuZGlmCiAgICAgLyogTWVtb3J5IHBhZ2luZyBzdXBwb3J0ICovCiAjaWZk
ZWYgQ09ORklHX0hBU19NRU1fUEFHSU5HCi0tIAoyLjIwLjEKCgpfX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1k
ZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21h
aWxtYW4vbGlzdGluZm8veGVuLWRldmVs

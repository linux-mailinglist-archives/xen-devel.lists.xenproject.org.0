Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id BE2A6763BA
	for <lists+xen-devel@lfdr.de>; Fri, 26 Jul 2019 12:42:16 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hqxbr-0006cd-0h; Fri, 26 Jul 2019 10:37:59 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=gQyu=VX=gmail.com=andrii.anisov@srs-us1.protection.inumbo.net>)
 id 1hqxbp-0006by-4g
 for xen-devel@lists.xenproject.org; Fri, 26 Jul 2019 10:37:57 +0000
X-Inumbo-ID: 6d259876-af91-11e9-8980-bc764e045a96
Received: from mail-lj1-x242.google.com (unknown [2a00:1450:4864:20::242])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 6d259876-af91-11e9-8980-bc764e045a96;
 Fri, 26 Jul 2019 10:37:55 +0000 (UTC)
Received: by mail-lj1-x242.google.com with SMTP id p17so51022628ljg.1
 for <xen-devel@lists.xenproject.org>; Fri, 26 Jul 2019 03:37:55 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=GHql7nst5PZI5seboz+e6ZOjIlMgKOZG3COnwTjnuXI=;
 b=NSGVgOVO88sYlATLQVikDUBjqOGp5k+vazPW9O9B1bXJ+GK6mKBn1Ge8KD0OV0Ckbo
 qEcuobrfhsKmY6tQSRgcXZue09Wz/eAS11OkEO4Qv+aq3qgZdBFdSJGNrHQ01cFueJRc
 YN7sLYvSH/nf9XjeLgh/CdnmFqvRay22G79L77rqykcuAswU7yYRpoPKDD46CryCJFbD
 T5kP2hzvlgBy4ERaYE3icpD2Kfvrg/U3ct1XBJLGWdtNhP41mioCtDYt2JAToGBrVKdR
 bqprERBd9bH55Ut+/vrLtq2KL8tmwqdkzvtv7jNWFYYDTbSYELMdeWnoR9g8Lmm5F3Jh
 VrIQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=GHql7nst5PZI5seboz+e6ZOjIlMgKOZG3COnwTjnuXI=;
 b=QQc6ooU8akJ8y7EdXsycED9EKu5Ok8AWuFc7kDkMAWhKm7tDzPrDuo/sZrrKWYRsgi
 +e98SDzCc2crdUHRZTVFxWXGxs9FDtR25syJwVrC7FXc9rrYJzEeOFdr1i3olI99F5ep
 Zxc3zZyVmbvKN8JsNDsCvZTn80qulb/Zaju7hXkg007aPGj8lzVBGvkmzf3X/YhA1yL9
 E8WFCoJjz9XI1xL641YbDZHhRBkLxz/TOARU1rnFwPh42LrY9h0q1TcodYpIJ48d2IHR
 2eSZ20XAveCeEFnaiCuihV9PqFDDcVyeRIw/v8U8yxgxbZ8iqTO2INJ37v6pRfH0eSa9
 XEww==
X-Gm-Message-State: APjAAAXzNYnNABX9BbQBT8HkG2W8gO4VLgXup0ewv3SpB91zTQjbJcQX
 Ndh/vHnpz9aeHIG6domOZeZzfM03n68=
X-Google-Smtp-Source: APXvYqx8wtYl0O5SH9Q0NcbAVJxXg8MB6wZSjOnbhJs/IK377DfJz5MwCrtvGOiE0KdcFWliNH60jQ==
X-Received: by 2002:a2e:8ecb:: with SMTP id e11mr10753271ljl.218.1564137473779; 
 Fri, 26 Jul 2019 03:37:53 -0700 (PDT)
Received: from aanisov-work.kyiv.epam.com (ll-22.209.223.85.sovam.net.ua.
 [85.223.209.22])
 by smtp.gmail.com with ESMTPSA id m4sm9938274ljc.56.2019.07.26.03.37.51
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-SHA bits=128/128);
 Fri, 26 Jul 2019 03:37:52 -0700 (PDT)
From: Andrii Anisov <andrii.anisov@gmail.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 26 Jul 2019 13:37:40 +0300
Message-Id: <1564137460-25629-8-git-send-email-andrii.anisov@gmail.com>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <1564137460-25629-1-git-send-email-andrii.anisov@gmail.com>
References: <1564137460-25629-1-git-send-email-andrii.anisov@gmail.com>
Subject: [Xen-devel] [RFC 6/6] schedule: account all the hypervisor time to
 the idle vcpu
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Stefano Stabellini <sstabellini@kernel.org>,
 Andrii Anisov <andrii_anisov@epam.com>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Meng Xu <mengxu@cis.upenn.edu>,
 Jan Beulich <jbeulich@suse.com>, Dario Faggioli <dfaggioli@suse.com>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

RnJvbTogQW5kcmlpIEFuaXNvdiA8YW5kcmlpX2FuaXNvdkBlcGFtLmNvbT4KCkFjY291bnQgZm9y
IGEgZ3Vlc3Q6CiAtIGd1ZXN0IHJ1bm5pbmcgdGltZQogLSBndWVzdCBzeW5jIHRyYXBzIHNlcnZp
bmcgdGltZSAoaHlwZXJjYWxscywgdHJhcHBlZCBlbXVsYXRlZCBpb21lbXMsIGV0YykKIC0gdmNw
dSBqb2JzIGluIGxlYXZlX2h5cGVydmlzb3JfdGFpbAoKQWNjb3VudCBmb3IgdGhlIGh5cDoKIC0g
SVJRIHByb2Nlc3NpbmcKIC0gU29mdGlycSBwcm9jZXNzaW5nCgpTaWduZWQtb2ZmLWJ5OiBBbmRy
aWkgQW5pc292IDxhbmRyaWlfYW5pc292QGVwYW0uY29tPgotLS0KIHhlbi9hcmNoL2FybS90cmFw
cy5jICAgICAgIHwgNDkgKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tCiB4ZW4vY29tbW9u
L3NjaGVkX2NyZWRpdC5jICB8ICAyICstCiB4ZW4vY29tbW9uL3NjaGVkX2NyZWRpdDIuYyB8ICA0
ICstLQogeGVuL2NvbW1vbi9zY2hlZF9ydC5jICAgICAgfCAgMiArLQogeGVuL2NvbW1vbi9zY2hl
ZHVsZS5jICAgICAgfCA3NCArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKyst
LS0tLS0tCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCAgICB8ICA1ICsrKysKIDYgZmlsZXMgY2hh
bmdlZCwgMTE2IGluc2VydGlvbnMoKyksIDIwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hl
bi9hcmNoL2FybS90cmFwcy5jIGIveGVuL2FyY2gvYXJtL3RyYXBzLmMKaW5kZXggMTM3MjZkYi4u
Zjk3OGI5NCAxMDA2NDQKLS0tIGEveGVuL2FyY2gvYXJtL3RyYXBzLmMKKysrIGIveGVuL2FyY2gv
YXJtL3RyYXBzLmMKQEAgLTIwNjQsNyArMjA2NCw3IEBAIHZvaWQgZG9fdHJhcF9ndWVzdF9zeW5j
KHN0cnVjdCBjcHVfdXNlcl9yZWdzICpyZWdzKQogICAgICAgICBpZiAoICFjaGVja19jb25kaXRp
b25hbF9pbnN0cihyZWdzLCBoc3IpICkKICAgICAgICAgewogICAgICAgICAgICAgYWR2YW5jZV9w
YyhyZWdzLCBoc3IpOwotICAgICAgICAgICAgcmV0dXJuOworICAgICAgICAgICAgYnJlYWs7CiAg
ICAgICAgIH0KICAgICAgICAgaWYgKCBoc3Iud2ZpX3dmZS50aSApIHsKICAgICAgICAgICAgIC8q
IFlpZWxkIHRoZSBWQ1BVIGZvciBXRkUgKi8KQEAgLTIxMjYsMTAgKzIxMjYsMTYgQEAgdm9pZCBk
b190cmFwX2d1ZXN0X3N5bmMoc3RydWN0IGNwdV91c2VyX3JlZ3MgKnJlZ3MpCiAgICAgICAgIHBl
cmZjX2luY3IodHJhcF9odmMzMik7CiAjaWZuZGVmIE5ERUJVRwogICAgICAgICBpZiAoIChoc3Iu
aXNzICYgMHhmZjAwKSA9PSAweGZmMDAgKQotICAgICAgICAgICAgcmV0dXJuIGRvX2RlYnVnX3Ry
YXAocmVncywgaHNyLmlzcyAmIDB4MDBmZik7CisgICAgICAgIHsKKyAgICAgICAgICAgIGRvX2Rl
YnVnX3RyYXAocmVncywgaHNyLmlzcyAmIDB4MDBmZik7CisgICAgICAgICAgICBicmVhazsKKyAg
ICAgICAgfQogI2VuZGlmCiAgICAgICAgIGlmICggaHNyLmlzcyA9PSAwICkKLSAgICAgICAgICAg
IHJldHVybiBkb190cmFwX2h2Y19zbWNjYyhyZWdzKTsKKyAgICAgICAgeworICAgICAgICAgICAg
ZG9fdHJhcF9odmNfc21jY2MocmVncyk7CisgICAgICAgICAgICBicmVhazsKKyAgICAgICAgfQog
ICAgICAgICBuciA9IHJlZ3MtPnIxMjsKICAgICAgICAgZG9fdHJhcF9oeXBlcmNhbGwocmVncywg
Jm5yLCBoc3IpOwogICAgICAgICByZWdzLT5yMTIgPSAodWludDMyX3QpbnI7CkBAIC0yMTQxLDEw
ICsyMTQ3LDE2IEBAIHZvaWQgZG9fdHJhcF9ndWVzdF9zeW5jKHN0cnVjdCBjcHVfdXNlcl9yZWdz
ICpyZWdzKQogICAgICAgICBwZXJmY19pbmNyKHRyYXBfaHZjNjQpOwogI2lmbmRlZiBOREVCVUcK
ICAgICAgICAgaWYgKCAoaHNyLmlzcyAmIDB4ZmYwMCkgPT0gMHhmZjAwICkKLSAgICAgICAgICAg
IHJldHVybiBkb19kZWJ1Z190cmFwKHJlZ3MsIGhzci5pc3MgJiAweDAwZmYpOworICAgICAgICB7
CisgICAgICAgICAgICBkb19kZWJ1Z190cmFwKHJlZ3MsIGhzci5pc3MgJiAweDAwZmYpOworICAg
ICAgICAgICAgYnJlYWs7CisgICAgICAgIH0KICNlbmRpZgogICAgICAgICBpZiAoIGhzci5pc3Mg
PT0gMCApCi0gICAgICAgICAgICByZXR1cm4gZG9fdHJhcF9odmNfc21jY2MocmVncyk7CisgICAg
ICAgIHsKKyAgICAgICAgICAgIGRvX3RyYXBfaHZjX3NtY2NjKHJlZ3MpOworICAgICAgICAgICAg
YnJlYWs7CisgICAgICAgIH0KICAgICAgICAgZG9fdHJhcF9oeXBlcmNhbGwocmVncywgJnJlZ3Mt
PngxNiwgaHNyKTsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIU1JfRUNfU01DNjQ6CkBAIC0y
MTc5LDYgKzIxOTEsMTEgQEAgdm9pZCBkb190cmFwX2d1ZXN0X3N5bmMoc3RydWN0IGNwdV91c2Vy
X3JlZ3MgKnJlZ3MpCiAgICAgICAgICAgICAgICAgaHNyLmJpdHMsIGhzci5lYywgaHNyLmxlbiwg
aHNyLmlzcyk7CiAgICAgICAgIGluamVjdF91bmRlZl9leGNlcHRpb24ocmVncywgaHNyKTsKICAg
ICB9CisKKyAgICBsb2NhbF9pcnFfZGlzYWJsZSgpOworICAgIGh5cF90YWNjX2hlYWQoMSk7CisK
KyAgICAvKndlIHdpbGwgY2FsbCB0YWNjIHRhaWwgZnJvbSB0aGUgbGVhdmVfaHlwZXJ2aXNvcl90
YWlsKi8KIH0KIAogdm9pZCBkb190cmFwX2h5cF9zeW5jKHN0cnVjdCBjcHVfdXNlcl9yZWdzICpy
ZWdzKQpAQCAtMjIxOSw2ICsyMjM2LDcgQEAgdm9pZCBkb190cmFwX2h5cF9zeW5jKHN0cnVjdCBj
cHVfdXNlcl9yZWdzICpyZWdzKQogICAgICAgICAgICAgICAgaHNyLmJpdHMsIGhzci5lYywgaHNy
LmxlbiwgaHNyLmlzcyk7CiAgICAgICAgIGRvX3VuZXhwZWN0ZWRfdHJhcCgiSHlwZXJ2aXNvciIs
IHJlZ3MpOwogICAgIH0KKwogfQogCiB2b2lkIGRvX3RyYXBfaHlwX3NlcnJvcihzdHJ1Y3QgY3B1
X3VzZXJfcmVncyAqcmVncykKQEAgLTIyMzQsMjggKzIyNTIsNDcgQEAgdm9pZCBkb190cmFwX2d1
ZXN0X3NlcnJvcihzdHJ1Y3QgY3B1X3VzZXJfcmVncyAqcmVncykKICAgICBsb2NhbF9pcnFfZW5h
YmxlKCk7CiAKICAgICBfX2RvX3RyYXBfc2Vycm9yKHJlZ3MsIHRydWUpOworCisgICAgbG9jYWxf
aXJxX2Rpc2FibGUoKTsKKyAgICBoeXBfdGFjY19oZWFkKDIpOwogfQogCiB2b2lkIGRvX3RyYXBf
Z3Vlc3RfaXJxKHN0cnVjdCBjcHVfdXNlcl9yZWdzICpyZWdzKQogeworICAgIGh5cF90YWNjX2hl
YWQoMyk7CisKICAgICBlbnRlcl9oeXBlcnZpc29yX2hlYWQoKTsKICAgICBnaWNfaW50ZXJydXB0
KHJlZ3MsIDApOworCisgICAgLyp3ZSB3aWxsIGNhbGwgdGFjYyB0YWlsIGZyb20gdGhlIGxlYXZl
X2h5cGVydmlzb3JfdGFpbCovCiB9CiAKIHZvaWQgZG9fdHJhcF9ndWVzdF9maXEoc3RydWN0IGNw
dV91c2VyX3JlZ3MgKnJlZ3MpCiB7CisgICAgaHlwX3RhY2NfaGVhZCg0KTsKKwogICAgIGVudGVy
X2h5cGVydmlzb3JfaGVhZCgpOwogICAgIGdpY19pbnRlcnJ1cHQocmVncywgMSk7CisKKyAgICAv
KndlIHdpbGwgY2FsbCB0YWNjIHRhaWwgZnJvbSB0aGUgbGVhdmVfaHlwZXJ2aXNvcl90YWlsKi8K
IH0KIAogdm9pZCBkb190cmFwX2h5cF9pcnEoc3RydWN0IGNwdV91c2VyX3JlZ3MgKnJlZ3MpCiB7
CisgICAgaHlwX3RhY2NfaGVhZCg1KTsKKwogICAgIGdpY19pbnRlcnJ1cHQocmVncywgMCk7CisK
KyAgICBoeXBfdGFjY190YWlsKDUpOwogfQogCiB2b2lkIGRvX3RyYXBfaHlwX2ZpcShzdHJ1Y3Qg
Y3B1X3VzZXJfcmVncyAqcmVncykKIHsKKyAgICBoeXBfdGFjY19oZWFkKDYpOworCiAgICAgZ2lj
X2ludGVycnVwdChyZWdzLCAxKTsKKworICAgIGh5cF90YWNjX3RhaWwoNik7CiB9CiAKIHN0YXRp
YyB2b2lkIGNoZWNrX2Zvcl9wY3B1X3dvcmsodm9pZCkKQEAgLTIzMTgsNiArMjM1NSw4IEBAIHZv
aWQgbGVhdmVfaHlwZXJ2aXNvcl90YWlsKHZvaWQpCiAgICAgICovCiAgICAgU1lOQ0hST05JWkVf
U0VSUk9SKFNLSVBfU1lOQ0hST05JWkVfU0VSUk9SX0VOVFJZX0VYSVQpOwogCisgICAgaHlwX3Rh
Y2NfdGFpbCgxMjM0KTsKKwogICAgIC8qCiAgICAgICogVGhlIGh5cGVydmlzb3IgcnVucyB3aXRo
IHRoZSB3b3JrYXJvdW5kIGFsd2F5cyBwcmVzZW50LgogICAgICAqIElmIHRoZSBndWVzdCB3YW50
cyBpdCBkaXNhYmxlZCwgc28gYmUgaXQuLi4KZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWRf
Y3JlZGl0LmMgYi94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jCmluZGV4IDNjMGQ3YzcuLmI4ZDg2
NmIgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWRfY3JlZGl0LmMKKysrIGIveGVuL2NvbW1v
bi9zY2hlZF9jcmVkaXQuYwpAQCAtMTg1Niw3ICsxODU2LDcgQEAgY3NjaGVkX3NjaGVkdWxlKAog
ICAgICAgICAgICAgICAgICAgICAodW5zaWduZWQgY2hhciAqKSZkKTsKICAgICB9CiAKLSAgICBy
dW50aW1lID0gbm93IC0gY3VycmVudC0+cnVuc3RhdGUuc3RhdGVfZW50cnlfdGltZTsKKyAgICBy
dW50aW1lID0gY3VycmVudC0+cnVudGltZTsKICAgICBpZiAoIHJ1bnRpbWUgPCAwICkgLyogRG9l
cyB0aGlzIGV2ZXIgaGFwcGVuPyAqLwogICAgICAgICBydW50aW1lID0gMDsKIApkaWZmIC0tZ2l0
IGEveGVuL2NvbW1vbi9zY2hlZF9jcmVkaXQyLmMgYi94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdDIu
YwppbmRleCA4ZTQzODFkLi4yZDExYTVmIDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkX2Ny
ZWRpdDIuYworKysgYi94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdDIuYwpAQCAtMzI4NSw3ICszMjg1
LDcgQEAgcnVucV9jYW5kaWRhdGUoc3RydWN0IGNzY2hlZDJfcnVucXVldWVfZGF0YSAqcnFkLAog
ICAgICAqIG5vIHBvaW50IGZvcmNpbmcgaXQgdG8gZG8gc28gdW50aWwgcmF0ZSBsaW1pdGluZyBl
eHBpcmVzLgogICAgICAqLwogICAgIGlmICggIXlpZWxkICYmIHBydi0+cmF0ZWxpbWl0X3VzICYm
IHZjcHVfcnVubmFibGUoc2N1cnItPnZjcHUpICYmCi0gICAgICAgICAobm93IC0gc2N1cnItPnZj
cHUtPnJ1bnN0YXRlLnN0YXRlX2VudHJ5X3RpbWUpIDwKKyAgICAgICAgICBzY3Vyci0+dmNwdS0+
cnVudGltZSA8CiAgICAgICAgICAgTUlDUk9TRUNTKHBydi0+cmF0ZWxpbWl0X3VzKSApCiAgICAg
ewogICAgICAgICBpZiAoIHVubGlrZWx5KHRiX2luaXRfZG9uZSkgKQpAQCAtMzI5Niw3ICszMjk2
LDcgQEAgcnVucV9jYW5kaWRhdGUoc3RydWN0IGNzY2hlZDJfcnVucXVldWVfZGF0YSAqcnFkLAog
ICAgICAgICAgICAgfSBkOwogICAgICAgICAgICAgZC5kb20gPSBzY3Vyci0+dmNwdS0+ZG9tYWlu
LT5kb21haW5faWQ7CiAgICAgICAgICAgICBkLnZjcHUgPSBzY3Vyci0+dmNwdS0+dmNwdV9pZDsK
LSAgICAgICAgICAgIGQucnVudGltZSA9IG5vdyAtIHNjdXJyLT52Y3B1LT5ydW5zdGF0ZS5zdGF0
ZV9lbnRyeV90aW1lOworICAgICAgICAgICAgZC5ydW50aW1lID0gc2N1cnItPnZjcHUtPnJ1bnRp
bWU7CiAgICAgICAgICAgICBfX3RyYWNlX3ZhcihUUkNfQ1NDSEVEMl9SQVRFTElNSVQsIDEsCiAg
ICAgICAgICAgICAgICAgICAgICAgICBzaXplb2YoZCksCiAgICAgICAgICAgICAgICAgICAgICAg
ICAodW5zaWduZWQgY2hhciAqKSZkKTsKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWRfcnQu
YyBiL3hlbi9jb21tb24vc2NoZWRfcnQuYwppbmRleCAwYWNmYzNkLi5mMWRlNTExIDEwMDY0NAot
LS0gYS94ZW4vY29tbW9uL3NjaGVkX3J0LmMKKysrIGIveGVuL2NvbW1vbi9zY2hlZF9ydC5jCkBA
IC05NDcsNyArOTQ3LDcgQEAgYnVybl9idWRnZXQoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3Bz
LCBzdHJ1Y3QgcnRfdmNwdSAqc3ZjLCBzX3RpbWVfdCBub3cpCiAgICAgICAgIHJldHVybjsKIAog
ICAgIC8qIGJ1cm4gYXQgbmFub3NlY29uZHMgbGV2ZWwgKi8KLSAgICBkZWx0YSA9IG5vdyAtIHN2
Yy0+bGFzdF9zdGFydDsKKyAgICBkZWx0YSA9IHN2Yy0+dmNwdS0+cnVudGltZTsKICAgICAvKgog
ICAgICAqIGRlbHRhIDwgMCBvbmx5IGhhcHBlbnMgaW4gbmVzdGVkIHZpcnR1YWxpemF0aW9uOwog
ICAgICAqIFRPRE86IGhvdyBzaG91bGQgd2UgaGFuZGxlIGRlbHRhIDwgMCBpbiBhIGJldHRlciB3
YXk/CmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMgYi94ZW4vY29tbW9uL3NjaGVk
dWxlLmMKaW5kZXggOWU4ODA1ZC4uZDMyNDZmOSAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hl
ZHVsZS5jCisrKyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwpAQCAtMTUwNCwyMCArMTUwNCwxNiBA
QCBzdGF0aWMgdm9pZCBzY2hlZHVsZSh2b2lkKQogICAgICAgICAgICAgIChub3cgLSBuZXh0LT5y
dW5zdGF0ZS5zdGF0ZV9lbnRyeV90aW1lKSA6IDAsCiAgICAgICAgICAgICAgbmV4dF9zbGljZS50
aW1lKTsKIAotICAgIEFTU0VSVChwcmV2LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5u
aW5nKTsKLQogICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0gsCiAgICAgICAgICAgICAgcHJl
di0+ZG9tYWluLT5kb21haW5faWQsIHByZXYtPnZjcHVfaWQsCiAgICAgICAgICAgICAgbmV4dC0+
ZG9tYWluLT5kb21haW5faWQsIG5leHQtPnZjcHVfaWQpOwogCi0gICAgdmNwdV9ydW5zdGF0ZV9j
aGFuZ2UoCi0gICAgICAgIHByZXYsCi0gICAgICAgICgocHJldi0+cGF1c2VfZmxhZ3MgJiBWUEZf
YmxvY2tlZCkgPyBSVU5TVEFURV9ibG9ja2VkIDoKLSAgICAgICAgICh2Y3B1X3J1bm5hYmxlKHBy
ZXYpID8gUlVOU1RBVEVfcnVubmFibGUgOiBSVU5TVEFURV9vZmZsaW5lKSksCi0gICAgICAgIG5v
dyk7Ci0KLSAgICBBU1NFUlQobmV4dC0+cnVuc3RhdGUuc3RhdGUgIT0gUlVOU1RBVEVfcnVubmlu
Zyk7Ci0gICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UobmV4dCwgUlVOU1RBVEVfcnVubmluZywgbm93
KTsKKyAgICBpZiAoICF2Y3B1X3J1bm5hYmxlKHByZXYpICkKKyAgICAgICAgdmNwdV9ydW5zdGF0
ZV9jaGFuZ2UoCisgICAgICAgICAgICBwcmV2LAorICAgICAgICAgICAgKChwcmV2LT5wYXVzZV9m
bGFncyAmIFZQRl9ibG9ja2VkKSA/IFJVTlNUQVRFX2Jsb2NrZWQgOgorICAgICAgICAgICAgIFJV
TlNUQVRFX29mZmxpbmUpLAorICAgICAgICAgICAgbm93KTsKIAogICAgIC8qCiAgICAgICogTkIu
IERvbid0IGFkZCBhbnkgdHJhY2UgcmVjb3JkcyBmcm9tIGhlcmUgdW50aWwgdGhlIGFjdHVhbCBj
b250ZXh0CkBAIC0xNTI2LDYgKzE1MjIsNyBAQCBzdGF0aWMgdm9pZCBzY2hlZHVsZSh2b2lkKQog
CiAgICAgQVNTRVJUKCFuZXh0LT5pc19ydW5uaW5nKTsKICAgICBuZXh0LT5pc19ydW5uaW5nID0g
MTsKKyAgICBuZXh0LT5ydW50aW1lID0gMDsKIAogICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2ly
cShsb2NrLCBjcHUpOwogCkBAIC0xNTQxLDYgKzE1MzgsNTggQEAgc3RhdGljIHZvaWQgc2NoZWR1
bGUodm9pZCkKICAgICBjb250ZXh0X3N3aXRjaChwcmV2LCBuZXh0KTsKIH0KIAorREVGSU5FX1BF
Ul9DUFUoaW50LCBoeXBfdGFjY19jbnQpOworCit2b2lkIGh5cF90YWNjX2hlYWQoaW50IHBsYWNl
KQoreworICAgIC8vcHJpbnRrKCJcdGhlYWQgY3B1ICV1LCBwbGFjZSAlZCwgY250ICVkXG4iLCBz
bXBfcHJvY2Vzc29yX2lkKCksIHBsYWNlLCB0aGlzX2NwdShoeXBfdGFjY19jbnQpKTsKKworICAg
IEFTU0VSVCh0aGlzX2NwdShoeXBfdGFjY19jbnQpID49IDApOworCisgICAgaWYgKCB0aGlzX2Nw
dShoeXBfdGFjY19jbnQpID09IDAgKQorICAgIHsKKyAgICAgICAgc190aW1lX3Qgbm93ID0gTk9X
KCk7CisgICAgICAgIHNwaW5fbG9jayhwZXJfY3B1KHNjaGVkdWxlX2RhdGEsc21wX3Byb2Nlc3Nv
cl9pZCgpKS5zY2hlZHVsZV9sb2NrKTsKKyAgICAgICAgLyoKKyAgICAgICAgICogU3RvcCB0aW1l
IGFjY291bnRpbmcgZm9yIGd1ZXN0IChndWVzdCB2Y3B1KQorICAgICAgICAgKi8KKyAgICAgICAg
QVNTRVJUKCAoY3VycmVudC0+cnVuc3RhdGUuc3RhdGVfZW50cnlfdGltZSAmIFhFTl9SVU5TVEFU
RV9VUERBVEUpID09IDApOworICAgICAgICBjdXJyZW50LT5ydW50aW1lICs9IG5vdyAtIGN1cnJl
bnQtPnJ1bnN0YXRlLnN0YXRlX2VudHJ5X3RpbWU7CisgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hh
bmdlKGN1cnJlbnQsIFJVTlNUQVRFX3J1bm5hYmxlLCBub3cpOworICAgICAgICAvKgorICAgICAg
ICAgKiBTdGFydCB0aW1lIGFjY291bnRpbmcgZm9yIGh5cCAoaWRsZSB2Y3B1KQorICAgICAgICAg
Ki8KKyAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UoaWRsZV92Y3B1W3NtcF9wcm9jZXNzb3Jf
aWQoKV0sIFJVTlNUQVRFX3J1bm5pbmcsIG5vdyk7CisgICAgICAgIHNwaW5fdW5sb2NrKHBlcl9j
cHUoc2NoZWR1bGVfZGF0YSxzbXBfcHJvY2Vzc29yX2lkKCkpLnNjaGVkdWxlX2xvY2spOworICAg
IH0KKworICAgIHRoaXNfY3B1KGh5cF90YWNjX2NudCkrKzsKK30KKwordm9pZCBoeXBfdGFjY190
YWlsKGludCBwbGFjZSkKK3sKKyAgICAvL3ByaW50aygiXHRcdFx0XHR0YWlsIGNwdSAldSwgcGxh
Y2UgJWQsIGNudCAlZFxuIiwgc21wX3Byb2Nlc3Nvcl9pZCgpLCBwbGFjZSwgdGhpc19jcHUoaHlw
X3RhY2NfY250KSk7CisKKyAgICBBU1NFUlQodGhpc19jcHUoaHlwX3RhY2NfY250KSA+IDApOwor
CisgICAgaWYgKHRoaXNfY3B1KGh5cF90YWNjX2NudCkgPT0gMSkKKyAgICB7CisgICAgICAgIHNf
dGltZV90IG5vdyA9IE5PVygpOworICAgICAgICBzcGluX2xvY2socGVyX2NwdShzY2hlZHVsZV9k
YXRhLHNtcF9wcm9jZXNzb3JfaWQoKSkuc2NoZWR1bGVfbG9jayk7CisgICAgICAgIC8qCisgICAg
ICAgICAqIFN0b3AgdGltZSBhY2NvdW50aW5nIGZvciBndWVzdCAoZ3Vlc3QgdmNwdSkKKyAgICAg
ICAgICovCisgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdlKGlkbGVfdmNwdVtzbXBfcHJvY2Vz
c29yX2lkKCldLCBSVU5TVEFURV9ydW5uYWJsZSwgbm93KTsKKyAgICAgICAgLyoKKyAgICAgICAg
ICogU3RhcnQgdGltZSBhY2NvdW50aW5nIGZvciBoeXAgKGlkbGUgdmNwdSkKKyAgICAgICAgICov
CisgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdlKGN1cnJlbnQsIFJVTlNUQVRFX3J1bm5pbmcs
IG5vdyk7CisgICAgICAgIHNwaW5fdW5sb2NrKHBlcl9jcHUoc2NoZWR1bGVfZGF0YSxzbXBfcHJv
Y2Vzc29yX2lkKCkpLnNjaGVkdWxlX2xvY2spOworICAgIH0KKworICAgIHRoaXNfY3B1KGh5cF90
YWNjX2NudCktLTsKK30KKwogdm9pZCBjb250ZXh0X3NhdmVkKHN0cnVjdCB2Y3B1ICpwcmV2KQog
ewogICAgIC8qIENsZWFyIHJ1bm5pbmcgZmxhZyAvYWZ0ZXIvIHdyaXRpbmcgY29udGV4dCB0byBt
ZW1vcnkuICovCkBAIC0xNTk3LDggKzE2NDYsOSBAQCBzdGF0aWMgaW50IGNwdV9zY2hlZHVsZV91
cCh1bnNpZ25lZCBpbnQgY3B1KQogICAgIHNkLT5jdXJyID0gaWRsZV92Y3B1W2NwdV07CiAgICAg
aW5pdF90aW1lcigmc2QtPnNfdGltZXIsIHNfdGltZXJfZm4sIE5VTEwsIGNwdSk7CiAgICAgYXRv
bWljX3NldCgmc2QtPnVyZ2VudF9jb3VudCwgMCk7CisgICAgcGVyX2NwdShoeXBfdGFjY19jbnQs
IGNwdSkgPSAxOwogCi0gICAgLyogQm9vdCBDUFUgaXMgZGVhbHQgd2l0aCBsYXRlciBpbiBzY2hl
ZHVsZV9pbml0KCkuICovCisgICAgLyogQm9vdCBDUFUgaXMgZGVhbHQgd2l0aCBsYXRlciBpbiBz
Y2hlZHVsZXJfaW5pdCgpLiAqLwogICAgIGlmICggY3B1ID09IDAgKQogICAgICAgICByZXR1cm4g
MDsKIApAQCAtMTY1NCw2ICsxNzA0LDggQEAgc3RhdGljIHZvaWQgY3B1X3NjaGVkdWxlX2Rvd24o
dW5zaWduZWQgaW50IGNwdSkKICAgICBzZC0+c2NoZWRfcHJpdiA9IE5VTEw7CiAKICAgICBraWxs
X3RpbWVyKCZzZC0+c190aW1lcik7CisKKyAgICBwZXJfY3B1KGh5cF90YWNjX2NudCwgY3B1KSA9
IDA7CiB9CiAKIHN0YXRpYyBpbnQgY3B1X3NjaGVkdWxlX2NhbGxiYWNrKApkaWZmIC0tZ2l0IGEv
eGVuL2luY2x1ZGUveGVuL3NjaGVkLmggYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaAppbmRleCA1
ZTI4Nzk3Li45MzkxMzE4IDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaAorKysg
Yi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaApAQCAtMTc0LDYgKzE3NCw4IEBAIHN0cnVjdCB2Y3B1
CiAgICAgfSBydW5zdGF0ZV9ndWVzdDsgLyogZ3Vlc3QgYWRkcmVzcyAqLwogI2VuZGlmCiAKKyAg
ICBzX3RpbWVfdCBydW50aW1lOworCiAgICAgLyogSGFzIHRoZSBGUFUgYmVlbiBpbml0aWFsaXNl
ZD8gKi8KICAgICBib29sICAgICAgICAgICAgIGZwdV9pbml0aWFsaXNlZDsKICAgICAvKiBIYXMg
dGhlIEZQVSBiZWVuIHVzZWQgc2luY2UgaXQgd2FzIGxhc3Qgc2F2ZWQ/ICovCkBAIC05OTgsNiAr
MTAwMCw5IEBAIGV4dGVybiB2b2lkIGR1bXBfcnVucSh1bnNpZ25lZCBjaGFyIGtleSk7CiAKIHZv
aWQgYXJjaF9kb19waHlzaW5mbyhzdHJ1Y3QgeGVuX3N5c2N0bF9waHlzaW5mbyAqcGkpOwogCit2
b2lkIGh5cF90YWNjX2hlYWQoaW50IHBsYWNlKTsKK3ZvaWQgaHlwX3RhY2NfdGFpbChpbnQgcGxh
Y2UpOworCiAjZW5kaWYgLyogX19TQ0hFRF9IX18gKi8KIAogLyoKLS0gCjIuNy40CgoKX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxp
bmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5w
cm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 1844343674
	for <lists+xen-devel@lfdr.de>; Thu, 13 Jun 2019 15:26:08 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hbPi5-0001P2-KR; Thu, 13 Jun 2019 13:24:09 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=BOU1=UM=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1hbPi4-0001Ou-Ee
 for xen-devel@lists.xenproject.org; Thu, 13 Jun 2019 13:24:08 +0000
X-Inumbo-ID: 8315664a-8dde-11e9-9fa0-2f843c3e7c55
Received: from prv1-mh.provo.novell.com (unknown [137.65.248.33])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 8315664a-8dde-11e9-9fa0-2f843c3e7c55;
 Thu, 13 Jun 2019 13:24:04 +0000 (UTC)
Received: from INET-PRV1-MTA by prv1-mh.provo.novell.com
 with Novell_GroupWise; Thu, 13 Jun 2019 07:24:03 -0600
Message-Id: <5D024E6F0200007800237E25@prv1-mh.provo.novell.com>
X-Mailer: Novell GroupWise Internet Agent 18.1.1 
Date: Thu, 13 Jun 2019 07:23:59 -0600
From: "Jan Beulich" <JBeulich@suse.com>
To: "xen-devel" <xen-devel@lists.xenproject.org>
References: <5D024C500200007800237DD8@prv1-mh.provo.novell.com>
In-Reply-To: <5D024C500200007800237DD8@prv1-mh.provo.novell.com>
Mime-Version: 1.0
Content-Disposition: inline
Subject: [Xen-devel] [PATCH 4/9] AMD/IOMMU: introduce 128-bit IRTE
 non-guest-APIC IRTE format
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Brian Woods <brian.woods@amd.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhpcyBpcyBpbiBwcmVwYXJhdGlvbiBvZiBhY3R1YWxseSBlbmFibGluZyB4MkFQSUMgbW9kZSwg
d2hpY2ggcmVxdWlyZXMKdGhpcyB3aWRlciBJUlRFIGZvcm1hdCB0byBiZSB1c2VkLgoKQSBzcGVj
aWZpYyByZW1hcmsgcmVnYXJkaW5nIHRoZSBmaXJzdCBodW5rIGNoYW5naW5nCmFtZF9pb21tdV9p
b2FwaWNfdXBkYXRlX2lyZSgpOiBUaGlzIGJ5cGFzcyB3YXMgaW50cm9kdWNlZCBmb3IgWFNBLTM2
LAppLmUuIGJ5IDk0ZDRhMTExOWQgKCJBTUQsSU9NTVU6IENsZWFuIHVwIG9sZCBlbnRyaWVzIGlu
IHJlbWFwcGluZwp0YWJsZXMgd2hlbiBjcmVhdGluZyBuZXcgb25lIikuIE90aGVyIGNvZGUgaW50
cm9kdWNlZCBieSB0aGF0IGNoYW5nZSBoYXMKbWVhbndoaWxlIGRpc2FwcGVhcmVkIG9yIGZ1cnRo
ZXIgY2hhbmdlZCwgYW5kIEkgd29uZGVyIGlmIC0gcmF0aGVyIHRoYW4KYWRkaW5nIGFuIHgyYXBp
Y19lbmFibGVkIGNoZWNrIHRvIHRoZSBjb25kaXRpb25hbCAtIHRoZSBieXBhc3MgY291bGRuJ3QK
YmUgZGVsZXRlZCBhbHRvZ2V0aGVyLiBGb3Igbm93IHRoZSBnb2FsIGlzIHRvIGFmZmVjdCB0aGUg
bm9uLXgyQVBJQwpwYXRocyBhcyBsaXR0bGUgYXMgcG9zc2libGUuCgpUYWtlIHRoZSBsaWJlcnR5
IGFuZCB1c2UgdGhlIG5ldyAiZnJlc2giIGZsYWcgdG8gc3VwcHJlc3MgYW4gdW5uZWVkZWQKZmx1
c2ggaW4gdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zyb21faW9hcGljKCkuCgpTaWduZWQtb2ZmLWJ5
OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+Ci0tLQpOb3RlIHRoYXQgQU1EJ3MgZG9j
IHNheXMgTG93ZXN0IFByaW9yaXR5ICgiQXJiaXRyYXRlZCIgYnkgdGhlaXIgbmFtaW5nKQptb2Rl
IGlzIHVuYXZhaWxhYmxlIGluIHgyQVBJQyBtb2RlLCBidXQgdGhleSd2ZSBjb25maXJtZWQgdGhp
cyB0byBiZSBhCm1pc3Rha2Ugb24gdGhlaXIgcGFydC4KCi0tLSBhL3hlbi9kcml2ZXJzL3Bhc3N0
aHJvdWdoL2FtZC9pb21tdV9pbnRyLmMKKysrIGIveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1k
L2lvbW11X2ludHIuYwpAQCAtMzUsMTIgKzM1LDM0IEBAIHN0cnVjdCBpcnRlX2Jhc2ljIHsKICAg
ICB1bnNpZ25lZCBpbnQgOjg7CiB9OwogCitzdHJ1Y3QgaXJ0ZV9mdWxsIHsKKyAgICB1bnNpZ25l
ZCBpbnQgcmVtYXBfZW46MTsKKyAgICB1bnNpZ25lZCBpbnQgc3VwX2lvX3BmOjE7CisgICAgdW5z
aWduZWQgaW50IGludF90eXBlOjM7CisgICAgdW5zaWduZWQgaW50IHJxX2VvaToxOworICAgIHVu
c2lnbmVkIGludCBkbToxOworICAgIHVuc2lnbmVkIGludCBndWVzdF9tb2RlOjE7IC8qIE1CWiAq
LworICAgIHVuc2lnbmVkIGludCBkZXN0X2xvOjI0OworICAgIHVuc2lnbmVkIGludCA6MzI7Cisg
ICAgdW5zaWduZWQgaW50IHZlY3Rvcjo4OworICAgIHVuc2lnbmVkIGludCA6MjQ7CisgICAgdW5z
aWduZWQgaW50IDoyNDsKKyAgICB1bnNpZ25lZCBpbnQgZGVzdF9oaTo4OworfTsKKworc3RhdGlj
IGVudW0geworICAgIGlydGVfYmFzaWMsCisgICAgaXJ0ZV9mdWxsLAorICAgIGlydGVfdW5zZXQs
Cit9IGlydGVfbW9kZSBfX3JlYWRfbW9zdGx5ID0gaXJ0ZV91bnNldDsKKwogdW5pb24gaXJ0ZV9w
dHIgewogICAgIHZvaWQgKnJhdzsKICAgICBzdHJ1Y3QgaXJ0ZV9iYXNpYyAqYmFzaWM7CisgICAg
c3RydWN0IGlydGVfZnVsbCAqZnVsbDsKIH07CiAKLSNkZWZpbmUgSU5UUkVNQVBfVEFCTEVfT1JE
RVIgICAgMQorI2RlZmluZSBJTlRSRU1BUF9UQUJMRV9PUkRFUiAoaXJ0ZV9tb2RlID09IGlydGVf
YmFzaWMgPyAxIDogMykKICNkZWZpbmUgSU5UUkVNQVBfTEVOR1RIIDB4QgogI2RlZmluZSBJTlRS
RU1BUF9FTlRSSUVTICgxIDw8IElOVFJFTUFQX0xFTkdUSCkKIApAQCAtMTI3LDcgKzE0OSwxOSBA
QCBzdGF0aWMgdW5pb24gaXJ0ZV9wdHIgZ2V0X2ludHJlbWFwX2VudHJ5CiAKICAgICBBU1NFUlQo
dGFibGUucmF3ICYmIChvZmZzZXQgPCBJTlRSRU1BUF9FTlRSSUVTKSk7CiAKLSAgICB0YWJsZS5i
YXNpYyArPSBvZmZzZXQ7CisgICAgc3dpdGNoICggaXJ0ZV9tb2RlICkKKyAgICB7CisgICAgY2Fz
ZSBpcnRlX2Jhc2ljOgorICAgICAgICB0YWJsZS5iYXNpYyArPSBvZmZzZXQ7CisgICAgICAgIGJy
ZWFrOworCisgICAgY2FzZSBpcnRlX2Z1bGw6CisgICAgICAgIHRhYmxlLmZ1bGwgKz0gb2Zmc2V0
OworICAgICAgICBicmVhazsKKworICAgIGRlZmF1bHQ6CisgICAgICAgIEFTU0VSVF9VTlJFQUNI
QUJMRSgpOworICAgIH0KIAogICAgIHJldHVybiB0YWJsZTsKIH0KQEAgLTEzNiw3ICsxNzAsMjEg
QEAgc3RhdGljIHZvaWQgZnJlZV9pbnRyZW1hcF9lbnRyeSh1bnNpZ25lZAogewogICAgIHVuaW9u
IGlydGVfcHRyIGVudHJ5ID0gZ2V0X2ludHJlbWFwX2VudHJ5KHNlZywgYmRmLCBvZmZzZXQpOwog
Ci0gICAgKmVudHJ5LmJhc2ljID0gKHN0cnVjdCBpcnRlX2Jhc2ljKXt9OworICAgIHN3aXRjaCAo
IGlydGVfbW9kZSApCisgICAgeworICAgIGNhc2UgaXJ0ZV9iYXNpYzoKKyAgICAgICAgKmVudHJ5
LmJhc2ljID0gKHN0cnVjdCBpcnRlX2Jhc2ljKXt9OworICAgICAgICBicmVhazsKKworICAgIGNh
c2UgaXJ0ZV9mdWxsOgorICAgICAgICBlbnRyeS5mdWxsLT5yZW1hcF9lbiA9IDA7CisgICAgICAg
IHdtYigpOworICAgICAgICAqZW50cnkuZnVsbCA9IChzdHJ1Y3QgaXJ0ZV9mdWxsKXt9OworICAg
ICAgICBicmVhazsKKworICAgIGRlZmF1bHQ6CisgICAgICAgIEFTU0VSVF9VTlJFQUNIQUJMRSgp
OworICAgIH0KIAogICAgIF9fY2xlYXJfYml0KG9mZnNldCwgZ2V0X2l2cnNfbWFwcGluZ3Moc2Vn
KVtiZGZdLmludHJlbWFwX2ludXNlKTsKIH0KQEAgLTE1NCw4ICsyMDIsMzggQEAgc3RhdGljIHZv
aWQgdXBkYXRlX2ludHJlbWFwX2VudHJ5KHVuaW9uCiAgICAgICAgIC5kZXN0ID0gZGVzdCwKICAg
ICAgICAgLnZlY3RvciA9IHZlY3RvciwKICAgICB9OworICAgIHN0cnVjdCBpcnRlX2Z1bGwgZnVs
bCA9IHsKKyAgICAgICAgLnJlbWFwX2VuID0gMSwKKyAgICAgICAgLnN1cF9pb19wZiA9IDAsCisg
ICAgICAgIC5pbnRfdHlwZSA9IGludF90eXBlLAorICAgICAgICAucnFfZW9pID0gMCwKKyAgICAg
ICAgLmRtID0gZGVzdF9tb2RlLAorICAgICAgICAuZGVzdF9sbyA9IGRlc3QsCisgICAgICAgIC5k
ZXN0X2hpID0gZGVzdCA+PiAyNCwKKyAgICAgICAgLnZlY3RvciA9IHZlY3RvciwKKyAgICB9Owor
CisgICAgc3dpdGNoICggaXJ0ZV9tb2RlICkKKyAgICB7CisgICAgICAgIF9fdWludDEyOF90IHJl
dDsKKyAgICAgICAgdW5pb24geworICAgICAgICAgICAgX191aW50MTI4X3QgcmF3OworICAgICAg
ICAgICAgc3RydWN0IGlydGVfZnVsbCBmdWxsOworICAgICAgICB9IG9sZDsKKworICAgIGNhc2Ug
aXJ0ZV9iYXNpYzoKKyAgICAgICAgKmVudHJ5LmJhc2ljID0gYmFzaWM7CisgICAgICAgIGJyZWFr
OworCisgICAgY2FzZSBpcnRlX2Z1bGw6CisgICAgICAgIG9sZC5mdWxsID0gKmVudHJ5LmZ1bGw7
CisgICAgICAgIHJldCA9IGNtcHhjaGcxNmIoZW50cnkuZnVsbCwgJm9sZCwgJmZ1bGwpOworICAg
ICAgICBBU1NFUlQocmV0ID09IG9sZC5yYXcpOworICAgICAgICBicmVhazsKIAotICAgICplbnRy
eS5iYXNpYyA9IGJhc2ljOworICAgIGRlZmF1bHQ6CisgICAgICAgIEFTU0VSVF9VTlJFQUNIQUJM
RSgpOworICAgIH0KIH0KIAogc3RhdGljIGlubGluZSBpbnQgZ2V0X3J0ZV9pbmRleChjb25zdCBz
dHJ1Y3QgSU9fQVBJQ19yb3V0ZV9lbnRyeSAqcnRlKQpAQCAtMTY5LDYgKzI0NywxMSBAQCBzdGF0
aWMgaW5saW5lIHZvaWQgc2V0X3J0ZV9pbmRleChzdHJ1Y3QKICAgICBydGUtPmRlbGl2ZXJ5X21v
ZGUgPSBvZmZzZXQgPj4gODsKIH0KIAorc3RhdGljIGlubGluZSB1bnNpZ25lZCBpbnQgZ2V0X2Z1
bGxfZGVzdChjb25zdCBzdHJ1Y3QgaXJ0ZV9mdWxsICplbnRyeSkKK3sKKyAgICByZXR1cm4gZW50
cnktPmRlc3RfbG8gfCAoZW50cnktPmRlc3RfaGkgPDwgMjQpOworfQorCiBzdGF0aWMgaW50IHVw
ZGF0ZV9pbnRyZW1hcF9lbnRyeV9mcm9tX2lvYXBpYygKICAgICBpbnQgYmRmLAogICAgIHN0cnVj
dCBhbWRfaW9tbXUgKmlvbW11LApAQCAtMTc4LDEwICsyNjEsMTEgQEAgc3RhdGljIGludCB1cGRh
dGVfaW50cmVtYXBfZW50cnlfZnJvbV9pbwogewogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAg
ICAgdW5pb24gaXJ0ZV9wdHIgZW50cnk7Ci0gICAgdTggZGVsaXZlcnlfbW9kZSwgZGVzdCwgdmVj
dG9yLCBkZXN0X21vZGU7CisgICAgdW5zaWduZWQgaW50IGRlbGl2ZXJ5X21vZGUsIGRlc3QsIHZl
Y3RvciwgZGVzdF9tb2RlOwogICAgIGludCByZXFfaWQ7CiAgICAgc3BpbmxvY2tfdCAqbG9jazsK
ICAgICB1bnNpZ25lZCBpbnQgb2Zmc2V0OworICAgIGJvb2wgZnJlc2ggPSBmYWxzZTsKIAogICAg
IHJlcV9pZCA9IGdldF9pbnRyZW1hcF9yZXF1ZXN0b3JfaWQoaW9tbXUtPnNlZywgYmRmKTsKICAg
ICBsb2NrID0gZ2V0X2ludHJlbWFwX2xvY2soaW9tbXUtPnNlZywgcmVxX2lkKTsKQEAgLTE4OSw3
ICsyNzMsNyBAQCBzdGF0aWMgaW50IHVwZGF0ZV9pbnRyZW1hcF9lbnRyeV9mcm9tX2lvCiAgICAg
ZGVsaXZlcnlfbW9kZSA9IHJ0ZS0+ZGVsaXZlcnlfbW9kZTsKICAgICB2ZWN0b3IgPSBydGUtPnZl
Y3RvcjsKICAgICBkZXN0X21vZGUgPSBydGUtPmRlc3RfbW9kZTsKLSAgICBkZXN0ID0gcnRlLT5k
ZXN0LmxvZ2ljYWwubG9naWNhbF9kZXN0OworICAgIGRlc3QgPSB4MmFwaWNfZW5hYmxlZCA/IHJ0
ZS0+ZGVzdC5kZXN0MzIgOiBydGUtPmRlc3QubG9naWNhbC5sb2dpY2FsX2Rlc3Q7CiAKICAgICBz
cGluX2xvY2tfaXJxc2F2ZShsb2NrLCBmbGFncyk7CiAKQEAgLTIwNCwyNSArMjg4LDQwIEBAIHN0
YXRpYyBpbnQgdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zyb21faW8KICAgICAgICAgICAgIHJldHVy
biAtRU5PU1BDOwogICAgICAgICB9CiAgICAgICAgICppbmRleCA9IG9mZnNldDsKLSAgICAgICAg
bG9fdXBkYXRlID0gMTsKKyAgICAgICAgZnJlc2ggPSB0cnVlOwogICAgIH0KIAogICAgIGVudHJ5
ID0gZ2V0X2ludHJlbWFwX2VudHJ5KGlvbW11LT5zZWcsIHJlcV9pZCwgb2Zmc2V0KTsKLSAgICBp
ZiAoICFsb191cGRhdGUgKQorICAgIGlmICggZnJlc2ggKQorICAgICAgICAvKiBub3RoaW5nICov
OworICAgIGVsc2UgaWYgKCAhbG9fdXBkYXRlICkKICAgICB7CiAgICAgICAgIC8qCiAgICAgICAg
ICAqIExvdyBoYWxmIG9mIGluY29taW5nIFJURSBpcyBhbHJlYWR5IGluIHJlbWFwcGVkIGZvcm1h
dCwKICAgICAgICAgICogc28gbmVlZCB0byByZWNvdmVyIHZlY3RvciBhbmQgZGVsaXZlcnkgbW9k
ZSBmcm9tIElSVEUuCiAgICAgICAgICAqLwogICAgICAgICBBU1NFUlQoZ2V0X3J0ZV9pbmRleChy
dGUpID09IG9mZnNldCk7Ci0gICAgICAgIHZlY3RvciA9IGVudHJ5LmJhc2ljLT52ZWN0b3I7Cisg
ICAgICAgIGlmICggaXJ0ZV9tb2RlID09IGlydGVfYmFzaWMgKQorICAgICAgICAgICAgdmVjdG9y
ID0gZW50cnkuYmFzaWMtPnZlY3RvcjsKKyAgICAgICAgZWxzZQorICAgICAgICAgICAgdmVjdG9y
ID0gZW50cnkuZnVsbC0+dmVjdG9yOworICAgICAgICAvKiBUaGUgSW50VHlwZSBmaWVsZHMgbWF0
Y2ggZm9yIGJvdGggZm9ybWF0cy4gKi8KICAgICAgICAgZGVsaXZlcnlfbW9kZSA9IGVudHJ5LmJh
c2ljLT5pbnRfdHlwZTsKICAgICB9CisgICAgZWxzZSBpZiAoIHgyYXBpY19lbmFibGVkICkKKyAg
ICB7CisgICAgICAgIC8qCisgICAgICAgICAqIEhpZ2ggaGFsZiBvZiBpbmNvbWluZyBSVEUgd2Fz
IHJlYWQgZnJvbSB0aGUgSS9PIEFQSUMgYW5kIGhlbmNlIG1heQorICAgICAgICAgKiBub3QgaG9s
ZCB0aGUgZnVsbCBkZXN0aW5hdGlvbiwgc28gbmVlZCB0byByZWNvdmVyIGZ1bGwgZGVzdGluYXRp
b24KKyAgICAgICAgICogZnJvbSBJUlRFLgorICAgICAgICAgKi8KKyAgICAgICAgZGVzdCA9IGdl
dF9mdWxsX2Rlc3QoZW50cnkuZnVsbCk7CisgICAgfQogICAgIHVwZGF0ZV9pbnRyZW1hcF9lbnRy
eShlbnRyeSwgdmVjdG9yLCBkZWxpdmVyeV9tb2RlLCBkZXN0X21vZGUsIGRlc3QpOwogCiAgICAg
c3Bpbl91bmxvY2tfaXJxcmVzdG9yZShsb2NrLCBmbGFncyk7CiAKLSAgICBpZiAoIGlvbW11LT5l
bmFibGVkICkKKyAgICBpZiAoIGlvbW11LT5lbmFibGVkICYmICFmcmVzaCApCiAgICAgewogICAg
ICAgICBzcGluX2xvY2tfaXJxc2F2ZSgmaW9tbXUtPmxvY2ssIGZsYWdzKTsKICAgICAgICAgYW1k
X2lvbW11X2ZsdXNoX2ludHJlbWFwKGlvbW11LCByZXFfaWQpOwpAQCAtMjQ2LDYgKzM0NSwxOSBA
QCBpbnQgX19pbml0IGFtZF9pb21tdV9zZXR1cF9pb2FwaWNfcmVtYXBwCiAgICAgc3BpbmxvY2tf
dCAqbG9jazsKICAgICB1bnNpZ25lZCBpbnQgb2Zmc2V0OwogCisgICAgZm9yX2VhY2hfYW1kX2lv
bW11ICggaW9tbXUgKQorICAgIHsKKyAgICAgICAgaWYgKCBpcnRlX21vZGUgIT0gaXJ0ZV91bnNl
dCApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggaW9tbXUtPmN0cmwuZ2FfZW4gPT0gKGly
dGVfbW9kZSA9PSBpcnRlX2Jhc2ljKSApCisgICAgICAgICAgICAgICAgcmV0dXJuIC1FTlhJTzsK
KyAgICAgICAgfQorICAgICAgICBlbHNlIGlmICggaW9tbXUtPmN0cmwuZ2FfZW4gKQorICAgICAg
ICAgICAgaXJ0ZV9tb2RlID0gaXJ0ZV9mdWxsOworICAgICAgICBlbHNlCisgICAgICAgICAgICBp
cnRlX21vZGUgPSBpcnRlX2Jhc2ljOworICAgIH0KKwogICAgIC8qIFJlYWQgaW9hcGljIGVudHJp
ZXMgYW5kIHVwZGF0ZSBpbnRlcnJ1cHQgcmVtYXBwaW5nIHRhYmxlIGFjY29yZGluZ2x5ICovCiAg
ICAgZm9yICggYXBpYyA9IDA7IGFwaWMgPCBucl9pb2FwaWNzOyBhcGljKysgKQogICAgIHsKQEAg
LTI4MCw2ICszOTIsMTggQEAgaW50IF9faW5pdCBhbWRfaW9tbXVfc2V0dXBfaW9hcGljX3JlbWFw
cAogICAgICAgICAgICAgZGVzdF9tb2RlID0gcnRlLmRlc3RfbW9kZTsKICAgICAgICAgICAgIGRl
c3QgPSBydGUuZGVzdC5sb2dpY2FsLmxvZ2ljYWxfZGVzdDsKIAorICAgICAgICAgICAgaWYgKCBp
b21tdS0+Y3RybC54dF9lbiApCisgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgLyoKKyAg
ICAgICAgICAgICAgICAgKiBJbiB4MkFQSUMgbW9kZSB3ZSBoYXZlIG5vIHdheSBvZiBkaXNjb3Zl
cmluZyB0aGUgaGlnaCAyNAorICAgICAgICAgICAgICAgICAqIGJpdHMgb2YgdGhlIGRlc3RpbmF0
aW9uIG9mIGFuIGFscmVhZHkgZW5hYmxlZCBpbnRlcnJ1cHQuCisgICAgICAgICAgICAgICAgICog
V2UgY29tZSBoZXJlIGVhcmxpZXIgdGhhbiBmb3IgeEFQSUMgbW9kZSwgc28gbm8gaW50ZXJydXB0
cworICAgICAgICAgICAgICAgICAqIHNob3VsZCBoYXZlIGJlZW4gc2V0IHVwIGJlZm9yZS4KKyAg
ICAgICAgICAgICAgICAgKi8KKyAgICAgICAgICAgICAgICBBTURfSU9NTVVfREVCVUcoIlVubWFz
a2VkIElPLUFQSUMjJXUgZW50cnkgJXUgaW4geDJBUElDIG1vZGVcbiIsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIElPX0FQSUNfSUQoYXBpYyksIHBpbik7CisgICAgICAgICAgICB9
CisKICAgICAgICAgICAgIHNwaW5fbG9ja19pcnFzYXZlKGxvY2ssIGZsYWdzKTsKICAgICAgICAg
ICAgIG9mZnNldCA9IGFsbG9jX2ludHJlbWFwX2VudHJ5KHNlZywgcmVxX2lkLCAxKTsKICAgICAg
ICAgICAgIEJVR19PTihvZmZzZXQgPj0gSU5UUkVNQVBfRU5UUklFUyk7CkBAIC0zMTQsNyArNDM4
LDggQEAgdm9pZCBhbWRfaW9tbXVfaW9hcGljX3VwZGF0ZV9pcmUoCiAgICAgc3RydWN0IElPX0FQ
SUNfcm91dGVfZW50cnkgbmV3X3J0ZSA9IHsgMCB9OwogICAgIHVuc2lnbmVkIGludCBydGVfbG8g
PSAocmVnICYgMSkgPyByZWcgLSAxIDogcmVnOwogICAgIHVuc2lnbmVkIGludCBwaW4gPSAocmVn
IC0gMHgxMCkgLyAyOwotICAgIGludCBzYXZlZF9tYXNrLCBzZWcsIGJkZiwgcmM7CisgICAgaW50
IHNlZywgYmRmLCByYzsKKyAgICBib29sIHNhdmVkX21hc2ssIGZyZXNoID0gZmFsc2U7CiAgICAg
c3RydWN0IGFtZF9pb21tdSAqaW9tbXU7CiAgICAgdW5zaWduZWQgaW50IGlkeDsKIApAQCAtMzU2
LDEyICs0ODEsMjIgQEAgdm9pZCBhbWRfaW9tbXVfaW9hcGljX3VwZGF0ZV9pcmUoCiAgICAgICAg
ICooKCh1MzIgKikmbmV3X3J0ZSkgKyAxKSA9IHZhbHVlOwogICAgIH0KIAotICAgIGlmICggbmV3
X3J0ZS5tYXNrICYmCi0gICAgICAgICBpb2FwaWNfc2JkZltpZHhdLnBpbl8yX2lkeFtwaW5dID49
IElOVFJFTUFQX0VOVFJJRVMgKQorICAgIGlmICggaW9hcGljX3NiZGZbaWR4XS5waW5fMl9pZHhb
cGluXSA+PSBJTlRSRU1BUF9FTlRSSUVTICkKICAgICB7CiAgICAgICAgIEFTU0VSVChzYXZlZF9t
YXNrKTsKLSAgICAgICAgX19pb19hcGljX3dyaXRlKGFwaWMsIHJlZywgdmFsdWUpOwotICAgICAg
ICByZXR1cm47CisKKyAgICAgICAgLyoKKyAgICAgICAgICogVGhlcmUncyBub3doZXJlIGV4Y2Vw
dCB0aGUgSVJURSB0byBzdG9yZSBhIGZ1bGwgMzItYml0IGRlc3RpbmF0aW9uLAorICAgICAgICAg
KiBzbyB3ZSBtYXkgbm90IGJ5cGFzcyBlbnRyeSBhbGxvY2F0aW9uIGFuZCB1cGRhdGluZyBvZiB0
aGUgbG93IFJURQorICAgICAgICAgKiBoYWxmIGluIHRoZSAodXN1YWwpIGNhc2Ugb2YgdGhlIGhp
Z2ggUlRFIGhhbGYgZ2V0dGluZyB3cml0dGVuIGZpcnN0LgorICAgICAgICAgKi8KKyAgICAgICAg
aWYgKCBuZXdfcnRlLm1hc2sgJiYgIXgyYXBpY19lbmFibGVkICkKKyAgICAgICAgeworICAgICAg
ICAgICAgX19pb19hcGljX3dyaXRlKGFwaWMsIHJlZywgdmFsdWUpOworICAgICAgICAgICAgcmV0
dXJuOworICAgICAgICB9CisKKyAgICAgICAgZnJlc2ggPSB0cnVlOwogICAgIH0KIAogICAgIC8q
IG1hc2sgdGhlIGludGVycnVwdCB3aGlsZSB3ZSBjaGFuZ2UgdGhlIGludHJlbWFwIHRhYmxlICov
CkBAIC0zOTAsOCArNTI1LDEyIEBAIHZvaWQgYW1kX2lvbW11X2lvYXBpY191cGRhdGVfaXJlKAog
ICAgIGlmICggcmVnID09IHJ0ZV9sbyApCiAgICAgICAgIHJldHVybjsKIAotICAgIC8qIHVubWFz
ayB0aGUgaW50ZXJydXB0IGFmdGVyIHdlIGhhdmUgdXBkYXRlZCB0aGUgaW50cmVtYXAgdGFibGUg
Ki8KLSAgICBpZiAoICFzYXZlZF9tYXNrICkKKyAgICAvKgorICAgICAqIFVubWFzayB0aGUgaW50
ZXJydXB0IGFmdGVyIHdlIGhhdmUgdXBkYXRlZCB0aGUgaW50cmVtYXAgdGFibGUuIEFsc28KKyAg
ICAgKiB3cml0ZSB0aGUgbG93IGhhbGYgaWYgYSBmcmVzaCBlbnRyeSB3YXMgYWxsb2NhdGVkIGZv
ciBhIGhpZ2ggaGFsZgorICAgICAqIHVwZGF0ZSBpbiB4MkFQSUMgbW9kZS4KKyAgICAgKi8KKyAg
ICBpZiAoICFzYXZlZF9tYXNrIHx8ICh4MmFwaWNfZW5hYmxlZCAmJiBmcmVzaCkgKQogICAgIHsK
ICAgICAgICAgb2xkX3J0ZS5tYXNrID0gc2F2ZWRfbWFzazsKICAgICAgICAgX19pb19hcGljX3dy
aXRlKGFwaWMsIHJ0ZV9sbywgKigodTMyICopJm9sZF9ydGUpKTsKQEAgLTQwNSwyNSArNTQ0LDM1
IEBAIHVuc2lnbmVkIGludCBhbWRfaW9tbXVfcmVhZF9pb2FwaWNfZnJvbV8KICAgICB1bnNpZ25l
ZCBpbnQgb2Zmc2V0OwogICAgIHVuc2lnbmVkIGludCB2YWwgPSBfX2lvX2FwaWNfcmVhZChhcGlj
LCByZWcpOwogICAgIHVuc2lnbmVkIGludCBwaW4gPSAocmVnIC0gMHgxMCkgLyAyOworICAgIHVp
bnQxNl90IHNlZywgcmVxX2lkOworICAgIHVuaW9uIGlydGVfcHRyIGVudHJ5OwogCiAgICAgaWR4
ID0gaW9hcGljX2lkX3RvX2luZGV4KElPX0FQSUNfSUQoYXBpYykpOwogICAgIGlmICggaWR4ID09
IE1BWF9JT19BUElDUyApCiAgICAgICAgIHJldHVybiAtRUlOVkFMOwogCiAgICAgb2Zmc2V0ID0g
aW9hcGljX3NiZGZbaWR4XS5waW5fMl9pZHhbcGluXTsKKyAgICBpZiAoIG9mZnNldCA+PSBJTlRS
RU1BUF9FTlRSSUVTICkKKyAgICAgICAgcmV0dXJuIHZhbDsKIAotICAgIGlmICggIShyZWcgJiAx
KSAmJiBvZmZzZXQgPCBJTlRSRU1BUF9FTlRSSUVTICkKKyAgICBzZWcgPSBpb2FwaWNfc2JkZltp
ZHhdLnNlZzsKKyAgICByZXFfaWQgPSBnZXRfaW50cmVtYXBfcmVxdWVzdG9yX2lkKHNlZywgaW9h
cGljX3NiZGZbaWR4XS5iZGYpOworICAgIGVudHJ5ID0gZ2V0X2ludHJlbWFwX2VudHJ5KHNlZywg
cmVxX2lkLCBvZmZzZXQpOworCisgICAgaWYgKCAhKHJlZyAmIDEpICkKICAgICB7Ci0gICAgICAg
IHUxNiBiZGYgPSBpb2FwaWNfc2JkZltpZHhdLmJkZjsKLSAgICAgICAgdTE2IHNlZyA9IGlvYXBp
Y19zYmRmW2lkeF0uc2VnOwotICAgICAgICB1MTYgcmVxX2lkID0gZ2V0X2ludHJlbWFwX3JlcXVl
c3Rvcl9pZChzZWcsIGJkZik7Ci0gICAgICAgIHVuaW9uIGlydGVfcHRyIGVudHJ5ID0gZ2V0X2lu
dHJlbWFwX2VudHJ5KHNlZywgcmVxX2lkLCBvZmZzZXQpOwogCiAgICAgICAgIEFTU0VSVChvZmZz
ZXQgPT0gKHZhbCAmIChJTlRSRU1BUF9FTlRSSUVTIC0gMSkpKTsKICAgICAgICAgdmFsICY9IH4o
SU5UUkVNQVBfRU5UUklFUyAtIDEpOworICAgICAgICAvKiBUaGUgSW50VHlwZSBmaWVsZHMgbWF0
Y2ggZm9yIGJvdGggZm9ybWF0cy4gKi8KICAgICAgICAgdmFsIHw9IE1BU0tfSU5TUihlbnRyeS5i
YXNpYy0+aW50X3R5cGUsIElPX0FQSUNfUkVESVJfREVMSVZfTU9ERV9NQVNLKTsKLSAgICAgICAg
dmFsIHw9IE1BU0tfSU5TUihlbnRyeS5iYXNpYy0+dmVjdG9yLCBJT19BUElDX1JFRElSX1ZFQ1RP
Ul9NQVNLKTsKKyAgICAgICAgaWYgKCBpcnRlX21vZGUgPT0gaXJ0ZV9iYXNpYyApCisgICAgICAg
ICAgICB2YWwgfD0gTUFTS19JTlNSKGVudHJ5LmJhc2ljLT52ZWN0b3IsIElPX0FQSUNfUkVESVJf
VkVDVE9SX01BU0spOworICAgICAgICBlbHNlCisgICAgICAgICAgICB2YWwgfD0gTUFTS19JTlNS
KGVudHJ5LmZ1bGwtPnZlY3RvciwgSU9fQVBJQ19SRURJUl9WRUNUT1JfTUFTSyk7CiAgICAgfQor
ICAgIGVsc2UgaWYgKCB4MmFwaWNfZW5hYmxlZCApCisgICAgICAgIHZhbCA9IGdldF9mdWxsX2Rl
c3QoZW50cnkuZnVsbCk7CiAKICAgICByZXR1cm4gdmFsOwogfQpAQCAtNDM1LDkgKzU4NCw5IEBA
IHN0YXRpYyBpbnQgdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zyb21fbXMKICAgICB1bnNpZ25lZCBs
b25nIGZsYWdzOwogICAgIHVuaW9uIGlydGVfcHRyIGVudHJ5OwogICAgIHUxNiByZXFfaWQsIGFs
aWFzX2lkOwotICAgIHU4IGRlbGl2ZXJ5X21vZGUsIGRlc3QsIHZlY3RvciwgZGVzdF9tb2RlOwor
ICAgIHVpbnQ4X3QgZGVsaXZlcnlfbW9kZSwgdmVjdG9yLCBkZXN0X21vZGU7CiAgICAgc3Bpbmxv
Y2tfdCAqbG9jazsKLSAgICB1bnNpZ25lZCBpbnQgb2Zmc2V0LCBpOworICAgIHVuc2lnbmVkIGlu
dCBkZXN0LCBvZmZzZXQsIGk7CiAKICAgICByZXFfaWQgPSBnZXRfZG1hX3JlcXVlc3Rvcl9pZChp
b21tdS0+c2VnLCBiZGYpOwogICAgIGFsaWFzX2lkID0gZ2V0X2ludHJlbWFwX3JlcXVlc3Rvcl9p
ZChpb21tdS0+c2VnLCBiZGYpOwpAQCAtNDU4LDcgKzYwNywxMiBAQCBzdGF0aWMgaW50IHVwZGF0
ZV9pbnRyZW1hcF9lbnRyeV9mcm9tX21zCiAgICAgZGVzdF9tb2RlID0gKG1zZy0+YWRkcmVzc19s
byA+PiBNU0lfQUREUl9ERVNUTU9ERV9TSElGVCkgJiAweDE7CiAgICAgZGVsaXZlcnlfbW9kZSA9
IChtc2ctPmRhdGEgPj4gTVNJX0RBVEFfREVMSVZFUllfTU9ERV9TSElGVCkgJiAweDE7CiAgICAg
dmVjdG9yID0gKG1zZy0+ZGF0YSA+PiBNU0lfREFUQV9WRUNUT1JfU0hJRlQpICYgTVNJX0RBVEFf
VkVDVE9SX01BU0s7Ci0gICAgZGVzdCA9IChtc2ctPmFkZHJlc3NfbG8gPj4gTVNJX0FERFJfREVT
VF9JRF9TSElGVCkgJiAweGZmOworCisgICAgaWYgKCB4MmFwaWNfZW5hYmxlZCApCisgICAgICAg
IGRlc3QgPSBtc2ctPmRlc3QzMjsKKyAgICBlbHNlCisgICAgICAgIGRlc3QgPSBNQVNLX0VYVFIo
bXNnLT5hZGRyZXNzX2xvLCBNU0lfQUREUl9ERVNUX0lEX01BU0spOworCiAgICAgb2Zmc2V0ID0g
KnJlbWFwX2luZGV4OwogICAgIGlmICggb2Zmc2V0ID49IElOVFJFTUFQX0VOVFJJRVMgKQogICAg
IHsKQEAgLTYwMyw4ICs3NTcsMTggQEAgdm9pZCBhbWRfaW9tbXVfcmVhZF9tc2lfZnJvbV9pcmUo
CiAgICAgfQogCiAgICAgbXNnLT5kYXRhICY9IH4oSU5UUkVNQVBfRU5UUklFUyAtIDEpOworICAg
IC8qIFRoZSBJbnRUeXBlIGZpZWxkcyBtYXRjaCBmb3IgYm90aCBmb3JtYXRzLiAqLwogICAgIG1z
Zy0+ZGF0YSB8PSBNQVNLX0lOU1IoZW50cnkuYmFzaWMtPmludF90eXBlLCBNU0lfREFUQV9ERUxJ
VkVSWV9NT0RFX01BU0spOwotICAgIG1zZy0+ZGF0YSB8PSBNQVNLX0lOU1IoZW50cnkuYmFzaWMt
PnZlY3RvciwgTVNJX0RBVEFfVkVDVE9SX01BU0spOworICAgIGlmICggaXJ0ZV9tb2RlID09IGly
dGVfYmFzaWMgKQorICAgIHsKKyAgICAgICAgbXNnLT5kYXRhIHw9IE1BU0tfSU5TUihlbnRyeS5i
YXNpYy0+dmVjdG9yLCBNU0lfREFUQV9WRUNUT1JfTUFTSyk7CisgICAgICAgIG1zZy0+ZGVzdDMy
ID0gZW50cnkuYmFzaWMtPmRlc3Q7CisgICAgfQorICAgIGVsc2UKKyAgICB7CisgICAgICAgIG1z
Zy0+ZGF0YSB8PSBNQVNLX0lOU1IoZW50cnkuZnVsbC0+dmVjdG9yLCBNU0lfREFUQV9WRUNUT1Jf
TUFTSyk7CisgICAgICAgIG1zZy0+ZGVzdDMyID0gZ2V0X2Z1bGxfZGVzdChlbnRyeS5mdWxsKTsK
KyAgICB9CiB9CiAKIGludCBfX2luaXQgYW1kX2lvbW11X2ZyZWVfaW50cmVtYXBfdGFibGUoCkBA
IC02NjcsMTggKzgzMSwzMyBAQCBpbnQgX19pbml0IGFtZF9zZXR1cF9ocGV0X21zaShzdHJ1Y3Qg
bXNpCiAgICAgcmV0dXJuIHJjOwogfQogCi1zdGF0aWMgdm9pZCBkdW1wX2ludHJlbWFwX3RhYmxl
KGNvbnN0IHUzMiAqdGFibGUpCitzdGF0aWMgdm9pZCBkdW1wX2ludHJlbWFwX3RhYmxlKGNvbnN0
IHZvaWQgKnRhYmxlKQogewotICAgIHUzMiBjb3VudDsKKyAgICB1bnNpZ25lZCBpbnQgY291bnQ7
CisgICAgdW5pb24geworICAgICAgICBjb25zdCB2b2lkICpyYXc7CisgICAgICAgIGNvbnN0IHVp
bnQzMl90ICpiYXNpYzsKKyAgICAgICAgY29uc3QgdWludDY0X3QgKCpmdWxsKVsyXTsKKyAgICB9
IHRibCA9IHsgLnJhdyA9IHRhYmxlIH07CiAKLSAgICBpZiAoICF0YWJsZSApCisgICAgaWYgKCAh
dGFibGUgfHwgaXJ0ZV9tb2RlID09IGlydGVfdW5zZXQgKQogICAgICAgICByZXR1cm47CiAKICAg
ICBmb3IgKCBjb3VudCA9IDA7IGNvdW50IDwgSU5UUkVNQVBfRU5UUklFUzsgY291bnQrKyApCiAg
ICAgewotICAgICAgICBpZiAoICF0YWJsZVtjb3VudF0gKQotICAgICAgICAgICAgY29udGludWU7
Ci0gICAgICAgIHByaW50aygiICAgIElSVEVbJTAzeF0gJTA4eFxuIiwgY291bnQsIHRhYmxlW2Nv
dW50XSk7CisgICAgICAgIGlmICggaXJ0ZV9tb2RlID09IGlydGVfYmFzaWMgKQorICAgICAgICB7
CisgICAgICAgICAgICBpZiAoICF0YmwuYmFzaWNbY291bnRdICkKKyAgICAgICAgICAgICAgICBj
b250aW51ZTsKKyAgICAgICAgICAgIHByaW50aygiICAgIElSVEVbJTAzeF0gJTA4eFxuIiwgY291
bnQsIHRibC5iYXNpY1tjb3VudF0pOworICAgICAgICB9CisgICAgICAgIGVsc2UKKyAgICAgICAg
eworICAgICAgICAgICAgaWYgKCAhdGJsLmZ1bGxbY291bnRdWzBdICYmICF0YmwuZnVsbFtjb3Vu
dF1bMV0gKQorICAgICAgICAgICAgICAgIGNvbnRpbnVlOworICAgICAgICAgICAgcHJpbnRrKCIg
ICAgSVJURVslMDN4XSAlMDE2bHhfJTAxNmx4XG4iLAorICAgICAgICAgICAgICAgICAgIGNvdW50
LCB0YmwuZnVsbFtjb3VudF1bMV0sIHRibC5mdWxsW2NvdW50XVswXSk7CisgICAgICAgIH0KICAg
ICB9CiB9CiAKCgoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3Jn
Cmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id B6F4012AED
	for <lists+xen-devel@lfdr.de>; Fri,  3 May 2019 11:46:54 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hMUid-0005D9-2X; Fri, 03 May 2019 09:43:03 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=P1b8=TD=aepfle.de=olaf@srs-us1.protection.inumbo.net>)
 id 1hMUib-0005D4-GY
 for xen-devel@lists.xenproject.org; Fri, 03 May 2019 09:43:02 +0000
X-Inumbo-ID: d5b89135-6d87-11e9-843c-bc764e045a96
Received: from mo6-p00-ob.smtp.rzone.de (unknown [2a01:238:20a:202:5300::1])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id d5b89135-6d87-11e9-843c-bc764e045a96;
 Fri, 03 May 2019 09:42:59 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; t=1556876578;
 s=strato-dkim-0002; d=aepfle.de;
 h=Message-Id:Date:Subject:Cc:To:From:X-RZG-CLASS-ID:X-RZG-AUTH:From:
 Subject:Sender;
 bh=1M8QQwYlbAS98NHPSa/rcSf9CBZR4+BO2CLavvWsx9I=;
 b=JmBDhLcpl02cjJXo151NkeWBEyOLytpg0dAF0t8VNXX+ReJHbT6XWNAVBcehqF+Hnm
 FYXGpy0dCMTDbgOnxnhj/mydhzaKY3UsDyfcypR9HT4gJyqlXAsXXk3jT5vqF8oDW3Ex
 KovgpFRR2zjEGqgm7GPK6sTl2UKsY0+IwzkIaZ7saJ+oX06fQiFNnYw6CgxZrMH2W9vX
 GPzbi7Ra643O6ICkvPD3h6XFGmPPPXKJMt0IueORvhqpCT9UbWRM1d8/8Qp3O2AMGHnt
 Ycgsq8OpO9EP+5XDV7Hj3MSSQO4dZOWIVIL9EyFNZbvn5dbL0G8AOKDj6BtDQArxYSKM
 xX7A==
X-RZG-AUTH: ":P2EQZWCpfu+qG7CngxMFH1J+3q8wa/QXkBR9MXjAuzBd/ORjA5Q4DFnYbn87Gg=="
X-RZG-CLASS-ID: mo00
Received: from sender by smtp.strato.de (RZmta 44.18 DYNA|AUTH)
 with ESMTPSA id 60a847v439grKEU
 (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (curve secp521r1 with
 521 ECDH bits, eq. 15360 bits RSA))
 (Client did not present a certificate);
 Fri, 3 May 2019 11:42:53 +0200 (CEST)
From: Olaf Hering <olaf@aepfle.de>
To: xen-devel@lists.xenproject.org
Date: Fri,  3 May 2019 11:42:51 +0200
Message-Id: <20190503094251.16148-1-olaf@aepfle.de>
X-Mailer: git-send-email 2.16.4
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2] libxl: fix migration of PV and PVH domUs
 with and without qemu
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>, Wei Liu <wei.liu2@citrix.com>,
 Olaf Hering <olaf@aepfle.de>, Ian Jackson <ian.jackson@eu.citrix.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SWYgYSBkb21VIGhhcyBhIHFlbXUteGVuIGluc3RhbmNlIGF0dGFjaGVkLCBpdCBpcyByZXF1aXJl
ZCB0byBjYWxsIHFlbXVzCiJ4ZW4tc2F2ZS1kZXZpY2VzLXN0YXRlIiBtZXRob2QuIFdpdGhvdXQg
aXQsIHRoZSByZWNlaXZpbmcgc2lkZSBvZiBhIFBWIG9yClBWSCBtaWdyYXRpb24gbWF5IGJlIHVu
YWJsZSB0byBsb2NrIHRoZSBpbWFnZToKCnhlbiBiZTogcWRpc2stNTE3MTI6IHhlbiBiZTogcWRp
c2stNTE3MTI6IGVycm9yOiBGYWlsZWQgdG8gZ2V0ICJ3cml0ZSIgbG9jawplcnJvcjogRmFpbGVk
IHRvIGdldCAid3JpdGUiIGxvY2sKeGVuIGJlOiBxZGlzay01MTcxMjogeGVuIGJlOiBxZGlzay01
MTcxMjogaW5pdGlhbGlzZSgpIGZhaWxlZAppbml0aWFsaXNlKCkgZmFpbGVkCgpUbyBmaXggdGhp
cyBidWcsIGxpYnhsX19kb21haW5fc3VzcGVuZF9kZXZpY2VfbW9kZWwoKSBhbmQKbGlieGxfX2Rv
bWFpbl9yZXN1bWVfZGV2aWNlX21vZGVsKCkgaGF2ZSB0byBiZSBjYWxsZWQgbm90IG9ubHkgZm9y
IEhWTSwKYnV0IGFsc28gaWYgdGhlIGFjdGl2ZSBkZXZpY2VfbW9kZWwgaXMgUUVNVV9YRU4uCgpV
bmZvcnR1bmF0ZWx5LCBsaWJ4bF9fZG9tYWluX2J1aWxkX2luZm9fc2V0ZGVmYXVsdCgpIGhhcmRj
b2RlcwpiX2luZm8tPmRldmljZV9tb2RlbF92ZXJzaW9uIHRvIFFFTVVfWEVOIGlmIGl0IGRvZXMg
bm90IGtub3cgaXQgYW55CmJldHRlci4gVGhpcyBicmVha3MgZG9tVXMgd2l0aG91dCBhIGRldmlj
ZV9tb2RlbC4gbGlieGxfX3FtcF9zdG9wKCkgd291bGQKd2FpdCAxMCBzZWNvbmRzIGluIHFtcF9v
cGVuKCkgZm9yIGEgcWVtdSB0aGF0IHdpbGwgbmV2ZXIgYXBwZWFyLiAgRHVyaW5nCnRoaXMgbG9u
ZyB0aW1lZnJhbWUgdGhlIGRvbVUgcmVtYWlucyBpbiBzdGF0ZSBwYXVzZWQgb24gdGhlIHNlbmRp
bmcgc2lkZS4KQXMgYSByZXN1bHQgbmV0d29yayBjb25uZWN0aW9ucyBtYXkgYmUgZHJvcHBlZC4g
T25jZSB0aGlzIGJ1ZyBpcyBmaXhlZCBhcwp3ZWxsLCBieSBqdXN0IHJlbW92aW5nIHRoYXQgYXNz
dW1wdGlvbiwgdGhlcmUgaXMgbm8gY29kZSB0byBhY3R1YWxseQppbml0aWFsaXNlIGJfaW5mby0+
ZGV2aWNlX21vZGVsX3ZlcnNpb24uCgpUaGVyZSBpcyBhIGhlbHBlciBmdW5jdGlvbiBsaWJ4bF9f
bmVlZF94ZW5wdl9xZW11KCksIHdoaWNoIGlzIHVzZWQgaW4KdmFyaW91cyBwbGFjZXMgdG8gZGVj
aWRlIGlmIGFueSBkZXZpY2VfbW9kZWwgaGFzIHRvIGJlIHNwYXduZWQuIFRoaXMKZnVuY3Rpb24g
Y2FuIG5vdCBiZSB1c2VkIGFzIGlzLCBqdXN0IHRvIGZpbGwgYl9pbmZvLT5kZXZpY2VfbW9kZWxf
dmVyc2lvbiwKYmVjYXVzZSBzdG9yZV9saWJ4bF9lbnRyeSgpIHdhcyBhbHJlYWR5IGNhbGxlZCBl
YXJsaWVyLiBVcGRhdGUgdGhpcwpmdW5jdGlvbiB0byByZWNlaXZlIGEgZG9taWQgdG8gd29yayB3
aXRoLCBpbnN0ZWFkIG9mIHJlYWRpbmcgeGVuc3RvcmUuCgpSZWFycmFuZ2UgdGhlIGNvZGUgYW5k
IGluaXRpYWxpemUgYl9pbmZvLT5kZXZpY2VfbW9kZWxfdmVyc2lvbiBpbgpsaWJ4bF9fZG9tYWlu
X2J1aWxkX2luZm9fc2V0ZGVmYXVsdCgpIHBlciBET01BSU5fVFlQRS4KClVwZGF0ZSBpbml0aWF0
ZV9kb21haW5fY3JlYXRlKCkgdG8gc2V0IGJfaW5mby0+ZGV2aWNlX21vZGVsX3ZlcnNpb24gaWYg
aXQKd2FzIG5vdCBzZXQgZWFybGllciwgdXNpbmcgdGhlIHVwZGF0ZWQgbGlieGxfX25lZWRfeGVu
cHZfcWVtdSgpLgoKSW50cm9kdWNlIExJQlhMX0RFVklDRV9NT0RFTF9WRVJTSU9OX05PTkVfUkVR
VUlSRUQgZm9yIFBWIGFuZCBQVkggdGhhdApoYXZlIG5vIG5lZWQgZm9yIGEgZGV2aWNlX21vZGVs
LgoKVXBkYXRlIGV4aXN0aW5nIHVzZXJzIG9mIGxpYnhsX19uZWVkX3hlbnB2X3FlbXUoKSB0byB1
c2UKYl9pbmZvLT5kZXZpY2VfbW9kZWxfdmVyc2lvbiBmb3IgdGhlaXIgY2hlY2sgaWYgYSBkZXZp
Y2VfbW9kZWwgaXMgbmVlZGVkLgoKdjAyOgotIHVwZGF0ZSB3b3JkaW5nIGluIGEgY29tbWVudAot
IHJlbW92ZSBzdGFsZSBnb3RvIGluIGRvbWNyZWF0ZV9sYXVuY2hfZG0KLSBpbml0aWFsaXplIHJl
dCBpbiBsaWJ4bF9fbmVlZF94ZW5wdl9xZW11CgpTaWduZWQtb2ZmLWJ5OiBPbGFmIEhlcmluZyA8
b2xhZkBhZXBmbGUuZGU+CkNjOiBSb2dlciBQYXUgTW9ubsOpIDxyb2dlci5wYXVAY2l0cml4LmNv
bT4KQ2M6IEFudGhvbnkgUEVSQVJEIDxhbnRob255LnBlcmFyZEBjaXRyaXguY29tPgotLS0KIHRv
b2xzL2xpYnhsL2xpYnhsX2NyZWF0ZS5jICAgICAgfCAzOSArKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrLS0tLS0tLS0KIHRvb2xzL2xpYnhsL2xpYnhsX2RtLmMgICAgICAgICAgfCA0MCAr
KysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tCiB0b29scy9saWJ4bC9saWJ4
bF9kb21fc3VzcGVuZC5jIHwgIDggKysrKysrLS0KIHRvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFs
LmggICAgfCAgMyArKy0KIHRvb2xzL2xpYnhsL2xpYnhsX3R5cGVzLmlkbCAgICAgfCAgMSArCiA1
IGZpbGVzIGNoYW5nZWQsIDYzIGluc2VydGlvbnMoKyksIDI4IGRlbGV0aW9ucygtKQoKZGlmZiAt
LWdpdCBhL3Rvb2xzL2xpYnhsL2xpYnhsX2NyZWF0ZS5jIGIvdG9vbHMvbGlieGwvbGlieGxfY3Jl
YXRlLmMKaW5kZXggODlmZTgwZmM5Yy4uMTUwYWIwMjM1NCAxMDA2NDQKLS0tIGEvdG9vbHMvbGli
eGwvbGlieGxfY3JlYXRlLmMKKysrIGIvdG9vbHMvbGlieGwvbGlieGxfY3JlYXRlLmMKQEAgLTg3
LDE2ICs4NywyMCBAQCBpbnQgbGlieGxfX2RvbWFpbl9idWlsZF9pbmZvX3NldGRlZmF1bHQobGli
eGxfX2djICpnYywKICAgICAgICAgYl9pbmZvLT5kZXZpY2VfbW9kZWxfc3NpZHJlZiA9IFNFQ0lO
SVRTSURfRE9NRE07CiAKICAgICBpZiAoIWJfaW5mby0+ZGV2aWNlX21vZGVsX3ZlcnNpb24pIHsK
LSAgICAgICAgaWYgKGJfaW5mby0+dHlwZSA9PSBMSUJYTF9ET01BSU5fVFlQRV9IVk0pIHsKKyAg
ICAgICAgc3dpdGNoIChiX2luZm8tPnR5cGUpIHsKKyAgICAgICAgY2FzZSBMSUJYTF9ET01BSU5f
VFlQRV9IVk06CiAgICAgICAgICAgICBpZiAobGlieGxfZGVmYm9vbF92YWwoYl9pbmZvLT5kZXZp
Y2VfbW9kZWxfc3R1YmRvbWFpbikpIHsKICAgICAgICAgICAgICAgICBiX2luZm8tPmRldmljZV9t
b2RlbF92ZXJzaW9uID0KICAgICAgICAgICAgICAgICAgICAgTElCWExfREVWSUNFX01PREVMX1ZF
UlNJT05fUUVNVV9YRU5fVFJBRElUSU9OQUw7CiAgICAgICAgICAgICB9IGVsc2UgewogICAgICAg
ICAgICAgICAgIGJfaW5mby0+ZGV2aWNlX21vZGVsX3ZlcnNpb24gPSBsaWJ4bF9fZGVmYXVsdF9k
ZXZpY2VfbW9kZWwoZ2MpOwogICAgICAgICAgICAgfQotICAgICAgICB9IGVsc2UgewotICAgICAg
ICAgICAgYl9pbmZvLT5kZXZpY2VfbW9kZWxfdmVyc2lvbiA9Ci0gICAgICAgICAgICAgICAgTElC
WExfREVWSUNFX01PREVMX1ZFUlNJT05fUUVNVV9YRU47CisgICAgICAgICAgICBicmVhazsKKyAg
ICAgICAgY2FzZSBMSUJYTF9ET01BSU5fVFlQRV9QVjoKKyAgICAgICAgY2FzZSBMSUJYTF9ET01B
SU5fVFlQRV9QVkg6CisgICAgICAgIGRlZmF1bHQ6CisgICAgICAgICAgICAvKiBtYXkgYmUgc2V0
IGxhdGVyICovCisgICAgICAgICAgICBicmVhazsKICAgICAgICAgfQogICAgICAgICBpZiAoYl9p
bmZvLT5kZXZpY2VfbW9kZWxfdmVyc2lvbgogICAgICAgICAgICAgICAgID09IExJQlhMX0RFVklD
RV9NT0RFTF9WRVJTSU9OX1FFTVVfWEVOKSB7CkBAIC05NzgsNiArOTgyLDE3IEBAIHN0YXRpYyB2
b2lkIGluaXRpYXRlX2RvbWFpbl9jcmVhdGUobGlieGxfX2VnYyAqZWdjLAogICAgICAgICBnb3Rv
IGVycm9yX291dDsKICAgICB9CiAKKyAgICBpZiAoZF9jb25maWctPmJfaW5mby5kZXZpY2VfbW9k
ZWxfdmVyc2lvbgorICAgICAgICA9PSBMSUJYTF9ERVZJQ0VfTU9ERUxfVkVSU0lPTl9VTktOT1dO
KSB7CisgICAgICAgIHJldCA9IGxpYnhsX19uZWVkX3hlbnB2X3FlbXUoZ2MsIGRfY29uZmlnLCBk
b21pZCk7CisgICAgICAgIGlmIChyZXQpCisgICAgICAgICAgICBkX2NvbmZpZy0+Yl9pbmZvLmRl
dmljZV9tb2RlbF92ZXJzaW9uID0KKyAgICAgICAgICAgICAgICBMSUJYTF9ERVZJQ0VfTU9ERUxf
VkVSU0lPTl9RRU1VX1hFTjsKKyAgICAgICAgZWxzZQorICAgICAgICAgICAgZF9jb25maWctPmJf
aW5mby5kZXZpY2VfbW9kZWxfdmVyc2lvbiA9CisgICAgICAgICAgICAgICAgTElCWExfREVWSUNF
X01PREVMX1ZFUlNJT05fTk9ORV9SRVFVSVJFRDsKKyAgICB9CisKICAgICBkY3MtPmd1ZXN0X2Rv
bWlkID0gZG9taWQ7CiAgICAgZGNzLT5zZHNzLmRtLmd1ZXN0X2RvbWlkID0gMDsgLyogbWVhbnMg
d2UgaGF2ZW4ndCBzcGF3bmVkICovCiAKQEAgLTEzMTIsNiArMTMyNyw3IEBAIHN0YXRpYyB2b2lk
IGRvbWNyZWF0ZV9sYXVuY2hfZG0obGlieGxfX2VnYyAqZWdjLCBsaWJ4bF9fbXVsdGlkZXYgKm11
bHRpZGV2LAogICAgIGxpYnhsX19kb21haW5fY3JlYXRlX3N0YXRlICpkY3MgPSBDT05UQUlORVJf
T0YobXVsdGlkZXYsICpkY3MsIG11bHRpZGV2KTsKICAgICBTVEFURV9BT19HQyhkY3MtPmFvKTsK
ICAgICBpbnQgaTsKKyAgICBib29sIG5lZWRfcWVtdTsKIAogICAgIC8qIGNvbnZlbmllbmNlIGFs
aWFzZXMgKi8KICAgICBjb25zdCB1aW50MzJfdCBkb21pZCA9IGRjcy0+Z3Vlc3RfZG9taWQ7CkBA
IC0xNDY0LDEwICsxNDgwLDE3IEBAIHN0YXRpYyB2b2lkIGRvbWNyZWF0ZV9sYXVuY2hfZG0obGli
eGxfX2VnYyAqZWdjLCBsaWJ4bF9fbXVsdGlkZXYgKm11bHRpZGV2LAogICAgICAgICBsaWJ4bF9f
ZGV2aWNlX2NvbnNvbGVfYWRkKGdjLCBkb21pZCwgJmNvbnNvbGUsIHN0YXRlLCAmZGV2aWNlKTsK
ICAgICAgICAgbGlieGxfX2RldmljZV9jb25zb2xlX2Rpc3Bvc2UoJmNvbnNvbGUpOwogCi0gICAg
ICAgIHJldCA9IGxpYnhsX19uZWVkX3hlbnB2X3FlbXUoZ2MsIGRfY29uZmlnKTsKLSAgICAgICAg
aWYgKHJldCA8IDApCi0gICAgICAgICAgICBnb3RvIGVycm9yX291dDsKLSAgICAgICAgaWYgKHJl
dCkgeworICAgICAgICBzd2l0Y2ggKGRfY29uZmlnLT5iX2luZm8uZGV2aWNlX21vZGVsX3ZlcnNp
b24pIHsKKyAgICAgICAgICAgIGNhc2UgTElCWExfREVWSUNFX01PREVMX1ZFUlNJT05fUUVNVV9Y
RU5fVFJBRElUSU9OQUw6CisgICAgICAgICAgICBjYXNlIExJQlhMX0RFVklDRV9NT0RFTF9WRVJT
SU9OX1FFTVVfWEVOOgorICAgICAgICAgICAgICAgIG5lZWRfcWVtdSA9IHRydWU7CisgICAgICAg
ICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICBkZWZhdWx0OgorICAgICAgICAgICAgICAgIG5l
ZWRfcWVtdSA9IGZhbHNlOworICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICB9CisKKyAg
ICAgICAgaWYgKG5lZWRfcWVtdSkgewogICAgICAgICAgICAgZGNzLT5zZHNzLmRtLmd1ZXN0X2Rv
bWlkID0gZG9taWQ7CiAgICAgICAgICAgICBsaWJ4bF9fc3Bhd25fbG9jYWxfZG0oZWdjLCAmZGNz
LT5zZHNzLmRtKTsKICAgICAgICAgICAgIHJldHVybjsKZGlmZiAtLWdpdCBhL3Rvb2xzL2xpYnhs
L2xpYnhsX2RtLmMgYi90b29scy9saWJ4bC9saWJ4bF9kbS5jCmluZGV4IDJmMTk3ODZiZGQuLmJh
YjA0YWIxOTYgMTAwNjQ0Ci0tLSBhL3Rvb2xzL2xpYnhsL2xpYnhsX2RtLmMKKysrIGIvdG9vbHMv
bGlieGwvbGlieGxfZG0uYwpAQCAtMjI2OCw3ICsyMjY4LDcgQEAgc3RhdGljIHZvaWQgc3Bhd25f
c3R1Yl9sYXVuY2hfZG0obGlieGxfX2VnYyAqZWdjLAogICAgIGxpYnhsX19kb21haW5fYnVpbGRf
c3RhdGUgKmNvbnN0IGRfc3RhdGUgPSBzZHNzLT5kbS5idWlsZF9zdGF0ZTsKICAgICBsaWJ4bF9f
ZG9tYWluX2J1aWxkX3N0YXRlICpjb25zdCBzdHViZG9tX3N0YXRlID0gJnNkc3MtPmRtX3N0YXRl
OwogICAgIHVpbnQzMl90IGRtX2RvbWlkID0gc2Rzcy0+cHZxZW11Lmd1ZXN0X2RvbWlkOwotICAg
IGludCBuZWVkX3FlbXU7CisgICAgYm9vbCBuZWVkX3FlbXU7CiAKICAgICBpZiAocmV0KSB7CiAg
ICAgICAgIExPR0QoRVJST1IsIGd1ZXN0X2RvbWlkLCAiZXJyb3IgY29ubmVjdGluZyBkaXNrIGRl
dmljZXMiKTsKQEAgLTIzMzcsNyArMjMzNywxNSBAQCBzdGF0aWMgdm9pZCBzcGF3bl9zdHViX2xh
dW5jaF9kbShsaWJ4bF9fZWdjICplZ2MsCiAgICAgICAgIH0KICAgICB9CiAKLSAgICBuZWVkX3Fl
bXUgPSBsaWJ4bF9fbmVlZF94ZW5wdl9xZW11KGdjLCBkbV9jb25maWcpOworICAgIHN3aXRjaCAo
ZG1fY29uZmlnLT5iX2luZm8uZGV2aWNlX21vZGVsX3ZlcnNpb24pIHsKKyAgICAgICAgY2FzZSBM
SUJYTF9ERVZJQ0VfTU9ERUxfVkVSU0lPTl9RRU1VX1hFTl9UUkFESVRJT05BTDoKKyAgICAgICAg
Y2FzZSBMSUJYTF9ERVZJQ0VfTU9ERUxfVkVSU0lPTl9RRU1VX1hFTjoKKyAgICAgICAgICAgIG5l
ZWRfcWVtdSA9IHRydWU7CisgICAgICAgICAgICBicmVhazsKKyAgICAgICAgZGVmYXVsdDoKKyAg
ICAgICAgICAgIG5lZWRfcWVtdSA9IGZhbHNlOworICAgICAgICAgICAgYnJlYWs7CisgICAgfQog
CiAgICAgZm9yIChpID0gMDsgaSA8IG51bV9jb25zb2xlOyBpKyspIHsKICAgICAgICAgbGlieGxf
X2RldmljZSBkZXZpY2U7CkBAIC0zMTc1LDE4ICszMTgzLDExIEBAIHN0YXRpYyB2b2lkIGtpbGxf
ZGV2aWNlX21vZGVsX3VpZF9jYihsaWJ4bF9fZWdjICplZ2MsCiB9CiAKIC8qIFJldHVybiAwIGlm
IG5vIGRtIG5lZWRlZCwgMSBpZiBuZWVkZWQgYW5kIDwwIGlmIGVycm9yLiAqLwotaW50IGxpYnhs
X19uZWVkX3hlbnB2X3FlbXUobGlieGxfX2djICpnYywgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9j
b25maWcpCitpbnQgbGlieGxfX25lZWRfeGVucHZfcWVtdShsaWJ4bF9fZ2MgKmdjLCBsaWJ4bF9k
b21haW5fY29uZmlnICpkX2NvbmZpZywgdWludDMyX3QgZG9taWQpCiB7Ci0gICAgaW50IGlkeCwg
aSwgcmV0LCBudW07Ci0gICAgdWludDMyX3QgZG9taWQ7CisgICAgaW50IGlkeCwgaSwgcmV0ID0g
MCwgbnVtOwogICAgIGNvbnN0IHN0cnVjdCBsaWJ4bF9kZXZpY2VfdHlwZSAqZHQ7CiAKLSAgICBy
ZXQgPSBsaWJ4bF9fZ2V0X2RvbWlkKGdjLCAmZG9taWQpOwotICAgIGlmIChyZXQpIHsKLSAgICAg
ICAgTE9HKEVSUk9SLCAidW5hYmxlIHRvIGdldCBkb21haW4gaWQiKTsKLSAgICAgICAgZ290byBv
dXQ7Ci0gICAgfQotCiAgICAgaWYgKGRfY29uZmlnLT5udW1fdmZicyA+IDAgfHwgZF9jb25maWct
Pm51bV9wOXMgPiAwKSB7CiAgICAgICAgIHJldCA9IDE7CiAgICAgICAgIGdvdG8gb3V0OwpAQCAt
MzIzOCwyMSArMzIzOSwyNiBAQCBpbnQgbGlieGxfX2RtX2NoZWNrX3N0YXJ0KGxpYnhsX19nYyAq
Z2MsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogICAgICAgICAgICAgICAgICAgICAg
ICAgICB1aW50MzJfdCBkb21pZCkKIHsKICAgICBpbnQgcmM7CisgICAgYm9vbCBuZWVkX3FlbXU7
CiAKICAgICBpZiAobGlieGxfX2RtX2FjdGl2ZShnYywgZG9taWQpKQogICAgICAgICByZXR1cm4g
MDsKIAotICAgIHJjID0gbGlieGxfX25lZWRfeGVucHZfcWVtdShnYywgZF9jb25maWcpOwotICAg
IGlmIChyYyA8IDApCi0gICAgICAgIGdvdG8gb3V0OwotCi0gICAgaWYgKCFyYykKKyAgICBzd2l0
Y2ggKGRfY29uZmlnLT5iX2luZm8uZGV2aWNlX21vZGVsX3ZlcnNpb24pIHsKKyAgICAgICAgY2Fz
ZSBMSUJYTF9ERVZJQ0VfTU9ERUxfVkVSU0lPTl9RRU1VX1hFTl9UUkFESVRJT05BTDoKKyAgICAg
ICAgY2FzZSBMSUJYTF9ERVZJQ0VfTU9ERUxfVkVSU0lPTl9RRU1VX1hFTjoKKyAgICAgICAgICAg
IG5lZWRfcWVtdSA9IHRydWU7CisgICAgICAgICAgICBicmVhazsKKyAgICAgICAgZGVmYXVsdDoK
KyAgICAgICAgICAgIG5lZWRfcWVtdSA9IGZhbHNlOworICAgICAgICAgICAgYnJlYWs7CisgICAg
fQorICAgIGlmIChuZWVkX3FlbXUgPT0gZmFsc2UpCiAgICAgICAgIHJldHVybiAwOwogCiAgICAg
TE9HRChFUlJPUiwgZG9taWQsICJkZXZpY2UgbW9kZWwgcmVxdWlyZWQgYnV0IG5vdCBydW5uaW5n
Iik7CiAgICAgcmMgPSBFUlJPUl9GQUlMOwogCi1vdXQ6CiAgICAgcmV0dXJuIHJjOwogfQogCmRp
ZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9kb21fc3VzcGVuZC5jIGIvdG9vbHMvbGlieGwv
bGlieGxfZG9tX3N1c3BlbmQuYwppbmRleCBkMWFmM2E2NTczLi5jNDkyZmU1ZGQxIDEwMDY0NAot
LS0gYS90b29scy9saWJ4bC9saWJ4bF9kb21fc3VzcGVuZC5jCisrKyBiL3Rvb2xzL2xpYnhsL2xp
YnhsX2RvbV9zdXNwZW5kLmMKQEAgLTM3OSw3ICszNzksOSBAQCBzdGF0aWMgdm9pZCBkb21haW5f
c3VzcGVuZF9jb21tb25fZ3Vlc3Rfc3VzcGVuZGVkKGxpYnhsX19lZ2MgKmVnYywKICAgICBsaWJ4
bF9fZXZfeHN3YXRjaF9kZXJlZ2lzdGVyKGdjLCAmZHNwcy0+Z3Vlc3Rfd2F0Y2gpOwogICAgIGxp
YnhsX19ldl90aW1lX2RlcmVnaXN0ZXIoZ2MsICZkc3BzLT5ndWVzdF90aW1lb3V0KTsKIAotICAg
IGlmIChkc3BzLT50eXBlID09IExJQlhMX0RPTUFJTl9UWVBFX0hWTSkgeworICAgIGlmIChkc3Bz
LT50eXBlID09IExJQlhMX0RPTUFJTl9UWVBFX0hWTSB8fAorICAgICAgICBsaWJ4bF9fZGV2aWNl
X21vZGVsX3ZlcnNpb25fcnVubmluZyhnYywgZHNwcy0+ZG9taWQpID09CisgICAgICAgIExJQlhM
X0RFVklDRV9NT0RFTF9WRVJTSU9OX1FFTVVfWEVOKSB7CiAgICAgICAgIGRzcHMtPmNhbGxiYWNr
X2RldmljZV9tb2RlbF9kb25lID0gZG9tYWluX3N1c3BlbmRfY29tbW9uX2RvbmU7CiAgICAgICAg
IGxpYnhsX19kb21haW5fc3VzcGVuZF9kZXZpY2VfbW9kZWwoZWdjLCBkc3BzKTsgLyogbXVzdCBi
ZSBsYXN0ICovCiAgICAgICAgIHJldHVybjsKQEAgLTQ1OSw3ICs0NjEsOSBAQCBpbnQgbGlieGxf
X2RvbWFpbl9yZXN1bWUobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsIGludCBzdXNwZW5k
X2NhbmNlbCkKICAgICAgICAgZ290byBvdXQ7CiAgICAgfQogCi0gICAgaWYgKHR5cGUgPT0gTElC
WExfRE9NQUlOX1RZUEVfSFZNKSB7CisgICAgaWYgKHR5cGUgPT0gTElCWExfRE9NQUlOX1RZUEVf
SFZNIHx8CisgICAgICAgIGxpYnhsX19kZXZpY2VfbW9kZWxfdmVyc2lvbl9ydW5uaW5nKGdjLCBk
b21pZCkgPT0KKyAgICAgICAgTElCWExfREVWSUNFX01PREVMX1ZFUlNJT05fUUVNVV9YRU4pIHsK
ICAgICAgICAgcmMgPSBsaWJ4bF9fZG9tYWluX3Jlc3VtZV9kZXZpY2VfbW9kZWwoZ2MsIGRvbWlk
KTsKICAgICAgICAgaWYgKHJjKSB7CiAgICAgICAgICAgICBMT0dEKEVSUk9SLCBkb21pZCwgImZh
aWxlZCB0byByZXN1bWUgZGV2aWNlIG1vZGVsOiVkIiwgcmMpOwpkaWZmIC0tZ2l0IGEvdG9vbHMv
bGlieGwvbGlieGxfaW50ZXJuYWwuaCBiL3Rvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmgKaW5k
ZXggNDRlMDIyMTI4NC4uOWViNDIxMWQ4NSAxMDA2NDQKLS0tIGEvdG9vbHMvbGlieGwvbGlieGxf
aW50ZXJuYWwuaAorKysgYi90b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5oCkBAIC0xODE3LDcg
KzE4MTcsOCBAQCBfaGlkZGVuIGludCBsaWJ4bF9fZG9tYWluX2J1aWxkKGxpYnhsX19nYyAqZ2Ms
CiBfaGlkZGVuIGNvbnN0IGNoYXIgKmxpYnhsX19kb21haW5fZGV2aWNlX21vZGVsKGxpYnhsX19n
YyAqZ2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGli
eGxfZG9tYWluX2J1aWxkX2luZm8gKmluZm8pOwogX2hpZGRlbiBpbnQgbGlieGxfX25lZWRfeGVu
cHZfcWVtdShsaWJ4bF9fZ2MgKmdjLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBsaWJ4bF9kb21haW5fY29uZmlnICpkX2NvbmZpZyk7CisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICB1aW50MzJfdCBkb21pZCk7CiBfaGlkZGVuIGJvb2wgbGli
eGxfX3F1ZXJ5X3FlbXVfYmFja2VuZChsaWJ4bF9fZ2MgKmdjLAogICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgZG9taWQsCiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICB1aW50MzJfdCBiYWNrZW5kX2lkLApkaWZmIC0tZ2l0IGEvdG9v
bHMvbGlieGwvbGlieGxfdHlwZXMuaWRsIGIvdG9vbHMvbGlieGwvbGlieGxfdHlwZXMuaWRsCmlu
ZGV4IGNiNDcwMmZkN2EuLjdkNzViZDM4NTAgMTAwNjQ0Ci0tLSBhL3Rvb2xzL2xpYnhsL2xpYnhs
X3R5cGVzLmlkbAorKysgYi90b29scy9saWJ4bC9saWJ4bF90eXBlcy5pZGwKQEAgLTEwNiw2ICsx
MDYsNyBAQCBsaWJ4bF9kZXZpY2VfbW9kZWxfdmVyc2lvbiA9IEVudW1lcmF0aW9uKCJkZXZpY2Vf
bW9kZWxfdmVyc2lvbiIsIFsKICAgICAoMCwgIlVOS05PV04iKSwKICAgICAoMSwgIlFFTVVfWEVO
X1RSQURJVElPTkFMIiksICMgSGlzdG9yaWNhbCBxZW11LXhlbiBkZXZpY2UgbW9kZWwgKHFlbXUt
ZG0pCiAgICAgKDIsICJRRU1VX1hFTiIpLCAgICAgICAgICAgICAjIFVwc3RyZWFtIGJhc2VkIHFl
bXUteGVuIGRldmljZSBtb2RlbAorICAgICgzLCAiTk9ORV9SRVFVSVJFRCIpLAogICAgIF0pCiAK
IGxpYnhsX2NvbnNvbGVfdHlwZSA9IEVudW1lcmF0aW9uKCJjb25zb2xlX3R5cGUiLCBbCgpfX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFp
bGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhl
bnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

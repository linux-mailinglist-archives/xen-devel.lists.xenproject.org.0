Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 18E2E58581
	for <lists+xen-devel@lfdr.de>; Thu, 27 Jun 2019 17:25:45 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hgWFf-0004ZU-K2; Thu, 27 Jun 2019 15:23:55 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=LRcK=U2=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1hgWFe-0004ZF-93
 for xen-devel@lists.xenproject.org; Thu, 27 Jun 2019 15:23:54 +0000
X-Inumbo-ID: 91756822-98ef-11e9-bd42-8733604c400a
Received: from prv1-mh.provo.novell.com (unknown [137.65.248.33])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 91756822-98ef-11e9-bd42-8733604c400a;
 Thu, 27 Jun 2019 15:23:52 +0000 (UTC)
Received: from INET-PRV1-MTA by prv1-mh.provo.novell.com
 with Novell_GroupWise; Thu, 27 Jun 2019 09:23:51 -0600
Message-Id: <5D14DF81020000780023B9DF@prv1-mh.provo.novell.com>
X-Mailer: Novell GroupWise Internet Agent 18.1.1 
Date: Thu, 27 Jun 2019 09:23:45 -0600
From: "Jan Beulich" <JBeulich@suse.com>
To: "xen-devel" <xen-devel@lists.xenproject.org>
References: <5D024C500200007800237DD8@prv1-mh.provo.novell.com>
 <5D14DDA6020000780023B96E@prv1-mh.provo.novell.com>
In-Reply-To: <5D14DDA6020000780023B96E@prv1-mh.provo.novell.com>
Mime-Version: 1.0
Content-Disposition: inline
Subject: [Xen-devel] [PATCH RFC v2 10/10] AMD/IOMMU: correct IRTE updating
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Brian Woods <brian.woods@amd.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hpbGUgZm9yIDMyLWJpdCBJUlRFcyBJIHRoaW5rIHdlIGNhbiBzYWZlbHkgY29udGludWUgdG8g
YXNzdW1lIHRoYXQgdGhlCndyaXRlcyB3aWxsIHRyYW5zbGF0ZSB0byBhIHNpbmdsZSBNT1YsIHRo
ZSB1c2Ugb2YgQ01QWENIRzE2QiBpcyBtb3JlCmhlYXZ5IGhhbmRlZCB0aGFuIG5lY2Vzc2FyeSBm
b3IgdGhlIDEyOC1iaXQgZm9ybSwgYW5kIHRoZSBmbHVzaGluZwpkaWRuJ3QgZ2V0IGRvbmUgYWxv
bmcgdGhlIGxpbmVzIG9mIHdoYXQgdGhlIHNwZWNpZmljYXRpb24gc2F5cy4gTWFyawplbnRyaWVz
IHRvIGJlIHVwZGF0ZWQgYXMgbm90IHJlbWFwcGVkICh3aGljaCB3aWxsIHJlc3VsdCBpbiBpbnRl
cnJ1cHQKcmVxdWVzdHMgdG8gZ2V0IHRhcmdldCBhYm9ydGVkLCBidXQgdGhlIGludGVycnVwdHMg
c2hvdWxkIGJlIG1hc2tlZAphbnl3YXkgYXQgdGhhdCBwb2ludCBpbiB0aW1lKSwgaXNzdWUgdGhl
IGZsdXNoLCBhbmQgb25seSB0aGVuIHdyaXRlIHRoZQpuZXcgZW50cnkuIEluIHRoZSAxMjgtYml0
IElSVEUgY2FzZSBzZXQgUmVtYXBFbiBzZXBhcmF0ZWx5IGxhc3QsIHRvIHRoYXQKdGhlIG9yZGVy
aW5nIG9mIHRoZSB3cml0ZXMgb2YgdGhlIHR3byA2NC1iaXQgaGFsdmVzIHdvbid0IG1hdHRlci4K
CkluIHVwZGF0ZV9pbnRyZW1hcF9lbnRyeV9mcm9tX21zaV9tc2coKSBhbHNvIGZvbGQgdGhlIGR1
cGxpY2F0ZSBpbml0aWFsCmxvY2sgZGV0ZXJtaW5hdGlvbiBhbmQgYWNxdWlyZSBpbnRvIGp1c3Qg
YSBzaW5nbGUgaW5zdGFuY2UuCgpTaWduZWQtb2ZmLWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hA
c3VzZS5jb20+Ci0tLQpSRkM6IFB1dHRpbmcgdGhlIGZsdXNoIGludm9jYXRpb25zIGluIGxvb3Bz
IGlzbid0IG92ZXJseSBuaWNlLCBidXQgSQogICAgIGRvbid0IHRoaW5rIHRoaXMgY2FuIHJlYWxs
eSBiZSBhYnVzZWQsIHNpbmNlIGNhbGxlcnMgdXAgdGhlIHN0YWNrCiAgICAgaG9sZCBmdXJ0aGVy
IGxvY2tzLiBOZXZlcnRoZWxlc3MgSSdkIGxpa2UgdG8gYXNrIGZvciBiZXR0ZXIKICAgICBzdWdn
ZXN0aW9ucy4KLS0tCnYyOiBQYXJ0cyBtb3JwaGVkIGludG8gZWFybGllciBwYXRjaC4KCi0tLSBh
L3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdV9pbnRyLmMKKysrIGIveGVuL2RyaXZl
cnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11X2ludHIuYwpAQCAtMjM4LDggKzIzOCw3IEBAIHN0YXRp
YyB2b2lkIHVwZGF0ZV9pbnRyZW1hcF9lbnRyeSh1bmlvbgogICAgICAgICBicmVhazsKIAogICAg
IGNhc2UgaXJ0ZTEyODoKLSAgICAgICAgQUNDRVNTX09OQ0UoZW50cnkucHRyMTI4LT5yYXdbMF0p
ID0gMDsKLSAgICAgICAgYmFycmllcigpOworICAgICAgICBBU1NFUlQoIWVudHJ5LnB0cjEyOC0+
ZnVsbC5yZW1hcF9lbik7CiAgICAgICAgIGVudHJ5LnB0cjEyOC0+cmF3WzFdID0KICAgICAgICAg
ICAgIGNvbnRhaW5lcl9vZigmZnVsbCwgdW5pb24gaXJ0ZTEyOCwgZnVsbCktPnJhd1sxXTsKICAg
ICAgICAgYmFycmllcigpOwpAQCAtMzA4LDYgKzMwNywyMCBAQCBzdGF0aWMgaW50IHVwZGF0ZV9p
bnRyZW1hcF9lbnRyeV9mcm9tX2lvCiAgICAgfQogCiAgICAgZW50cnkgPSBnZXRfaW50cmVtYXBf
ZW50cnkoaW9tbXUtPnNlZywgcmVxX2lkLCBvZmZzZXQpOworCisgICAgLyogVGhlIFJlbWFwRW4g
ZmllbGRzIG1hdGNoIGZvciBhbGwgZm9ybWF0cy4gKi8KKyAgICB3aGlsZSAoIGlvbW11LT5lbmFi
bGVkICYmIGVudHJ5LnB0cjMyLT5iYXNpYy5yZW1hcF9lbiApCisgICAgeworICAgICAgICBlbnRy
eS5wdHIzMi0+YmFzaWMucmVtYXBfZW4gPSAwOworICAgICAgICBzcGluX3VubG9jayhsb2NrKTsK
KworICAgICAgICBzcGluX2xvY2soJmlvbW11LT5sb2NrKTsKKyAgICAgICAgYW1kX2lvbW11X2Zs
dXNoX2ludHJlbWFwKGlvbW11LCByZXFfaWQpOworICAgICAgICBzcGluX3VubG9jaygmaW9tbXUt
PmxvY2spOworCisgICAgICAgIHNwaW5fbG9jayhsb2NrKTsKKyAgICB9CisKICAgICBpZiAoIGZy
ZXNoICkKICAgICAgICAgLyogbm90aGluZyAqLzsKICAgICBlbHNlIGlmICggIWxvX3VwZGF0ZSAp
CkBAIC0zMzcsMTMgKzM1MCw2IEBAIHN0YXRpYyBpbnQgdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zy
b21faW8KIAogICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MpOwogCi0gICAg
aWYgKCBpb21tdS0+ZW5hYmxlZCAmJiAhZnJlc2ggKQotICAgIHsKLSAgICAgICAgc3Bpbl9sb2Nr
X2lycXNhdmUoJmlvbW11LT5sb2NrLCBmbGFncyk7Ci0gICAgICAgIGFtZF9pb21tdV9mbHVzaF9p
bnRyZW1hcChpb21tdSwgcmVxX2lkKTsKLSAgICAgICAgc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgm
aW9tbXUtPmxvY2ssIGZsYWdzKTsKLSAgICB9Ci0KICAgICBzZXRfcnRlX2luZGV4KHJ0ZSwgb2Zm
c2V0KTsKIAogICAgIHJldHVybiAwOwpAQCAtNjA4LDE5ICs2MTQsMjcgQEAgc3RhdGljIGludCB1
cGRhdGVfaW50cmVtYXBfZW50cnlfZnJvbV9tcwogICAgIHJlcV9pZCA9IGdldF9kbWFfcmVxdWVz
dG9yX2lkKGlvbW11LT5zZWcsIGJkZik7CiAgICAgYWxpYXNfaWQgPSBnZXRfaW50cmVtYXBfcmVx
dWVzdG9yX2lkKGlvbW11LT5zZWcsIGJkZik7CiAKKyAgICBsb2NrID0gZ2V0X2ludHJlbWFwX2xv
Y2soaW9tbXUtPnNlZywgcmVxX2lkKTsKKyAgICBzcGluX2xvY2tfaXJxc2F2ZShsb2NrLCBmbGFn
cyk7CisKICAgICBpZiAoIG1zZyA9PSBOVUxMICkKICAgICB7Ci0gICAgICAgIGxvY2sgPSBnZXRf
aW50cmVtYXBfbG9jayhpb21tdS0+c2VnLCByZXFfaWQpOwotICAgICAgICBzcGluX2xvY2tfaXJx
c2F2ZShsb2NrLCBmbGFncyk7CiAgICAgICAgIGZvciAoIGkgPSAwOyBpIDwgbnI7ICsraSApCiAg
ICAgICAgICAgICBmcmVlX2ludHJlbWFwX2VudHJ5KGlvbW11LT5zZWcsIHJlcV9pZCwgKnJlbWFw
X2luZGV4ICsgaSk7CiAgICAgICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3Mp
OwotICAgICAgICBnb3RvIGRvbmU7Ci0gICAgfQogCi0gICAgbG9jayA9IGdldF9pbnRyZW1hcF9s
b2NrKGlvbW11LT5zZWcsIHJlcV9pZCk7CisgICAgICAgIGlmICggaW9tbXUtPmVuYWJsZWQgKQor
ICAgICAgICB7CisgICAgICAgICAgICBzcGluX2xvY2tfaXJxc2F2ZSgmaW9tbXUtPmxvY2ssIGZs
YWdzKTsKKyAgICAgICAgICAgIGFtZF9pb21tdV9mbHVzaF9pbnRyZW1hcChpb21tdSwgcmVxX2lk
KTsKKyAgICAgICAgICAgIGlmICggYWxpYXNfaWQgIT0gcmVxX2lkICkKKyAgICAgICAgICAgICAg
ICBhbWRfaW9tbXVfZmx1c2hfaW50cmVtYXAoaW9tbXUsIGFsaWFzX2lkKTsKKyAgICAgICAgICAg
IHNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmlvbW11LT5sb2NrLCBmbGFncyk7CisgICAgICAgIH0K
KworICAgICAgICByZXR1cm4gMDsKKyAgICB9CiAKLSAgICBzcGluX2xvY2tfaXJxc2F2ZShsb2Nr
LCBmbGFncyk7CiAgICAgZGVzdF9tb2RlID0gKG1zZy0+YWRkcmVzc19sbyA+PiBNU0lfQUREUl9E
RVNUTU9ERV9TSElGVCkgJiAweDE7CiAgICAgZGVsaXZlcnlfbW9kZSA9IChtc2ctPmRhdGEgPj4g
TVNJX0RBVEFfREVMSVZFUllfTU9ERV9TSElGVCkgJiAweDE7CiAgICAgdmVjdG9yID0gKG1zZy0+
ZGF0YSA+PiBNU0lfREFUQV9WRUNUT1JfU0hJRlQpICYgTVNJX0RBVEFfVkVDVE9SX01BU0s7CkBA
IC02NDQsNiArNjU4LDIyIEBAIHN0YXRpYyBpbnQgdXBkYXRlX2ludHJlbWFwX2VudHJ5X2Zyb21f
bXMKICAgICB9CiAKICAgICBlbnRyeSA9IGdldF9pbnRyZW1hcF9lbnRyeShpb21tdS0+c2VnLCBy
ZXFfaWQsIG9mZnNldCk7CisKKyAgICAvKiBUaGUgUmVtYXBFbiBmaWVsZHMgbWF0Y2ggZm9yIGFs
bCBmb3JtYXRzLiAqLworICAgIHdoaWxlICggaW9tbXUtPmVuYWJsZWQgJiYgZW50cnkucHRyMzIt
PmJhc2ljLnJlbWFwX2VuICkKKyAgICB7CisgICAgICAgIGVudHJ5LnB0cjMyLT5iYXNpYy5yZW1h
cF9lbiA9IDA7CisgICAgICAgIHNwaW5fdW5sb2NrKGxvY2spOworCisgICAgICAgIHNwaW5fbG9j
aygmaW9tbXUtPmxvY2spOworICAgICAgICBhbWRfaW9tbXVfZmx1c2hfaW50cmVtYXAoaW9tbXUs
IHJlcV9pZCk7CisgICAgICAgIGlmICggYWxpYXNfaWQgIT0gcmVxX2lkICkKKyAgICAgICAgICAg
IGFtZF9pb21tdV9mbHVzaF9pbnRyZW1hcChpb21tdSwgYWxpYXNfaWQpOworICAgICAgICBzcGlu
X3VubG9jaygmaW9tbXUtPmxvY2spOworCisgICAgICAgIHNwaW5fbG9jayhsb2NrKTsKKyAgICB9
CisKICAgICB1cGRhdGVfaW50cmVtYXBfZW50cnkoZW50cnksIHZlY3RvciwgZGVsaXZlcnlfbW9k
ZSwgZGVzdF9tb2RlLCBkZXN0KTsKICAgICBzcGluX3VubG9ja19pcnFyZXN0b3JlKGxvY2ssIGZs
YWdzKTsKIApAQCAtNjYzLDE2ICs2OTMsNiBAQCBzdGF0aWMgaW50IHVwZGF0ZV9pbnRyZW1hcF9l
bnRyeV9mcm9tX21zCiAgICAgICAgICAgICAgICBnZXRfaXZyc19tYXBwaW5ncyhpb21tdS0+c2Vn
KVthbGlhc19pZF0uaW50cmVtYXBfdGFibGUpOwogICAgIH0KIAotZG9uZToKLSAgICBpZiAoIGlv
bW11LT5lbmFibGVkICkKLSAgICB7Ci0gICAgICAgIHNwaW5fbG9ja19pcnFzYXZlKCZpb21tdS0+
bG9jaywgZmxhZ3MpOwotICAgICAgICBhbWRfaW9tbXVfZmx1c2hfaW50cmVtYXAoaW9tbXUsIHJl
cV9pZCk7Ci0gICAgICAgIGlmICggYWxpYXNfaWQgIT0gcmVxX2lkICkKLSAgICAgICAgICAgIGFt
ZF9pb21tdV9mbHVzaF9pbnRyZW1hcChpb21tdSwgYWxpYXNfaWQpOwotICAgICAgICBzcGluX3Vu
bG9ja19pcnFyZXN0b3JlKCZpb21tdS0+bG9jaywgZmxhZ3MpOwotICAgIH0KLQogICAgIHJldHVy
biAwOwogfQogCgoKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9y
ZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

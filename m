Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id D67272C485
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:37:23 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZQk-0005xa-82; Tue, 28 May 2019 10:34:06 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZQD-0004rj-Ta
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:33:33 +0000
X-Inumbo-ID: 04c3324c-8134-11e9-8f2a-93c24c1ed862
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 04c3324c-8134-11e9-8f2a-93c24c1ed862;
 Tue, 28 May 2019 10:33:23 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 4364CB03E;
 Tue, 28 May 2019 10:33:22 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:32:35 +0200
Message-Id: <20190528103313.1343-23-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 22/60] xen/sched: make credit scheduler vcpu
 agnostic.
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U3dpdGNoIGNyZWRpdCBzY2hlZHVsZXIgY29tcGxldGVseSBmcm9tIHZjcHUgdG8gc2NoZWRfdW5p
dCB1c2FnZS4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4K
LS0tCiB4ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jIHwgNTA2ICsrKysrKysrKysrKysrKysrKysr
KysrLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAyNTIgaW5zZXJ0aW9u
cygrKSwgMjU0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWRfY3Jl
ZGl0LmMgYi94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jCmluZGV4IGI3MDBjYzA3Y2UuLjBiYzZh
ODdkMzAgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWRfY3JlZGl0LmMKKysrIGIveGVuL2Nv
bW1vbi9zY2hlZF9jcmVkaXQuYwpAQCAtNzAsMTAgKzcwLDEwIEBACiAgKiBpbmNvbnNpc3RlbnQg
c2V0IG9mIGxvY2tzLiBUaGVyZWZvcmUgYXRvbWljLXNhZmUgYml0IG9wZXJhdGlvbnMgbXVzdAog
ICogYmUgdXNlZCBmb3IgYWNjZXNzaW5nIGl0LgogICovCi0jZGVmaW5lIENTQ0hFRF9GTEFHX1ZD
UFVfUEFSS0VEICAgIDB4MCAgLyogVkNQVSBvdmVyIGNhcHBlZCBjcmVkaXRzICovCi0jZGVmaW5l
IENTQ0hFRF9GTEFHX1ZDUFVfWUlFTEQgICAgIDB4MSAgLyogVkNQVSB5aWVsZGluZyAqLwotI2Rl
ZmluZSBDU0NIRURfRkxBR19WQ1BVX01JR1JBVElORyAweDIgIC8qIFZDUFUgbWF5IGhhdmUgbW92
ZWQgdG8gYSBuZXcgcGNwdSAqLwotI2RlZmluZSBDU0NIRURfRkxBR19WQ1BVX1BJTk5FRCAgICAw
eDQgIC8qIFZDUFUgY2FuIHJ1biBvbmx5IG9uIDEgcGNwdSAqLworI2RlZmluZSBDU0NIRURfRkxB
R19VTklUX1BBUktFRCAgICAweDAgIC8qIFVOSVQgb3ZlciBjYXBwZWQgY3JlZGl0cyAqLworI2Rl
ZmluZSBDU0NIRURfRkxBR19VTklUX1lJRUxEICAgICAweDEgIC8qIFVOSVQgeWllbGRpbmcgKi8K
KyNkZWZpbmUgQ1NDSEVEX0ZMQUdfVU5JVF9NSUdSQVRJTkcgMHgyICAvKiBVTklUIG1heSBoYXZl
IG1vdmVkIHRvIGEgbmV3IHBjcHUgKi8KKyNkZWZpbmUgQ1NDSEVEX0ZMQUdfVU5JVF9QSU5ORUQg
ICAgMHg0ICAvKiBVTklUIGNhbiBydW4gb25seSBvbiAxIHBjcHUgKi8KIAogCiAvKgpAQCAtOTEs
NyArOTEsNyBAQAogLyoKICAqIENTQ0hFRF9TVEFUUwogICoKLSAqIE1hbmFnZSB2ZXJ5IGJhc2lj
IHBlci12Q1BVIGNvdW50ZXJzIGFuZCBzdGF0cy4KKyAqIE1hbmFnZSB2ZXJ5IGJhc2ljIHBlci11
bml0IGNvdW50ZXJzIGFuZCBzdGF0cy4KICAqCiAgKiBVc2VmdWwgZm9yIGRlYnVnZ2luZyBsaXZl
IHN5c3RlbXMuIFRoZSBzdGF0cyBhcmUgZGlzcGxheWVkCiAgKiB3aXRoIHJ1bnEgZHVtcHMgKCdy
JyBvbiB0aGUgWGVuIGNvbnNvbGUpLgpAQCAtMTAwLDIzICsxMDAsMjMgQEAKIAogI2RlZmluZSBD
U0NIRURfU1RBVFMKIAotI2RlZmluZSBTQ0hFRF9WQ1BVX1NUQVRTX1JFU0VUKF9WKSAgICAgICAg
ICAgICAgICAgICAgICBcCisjZGVmaW5lIFNDSEVEX1VOSVRfU1RBVFNfUkVTRVQoX1YpICAgICAg
ICAgICAgICAgICAgICAgIFwKICAgICBkbyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgXAogICAgIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgIG1lbXNldCgmKF9WKS0+c3RhdHMsIDAsIHNp
emVvZigoX1YpLT5zdGF0cykpOyAgIFwKICAgICB9IHdoaWxlICggMCApCiAKLSNkZWZpbmUgU0NI
RURfVkNQVV9TVEFUX0NSQU5LKF9WLCBfWCkgICAgICAgKCgoX1YpLT5zdGF0cy5fWCkrKykKKyNk
ZWZpbmUgU0NIRURfVU5JVF9TVEFUX0NSQU5LKF9WLCBfWCkgICAgICAgKCgoX1YpLT5zdGF0cy5f
WCkrKykKIAotI2RlZmluZSBTQ0hFRF9WQ1BVX1NUQVRfU0VUKF9WLCBfWCwgX1kpICAgICAoKChf
ViktPnN0YXRzLl9YKSA9IChfWSkpCisjZGVmaW5lIFNDSEVEX1VOSVRfU1RBVF9TRVQoX1YsIF9Y
LCBfWSkgICAgICgoKF9WKS0+c3RhdHMuX1gpID0gKF9ZKSkKIAogI2Vsc2UgLyogIVNDSEVEX1NU
QVRTICovCiAKICN1bmRlZiBDU0NIRURfU1RBVFMKIAotI2RlZmluZSBTQ0hFRF9WQ1BVX1NUQVRT
X1JFU0VUKF9WKSAgICAgICAgIGRvIHt9IHdoaWxlICggMCApCi0jZGVmaW5lIFNDSEVEX1ZDUFVf
U1RBVF9DUkFOSyhfViwgX1gpICAgICAgZG8ge30gd2hpbGUgKCAwICkKLSNkZWZpbmUgU0NIRURf
VkNQVV9TVEFUX1NFVChfViwgX1gsIF9ZKSAgICBkbyB7fSB3aGlsZSAoIDAgKQorI2RlZmluZSBT
Q0hFRF9VTklUX1NUQVRTX1JFU0VUKF9WKSAgICAgICAgIGRvIHt9IHdoaWxlICggMCApCisjZGVm
aW5lIFNDSEVEX1VOSVRfU1RBVF9DUkFOSyhfViwgX1gpICAgICAgZG8ge30gd2hpbGUgKCAwICkK
KyNkZWZpbmUgU0NIRURfVU5JVF9TVEFUX1NFVChfViwgX1gsIF9ZKSAgICBkbyB7fSB3aGlsZSAo
IDAgKQogCiAjZW5kaWYgLyogU0NIRURfU1RBVFMgKi8KIApAQCAtMTI4LDcgKzEyOCw3IEBACiAj
ZGVmaW5lIFRSQ19DU0NIRURfU0NIRURfVEFTS0xFVCBUUkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hF
RCwgMSkKICNkZWZpbmUgVFJDX0NTQ0hFRF9BQ0NPVU5UX1NUQVJUIFRSQ19TQ0hFRF9DTEFTU19F
VlQoQ1NDSEVELCAyKQogI2RlZmluZSBUUkNfQ1NDSEVEX0FDQ09VTlRfU1RPUCAgVFJDX1NDSEVE
X0NMQVNTX0VWVChDU0NIRUQsIDMpCi0jZGVmaW5lIFRSQ19DU0NIRURfU1RPTEVOX1ZDUFUgICBU
UkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hFRCwgNCkKKyNkZWZpbmUgVFJDX0NTQ0hFRF9TVE9MRU5f
VU5JVCAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoQ1NDSEVELCA0KQogI2RlZmluZSBUUkNfQ1NDSEVE
X1BJQ0tFRF9DUFUgICAgVFJDX1NDSEVEX0NMQVNTX0VWVChDU0NIRUQsIDUpCiAjZGVmaW5lIFRS
Q19DU0NIRURfVElDS0xFICAgICAgICBUUkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hFRCwgNikKICNk
ZWZpbmUgVFJDX0NTQ0hFRF9CT09TVF9TVEFSVCAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoQ1NDSEVE
LCA3KQpAQCAtMTU4LDE1ICsxNTgsMTUgQEAgc3RydWN0IGNzY2hlZF9wY3B1IHsKIH07CiAKIC8q
Ci0gKiBWaXJ0dWFsIENQVQorICogVmlydHVhbCBVTklUCiAgKi8KIHN0cnVjdCBjc2NoZWRfdW5p
dCB7CiAgICAgc3RydWN0IGxpc3RfaGVhZCBydW5xX2VsZW07Ci0gICAgc3RydWN0IGxpc3RfaGVh
ZCBhY3RpdmVfdmNwdV9lbGVtOworICAgIHN0cnVjdCBsaXN0X2hlYWQgYWN0aXZlX3VuaXRfZWxl
bTsKIAogICAgIC8qIFVwLXBvaW50ZXJzICovCiAgICAgc3RydWN0IGNzY2hlZF9kb20gKnNkb207
Ci0gICAgc3RydWN0IHZjcHUgKnZjcHU7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAK
ICAgICBzX3RpbWVfdCBzdGFydF90aW1lOyAgIC8qIFdoZW4gd2Ugd2VyZSBzY2hlZHVsZWQgKHVz
ZWQgZm9yIGNyZWRpdCkgKi8KICAgICB1bnNpZ25lZCBmbGFnczsKQEAgLTE5MiwxMCArMTkyLDEw
IEBAIHN0cnVjdCBjc2NoZWRfdW5pdCB7CiAgKiBEb21haW4KICAqLwogc3RydWN0IGNzY2hlZF9k
b20gewotICAgIHN0cnVjdCBsaXN0X2hlYWQgYWN0aXZlX3ZjcHU7CisgICAgc3RydWN0IGxpc3Rf
aGVhZCBhY3RpdmVfdW5pdDsKICAgICBzdHJ1Y3QgbGlzdF9oZWFkIGFjdGl2ZV9zZG9tX2VsZW07
CiAgICAgc3RydWN0IGRvbWFpbiAqZG9tOwotICAgIHVpbnQxNl90IGFjdGl2ZV92Y3B1X2NvdW50
OworICAgIHVpbnQxNl90IGFjdGl2ZV91bml0X2NvdW50OwogICAgIHVpbnQxNl90IHdlaWdodDsK
ICAgICB1aW50MTZfdCBjYXA7CiB9OwpAQCAtMjE1LDcgKzIxNSw3IEBAIHN0cnVjdCBjc2NoZWRf
cHJpdmF0ZSB7CiAKICAgICAvKiBQZXJpb2Qgb2YgbWFzdGVyIGFuZCB0aWNrIGluIG1pbGxpc2Vj
b25kcyAqLwogICAgIHVuc2lnbmVkIGludCB0aWNrX3BlcmlvZF91cywgdGlja3NfcGVyX3RzbGlj
ZTsKLSAgICBzX3RpbWVfdCByYXRlbGltaXQsIHRzbGljZSwgdmNwdV9taWdyX2RlbGF5OworICAg
IHNfdGltZV90IHJhdGVsaW1pdCwgdHNsaWNlLCB1bml0X21pZ3JfZGVsYXk7CiAKICAgICBzdHJ1
Y3QgbGlzdF9oZWFkIGFjdGl2ZV9zZG9tOwogICAgIHVpbnQzMl90IHdlaWdodDsKQEAgLTIzMSw3
ICsyMzEsNyBAQCBzdGF0aWMgdm9pZCBjc2NoZWRfdGljayh2b2lkICpfY3B1KTsKIHN0YXRpYyB2
b2lkIGNzY2hlZF9hY2N0KHZvaWQgKmR1bW15KTsKIAogc3RhdGljIGlubGluZSBpbnQKLV9fdmNw
dV9vbl9ydW5xKHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQorX191bml0X29uX3J1bnEoc3RydWN0
IGNzY2hlZF91bml0ICpzdmMpCiB7CiAgICAgcmV0dXJuICFsaXN0X2VtcHR5KCZzdmMtPnJ1bnFf
ZWxlbSk7CiB9CkBAIC0yNDIsNyArMjQyLDcgQEAgX19ydW5xX2VsZW0oc3RydWN0IGxpc3RfaGVh
ZCAqZWxlbSkKICAgICByZXR1cm4gbGlzdF9lbnRyeShlbGVtLCBzdHJ1Y3QgY3NjaGVkX3VuaXQs
IHJ1bnFfZWxlbSk7CiB9CiAKLS8qIElzIHRoZSBmaXJzdCBlbGVtZW50IG9mIGNwdSdzIHJ1bnEg
KGlmIGFueSkgY3B1J3MgaWRsZSB2Y3B1PyAqLworLyogSXMgdGhlIGZpcnN0IGVsZW1lbnQgb2Yg
Y3B1J3MgcnVucSAoaWYgYW55KSBjcHUncyBpZGxlIHVuaXQ/ICovCiBzdGF0aWMgaW5saW5lIGJv
b2xfdCBpc19ydW5xX2lkbGUodW5zaWduZWQgaW50IGNwdSkKIHsKICAgICAvKgpAQCAtMjUxLDcg
KzI1MSw3IEBAIHN0YXRpYyBpbmxpbmUgYm9vbF90IGlzX3J1bnFfaWRsZSh1bnNpZ25lZCBpbnQg
Y3B1KQogICAgIEFTU0VSVChzcGluX2lzX2xvY2tlZChnZXRfc2NoZWRfcmVzKGNwdSktPnNjaGVk
dWxlX2xvY2spKTsKIAogICAgIHJldHVybiBsaXN0X2VtcHR5KFJVTlEoY3B1KSkgfHwKLSAgICAg
ICAgICAgaXNfaWRsZV92Y3B1KF9fcnVucV9lbGVtKFJVTlEoY3B1KS0+bmV4dCktPnZjcHUpOwor
ICAgICAgICAgICBpc19pZGxlX3VuaXQoX19ydW5xX2VsZW0oUlVOUShjcHUpLT5uZXh0KS0+dW5p
dCk7CiB9CiAKIHN0YXRpYyBpbmxpbmUgdm9pZApAQCAtMjczLDExICsyNzMsMTEgQEAgZGVjX25y
X3J1bm5hYmxlKHVuc2lnbmVkIGludCBjcHUpCiBzdGF0aWMgaW5saW5lIHZvaWQKIF9fcnVucV9p
bnNlcnQoc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiB7Ci0gICAgdW5zaWduZWQgaW50IGNwdSA9
IHN2Yy0+dmNwdS0+cHJvY2Vzc29yOworICAgIHVuc2lnbmVkIGludCBjcHUgPSBzY2hlZF91bml0
X2NwdShzdmMtPnVuaXQpOwogICAgIGNvbnN0IHN0cnVjdCBsaXN0X2hlYWQgKiBjb25zdCBydW5x
ID0gUlVOUShjcHUpOwogICAgIHN0cnVjdCBsaXN0X2hlYWQgKml0ZXI7CiAKLSAgICBCVUdfT04o
IF9fdmNwdV9vbl9ydW5xKHN2YykgKTsKKyAgICBCVUdfT04oIF9fdW5pdF9vbl9ydW5xKHN2Yykg
KTsKIAogICAgIGxpc3RfZm9yX2VhY2goIGl0ZXIsIHJ1bnEgKQogICAgIHsKQEAgLTI4NiwxMCAr
Mjg2LDEwIEBAIF9fcnVucV9pbnNlcnQoc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiAgICAgICAg
ICAgICBicmVhazsKICAgICB9CiAKLSAgICAvKiBJZiB0aGUgdmNwdSB5aWVsZGVkLCB0cnkgdG8g
cHV0IGl0IGJlaGluZCBvbmUgbG93ZXItcHJpb3JpdHkKLSAgICAgKiBydW5uYWJsZSB2Y3B1IGlm
IHdlIGNhbi4gIFRoZSBuZXh0IHJ1bnFfc29ydCB3aWxsIGJyaW5nIGl0IGZvcndhcmQKKyAgICAv
KiBJZiB0aGUgdW5pdCB5aWVsZGVkLCB0cnkgdG8gcHV0IGl0IGJlaGluZCBvbmUgbG93ZXItcHJp
b3JpdHkKKyAgICAgKiBydW5uYWJsZSB1bml0IGlmIHdlIGNhbi4gIFRoZSBuZXh0IHJ1bnFfc29y
dCB3aWxsIGJyaW5nIGl0IGZvcndhcmQKICAgICAgKiB3aXRoaW4gMzBtcyBpZiB0aGUgcXVldWUg
dG9vIGxvbmcuICovCi0gICAgaWYgKCB0ZXN0X2JpdChDU0NIRURfRkxBR19WQ1BVX1lJRUxELCAm
c3ZjLT5mbGFncykKKyAgICBpZiAoIHRlc3RfYml0KENTQ0hFRF9GTEFHX1VOSVRfWUlFTEQsICZz
dmMtPmZsYWdzKQogICAgICAgICAgJiYgX19ydW5xX2VsZW0oaXRlciktPnByaSA+IENTQ0hFRF9Q
UklfSURMRSApCiAgICAgewogICAgICAgICBpdGVyPWl0ZXItPm5leHQ7CkBAIC0zMDUsMjAgKzMw
NSwyMCBAQCBzdGF0aWMgaW5saW5lIHZvaWQKIHJ1bnFfaW5zZXJ0KHN0cnVjdCBjc2NoZWRfdW5p
dCAqc3ZjKQogewogICAgIF9fcnVucV9pbnNlcnQoc3ZjKTsKLSAgICBpbmNfbnJfcnVubmFibGUo
c3ZjLT52Y3B1LT5wcm9jZXNzb3IpOworICAgIGluY19ucl9ydW5uYWJsZShzY2hlZF91bml0X2Nw
dShzdmMtPnVuaXQpKTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lkCiBfX3J1bnFfcmVtb3ZlKHN0
cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewotICAgIEJVR19PTiggIV9fdmNwdV9vbl9ydW5xKHN2
YykgKTsKKyAgICBCVUdfT04oICFfX3VuaXRfb25fcnVucShzdmMpICk7CiAgICAgbGlzdF9kZWxf
aW5pdCgmc3ZjLT5ydW5xX2VsZW0pOwogfQogCiBzdGF0aWMgaW5saW5lIHZvaWQKIHJ1bnFfcmVt
b3ZlKHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewotICAgIGRlY19ucl9ydW5uYWJsZShzdmMt
PnZjcHUtPnByb2Nlc3Nvcik7CisgICAgZGVjX25yX3J1bm5hYmxlKHNjaGVkX3VuaXRfY3B1KHN2
Yy0+dW5pdCkpOwogICAgIF9fcnVucV9yZW1vdmUoc3ZjKTsKIH0KIApAQCAtMzI5LDcgKzMyOSw3
IEBAIHN0YXRpYyB2b2lkIGJ1cm5fY3JlZGl0cyhzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2Yywgc190
aW1lX3Qgbm93KQogICAgIHVuc2lnbmVkIGludCBjcmVkaXRzOwogCiAgICAgLyogQXNzZXJ0IHN2
YyBpcyBjdXJyZW50ICovCi0gICAgQVNTRVJUKCBzdmMgPT0gQ1NDSEVEX1VOSVQoY3Vycl9vbl9j
cHUoc3ZjLT52Y3B1LT5wcm9jZXNzb3IpKSApOworICAgIEFTU0VSVCggc3ZjID09IENTQ0hFRF9V
TklUKGN1cnJfb25fY3B1KHNjaGVkX3VuaXRfY3B1KHN2Yy0+dW5pdCkpKSApOwogCiAgICAgaWYg
KCAoZGVsdGEgPSBub3cgLSBzdmMtPnN0YXJ0X3RpbWUpIDw9IDAgKQogICAgICAgICByZXR1cm47
CkBAIC0zNDksOCArMzQ5LDggQEAgREVGSU5FX1BFUl9DUFUodW5zaWduZWQgaW50LCBsYXN0X3Rp
Y2tsZV9jcHUpOwogCiBzdGF0aWMgaW5saW5lIHZvaWQgX19ydW5xX3RpY2tsZShzdHJ1Y3QgY3Nj
aGVkX3VuaXQgKm5ldykKIHsKLSAgICB1bnNpZ25lZCBpbnQgY3B1ID0gbmV3LT52Y3B1LT5wcm9j
ZXNzb3I7Ci0gICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSBuZXctPnZjcHUtPnNjaGVkX3Vu
aXQ7CisgICAgdW5zaWduZWQgaW50IGNwdSA9IHNjaGVkX3VuaXRfY3B1KG5ldy0+dW5pdCk7Cisg
ICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSBuZXctPnVuaXQ7CiAgICAgc3RydWN0IGNzY2hl
ZF91bml0ICogY29uc3QgY3VyID0gQ1NDSEVEX1VOSVQoY3Vycl9vbl9jcHUoY3B1KSk7CiAgICAg
c3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYgPSBDU0NIRURfUFJJVihwZXJfY3B1KHNjaGVkdWxl
ciwgY3B1KSk7CiAgICAgY3B1bWFza190IG1hc2ssIGlkbGVfbWFzaywgKm9ubGluZTsKQEAgLTM2
NCwxNiArMzY0LDE2IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBfX3J1bnFfdGlja2xlKHN0cnVjdCBj
c2NoZWRfdW5pdCAqbmV3KQogICAgIGlkbGVyc19lbXB0eSA9IGNwdW1hc2tfZW1wdHkoJmlkbGVf
bWFzayk7CiAKICAgICAvKgotICAgICAqIEV4Y2x1c2l2ZSBwaW5uaW5nIGlzIHdoZW4gYSB2Y3B1
IGhhcyBoYXJkLWFmZmluaXR5IHdpdGggb25seSBvbmUKLSAgICAgKiBjcHUsIGFuZCB0aGVyZSBp
cyBubyBvdGhlciB2Y3B1IHRoYXQgaGFzIGhhcmQtYWZmaW5pdHkgd2l0aCB0aGF0CisgICAgICog
RXhjbHVzaXZlIHBpbm5pbmcgaXMgd2hlbiBhIHVuaXQgaGFzIGhhcmQtYWZmaW5pdHkgd2l0aCBv
bmx5IG9uZQorICAgICAqIGNwdSwgYW5kIHRoZXJlIGlzIG5vIG90aGVyIHVuaXQgdGhhdCBoYXMg
aGFyZC1hZmZpbml0eSB3aXRoIHRoYXQKICAgICAgKiBzYW1lIGNwdS4gVGhpcyBpcyBpbmZyZXF1
ZW50LCBidXQgaWYgaXQgaGFwcGVucywgaXMgZm9yIGFjaGlldmluZwogICAgICAqIHRoZSBtb3N0
IHBvc3NpYmxlIGRldGVybWluaXNtLCBhbmQgbGVhc3QgcG9zc2libGUgb3ZlcmhlYWQgZm9yCi0g
ICAgICogdGhlIHZjcHVzIGluIHF1ZXN0aW9uLgorICAgICAqIHRoZSB1bml0cyBpbiBxdWVzdGlv
bi4KICAgICAgKgogICAgICAqIFRyeSB0byBpZGVudGlmeSB0aGUgdmFzdCBtYWpvcml0eSBvZiB0
aGVzZSBzaXR1YXRpb25zLCBhbmQgZGVhbAogICAgICAqIHdpdGggdGhlbSBxdWlja2x5LgogICAg
ICAqLwotICAgIGlmICggdW5saWtlbHkodGVzdF9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9QSU5ORUQs
ICZuZXctPmZsYWdzKSAmJgorICAgIGlmICggdW5saWtlbHkodGVzdF9iaXQoQ1NDSEVEX0ZMQUdf
VU5JVF9QSU5ORUQsICZuZXctPmZsYWdzKSAmJgogICAgICAgICAgICAgICAgICAgY3B1bWFza190
ZXN0X2NwdShjcHUsICZpZGxlX21hc2spKSApCiAgICAgewogICAgICAgICBBU1NFUlQoY3B1bWFz
a19jeWNsZShjcHUsIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5KSA9PSBjcHUpOwpAQCAtMzg0LDcg
KzM4NCw3IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBfX3J1bnFfdGlja2xlKHN0cnVjdCBjc2NoZWRf
dW5pdCAqbmV3KQogCiAgICAgLyoKICAgICAgKiBJZiB0aGUgcGNwdSBpcyBpZGxlLCBvciB0aGVy
ZSBhcmUgbm8gaWRsZXJzIGFuZCB0aGUgbmV3Ci0gICAgICogdmNwdSBpcyBhIGhpZ2hlciBwcmlv
cml0eSB0aGFuIHRoZSBvbGQgdmNwdSwgcnVuIGl0IGhlcmUuCisgICAgICogdW5pdCBpcyBhIGhp
Z2hlciBwcmlvcml0eSB0aGFuIHRoZSBvbGQgdW5pdCwgcnVuIGl0IGhlcmUuCiAgICAgICoKICAg
ICAgKiBJZiB0aGVyZSBhcmUgaWRsZSBjcHVzLCBmaXJzdCB0cnkgdG8gZmluZCBvbmUgc3VpdGFi
bGUgdG8gcnVuCiAgICAgICogbmV3LCBzbyB3ZSBjYW4gYXZvaWQgcHJlZW1wdGluZyBjdXIuICBJ
ZiB3ZSBjYW5ub3QgZmluZCBhCkBAIC00MDMsNyArNDAzLDcgQEAgc3RhdGljIGlubGluZSB2b2lk
IF9fcnVucV90aWNrbGUoc3RydWN0IGNzY2hlZF91bml0ICpuZXcpCiAgICAgZWxzZSBpZiAoICFp
ZGxlcnNfZW1wdHkgKQogICAgIHsKICAgICAgICAgLyoKLSAgICAgICAgICogU29mdCBhbmQgaGFy
ZCBhZmZpbml0eSBiYWxhbmNpbmcgbG9vcC4gRm9yIHZjcHVzIHdpdGhvdXQKKyAgICAgICAgICog
U29mdCBhbmQgaGFyZCBhZmZpbml0eSBiYWxhbmNpbmcgbG9vcC4gRm9yIHVuaXRzIHdpdGhvdXQK
ICAgICAgICAgICogYSB1c2VmdWwgc29mdCBhZmZpbml0eSwgY29uc2lkZXIgaGFyZCBhZmZpbml0
eSBvbmx5LgogICAgICAgICAgKi8KICAgICAgICAgZm9yX2VhY2hfYWZmaW5pdHlfYmFsYW5jZV9z
dGVwKCBiYWxhbmNlX3N0ZXAgKQpAQCAtNDQ2LDEwICs0NDYsMTAgQEAgc3RhdGljIGlubGluZSB2
b2lkIF9fcnVucV90aWNrbGUoc3RydWN0IGNzY2hlZF91bml0ICpuZXcpCiAgICAgICAgICAgICB7
CiAgICAgICAgICAgICAgICAgaWYgKCBjcHVtYXNrX2ludGVyc2VjdHModW5pdC0+Y3B1X2hhcmRf
YWZmaW5pdHksICZpZGxlX21hc2spICkKICAgICAgICAgICAgICAgICB7Ci0gICAgICAgICAgICAg
ICAgICAgIFNDSEVEX1ZDUFVfU1RBVF9DUkFOSyhjdXIsIGtpY2tlZF9hd2F5KTsKLSAgICAgICAg
ICAgICAgICAgICAgU0NIRURfVkNQVV9TVEFUX0NSQU5LKGN1ciwgbWlncmF0ZV9yKTsKKyAgICAg
ICAgICAgICAgICAgICAgU0NIRURfVU5JVF9TVEFUX0NSQU5LKGN1ciwga2lja2VkX2F3YXkpOwor
ICAgICAgICAgICAgICAgICAgICBTQ0hFRF9VTklUX1NUQVRfQ1JBTksoY3VyLCBtaWdyYXRlX3Ip
OwogICAgICAgICAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3JhdGVfa2lja2VkX2F3
YXkpOwotICAgICAgICAgICAgICAgICAgICBzZXRfYml0KF9WUEZfbWlncmF0aW5nLCAmY3VyLT52
Y3B1LT5wYXVzZV9mbGFncyk7CisgICAgICAgICAgICAgICAgICAgIHNjaGVkX3NldF9wYXVzZV9m
bGFnc19hdG9taWMoY3VyLT51bml0LCBfVlBGX21pZ3JhdGluZyk7CiAgICAgICAgICAgICAgICAg
fQogICAgICAgICAgICAgICAgIC8qIFRpY2tsZSBjcHUgYW55d2F5LCB0byBsZXQgbmV3IHByZWVt
cHQgY3VyLiAqLwogICAgICAgICAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodGlja2xlZF9idXN5
X2NwdSk7CkBAIC02MDUsNyArNjA1LDcgQEAgaW5pdF9wZGF0YShzdHJ1Y3QgY3NjaGVkX3ByaXZh
dGUgKnBydiwgc3RydWN0IGNzY2hlZF9wY3B1ICpzcGMsIGludCBjcHUpCiAgICAgc3BjLT5pZGxl
X2JpYXMgPSBucl9jcHVfaWRzIC0gMTsKIAogICAgIC8qIFN0YXJ0IG9mZiBpZGxpbmcuLi4gKi8K
LSAgICBCVUdfT04oIWlzX2lkbGVfdmNwdShjdXJyX29uX2NwdShjcHUpLT52Y3B1KSk7CisgICAg
QlVHX09OKCFpc19pZGxlX3VuaXQoY3Vycl9vbl9jcHUoY3B1KSkpOwogICAgIGNwdW1hc2tfc2V0
X2NwdShjcHUsIHBydi0+aWRsZXJzKTsKICAgICBzcGMtPm5yX3J1bm5hYmxlID0gMDsKIH0KQEAg
LTYzOSw5ICs2MzksOSBAQCBjc2NoZWRfc3dpdGNoX3NjaGVkKHN0cnVjdCBzY2hlZHVsZXIgKm5l
d19vcHMsIHVuc2lnbmVkIGludCBjcHUsCiAgICAgc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYg
PSBDU0NIRURfUFJJVihuZXdfb3BzKTsKICAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YyA9IHZk
YXRhOwogCi0gICAgQVNTRVJUKHN2YyAmJiBpc19pZGxlX3ZjcHUoc3ZjLT52Y3B1KSk7CisgICAg
QVNTRVJUKHN2YyAmJiBpc19pZGxlX3VuaXQoc3ZjLT51bml0KSk7CiAKLSAgICBpZGxlX3ZjcHVb
Y3B1XS0+c2NoZWRfdW5pdC0+cHJpdiA9IHZkYXRhOworICAgIHNjaGVkX2lkbGVfdW5pdChjcHUp
LT5wcml2ID0gdmRhdGE7CiAKICAgICAvKgogICAgICAqIFdlIGFyZSBob2xkaW5nIHRoZSBydW5x
dWV1ZSBsb2NrIGFscmVhZHkgKGl0J3MgYmVlbiB0YWtlbiBpbgpAQCAtNjU4LDMzICs2NTgsMzMg
QEAgY3NjaGVkX3N3aXRjaF9zY2hlZChzdHJ1Y3Qgc2NoZWR1bGVyICpuZXdfb3BzLCB1bnNpZ25l
ZCBpbnQgY3B1LAogCiAjaWZuZGVmIE5ERUJVRwogc3RhdGljIGlubGluZSB2b2lkCi1fX2NzY2hl
ZF92Y3B1X2NoZWNrKHN0cnVjdCB2Y3B1ICp2YykKK19fY3NjaGVkX3VuaXRfY2hlY2soc3RydWN0
IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAgc3RydWN0IGNzY2hlZF91bml0ICogY29uc3Qgc3Zj
ID0gQ1NDSEVEX1VOSVQodmMtPnNjaGVkX3VuaXQpOworICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAq
IGNvbnN0IHN2YyA9IENTQ0hFRF9VTklUKHVuaXQpOwogICAgIHN0cnVjdCBjc2NoZWRfZG9tICog
Y29uc3Qgc2RvbSA9IHN2Yy0+c2RvbTsKIAotICAgIEJVR19PTiggc3ZjLT52Y3B1ICE9IHZjICk7
Ci0gICAgQlVHX09OKCBzZG9tICE9IENTQ0hFRF9ET00odmMtPmRvbWFpbikgKTsKKyAgICBCVUdf
T04oIHN2Yy0+dW5pdCAhPSB1bml0ICk7CisgICAgQlVHX09OKCBzZG9tICE9IENTQ0hFRF9ET00o
dW5pdC0+ZG9tYWluKSApOwogICAgIGlmICggc2RvbSApCiAgICAgewotICAgICAgICBCVUdfT04o
IGlzX2lkbGVfdmNwdSh2YykgKTsKLSAgICAgICAgQlVHX09OKCBzZG9tLT5kb20gIT0gdmMtPmRv
bWFpbiApOworICAgICAgICBCVUdfT04oIGlzX2lkbGVfdW5pdCh1bml0KSApOworICAgICAgICBC
VUdfT04oIHNkb20tPmRvbSAhPSB1bml0LT5kb21haW4gKTsKICAgICB9CiAgICAgZWxzZQogICAg
IHsKLSAgICAgICAgQlVHX09OKCAhaXNfaWRsZV92Y3B1KHZjKSApOworICAgICAgICBCVUdfT04o
ICFpc19pZGxlX3VuaXQodW5pdCkgKTsKICAgICB9CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVu
aXRfY2hlY2spOwogfQotI2RlZmluZSBDU0NIRURfVkNQVV9DSEVDSyhfdmMpICAoX19jc2NoZWRf
dmNwdV9jaGVjayhfdmMpKQorI2RlZmluZSBDU0NIRURfVU5JVF9DSEVDSyh1bml0KSAgKF9fY3Nj
aGVkX3VuaXRfY2hlY2sodW5pdCkpCiAjZWxzZQotI2RlZmluZSBDU0NIRURfVkNQVV9DSEVDSyhf
dmMpCisjZGVmaW5lIENTQ0hFRF9VTklUX0NIRUNLKHVuaXQpCiAjZW5kaWYKIAogLyoKLSAqIERl
bGF5LCBpbiBtaWNyb3NlY29uZHMsIGJldHdlZW4gbWlncmF0aW9ucyBvZiBhIFZDUFUgYmV0d2Vl
biBQQ1BVcy4KLSAqIFRoaXMgcHJldmVudHMgcmFwaWQgZmx1dHRlcmluZyBvZiBhIFZDUFUgYmV0
d2VlbiBDUFVzLCBhbmQgcmVkdWNlcyB0aGUKKyAqIERlbGF5LCBpbiBtaWNyb3NlY29uZHMsIGJl
dHdlZW4gbWlncmF0aW9ucyBvZiBhIFVOSVQgYmV0d2VlbiBQQ1BVcy4KKyAqIFRoaXMgcHJldmVu
dHMgcmFwaWQgZmx1dHRlcmluZyBvZiBhIFVOSVQgYmV0d2VlbiBDUFVzLCBhbmQgcmVkdWNlcyB0
aGUKICAqIGltcGxpY2l0IG92ZXJoZWFkcyBzdWNoIGFzIGNhY2hlLXdhcm1pbmcuIDFtcyAoMTAw
MCkgaGFzIGJlZW4gbWVhc3VyZWQKICAqIGFzIGEgZ29vZCB2YWx1ZS4KICAqLwpAQCAtNjkyLDEw
ICs2OTIsMTEgQEAgc3RhdGljIHVuc2lnbmVkIGludCB2Y3B1X21pZ3JhdGlvbl9kZWxheV91czsK
IGludGVnZXJfcGFyYW0oInZjcHVfbWlncmF0aW9uX2RlbGF5IiwgdmNwdV9taWdyYXRpb25fZGVs
YXlfdXMpOwogCiBzdGF0aWMgaW5saW5lIGJvb2wKLV9fY3NjaGVkX3ZjcHVfaXNfY2FjaGVfaG90
KGNvbnN0IHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3QgdmNwdSAqdikKK19fY3Nj
aGVkX3VuaXRfaXNfY2FjaGVfaG90KGNvbnN0IHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0g
ICAgYm9vbCBob3QgPSBwcnYtPnZjcHVfbWlncl9kZWxheSAmJgotICAgICAgICAgICAgICAgKE5P
VygpIC0gdi0+c2NoZWRfdW5pdC0+bGFzdF9ydW5fdGltZSkgPCBwcnYtPnZjcHVfbWlncl9kZWxh
eTsKKyAgICBib29sIGhvdCA9IHBydi0+dW5pdF9taWdyX2RlbGF5ICYmCisgICAgICAgICAgICAg
ICAoTk9XKCkgLSB1bml0LT5sYXN0X3J1bl90aW1lKSA8IHBydi0+dW5pdF9taWdyX2RlbGF5Owog
CiAgICAgaWYgKCBob3QgKQogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfaG90KTsKQEAg
LTcwNCwzNiArNzA1LDM4IEBAIF9fY3NjaGVkX3ZjcHVfaXNfY2FjaGVfaG90KGNvbnN0IHN0cnVj
dCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3QgdmNwdSAqdikKIH0KIAogc3RhdGljIGlubGlu
ZSBpbnQKLV9fY3NjaGVkX3ZjcHVfaXNfbWlncmF0ZWFibGUoY29uc3Qgc3RydWN0IGNzY2hlZF9w
cml2YXRlICpwcnYsIHN0cnVjdCB2Y3B1ICp2YywKK19fY3NjaGVkX3VuaXRfaXNfbWlncmF0ZWFi
bGUoY29uc3Qgc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0LAogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBpbnQgZGVzdF9jcHUsIGNwdW1hc2tfdCAqbWFzaykKIHsKICAgICAvKgogICAgICAq
IERvbid0IHBpY2sgdXAgd29yayB0aGF0J3MgaG90IG9uIHBlZXIgUENQVSwgb3IgdGhhdCBjYW4n
dCAob3IKICAgICAgKiB3b3VsZCBwcmVmZXIgbm90IHRvKSBydW4gb24gY3B1LgogICAgICAqCi0g
ICAgICogVGhlIGNhbGxlciBpcyBzdXBwb3NlZCB0byBoYXZlIGFscmVhZHkgY2hlY2tlZCB0aGF0
IHZjIGlzIGFsc28KKyAgICAgKiBUaGUgY2FsbGVyIGlzIHN1cHBvc2VkIHRvIGhhdmUgYWxyZWFk
eSBjaGVja2VkIHRoYXQgdW5pdCBpcyBhbHNvCiAgICAgICogbm90IHJ1bm5pbmcuCiAgICAgICov
Ci0gICAgQVNTRVJUKCF2Yy0+c2NoZWRfdW5pdC0+aXNfcnVubmluZyk7CisgICAgQVNTRVJUKCF1
bml0LT5pc19ydW5uaW5nKTsKIAotICAgIHJldHVybiAhX19jc2NoZWRfdmNwdV9pc19jYWNoZV9o
b3QocHJ2LCB2YykgJiYKKyAgICByZXR1cm4gIV9fY3NjaGVkX3VuaXRfaXNfY2FjaGVfaG90KHBy
diwgdW5pdCkgJiYKICAgICAgICAgICAgY3B1bWFza190ZXN0X2NwdShkZXN0X2NwdSwgbWFzayk7
CiB9CiAKIHN0YXRpYyBpbnQKLV9jc2NoZWRfY3B1X3BpY2soY29uc3Qgc3RydWN0IHNjaGVkdWxl
ciAqb3BzLCBzdHJ1Y3QgdmNwdSAqdmMsIGJvb2xfdCBjb21taXQpCitfY3NjaGVkX2NwdV9waWNr
KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisg
ICAgICAgICAgICAgICAgIGJvb2xfdCBjb21taXQpCiB7Ci0gICAgLyogV2UgbXVzdCBhbHdheXMg
dXNlIHZjLT5wcm9jc3NvcidzIHNjcmF0Y2ggc3BhY2UgKi8KLSAgICBjcHVtYXNrX3QgKmNwdXMg
PSBjcHVtYXNrX3NjcmF0Y2hfY3B1KHZjLT5wcm9jZXNzb3IpOworICAgIGludCBjcHUgPSBzY2hl
ZF91bml0X2NwdSh1bml0KTsKKyAgICAvKiBXZSBtdXN0IGFsd2F5cyB1c2UgY3B1J3Mgc2NyYXRj
aCBzcGFjZSAqLworICAgIGNwdW1hc2tfdCAqY3B1cyA9IGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1
KTsKICAgICBjcHVtYXNrX3QgaWRsZXJzOwotICAgIGNwdW1hc2tfdCAqb25saW5lID0gY3B1cG9v
bF9kb21haW5fY3B1bWFzayh2Yy0+ZG9tYWluKTsKKyAgICBjcHVtYXNrX3QgKm9ubGluZSA9IGNw
dXBvb2xfZG9tYWluX2NwdW1hc2sodW5pdC0+ZG9tYWluKTsKICAgICBzdHJ1Y3QgY3NjaGVkX3Bj
cHUgKnNwYyA9IE5VTEw7Ci0gICAgaW50IGNwdSA9IHZjLT5wcm9jZXNzb3I7CiAgICAgaW50IGJh
bGFuY2Vfc3RlcDsKIAogICAgIGZvcl9lYWNoX2FmZmluaXR5X2JhbGFuY2Vfc3RlcCggYmFsYW5j
ZV9zdGVwICkKICAgICB7Ci0gICAgICAgIGFmZmluaXR5X2JhbGFuY2VfY3B1bWFzayh2Yy0+c2No
ZWRfdW5pdCwgYmFsYW5jZV9zdGVwLCBjcHVzKTsKKyAgICAgICAgYWZmaW5pdHlfYmFsYW5jZV9j
cHVtYXNrKHVuaXQsIGJhbGFuY2Vfc3RlcCwgY3B1cyk7CiAgICAgICAgIGNwdW1hc2tfYW5kKGNw
dXMsIG9ubGluZSwgY3B1cyk7CiAgICAgICAgIC8qCiAgICAgICAgICAqIFdlIHdhbnQgdG8gcGlj
ayB1cCBhIHBjcHUgYW1vbmcgdGhlIG9uZXMgdGhhdCBhcmUgb25saW5lIGFuZApAQCAtNzUyLDEy
ICs3NTUsMTMgQEAgX2NzY2hlZF9jcHVfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMs
IHN0cnVjdCB2Y3B1ICp2YywgYm9vbF90IGNvbW1pdCkKICAgICAgICAgICogYmFsYW5jaW5nIHN0
ZXAgYWxsIHRvZ2V0aGVyLgogICAgICAgICAgKi8KICAgICAgICAgaWYgKCBiYWxhbmNlX3N0ZXAg
PT0gQkFMQU5DRV9TT0ZUX0FGRklOSVRZICYmCi0gICAgICAgICAgICAgKCFoYXNfc29mdF9hZmZp
bml0eSh2Yy0+c2NoZWRfdW5pdCkgfHwgY3B1bWFza19lbXB0eShjcHVzKSkgKQorICAgICAgICAg
ICAgICghaGFzX3NvZnRfYWZmaW5pdHkodW5pdCkgfHwgY3B1bWFza19lbXB0eShjcHVzKSkgKQog
ICAgICAgICAgICAgY29udGludWU7CiAKICAgICAgICAgLyogSWYgcHJlc2VudCwgcHJlZmVyIHZj
J3MgY3VycmVudCBwcm9jZXNzb3IgKi8KLSAgICAgICAgY3B1ID0gY3B1bWFza190ZXN0X2NwdSh2
Yy0+cHJvY2Vzc29yLCBjcHVzKQotICAgICAgICAgICAgICAgID8gdmMtPnByb2Nlc3NvciA6IGNw
dW1hc2tfY3ljbGUodmMtPnByb2Nlc3NvciwgY3B1cyk7CisgICAgICAgIGNwdSA9IGNwdW1hc2tf
dGVzdF9jcHUoc2NoZWRfdW5pdF9jcHUodW5pdCksIGNwdXMpCisgICAgICAgICAgICAgICAgPyBz
Y2hlZF91bml0X2NwdSh1bml0KQorICAgICAgICAgICAgICAgIDogY3B1bWFza19jeWNsZShzY2hl
ZF91bml0X2NwdSh1bml0KSwgY3B1cyk7CiAgICAgICAgIEFTU0VSVChjcHVtYXNrX3Rlc3RfY3B1
KGNwdSwgY3B1cykpOwogCiAgICAgICAgIC8qCkBAIC03NjksMTUgKzc3MywxNSBAQCBfY3NjaGVk
X2NwdV9waWNrKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHZjcHUgKnZjLCBi
b29sX3QgY29tbWl0KQogICAgICAgICAgKiBXZSBnaXZlIHByZWZlcmVuY2UgdG8gdGhlIGlkbGUg
ZXhlY3V0aW9uIHZlaGljbGUgd2l0aCB0aGUgbW9zdAogICAgICAgICAgKiBpZGxpbmcgbmVpZ2hi
b3VycyBpbiBpdHMgZ3JvdXBpbmcuIFRoaXMgZGlzdHJpYnV0ZXMgd29yayBhY3Jvc3MKICAgICAg
ICAgICogZGlzdGluY3QgY29yZXMgZmlyc3QgYW5kIGd1YXJhbnRlZXMgd2UgZG9uJ3QgZG8gc29t
ZXRoaW5nIHN0dXBpZAotICAgICAgICAgKiBsaWtlIHJ1biB0d28gVkNQVXMgb24gY28taHlwZXJ0
aHJlYWRzIHdoaWxlIHRoZXJlIGFyZSBpZGxlIGNvcmVzCisgICAgICAgICAqIGxpa2UgcnVuIHR3
byBVTklUcyBvbiBjby1oeXBlcnRocmVhZHMgd2hpbGUgdGhlcmUgYXJlIGlkbGUgY29yZXMKICAg
ICAgICAgICogb3Igc29ja2V0cy4KICAgICAgICAgICoKICAgICAgICAgICogTm90aWNlIHRoYXQs
IHdoZW4gY29tcHV0aW5nIHRoZSAiaWRsZW5lc3MiIG9mIGNwdSwgd2UgbWF5IHdhbnQgdG8KLSAg
ICAgICAgICogZGlzY291bnQgdmMuIFRoYXQgaXMsIGlmZiB2YyBpcyB0aGUgY3VycmVudGx5IHJ1
bm5pbmcgYW5kIHRoZSBvbmx5Ci0gICAgICAgICAqIHJ1bm5hYmxlIHZjcHUgb24gY3B1LCB3ZSBh
ZGQgY3B1IHRvIHRoZSBpZGxlcnMuCisgICAgICAgICAqIGRpc2NvdW50IHVuaXQuIFRoYXQgaXMs
IGlmZiB1bml0IGlzIHRoZSBjdXJyZW50bHkgcnVubmluZyBhbmQgdGhlCisgICAgICAgICAqIG9u
bHkgcnVubmFibGUgdW5pdCBvbiBjcHUsIHdlIGFkZCBjcHUgdG8gdGhlIGlkbGVycy4KICAgICAg
ICAgICovCiAgICAgICAgIGNwdW1hc2tfYW5kKCZpZGxlcnMsICZjcHVfb25saW5lX21hcCwgQ1ND
SEVEX1BSSVYob3BzKS0+aWRsZXJzKTsKLSAgICAgICAgaWYgKCB2Yy0+cHJvY2Vzc29yID09IGNw
dSAmJiBpc19ydW5xX2lkbGUoY3B1KSApCisgICAgICAgIGlmICggc2NoZWRfdW5pdF9jcHUodW5p
dCkgPT0gY3B1ICYmIGlzX3J1bnFfaWRsZShjcHUpICkKICAgICAgICAgICAgIF9fY3B1bWFza19z
ZXRfY3B1KGNwdSwgJmlkbGVycyk7CiAgICAgICAgIGNwdW1hc2tfYW5kKGNwdXMsICZpZGxlcnMs
IGNwdXMpOwogCkBAIC03ODcsNyArNzkxLDcgQEAgX2NzY2hlZF9jcHVfcGljayhjb25zdCBzdHJ1
Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1ICp2YywgYm9vbF90IGNvbW1pdCkKICAgICAg
ICAgICogQ1BVLCBhcyB3ZSBqdXN0ICYmLWVkIGl0IHdpdGggaWRsZXJzKS4gSW4gZmFjdCwgaWYg
d2UgYXJlIG9uIFNNVCwgYW5kCiAgICAgICAgICAqIGNwdSBwb2ludHMgdG8gYSBidXN5IHRocmVh
ZCB3aXRoIGFuIGlkbGUgc2libGluZywgYm90aCB0aGUgdGhyZWFkcwogICAgICAgICAgKiB3aWxs
IGJlIGNvbnNpZGVyZWQgdGhlIHNhbWUsIGZyb20gdGhlICJpZGxlbmVzcyIgY2FsY3VsYXRpb24g
cG9pbnQKLSAgICAgICAgICogb2YgdmlldyIsIHByZXZlbnRpbmcgdmNwdSBmcm9tIGJlaW5nIG1v
dmVkIHRvIHRoZSB0aHJlYWQgdGhhdCBpcworICAgICAgICAgKiBvZiB2aWV3IiwgcHJldmVudGlu
ZyB1bml0IGZyb20gYmVpbmcgbW92ZWQgdG8gdGhlIHRocmVhZCB0aGF0IGlzCiAgICAgICAgICAq
IGFjdHVhbGx5IGlkbGUuCiAgICAgICAgICAqCiAgICAgICAgICAqIE5vdGljZSB0aGF0IGNwdW1h
c2tfdGVzdF9jcHUoKSBpcyBxdWlja2VyIHRoYW4gY3B1bWFza19lbXB0eSgpLCBzbwpAQCAtODUz
LDcgKzg1Nyw4IEBAIF9jc2NoZWRfY3B1X3BpY2soY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3Bz
LCBzdHJ1Y3QgdmNwdSAqdmMsIGJvb2xfdCBjb21taXQpCiAgICAgaWYgKCBjb21taXQgJiYgc3Bj
ICkKICAgICAgICBzcGMtPmlkbGVfYmlhcyA9IGNwdTsKIAotICAgIFRSQUNFXzNEKFRSQ19DU0NI
RURfUElDS0VEX0NQVSwgdmMtPmRvbWFpbi0+ZG9tYWluX2lkLCB2Yy0+dmNwdV9pZCwgY3B1KTsK
KyAgICBUUkFDRV8zRChUUkNfQ1NDSEVEX1BJQ0tFRF9DUFUsIHVuaXQtPmRvbWFpbi0+ZG9tYWlu
X2lkLCB1bml0LT51bml0X2lkLAorICAgICAgICAgICAgIGNwdSk7CiAKICAgICByZXR1cm4gY3B1
OwogfQpAQCAtODYxLDcgKzg2Niw2IEBAIF9jc2NoZWRfY3B1X3BpY2soY29uc3Qgc3RydWN0IHNj
aGVkdWxlciAqb3BzLCBzdHJ1Y3QgdmNwdSAqdmMsIGJvb2xfdCBjb21taXQpCiBzdGF0aWMgc3Ry
dWN0IHNjaGVkX3Jlc291cmNlICoKIGNzY2hlZF9yZXNfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1
bGVyICpvcHMsIHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQogewotICAgIHN0cnVjdCB2Y3B1ICp2
YyA9IHVuaXQtPnZjcHU7CiAgICAgc3RydWN0IGNzY2hlZF91bml0ICpzdmMgPSBDU0NIRURfVU5J
VCh1bml0KTsKIAogICAgIC8qCkBAIC04NzEsMjYgKzg3NSwyNiBAQCBjc2NoZWRfcmVzX3BpY2so
Y29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKICAg
ICAgKiBjc2NoZWRfdW5pdF93YWtlKCkgKHN0aWxsIGNhbGxlZCBmcm9tIHZjcHVfbWlncmF0ZSgp
KSB3ZSB3b24ndAogICAgICAqIGdldCBib29zdGVkLCB3aGljaCB3ZSBkb24ndCBkZXNlcnZlIGFz
IHdlIGFyZSAib25seSIgbWlncmF0aW5nLgogICAgICAqLwotICAgIHNldF9iaXQoQ1NDSEVEX0ZM
QUdfVkNQVV9NSUdSQVRJTkcsICZzdmMtPmZsYWdzKTsKLSAgICByZXR1cm4gZ2V0X3NjaGVkX3Jl
cyhfY3NjaGVkX2NwdV9waWNrKG9wcywgdmMsIDEpKTsKKyAgICBzZXRfYml0KENTQ0hFRF9GTEFH
X1VOSVRfTUlHUkFUSU5HLCAmc3ZjLT5mbGFncyk7CisgICAgcmV0dXJuIGdldF9zY2hlZF9yZXMo
X2NzY2hlZF9jcHVfcGljayhvcHMsIHVuaXQsIDEpKTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lk
Ci1fX2NzY2hlZF92Y3B1X2FjY3Rfc3RhcnQoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHN0
cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQorX19jc2NoZWRfdW5pdF9hY2N0X3N0YXJ0KHN0cnVjdCBj
c2NoZWRfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKIHsKICAgICBzdHJ1
Y3QgY3NjaGVkX2RvbSAqIGNvbnN0IHNkb20gPSBzdmMtPnNkb207CiAgICAgdW5zaWduZWQgbG9u
ZyBmbGFnczsKIAogICAgIHNwaW5fbG9ja19pcnFzYXZlKCZwcnYtPmxvY2ssIGZsYWdzKTsKIAot
ICAgIGlmICggbGlzdF9lbXB0eSgmc3ZjLT5hY3RpdmVfdmNwdV9lbGVtKSApCisgICAgaWYgKCBs
aXN0X2VtcHR5KCZzdmMtPmFjdGl2ZV91bml0X2VsZW0pICkKICAgICB7Ci0gICAgICAgIFNDSEVE
X1ZDUFVfU1RBVF9DUkFOSyhzdmMsIHN0YXRlX2FjdGl2ZSk7CisgICAgICAgIFNDSEVEX1VOSVRf
U1RBVF9DUkFOSyhzdmMsIHN0YXRlX2FjdGl2ZSk7CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTkso
YWNjdF91bml0X2FjdGl2ZSk7CiAKLSAgICAgICAgc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQrKzsK
LSAgICAgICAgbGlzdF9hZGQoJnN2Yy0+YWN0aXZlX3ZjcHVfZWxlbSwgJnNkb20tPmFjdGl2ZV92
Y3B1KTsKLSAgICAgICAgLyogTWFrZSB3ZWlnaHQgcGVyLXZjcHUgKi8KKyAgICAgICAgc2RvbS0+
YWN0aXZlX3VuaXRfY291bnQrKzsKKyAgICAgICAgbGlzdF9hZGQoJnN2Yy0+YWN0aXZlX3VuaXRf
ZWxlbSwgJnNkb20tPmFjdGl2ZV91bml0KTsKKyAgICAgICAgLyogTWFrZSB3ZWlnaHQgcGVyLXVu
aXQgKi8KICAgICAgICAgcHJ2LT53ZWlnaHQgKz0gc2RvbS0+d2VpZ2h0OwogICAgICAgICBpZiAo
IGxpc3RfZW1wdHkoJnNkb20tPmFjdGl2ZV9zZG9tX2VsZW0pICkKICAgICAgICAgewpAQCAtODk5
LDU2ICs5MDMsNTYgQEAgX19jc2NoZWRfdmNwdV9hY2N0X3N0YXJ0KHN0cnVjdCBjc2NoZWRfcHJp
dmF0ZSAqcHJ2LCBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKICAgICB9CiAKICAgICBUUkFDRV8z
RChUUkNfQ1NDSEVEX0FDQ09VTlRfU1RBUlQsIHNkb20tPmRvbS0+ZG9tYWluX2lkLAotICAgICAg
ICAgICAgIHN2Yy0+dmNwdS0+dmNwdV9pZCwgc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQpOworICAg
ICAgICAgICAgIHN2Yy0+dW5pdC0+dW5pdF9pZCwgc2RvbS0+YWN0aXZlX3VuaXRfY291bnQpOwog
CiAgICAgc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmcHJ2LT5sb2NrLCBmbGFncyk7CiB9CiAKIHN0
YXRpYyBpbmxpbmUgdm9pZAotX19jc2NoZWRfdmNwdV9hY2N0X3N0b3BfbG9ja2VkKHN0cnVjdCBj
c2NoZWRfcHJpdmF0ZSAqcHJ2LAorX19jc2NoZWRfdW5pdF9hY2N0X3N0b3BfbG9ja2VkKHN0cnVj
dCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LAogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewog
ICAgIHN0cnVjdCBjc2NoZWRfZG9tICogY29uc3Qgc2RvbSA9IHN2Yy0+c2RvbTsKIAotICAgIEJV
R19PTiggbGlzdF9lbXB0eSgmc3ZjLT5hY3RpdmVfdmNwdV9lbGVtKSApOworICAgIEJVR19PTigg
bGlzdF9lbXB0eSgmc3ZjLT5hY3RpdmVfdW5pdF9lbGVtKSApOwogCi0gICAgU0NIRURfVkNQVV9T
VEFUX0NSQU5LKHN2Yywgc3RhdGVfaWRsZSk7CisgICAgU0NIRURfVU5JVF9TVEFUX0NSQU5LKHN2
Yywgc3RhdGVfaWRsZSk7CiAgICAgU0NIRURfU1RBVF9DUkFOSyhhY2N0X3VuaXRfaWRsZSk7CiAK
ICAgICBCVUdfT04oIHBydi0+d2VpZ2h0IDwgc2RvbS0+d2VpZ2h0ICk7Ci0gICAgc2RvbS0+YWN0
aXZlX3ZjcHVfY291bnQtLTsKLSAgICBsaXN0X2RlbF9pbml0KCZzdmMtPmFjdGl2ZV92Y3B1X2Vs
ZW0pOworICAgIHNkb20tPmFjdGl2ZV91bml0X2NvdW50LS07CisgICAgbGlzdF9kZWxfaW5pdCgm
c3ZjLT5hY3RpdmVfdW5pdF9lbGVtKTsKICAgICBwcnYtPndlaWdodCAtPSBzZG9tLT53ZWlnaHQ7
Ci0gICAgaWYgKCBsaXN0X2VtcHR5KCZzZG9tLT5hY3RpdmVfdmNwdSkgKQorICAgIGlmICggbGlz
dF9lbXB0eSgmc2RvbS0+YWN0aXZlX3VuaXQpICkKICAgICB7CiAgICAgICAgIGxpc3RfZGVsX2lu
aXQoJnNkb20tPmFjdGl2ZV9zZG9tX2VsZW0pOwogICAgIH0KIAogICAgIFRSQUNFXzNEKFRSQ19D
U0NIRURfQUNDT1VOVF9TVE9QLCBzZG9tLT5kb20tPmRvbWFpbl9pZCwKLSAgICAgICAgICAgICBz
dmMtPnZjcHUtPnZjcHVfaWQsIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50KTsKKyAgICAgICAgICAg
ICBzdmMtPnVuaXQtPnVuaXRfaWQsIHNkb20tPmFjdGl2ZV91bml0X2NvdW50KTsKIH0KIAogc3Rh
dGljIHZvaWQKLWNzY2hlZF92Y3B1X2FjY3Qoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHVu
c2lnbmVkIGludCBjcHUpCitjc2NoZWRfdW5pdF9hY2N0KHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAq
cHJ2LCB1bnNpZ25lZCBpbnQgY3B1KQogewogICAgIHN0cnVjdCBzY2hlZF91bml0ICpjdXJydW5p
dCA9IGN1cnJlbnQtPnNjaGVkX3VuaXQ7CiAgICAgc3RydWN0IGNzY2hlZF91bml0ICogY29uc3Qg
c3ZjID0gQ1NDSEVEX1VOSVQoY3VycnVuaXQpOwogICAgIGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIg
Km9wcyA9IHBlcl9jcHUoc2NoZWR1bGVyLCBjcHUpOwogCi0gICAgQVNTRVJUKCBjdXJyZW50LT5w
cm9jZXNzb3IgPT0gY3B1ICk7CisgICAgQVNTRVJUKCBzY2hlZF91bml0X2NwdShjdXJydW5pdCkg
PT0gY3B1ICk7CiAgICAgQVNTRVJUKCBzdmMtPnNkb20gIT0gTlVMTCApOwotICAgIEFTU0VSVCgg
IWlzX2lkbGVfdmNwdShzdmMtPnZjcHUpICk7CisgICAgQVNTRVJUKCAhaXNfaWRsZV91bml0KHN2
Yy0+dW5pdCkgKTsKIAogICAgIC8qCi0gICAgICogSWYgdGhpcyBWQ1BVJ3MgcHJpb3JpdHkgd2Fz
IGJvb3N0ZWQgd2hlbiBpdCBsYXN0IGF3b2tlLCByZXNldCBpdC4KLSAgICAgKiBJZiB0aGUgVkNQ
VSBpcyBmb3VuZCBoZXJlLCB0aGVuIGl0J3MgY29uc3VtaW5nIGEgbm9uLW5lZ2xpZ2VhYmxlCisg
ICAgICogSWYgdGhpcyBVTklUJ3MgcHJpb3JpdHkgd2FzIGJvb3N0ZWQgd2hlbiBpdCBsYXN0IGF3
b2tlLCByZXNldCBpdC4KKyAgICAgKiBJZiB0aGUgVU5JVCBpcyBmb3VuZCBoZXJlLCB0aGVuIGl0
J3MgY29uc3VtaW5nIGEgbm9uLW5lZ2xpZ2VhYmxlCiAgICAgICogYW1vdW50IG9mIENQVSByZXNv
dXJjZXMgYW5kIHNob3VsZCBubyBsb25nZXIgYmUgYm9vc3RlZC4KICAgICAgKi8KICAgICBpZiAo
IHN2Yy0+cHJpID09IENTQ0hFRF9QUklfVFNfQk9PU1QgKQogICAgIHsKICAgICAgICAgc3ZjLT5w
cmkgPSBDU0NIRURfUFJJX1RTX1VOREVSOwogICAgICAgICBUUkFDRV8yRChUUkNfQ1NDSEVEX0JP
T1NUX0VORCwgc3ZjLT5zZG9tLT5kb20tPmRvbWFpbl9pZCwKLSAgICAgICAgICAgICAgICAgc3Zj
LT52Y3B1LT52Y3B1X2lkKTsKKyAgICAgICAgICAgICAgICAgc3ZjLT51bml0LT51bml0X2lkKTsK
ICAgICB9CiAKICAgICAvKgpAQCAtOTU3LDEyICs5NjEsMTIgQEAgY3NjaGVkX3ZjcHVfYWNjdChz
dHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBydiwgdW5zaWduZWQgaW50IGNwdSkKICAgICBidXJuX2Ny
ZWRpdHMoc3ZjLCBOT1coKSk7CiAKICAgICAvKgotICAgICAqIFB1dCB0aGlzIFZDUFUgYW5kIGRv
bWFpbiBiYWNrIG9uIHRoZSBhY3RpdmUgbGlzdCBpZiBpdCB3YXMKKyAgICAgKiBQdXQgdGhpcyBV
TklUIGFuZCBkb21haW4gYmFjayBvbiB0aGUgYWN0aXZlIGxpc3QgaWYgaXQgd2FzCiAgICAgICog
aWRsaW5nLgogICAgICAqLwotICAgIGlmICggbGlzdF9lbXB0eSgmc3ZjLT5hY3RpdmVfdmNwdV9l
bGVtKSApCisgICAgaWYgKCBsaXN0X2VtcHR5KCZzdmMtPmFjdGl2ZV91bml0X2VsZW0pICkKICAg
ICB7Ci0gICAgICAgIF9fY3NjaGVkX3ZjcHVfYWNjdF9zdGFydChwcnYsIHN2Yyk7CisgICAgICAg
IF9fY3NjaGVkX3VuaXRfYWNjdF9zdGFydChwcnYsIHN2Yyk7CiAgICAgfQogICAgIGVsc2UKICAg
ICB7CkBAIC05NzUsMTUgKzk3OSwxNSBAQCBjc2NoZWRfdmNwdV9hY2N0KHN0cnVjdCBjc2NoZWRf
cHJpdmF0ZSAqcHJ2LCB1bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICAgKiBtaWdyYXRpbmcgaXQg
dG8gcnVuIGVsc2V3aGVyZSAoc2VlIG11bHRpLWNvcmUgYW5kIG11bHRpLXRocmVhZAogICAgICAg
ICAgKiBzdXBwb3J0IGluIGNzY2hlZF9yZXNfcGljaygpKS4KICAgICAgICAgICovCi0gICAgICAg
IG5ld19jcHUgPSBfY3NjaGVkX2NwdV9waWNrKG9wcywgY3VycmVudCwgMCk7CisgICAgICAgIG5l
d19jcHUgPSBfY3NjaGVkX2NwdV9waWNrKG9wcywgY3VycnVuaXQsIDApOwogCiAgICAgICAgIHVu
aXRfc2NoZWR1bGVfdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIGN1cnJ1bml0KTsKIAog
ICAgICAgICBpZiAoIG5ld19jcHUgIT0gY3B1ICkKICAgICAgICAgewotICAgICAgICAgICAgU0NI
RURfVkNQVV9TVEFUX0NSQU5LKHN2YywgbWlncmF0ZV9yKTsKKyAgICAgICAgICAgIFNDSEVEX1VO
SVRfU1RBVF9DUkFOSyhzdmMsIG1pZ3JhdGVfcik7CiAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NS
QU5LKG1pZ3JhdGVfcnVubmluZyk7Ci0gICAgICAgICAgICBzZXRfYml0KF9WUEZfbWlncmF0aW5n
LCAmY3VycmVudC0+cGF1c2VfZmxhZ3MpOworICAgICAgICAgICAgc2NoZWRfc2V0X3BhdXNlX2Zs
YWdzX2F0b21pYyhjdXJydW5pdCwgX1ZQRl9taWdyYXRpbmcpOwogICAgICAgICAgICAgLyoKICAg
ICAgICAgICAgICAqIEFzIHdlIGFyZSBhYm91dCB0byB0aWNrbGUgY3B1LCB3ZSBzaG91bGQgY2xl
YXIgaXRzIGJpdCBpbgogICAgICAgICAgICAgICogaWRsZXJzLiBCdXQsIGlmIHdlIGFyZSBoZXJl
LCBpdCBtZWFucyB0aGVyZSBpcyBzb21lb25lIHJ1bm5pbmcKQEAgLTEwMDAsMjEgKzEwMDQsMjAg
QEAgc3RhdGljIHZvaWQgKgogY3NjaGVkX2FsbG9jX3ZkYXRhKGNvbnN0IHN0cnVjdCBzY2hlZHVs
ZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCiAgICAgICAgICAgICAgICAgICAgdm9p
ZCAqZGQpCiB7Ci0gICAgc3RydWN0IHZjcHUgKnZjID0gdW5pdC0+dmNwdTsKICAgICBzdHJ1Y3Qg
Y3NjaGVkX3VuaXQgKnN2YzsKIAotICAgIC8qIEFsbG9jYXRlIHBlci1WQ1BVIGluZm8gKi8KKyAg
ICAvKiBBbGxvY2F0ZSBwZXItVU5JVCBpbmZvICovCiAgICAgc3ZjID0geHphbGxvYyhzdHJ1Y3Qg
Y3NjaGVkX3VuaXQpOwogICAgIGlmICggc3ZjID09IE5VTEwgKQogICAgICAgICByZXR1cm4gTlVM
TDsKIAogICAgIElOSVRfTElTVF9IRUFEKCZzdmMtPnJ1bnFfZWxlbSk7Ci0gICAgSU5JVF9MSVNU
X0hFQUQoJnN2Yy0+YWN0aXZlX3ZjcHVfZWxlbSk7CisgICAgSU5JVF9MSVNUX0hFQUQoJnN2Yy0+
YWN0aXZlX3VuaXRfZWxlbSk7CiAgICAgc3ZjLT5zZG9tID0gZGQ7Ci0gICAgc3ZjLT52Y3B1ID0g
dmM7Ci0gICAgc3ZjLT5wcmkgPSBpc19pZGxlX2RvbWFpbih2Yy0+ZG9tYWluKSA/CisgICAgc3Zj
LT51bml0ID0gdW5pdDsKKyAgICBzdmMtPnByaSA9IGlzX2lkbGVfdW5pdCh1bml0KSA/CiAgICAg
ICAgIENTQ0hFRF9QUklfSURMRSA6IENTQ0hFRF9QUklfVFNfVU5ERVI7Ci0gICAgU0NIRURfVkNQ
VV9TVEFUU19SRVNFVChzdmMpOworICAgIFNDSEVEX1VOSVRfU1RBVFNfUkVTRVQoc3ZjKTsKICAg
ICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfYWxsb2MpOwogICAgIHJldHVybiBzdmM7CiB9CkBAIC0x
MDIyLDI0ICsxMDI1LDIxIEBAIGNzY2hlZF9hbGxvY192ZGF0YShjb25zdCBzdHJ1Y3Qgc2NoZWR1
bGVyICpvcHMsIHN0cnVjdCBzY2hlZF91bml0ICp1bml0LAogc3RhdGljIHZvaWQKIGNzY2hlZF91
bml0X2luc2VydChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hlZF91bml0
ICp1bml0KQogewotICAgIHN0cnVjdCB2Y3B1ICp2YyA9IHVuaXQtPnZjcHU7CiAgICAgc3RydWN0
IGNzY2hlZF91bml0ICpzdmMgPSB1bml0LT5wcml2OwogICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAK
LSAgICBCVUdfT04oIGlzX2lkbGVfdmNwdSh2YykgKTsKKyAgICBCVUdfT04oIGlzX2lkbGVfdW5p
dCh1bml0KSApOwogCiAgICAgLyogY3NjaGVkX3Jlc19waWNrKCkgbG9va3MgaW4gdmMtPnByb2Nl
c3NvcidzIHJ1bnEsIHNvIHdlIG5lZWQgdGhlIGxvY2suICovCiAgICAgbG9jayA9IHVuaXRfc2No
ZWR1bGVfbG9ja19pcnEodW5pdCk7CiAKLSAgICB1bml0LT5yZXMgPSBjc2NoZWRfcmVzX3BpY2so
b3BzLCB1bml0KTsKLSAgICB2Yy0+cHJvY2Vzc29yID0gdW5pdC0+cmVzLT5wcm9jZXNzb3I7Cisg
ICAgc2NoZWRfc2V0X3Jlcyh1bml0LCBjc2NoZWRfcmVzX3BpY2sob3BzLCB1bml0KSk7CiAKICAg
ICBzcGluX3VubG9ja19pcnEobG9jayk7CiAKICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2Nr
X2lycSh1bml0KTsKIAotICAgIGlmICggIV9fdmNwdV9vbl9ydW5xKHN2YykgJiYgdmNwdV9ydW5u
YWJsZSh2YykgJiYKLSAgICAgICAgICF2Yy0+c2NoZWRfdW5pdC0+aXNfcnVubmluZyApCisgICAg
aWYgKCAhX191bml0X29uX3J1bnEoc3ZjKSAmJiB1bml0X3J1bm5hYmxlKHVuaXQpICYmICF1bml0
LT5pc19ydW5uaW5nICkKICAgICAgICAgcnVucV9pbnNlcnQoc3ZjKTsKIAogICAgIHVuaXRfc2No
ZWR1bGVfdW5sb2NrX2lycShsb2NrLCB1bml0KTsKQEAgLTEwNjYsMTggKzEwNjYsMTggQEAgY3Nj
aGVkX3VuaXRfcmVtb3ZlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVk
X3VuaXQgKnVuaXQpCiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfcmVtb3ZlKTsKIAotICAg
IEFTU0VSVCghX192Y3B1X29uX3J1bnEoc3ZjKSk7CisgICAgQVNTRVJUKCFfX3VuaXRfb25fcnVu
cShzdmMpKTsKIAotICAgIGlmICggdGVzdF9hbmRfY2xlYXJfYml0KENTQ0hFRF9GTEFHX1ZDUFVf
UEFSS0VELCAmc3ZjLT5mbGFncykgKQorICAgIGlmICggdGVzdF9hbmRfY2xlYXJfYml0KENTQ0hF
RF9GTEFHX1VOSVRfUEFSS0VELCAmc3ZjLT5mbGFncykgKQogICAgIHsKICAgICAgICAgU0NIRURf
U1RBVF9DUkFOSyh1bml0X3VucGFyayk7Ci0gICAgICAgIHZjcHVfdW5wYXVzZShzdmMtPnZjcHUp
OworICAgICAgICB2Y3B1X3VucGF1c2Uoc3ZjLT51bml0LT52Y3B1KTsKICAgICB9CiAKICAgICBz
cGluX2xvY2tfaXJxKCZwcnYtPmxvY2spOwogCi0gICAgaWYgKCAhbGlzdF9lbXB0eSgmc3ZjLT5h
Y3RpdmVfdmNwdV9lbGVtKSApCi0gICAgICAgIF9fY3NjaGVkX3ZjcHVfYWNjdF9zdG9wX2xvY2tl
ZChwcnYsIHN2Yyk7CisgICAgaWYgKCAhbGlzdF9lbXB0eSgmc3ZjLT5hY3RpdmVfdW5pdF9lbGVt
KSApCisgICAgICAgIF9fY3NjaGVkX3VuaXRfYWNjdF9zdG9wX2xvY2tlZChwcnYsIHN2Yyk7CiAK
ICAgICBzcGluX3VubG9ja19pcnEoJnBydi0+bG9jayk7CiAKQEAgLTEwODcsODYgKzEwODcsODUg
QEAgY3NjaGVkX3VuaXRfcmVtb3ZlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0
IHNjaGVkX3VuaXQgKnVuaXQpCiBzdGF0aWMgdm9pZAogY3NjaGVkX3VuaXRfc2xlZXAoY29uc3Qg
c3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIHsKLSAgICBz
dHJ1Y3QgdmNwdSAqdmMgPSB1bml0LT52Y3B1OwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqIGNv
bnN0IHN2YyA9IENTQ0hFRF9VTklUKHVuaXQpOwotICAgIHVuc2lnbmVkIGludCBjcHUgPSB2Yy0+
cHJvY2Vzc29yOworICAgIHVuc2lnbmVkIGludCBjcHUgPSBzY2hlZF91bml0X2NwdSh1bml0KTsK
IAogICAgIFNDSEVEX1NUQVRfQ1JBTksodW5pdF9zbGVlcCk7CiAKLSAgICBCVUdfT04oIGlzX2lk
bGVfdmNwdSh2YykgKTsKKyAgICBCVUdfT04oIGlzX2lkbGVfdW5pdCh1bml0KSApOwogCiAgICAg
aWYgKCBjdXJyX29uX2NwdShjcHUpID09IHVuaXQgKQogICAgIHsKICAgICAgICAgLyoKICAgICAg
ICAgICogV2UgYXJlIGFib3V0IHRvIHRpY2tsZSBjcHUsIHNvIHdlIHNob3VsZCBjbGVhciBpdHMg
Yml0IGluIGlkbGVycy4KLSAgICAgICAgICogQnV0LCB3ZSBhcmUgaGVyZSBiZWNhdXNlIHZjIGlz
IGdvaW5nIHRvIHNsZWVwIHdoaWxlIHJ1bm5pbmcgb24gY3B1LAorICAgICAgICAgKiBCdXQsIHdl
IGFyZSBoZXJlIGJlY2F1c2UgdW5pdCBpcyBnb2luZyB0byBzbGVlcCB3aGlsZSBydW5uaW5nIG9u
IGNwdSwKICAgICAgICAgICogc28gdGhlIGJpdCBtdXN0IGJlIHplcm8gYWxyZWFkeS4KICAgICAg
ICAgICovCiAgICAgICAgIEFTU0VSVCghY3B1bWFza190ZXN0X2NwdShjcHUsIENTQ0hFRF9QUklW
KHBlcl9jcHUoc2NoZWR1bGVyLCBjcHUpKS0+aWRsZXJzKSk7CiAgICAgICAgIGNwdV9yYWlzZV9z
b2Z0aXJxKGNwdSwgU0NIRURVTEVfU09GVElSUSk7CiAgICAgfQotICAgIGVsc2UgaWYgKCBfX3Zj
cHVfb25fcnVucShzdmMpICkKKyAgICBlbHNlIGlmICggX191bml0X29uX3J1bnEoc3ZjKSApCiAg
ICAgICAgIHJ1bnFfcmVtb3ZlKHN2Yyk7CiB9CiAKIHN0YXRpYyB2b2lkCiBjc2NoZWRfdW5pdF93
YWtlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQp
CiB7Ci0gICAgc3RydWN0IHZjcHUgKnZjID0gdW5pdC0+dmNwdTsKICAgICBzdHJ1Y3QgY3NjaGVk
X3VuaXQgKiBjb25zdCBzdmMgPSBDU0NIRURfVU5JVCh1bml0KTsKICAgICBib29sX3QgbWlncmF0
aW5nOwogCi0gICAgQlVHX09OKCBpc19pZGxlX3ZjcHUodmMpICk7CisgICAgQlVHX09OKCBpc19p
ZGxlX3VuaXQodW5pdCkgKTsKIAotICAgIGlmICggdW5saWtlbHkoY3Vycl9vbl9jcHUodmMtPnBy
b2Nlc3NvcikgPT0gdW5pdCkgKQorICAgIGlmICggdW5saWtlbHkoY3Vycl9vbl9jcHUoc2NoZWRf
dW5pdF9jcHUodW5pdCkpID09IHVuaXQpICkKICAgICB7CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JB
TksodW5pdF93YWtlX3J1bm5pbmcpOwogICAgICAgICByZXR1cm47CiAgICAgfQotICAgIGlmICgg
dW5saWtlbHkoX192Y3B1X29uX3J1bnEoc3ZjKSkgKQorICAgIGlmICggdW5saWtlbHkoX191bml0
X29uX3J1bnEoc3ZjKSkgKQogICAgIHsKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0X3dh
a2Vfb25ydW5xKTsKICAgICAgICAgcmV0dXJuOwogICAgIH0KIAotICAgIGlmICggbGlrZWx5KHZj
cHVfcnVubmFibGUodmMpKSApCisgICAgaWYgKCBsaWtlbHkodW5pdF9ydW5uYWJsZSh1bml0KSkg
KQogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfd2FrZV9ydW5uYWJsZSk7CiAgICAgZWxz
ZQogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfd2FrZV9ub3RfcnVubmFibGUpOwogCiAg
ICAgLyoKLSAgICAgKiBXZSB0ZW1wb3Jhcmx5IGJvb3N0IHRoZSBwcmlvcml0eSBvZiBhd2FraW5n
IFZDUFVzIQorICAgICAqIFdlIHRlbXBvcmFyaWx5IGJvb3N0IHRoZSBwcmlvcml0eSBvZiBhd2Fr
aW5nIFVOSVRzIQogICAgICAqCi0gICAgICogSWYgdGhpcyBWQ1BVIGNvbnN1bWVzIGEgbm9uIG5l
Z2xpZ2VhYmxlIGFtb3VudCBvZiBDUFUsIGl0CisgICAgICogSWYgdGhpcyBVTklUIGNvbnN1bWVz
IGEgbm9uIG5lZ2xpZ2libGUgYW1vdW50IG9mIENQVSwgaXQKICAgICAgKiB3aWxsIGV2ZW50dWFs
bHkgZmluZCBpdHNlbGYgaW4gdGhlIGNyZWRpdCBhY2NvdW50aW5nIGNvZGUKICAgICAgKiBwYXRo
IHdoZXJlIGl0cyBwcmlvcml0eSB3aWxsIGJlIHJlc2V0IHRvIG5vcm1hbC4KICAgICAgKgotICAg
ICAqIElmIG9uIHRoZSBvdGhlciBoYW5kIHRoZSBWQ1BVIGNvbnN1bWVzIGxpdHRsZSBDUFUgYW5k
IGlzCisgICAgICogSWYgb24gdGhlIG90aGVyIGhhbmQgdGhlIFVOSVQgY29uc3VtZXMgbGl0dGxl
IENQVSBhbmQgaXMKICAgICAgKiBibG9ja2luZyBhbmQgYXdva2VuIGEgbG90IChkb2luZyBJL08g
Zm9yIGV4YW1wbGUpLCBpdHMKICAgICAgKiBwcmlvcml0eSB3aWxsIHJlbWFpbiBib29zdGVkLCBv
cHRpbWl6aW5nIGl0J3Mgd2FrZS10by1ydW4KICAgICAgKiBsYXRlbmNpZXMuCiAgICAgICoKLSAg
ICAgKiBUaGlzIGFsbG93cyB3YWtlLXRvLXJ1biBsYXRlbmN5IHNlbnNpdGl2ZSBWQ1BVcyB0byBw
cmVlbXB0Ci0gICAgICogbW9yZSBDUFUgcmVzb3VyY2UgaW50ZW5zaXZlIFZDUFVzIHdpdGhvdXQg
aW1wYWN0aW5nIG92ZXJhbGwgCisgICAgICogVGhpcyBhbGxvd3Mgd2FrZS10by1ydW4gbGF0ZW5j
eSBzZW5zaXRpdmUgVU5JVHMgdG8gcHJlZW1wdAorICAgICAqIG1vcmUgQ1BVIHJlc291cmNlIGlu
dGVuc2l2ZSBVTklUcyB3aXRob3V0IGltcGFjdGluZyBvdmVyYWxsCiAgICAgICogc3lzdGVtIGZh
aXJuZXNzLgogICAgICAqCiAgICAgICogVGhlcmUgYXJlIHR3byBjYXNlcywgd2hlbiB3ZSBkb24n
dCB3YW50IHRvIGJvb3N0OgotICAgICAqICAtIFZDUFVzIHRoYXQgYXJlIHdha2luZyB1cCBhZnRl
ciBhIG1pZ3JhdGlvbiwgcmF0aGVyIHRoYW4KKyAgICAgKiAgLSBVTklUcyB0aGF0IGFyZSB3YWtp
bmcgdXAgYWZ0ZXIgYSBtaWdyYXRpb24sIHJhdGhlciB0aGFuCiAgICAgICogICAgYWZ0ZXIgaGF2
aW5nIGJsb2NrOwotICAgICAqICAtIFZDUFVzIG9mIGNhcHBlZCBkb21haW5zIHVucGF1c2luZyBh
ZnRlciBlYXJuaW5nIGNyZWRpdHMKKyAgICAgKiAgLSBVTklUcyBvZiBjYXBwZWQgZG9tYWlucyB1
bnBhdXNpbmcgYWZ0ZXIgZWFybmluZyBjcmVkaXRzCiAgICAgICogICAgdGhleSBoYWQgb3ZlcnNw
ZW50LgogICAgICAqLwotICAgIG1pZ3JhdGluZyA9IHRlc3RfYW5kX2NsZWFyX2JpdChDU0NIRURf
RkxBR19WQ1BVX01JR1JBVElORywgJnN2Yy0+ZmxhZ3MpOworICAgIG1pZ3JhdGluZyA9IHRlc3Rf
YW5kX2NsZWFyX2JpdChDU0NIRURfRkxBR19VTklUX01JR1JBVElORywgJnN2Yy0+ZmxhZ3MpOwog
CiAgICAgaWYgKCAhbWlncmF0aW5nICYmIHN2Yy0+cHJpID09IENTQ0hFRF9QUklfVFNfVU5ERVIg
JiYKLSAgICAgICAgICF0ZXN0X2JpdChDU0NIRURfRkxBR19WQ1BVX1BBUktFRCwgJnN2Yy0+Zmxh
Z3MpICkKKyAgICAgICAgICF0ZXN0X2JpdChDU0NIRURfRkxBR19VTklUX1BBUktFRCwgJnN2Yy0+
ZmxhZ3MpICkKICAgICB7Ci0gICAgICAgIFRSQUNFXzJEKFRSQ19DU0NIRURfQk9PU1RfU1RBUlQs
IHZjLT5kb21haW4tPmRvbWFpbl9pZCwgdmMtPnZjcHVfaWQpOworICAgICAgICBUUkFDRV8yRChU
UkNfQ1NDSEVEX0JPT1NUX1NUQVJULCB1bml0LT5kb21haW4tPmRvbWFpbl9pZCwKKyAgICAgICAg
ICAgICAgICAgdW5pdC0+dW5pdF9pZCk7CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodW5pdF9i
b29zdCk7CiAgICAgICAgIHN2Yy0+cHJpID0gQ1NDSEVEX1BSSV9UU19CT09TVDsKICAgICB9CiAK
LSAgICAvKiBQdXQgdGhlIFZDUFUgb24gdGhlIHJ1bnEgYW5kIHRpY2tsZSBDUFVzICovCisgICAg
LyogUHV0IHRoZSBVTklUIG9uIHRoZSBydW5xIGFuZCB0aWNrbGUgQ1BVcyAqLwogICAgIHJ1bnFf
aW5zZXJ0KHN2Yyk7CiAgICAgX19ydW5xX3RpY2tsZShzdmMpOwogfQpAQCAtMTE3Nyw3ICsxMTc2
LDcgQEAgY3NjaGVkX3VuaXRfeWllbGQoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1
Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKICAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQgKiBjb25zdCBzdmMg
PSBDU0NIRURfVU5JVCh1bml0KTsKIAogICAgIC8qIExldCB0aGUgc2NoZWR1bGVyIGtub3cgdGhh
dCB0aGlzIHZjcHUgaXMgdHJ5aW5nIHRvIHlpZWxkICovCi0gICAgc2V0X2JpdChDU0NIRURfRkxB
R19WQ1BVX1lJRUxELCAmc3ZjLT5mbGFncyk7CisgICAgc2V0X2JpdChDU0NIRURfRkxBR19VTklU
X1lJRUxELCAmc3ZjLT5mbGFncyk7CiB9CiAKIHN0YXRpYyBpbnQKQEAgLTEyMDYsOCArMTIwNSw4
IEBAIGNzY2hlZF9kb21fY250bCgKICAgICAgICAgewogICAgICAgICAgICAgaWYgKCAhbGlzdF9l
bXB0eSgmc2RvbS0+YWN0aXZlX3Nkb21fZWxlbSkgKQogICAgICAgICAgICAgewotICAgICAgICAg
ICAgICAgIHBydi0+d2VpZ2h0IC09IHNkb20tPndlaWdodCAqIHNkb20tPmFjdGl2ZV92Y3B1X2Nv
dW50OwotICAgICAgICAgICAgICAgIHBydi0+d2VpZ2h0ICs9IG9wLT51LmNyZWRpdC53ZWlnaHQg
KiBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudDsKKyAgICAgICAgICAgICAgICBwcnYtPndlaWdodCAt
PSBzZG9tLT53ZWlnaHQgKiBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudDsKKyAgICAgICAgICAgICAg
ICBwcnYtPndlaWdodCArPSBvcC0+dS5jcmVkaXQud2VpZ2h0ICogc2RvbS0+YWN0aXZlX3VuaXRf
Y291bnQ7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgICBzZG9tLT53ZWlnaHQgPSBvcC0+dS5j
cmVkaXQud2VpZ2h0OwogICAgICAgICB9CkBAIC0xMjM2LDkgKzEyMzUsOSBAQCBjc2NoZWRfYWZm
X2NudGwoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5p
dCwKIAogICAgIC8qIEFyZSB3ZSBiZWNvbWluZyBleGNsdXNpdmVseSBwaW5uZWQ/ICovCiAgICAg
aWYgKCBjcHVtYXNrX3dlaWdodChoYXJkKSA9PSAxICkKLSAgICAgICAgc2V0X2JpdChDU0NIRURf
RkxBR19WQ1BVX1BJTk5FRCwgJnN2Yy0+ZmxhZ3MpOworICAgICAgICBzZXRfYml0KENTQ0hFRF9G
TEFHX1VOSVRfUElOTkVELCAmc3ZjLT5mbGFncyk7CiAgICAgZWxzZQotICAgICAgICBjbGVhcl9i
aXQoQ1NDSEVEX0ZMQUdfVkNQVV9QSU5ORUQsICZzdmMtPmZsYWdzKTsKKyAgICAgICAgY2xlYXJf
Yml0KENTQ0hFRF9GTEFHX1VOSVRfUElOTkVELCAmc3ZjLT5mbGFncyk7CiB9CiAKIHN0YXRpYyBp
bmxpbmUgdm9pZApAQCAtMTI4MSwxNCArMTI4MCwxNCBAQCBjc2NoZWRfc3lzX2NudGwoY29uc3Qg
c3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAgICAgICBlbHNlIGlmICggcHJ2LT5yYXRlbGltaXQg
JiYgIXBhcmFtcy0+cmF0ZWxpbWl0X3VzICkKICAgICAgICAgICAgIHByaW50ayhYRU5MT0dfSU5G
TyAiRGlzYWJsaW5nIGNvbnRleHQgc3dpdGNoIHJhdGUgbGltaXRpbmdcbiIpOwogICAgICAgICBw
cnYtPnJhdGVsaW1pdCA9IE1JQ1JPU0VDUyhwYXJhbXMtPnJhdGVsaW1pdF91cyk7Ci0gICAgICAg
IHBydi0+dmNwdV9taWdyX2RlbGF5ID0gTUlDUk9TRUNTKHBhcmFtcy0+dmNwdV9taWdyX2RlbGF5
X3VzKTsKKyAgICAgICAgcHJ2LT51bml0X21pZ3JfZGVsYXkgPSBNSUNST1NFQ1MocGFyYW1zLT52
Y3B1X21pZ3JfZGVsYXlfdXMpOwogICAgICAgICBzcGluX3VubG9ja19pcnFyZXN0b3JlKCZwcnYt
PmxvY2ssIGZsYWdzKTsKIAogICAgICAgICAvKiBGQUxMVEhSVSAqLwogICAgIGNhc2UgWEVOX1NZ
U0NUTF9TQ0hFRE9QX2dldGluZm86CiAgICAgICAgIHBhcmFtcy0+dHNsaWNlX21zID0gcHJ2LT50
c2xpY2UgLyBNSUxMSVNFQ1MoMSk7CiAgICAgICAgIHBhcmFtcy0+cmF0ZWxpbWl0X3VzID0gcHJ2
LT5yYXRlbGltaXQgLyBNSUNST1NFQ1MoMSk7Ci0gICAgICAgIHBhcmFtcy0+dmNwdV9taWdyX2Rl
bGF5X3VzID0gcHJ2LT52Y3B1X21pZ3JfZGVsYXkgLyBNSUNST1NFQ1MoMSk7CisgICAgICAgIHBh
cmFtcy0+dmNwdV9taWdyX2RlbGF5X3VzID0gcHJ2LT51bml0X21pZ3JfZGVsYXkgLyBNSUNST1NF
Q1MoMSk7CiAgICAgICAgIHJjID0gMDsKICAgICAgICAgYnJlYWs7CiAgICAgfQpAQCAtMTMwNiw3
ICsxMzA1LDcgQEAgY3NjaGVkX2FsbG9jX2RvbWRhdGEoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAq
b3BzLCBzdHJ1Y3QgZG9tYWluICpkb20pCiAgICAgICAgIHJldHVybiBFUlJfUFRSKC1FTk9NRU0p
OwogCiAgICAgLyogSW5pdGlhbGl6ZSBjcmVkaXQgYW5kIHdlaWdodCAqLwotICAgIElOSVRfTElT
VF9IRUFEKCZzZG9tLT5hY3RpdmVfdmNwdSk7CisgICAgSU5JVF9MSVNUX0hFQUQoJnNkb20tPmFj
dGl2ZV91bml0KTsKICAgICBJTklUX0xJU1RfSEVBRCgmc2RvbS0+YWN0aXZlX3Nkb21fZWxlbSk7
CiAgICAgc2RvbS0+ZG9tID0gZG9tOwogICAgIHNkb20tPndlaWdodCA9IENTQ0hFRF9ERUZBVUxU
X1dFSUdIVDsKQEAgLTEzMjMsNyArMTMyMiw3IEBAIGNzY2hlZF9mcmVlX2RvbWRhdGEoY29uc3Qg
c3RydWN0IHNjaGVkdWxlciAqb3BzLCB2b2lkICpkYXRhKQogLyoKICAqIFRoaXMgaXMgYSBPKG4p
IG9wdGltaXplZCBzb3J0IG9mIHRoZSBydW5xLgogICoKLSAqIFRpbWUtc2hhcmUgVkNQVXMgY2Fu
IG9ubHkgYmUgb25lIG9mIHR3byBwcmlvcml0aWVzLCBVTkRFUiBvciBPVkVSLiBXZSB3YWxrCisg
KiBUaW1lLXNoYXJlIFVOSVRzIGNhbiBvbmx5IGJlIG9uZSBvZiB0d28gcHJpb3JpdGllcywgVU5E
RVIgb3IgT1ZFUi4gV2Ugd2FsawogICogdGhyb3VnaCB0aGUgcnVucSBhbmQgbW92ZSB1cCBhbnkg
VU5ERVJzIHRoYXQgYXJlIHByZWNlZGVkIGJ5IE9WRVJTLiBXZQogICogcmVtZW1iZXIgdGhlIGxh
c3QgVU5ERVIgdG8gbWFrZSB0aGUgbW92ZSB1cCBvcGVyYXRpb24gTygxKS4KICAqLwpAQCAtMTM3
Niw3ICsxMzc1LDcgQEAgY3NjaGVkX2FjY3Qodm9pZCogZHVtbXkpCiB7CiAgICAgc3RydWN0IGNz
Y2hlZF9wcml2YXRlICpwcnYgPSBkdW1teTsKICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwotICAg
IHN0cnVjdCBsaXN0X2hlYWQgKml0ZXJfdmNwdSwgKm5leHRfdmNwdTsKKyAgICBzdHJ1Y3QgbGlz
dF9oZWFkICppdGVyX3VuaXQsICpuZXh0X3VuaXQ7CiAgICAgc3RydWN0IGxpc3RfaGVhZCAqaXRl
cl9zZG9tLCAqbmV4dF9zZG9tOwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjOwogICAgIHN0
cnVjdCBjc2NoZWRfZG9tICpzZG9tOwpAQCAtMTQyMywyNiArMTQyMiwyNiBAQCBjc2NoZWRfYWNj
dCh2b2lkKiBkdW1teSkKICAgICAgICAgc2RvbSA9IGxpc3RfZW50cnkoaXRlcl9zZG9tLCBzdHJ1
Y3QgY3NjaGVkX2RvbSwgYWN0aXZlX3Nkb21fZWxlbSk7CiAKICAgICAgICAgQlVHX09OKCBpc19p
ZGxlX2RvbWFpbihzZG9tLT5kb20pICk7Ci0gICAgICAgIEJVR19PTiggc2RvbS0+YWN0aXZlX3Zj
cHVfY291bnQgPT0gMCApOworICAgICAgICBCVUdfT04oIHNkb20tPmFjdGl2ZV91bml0X2NvdW50
ID09IDAgKTsKICAgICAgICAgQlVHX09OKCBzZG9tLT53ZWlnaHQgPT0gMCApOwotICAgICAgICBC
VUdfT04oIChzZG9tLT53ZWlnaHQgKiBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudCkgPiB3ZWlnaHRf
bGVmdCApOworICAgICAgICBCVUdfT04oIChzZG9tLT53ZWlnaHQgKiBzZG9tLT5hY3RpdmVfdW5p
dF9jb3VudCkgPiB3ZWlnaHRfbGVmdCApOwogCi0gICAgICAgIHdlaWdodF9sZWZ0IC09ICggc2Rv
bS0+d2VpZ2h0ICogc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQgKTsKKyAgICAgICAgd2VpZ2h0X2xl
ZnQgLT0gKCBzZG9tLT53ZWlnaHQgKiBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCApOwogCiAgICAg
ICAgIC8qCiAgICAgICAgICAqIEEgZG9tYWluJ3MgZmFpciBzaGFyZSBpcyBjb21wdXRlZCB1c2lu
ZyBpdHMgd2VpZ2h0IGluIGNvbXBldGl0aW9uCiAgICAgICAgICAqIHdpdGggdGhhdCBvZiBhbGwg
b3RoZXIgYWN0aXZlIGRvbWFpbnMuCiAgICAgICAgICAqCi0gICAgICAgICAqIEF0IG1vc3QsIGEg
ZG9tYWluIGNhbiB1c2UgY3JlZGl0cyB0byBydW4gYWxsIGl0cyBhY3RpdmUgVkNQVXMKKyAgICAg
ICAgICogQXQgbW9zdCwgYSBkb21haW4gY2FuIHVzZSBjcmVkaXRzIHRvIHJ1biBhbGwgaXRzIGFj
dGl2ZSBVTklUcwogICAgICAgICAgKiBmb3Igb25lIGZ1bGwgYWNjb3VudGluZyBwZXJpb2QuIFdl
IGFsbG93IGEgZG9tYWluIHRvIGVhcm4gbW9yZQogICAgICAgICAgKiBvbmx5IHdoZW4gdGhlIHN5
c3RlbS13aWRlIGNyZWRpdCBiYWxhbmNlIGlzIG5lZ2F0aXZlLgogICAgICAgICAgKi8KLSAgICAg
ICAgY3JlZGl0X3BlYWsgPSBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudCAqIHBydi0+Y3JlZGl0c19w
ZXJfdHNsaWNlOworICAgICAgICBjcmVkaXRfcGVhayA9IHNkb20tPmFjdGl2ZV91bml0X2NvdW50
ICogcHJ2LT5jcmVkaXRzX3Blcl90c2xpY2U7CiAgICAgICAgIGlmICggcHJ2LT5jcmVkaXRfYmFs
YW5jZSA8IDAgKQogICAgICAgICB7CiAgICAgICAgICAgICBjcmVkaXRfcGVhayArPSAoICggLXBy
di0+Y3JlZGl0X2JhbGFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqIHNkb20t
PndlaWdodAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogc2RvbS0+YWN0aXZlX3Zj
cHVfY291bnQpICsKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqIHNkb20tPmFjdGl2
ZV91bml0X2NvdW50KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh3ZWlnaHRfdG90
YWwgLSAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSAvIHdlaWdodF90b3RhbDsKICAg
ICAgICAgfQpAQCAtMTQ1MywxNCArMTQ1MiwxNCBAQCBjc2NoZWRfYWNjdCh2b2lkKiBkdW1teSkK
ICAgICAgICAgICAgIGlmICggY3JlZGl0X2NhcCA8IGNyZWRpdF9wZWFrICkKICAgICAgICAgICAg
ICAgICBjcmVkaXRfcGVhayA9IGNyZWRpdF9jYXA7CiAKLSAgICAgICAgICAgIC8qIEZJWE1FIC0t
IHNldCBjYXAgcGVyLXZjcHUgYXMgd2VsbC4uLj8gKi8KLSAgICAgICAgICAgIGNyZWRpdF9jYXAg
PSAoIGNyZWRpdF9jYXAgKyAoIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50IC0gMSApCi0gICAgICAg
ICAgICAgICAgICAgICAgICAgKSAvIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50OworICAgICAgICAg
ICAgLyogRklYTUUgLS0gc2V0IGNhcCBwZXItdW5pdCBhcyB3ZWxsLi4uPyAqLworICAgICAgICAg
ICAgY3JlZGl0X2NhcCA9ICggY3JlZGl0X2NhcCArICggc2RvbS0+YWN0aXZlX3VuaXRfY291bnQg
LSAxICkKKyAgICAgICAgICAgICAgICAgICAgICAgICApIC8gc2RvbS0+YWN0aXZlX3VuaXRfY291
bnQ7CiAgICAgICAgIH0KIAogICAgICAgICBjcmVkaXRfZmFpciA9ICggKCBjcmVkaXRfdG90YWwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgKiBzZG9tLT53ZWlnaHQKLSAgICAgICAgICAgICAg
ICAgICAgICAgICAgKiBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudCApCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICogc2RvbS0+YWN0aXZlX3VuaXRfY291bnQgKQogICAgICAgICAgICAgICAgICAg
ICAgICAgKyAod2VpZ2h0X3RvdGFsIC0gMSkKICAgICAgICAgICAgICAgICAgICAgICApIC8gd2Vp
Z2h0X3RvdGFsOwogCkBAIC0xNDk0LDE0ICsxNDkzLDE0IEBAIGNzY2hlZF9hY2N0KHZvaWQqIGR1
bW15KQogICAgICAgICAgICAgY3JlZGl0X2ZhaXIgPSBjcmVkaXRfcGVhazsKICAgICAgICAgfQog
Ci0gICAgICAgIC8qIENvbXB1dGUgZmFpciBzaGFyZSBwZXIgVkNQVSAqLwotICAgICAgICBjcmVk
aXRfZmFpciA9ICggY3JlZGl0X2ZhaXIgKyAoIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50IC0gMSAp
Ci0gICAgICAgICAgICAgICAgICAgICAgKSAvIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50OworICAg
ICAgICAvKiBDb21wdXRlIGZhaXIgc2hhcmUgcGVyIFVOSVQgKi8KKyAgICAgICAgY3JlZGl0X2Zh
aXIgPSAoIGNyZWRpdF9mYWlyICsgKCBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCAtIDEgKQorICAg
ICAgICAgICAgICAgICAgICAgICkgLyBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudDsKIAogCi0gICAg
ICAgIGxpc3RfZm9yX2VhY2hfc2FmZSggaXRlcl92Y3B1LCBuZXh0X3ZjcHUsICZzZG9tLT5hY3Rp
dmVfdmNwdSApCisgICAgICAgIGxpc3RfZm9yX2VhY2hfc2FmZSggaXRlcl91bml0LCBuZXh0X3Vu
aXQsICZzZG9tLT5hY3RpdmVfdW5pdCApCiAgICAgICAgIHsKLSAgICAgICAgICAgIHN2YyA9IGxp
c3RfZW50cnkoaXRlcl92Y3B1LCBzdHJ1Y3QgY3NjaGVkX3VuaXQsIGFjdGl2ZV92Y3B1X2VsZW0p
OworICAgICAgICAgICAgc3ZjID0gbGlzdF9lbnRyeShpdGVyX3VuaXQsIHN0cnVjdCBjc2NoZWRf
dW5pdCwgYWN0aXZlX3VuaXRfZWxlbSk7CiAgICAgICAgICAgICBCVUdfT04oIHNkb20gIT0gc3Zj
LT5zZG9tICk7CiAKICAgICAgICAgICAgIC8qIEluY3JlbWVudCBjcmVkaXQgKi8KQEAgLTE1MDks
MjAgKzE1MDgsMjAgQEAgY3NjaGVkX2FjY3Qodm9pZCogZHVtbXkpCiAgICAgICAgICAgICBjcmVk
aXQgPSBhdG9taWNfcmVhZCgmc3ZjLT5jcmVkaXQpOwogCiAgICAgICAgICAgICAvKgotICAgICAg
ICAgICAgICogUmVjb21wdXRlIHByaW9yaXR5IG9yLCBpZiBWQ1BVIGlzIGlkbGluZywgcmVtb3Zl
IGl0IGZyb20KKyAgICAgICAgICAgICAqIFJlY29tcHV0ZSBwcmlvcml0eSBvciwgaWYgVU5JVCBp
cyBpZGxpbmcsIHJlbW92ZSBpdCBmcm9tCiAgICAgICAgICAgICAgKiB0aGUgYWN0aXZlIGxpc3Qu
CiAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgIGlmICggY3JlZGl0IDwgMCApCiAgICAgICAg
ICAgICB7CiAgICAgICAgICAgICAgICAgc3ZjLT5wcmkgPSBDU0NIRURfUFJJX1RTX09WRVI7CiAK
LSAgICAgICAgICAgICAgICAvKiBQYXJrIHJ1bm5pbmcgVkNQVXMgb2YgY2FwcGVkLW91dCBkb21h
aW5zICovCisgICAgICAgICAgICAgICAgLyogUGFyayBydW5uaW5nIFVOSVRzIG9mIGNhcHBlZC1v
dXQgZG9tYWlucyAqLwogICAgICAgICAgICAgICAgIGlmICggc2RvbS0+Y2FwICE9IDBVICYmCiAg
ICAgICAgICAgICAgICAgICAgICBjcmVkaXQgPCAtY3JlZGl0X2NhcCAmJgotICAgICAgICAgICAg
ICAgICAgICAgIXRlc3RfYW5kX3NldF9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9QQVJLRUQsICZzdmMt
PmZsYWdzKSApCisgICAgICAgICAgICAgICAgICAgICAhdGVzdF9hbmRfc2V0X2JpdChDU0NIRURf
RkxBR19VTklUX1BBUktFRCwgJnN2Yy0+ZmxhZ3MpICkKICAgICAgICAgICAgICAgICB7CiAgICAg
ICAgICAgICAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodW5pdF9wYXJrKTsKLSAgICAgICAgICAg
ICAgICAgICAgdmNwdV9wYXVzZV9ub3N5bmMoc3ZjLT52Y3B1KTsKKyAgICAgICAgICAgICAgICAg
ICAgdmNwdV9wYXVzZV9ub3N5bmMoc3ZjLT51bml0LT52Y3B1KTsKICAgICAgICAgICAgICAgICB9
CiAKICAgICAgICAgICAgICAgICAvKiBMb3dlciBib3VuZCBvbiBjcmVkaXRzICovCkBAIC0xNTM4
LDIyICsxNTM3LDIyIEBAIGNzY2hlZF9hY2N0KHZvaWQqIGR1bW15KQogICAgICAgICAgICAgICAg
IHN2Yy0+cHJpID0gQ1NDSEVEX1BSSV9UU19VTkRFUjsKIAogICAgICAgICAgICAgICAgIC8qIFVu
cGFyayBhbnkgY2FwcGVkIGRvbWFpbnMgd2hvc2UgY3JlZGl0cyBnbyBwb3NpdGl2ZSAqLwotICAg
ICAgICAgICAgICAgIGlmICggdGVzdF9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9QQVJLRUQsICZzdmMt
PmZsYWdzKSApCisgICAgICAgICAgICAgICAgaWYgKCB0ZXN0X2JpdChDU0NIRURfRkxBR19VTklU
X1BBUktFRCwgJnN2Yy0+ZmxhZ3MpICkKICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAg
ICAgICAgIC8qCiAgICAgICAgICAgICAgICAgICAgICAqIEl0J3MgaW1wb3J0YW50IHRvIHVuc2V0
IHRoZSBmbGFnIEFGVEVSIHRoZSB1bnBhdXNlKCkKLSAgICAgICAgICAgICAgICAgICAgICogY2Fs
bCB0byBtYWtlIHN1cmUgdGhlIFZDUFUncyBwcmlvcml0eSBpcyBub3QgYm9vc3RlZAorICAgICAg
ICAgICAgICAgICAgICAgKiBjYWxsIHRvIG1ha2Ugc3VyZSB0aGUgVU5JVCdzIHByaW9yaXR5IGlz
IG5vdCBib29zdGVkCiAgICAgICAgICAgICAgICAgICAgICAqIGlmIGl0IGlzIHdva2VuIHVwIGhl
cmUuCiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICBTQ0hFRF9T
VEFUX0NSQU5LKHVuaXRfdW5wYXJrKTsKLSAgICAgICAgICAgICAgICAgICAgdmNwdV91bnBhdXNl
KHN2Yy0+dmNwdSk7Ci0gICAgICAgICAgICAgICAgICAgIGNsZWFyX2JpdChDU0NIRURfRkxBR19W
Q1BVX1BBUktFRCwgJnN2Yy0+ZmxhZ3MpOworICAgICAgICAgICAgICAgICAgICB2Y3B1X3VucGF1
c2Uoc3ZjLT51bml0LT52Y3B1KTsKKyAgICAgICAgICAgICAgICAgICAgY2xlYXJfYml0KENTQ0hF
RF9GTEFHX1VOSVRfUEFSS0VELCAmc3ZjLT5mbGFncyk7CiAgICAgICAgICAgICAgICAgfQogCi0g
ICAgICAgICAgICAgICAgLyogVXBwZXIgYm91bmQgb24gY3JlZGl0cyBtZWFucyBWQ1BVIHN0b3Bz
IGVhcm5pbmcgKi8KKyAgICAgICAgICAgICAgICAvKiBVcHBlciBib3VuZCBvbiBjcmVkaXRzIG1l
YW5zIFVOSVQgc3RvcHMgZWFybmluZyAqLwogICAgICAgICAgICAgICAgIGlmICggY3JlZGl0ID4g
cHJ2LT5jcmVkaXRzX3Blcl90c2xpY2UgKQogICAgICAgICAgICAgICAgIHsKLSAgICAgICAgICAg
ICAgICAgICAgX19jc2NoZWRfdmNwdV9hY2N0X3N0b3BfbG9ja2VkKHBydiwgc3ZjKTsKKyAgICAg
ICAgICAgICAgICAgICAgX19jc2NoZWRfdW5pdF9hY2N0X3N0b3BfbG9ja2VkKHBydiwgc3ZjKTsK
ICAgICAgICAgICAgICAgICAgICAgLyogRGl2aWRlIGNyZWRpdHMgaW4gaGFsZiwgc28gdGhhdCB3
aGVuIGl0IHN0YXJ0cwogICAgICAgICAgICAgICAgICAgICAgKiBhY2NvdW50aW5nIGFnYWluLCBp
dCBzdGFydHMgYSBsaXR0bGUgYml0ICJhaGVhZCIgKi8KICAgICAgICAgICAgICAgICAgICAgY3Jl
ZGl0IC89IDI7CkBAIC0xNTYxLDggKzE1NjAsOCBAQCBjc2NoZWRfYWNjdCh2b2lkKiBkdW1teSkK
ICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICB9CiAKLSAgICAgICAgICAgIFNDSEVEX1ZD
UFVfU1RBVF9TRVQoc3ZjLCBjcmVkaXRfbGFzdCwgY3JlZGl0KTsKLSAgICAgICAgICAgIFNDSEVE
X1ZDUFVfU1RBVF9TRVQoc3ZjLCBjcmVkaXRfaW5jciwgY3JlZGl0X2ZhaXIpOworICAgICAgICAg
ICAgU0NIRURfVU5JVF9TVEFUX1NFVChzdmMsIGNyZWRpdF9sYXN0LCBjcmVkaXQpOworICAgICAg
ICAgICAgU0NIRURfVU5JVF9TVEFUX1NFVChzdmMsIGNyZWRpdF9pbmNyLCBjcmVkaXRfZmFpcik7
CiAgICAgICAgICAgICBjcmVkaXRfYmFsYW5jZSArPSBjcmVkaXQ7CiAgICAgICAgIH0KICAgICB9
CkBAIC0xNTg4LDEwICsxNTg3LDEwIEBAIGNzY2hlZF90aWNrKHZvaWQgKl9jcHUpCiAgICAgc3Bj
LT50aWNrKys7CiAKICAgICAvKgotICAgICAqIEFjY291bnRpbmcgZm9yIHJ1bm5pbmcgVkNQVQor
ICAgICAqIEFjY291bnRpbmcgZm9yIHJ1bm5pbmcgVU5JVAogICAgICAqLwotICAgIGlmICggIWlz
X2lkbGVfdmNwdShjdXJyZW50KSApCi0gICAgICAgIGNzY2hlZF92Y3B1X2FjY3QocHJ2LCBjcHUp
OworICAgIGlmICggIWlzX2lkbGVfdW5pdChjdXJyZW50LT5zY2hlZF91bml0KSApCisgICAgICAg
IGNzY2hlZF91bml0X2FjY3QocHJ2LCBjcHUpOwogCiAgICAgLyoKICAgICAgKiBDaGVjayBpZiBy
dW5xIG5lZWRzIHRvIGJlIHNvcnRlZApAQCAtMTYxMiw3ICsxNjExLDcgQEAgY3NjaGVkX3J1bnFf
c3RlYWwoaW50IHBlZXJfY3B1LCBpbnQgY3B1LCBpbnQgcHJpLCBpbnQgYmFsYW5jZV9zdGVwKQog
ICAgIGNvbnN0IHN0cnVjdCBjc2NoZWRfcGNwdSAqIGNvbnN0IHBlZXJfcGNwdSA9IENTQ0hFRF9Q
Q1BVKHBlZXJfY3B1KTsKICAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnNwZWVyOwogICAgIHN0cnVj
dCBsaXN0X2hlYWQgKml0ZXI7Ci0gICAgc3RydWN0IHZjcHUgKnZjOworICAgIHN0cnVjdCBzY2hl
ZF91bml0ICp1bml0OwogCiAgICAgQVNTRVJUKHBlZXJfcGNwdSAhPSBOVUxMKTsKIApAQCAtMTYy
MCw3ICsxNjE5LDcgQEAgY3NjaGVkX3J1bnFfc3RlYWwoaW50IHBlZXJfY3B1LCBpbnQgY3B1LCBp
bnQgcHJpLCBpbnQgYmFsYW5jZV9zdGVwKQogICAgICAqIERvbid0IHN0ZWFsIGZyb20gYW4gaWRs
ZSBDUFUncyBydW5xIGJlY2F1c2UgaXQncyBhYm91dCB0bwogICAgICAqIHBpY2sgdXAgd29yayBm
cm9tIGl0IGl0c2VsZi4KICAgICAgKi8KLSAgICBpZiAoIHVubGlrZWx5KGlzX2lkbGVfdmNwdShj
dXJyX29uX2NwdShwZWVyX2NwdSktPnZjcHUpKSApCisgICAgaWYgKCB1bmxpa2VseShpc19pZGxl
X3VuaXQoY3Vycl9vbl9jcHUocGVlcl9jcHUpKSkgKQogICAgICAgICBnb3RvIG91dDsKIAogICAg
IGxpc3RfZm9yX2VhY2goIGl0ZXIsICZwZWVyX3BjcHUtPnJ1bnEgKQpAQCAtMTYyOCw0NiArMTYy
Nyw0NCBAQCBjc2NoZWRfcnVucV9zdGVhbChpbnQgcGVlcl9jcHUsIGludCBjcHUsIGludCBwcmks
IGludCBiYWxhbmNlX3N0ZXApCiAgICAgICAgIHNwZWVyID0gX19ydW5xX2VsZW0oaXRlcik7CiAK
ICAgICAgICAgLyoKLSAgICAgICAgICogSWYgbmV4dCBhdmFpbGFibGUgVkNQVSBoZXJlIGlzIG5v
dCBvZiBzdHJpY3RseSBoaWdoZXIKKyAgICAgICAgICogSWYgbmV4dCBhdmFpbGFibGUgVU5JVCBo
ZXJlIGlzIG5vdCBvZiBzdHJpY3RseSBoaWdoZXIKICAgICAgICAgICogcHJpb3JpdHkgdGhhbiBv
dXJzLCB0aGlzIFBDUFUgaXMgdXNlbGVzcyB0byB1cy4KICAgICAgICAgICovCiAgICAgICAgIGlm
ICggc3BlZXItPnByaSA8PSBwcmkgKQogICAgICAgICAgICAgYnJlYWs7CiAKLSAgICAgICAgLyog
SXMgdGhpcyBWQ1BVIHJ1bm5hYmxlIG9uIG91ciBQQ1BVPyAqLwotICAgICAgICB2YyA9IHNwZWVy
LT52Y3B1OwotICAgICAgICBCVUdfT04oIGlzX2lkbGVfdmNwdSh2YykgKTsKKyAgICAgICAgLyog
SXMgdGhpcyBVTklUIHJ1bm5hYmxlIG9uIG91ciBQQ1BVPyAqLworICAgICAgICB1bml0ID0gc3Bl
ZXItPnVuaXQ7CisgICAgICAgIEJVR19PTiggaXNfaWRsZV91bml0KHVuaXQpICk7CiAKICAgICAg
ICAgLyoKLSAgICAgICAgICogSWYgdGhlIHZjcHUgaXMgc3RpbGwgaW4gcGVlcl9jcHUncyBzY2hl
ZHVsaW5nIHRhaWwsIG9yIGlmIGl0CisgICAgICAgICAqIElmIHRoZSB1bml0IGlzIHN0aWxsIGlu
IHBlZXJfY3B1J3Mgc2NoZWR1bGluZyB0YWlsLCBvciBpZiBpdAogICAgICAgICAgKiBoYXMgbm8g
dXNlZnVsIHNvZnQgYWZmaW5pdHksIHNraXAgaXQuCiAgICAgICAgICAqCiAgICAgICAgICAqIElu
IGZhY3QsIHdoYXQgd2Ugd2FudCBpcyB0byBjaGVjayBpZiB3ZSBoYXZlIGFueSAic29mdC1hZmZp
bmUKICAgICAgICAgICogd29yayIgdG8gc3RlYWwsIGJlZm9yZSBzdGFydGluZyB0byBsb29rIGF0
ICJoYXJkLWFmZmluZSB3b3JrIi4KICAgICAgICAgICoKLSAgICAgICAgICogTm90aWNlIHRoYXQs
IGlmIG5vdCBldmVuIG9uZSB2Q1BVIG9uIHRoaXMgcnVucSBoYXMgYSB1c2VmdWwKKyAgICAgICAg
ICogTm90aWNlIHRoYXQsIGlmIG5vdCBldmVuIG9uZSB1bml0IG9uIHRoaXMgcnVucSBoYXMgYSB1
c2VmdWwKICAgICAgICAgICogc29mdCBhZmZpbml0eSwgd2UgY291bGQgaGF2ZSBhdm9pZCBjb25z
aWRlcmluZyB0aGlzIHJ1bnEgZm9yCiAgICAgICAgICAqIGEgc29mdCBiYWxhbmNpbmcgc3RlcCBp
biB0aGUgZmlyc3QgcGxhY2UuIFRoaXMsIGZvciBpbnN0YW5jZSwKICAgICAgICAgICogY2FuIGJl
IGltcGxlbWVudGVkIGJ5IHRha2luZyBub3RlIG9mIG9uIHdoYXQgcnVucSB0aGVyZSBhcmUKLSAg
ICAgICAgICogdkNQVXMgd2l0aCB1c2VmdWwgc29mdCBhZmZpbml0aWVzIGluIHNvbWUgc29ydCBv
ZiBiaXRtYXAKKyAgICAgICAgICogdW5pdHMgd2l0aCB1c2VmdWwgc29mdCBhZmZpbml0aWVzIGlu
IHNvbWUgc29ydCBvZiBiaXRtYXAKICAgICAgICAgICogb3IgY291bnRlci4KICAgICAgICAgICov
Ci0gICAgICAgIGlmICggdmMtPnNjaGVkX3VuaXQtPmlzX3J1bm5pbmcgfHwKLSAgICAgICAgICAg
ICAoYmFsYW5jZV9zdGVwID09IEJBTEFOQ0VfU09GVF9BRkZJTklUWSAmJgotICAgICAgICAgICAg
ICAhaGFzX3NvZnRfYWZmaW5pdHkodmMtPnNjaGVkX3VuaXQpKSApCisgICAgICAgIGlmICggdW5p
dC0+aXNfcnVubmluZyB8fCAoYmFsYW5jZV9zdGVwID09IEJBTEFOQ0VfU09GVF9BRkZJTklUWSAm
JgorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICFoYXNfc29mdF9hZmZpbml0eSh1
bml0KSkgKQogICAgICAgICAgICAgY29udGludWU7CiAKLSAgICAgICAgYWZmaW5pdHlfYmFsYW5j
ZV9jcHVtYXNrKHZjLT5zY2hlZF91bml0LCBiYWxhbmNlX3N0ZXAsIGNwdW1hc2tfc2NyYXRjaCk7
Ci0gICAgICAgIGlmICggX19jc2NoZWRfdmNwdV9pc19taWdyYXRlYWJsZShwcnYsIHZjLCBjcHUs
IGNwdW1hc2tfc2NyYXRjaCkgKQorICAgICAgICBhZmZpbml0eV9iYWxhbmNlX2NwdW1hc2sodW5p
dCwgYmFsYW5jZV9zdGVwLCBjcHVtYXNrX3NjcmF0Y2gpOworICAgICAgICBpZiAoIF9fY3NjaGVk
X3VuaXRfaXNfbWlncmF0ZWFibGUocHJ2LCB1bml0LCBjcHUsIGNwdW1hc2tfc2NyYXRjaCkgKQog
ICAgICAgICB7CiAgICAgICAgICAgICAvKiBXZSBnb3QgYSBjYW5kaWRhdGUuIEdyYWIgaXQhICov
Ci0gICAgICAgICAgICBUUkFDRV8zRChUUkNfQ1NDSEVEX1NUT0xFTl9WQ1BVLCBwZWVyX2NwdSwK
LSAgICAgICAgICAgICAgICAgICAgIHZjLT5kb21haW4tPmRvbWFpbl9pZCwgdmMtPnZjcHVfaWQp
OwotICAgICAgICAgICAgU0NIRURfVkNQVV9TVEFUX0NSQU5LKHNwZWVyLCBtaWdyYXRlX3EpOwor
ICAgICAgICAgICAgVFJBQ0VfM0QoVFJDX0NTQ0hFRF9TVE9MRU5fVU5JVCwgcGVlcl9jcHUsCisg
ICAgICAgICAgICAgICAgICAgICB1bml0LT5kb21haW4tPmRvbWFpbl9pZCwgdW5pdC0+dW5pdF9p
ZCk7CisgICAgICAgICAgICBTQ0hFRF9VTklUX1NUQVRfQ1JBTksoc3BlZXIsIG1pZ3JhdGVfcSk7
CiAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3JhdGVfcXVldWVkKTsKLSAgICAgICAg
ICAgIFdBUk5fT04odmMtPmlzX3VyZ2VudCk7CiAgICAgICAgICAgICBydW5xX3JlbW92ZShzcGVl
cik7Ci0gICAgICAgICAgICBzY2hlZF9zZXRfcmVzKHZjLT5zY2hlZF91bml0LCBnZXRfc2NoZWRf
cmVzKGNwdSkpOworICAgICAgICAgICAgc2NoZWRfc2V0X3Jlcyh1bml0LCBnZXRfc2NoZWRfcmVz
KGNwdSkpOwogICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAqIHNwZWVyIHdpbGwgc3RhcnQg
ZXhlY3V0aW5nIGRpcmVjdGx5IG9uIGNwdSwgd2l0aG91dCBoYXZpbmcgdG8KICAgICAgICAgICAg
ICAqIGdvIHRocm91Z2ggcnVucV9pbnNlcnQoKS4gU28gd2UgbXVzdCB1cGRhdGUgdGhlIHJ1bm5h
YmxlIGNvdW50CkBAIC0xNjkzLDcgKzE2OTAsNyBAQCBjc2NoZWRfbG9hZF9iYWxhbmNlKHN0cnVj
dCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCBpbnQgY3B1LAogICAgIGludCBwZWVyX2NwdSwgZmlyc3Rf
Y3B1LCBwZWVyX25vZGUsIGJzdGVwOwogICAgIGludCBub2RlID0gY3B1X3RvX25vZGUoY3B1KTsK
IAotICAgIEJVR19PTiggY3B1ICE9IHNuZXh0LT52Y3B1LT5wcm9jZXNzb3IgKTsKKyAgICBCVUdf
T04oIGNwdSAhPSBzY2hlZF91bml0X2NwdShzbmV4dC0+dW5pdCkgKTsKICAgICBvbmxpbmUgPSBj
cHVwb29sX29ubGluZV9jcHVtYXNrKGMpOwogCiAgICAgLyoKQEAgLTE3MjIsNyArMTcxOSw3IEBA
IGNzY2hlZF9sb2FkX2JhbGFuY2Uoc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIGludCBjcHUs
CiAgICAgICAgIC8qCiAgICAgICAgICAqIFdlIHBlZWsgYXQgdGhlIG5vbi1pZGxpbmcgQ1BVcyBp
biBhIG5vZGUtd2lzZSBmYXNoaW9uLiBJbiBmYWN0LAogICAgICAgICAgKiBpdCBpcyBtb3JlIGxp
a2VseSB0aGF0IHdlIGZpbmQgc29tZSBhZmZpbmUgd29yayBvbiBvdXIgc2FtZQotICAgICAgICAg
KiBub2RlLCBub3QgdG8gbWVudGlvbiB0aGF0IG1pZ3JhdGluZyB2Y3B1cyB3aXRoaW4gdGhlIHNh
bWUgbm9kZQorICAgICAgICAgKiBub2RlLCBub3QgdG8gbWVudGlvbiB0aGF0IG1pZ3JhdGluZyB1
bml0cyB3aXRoaW4gdGhlIHNhbWUgbm9kZQogICAgICAgICAgKiBjb3VsZCB3ZWxsIGV4cGVjdGVk
IHRvIGJlIGNoZWFwZXIgdGhhbiBhY3Jvc3Mtbm9kZXMgKG1lbW9yeQogICAgICAgICAgKiBzdGF5
cyBsb2NhbCwgdGhlcmUgbWlnaHQgYmUgc29tZSBub2RlLXdpZGUgY2FjaGVbc10sIGV0Yy4pLgog
ICAgICAgICAgKi8KQEAgLTE3NDMsNyArMTc0MCw3IEBAIGNzY2hlZF9sb2FkX2JhbGFuY2Uoc3Ry
dWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIGludCBjcHUsCiAgICAgICAgICAgICAgICAgc3Bpbmxv
Y2tfdCAqbG9jazsKIAogICAgICAgICAgICAgICAgIC8qCi0gICAgICAgICAgICAgICAgICogSWYg
dGhlcmUgaXMgb25seSBvbmUgcnVubmFibGUgdkNQVSBvbiBwZWVyX2NwdSwgaXQgbWVhbnMKKyAg
ICAgICAgICAgICAgICAgKiBJZiB0aGVyZSBpcyBvbmx5IG9uZSBydW5uYWJsZSB1bml0IG9uIHBl
ZXJfY3B1LCBpdCBtZWFucwogICAgICAgICAgICAgICAgICAqIHRoZXJlJ3Mgbm8gb25lIHRvIGJl
IHN0b2xlbiBpbiBpdHMgcnVucXVldWUsIHNvIHNraXAgaXQuCiAgICAgICAgICAgICAgICAgICoK
ICAgICAgICAgICAgICAgICAgKiBDaGVja2luZyB0aGlzIHdpdGhvdXQgaG9sZGluZyB0aGUgbG9j
ayBpcyByYWN5Li4uIEJ1dCB0aGF0J3MKQEAgLTE3NTYsMTMgKzE3NTMsMTMgQEAgY3NjaGVkX2xv
YWRfYmFsYW5jZShzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBydiwgaW50IGNwdSwKICAgICAgICAg
ICAgICAgICAgKiAgIEFuZCB3ZSBjYW4gYXZvaWQgdGhhdCBieSByZS1jaGVja2luZyBucl9ydW5u
YWJsZSBhZnRlcgogICAgICAgICAgICAgICAgICAqICAgaGF2aW5nIGdyYWJiZWQgdGhlIGxvY2ss
IGlmIHdlIHdhbnQ7CiAgICAgICAgICAgICAgICAgICogLSBpZiB3ZSByYWNlIHdpdGggaW5jX25y
X3J1bm5hYmxlKCksIHdlIHNraXAgYSBwQ1BVIHRoYXQgbWF5Ci0gICAgICAgICAgICAgICAgICog
ICBoYXZlIHJ1bm5hYmxlIHZDUFVzIGluIGl0cyBydW5xdWV1ZSwgYnV0IHRoYXQncyBub3QgYQor
ICAgICAgICAgICAgICAgICAqICAgaGF2ZSBydW5uYWJsZSB1bml0cyBpbiBpdHMgcnVucXVldWUs
IGJ1dCB0aGF0J3Mgbm90IGEKICAgICAgICAgICAgICAgICAgKiAgIHByb2JsZW0gYmVjYXVzZToK
ICAgICAgICAgICAgICAgICAgKiAgICsgaWYgcmFjaW5nIHdpdGggY3NjaGVkX3VuaXRfaW5zZXJ0
KCkgb3IgY3NjaGVkX3VuaXRfd2FrZSgpLAotICAgICAgICAgICAgICAgICAqICAgICBfX3J1bnFf
dGlja2xlKCkgd2lsbCBiZSBjYWxsZWQgYWZ0ZXJ3b3Jkcywgc28gdGhlIHZDUFUKKyAgICAgICAg
ICAgICAgICAgKiAgICAgX19ydW5xX3RpY2tsZSgpIHdpbGwgYmUgY2FsbGVkIGFmdGVyd29yZHMs
IHNvIHRoZSB1bml0CiAgICAgICAgICAgICAgICAgICogICAgIHdvbid0IGdldCBzdHVjayBpbiB0
aGUgcnVucXVldWUgZm9yIHRvbyBsb25nOwotICAgICAgICAgICAgICAgICAqICAgKyBpZiByYWNp
bmcgd2l0aCBjc2NoZWRfcnVucV9zdGVhbCgpLCBpdCBtYXkgYmUgdGhhdCBhCi0gICAgICAgICAg
ICAgICAgICogICAgIHZDUFUgdGhhdCB3ZSBjb3VsZCBoYXZlIHBpY2tlZCB1cCwgc3RheXMgaW4g
YSBydW5xdWV1ZQorICAgICAgICAgICAgICAgICAqICAgKyBpZiByYWNpbmcgd2l0aCBjc2NoZWRf
cnVucV9zdGVhbCgpLCBpdCBtYXkgYmUgdGhhdCBhbgorICAgICAgICAgICAgICAgICAqICAgICB1
bml0IHRoYXQgd2UgY291bGQgaGF2ZSBwaWNrZWQgdXAsIHN0YXlzIGluIGEgcnVucXVldWUKICAg
ICAgICAgICAgICAgICAgKiAgICAgdW50aWwgc29tZW9uZSBlbHNlIHRyaWVzIHRvIHN0ZWFsIGl0
IGFnYWluLiBCdXQgdGhpcyBpcwogICAgICAgICAgICAgICAgICAqICAgICBubyB3b3JzZSB0aGFu
IHdoYXQgY2FuIGhhcHBlbiBhbHJlYWR5ICh3aXRob3V0IHRoaXMKICAgICAgICAgICAgICAgICAg
KiAgICAgb3B0aW1pemF0aW9uKSwgaXQgdGhlIHBDUFUgd291bGQgc2NoZWR1bGUgcmlnaHQgYWZ0
ZXIgd2UKQEAgLTE3OTcsNyArMTc5NCw3IEBAIGNzY2hlZF9sb2FkX2JhbGFuY2Uoc3RydWN0IGNz
Y2hlZF9wcml2YXRlICpwcnYsIGludCBjcHUsCiAgICAgICAgICAgICAgICAgICAgIGNzY2hlZF9y
dW5xX3N0ZWFsKHBlZXJfY3B1LCBjcHUsIHNuZXh0LT5wcmksIGJzdGVwKSA6IE5VTEw7CiAgICAg
ICAgICAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxvY2sobG9jaywgcGVlcl9jcHUpOwogCi0gICAg
ICAgICAgICAgICAgLyogQXMgc29vbiBhcyBvbmUgdmNwdSBpcyBmb3VuZCwgYmFsYW5jaW5nIGVu
ZHMgKi8KKyAgICAgICAgICAgICAgICAvKiBBcyBzb29uIGFzIG9uZSB1bml0IGlzIGZvdW5kLCBi
YWxhbmNpbmcgZW5kcyAqLwogICAgICAgICAgICAgICAgIGlmICggc3BlZXIgIT0gTlVMTCApCiAg
ICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAqc3RvbGVuID0gMTsKQEAgLTE4
MzYsMTQgKzE4MzMsMTUgQEAgY3NjaGVkX3NjaGVkdWxlKAogewogICAgIGNvbnN0IGludCBjcHUg
PSBzbXBfcHJvY2Vzc29yX2lkKCk7CiAgICAgc3RydWN0IGxpc3RfaGVhZCAqIGNvbnN0IHJ1bnEg
PSBSVU5RKGNwdSk7Ci0gICAgc3RydWN0IGNzY2hlZF91bml0ICogY29uc3Qgc2N1cnIgPSBDU0NI
RURfVU5JVChjdXJyZW50LT5zY2hlZF91bml0KTsKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5p
dCA9IGN1cnJlbnQtPnNjaGVkX3VuaXQ7CisgICAgc3RydWN0IGNzY2hlZF91bml0ICogY29uc3Qg
c2N1cnIgPSBDU0NIRURfVU5JVCh1bml0KTsKICAgICBzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBy
diA9IENTQ0hFRF9QUklWKG9wcyk7CiAgICAgc3RydWN0IGNzY2hlZF91bml0ICpzbmV4dDsKICAg
ICBzdHJ1Y3QgdGFza19zbGljZSByZXQ7CiAgICAgc190aW1lX3QgcnVudGltZSwgdHNsaWNlOwog
CiAgICAgU0NIRURfU1RBVF9DUkFOSyhzY2hlZHVsZSk7Ci0gICAgQ1NDSEVEX1ZDUFVfQ0hFQ0so
Y3VycmVudCk7CisgICAgQ1NDSEVEX1VOSVRfQ0hFQ0sodW5pdCk7CiAKICAgICAvKgogICAgICAq
IEhlcmUgaW4gQ3JlZGl0MSBjb2RlLCB3ZSB1c3VhbGx5IGp1c3QgY2FsbCBUUkFDRV9uRCgpIGhl
bHBlcnMsIGFuZApAQCAtMTg1NywzMCArMTg1NSwzMCBAQCBjc2NoZWRfc2NoZWR1bGUoCiAgICAg
ICAgIH0gZDsKICAgICAgICAgZC5jcHUgPSBjcHU7CiAgICAgICAgIGQudGFza2xldCA9IHRhc2ts
ZXRfd29ya19zY2hlZHVsZWQ7Ci0gICAgICAgIGQuaWRsZSA9IGlzX2lkbGVfdmNwdShjdXJyZW50
KTsKKyAgICAgICAgZC5pZGxlID0gaXNfaWRsZV91bml0KHVuaXQpOwogICAgICAgICBfX3RyYWNl
X3ZhcihUUkNfQ1NDSEVEX1NDSEVEVUxFLCAxLCBzaXplb2YoZCksCiAgICAgICAgICAgICAgICAg
ICAgICh1bnNpZ25lZCBjaGFyICopJmQpOwogICAgIH0KIAotICAgIHJ1bnRpbWUgPSBub3cgLSBj
dXJyZW50LT5zY2hlZF91bml0LT5zdGF0ZV9lbnRyeV90aW1lOworICAgIHJ1bnRpbWUgPSBub3cg
LSB1bml0LT5zdGF0ZV9lbnRyeV90aW1lOwogICAgIGlmICggcnVudGltZSA8IDAgKSAvKiBEb2Vz
IHRoaXMgZXZlciBoYXBwZW4/ICovCiAgICAgICAgIHJ1bnRpbWUgPSAwOwogCi0gICAgaWYgKCAh
aXNfaWRsZV92Y3B1KHNjdXJyLT52Y3B1KSApCisgICAgaWYgKCAhaXNfaWRsZV91bml0KHVuaXQp
ICkKICAgICB7Ci0gICAgICAgIC8qIFVwZGF0ZSBjcmVkaXRzIG9mIGEgbm9uLWlkbGUgVkNQVS4g
Ki8KKyAgICAgICAgLyogVXBkYXRlIGNyZWRpdHMgb2YgYSBub24taWRsZSBVTklULiAqLwogICAg
ICAgICBidXJuX2NyZWRpdHMoc2N1cnIsIG5vdyk7CiAgICAgICAgIHNjdXJyLT5zdGFydF90aW1l
IC09IG5vdzsKICAgICB9CiAgICAgZWxzZQogICAgIHsKLSAgICAgICAgLyogUmUtaW5zdGF0ZSBh
IGJvb3N0ZWQgaWRsZSBWQ1BVIGFzIG5vcm1hbC1pZGxlLiAqLworICAgICAgICAvKiBSZS1pbnN0
YXRlIGEgYm9vc3RlZCBpZGxlIFVOSVQgYXMgbm9ybWFsLWlkbGUuICovCiAgICAgICAgIHNjdXJy
LT5wcmkgPSBDU0NIRURfUFJJX0lETEU7CiAgICAgfQogCiAgICAgLyogQ2hvaWNlcywgY2hvaWNl
czoKLSAgICAgKiAtIElmIHdlIGhhdmUgYSB0YXNrbGV0LCB3ZSBuZWVkIHRvIHJ1biB0aGUgaWRs
ZSB2Y3B1IG5vIG1hdHRlciB3aGF0LgotICAgICAqIC0gSWYgc2NoZWQgcmF0ZSBsaW1pdGluZyBp
cyBpbiBlZmZlY3QsIGFuZCB0aGUgY3VycmVudCB2Y3B1IGhhcworICAgICAqIC0gSWYgd2UgaGF2
ZSBhIHRhc2tsZXQsIHdlIG5lZWQgdG8gcnVuIHRoZSBpZGxlIHVuaXQgbm8gbWF0dGVyIHdoYXQu
CisgICAgICogLSBJZiBzY2hlZCByYXRlIGxpbWl0aW5nIGlzIGluIGVmZmVjdCwgYW5kIHRoZSBj
dXJyZW50IHVuaXQgaGFzCiAgICAgICogICBydW4gZm9yIGxlc3MgdGhhbiB0aGF0IGFtb3VudCBv
ZiB0aW1lLCBjb250aW51ZSB0aGUgY3VycmVudCBvbmUsCiAgICAgICogICBidXQgd2l0aCBhIHNo
b3J0ZXIgdGltZXNsaWNlIGFuZCByZXR1cm4gaXQgaW1tZWRpYXRlbHkKICAgICAgKiAtIE90aGVy
d2lzZSwgY2hvc2UgdGhlIG9uZSB3aXRoIHRoZSBoaWdoZXN0IHByaW9yaXR5ICh3aGljaCBtYXkK
QEAgLTE4OTgsMTEgKzE4OTYsMTEgQEAgY3NjaGVkX3NjaGVkdWxlKAogICAgICAqIEluIGZhY3Qs
IGl0IG1heSBiZSB0aGUgY2FzZSB0aGF0IHNjdXJyIGlzIGFib3V0IHRvIHNwaW4sIGFuZCB0aGVy
ZSdzCiAgICAgICogbm8gcG9pbnQgZm9yY2luZyBpdCB0byBkbyBzbyB1bnRpbCByYXRlIGxpbWl0
aW5nIGV4cGlyZXMuCiAgICAgICovCi0gICAgaWYgKCAhdGVzdF9iaXQoQ1NDSEVEX0ZMQUdfVkNQ
VV9ZSUVMRCwgJnNjdXJyLT5mbGFncykKKyAgICBpZiAoICF0ZXN0X2JpdChDU0NIRURfRkxBR19V
TklUX1lJRUxELCAmc2N1cnItPmZsYWdzKQogICAgICAgICAgJiYgIXRhc2tsZXRfd29ya19zY2hl
ZHVsZWQKICAgICAgICAgICYmIHBydi0+cmF0ZWxpbWl0Ci0gICAgICAgICAmJiB2Y3B1X3J1bm5h
YmxlKGN1cnJlbnQpCi0gICAgICAgICAmJiAhaXNfaWRsZV92Y3B1KGN1cnJlbnQpCisgICAgICAg
ICAmJiB1bml0X3J1bm5hYmxlKHVuaXQpCisgICAgICAgICAmJiAhaXNfaWRsZV91bml0KHVuaXQp
CiAgICAgICAgICAmJiBydW50aW1lIDwgcHJ2LT5yYXRlbGltaXQgKQogICAgIHsKICAgICAgICAg
c25leHQgPSBzY3VycjsKQEAgLTE5MjAsMTEgKzE5MTgsMTEgQEAgY3NjaGVkX3NjaGVkdWxlKAog
ICAgICAgICBpZiAoIHVubGlrZWx5KHRiX2luaXRfZG9uZSkgKQogICAgICAgICB7CiAgICAgICAg
ICAgICBzdHJ1Y3QgewotICAgICAgICAgICAgICAgIHVuc2lnbmVkIHZjcHU6MTYsIGRvbToxNjsK
KyAgICAgICAgICAgICAgICB1bnNpZ25lZCB1bml0OjE2LCBkb206MTY7CiAgICAgICAgICAgICAg
ICAgdW5zaWduZWQgcnVudGltZTsKICAgICAgICAgICAgIH0gZDsKLSAgICAgICAgICAgIGQuZG9t
ID0gc2N1cnItPnZjcHUtPmRvbWFpbi0+ZG9tYWluX2lkOwotICAgICAgICAgICAgZC52Y3B1ID0g
c2N1cnItPnZjcHUtPnZjcHVfaWQ7CisgICAgICAgICAgICBkLmRvbSA9IHVuaXQtPmRvbWFpbi0+
ZG9tYWluX2lkOworICAgICAgICAgICAgZC51bml0ID0gdW5pdC0+dW5pdF9pZDsKICAgICAgICAg
ICAgIGQucnVudGltZSA9IHJ1bnRpbWU7CiAgICAgICAgICAgICBfX3RyYWNlX3ZhcihUUkNfQ1ND
SEVEX1JBVEVMSU1JVCwgMSwgc2l6ZW9mKGQpLAogICAgICAgICAgICAgICAgICAgICAgICAgKHVu
c2lnbmVkIGNoYXIgKikmZCk7CkBAIC0xOTM2LDEzICsxOTM0LDEzIEBAIGNzY2hlZF9zY2hlZHVs
ZSgKICAgICB0c2xpY2UgPSBwcnYtPnRzbGljZTsKIAogICAgIC8qCi0gICAgICogU2VsZWN0IG5l
eHQgcnVubmFibGUgbG9jYWwgVkNQVSAoaWUgdG9wIG9mIGxvY2FsIHJ1bnEpCisgICAgICogU2Vs
ZWN0IG5leHQgcnVubmFibGUgbG9jYWwgVU5JVCAoaWUgdG9wIG9mIGxvY2FsIHJ1bnEpCiAgICAg
ICovCi0gICAgaWYgKCB2Y3B1X3J1bm5hYmxlKGN1cnJlbnQpICkKKyAgICBpZiAoIHVuaXRfcnVu
bmFibGUodW5pdCkgKQogICAgICAgICBfX3J1bnFfaW5zZXJ0KHNjdXJyKTsKICAgICBlbHNlCiAg
ICAgewotICAgICAgICBCVUdfT04oIGlzX2lkbGVfdmNwdShjdXJyZW50KSB8fCBsaXN0X2VtcHR5
KHJ1bnEpICk7CisgICAgICAgIEJVR19PTiggaXNfaWRsZV91bml0KHVuaXQpIHx8IGxpc3RfZW1w
dHkocnVucSkgKTsKICAgICAgICAgLyogQ3VycmVudCBoYXMgYmxvY2tlZC4gVXBkYXRlIHRoZSBy
dW5uYWJsZSBjb3VudGVyIGZvciB0aGlzIGNwdS4gKi8KICAgICAgICAgZGVjX25yX3J1bm5hYmxl
KGNwdSk7CiAgICAgfQpAQCAtMTk1MCwyMyArMTk0OCwyMyBAQCBjc2NoZWRfc2NoZWR1bGUoCiAg
ICAgc25leHQgPSBfX3J1bnFfZWxlbShydW5xLT5uZXh0KTsKICAgICByZXQubWlncmF0ZWQgPSAw
OwogCi0gICAgLyogVGFza2xldCB3b3JrICh3aGljaCBydW5zIGluIGlkbGUgVkNQVSBjb250ZXh0
KSBvdmVycmlkZXMgYWxsIGVsc2UuICovCisgICAgLyogVGFza2xldCB3b3JrICh3aGljaCBydW5z
IGluIGlkbGUgVU5JVCBjb250ZXh0KSBvdmVycmlkZXMgYWxsIGVsc2UuICovCiAgICAgaWYgKCB0
YXNrbGV0X3dvcmtfc2NoZWR1bGVkICkKICAgICB7CiAgICAgICAgIFRSQUNFXzBEKFRSQ19DU0NI
RURfU0NIRURfVEFTS0xFVCk7Ci0gICAgICAgIHNuZXh0ID0gQ1NDSEVEX1VOSVQoaWRsZV92Y3B1
W2NwdV0tPnNjaGVkX3VuaXQpOworICAgICAgICBzbmV4dCA9IENTQ0hFRF9VTklUKHNjaGVkX2lk
bGVfdW5pdChjcHUpKTsKICAgICAgICAgc25leHQtPnByaSA9IENTQ0hFRF9QUklfVFNfQk9PU1Q7
CiAgICAgfQogCiAgICAgLyoKICAgICAgKiBDbGVhciBZSUVMRCBmbGFnIGJlZm9yZSBzY2hlZHVs
aW5nIG91dAogICAgICAqLwotICAgIGNsZWFyX2JpdChDU0NIRURfRkxBR19WQ1BVX1lJRUxELCAm
c2N1cnItPmZsYWdzKTsKKyAgICBjbGVhcl9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9ZSUVMRCwgJnNj
dXJyLT5mbGFncyk7CiAKICAgICAvKgogICAgICAqIFNNUCBMb2FkIGJhbGFuY2U6CiAgICAgICoK
LSAgICAgKiBJZiB0aGUgbmV4dCBoaWdoZXN0IHByaW9yaXR5IGxvY2FsIHJ1bm5hYmxlIFZDUFUg
aGFzIGFscmVhZHkgZWF0ZW4KKyAgICAgKiBJZiB0aGUgbmV4dCBoaWdoZXN0IHByaW9yaXR5IGxv
Y2FsIHJ1bm5hYmxlIFVOSVQgaGFzIGFscmVhZHkgZWF0ZW4KICAgICAgKiB0aHJvdWdoIGl0cyBj
cmVkaXRzLCBsb29rIG9uIG90aGVyIFBDUFVzIHRvIHNlZSBpZiB3ZSBoYXZlIG1vcmUKICAgICAg
KiB1cmdlbnQgd29yay4uLiBJZiBub3QsIGNzY2hlZF9sb2FkX2JhbGFuY2UoKSB3aWxsIHJldHVy
biBzbmV4dCwgYnV0CiAgICAgICogYWxyZWFkeSByZW1vdmVkIGZyb20gdGhlIHJ1bnEuCkBAIC0x
OTkwLDMyICsxOTg4LDMyIEBAIGNzY2hlZF9zY2hlZHVsZSgKICAgICAgICAgY3B1bWFza19jbGVh
cl9jcHUoY3B1LCBwcnYtPmlkbGVycyk7CiAgICAgfQogCi0gICAgaWYgKCAhaXNfaWRsZV92Y3B1
KHNuZXh0LT52Y3B1KSApCisgICAgaWYgKCAhaXNfaWRsZV91bml0KHNuZXh0LT51bml0KSApCiAg
ICAgICAgIHNuZXh0LT5zdGFydF90aW1lICs9IG5vdzsKIAogb3V0OgogICAgIC8qCiAgICAgICog
UmV0dXJuIHRhc2sgdG8gcnVuIG5leHQuLi4KICAgICAgKi8KLSAgICByZXQudGltZSA9IChpc19p
ZGxlX3ZjcHUoc25leHQtPnZjcHUpID8KKyAgICByZXQudGltZSA9IChpc19pZGxlX3VuaXQoc25l
eHQtPnVuaXQpID8KICAgICAgICAgICAgICAgICAtMSA6IHRzbGljZSk7Ci0gICAgcmV0LnRhc2sg
PSBzbmV4dC0+dmNwdS0+c2NoZWRfdW5pdDsKKyAgICByZXQudGFzayA9IHNuZXh0LT51bml0Owog
Ci0gICAgQ1NDSEVEX1ZDUFVfQ0hFQ0socmV0LnRhc2stPnZjcHUpOworICAgIENTQ0hFRF9VTklU
X0NIRUNLKHJldC50YXNrKTsKICAgICByZXR1cm4gcmV0OwogfQogCiBzdGF0aWMgdm9pZAotY3Nj
aGVkX2R1bXBfdmNwdShzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKK2NzY2hlZF9kdW1wX3VuaXQo
c3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiB7CiAgICAgc3RydWN0IGNzY2hlZF9kb20gKiBjb25z
dCBzZG9tID0gc3ZjLT5zZG9tOwogCiAgICAgcHJpbnRrKCJbJWkuJWldIHByaT0laSBmbGFncz0l
eCBjcHU9JWkiLAotICAgICAgICAgICAgc3ZjLT52Y3B1LT5kb21haW4tPmRvbWFpbl9pZCwKLSAg
ICAgICAgICAgIHN2Yy0+dmNwdS0+dmNwdV9pZCwKKyAgICAgICAgICAgIHN2Yy0+dW5pdC0+ZG9t
YWluLT5kb21haW5faWQsCisgICAgICAgICAgICBzdmMtPnVuaXQtPnVuaXRfaWQsCiAgICAgICAg
ICAgICBzdmMtPnByaSwKICAgICAgICAgICAgIHN2Yy0+ZmxhZ3MsCi0gICAgICAgICAgICBzdmMt
PnZjcHUtPnByb2Nlc3Nvcik7CisgICAgICAgICAgICBzY2hlZF91bml0X2NwdShzdmMtPnVuaXQp
KTsKIAogICAgIGlmICggc2RvbSApCiAgICAgewpAQCAtMjA0OSw3ICsyMDQ3LDcgQEAgY3NjaGVk
X2R1bXBfcGNwdShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIGludCBjcHUpCiAKICAgICAv
KgogICAgICAqIFdlIG5lZWQgYm90aCBsb2NrczoKLSAgICAgKiAtIGNzY2hlZF9kdW1wX3ZjcHUo
KSB3YW50cyB0byBhY2Nlc3MgZG9tYWlucycgc2NoZWR1bGluZworICAgICAqIC0gY3NjaGVkX2R1
bXBfdW5pdCgpIHdhbnRzIHRvIGFjY2VzcyBkb21haW5zJyBzY2hlZHVsaW5nCiAgICAgICogICBw
YXJhbWV0ZXJzLCB3aGljaCBhcmUgcHJvdGVjdGVkIGJ5IHRoZSBwcml2YXRlIHNjaGVkdWxlciBs
b2NrOwogICAgICAqIC0gd2Ugc2NhbiB0aHJvdWdoIHRoZSBydW5xdWV1ZSwgc28gd2UgbmVlZCB0
aGUgcHJvcGVyIHJ1bnF1ZXVlCiAgICAgICogICBsb2NrICh0aGUgb25lIG9mIHRoZSBydW5xdWV1
ZSBvZiB0aGlzIGNwdSkuCkBAIC0yMDY1LDEyICsyMDYzLDEyIEBAIGNzY2hlZF9kdW1wX3BjcHUo
Y29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBpbnQgY3B1KQogICAgICAgICAgICBucl9jcHVf
aWRzLCBjcHVtYXNrX2JpdHMocGVyX2NwdShjcHVfc2libGluZ19tYXNrLCBjcHUpKSwKICAgICAg
ICAgICAgbnJfY3B1X2lkcywgY3B1bWFza19iaXRzKHBlcl9jcHUoY3B1X2NvcmVfbWFzaywgY3B1
KSkpOwogCi0gICAgLyogY3VycmVudCBWQ1BVIChub3RoaW5nIHRvIHNheSBpZiB0aGF0J3MgdGhl
IGlkbGUgdmNwdSkuICovCisgICAgLyogY3VycmVudCBVTklUIChub3RoaW5nIHRvIHNheSBpZiB0
aGF0J3MgdGhlIGlkbGUgdW5pdCkuICovCiAgICAgc3ZjID0gQ1NDSEVEX1VOSVQoY3Vycl9vbl9j
cHUoY3B1KSk7Ci0gICAgaWYgKCBzdmMgJiYgIWlzX2lkbGVfdmNwdShzdmMtPnZjcHUpICkKKyAg
ICBpZiAoIHN2YyAmJiAhaXNfaWRsZV91bml0KHN2Yy0+dW5pdCkgKQogICAgIHsKICAgICAgICAg
cHJpbnRrKCJcdHJ1bjogIik7Ci0gICAgICAgIGNzY2hlZF9kdW1wX3ZjcHUoc3ZjKTsKKyAgICAg
ICAgY3NjaGVkX2R1bXBfdW5pdChzdmMpOwogICAgIH0KIAogICAgIGxvb3AgPSAwOwpAQCAtMjA4
MCw3ICsyMDc4LDcgQEAgY3NjaGVkX2R1bXBfcGNwdShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpv
cHMsIGludCBjcHUpCiAgICAgICAgIGlmICggc3ZjICkKICAgICAgICAgewogICAgICAgICAgICAg
cHJpbnRrKCJcdCUzZDogIiwgKytsb29wKTsKLSAgICAgICAgICAgIGNzY2hlZF9kdW1wX3ZjcHUo
c3ZjKTsKKyAgICAgICAgICAgIGNzY2hlZF9kdW1wX3VuaXQoc3ZjKTsKICAgICAgICAgfQogICAg
IH0KIApAQCAtMjEyMiwyOSArMjEyMCwyOSBAQCBjc2NoZWRfZHVtcChjb25zdCBzdHJ1Y3Qgc2No
ZWR1bGVyICpvcHMpCiAgICAgICAgICAgIHBydi0+cmF0ZWxpbWl0IC8gTUlDUk9TRUNTKDEpLAog
ICAgICAgICAgICBDU0NIRURfQ1JFRElUU19QRVJfTVNFQywKICAgICAgICAgICAgcHJ2LT50aWNr
c19wZXJfdHNsaWNlLAotICAgICAgICAgICBwcnYtPnZjcHVfbWlncl9kZWxheS8gTUlDUk9TRUNT
KDEpKTsKKyAgICAgICAgICAgcHJ2LT51bml0X21pZ3JfZGVsYXkvIE1JQ1JPU0VDUygxKSk7CiAK
ICAgICBwcmludGsoImlkbGVyczogJSpwYlxuIiwgbnJfY3B1X2lkcywgY3B1bWFza19iaXRzKHBy
di0+aWRsZXJzKSk7CiAKLSAgICBwcmludGsoImFjdGl2ZSB2Y3B1czpcbiIpOworICAgIHByaW50
aygiYWN0aXZlIHVuaXRzOlxuIik7CiAgICAgbG9vcCA9IDA7CiAgICAgbGlzdF9mb3JfZWFjaCgg
aXRlcl9zZG9tLCAmcHJ2LT5hY3RpdmVfc2RvbSApCiAgICAgewogICAgICAgICBzdHJ1Y3QgY3Nj
aGVkX2RvbSAqc2RvbTsKICAgICAgICAgc2RvbSA9IGxpc3RfZW50cnkoaXRlcl9zZG9tLCBzdHJ1
Y3QgY3NjaGVkX2RvbSwgYWN0aXZlX3Nkb21fZWxlbSk7CiAKLSAgICAgICAgbGlzdF9mb3JfZWFj
aCggaXRlcl9zdmMsICZzZG9tLT5hY3RpdmVfdmNwdSApCisgICAgICAgIGxpc3RfZm9yX2VhY2go
IGl0ZXJfc3ZjLCAmc2RvbS0+YWN0aXZlX3VuaXQgKQogICAgICAgICB7CiAgICAgICAgICAgICBz
dHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YzsKICAgICAgICAgICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAK
LSAgICAgICAgICAgIHN2YyA9IGxpc3RfZW50cnkoaXRlcl9zdmMsIHN0cnVjdCBjc2NoZWRfdW5p
dCwgYWN0aXZlX3ZjcHVfZWxlbSk7Ci0gICAgICAgICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9s
b2NrKHN2Yy0+dmNwdS0+c2NoZWRfdW5pdCk7CisgICAgICAgICAgICBzdmMgPSBsaXN0X2VudHJ5
KGl0ZXJfc3ZjLCBzdHJ1Y3QgY3NjaGVkX3VuaXQsIGFjdGl2ZV91bml0X2VsZW0pOworICAgICAg
ICAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9jayhzdmMtPnVuaXQpOwogCiAgICAgICAgICAg
ICBwcmludGsoIlx0JTNkOiAiLCArK2xvb3ApOwotICAgICAgICAgICAgY3NjaGVkX2R1bXBfdmNw
dShzdmMpOworICAgICAgICAgICAgY3NjaGVkX2R1bXBfdW5pdChzdmMpOwogCi0gICAgICAgICAg
ICB1bml0X3NjaGVkdWxlX3VubG9jayhsb2NrLCBzdmMtPnZjcHUtPnNjaGVkX3VuaXQpOworICAg
ICAgICAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2sobG9jaywgc3ZjLT51bml0KTsKICAgICAgICAg
fQogICAgIH0KIApAQCAtMjIxOCw3ICsyMjE2LDcgQEAgY3NjaGVkX2luaXQoc3RydWN0IHNjaGVk
dWxlciAqb3BzKQogICAgIGVsc2UKICAgICAgICAgcHJ2LT5yYXRlbGltaXQgPSBNSUNST1NFQ1Mo
c2NoZWRfcmF0ZWxpbWl0X3VzKTsKIAotICAgIHBydi0+dmNwdV9taWdyX2RlbGF5ID0gTUlDUk9T
RUNTKHZjcHVfbWlncmF0aW9uX2RlbGF5X3VzKTsKKyAgICBwcnYtPnVuaXRfbWlncl9kZWxheSA9
IE1JQ1JPU0VDUyh2Y3B1X21pZ3JhdGlvbl9kZWxheV91cyk7CiAKICAgICByZXR1cm4gMDsKIH0K
LS0gCjIuMTYuNAoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3Jn
Cmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 18B0075F06
	for <lists+xen-devel@lfdr.de>; Fri, 26 Jul 2019 08:28:15 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hqtg6-0003BM-6E; Fri, 26 Jul 2019 06:26:06 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=6973=VX=suse.com=dfaggioli@srs-us1.protection.inumbo.net>)
 id 1hqtg4-0003Az-Rk
 for xen-devel@lists.xenproject.org; Fri, 26 Jul 2019 06:26:04 +0000
X-Inumbo-ID: 3de65e79-af6e-11e9-8980-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 3de65e79-af6e-11e9-8980-bc764e045a96;
 Fri, 26 Jul 2019 06:26:03 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id D003EAD31;
 Fri, 26 Jul 2019 06:26:02 +0000 (UTC)
From: Dario Faggioli <dfaggioli@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 26 Jul 2019 08:26:02 +0200
Message-ID: <156412236222.2385.236340632846050170.stgit@Palanthas>
In-Reply-To: <156412188377.2385.12588508835559819141.stgit@Palanthas>
References: <156412188377.2385.12588508835559819141.stgit@Palanthas>
User-Agent: StGit/0.17.1-dirty
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2 3/4] xen: sched: reassign vCPUs to pCPUs,
 when they come back online
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Roger Pau Monne <roger.pau@citrix.com>,
 Stefano Stabellini <sstabellini@kernel.org>,
 George Dunlap <george.dunlap@citrix.com>,
 Dario Faggioli <dario.faggioli@suse.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiBhIHZjcHUgdGhhdCB3YXMgb2ZmbGluZSwgY29tZXMgYmFjayBvbmxpbmUsIHdlIGRvIHdh
bnQgaXQgdG8gZWl0aGVyCmJlIGFzc2lnbmVkIHRvIGEgcENQVSwgb3IgZ28gaW50byB0aGUgd2Fp
dCBsaXN0LgoKRGV0ZWN0aW5nIHRoYXQgYSB2Y3B1IGlzIGNvbWluZyBiYWNrIG9ubGluZSBpcyBh
IGJpdCB0cmlja3kuIEJhc2ljYWxseSwKaWYgdGhlIHZjcHUgaXMgd2FraW5nIHVwLCBhbmQgaXMg
bmVpdGhlciBhc3NpZ25lZCB0byBhIHBDUFUsIG5vciBpbiB0aGUKd2FpdCBsaXN0LCBpdCBtdXN0
IGJlIGNvbWluZyBiYWNrIGZyb20gb2ZmbGluZS4KCldoZW4gdGhpcyBoYXBwZW5zLCB3ZSBwdXQg
aXQgaW4gdGhlIHdhaXRxdWV1ZSwgYW5kIHdlICJ0aWNrbGUiIGFuIGlkbGUKcENQVSAoaWYgYW55
KSwgdG8gZ28gcGljayBpdCB1cC4KCkxvb2tpbmcgYXQgdGhlIHBhdGNoLCBpdCBzZWVtcyB0aGF0
IHRoZSB2Y3B1IHdha2V1cCBjb2RlIGlzIGdldHRpbmcKY29tcGxleCwgYW5kIGhlbmNlIHRoYXQg
aXQgY291bGQgcG90ZW50aWFsbHkgaW50cm9kdWNlIGxhdGVuY2llcy4KSG93ZXZlciwgYWxsIHRo
aXMgbmV3IGxvZ2ljIGlzIHRyaWdnZXJlZCBvbmx5IGJ5IHRoZSBjYXNlIG9mIGEgdmNwdQpjb21p
bmcgb25saW5lLCBzbywgYmFzaWNhbGx5LCB0aGUgb3ZlcmhlYWQgZHVyaW5nIG5vcm1hbCBvcGVy
YXRpb25zIGlzCmp1c3QgYW4gYWRkaXRpb25hbCAnaWYoKScuCgpTaWduZWQtb2ZmLWJ5OiBEYXJp
byBGYWdnaW9saSA8ZGFyaW8uZmFnZ2lvbGlAc3VzZS5jb20+ClJldmlld2VkLWJ5OiBHZW9yZ2Ug
RHVubGFwIDxnZW9yZ2UuZHVubGFwQGNpdHJpeC5jb20+Ci0tLQpDYzogU3RlZmFubyBTdGFiZWxs
aW5pIDxzc3RhYmVsbGluaUBrZXJuZWwub3JnPgpDYzogUm9nZXIgUGF1IE1vbm5lIDxyb2dlci5w
YXVAY2l0cml4LmNvbT4KLS0tCiB4ZW4vY29tbW9uL3NjaGVkX251bGwuYyB8ICAgNTMgKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0KIDEgZmlsZSBjaGFuZ2Vk
LCA1MSBpbnNlcnRpb25zKCspLCAyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9jb21t
b24vc2NoZWRfbnVsbC5jIGIveGVuL2NvbW1vbi9zY2hlZF9udWxsLmMKaW5kZXggMTBlOTZmMjFk
ZC4uMWJiY2FmOTJiOSAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hlZF9udWxsLmMKKysrIGIv
eGVuL2NvbW1vbi9zY2hlZF9udWxsLmMKQEAgLTU0MiwxNSArNTQyLDE5IEBAIHN0YXRpYyB2b2lk
IG51bGxfdmNwdV9yZW1vdmUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3QgdmNw
dSAqdikKIAogc3RhdGljIHZvaWQgbnVsbF92Y3B1X3dha2UoY29uc3Qgc3RydWN0IHNjaGVkdWxl
ciAqb3BzLCBzdHJ1Y3QgdmNwdSAqdikKIHsKKyAgICBzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYg
PSBudWxsX3ByaXYob3BzKTsKKyAgICBzdHJ1Y3QgbnVsbF92Y3B1ICpudmMgPSBudWxsX3ZjcHUo
dik7CisgICAgdW5zaWduZWQgaW50IGNwdSA9IHYtPnByb2Nlc3NvcjsKKwogICAgIEFTU0VSVCgh
aXNfaWRsZV92Y3B1KHYpKTsKIAotICAgIGlmICggdW5saWtlbHkoY3Vycl9vbl9jcHUodi0+cHJv
Y2Vzc29yKSA9PSB2KSApCisgICAgaWYgKCB1bmxpa2VseShjdXJyX29uX2NwdShjcHUpID09IHYp
ICkKICAgICB7CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodmNwdV93YWtlX3J1bm5pbmcpOwog
ICAgICAgICByZXR1cm47CiAgICAgfQogCi0gICAgaWYgKCB1bmxpa2VseSghbGlzdF9lbXB0eSgm
bnVsbF92Y3B1KHYpLT53YWl0cV9lbGVtKSkgKQorICAgIGlmICggdW5saWtlbHkoIWxpc3RfZW1w
dHkoJm52Yy0+d2FpdHFfZWxlbSkpICkKICAgICB7CiAgICAgICAgIC8qIE5vdCBleGFjdGx5ICJv
biBydW5xIiwgYnV0IGNsb3NlIGVub3VnaCBmb3IgcmV1c2luZyB0aGUgY291bnRlciAqLwogICAg
ICAgICBTQ0hFRF9TVEFUX0NSQU5LKHZjcHVfd2FrZV9vbnJ1bnEpOwpAQCAtNTYyLDYgKzU2Niw0
OCBAQCBzdGF0aWMgdm9pZCBudWxsX3ZjcHVfd2FrZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpv
cHMsIHN0cnVjdCB2Y3B1ICp2KQogICAgIGVsc2UKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyh2
Y3B1X3dha2Vfbm90X3J1bm5hYmxlKTsKIAorICAgIC8qCisgICAgICogSWYgYSB2Y3B1IGlzIG5l
aXRoZXIgb24gYSBwQ1BVIG5vciBpbiB0aGUgd2FpdHF1ZXVlLCBpdCBtZWFucyBpdCB3YXMKKyAg
ICAgKiBvZmZsaW5lLCBhbmQgdGhhdCBpdCBpcyBub3cgY29taW5nIGJhY2sgYmVpbmcgb25saW5l
LgorICAgICAqLworICAgIGlmICggdW5saWtlbHkocGVyX2NwdShucGMsIGNwdSkudmNwdSAhPSB2
ICYmIGxpc3RfZW1wdHkoJm52Yy0+d2FpdHFfZWxlbSkpICkKKyAgICB7CisgICAgICAgIHNwaW5f
bG9jaygmcHJ2LT53YWl0cV9sb2NrKTsKKyAgICAgICAgbGlzdF9hZGRfdGFpbCgmbnZjLT53YWl0
cV9lbGVtLCAmcHJ2LT53YWl0cSk7CisgICAgICAgIHNwaW5fdW5sb2NrKCZwcnYtPndhaXRxX2xv
Y2spOworCisgICAgICAgIGNwdW1hc2tfYW5kKGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSwgdi0+
Y3B1X2hhcmRfYWZmaW5pdHksCisgICAgICAgICAgICAgICAgICAgIGNwdXBvb2xfZG9tYWluX2Nw
dW1hc2sodi0+ZG9tYWluKSk7CisKKyAgICAgICAgaWYgKCAhY3B1bWFza19pbnRlcnNlY3RzKCZw
cnYtPmNwdXNfZnJlZSwgY3B1bWFza19zY3JhdGNoX2NwdShjcHUpKSApCisgICAgICAgIHsKKyAg
ICAgICAgICAgIGRwcmludGsoWEVOTE9HX0dfV0FSTklORywgIldBUk5JTkc6IGQlZHYlZCBub3Qg
YXNzaWduZWQgdG8gYW55IENQVSFcbiIsCisgICAgICAgICAgICAgICAgICAgIHYtPmRvbWFpbi0+
ZG9tYWluX2lkLCB2LT52Y3B1X2lkKTsKKyAgICAgICAgICAgIHJldHVybjsKKyAgICAgICAgfQor
CisgICAgICAgIC8qCisgICAgICAgICAqIE5vdyB3ZSB3b3VsZCB3YW50IHRvIGFzc2lnbiB0aGUg
dmNwdSB0byBjcHUsIGJ1dCB3ZSBjYW4ndCwgYmVjYXVzZQorICAgICAgICAgKiB3ZSBkb24ndCBo
YXZlIHRoZSBsb2NrLiBTbywgbGV0J3MgZG8gdGhlIGZvbGxvd2luZzoKKyAgICAgICAgICogLSB0
cnkgdG8gcmVtb3ZlIGNwdSBmcm9tIHRoZSBsaXN0IG9mIGZyZWUgY3B1cywgdG8gYXZvaWQgcmFj
ZXMgd2l0aAorICAgICAgICAgKiAgIG90aGVyIG9ubGluaW5nLCBpbnNlcnRpbmcgb3IgbWlncmF0
aW5nIG9wZXJhdGlvbnM7CisgICAgICAgICAqIC0gdGlja2xlIHRoZSBjcHUsIHdoaWNoIHdpbGwg
cGlja3VwIHdvcmsgZnJvbSB0aGUgd2FpdHF1ZXVlLCBhbmQKKyAgICAgICAgICogICBhc3NpZ24g
aXQgdG8gaXRzZWxmOworICAgICAgICAgKiAtIGlmIHdlJ3JlIHJhY2luZyBhbHJlYWR5LCBhbmQg
aWYgdGhlcmUgc3RpbGwgYXJlIGZyZWUgY3B1cywgdHJ5CisgICAgICAgICAqICAgYWdhaW4uCisg
ICAgICAgICAqLworICAgICAgICB3aGlsZSAoIGNwdW1hc2tfaW50ZXJzZWN0cygmcHJ2LT5jcHVz
X2ZyZWUsIGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSkgKQorICAgICAgICB7CisgICAgICAgICAg
ICB1bnNpZ25lZCBpbnQgbmV3X2NwdSA9IHBpY2tfY3B1KHBydiwgdik7CisKKyAgICAgICAgICAg
IGlmICggdGVzdF9hbmRfY2xlYXJfYml0KG5ld19jcHUsICZwcnYtPmNwdXNfZnJlZSkgKQorICAg
ICAgICAgICAgeworICAgICAgICAgICAgICAgIGNwdV9yYWlzZV9zb2Z0aXJxKG5ld19jcHUsIFND
SEVEVUxFX1NPRlRJUlEpOworICAgICAgICAgICAgICAgIHJldHVybjsKKyAgICAgICAgICAgIH0K
KyAgICAgICAgfQorICAgIH0KKwogICAgIC8qIE5vdGUgdGhhdCB3ZSBnZXQgaGVyZSBvbmx5IGZv
ciB2Q1BVcyBhc3NpZ25lZCB0byBhIHBDUFUgKi8KICAgICBjcHVfcmFpc2Vfc29mdGlycSh2LT5w
cm9jZXNzb3IsIFNDSEVEVUxFX1NPRlRJUlEpOwogfQpAQCAtODA4LDYgKzg1NCw5IEBAIHN0YXRp
YyBzdHJ1Y3QgdGFza19zbGljZSBudWxsX3NjaGVkdWxlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIg
Km9wcywKICAgICAgICAgfQogIHVubG9jazoKICAgICAgICAgc3Bpbl91bmxvY2soJnBydi0+d2Fp
dHFfbG9jayk7CisKKyAgICAgICAgaWYgKCByZXQudGFzayA9PSBOVUxMICYmICFjcHVtYXNrX3Rl
c3RfY3B1KGNwdSwgJnBydi0+Y3B1c19mcmVlKSApCisgICAgICAgICAgICBjcHVtYXNrX3NldF9j
cHUoY3B1LCAmcHJ2LT5jcHVzX2ZyZWUpOwogICAgIH0KIAogICAgIGlmICggdW5saWtlbHkocmV0
LnRhc2sgPT0gTlVMTCB8fCAhdmNwdV9ydW5uYWJsZShyZXQudGFzaykpICkKCgpfX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBs
aXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2pl
Y3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

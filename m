Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id B9FA82C491
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:38:48 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZRk-0008Bo-NS; Tue, 28 May 2019 10:35:08 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZQP-0005HX-PC
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:33:45 +0000
X-Inumbo-ID: 09befeb6-8134-11e9-a528-87341ba88085
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 09befeb6-8134-11e9-a528-87341ba88085;
 Tue, 28 May 2019 10:33:38 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 14493B03C;
 Tue, 28 May 2019 10:33:31 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:33:09 +0200
Message-Id: <20190528103313.1343-57-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 56/60] xen/sched: protect scheduling resource
 via rcu
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SW4gb3JkZXIgdG8gYmUgYWJsZSB0byBtb3ZlIGNwdXMgdG8gY3B1cG9vbHMgd2l0aCBjb3JlIHNj
aGVkdWxpbmcKYWN0aXZlIGl0IGlzIG1hbmRhdG9yeSB0byBtZXJnZSBtdWx0aXBsZSBjcHVzIGlu
dG8gb25lIHNjaGVkdWxpbmcKcmVzb3VyY2Ugb3IgdG8gc3BsaXQgYSBzY2hlZHVsaW5nIHJlc291
cmNlIHdpdGggbXVsdGlwbGUgY3B1cyBpbiBpdAppbnRvIG11bHRpcGxlIHNjaGVkdWxpbmcgcmVz
b3VyY2VzLiBUaGlzIGluIHR1cm4gcmVxdWlyZXMgdG8gbW9kaWZ5CnRoZSBjcHUgPC0+IHNjaGVk
dWxpbmcgcmVzb3VyY2UgcmVsYXRpb24uIEluIG9yZGVyIHRvIGJlIGFibGUgdG8gZnJlZQp1bnVz
ZWQgcmVzb3VyY2VzIHByb3RlY3Qgc3RydWN0IHNjaGVkX3Jlc291cmNlIHZpYSBSQ1UuIFRoaXMg
ZW5zdXJlcwp0aGVyZSBhcmUgbm8gdXNlcnMgbGVmdCB3aGVuIGZyZWVpbmcgc3VjaCBhIHJlc291
cmNlLgoKU2lnbmVkLW9mZi1ieTogSnVlcmdlbiBHcm9zcyA8amdyb3NzQHN1c2UuY29tPgotLS0K
VjE6IG5ldyBwYXRjaAotLS0KIHhlbi9jb21tb24vY3B1cG9vbC5jICAgICAgIHwgICA0ICsKIHhl
bi9jb21tb24vc2NoZWR1bGUuYyAgICAgIHwgMjAwICsrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKystLS0tLQogeGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmggfCAgIDcgKy0K
IDMgZmlsZXMgY2hhbmdlZCwgMTkwIGluc2VydGlvbnMoKyksIDIxIGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL3hlbi9jb21tb24vY3B1cG9vbC5jIGIveGVuL2NvbW1vbi9jcHVwb29sLmMKaW5k
ZXggMzUxMDhiOTExOS4uMWM3NzIyNTUyYyAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9jcHVwb29s
LmMKKysrIGIveGVuL2NvbW1vbi9jcHVwb29sLmMKQEAgLTUxMCw4ICs1MTAsMTAgQEAgc3RhdGlj
IGludCBjcHVwb29sX2NwdV9hZGQodW5zaWduZWQgaW50IGNwdSkKICAgICAgKiAob3IgdW5wbHVn
Z2luZyB3b3VsZCBoYXZlIGZhaWxlZCkgYW5kIHRoYXQgaXMgdGhlIGRlZmF1bHQgYmVoYXZpb3IK
ICAgICAgKiBhbnl3YXkuCiAgICAgICovCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOwogICAgIGdldF9zY2hlZF9yZXMoY3B1KS0+Y3B1cG9vbCA9IE5VTEw7CiAgICAgcmV0
ID0gY3B1cG9vbF9hc3NpZ25fY3B1X2xvY2tlZChjcHVwb29sMCwgY3B1KTsKKyAgICByY3VfcmVh
ZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIAogICAgIHNwaW5fdW5sb2NrKCZjcHVwb29s
X2xvY2spOwogCkBAIC01OTYsNyArNTk4LDkgQEAgc3RhdGljIHZvaWQgY3B1cG9vbF9jcHVfcmVt
b3ZlX2ZvcmNlZCh1bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICB9CiAgICAgfQogCisgICAgcmN1
X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAgIHNjaGVkX3JtX2NwdShjcHUpOwor
ICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogfQogCiAvKgpkaWZmIC0t
Z2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCmluZGV4
IDBmNjY3MDY4YTguLjc4ZWIwNTVkMDcgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWR1bGUu
YworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTczLDYgKzczLDcgQEAgc3RhdGljIHZv
aWQgcG9sbF90aW1lcl9mbih2b2lkICpkYXRhKTsKIC8qIFRoaXMgaXMgZ2xvYmFsIGZvciBub3cg
c28gdGhhdCBwcml2YXRlIGltcGxlbWVudGF0aW9ucyBjYW4gcmVhY2ggaXQgKi8KIERFRklORV9Q
RVJfQ1BVKHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqLCBzY2hlZF9yZXMpOwogc3RhdGljIERFRklO
RV9QRVJfQ1BVKHVuc2lnbmVkIGludCwgc2NoZWRfcmVzX2lkeCk7CitERUZJTkVfUkNVX1JFQURf
TE9DSyhzY2hlZF9yZXNfcmN1bG9jayk7CiAKIC8qIFNjcmF0Y2ggc3BhY2UgZm9yIGNwdW1hc2tz
LiAqLwogREVGSU5FX1BFUl9DUFUoY3B1bWFza190LCBjcHVtYXNrX3NjcmF0Y2gpOwpAQCAtMjcw
LDE3ICsyNzEsMjUgQEAgc3RhdGljIGlubGluZSB2b2lkIHZjcHVfcnVuc3RhdGVfY2hhbmdlKAog
CiB2b2lkIHNjaGVkX2d1ZXN0X2lkbGUodm9pZCAoKmlkbGUpICh2b2lkKSwgdW5zaWduZWQgaW50
IGNwdSkKIHsKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAgICAgYXRv
bWljX2luYygmZ2V0X3NjaGVkX3JlcyhjcHUpLT51cmdlbnRfY291bnQpOworICAgIHJjdV9yZWFk
X3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgaWRsZSgpOworCisgICAgcmN1X3Jl
YWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAgIGF0b21pY19kZWMoJmdldF9zY2hlZF9y
ZXMoY3B1KS0+dXJnZW50X2NvdW50KTsKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19y
Y3Vsb2NrKTsKIH0KIAogdm9pZCB2Y3B1X3J1bnN0YXRlX2dldChzdHJ1Y3QgdmNwdSAqdiwgc3Ry
dWN0IHZjcHVfcnVuc3RhdGVfaW5mbyAqcnVuc3RhdGUpCiB7Ci0gICAgc3BpbmxvY2tfdCAqbG9j
ayA9IGxpa2VseSh2ID09IGN1cnJlbnQpCi0gICAgICAgICAgICAgICAgICAgICAgID8gTlVMTCA6
IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodi0+c2NoZWRfdW5pdCk7CisgICAgc3BpbmxvY2tfdCAq
bG9jazsKICAgICBzX3RpbWVfdCBkZWx0YTsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jl
c19yY3Vsb2NrKTsKKworICAgIGxvY2sgPSBsaWtlbHkodiA9PSBjdXJyZW50KSA/IE5VTEwgOiB1
bml0X3NjaGVkdWxlX2xvY2tfaXJxKHYtPnNjaGVkX3VuaXQpOwogICAgIG1lbWNweShydW5zdGF0
ZSwgJnYtPnJ1bnN0YXRlLCBzaXplb2YoKnJ1bnN0YXRlKSk7CiAgICAgZGVsdGEgPSBOT1coKSAt
IHJ1bnN0YXRlLT5zdGF0ZV9lbnRyeV90aW1lOwogICAgIGlmICggZGVsdGEgPiAwICkKQEAgLTI4
OCw2ICsyOTcsOCBAQCB2b2lkIHZjcHVfcnVuc3RhdGVfZ2V0KHN0cnVjdCB2Y3B1ICp2LCBzdHJ1
Y3QgdmNwdV9ydW5zdGF0ZV9pbmZvICpydW5zdGF0ZSkKIAogICAgIGlmICggdW5saWtlbHkobG9j
ayAhPSBOVUxMKSApCiAgICAgICAgIHVuaXRfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCB2LT5z
Y2hlZF91bml0KTsKKworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwog
fQogCiB1aW50NjRfdCBnZXRfY3B1X2lkbGVfdGltZSh1bnNpZ25lZCBpbnQgY3B1KQpAQCAtNDkz
LDYgKzUwNCw4IEBAIGludCBzY2hlZF9pbml0X3ZjcHUoc3RydWN0IHZjcHUgKnYpCiAgICAgICAg
IHJldHVybiAwOwogICAgIH0KIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2Nr
KTsKKwogICAgIC8qIFRoZSBmaXJzdCB2Y3B1IG9mIGFuIHVuaXQgY2FuIGJlIHNldCB2aWEgc2No
ZWRfc2V0X3JlcygpLiAqLwogICAgIHNjaGVkX3NldF9yZXModW5pdCwgZ2V0X3NjaGVkX3Jlcyhw
cm9jZXNzb3IpKTsKIApAQCAtNTAwLDYgKzUxMyw3IEBAIGludCBzY2hlZF9pbml0X3ZjcHUoc3Ry
dWN0IHZjcHUgKnYpCiAgICAgaWYgKCB1bml0LT5wcml2ID09IE5VTEwgKQogICAgIHsKICAgICAg
ICAgc2NoZWRfZnJlZV91bml0KHVuaXQsIHYpOworICAgICAgICByY3VfcmVhZF91bmxvY2soJnNj
aGVkX3Jlc19yY3Vsb2NrKTsKICAgICAgICAgcmV0dXJuIDE7CiAgICAgfQogCkBAIC01MjYsNiAr
NTQwLDggQEAgaW50IHNjaGVkX2luaXRfdmNwdShzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAgc2No
ZWRfaW5zZXJ0X3VuaXQoZG9tX3NjaGVkdWxlcihkKSwgdW5pdCk7CiAgICAgfQogCisgICAgcmN1
X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICByZXR1cm4gMDsKIH0KIApA
QCAtNTUzLDYgKzU2OSw3IEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpk
LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICB2b2lkICp1bml0ZGF0YTsKICAgICBzdHJ1Y3Qgc2No
ZWR1bGVyICpvbGRfb3BzOwogICAgIHZvaWQgKm9sZF9kb21kYXRhOworICAgIGludCByZXQgPSAw
OwogCiAgICAgZm9yX2VhY2hfc2NoZWRfdW5pdCAoIGQsIHVuaXQgKQogICAgIHsKQEAgLTU2MCwx
NSArNTc3LDIxIEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1
Y3QgY3B1cG9vbCAqYykKICAgICAgICAgICAgIHJldHVybiAtRUJVU1k7CiAgICAgfQogCisgICAg
cmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgZG9tZGF0YSA9IHNjaGVk
X2FsbG9jX2RvbWRhdGEoYy0+c2NoZWQsIGQpOwogICAgIGlmICggSVNfRVJSKGRvbWRhdGEpICkK
LSAgICAgICAgcmV0dXJuIFBUUl9FUlIoZG9tZGF0YSk7CisgICAgeworICAgICAgICByZXQgPSBQ
VFJfRVJSKGRvbWRhdGEpOworICAgICAgICBnb3RvIG91dDsKKyAgICB9CiAKICAgICB1bml0X3By
aXYgPSB4emFsbG9jX2FycmF5KHZvaWQgKiwgZC0+bWF4X3ZjcHVzKTsKICAgICBpZiAoIHVuaXRf
cHJpdiA9PSBOVUxMICkKICAgICB7CiAgICAgICAgIHNjaGVkX2ZyZWVfZG9tZGF0YShjLT5zY2hl
ZCwgZG9tZGF0YSk7Ci0gICAgICAgIHJldHVybiAtRU5PTUVNOworICAgICAgICByZXQgPSAtRU5P
TUVNOworICAgICAgICBnb3RvIG91dDsKICAgICB9CiAKICAgICBmb3JfZWFjaF9zY2hlZF91bml0
ICggZCwgdW5pdCApCkBAIC01ODAsNyArNjAzLDggQEAgaW50IHNjaGVkX21vdmVfZG9tYWluKHN0
cnVjdCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpjKQogICAgICAgICAgICAgICAgIHhmcmVl
KHVuaXRfcHJpdlt1bml0LT51bml0X2lkXSk7CiAgICAgICAgICAgICB4ZnJlZSh1bml0X3ByaXYp
OwogICAgICAgICAgICAgc2NoZWRfZnJlZV9kb21kYXRhKGMtPnNjaGVkLCBkb21kYXRhKTsKLSAg
ICAgICAgICAgIHJldHVybiAtRU5PTUVNOworICAgICAgICAgICAgcmV0ID0gLUVOT01FTTsKKyAg
ICAgICAgICAgIGdvdG8gb3V0OwogICAgICAgICB9CiAgICAgfQogCkBAIC02NDIsNyArNjY2LDEw
IEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgY3B1cG9v
bCAqYykKIAogICAgIHhmcmVlKHVuaXRfcHJpdik7CiAKLSAgICByZXR1cm4gMDsKK291dDoKKyAg
ICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKworICAgIHJldHVybiByZXQ7
CiB9CiAKIHZvaWQgc2NoZWRfZGVzdHJveV92Y3B1KHN0cnVjdCB2Y3B1ICp2KQpAQCAtNjYwLDkg
KzY4NywxMyBAQCB2b2lkIHNjaGVkX2Rlc3Ryb3lfdmNwdShzdHJ1Y3QgdmNwdSAqdikKICAgICAg
Ki8KICAgICBpZiAoIHVuaXQtPnZjcHUgPT0gdiApCiAgICAgeworICAgICAgICByY3VfcmVhZF9s
b2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICAgICAgc2NoZWRfcmVtb3ZlX3VuaXQodmNw
dV9zY2hlZHVsZXIodiksIHVuaXQpOwogICAgICAgICBzY2hlZF9mcmVlX3ZkYXRhKHZjcHVfc2No
ZWR1bGVyKHYpLCB1bml0LT5wcml2KTsKICAgICAgICAgc2NoZWRfZnJlZV91bml0KHVuaXQsIHYp
OworCisgICAgICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAgIH0K
IH0KIApAQCAtNjgwLDcgKzcxMSwxMiBAQCBpbnQgc2NoZWRfaW5pdF9kb21haW4oc3RydWN0IGRv
bWFpbiAqZCwgaW50IHBvb2xpZCkKICAgICBTQ0hFRF9TVEFUX0NSQU5LKGRvbV9pbml0KTsKICAg
ICBUUkFDRV8xRChUUkNfU0NIRURfRE9NX0FERCwgZC0+ZG9tYWluX2lkKTsKIAorICAgIHJjdV9y
ZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIHNkb20gPSBzY2hlZF9hbGxvY19k
b21kYXRhKGRvbV9zY2hlZHVsZXIoZCksIGQpOworCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hl
ZF9yZXNfcmN1bG9jayk7CisKICAgICBpZiAoIElTX0VSUihzZG9tKSApCiAgICAgICAgIHJldHVy
biBQVFJfRVJSKHNkb20pOwogCkBAIC02OTgsOSArNzM0LDEzIEBAIHZvaWQgc2NoZWRfZGVzdHJv
eV9kb21haW4oc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyhkb21f
ZGVzdHJveSk7CiAgICAgICAgIFRSQUNFXzFEKFRSQ19TQ0hFRF9ET01fUkVNLCBkLT5kb21haW5f
aWQpOwogCisgICAgICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAg
ICAgICBzY2hlZF9mcmVlX2RvbWRhdGEoZG9tX3NjaGVkdWxlcihkKSwgZC0+c2NoZWRfcHJpdik7
CiAgICAgICAgIGQtPnNjaGVkX3ByaXYgPSBOVUxMOwogCisgICAgICAgIHJjdV9yZWFkX3VubG9j
aygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgICAgIGNwdXBvb2xfcm1fZG9tYWluKGQpOwog
ICAgIH0KIH0KQEAgLTczNCwxMSArNzc0LDE1IEBAIHZvaWQgdmNwdV9zbGVlcF9ub3N5bmMoc3Ry
dWN0IHZjcHUgKnYpCiAKICAgICBUUkFDRV8yRChUUkNfU0NIRURfU0xFRVAsIHYtPmRvbWFpbi0+
ZG9tYWluX2lkLCB2LT52Y3B1X2lkKTsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19y
Y3Vsb2NrKTsKKwogICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxc2F2ZSh2LT5zY2hl
ZF91bml0LCAmZmxhZ3MpOwogCiAgICAgdmNwdV9zbGVlcF9ub3N5bmNfbG9ja2VkKHYpOwogCiAg
ICAgdW5pdF9zY2hlZHVsZV91bmxvY2tfaXJxcmVzdG9yZShsb2NrLCBmbGFncywgdi0+c2NoZWRf
dW5pdCk7CisKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAog
dm9pZCB2Y3B1X3NsZWVwX3N5bmMoc3RydWN0IHZjcHUgKnYpCkBAIC03NTksNiArODAzLDggQEAg
dm9pZCB2Y3B1X3dha2Uoc3RydWN0IHZjcHUgKnYpCiAKICAgICBUUkFDRV8yRChUUkNfU0NIRURf
V0FLRSwgdi0+ZG9tYWluLT5kb21haW5faWQsIHYtPnZjcHVfaWQpOwogCisgICAgcmN1X3JlYWRf
bG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9j
a19pcnFzYXZlKHVuaXQsICZmbGFncyk7CiAKICAgICBpZiAoIGxpa2VseSh2Y3B1X3J1bm5hYmxl
KHYpKSApCkBAIC03NzksNiArODI1LDggQEAgdm9pZCB2Y3B1X3dha2Uoc3RydWN0IHZjcHUgKnYp
CiAgICAgfQogCiAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2tfaXJxcmVzdG9yZShsb2NrLCBmbGFn
cywgdW5pdCk7CisKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0K
IAogdm9pZCB2Y3B1X3VuYmxvY2soc3RydWN0IHZjcHUgKnYpCkBAIC04MTIsNiArODYwLDggQEAg
c3RhdGljIHZvaWQgc2NoZWRfdW5pdF9tb3ZlX2xvY2tlZChzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5p
dCwKICAgICB1bnNpZ25lZCBpbnQgb2xkX2NwdSA9IHVuaXQtPnJlcy0+cHJvY2Vzc29yOwogICAg
IHN0cnVjdCB2Y3B1ICp2OwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2sp
OworCiAgICAgLyoKICAgICAgKiBUcmFuc2ZlciB1cmdlbmN5IHN0YXR1cyB0byBuZXcgQ1BVIGJl
Zm9yZSBzd2l0Y2hpbmcgQ1BVcywgYXMKICAgICAgKiBvbmNlIHRoZSBzd2l0Y2ggb2NjdXJzLCB2
LT5pc191cmdlbnQgaXMgbm8gbG9uZ2VyIHByb3RlY3RlZCBieQpAQCAtODMxLDYgKzg4MSw4IEBA
IHN0YXRpYyB2b2lkIHNjaGVkX3VuaXRfbW92ZV9sb2NrZWQoc3RydWN0IHNjaGVkX3VuaXQgKnVu
aXQsCiAgICAgICogcG9pbnRlciBjYW4ndCBjaGFuZ2Ugd2hpbGUgdGhlIGN1cnJlbnQgbG9jayBp
cyBoZWxkLgogICAgICAqLwogICAgIHNjaGVkX21pZ3JhdGUodmNwdV9zY2hlZHVsZXIodW5pdC0+
dmNwdSksIHVuaXQsIG5ld19jcHUpOworCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNf
cmN1bG9jayk7CiB9CiAKIC8qCkBAIC05OTIsNiArMTA0NCw4IEBAIHZvaWQgcmVzdG9yZV92Y3B1
X2FmZmluaXR5KHN0cnVjdCBkb21haW4gKmQpCiAKICAgICBBU1NFUlQoc3lzdGVtX3N0YXRlID09
IFNZU19TVEFURV9yZXN1bWUpOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxv
Y2spOworCiAgICAgZm9yX2VhY2hfc2NoZWRfdW5pdCAoIGQsIHVuaXQgKQogICAgIHsKICAgICAg
ICAgc3BpbmxvY2tfdCAqbG9jazsKQEAgLTEwNDIsNiArMTA5Niw4IEBAIHZvaWQgcmVzdG9yZV92
Y3B1X2FmZmluaXR5KHN0cnVjdCBkb21haW4gKmQpCiAgICAgICAgICAgICBzY2hlZF9tb3ZlX2ly
cXModW5pdCk7CiAgICAgfQogCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9j
ayk7CisKICAgICBkb21haW5fdXBkYXRlX25vZGVfYWZmaW5pdHkoZCk7CiB9CiAKQEAgLTEwNTcs
OSArMTExMywxMSBAQCBpbnQgY3B1X2Rpc2FibGVfc2NoZWR1bGVyKHVuc2lnbmVkIGludCBjcHUp
CiAgICAgY3B1bWFza190IG9ubGluZV9hZmZpbml0eTsKICAgICBpbnQgcmV0ID0gMDsKIAorICAg
IHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGMgPSBnZXRfc2NoZWRf
cmVzKGNwdSktPmNwdXBvb2w7CiAgICAgaWYgKCBjID09IE5VTEwgKQotICAgICAgICByZXR1cm4g
cmV0OworICAgICAgICBnb3RvIG91dDsKIAogICAgIGZvcl9lYWNoX2RvbWFpbl9pbl9jcHVwb29s
ICggZCwgYyApCiAgICAgewpAQCAtMTExNiw2ICsxMTc0LDkgQEAgaW50IGNwdV9kaXNhYmxlX3Nj
aGVkdWxlcih1bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICB9CiAgICAgfQogCitvdXQ6CisgICAg
cmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICByZXR1cm4gcmV0Owog
fQogCkBAIC0xMTQ5LDcgKzEyMTAsOSBAQCB2b2lkIHNjaGVkX3NldF9hZmZpbml0eSgKIHsKICAg
ICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCA9IHYtPnNjaGVkX3VuaXQ7CiAKKyAgICByY3VfcmVh
ZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAgICAgc2NoZWRfYWRqdXN0X2FmZmluaXR5KGRv
bV9zY2hlZHVsZXIodi0+ZG9tYWluKSwgdW5pdCwgaGFyZCwgc29mdCk7CisgICAgcmN1X3JlYWRf
dW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAKICAgICBpZiAoIGhhcmQgKQogICAgICAgICBj
cHVtYXNrX2NvcHkodW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHksIGhhcmQpOwpAQCAtMTE2OSw2ICsx
MjMyLDggQEAgc3RhdGljIGludCB2Y3B1X3NldF9hZmZpbml0eSgKICAgICBzcGlubG9ja190ICps
b2NrOwogICAgIGludCByZXQgPSAwOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOworCiAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5pdCk7CiAKICAg
ICBpZiAoIHVuaXQtPmFmZmluaXR5X2Jyb2tlbiApCkBAIC0xMTk3LDYgKzEyNjIsOCBAQCBzdGF0
aWMgaW50IHZjcHVfc2V0X2FmZmluaXR5KAogCiAgICAgc2NoZWRfdW5pdF9taWdyYXRlX2Zpbmlz
aCh1bml0KTsKIAorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAg
ICAgcmV0dXJuIHJldDsKIH0KIApAQCAtMTMyMywxMSArMTM5MCwxNiBAQCBzdGF0aWMgbG9uZyBk
b19wb2xsKHN0cnVjdCBzY2hlZF9wb2xsICpzY2hlZF9wb2xsKQogbG9uZyB2Y3B1X3lpZWxkKHZv
aWQpCiB7CiAgICAgc3RydWN0IHZjcHUgKiB2PWN1cnJlbnQ7Ci0gICAgc3BpbmxvY2tfdCAqbG9j
ayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodi0+c2NoZWRfdW5pdCk7CisgICAgc3BpbmxvY2tf
dCAqbG9jazsKKworICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIAorICAg
IGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHYtPnNjaGVkX3VuaXQpOwogICAgIHNjaGVk
X3lpZWxkKHZjcHVfc2NoZWR1bGVyKHYpLCB2LT5zY2hlZF91bml0KTsKICAgICB1bml0X3NjaGVk
dWxlX3VubG9ja19pcnEobG9jaywgdi0+c2NoZWRfdW5pdCk7CiAKKyAgICByY3VfcmVhZF91bmxv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIFNDSEVEX1NUQVRfQ1JBTksodmNwdV95aWVs
ZCk7CiAKICAgICBUUkFDRV8yRChUUkNfU0NIRURfWUlFTEQsIGN1cnJlbnQtPmRvbWFpbi0+ZG9t
YWluX2lkLCBjdXJyZW50LT52Y3B1X2lkKTsKQEAgLTE0MTMsNiArMTQ4NSw4IEBAIGludCB2Y3B1
X3Bpbl9vdmVycmlkZShzdHJ1Y3QgdmNwdSAqdiwgaW50IGNwdSkKICAgICBzcGlubG9ja190ICps
b2NrOwogICAgIGludCByZXQgPSAtRUlOVkFMOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRf
cmVzX3JjdWxvY2spOworCiAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5pdCk7
CiAKICAgICBpZiAoIGNwdSA8IDAgKQpAQCAtMTQ0Nyw2ICsxNTIxLDggQEAgaW50IHZjcHVfcGlu
X292ZXJyaWRlKHN0cnVjdCB2Y3B1ICp2LCBpbnQgY3B1KQogCiAgICAgc2NoZWRfdW5pdF9taWdy
YXRlX2ZpbmlzaCh1bml0KTsKIAorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxv
Y2spOworCiAgICAgcmV0dXJuIHJldDsKIH0KIApAQCAtMTY1Miw5ICsxNzI4LDEzIEBAIGxvbmcg
c2NoZWRfYWRqdXN0KHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCB4ZW5fZG9tY3RsX3NjaGVkdWxl
cl9vcCAqb3ApCiAKICAgICAvKiBOQjogdGhlIHBsdWdnYWJsZSBzY2hlZHVsZXIgY29kZSBuZWVk
cyB0byB0YWtlIGNhcmUKICAgICAgKiBvZiBsb2NraW5nIGJ5IGl0c2VsZi4gKi8KKyAgICByY3Vf
cmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBpZiAoIChyZXQgPSBzY2hlZF9h
ZGp1c3RfZG9tKGRvbV9zY2hlZHVsZXIoZCksIGQsIG9wKSkgPT0gMCApCiAgICAgICAgIFRSQUNF
XzFEKFRSQ19TQ0hFRF9BREpET00sIGQtPmRvbWFpbl9pZCk7CiAKKyAgICByY3VfcmVhZF91bmxv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIHJldHVybiByZXQ7CiB9CiAKQEAgLTE2NzUs
OSArMTc1NSwxMyBAQCBsb25nIHNjaGVkX2FkanVzdF9nbG9iYWwoc3RydWN0IHhlbl9zeXNjdGxf
c2NoZWR1bGVyX29wICpvcCkKICAgICBpZiAoIHBvb2wgPT0gTlVMTCApCiAgICAgICAgIHJldHVy
biAtRVNSQ0g7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAg
ICByYyA9ICgob3AtPnNjaGVkX2lkID09IHBvb2wtPnNjaGVkLT5zY2hlZF9pZCkKICAgICAgICAg
ICA/IHNjaGVkX2FkanVzdF9jcHVwb29sKHBvb2wtPnNjaGVkLCBvcCkgOiAtRUlOVkFMKTsKIAor
ICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgY3B1cG9vbF9w
dXQocG9vbCk7CiAKICAgICByZXR1cm4gcmM7CkBAIC0xODU5LDggKzE5NDMsMTEgQEAgc3RhdGlj
IHZvaWQgY29udGV4dF9zYXZlZChzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIHZvaWQgc2NoZWRf
Y29udGV4dF9zd2l0Y2hlZChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCkK
IHsKICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqbmV4dCA9IHZuZXh0LT5zY2hlZF91bml0OwotICAg
IHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc2QgPSBnZXRfc2NoZWRfcmVzKHNtcF9wcm9jZXNzb3Jf
aWQoKSk7CisgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzZDsKIAorICAgIHJjdV9yZWFkX2xv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKworICAgIHNkID0gZ2V0X3NjaGVkX3JlcyhzbXBfcHJv
Y2Vzc29yX2lkKCkpOwogICAgIC8qIENsZWFyIHJ1bm5pbmcgZmxhZyAvYWZ0ZXIvIHdyaXRpbmcg
Y29udGV4dCB0byBtZW1vcnkuICovCiAgICAgc21wX3dtYigpOwogCkBAIC0xODg3LDYgKzE5NzQs
OCBAQCB2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNoZWQoc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1
Y3QgdmNwdSAqdm5leHQpCiAKICAgICBpZiAoIGlzX2lkbGVfdmNwdSh2cHJldikgJiYgdnByZXYg
IT0gdm5leHQgKQogICAgICAgICB2cHJldi0+c2NoZWRfdW5pdCA9IHNkLT5zY2hlZF91bml0X2lk
bGU7CisKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogc3Rh
dGljIHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3Qg
dmNwdSAqdm5leHQsCkBAIC0xOTA0LDYgKzE5OTMsOCBAQCBzdGF0aWMgdm9pZCBzY2hlZF9jb250
ZXh0X3N3aXRjaChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCwKICAgICAg
ICAgICAgIHZuZXh0LT5zY2hlZF91bml0ID0KICAgICAgICAgICAgICAgICBnZXRfc2NoZWRfcmVz
KHNtcF9wcm9jZXNzb3JfaWQoKSktPnNjaGVkX3VuaXRfaWRsZTsKIAorICAgICAgICByY3VfcmVh
ZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgICAgICB0cmFjZV9jb250aW51ZV9y
dW5uaW5nKHZuZXh0KTsKICAgICAgICAgcmV0dXJuIGNvbnRpbnVlX3J1bm5pbmcodnByZXYpOwog
ICAgIH0KQEAgLTE5MTcsNiArMjAwOCw4IEBAIHN0YXRpYyB2b2lkIHNjaGVkX2NvbnRleHRfc3dp
dGNoKHN0cnVjdCB2Y3B1ICp2cHJldiwgc3RydWN0IHZjcHUgKnZuZXh0LAogCiAgICAgdmNwdV9w
ZXJpb2RpY190aW1lcl93b3JrKHZuZXh0KTsKIAorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRf
cmVzX3JjdWxvY2spOworCiAgICAgY29udGV4dF9zd2l0Y2godnByZXYsIHZuZXh0KTsKIH0KIApA
QCAtMjA0Nyw2ICsyMTQwLDggQEAgc3RhdGljIHZvaWQgc2NoZWRfc2xhdmUodm9pZCkKIAogICAg
IEFTU0VSVF9OT1RfSU5fQVRPTUlDKCk7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNf
cmN1bG9jayk7CisKICAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycShjcHUpOwogCiAg
ICAgbm93ID0gTk9XKCk7CkBAIC0yMDcwLDYgKzIxNjUsOCBAQCBzdGF0aWMgdm9pZCBzY2hlZF9z
bGF2ZSh2b2lkKQogICAgIHsKICAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ss
IGNwdSk7CiAKKyAgICAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisK
ICAgICAgICAgLyogQ2hlY2sgZm9yIGZhaWxlZCBmb3JjZWQgY29udGV4dCBzd2l0Y2guICovCiAg
ICAgICAgIGlmICggZG9fc29mdGlycSApCiAgICAgICAgICAgICByYWlzZV9zb2Z0aXJxKFNDSEVE
VUxFX1NPRlRJUlEpOwpAQCAtMjEwMCwxMyArMjE5NywxNiBAQCBzdGF0aWMgdm9pZCBzY2hlZHVs
ZSh2b2lkKQogICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc2Q7CiAgICAgc3BpbmxvY2tfdCAg
ICAgICAgICAgKmxvY2s7CiAgICAgaW50IGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKLSAgICB1
bnNpZ25lZCBpbnQgICAgICAgICAgZ3JhbiA9IGdldF9zY2hlZF9yZXMoY3B1KS0+Z3JhbnVsYXJp
dHk7CisgICAgdW5zaWduZWQgaW50ICAgICAgICAgIGdyYW47CiAKICAgICBBU1NFUlRfTk9UX0lO
X0FUT01JQygpOwogCiAgICAgU0NIRURfU1RBVF9DUkFOSyhzY2hlZF9ydW4pOwogCisgICAgcmN1
X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgc2QgPSBnZXRfc2NoZWRfcmVz
KGNwdSk7CisgICAgZ3JhbiA9IHNkLT5ncmFudWxhcml0eTsKIAogICAgIGxvY2sgPSBwY3B1X3Nj
aGVkdWxlX2xvY2tfaXJxKGNwdSk7CiAKQEAgLTIxMTgsNiArMjIxOCw4IEBAIHN0YXRpYyB2b2lk
IHNjaGVkdWxlKHZvaWQpCiAgICAgICAgICAqLwogICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9j
a19pcnEobG9jaywgY3B1KTsKIAorICAgICAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19y
Y3Vsb2NrKTsKKwogICAgICAgICByYWlzZV9zb2Z0aXJxKFNDSEVEVUxFX1NPRlRJUlEpOwogICAg
ICAgICByZXR1cm4gc2NoZWRfc2xhdmUoKTsKICAgICB9CkBAIC0yMjMwLDE0ICsyMzMyLDI3IEBA
IHN0YXRpYyBpbnQgY3B1X3NjaGVkdWxlX3VwKHVuc2lnbmVkIGludCBjcHUpCiAgICAgcmV0dXJu
IDA7CiB9CiAKK3N0YXRpYyB2b2lkIHNjaGVkX3Jlc19mcmVlKHN0cnVjdCByY3VfaGVhZCAqaGVh
ZCkKK3sKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkID0gY29udGFpbmVyX29mKGhlYWQs
IHN0cnVjdCBzY2hlZF9yZXNvdXJjZSwgcmN1KTsKKworICAgIHhmcmVlKHNkKTsKK30KKwogc3Rh
dGljIHZvaWQgY3B1X3NjaGVkdWxlX2Rvd24odW5zaWduZWQgaW50IGNwdSkKIHsKLSAgICBzdHJ1
Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkID0gZ2V0X3NjaGVkX3JlcyhjcHUpOworICAgIHN0cnVjdCBz
Y2hlZF9yZXNvdXJjZSAqc2Q7CisKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9j
ayk7CisKKyAgICBzZCA9IGdldF9zY2hlZF9yZXMoY3B1KTsKIAogICAgIGtpbGxfdGltZXIoJnNk
LT5zX3RpbWVyKTsKIAogICAgIHNldF9zY2hlZF9yZXMoY3B1LCBOVUxMKTsKLSAgICB4ZnJlZShz
ZCk7CisgICAgY2FsbF9yY3UoJnNkLT5yY3UsIHNjaGVkX3Jlc19mcmVlKTsKKworICAgIHJjdV9y
ZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogfQogCiB2b2lkIHNjaGVkX3JtX2NwdSh1
bnNpZ25lZCBpbnQgY3B1KQpAQCAtMjI1Nyw2ICsyMzcyLDggQEAgc3RhdGljIGludCBjcHVfc2No
ZWR1bGVfY2FsbGJhY2soCiAgICAgdW5zaWduZWQgaW50IGNwdSA9ICh1bnNpZ25lZCBsb25nKWhj
cHU7CiAgICAgaW50IHJjID0gMDsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vs
b2NrKTsKKwogICAgIC8qCiAgICAgICogRnJvbSB0aGUgc2NoZWR1bGVyIHBlcnNwZWN0aXZlLCBi
cmluZ2luZyB1cCBhIHBDUFUgcmVxdWlyZXMKICAgICAgKiBhbGxvY2F0aW5nIGFuZCBpbml0aWFs
aXppbmcgdGhlIHBlci1wQ1BVIHNjaGVkdWxlciBzcGVjaWZpYyBkYXRhLApAQCAtMjMwMyw2ICsy
NDIwLDggQEAgc3RhdGljIGludCBjcHVfc2NoZWR1bGVfY2FsbGJhY2soCiAgICAgICAgIGJyZWFr
OwogICAgIH0KIAorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAg
ICAgcmV0dXJuICFyYyA/IE5PVElGWV9ET05FIDogbm90aWZpZXJfZnJvbV9lcnJubyhyYyk7CiB9
CiAKQEAgLTIzOTIsOCArMjUxMSwxMyBAQCB2b2lkIF9faW5pdCBzY2hlZHVsZXJfaW5pdCh2b2lk
KQogICAgIGlkbGVfZG9tYWluLT5tYXhfdmNwdXMgPSBucl9jcHVfaWRzOwogICAgIGlmICggdmNw
dV9jcmVhdGUoaWRsZV9kb21haW4sIDApID09IE5VTEwgKQogICAgICAgICBCVUcoKTsKKworICAg
IHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGdldF9zY2hlZF9yZXMo
MCktPmN1cnIgPSBpZGxlX3ZjcHVbMF0tPnNjaGVkX3VuaXQ7CiAgICAgZ2V0X3NjaGVkX3Jlcygw
KS0+c2NoZWRfdW5pdF9pZGxlID0gaWRsZV92Y3B1WzBdLT5zY2hlZF91bml0OworCisgICAgcmN1
X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiB9CiAKIC8qCkBAIC0yNDA2LDkgKzI1
MzAsMTQgQEAgaW50IHNjaGVkdWxlX2NwdV9hZGQodW5zaWduZWQgaW50IGNwdSwgc3RydWN0IGNw
dXBvb2wgKmMpCiAgICAgc3RydWN0IHZjcHUgKmlkbGU7CiAgICAgdm9pZCAqcHByaXYsICp2cHJp
djsKICAgICBzdHJ1Y3Qgc2NoZWR1bGVyICpuZXdfb3BzID0gYy0+c2NoZWQ7Ci0gICAgc3RydWN0
IHNjaGVkX3Jlc291cmNlICpzZCA9IGdldF9zY2hlZF9yZXMoY3B1KTsKKyAgICBzdHJ1Y3Qgc2No
ZWRfcmVzb3VyY2UgKnNkOwogICAgIHNwaW5sb2NrX3QgKm9sZF9sb2NrLCAqbmV3X2xvY2s7CiAg
ICAgdW5zaWduZWQgbG9uZyBmbGFnczsKKyAgICBpbnQgcmV0ID0gMDsKKworICAgIHJjdV9yZWFk
X2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKworICAgIHNkID0gZ2V0X3NjaGVkX3JlcyhjcHUp
OwogCiAgICAgQVNTRVJUKGNwdW1hc2tfdGVzdF9jcHUoY3B1LCAmY3B1cG9vbF9mcmVlX2NwdXMp
KTsKICAgICBBU1NFUlQoIWNwdW1hc2tfdGVzdF9jcHUoY3B1LCBjLT5jcHVfdmFsaWQpKTsKQEAg
LTI0MjgsMTMgKzI1NTcsMTggQEAgaW50IHNjaGVkdWxlX2NwdV9hZGQodW5zaWduZWQgaW50IGNw
dSwgc3RydWN0IGNwdXBvb2wgKmMpCiAgICAgaWRsZSA9IGlkbGVfdmNwdVtjcHVdOwogICAgIHBw
cml2ID0gc2NoZWRfYWxsb2NfcGRhdGEobmV3X29wcywgY3B1KTsKICAgICBpZiAoIElTX0VSUihw
cHJpdikgKQotICAgICAgICByZXR1cm4gUFRSX0VSUihwcHJpdik7CisgICAgeworICAgICAgICBy
ZXQgPSBQVFJfRVJSKHBwcml2KTsKKyAgICAgICAgZ290byBvdXQ7CisgICAgfQorCiAgICAgdnBy
aXYgPSBzY2hlZF9hbGxvY192ZGF0YShuZXdfb3BzLCBpZGxlLT5zY2hlZF91bml0LAogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgaWRsZS0+ZG9tYWluLT5zY2hlZF9wcml2KTsKICAgICBp
ZiAoIHZwcml2ID09IE5VTEwgKQogICAgIHsKICAgICAgICAgc2NoZWRfZnJlZV9wZGF0YShuZXdf
b3BzLCBwcHJpdiwgY3B1KTsKLSAgICAgICAgcmV0dXJuIC1FTk9NRU07CisgICAgICAgIHJldCA9
IC1FTk9NRU07CisgICAgICAgIGdvdG8gb3V0OwogICAgIH0KIAogICAgIC8qCkBAIC0yNDczLDcg
KzI2MDcsMTAgQEAgaW50IHNjaGVkdWxlX2NwdV9hZGQodW5zaWduZWQgaW50IGNwdSwgc3RydWN0
IGNwdXBvb2wgKmMpCiAgICAgLyogVGhlICBjcHUgaXMgYWRkZWQgdG8gYSBwb29sLCB0cmlnZ2Vy
IGl0IHRvIGdvIHBpY2sgdXAgc29tZSB3b3JrICovCiAgICAgY3B1X3JhaXNlX3NvZnRpcnEoY3B1
LCBTQ0hFRFVMRV9TT0ZUSVJRKTsKIAotICAgIHJldHVybiAwOworb3V0OgorICAgIHJjdV9yZWFk
X3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCisgICAgcmV0dXJuIHJldDsKIH0KIAogLyoK
QEAgLTI0ODYsMTEgKzI2MjMsMTYgQEAgaW50IHNjaGVkdWxlX2NwdV9ybSh1bnNpZ25lZCBpbnQg
Y3B1KQogewogICAgIHN0cnVjdCB2Y3B1ICppZGxlOwogICAgIHZvaWQgKnBwcml2X29sZCwgKnZw
cml2X29sZDsKLSAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkID0gZ2V0X3NjaGVkX3Jlcyhj
cHUpOwotICAgIHN0cnVjdCBzY2hlZHVsZXIgKm9sZF9vcHMgPSBzZC0+c2NoZWR1bGVyOworICAg
IHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc2Q7CisgICAgc3RydWN0IHNjaGVkdWxlciAqb2xkX29w
czsKICAgICBzcGlubG9ja190ICpvbGRfbG9jazsKICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwog
CisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCisgICAgc2QgPSBnZXRf
c2NoZWRfcmVzKGNwdSk7CisgICAgb2xkX29wcyA9IHNkLT5zY2hlZHVsZXI7CisKICAgICBBU1NF
UlQoc2QtPmNwdXBvb2wgIT0gTlVMTCk7CiAgICAgQVNTRVJUKGNwdW1hc2tfdGVzdF9jcHUoY3B1
LCAmY3B1cG9vbF9mcmVlX2NwdXMpKTsKICAgICBBU1NFUlQoIWNwdW1hc2tfdGVzdF9jcHUoY3B1
LCBzZC0+Y3B1cG9vbC0+Y3B1X3ZhbGlkKSk7CkBAIC0yNTIzLDYgKzI2NjUsOCBAQCBpbnQgc2No
ZWR1bGVfY3B1X3JtKHVuc2lnbmVkIGludCBjcHUpCiAgICAgc2QtPmdyYW51bGFyaXR5ID0gMTsK
ICAgICBzZC0+Y3B1cG9vbCA9IE5VTEw7CiAKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jl
c19yY3Vsb2NrKTsKKwogICAgIHJldHVybiAwOwogfQogCkBAIC0yNTcxLDYgKzI3MTUsOCBAQCB2
b2lkIHNjaGVkdWxlX2R1bXAoc3RydWN0IGNwdXBvb2wgKmMpCiAKICAgICAvKiBMb2NraW5nLCBp
ZiBuZWNlc3NhcnksIG11c3QgYmUgaGFuZGxlZCB3aXRoaW5nIGVhY2ggc2NoZWR1bGVyICovCiAK
KyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBpZiAoIGMgIT0g
TlVMTCApCiAgICAgewogICAgICAgICBzY2hlZCA9IGMtPnNjaGVkOwpAQCAtMjU5MCw2ICsyNzM2
LDggQEAgdm9pZCBzY2hlZHVsZV9kdW1wKHN0cnVjdCBjcHVwb29sICpjKQogICAgICAgICBmb3Jf
ZWFjaF9jcHUgKGksIGNwdXMpCiAgICAgICAgICAgICBzY2hlZF9kdW1wX2NwdV9zdGF0ZShzY2hl
ZCwgaSk7CiAgICAgfQorCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7
CiB9CiAKIHZvaWQgc2NoZWRfdGlja19zdXNwZW5kKHZvaWQpCkBAIC0yNTk3LDEwICsyNzQ1LDE0
IEBAIHZvaWQgc2NoZWRfdGlja19zdXNwZW5kKHZvaWQpCiAgICAgc3RydWN0IHNjaGVkdWxlciAq
c2NoZWQ7CiAgICAgdW5zaWduZWQgaW50IGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKIAorICAg
IHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIHNjaGVkID0gZ2V0X3Nj
aGVkX3JlcyhjcHUpLT5zY2hlZHVsZXI7CiAgICAgc2NoZWRfZG9fdGlja19zdXNwZW5kKHNjaGVk
LCBjcHUpOwogICAgIHJjdV9pZGxlX2VudGVyKGNwdSk7CiAgICAgcmN1X2lkbGVfdGltZXJfc3Rh
cnQoKTsKKworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogfQogCiB2
b2lkIHNjaGVkX3RpY2tfcmVzdW1lKHZvaWQpCkBAIC0yNjA4LDEwICsyNzYwLDE0IEBAIHZvaWQg
c2NoZWRfdGlja19yZXN1bWUodm9pZCkKICAgICBzdHJ1Y3Qgc2NoZWR1bGVyICpzY2hlZDsKICAg
ICB1bnNpZ25lZCBpbnQgY3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOwogCisgICAgcmN1X3JlYWRf
bG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgcmN1X2lkbGVfdGltZXJfc3RvcCgpOwog
ICAgIHJjdV9pZGxlX2V4aXQoY3B1KTsKICAgICBzY2hlZCA9IGdldF9zY2hlZF9yZXMoY3B1KS0+
c2NoZWR1bGVyOwogICAgIHNjaGVkX2RvX3RpY2tfcmVzdW1lKHNjaGVkLCBjcHUpOworCisgICAg
cmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiB9CiAKIHZvaWQgd2FpdCh2b2lk
KQpAQCAtMjYyNiw3ICsyNzgyLDEzIEBAIHZvaWQgd2FpdCh2b2lkKQogICovCiBpbnQgc2NoZWRf
aGFzX3VyZ2VudF92Y3B1KHZvaWQpCiB7Ci0gICAgcmV0dXJuIGF0b21pY19yZWFkKCZnZXRfc2No
ZWRfcmVzKHNtcF9wcm9jZXNzb3JfaWQoKSktPnVyZ2VudF9jb3VudCk7CisgICAgaW50IHZhbDsK
KworICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKyAgICB2YWwgPSBhdG9t
aWNfcmVhZCgmZ2V0X3NjaGVkX3JlcyhzbXBfcHJvY2Vzc29yX2lkKCkpLT51cmdlbnRfY291bnQp
OworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCisgICAgcmV0dXJu
IHZhbDsKIH0KIAogI2lmZGVmIENPTkZJR19DT01QQVQKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRl
L3hlbi9zY2hlZC1pZi5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKaW5kZXggZTA0ZDI0
OWRmZC4uYWJmNmQwNTIyZCAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgK
KysrIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKQEAgLTEwLDYgKzEwLDcgQEAKIAogI2lu
Y2x1ZGUgPHhlbi9wZXJjcHUuaD4KICNpbmNsdWRlIDx4ZW4vZXJyLmg+CisjaW5jbHVkZSA8eGVu
L3JjdXBkYXRlLmg+CiAKIC8qIEEgZ2xvYmFsIHBvaW50ZXIgdG8gdGhlIGluaXRpYWwgY3B1cG9v
bCAoUE9PTDApLiAqLwogZXh0ZXJuIHN0cnVjdCBjcHVwb29sICpjcHVwb29sMDsKQEAgLTU4LDIw
ICs1OSwyMiBAQCBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgewogICAgIHVuc2lnbmVkIGludCAgICAg
ICAgcHJvY2Vzc29yOwogICAgIHVuc2lnbmVkIGludCAgICAgICAgZ3JhbnVsYXJpdHk7CiAgICAg
Y29uc3QgY3B1bWFza190ICAgICpjcHVzOyAgICAgICAgICAgLyogY3B1cyBjb3ZlcmVkIGJ5IHRo
aXMgc3RydWN0ICAgICAqLworICAgIHN0cnVjdCByY3VfaGVhZCAgICAgcmN1OwogfTsKIAogI2Rl
ZmluZSBjdXJyX29uX2NwdShjKSAgICAoZ2V0X3NjaGVkX3JlcyhjKS0+Y3VycikKIAogREVDTEFS
RV9QRVJfQ1BVKHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqLCBzY2hlZF9yZXMpOworZXh0ZXJuIHJj
dV9yZWFkX2xvY2tfdCBzY2hlZF9yZXNfcmN1bG9jazsKIAogc3RhdGljIGlubGluZSBzdHJ1Y3Qg
c2NoZWRfcmVzb3VyY2UgKmdldF9zY2hlZF9yZXModW5zaWduZWQgaW50IGNwdSkKIHsKLSAgICBy
ZXR1cm4gcGVyX2NwdShzY2hlZF9yZXMsIGNwdSk7CisgICAgcmV0dXJuIHJjdV9kZXJlZmVyZW5j
ZShwZXJfY3B1KHNjaGVkX3JlcywgY3B1KSk7CiB9CiAKIHN0YXRpYyBpbmxpbmUgdm9pZCBzZXRf
c2NoZWRfcmVzKHVuc2lnbmVkIGludCBjcHUsIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqcmVzKQog
ewotICAgIHBlcl9jcHUoc2NoZWRfcmVzLCBjcHUpID0gcmVzOworICAgIHJjdV9hc3NpZ25fcG9p
bnRlcihwZXJfY3B1KHNjaGVkX3JlcywgY3B1KSwgcmVzKTsKIH0KIAogc3RhdGljIGlubGluZSBi
b29sIGlzX2lkbGVfdW5pdChjb25zdCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKLS0gCjIuMTYu
NAoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1k
ZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8v
bGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 0EB3C12D1D3
	for <lists+xen-devel@lfdr.de>; Mon, 30 Dec 2019 17:15:34 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ilxeH-00026i-53; Mon, 30 Dec 2019 16:12:05 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=0QMt=2U=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1ilxeF-00026N-4C
 for xen-devel@lists.xenproject.org; Mon, 30 Dec 2019 16:12:03 +0000
X-Inumbo-ID: 16f1b981-2b1f-11ea-a04b-12813bfff9fa
Received: from mga14.intel.com (unknown [192.55.52.115])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 16f1b981-2b1f-11ea-a04b-12813bfff9fa;
 Mon, 30 Dec 2019 16:11:53 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga003.jf.intel.com ([10.7.209.27])
 by fmsmga103.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 30 Dec 2019 08:11:50 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,375,1571727600"; d="scan'208";a="221167305"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.254.94.206])
 by orsmga003.jf.intel.com with ESMTP; 30 Dec 2019 08:11:50 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 30 Dec 2019 08:11:25 -0800
Message-Id: <0eeb9ab06a5e53c0aca7d5e9215062d9e0240140.1577721845.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1577721845.git.tamas.lengyel@intel.com>
References: <cover.1577721845.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v3 01/18] x86/hvm: introduce
 hvm_copy_context_and_params
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q3VycmVudGx5IHRoZSBodm0gcGFyYW1ldGVycyBhcmUgb25seSBhY2Nlc3NpYmxlIHZpYSB0aGUg
SFZNT1AgaHlwZXJjYWxscy4gSW4KdGhpcyBwYXRjaCB3ZSBpbnRyb2R1Y2UgYSBuZXcgZnVuY3Rp
b24gdGhhdCBjYW4gY29weSBib3RoIHRoZSBodm0gY29udGV4dCBhbmQKcGFyYW1ldGVycyBkaXJl
Y3RseSBpbnRvIGEgdGFyZ2V0IGRvbWFpbi4gV2UnbGwgdXNlIHRoaXMgZnVuY3Rpb24gZHVyaW5n
IFZNCmZvcmtpbmcgb3BlcmF0aW9uLgoKVGhlcmUgYXJlIG5vIGZ1bmN0aW9uYWwgY2hhbmdlcyB0
byBodm1vcF9nZXQvc2V0X3BhcmFtLCBvbmx5IGFkanVzdG1lbnRzIHRvCm1ha2UgdGhlIGNvZGUg
bW9yZSBhY2Nlc3NpYmxlIG91dHNpZGUgdGhlIEhWTU9QIGh5cGVyY2FsbHMuCgpTaWduZWQtb2Zm
LWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxAaW50ZWwuY29tPgotLS0KIHhlbi9h
cmNoL3g4Ni9odm0vaHZtLmMgICAgICAgIHwgMjQxICsrKysrKysrKysrKysrKysrKysrKy0tLS0t
LS0tLS0tLS0KIHhlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oIHwgICAyICsKIDIgZmlsZXMg
Y2hhbmdlZCwgMTUyIGluc2VydGlvbnMoKyksIDkxIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBh
L3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMgYi94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCmluZGV4IDQ3
MjNmNWQwOWMuLjI0ZjA4ZDcwNDMgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMK
KysrIGIveGVuL2FyY2gveDg2L2h2bS9odm0uYwpAQCAtNDA2NywxNiArNDA2NywxNyBAQCBzdGF0
aWMgaW50IGh2bW9wX3NldF9ldnRjaG5fdXBjYWxsX3ZlY3RvcigKIH0KIAogc3RhdGljIGludCBo
dm1fYWxsb3dfc2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsCi0gICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgY29uc3Qgc3RydWN0IHhlbl9odm1fcGFyYW0gKmEpCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgdWludDMyX3QgaW5kZXgsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgdWludDY0X3QgbmV3X3ZhbHVlKQogewotICAgIHVpbnQ2NF90IHZhbHVlID0gZC0+
YXJjaC5odm0ucGFyYW1zW2EtPmluZGV4XTsKKyAgICB1aW50NjRfdCB2YWx1ZSA9IGQtPmFyY2gu
aHZtLnBhcmFtc1tpbmRleF07CiAgICAgaW50IHJjOwogCiAgICAgcmMgPSB4c21faHZtX3BhcmFt
KFhTTV9UQVJHRVQsIGQsIEhWTU9QX3NldF9wYXJhbSk7CiAgICAgaWYgKCByYyApCiAgICAgICAg
IHJldHVybiByYzsKIAotICAgIHN3aXRjaCAoIGEtPmluZGV4ICkKKyAgICBzd2l0Y2ggKCBpbmRl
eCApCiAgICAgewogICAgIC8qIFRoZSBmb2xsb3dpbmcgcGFyYW1ldGVycyBjYW4gYmUgc2V0IGJ5
IHRoZSBndWVzdC4gKi8KICAgICBjYXNlIEhWTV9QQVJBTV9DQUxMQkFDS19JUlE6CkBAIC00MTA5
LDcgKzQxMTAsNyBAQCBzdGF0aWMgaW50IGh2bV9hbGxvd19zZXRfcGFyYW0oc3RydWN0IGRvbWFp
biAqZCwKICAgICBpZiAoIHJjICkKICAgICAgICAgcmV0dXJuIHJjOwogCi0gICAgc3dpdGNoICgg
YS0+aW5kZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAgICB7CiAgICAgLyogVGhlIGZvbGxv
d2luZyBwYXJhbWV0ZXJzIHNob3VsZCBvbmx5IGJlIGNoYW5nZWQgb25jZS4gKi8KICAgICBjYXNl
IEhWTV9QQVJBTV9WSVJJRElBTjoKQEAgLTQxMTksNyArNDEyMCw3IEBAIHN0YXRpYyBpbnQgaHZt
X2FsbG93X3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIGNhc2UgSFZNX1BBUkFNX05S
X0lPUkVRX1NFUlZFUl9QQUdFUzoKICAgICBjYXNlIEhWTV9QQVJBTV9BTFRQMk06CiAgICAgY2Fz
ZSBIVk1fUEFSQU1fTUNBX0NBUDoKLSAgICAgICAgaWYgKCB2YWx1ZSAhPSAwICYmIGEtPnZhbHVl
ICE9IHZhbHVlICkKKyAgICAgICAgaWYgKCB2YWx1ZSAhPSAwICYmIG5ld192YWx1ZSAhPSB2YWx1
ZSApCiAgICAgICAgICAgICByYyA9IC1FRVhJU1Q7CiAgICAgICAgIGJyZWFrOwogICAgIGRlZmF1
bHQ6CkBAIC00MTI5LDQ5ICs0MTMwLDMyIEBAIHN0YXRpYyBpbnQgaHZtX2FsbG93X3NldF9wYXJh
bShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHJldHVybiByYzsKIH0KIAotc3RhdGljIGludCBodm1v
cF9zZXRfcGFyYW0oCi0gICAgWEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5faHZtX3BhcmFtX3Qp
IGFyZykKK3N0YXRpYyBpbnQgaHZtX3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLCB1aW50MzJf
dCBpbmRleCwgdWludDY0X3QgdmFsdWUpCiB7CiAgICAgc3RydWN0IGRvbWFpbiAqY3Vycl9kID0g
Y3VycmVudC0+ZG9tYWluOwotICAgIHN0cnVjdCB4ZW5faHZtX3BhcmFtIGE7Ci0gICAgc3RydWN0
IGRvbWFpbiAqZDsKLSAgICBzdHJ1Y3QgdmNwdSAqdjsKICAgICBpbnQgcmM7CisgICAgc3RydWN0
IHZjcHUgKnY7CiAKLSAgICBpZiAoIGNvcHlfZnJvbV9ndWVzdCgmYSwgYXJnLCAxKSApCi0gICAg
ICAgIHJldHVybiAtRUZBVUxUOwotCi0gICAgaWYgKCBhLmluZGV4ID49IEhWTV9OUl9QQVJBTVMg
KQorICAgIGlmICggaW5kZXggPj0gSFZNX05SX1BBUkFNUyApCiAgICAgICAgIHJldHVybiAtRUlO
VkFMOwogCi0gICAgLyogTWFrZSBzdXJlIHRoZSBhYm92ZSBib3VuZCBjaGVjayBpcyBub3QgYnlw
YXNzZWQgZHVyaW5nIHNwZWN1bGF0aW9uLiAqLwotICAgIGJsb2NrX3NwZWN1bGF0aW9uKCk7Ci0K
LSAgICBkID0gcmN1X2xvY2tfZG9tYWluX2J5X2FueV9pZChhLmRvbWlkKTsKLSAgICBpZiAoIGQg
PT0gTlVMTCApCi0gICAgICAgIHJldHVybiAtRVNSQ0g7Ci0KLSAgICByYyA9IC1FSU5WQUw7Ci0g
ICAgaWYgKCAhaXNfaHZtX2RvbWFpbihkKSApCi0gICAgICAgIGdvdG8gb3V0OwotCi0gICAgcmMg
PSBodm1fYWxsb3dfc2V0X3BhcmFtKGQsICZhKTsKKyAgICByYyA9IGh2bV9hbGxvd19zZXRfcGFy
YW0oZCwgaW5kZXgsIHZhbHVlKTsKICAgICBpZiAoIHJjICkKICAgICAgICAgZ290byBvdXQ7CiAK
LSAgICBzd2l0Y2ggKCBhLmluZGV4ICkKKyAgICBzd2l0Y2ggKCBpbmRleCApCiAgICAgewogICAg
IGNhc2UgSFZNX1BBUkFNX0NBTExCQUNLX0lSUToKLSAgICAgICAgaHZtX3NldF9jYWxsYmFja192
aWEoZCwgYS52YWx1ZSk7CisgICAgICAgIGh2bV9zZXRfY2FsbGJhY2tfdmlhKGQsIHZhbHVlKTsK
ICAgICAgICAgaHZtX2xhdGNoX3NoaW5mb19zaXplKGQpOwogICAgICAgICBicmVhazsKICAgICBj
YXNlIEhWTV9QQVJBTV9USU1FUl9NT0RFOgotICAgICAgICBpZiAoIGEudmFsdWUgPiBIVk1QVE1f
b25lX21pc3NlZF90aWNrX3BlbmRpbmcgKQorICAgICAgICBpZiAoIHZhbHVlID4gSFZNUFRNX29u
ZV9taXNzZWRfdGlja19wZW5kaW5nICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAgICAg
ICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fVklSSURJQU46Ci0gICAgICAgIGlmICggKGEu
dmFsdWUgJiB+SFZNUFZfZmVhdHVyZV9tYXNrKSB8fAotICAgICAgICAgICAgICEoYS52YWx1ZSAm
IEhWTVBWX2Jhc2VfZnJlcSkgKQorICAgICAgICBpZiAoICh2YWx1ZSAmIH5IVk1QVl9mZWF0dXJl
X21hc2spIHx8CisgICAgICAgICAgICAgISh2YWx1ZSAmIEhWTVBWX2Jhc2VfZnJlcSkgKQogICAg
ICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJB
TV9JREVOVF9QVDoKQEAgLTQxODEsNyArNDE2NSw3IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3Bh
cmFtKAogICAgICAgICAgKi8KICAgICAgICAgaWYgKCAhcGFnaW5nX21vZGVfaGFwKGQpIHx8ICFj
cHVfaGFzX3ZteCApCiAgICAgICAgIHsKLSAgICAgICAgICAgIGQtPmFyY2guaHZtLnBhcmFtc1th
LmluZGV4XSA9IGEudmFsdWU7CisgICAgICAgICAgICBkLT5hcmNoLmh2bS5wYXJhbXNbaW5kZXhd
ID0gdmFsdWU7CiAgICAgICAgICAgICBicmVhazsKICAgICAgICAgfQogCkBAIC00MTk2LDcgKzQx
ODAsNyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgKIAogICAgICAgICByYyA9IDA7CiAg
ICAgICAgIGRvbWFpbl9wYXVzZShkKTsKLSAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1zW2EuaW5k
ZXhdID0gYS52YWx1ZTsKKyAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1zW2luZGV4XSA9IHZhbHVl
OwogICAgICAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCiAgICAgICAgICAgICBwYWdpbmdfdXBk
YXRlX2NyMyh2LCBmYWxzZSk7CiAgICAgICAgIGRvbWFpbl91bnBhdXNlKGQpOwpAQCAtNDIwNSwy
MyArNDE4OSwyMyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgKICAgICAgICAgYnJlYWs7
CiAgICAgY2FzZSBIVk1fUEFSQU1fRE1fRE9NQUlOOgogICAgICAgICAvKiBUaGUgb25seSB2YWx1
ZSB0aGlzIHNob3VsZCBldmVyIGJlIHNldCB0byBpcyBET01JRF9TRUxGICovCi0gICAgICAgIGlm
ICggYS52YWx1ZSAhPSBET01JRF9TRUxGICkKKyAgICAgICAgaWYgKCB2YWx1ZSAhPSBET01JRF9T
RUxGICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKIAotICAgICAgICBhLnZhbHVlID0gY3Vy
cl9kLT5kb21haW5faWQ7CisgICAgICAgIHZhbHVlID0gY3Vycl9kLT5kb21haW5faWQ7CiAgICAg
ICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX0FDUElfU19TVEFURToKICAgICAgICAgcmMg
PSAwOwotICAgICAgICBpZiAoIGEudmFsdWUgPT0gMyApCisgICAgICAgIGlmICggdmFsdWUgPT0g
MyApCiAgICAgICAgICAgICBodm1fczNfc3VzcGVuZChkKTsKLSAgICAgICAgZWxzZSBpZiAoIGEu
dmFsdWUgPT0gMCApCisgICAgICAgIGVsc2UgaWYgKCB2YWx1ZSA9PSAwICkKICAgICAgICAgICAg
IGh2bV9zM19yZXN1bWUoZCk7CiAgICAgICAgIGVsc2UKICAgICAgICAgICAgIHJjID0gLUVJTlZB
TDsKIAogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJBTV9BQ1BJX0lPUE9SVFNfTE9D
QVRJT046Ci0gICAgICAgIHJjID0gcG10aW1lcl9jaGFuZ2VfaW9wb3J0KGQsIGEudmFsdWUpOwor
ICAgICAgICByYyA9IHBtdGltZXJfY2hhbmdlX2lvcG9ydChkLCB2YWx1ZSk7CiAgICAgICAgIGJy
ZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX01FTU9SWV9FVkVOVF9DUjA6CiAgICAgY2FzZSBIVk1f
UEFSQU1fTUVNT1JZX0VWRU5UX0NSMzoKQEAgLTQyMzYsMjQgKzQyMjAsMjQgQEAgc3RhdGljIGlu
dCBodm1vcF9zZXRfcGFyYW0oCiAgICAgICAgIHJjID0geHNtX2h2bV9wYXJhbV9uZXN0ZWQoWFNN
X1BSSVYsIGQpOwogICAgICAgICBpZiAoIHJjICkKICAgICAgICAgICAgIGJyZWFrOwotICAgICAg
ICBpZiAoIGEudmFsdWUgPiAxICkKKyAgICAgICAgaWYgKCB2YWx1ZSA+IDEgKQogICAgICAgICAg
ICAgcmMgPSAtRUlOVkFMOwogICAgICAgICAvKgogICAgICAgICAgKiBSZW1vdmUgdGhlIGNoZWNr
IGJlbG93IG9uY2Ugd2UgaGF2ZQogICAgICAgICAgKiBzaGFkb3ctb24tc2hhZG93LgogICAgICAg
ICAgKi8KLSAgICAgICAgaWYgKCAhcGFnaW5nX21vZGVfaGFwKGQpICYmIGEudmFsdWUgKQorICAg
ICAgICBpZiAoICFwYWdpbmdfbW9kZV9oYXAoZCkgJiYgdmFsdWUgKQogICAgICAgICAgICAgcmMg
PSAtRUlOVkFMOwotICAgICAgICBpZiAoIGEudmFsdWUgJiYKKyAgICAgICAgaWYgKCB2YWx1ZSAm
JgogICAgICAgICAgICAgIGQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1fQUxUUDJNXSApCiAg
ICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgIC8qIFNldCB1cCBOSFZNIHN0YXRlIGZv
ciBhbnkgdmNwdXMgdGhhdCBhcmUgYWxyZWFkeSB1cC4gKi8KLSAgICAgICAgaWYgKCBhLnZhbHVl
ICYmCisgICAgICAgIGlmICggdmFsdWUgJiYKICAgICAgICAgICAgICAhZC0+YXJjaC5odm0ucGFy
YW1zW0hWTV9QQVJBTV9ORVNURURIVk1dICkKICAgICAgICAgICAgIGZvcl9lYWNoX3ZjcHUoZCwg
dikKICAgICAgICAgICAgICAgICBpZiAoIHJjID09IDAgKQogICAgICAgICAgICAgICAgICAgICBy
YyA9IG5lc3RlZGh2bV92Y3B1X2luaXRpYWxpc2Uodik7Ci0gICAgICAgIGlmICggIWEudmFsdWUg
fHwgcmMgKQorICAgICAgICBpZiAoICF2YWx1ZSB8fCByYyApCiAgICAgICAgICAgICBmb3JfZWFj
aF92Y3B1KGQsIHYpCiAgICAgICAgICAgICAgICAgbmVzdGVkaHZtX3ZjcHVfZGVzdHJveSh2KTsK
ICAgICAgICAgYnJlYWs7CkBAIC00MjYxLDMwICs0MjQ1LDMwIEBAIHN0YXRpYyBpbnQgaHZtb3Bf
c2V0X3BhcmFtKAogICAgICAgICByYyA9IHhzbV9odm1fcGFyYW1fYWx0cDJtaHZtKFhTTV9QUklW
LCBkKTsKICAgICAgICAgaWYgKCByYyApCiAgICAgICAgICAgICBicmVhazsKLSAgICAgICAgaWYg
KCBhLnZhbHVlID4gWEVOX0FMVFAyTV9saW1pdGVkICkKKyAgICAgICAgaWYgKCB2YWx1ZSA+IFhF
Tl9BTFRQMk1fbGltaXRlZCApCiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7Ci0gICAgICAgIGlm
ICggYS52YWx1ZSAmJgorICAgICAgICBpZiAoIHZhbHVlICYmCiAgICAgICAgICAgICAgZC0+YXJj
aC5odm0ucGFyYW1zW0hWTV9QQVJBTV9ORVNURURIVk1dICkKICAgICAgICAgICAgIHJjID0gLUVJ
TlZBTDsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fVFJJUExFX0ZBVUxUX1JF
QVNPTjoKLSAgICAgICAgaWYgKCBhLnZhbHVlID4gU0hVVERPV05fTUFYICkKKyAgICAgICAgaWYg
KCB2YWx1ZSA+IFNIVVRET1dOX01BWCApCiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAg
ICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX0lPUkVRX1NFUlZFUl9QRk46Ci0gICAgICAg
IGQtPmFyY2guaHZtLmlvcmVxX2dmbi5iYXNlID0gYS52YWx1ZTsKKyAgICAgICAgZC0+YXJjaC5o
dm0uaW9yZXFfZ2ZuLmJhc2UgPSB2YWx1ZTsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1f
UEFSQU1fTlJfSU9SRVFfU0VSVkVSX1BBR0VTOgogICAgIHsKICAgICAgICAgdW5zaWduZWQgaW50
IGk7CiAKLSAgICAgICAgaWYgKCBhLnZhbHVlID09IDAgfHwKLSAgICAgICAgICAgICBhLnZhbHVl
ID4gc2l6ZW9mKGQtPmFyY2guaHZtLmlvcmVxX2dmbi5tYXNrKSAqIDggKQorICAgICAgICBpZiAo
IHZhbHVlID09IDAgfHwKKyAgICAgICAgICAgICB2YWx1ZSA+IHNpemVvZihkLT5hcmNoLmh2bS5p
b3JlcV9nZm4ubWFzaykgKiA4ICkKICAgICAgICAgewogICAgICAgICAgICAgcmMgPSAtRUlOVkFM
OwogICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIH0KLSAgICAgICAgZm9yICggaSA9IDA7IGkg
PCBhLnZhbHVlOyBpKysgKQorICAgICAgICBmb3IgKCBpID0gMDsgaSA8IHZhbHVlOyBpKysgKQog
ICAgICAgICAgICAgc2V0X2JpdChpLCAmZC0+YXJjaC5odm0uaW9yZXFfZ2ZuLm1hc2spOwogCiAg
ICAgICAgIGJyZWFrOwpAQCAtNDI5NiwzNSArNDI4MCwzNSBAQCBzdGF0aWMgaW50IGh2bW9wX3Nl
dF9wYXJhbSgKICAgICAgICAgICAgICAgICAgICAgIHNpemVvZihkLT5hcmNoLmh2bS5pb3JlcV9n
Zm4ubGVnYWN5X21hc2spICogOCk7CiAgICAgICAgIEJVSUxEX0JVR19PTihIVk1fUEFSQU1fQlVG
SU9SRVFfUEZOID4KICAgICAgICAgICAgICAgICAgICAgIHNpemVvZihkLT5hcmNoLmh2bS5pb3Jl
cV9nZm4ubGVnYWN5X21hc2spICogOCk7Ci0gICAgICAgIGlmICggYS52YWx1ZSApCi0gICAgICAg
ICAgICBzZXRfYml0KGEuaW5kZXgsICZkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubGVnYWN5X21hc2sp
OworICAgICAgICBpZiAoIHZhbHVlICkKKyAgICAgICAgICAgIHNldF9iaXQoaW5kZXgsICZkLT5h
cmNoLmh2bS5pb3JlcV9nZm4ubGVnYWN5X21hc2spOwogICAgICAgICBicmVhazsKIAogICAgIGNh
c2UgSFZNX1BBUkFNX1g4N19GSVBfV0lEVEg6Ci0gICAgICAgIGlmICggYS52YWx1ZSAhPSAwICYm
IGEudmFsdWUgIT0gNCAmJiBhLnZhbHVlICE9IDggKQorICAgICAgICBpZiAoIHZhbHVlICE9IDAg
JiYgdmFsdWUgIT0gNCAmJiB2YWx1ZSAhPSA4ICkKICAgICAgICAgewogICAgICAgICAgICAgcmMg
PSAtRUlOVkFMOwogICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIH0KLSAgICAgICAgZC0+YXJj
aC54ODdfZmlwX3dpZHRoID0gYS52YWx1ZTsKKyAgICAgICAgZC0+YXJjaC54ODdfZmlwX3dpZHRo
ID0gdmFsdWU7CiAgICAgICAgIGJyZWFrOwogCiAgICAgY2FzZSBIVk1fUEFSQU1fVk04Nl9UU1M6
CiAgICAgICAgIC8qIEhhcmR3YXJlIHdvdWxkIHNpbGVudGx5IHRydW5jYXRlIGhpZ2ggYml0cy4g
Ki8KLSAgICAgICAgaWYgKCBhLnZhbHVlICE9ICh1aW50MzJfdClhLnZhbHVlICkKKyAgICAgICAg
aWYgKCB2YWx1ZSAhPSAodWludDMyX3QpdmFsdWUgKQogICAgICAgICB7CiAgICAgICAgICAgICBp
ZiAoIGQgPT0gY3Vycl9kICkKICAgICAgICAgICAgICAgICBkb21haW5fY3Jhc2goZCk7CiAgICAg
ICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgIH0KICAgICAgICAgLyogT2xkIGh2bWxvYWRl
ciBiaW5hcmllcyBoYXJkY29kZSB0aGUgc2l6ZSB0byAxMjggYnl0ZXMuICovCi0gICAgICAgIGlm
ICggYS52YWx1ZSApCi0gICAgICAgICAgICBhLnZhbHVlIHw9ICgxMjhVTEwgPDwgMzIpIHwgVk04
Nl9UU1NfVVBEQVRFRDsKLSAgICAgICAgYS5pbmRleCA9IEhWTV9QQVJBTV9WTTg2X1RTU19TSVpF
RDsKKyAgICAgICAgaWYgKCB2YWx1ZSApCisgICAgICAgICAgICB2YWx1ZSB8PSAoMTI4VUxMIDw8
IDMyKSB8IFZNODZfVFNTX1VQREFURUQ7CisgICAgICAgIGluZGV4ID0gSFZNX1BBUkFNX1ZNODZf
VFNTX1NJWkVEOwogICAgICAgICBicmVhazsKIAogICAgIGNhc2UgSFZNX1BBUkFNX1ZNODZfVFNT
X1NJWkVEOgotICAgICAgICBpZiAoIChhLnZhbHVlID4+IDMyKSA8IHNpemVvZihzdHJ1Y3QgdHNz
MzIpICkKKyAgICAgICAgaWYgKCAodmFsdWUgPj4gMzIpIDwgc2l6ZW9mKHN0cnVjdCB0c3MzMikg
KQogICAgICAgICB7CiAgICAgICAgICAgICBpZiAoIGQgPT0gY3Vycl9kICkKICAgICAgICAgICAg
ICAgICBkb21haW5fY3Jhc2goZCk7CkBAIC00MzM1LDI2ICs0MzE5LDU2IEBAIHN0YXRpYyBpbnQg
aHZtb3Bfc2V0X3BhcmFtKAogICAgICAgICAgKiAyNTYgYml0cyBpbnRlcnJ1cHQgcmVkaXJlY3Rp
b24gYml0bWFwICsgNjRrIGJpdHMgSS9PIGJpdG1hcAogICAgICAgICAgKiBwbHVzIG9uZSBwYWRk
aW5nIGJ5dGUpLgogICAgICAgICAgKi8KLSAgICAgICAgaWYgKCAoYS52YWx1ZSA+PiAzMikgPiBz
aXplb2Yoc3RydWN0IHRzczMyKSArCisgICAgICAgIGlmICggKHZhbHVlID4+IDMyKSA+IHNpemVv
ZihzdHJ1Y3QgdHNzMzIpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMHgxMDAg
LyA4KSArICgweDEwMDAwIC8gOCkgKyAxICkKLSAgICAgICAgICAgIGEudmFsdWUgPSAodWludDMy
X3QpYS52YWx1ZSB8CisgICAgICAgICAgICB2YWx1ZSA9ICh1aW50MzJfdCl2YWx1ZSB8CiAgICAg
ICAgICAgICAgICAgICAgICAgKChzaXplb2Yoc3RydWN0IHRzczMyKSArICgweDEwMCAvIDgpICsK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKDB4MTAwMDAg
LyA4KSArIDEpIDw8IDMyKTsKLSAgICAgICAgYS52YWx1ZSB8PSBWTTg2X1RTU19VUERBVEVEOwor
ICAgICAgICB2YWx1ZSB8PSBWTTg2X1RTU19VUERBVEVEOwogICAgICAgICBicmVhazsKIAogICAg
IGNhc2UgSFZNX1BBUkFNX01DQV9DQVA6Ci0gICAgICAgIHJjID0gdm1jZV9lbmFibGVfbWNhX2Nh
cChkLCBhLnZhbHVlKTsKKyAgICAgICAgcmMgPSB2bWNlX2VuYWJsZV9tY2FfY2FwKGQsIHZhbHVl
KTsKICAgICAgICAgYnJlYWs7CiAgICAgfQogCiAgICAgaWYgKCByYyAhPSAwICkKICAgICAgICAg
Z290byBvdXQ7CiAKLSAgICBkLT5hcmNoLmh2bS5wYXJhbXNbYS5pbmRleF0gPSBhLnZhbHVlOwor
ICAgIGQtPmFyY2guaHZtLnBhcmFtc1tpbmRleF0gPSB2YWx1ZTsKIAogICAgIEhWTV9EQkdfTE9H
KERCR19MRVZFTF9IQ0FMTCwgInNldCBwYXJhbSAldSA9ICUiUFJJeDY0LAotICAgICAgICAgICAg
ICAgIGEuaW5kZXgsIGEudmFsdWUpOworICAgICAgICAgICAgICAgIGluZGV4LCB2YWx1ZSk7CisK
KyBvdXQ6CisgICAgcmV0dXJuIHJjOworfQorCitpbnQgaHZtb3Bfc2V0X3BhcmFtKAorICAgIFhF
Tl9HVUVTVF9IQU5ETEVfUEFSQU0oeGVuX2h2bV9wYXJhbV90KSBhcmcpCit7CisgICAgc3RydWN0
IHhlbl9odm1fcGFyYW0gYTsKKyAgICBzdHJ1Y3QgZG9tYWluICpkOworICAgIGludCByYzsKKwor
ICAgIGlmICggY29weV9mcm9tX2d1ZXN0KCZhLCBhcmcsIDEpICkKKyAgICAgICAgcmV0dXJuIC1F
RkFVTFQ7CisKKyAgICBpZiAoIGEuaW5kZXggPj0gSFZNX05SX1BBUkFNUyApCisgICAgICAgIHJl
dHVybiAtRUlOVkFMOworCisgICAgLyogTWFrZSBzdXJlIHRoZSBhYm92ZSBib3VuZCBjaGVjayBp
cyBub3QgYnlwYXNzZWQgZHVyaW5nIHNwZWN1bGF0aW9uLiAqLworICAgIGJsb2NrX3NwZWN1bGF0
aW9uKCk7CisKKyAgICBkID0gcmN1X2xvY2tfZG9tYWluX2J5X2FueV9pZChhLmRvbWlkKTsKKyAg
ICBpZiAoIGQgPT0gTlVMTCApCisgICAgICAgIHJldHVybiAtRVNSQ0g7CisKKyAgICByYyA9IC1F
SU5WQUw7CisgICAgaWYgKCAhaXNfaHZtX2RvbWFpbihkKSApCisgICAgICAgIGdvdG8gb3V0Owor
CisgICAgcmMgPSBodm1fc2V0X3BhcmFtKGQsIGEuaW5kZXgsIGEudmFsdWUpOwogCiAgb3V0Ogog
ICAgIHJjdV91bmxvY2tfZG9tYWluKGQpOwpAQCAtNDM2Miw3ICs0Mzc2LDcgQEAgc3RhdGljIGlu
dCBodm1vcF9zZXRfcGFyYW0oCiB9CiAKIHN0YXRpYyBpbnQgaHZtX2FsbG93X2dldF9wYXJhbShz
dHJ1Y3QgZG9tYWluICpkLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0
cnVjdCB4ZW5faHZtX3BhcmFtICphKQorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVp
bnQzMl90IGluZGV4KQogewogICAgIGludCByYzsKIApAQCAtNDM3MCw3ICs0Mzg0LDcgQEAgc3Rh
dGljIGludCBodm1fYWxsb3dfZ2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsCiAgICAgaWYgKCBy
YyApCiAgICAgICAgIHJldHVybiByYzsKIAotICAgIHN3aXRjaCAoIGEtPmluZGV4ICkKKyAgICBz
d2l0Y2ggKCBpbmRleCApCiAgICAgewogICAgIC8qIFRoZSBmb2xsb3dpbmcgcGFyYW1ldGVycyBj
YW4gYmUgcmVhZCBieSB0aGUgZ3Vlc3QuICovCiAgICAgY2FzZSBIVk1fUEFSQU1fQ0FMTEJBQ0tf
SVJROgpAQCAtNDQwMCw2ICs0NDE0LDQzIEBAIHN0YXRpYyBpbnQgaHZtX2FsbG93X2dldF9wYXJh
bShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHJldHVybiByYzsKIH0KIAorc3RhdGljIGludCBodm1f
Z2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsIHVpbnQzMl90IGluZGV4LCB1aW50NjRfdCAqdmFs
dWUpCit7CisgICAgaW50IHJjOworCisgICAgaWYgKCBpbmRleCA+PSBIVk1fTlJfUEFSQU1TIHx8
ICF2YWx1ZSApCisgICAgICAgIHJldHVybiAtRUlOVkFMOworCisgICAgcmMgPSBodm1fYWxsb3df
Z2V0X3BhcmFtKGQsIGluZGV4KTsKKyAgICBpZiAoIHJjICkKKyAgICAgICAgcmV0dXJuIHJjOwor
CisgICAgc3dpdGNoICggaW5kZXggKQorICAgIHsKKyAgICBjYXNlIEhWTV9QQVJBTV9BQ1BJX1Nf
U1RBVEU6CisgICAgICAgICp2YWx1ZSA9IGQtPmFyY2guaHZtLmlzX3MzX3N1c3BlbmRlZCA/IDMg
OiAwOworICAgICAgICBicmVhazsKKworICAgIGNhc2UgSFZNX1BBUkFNX1ZNODZfVFNTOgorICAg
ICAgICAqdmFsdWUgPSAodWludDMyX3QpZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9WTTg2
X1RTU19TSVpFRF07CisgICAgICAgIGJyZWFrOworCisgICAgY2FzZSBIVk1fUEFSQU1fVk04Nl9U
U1NfU0laRUQ6CisgICAgICAgICp2YWx1ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1f
Vk04Nl9UU1NfU0laRURdICYKKyAgICAgICAgICAgICAgICAgICB+Vk04Nl9UU1NfVVBEQVRFRDsK
KyAgICAgICAgYnJlYWs7CisKKyAgICBjYXNlIEhWTV9QQVJBTV9YODdfRklQX1dJRFRIOgorICAg
ICAgICAqdmFsdWUgPSBkLT5hcmNoLng4N19maXBfd2lkdGg7CisgICAgICAgIGJyZWFrOworICAg
IGRlZmF1bHQ6CisgICAgICAgICp2YWx1ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tpbmRleF07Cisg
ICAgICAgIGJyZWFrOworICAgIH0KKworICAgIHJldHVybiAwOworfTsKKwogc3RhdGljIGludCBo
dm1vcF9nZXRfcGFyYW0oCiAgICAgWEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5faHZtX3BhcmFt
X3QpIGFyZykKIHsKQEAgLTQ0MjQsMzMgKzQ0NzUsMTAgQEAgc3RhdGljIGludCBodm1vcF9nZXRf
cGFyYW0oCiAgICAgaWYgKCAhaXNfaHZtX2RvbWFpbihkKSApCiAgICAgICAgIGdvdG8gb3V0Owog
Ci0gICAgcmMgPSBodm1fYWxsb3dfZ2V0X3BhcmFtKGQsICZhKTsKKyAgICByYyA9IGh2bV9nZXRf
cGFyYW0oZCwgYS5pbmRleCwgJmEudmFsdWUpOwogICAgIGlmICggcmMgKQogICAgICAgICBnb3Rv
IG91dDsKIAotICAgIHN3aXRjaCAoIGEuaW5kZXggKQotICAgIHsKLSAgICBjYXNlIEhWTV9QQVJB
TV9BQ1BJX1NfU1RBVEU6Ci0gICAgICAgIGEudmFsdWUgPSBkLT5hcmNoLmh2bS5pc19zM19zdXNw
ZW5kZWQgPyAzIDogMDsKLSAgICAgICAgYnJlYWs7Ci0KLSAgICBjYXNlIEhWTV9QQVJBTV9WTTg2
X1RTUzoKLSAgICAgICAgYS52YWx1ZSA9ICh1aW50MzJfdClkLT5hcmNoLmh2bS5wYXJhbXNbSFZN
X1BBUkFNX1ZNODZfVFNTX1NJWkVEXTsKLSAgICAgICAgYnJlYWs7Ci0KLSAgICBjYXNlIEhWTV9Q
QVJBTV9WTTg2X1RTU19TSVpFRDoKLSAgICAgICAgYS52YWx1ZSA9IGQtPmFyY2guaHZtLnBhcmFt
c1tIVk1fUEFSQU1fVk04Nl9UU1NfU0laRURdICYKLSAgICAgICAgICAgICAgICAgIH5WTTg2X1RT
U19VUERBVEVEOwotICAgICAgICBicmVhazsKLQotICAgIGNhc2UgSFZNX1BBUkFNX1g4N19GSVBf
V0lEVEg6Ci0gICAgICAgIGEudmFsdWUgPSBkLT5hcmNoLng4N19maXBfd2lkdGg7Ci0gICAgICAg
IGJyZWFrOwotICAgIGRlZmF1bHQ6Ci0gICAgICAgIGEudmFsdWUgPSBkLT5hcmNoLmh2bS5wYXJh
bXNbYS5pbmRleF07Ci0gICAgICAgIGJyZWFrOwotICAgIH0KLQogICAgIHJjID0gX19jb3B5X3Rv
X2d1ZXN0KGFyZywgJmEsIDEpID8gLUVGQVVMVCA6IDA7CiAKICAgICBIVk1fREJHX0xPRyhEQkdf
TEVWRUxfSENBTEwsICJnZXQgcGFyYW0gJXUgPSAlIlBSSXg2NCwKQEAgLTUyNjYsNiArNTI5NCwz
NyBAQCB2b2lkIGh2bV9zZXRfc2VnbWVudF9yZWdpc3RlcihzdHJ1Y3QgdmNwdSAqdiwgZW51bSB4
ODZfc2VnbWVudCBzZWcsCiAgICAgYWx0ZXJuYXRpdmVfdmNhbGwoaHZtX2Z1bmNzLnNldF9zZWdt
ZW50X3JlZ2lzdGVyLCB2LCBzZWcsIHJlZyk7CiB9CiAKK2ludCBodm1fY29weV9jb250ZXh0X2Fu
ZF9wYXJhbXMoc3RydWN0IGRvbWFpbiAqc3JjLCBzdHJ1Y3QgZG9tYWluICpkc3QpCit7CisgICAg
aW50IHJjLCBpOworICAgIHN0cnVjdCBodm1fZG9tYWluX2NvbnRleHQgYyA9IHsgfTsKKworICAg
IGMuc2l6ZSA9IGh2bV9zYXZlX3NpemUoc3JjKTsKKyAgICBpZiAoIChjLmRhdGEgPSB4bWFsbG9j
X2J5dGVzKGMuc2l6ZSkpID09IE5VTEwgKQorICAgICAgICByZXR1cm4gLUVOT01FTTsKKworICAg
IGZvciAoIGkgPSAwOyBpIDwgSFZNX05SX1BBUkFNUzsgaSsrICkKKyAgICB7CisgICAgICAgIHVp
bnQ2NF90IHZhbHVlID0gMDsKKworICAgICAgICBpZiAoIGh2bV9nZXRfcGFyYW0oc3JjLCBpLCAm
dmFsdWUpIHx8ICF2YWx1ZSApCisgICAgICAgICAgICBjb250aW51ZTsKKworICAgICAgICBpZiAo
IChyYyA9IGh2bV9zZXRfcGFyYW0oZHN0LCBpLCB2YWx1ZSkpICkKKyAgICAgICAgICAgIGdvdG8g
b3V0OworICAgIH0KKworICAgIGlmICggKHJjID0gaHZtX3NhdmUoc3JjLCAmYykpICkKKyAgICAg
ICAgZ290byBvdXQ7CisKKyAgICBjLmN1ciA9IDA7CisgICAgcmMgPSBodm1fbG9hZChkc3QsICZj
KTsKKworb3V0OgorICAgIHhmcmVlKGMuZGF0YSk7CisgICAgcmV0dXJuIHJjOworfQorCiAvKgog
ICogTG9jYWwgdmFyaWFibGVzOgogICogbW9kZTogQwpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUv
YXNtLXg4Ni9odm0vaHZtLmggYi94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaAppbmRleCAw
OTc5M2MxMmU5Li42MTA2YjgyYzk1IDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2
bS9odm0uaAorKysgYi94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaApAQCAtMzM2LDYgKzMz
Niw4IEBAIHVuc2lnbmVkIGxvbmcgaHZtX2NyNF9ndWVzdF92YWxpZF9iaXRzKGNvbnN0IHN0cnVj
dCBkb21haW4gKmQsIGJvb2wgcmVzdG9yZSk7CiBib29sIGh2bV9mbHVzaF92Y3B1X3RsYihib29s
ICgqZmx1c2hfdmNwdSkodm9pZCAqY3R4dCwgc3RydWN0IHZjcHUgKnYpLAogICAgICAgICAgICAg
ICAgICAgICAgICAgdm9pZCAqY3R4dCk7CiAKK2ludCBodm1fY29weV9jb250ZXh0X2FuZF9wYXJh
bXMoc3RydWN0IGRvbWFpbiAqc3JjLCBzdHJ1Y3QgZG9tYWluICpkc3QpOworCiAjaWZkZWYgQ09O
RklHX0hWTQogCiAjZGVmaW5lIGh2bV9nZXRfZ3Vlc3RfdHNjKHYpIGh2bV9nZXRfZ3Vlc3RfdHNj
X2ZpeGVkKHYsIDApCi0tIAoyLjIwLjEKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54
ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGlu
Zm8veGVuLWRldmVs

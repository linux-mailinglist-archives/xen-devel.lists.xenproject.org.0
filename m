Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 906957FDEA
	for <lists+xen-devel@lfdr.de>; Fri,  2 Aug 2019 17:59:59 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1htZwU-0005uc-C1; Fri, 02 Aug 2019 15:58:06 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=Qji5=V6=citrix.com=anthony.perard@srs-us1.protection.inumbo.net>)
 id 1htZwS-0005tm-Bq
 for xen-devel@lists.xenproject.org; Fri, 02 Aug 2019 15:58:04 +0000
X-Inumbo-ID: 4e4939a0-b53e-11e9-a1ad-ffb9cc75931d
Received: from esa4.hc3370-68.iphmx.com (unknown [216.71.155.144])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 4e4939a0-b53e-11e9-a1ad-ffb9cc75931d;
 Fri, 02 Aug 2019 15:58:01 +0000 (UTC)
Authentication-Results: esa4.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=anthony.perard@citrix.com;
 spf=Pass smtp.mailfrom=anthony.perard@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa4.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 anthony.perard@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa4.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa4.hc3370-68.iphmx.com: domain of
 anthony.perard@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa4.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83 ~all"
Received-SPF: None (esa4.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa4.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: EZTo8lTXZmgTU+dMVYJ0BJxfwtTobgE3Ei6AvjuVQeqwtZ+w9sfzcSGDuSH3u2KdbIUDI3Frup
 Gac/wVGGQNFH4eqJf7lEIHW6WJva4tL/pNmBuAvDQi3vT4HeQ+gdd93eeFSQVtlT2SL0VNP9ve
 RMIkZcOjSxWuIAU/Vaiiq0+1MMVhiFTORYbrGNpM62r3ShF7yPOmQ0D4+wbdFuFZcc7I6JZlfp
 Dk3+kijOr0BfGbNpfz+T9/o9+5r30sWz4Hie6669B4rIoXo4Y2UCRO4c0XdmrsDQNMvIrS0Qly
 E18=
X-SBRS: 2.7
X-MesageID: 3951219
X-Ironport-Server: esa4.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.64,338,1559534400"; 
   d="scan'208";a="3951219"
From: Anthony PERARD <anthony.perard@citrix.com>
To: <xen-devel@lists.xenproject.org>
Date: Fri, 2 Aug 2019 16:35:58 +0100
Message-ID: <20190802153606.32061-28-anthony.perard@citrix.com>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190802153606.32061-1-anthony.perard@citrix.com>
References: <20190802153606.32061-1-anthony.perard@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH 27/35] libxl_pci: Use libxl__ao_device with
 libxl__device_pci_add
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Wei Liu <wl@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U2lnbmVkLW9mZi1ieTogQW50aG9ueSBQRVJBUkQgPGFudGhvbnkucGVyYXJkQGNpdHJpeC5jb20+
Ci0tLQogdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaCB8ICAgNyArLQogdG9vbHMvbGlieGwv
bGlieGxfcGNpLmMgICAgICB8IDE3MCArKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0t
LQogMiBmaWxlcyBjaGFuZ2VkLCAxNTAgaW5zZXJ0aW9ucygrKSwgMjcgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaCBiL3Rvb2xzL2xpYnhsL2xp
YnhsX2ludGVybmFsLmgKaW5kZXggNWMxNWE3M2EwOC4uZGQ5OTM0MTQxZiAxMDA2NDQKLS0tIGEv
dG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaAorKysgYi90b29scy9saWJ4bC9saWJ4bF9pbnRl
cm5hbC5oCkBAIC0xOTgsNiArMTk4LDcgQEAgdHlwZWRlZiBzdHJ1Y3QgbGlieGxfX2pzb25fb2Jq
ZWN0IGxpYnhsX19qc29uX29iamVjdDsKIHR5cGVkZWYgc3RydWN0IGxpYnhsX19jYXJlZmQgbGli
eGxfX2NhcmVmZDsKIHR5cGVkZWYgc3RydWN0IGxpYnhsX19ldl9sb2NrIGxpYnhsX19ldl9sb2Nr
OwogdHlwZWRlZiBzdHJ1Y3QgbGlieGxfX2RtX3Jlc3VtZV9zdGF0ZSBsaWJ4bF9fZG1fcmVzdW1l
X3N0YXRlOwordHlwZWRlZiBzdHJ1Y3QgbGlieGxfX2FvX2RldmljZSBsaWJ4bF9fYW9fZGV2aWNl
OwogCiB0eXBlZGVmIHN0cnVjdCBsaWJ4bF9fZG9tYWluX2NyZWF0ZV9zdGF0ZSBsaWJ4bF9fZG9t
YWluX2NyZWF0ZV9zdGF0ZTsKIHR5cGVkZWYgdm9pZCBsaWJ4bF9fZG9tYWluX2NyZWF0ZV9jYihz
dHJ1Y3QgbGlieGxfX2VnYyAqZWdjLApAQCAtMTU5Miw4ICsxNTkzLDkgQEAgX2hpZGRlbiBpbnQg
bGlieGxfX3BjaV90b3BvbG9neV9pbml0KGxpYnhsX19nYyAqZ2MsCiAKIC8qIGZyb20gbGlieGxf
cGNpICovCiAKLV9oaWRkZW4gaW50IGxpYnhsX19kZXZpY2VfcGNpX2FkZChsaWJ4bF9fZ2MgKmdj
LCB1aW50MzJfdCBkb21pZCwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWJ4
bF9kZXZpY2VfcGNpICpwY2lkZXYsIGJvb2wgc3RhcnRpbmcpOworX2hpZGRlbiB2b2lkIGxpYnhs
X19kZXZpY2VfcGNpX2FkZChsaWJ4bF9fZWdjICplZ2MsIHVpbnQzMl90IGRvbWlkLAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWJ4bF9kZXZpY2VfcGNpICpwY2lkZXYsIGJv
b2wgc3RhcnRpbmcsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpYnhsX19h
b19kZXZpY2UgKmFvZGV2KTsKIF9oaWRkZW4gaW50IGxpYnhsX19kZXZpY2VfcGNpX2Rlc3Ryb3lf
YWxsKGxpYnhsX19nYyAqZ2MsIHVpbnQzMl90IGRvbWlkKTsKIF9oaWRkZW4gYm9vbCBsaWJ4bF9f
aXNfaWdkX3ZnYV9wYXNzdGhydShsaWJ4bF9fZ2MgKmdjLAogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnKTsK
QEAgLTI1NzEsNyArMjU3Myw2IEBAIF9oaWRkZW4gdm9pZCBsaWJ4bF9fa2lsbChsaWJ4bF9fZ2Mg
KmdjLCBwaWRfdCBwaWQsIGludCBzaWcsIGNvbnN0IGNoYXIgKndoYXQpOwogCiAvKi0tLS0tIGRl
dmljZSBhZGRpdGlvbi9yZW1vdmFsIC0tLS0tKi8KIAotdHlwZWRlZiBzdHJ1Y3QgbGlieGxfX2Fv
X2RldmljZSBsaWJ4bF9fYW9fZGV2aWNlOwogdHlwZWRlZiBzdHJ1Y3QgbGlieGxfX211bHRpZGV2
IGxpYnhsX19tdWx0aWRldjsKIHR5cGVkZWYgdm9pZCBsaWJ4bF9fZGV2aWNlX2NhbGxiYWNrKGxp
YnhsX19lZ2MqLCBsaWJ4bF9fYW9fZGV2aWNlKik7CiAKZGlmZiAtLWdpdCBhL3Rvb2xzL2xpYnhs
L2xpYnhsX3BjaS5jIGIvdG9vbHMvbGlieGwvbGlieGxfcGNpLmMKaW5kZXggMDcxODgwYjg1NS4u
NTAzZGI2YzI2MCAxMDA2NDQKLS0tIGEvdG9vbHMvbGlieGwvbGlieGxfcGNpLmMKKysrIGIvdG9v
bHMvbGlieGwvbGlieGxfcGNpLmMKQEAgLTk4Myw5ICs5ODMsMjQgQEAgc3RhdGljIGludCBxZW11
X3BjaV9hZGRfeGVuc3RvcmUobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgcmV0
dXJuIHJjOwogfQogCi1zdGF0aWMgaW50IGRvX3BjaV9hZGQobGlieGxfX2djICpnYywgdWludDMy
X3QgZG9taWQsCi0gICAgICAgICAgICAgICAgICAgICAgbGlieGxfZGV2aWNlX3BjaSAqcGNpZGV2
LCBib29sIHN0YXJ0aW5nKQordHlwZWRlZiBzdHJ1Y3QgcGNpX2FkZF9zdGF0ZSB7CisgICAgLyog
ZmlsbGVkIGJ5IHVzZXIgb2YgZG9fcGNpX2FkZCAqLworICAgIGxpYnhsX19hb19kZXZpY2UgKmFv
ZGV2OworICAgIGxpYnhsX2RvbWlkIGRvbWlkOworICAgIGJvb2wgc3RhcnRpbmc7CisgICAgdm9p
ZCAoKmNhbGxiYWNrKShsaWJ4bF9fZWdjICosIHN0cnVjdCBwY2lfYWRkX3N0YXRlICosIGludCBy
Yyk7CisKKyAgICAvKiBwcml2YXRlIHRvIGRvX3BjaV9hZGQgKi8KKyAgICBsaWJ4bF9kZXZpY2Vf
cGNpICpwY2lkZXY7CisgICAgaW50IHBjaV9kb21pZDsKK30gcGNpX2FkZF9zdGF0ZTsKKworc3Rh
dGljIHZvaWQgZG9fcGNpX2FkZChsaWJ4bF9fZWdjICplZ2MsCisgICAgICAgICAgICAgICAgICAg
ICAgIGxpYnhsX2RvbWlkIGRvbWlkLAorICAgICAgICAgICAgICAgICAgICAgICBsaWJ4bF9kZXZp
Y2VfcGNpICpwY2lkZXYsCisgICAgICAgICAgICAgICAgICAgICAgIHBjaV9hZGRfc3RhdGUgKnBh
cykKIHsKKyAgICBTVEFURV9BT19HQyhwYXMtPmFvZGV2LT5hbyk7CiAgICAgbGlieGxfY3R4ICpj
dHggPSBsaWJ4bF9fZ2Nfb3duZXIoZ2MpOwogICAgIGxpYnhsX2RvbWFpbl90eXBlIHR5cGUgPSBs
aWJ4bF9fZG9tYWluX3R5cGUoZ2MsIGRvbWlkKTsKICAgICBjaGFyICpzeXNmc19wYXRoOwpAQCAt
OTk3LDYgKzEwMTIsMTMgQEAgc3RhdGljIGludCBkb19wY2lfYWRkKGxpYnhsX19nYyAqZ2MsIHVp
bnQzMl90IGRvbWlkLAogICAgIGJvb2wgaXNzdHViZG9tID0gbGlieGxfaXNfc3R1YmRvbShjdHgs
IGRvbWlkLCAmZG9tYWluaWQpOwogICAgIGludCByOwogCisgICAgLyogQ29udmVuaWVuY2UgYWxp
YXNlcyAqLworICAgIGJvb2wgc3RhcnRpbmcgPSBwYXMtPnN0YXJ0aW5nOworCisgICAgLyogaW5p
dCBwY2lfYWRkX3N0YXRlICovCisgICAgcGFzLT5wY2lkZXYgPSBwY2lkZXY7CisgICAgcGFzLT5w
Y2lfZG9taWQgPSBkb21pZDsKKwogICAgIGlmICh0eXBlID09IExJQlhMX0RPTUFJTl9UWVBFX0lO
VkFMSUQpIHsKICAgICAgICAgcmMgPSBFUlJPUl9GQUlMOwogICAgICAgICBnb3RvIG91dDsKQEAg
LTExMjMsNyArMTE0NSw3IEBAIHN0YXRpYyBpbnQgZG9fcGNpX2FkZChsaWJ4bF9fZ2MgKmdjLCB1
aW50MzJfdCBkb21pZCwKICAgICBlbHNlCiAgICAgICAgIHJjID0gMDsKIG91dDoKLSAgICByZXR1
cm4gcmM7CisgICAgcGFzLT5jYWxsYmFjayhlZ2MsIHBhcywgcmMpOwogfQogCiBzdGF0aWMgaW50
IGxpYnhsX19kZXZpY2VfcGNpX3Jlc2V0KGxpYnhsX19nYyAqZ2MsIHVuc2lnbmVkIGludCBkb21h
aW4sIHVuc2lnbmVkIGludCBidXMsCkBAIC0xMTc3LDkgKzExOTksMTQgQEAgaW50IGxpYnhsX2Rl
dmljZV9wY2lfYWRkKGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBkb21pZCwKICAgICAgICAgICAg
ICAgICAgICAgICAgICBjb25zdCBsaWJ4bF9hc3luY29wX2hvdyAqYW9faG93KQogewogICAgIEFP
X0NSRUFURShjdHgsIGRvbWlkLCBhb19ob3cpOwotICAgIGludCByYzsKLSAgICByYyA9IGxpYnhs
X19kZXZpY2VfcGNpX2FkZChnYywgZG9taWQsIHBjaWRldiwgZmFsc2UpOwotICAgIGxpYnhsX19h
b19jb21wbGV0ZShlZ2MsIGFvLCByYyk7CisgICAgbGlieGxfX2FvX2RldmljZSAqYW9kZXY7CisK
KyAgICBHQ05FVyhhb2Rldik7CisgICAgbGlieGxfX3ByZXBhcmVfYW9fZGV2aWNlKGFvLCBhb2Rl
dik7CisgICAgYW9kZXYtPmFjdGlvbiA9IExJQlhMX19ERVZJQ0VfQUNUSU9OX0FERDsKKyAgICBh
b2Rldi0+Y2FsbGJhY2sgPSBkZXZpY2VfYWRkcm1fYW9jb21wbGV0ZTsKKyAgICBhb2Rldi0+dXBk
YXRlX2pzb24gPSB0cnVlOworICAgIGxpYnhsX19kZXZpY2VfcGNpX2FkZChlZ2MsIGRvbWlkLCBw
Y2lkZXYsIGZhbHNlLCBhb2Rldik7CiAgICAgcmV0dXJuIEFPX0lOUFJPR1JFU1M7CiB9CiAKQEAg
LTEyMDAsMTQgKzEyMjcsMzEgQEAgc3RhdGljIGludCBsaWJ4bF9wY2lkZXZfYXNzaWduYWJsZShs
aWJ4bF9jdHggKmN0eCwgbGlieGxfZGV2aWNlX3BjaSAqcGNpZGV2KQogICAgIHJldHVybiBpICE9
IG51bTsKIH0KIAotaW50IGxpYnhsX19kZXZpY2VfcGNpX2FkZChsaWJ4bF9fZ2MgKmdjLCB1aW50
MzJfdCBkb21pZCwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfZGV2aWNlX3BjaSAq
cGNpZGV2LCBib29sIHN0YXJ0aW5nKQorc3RhdGljIHZvaWQgZGV2aWNlX3BjaV9hZGRfc3R1YmRv
bV9kb25lKGxpYnhsX19lZ2MgKmVnYywKKyAgICBwY2lfYWRkX3N0YXRlICosIGludCByYyk7Citz
dGF0aWMgdm9pZCBkZXZpY2VfcGNpX2FkZF9kb25lKGxpYnhsX19lZ2MgKmVnYywKKyAgICBwY2lf
YWRkX3N0YXRlICosIGludCByYyk7CisKK3ZvaWQgbGlieGxfX2RldmljZV9wY2lfYWRkKGxpYnhs
X19lZ2MgKmVnYywgdWludDMyX3QgZG9taWQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICBs
aWJ4bF9kZXZpY2VfcGNpICpwY2lkZXYsIGJvb2wgc3RhcnRpbmcsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICBsaWJ4bF9fYW9fZGV2aWNlICphb2RldikKIHsKKyAgICBTVEFURV9BT19HQyhh
b2Rldi0+YW8pOwogICAgIGxpYnhsX2N0eCAqY3R4ID0gbGlieGxfX2djX293bmVyKGdjKTsKLSAg
ICB1bnNpZ25lZCBpbnQgb3JpZ192ZGV2LCBwZnVuY19tYXNrOwogICAgIGxpYnhsX2RldmljZV9w
Y2kgKmFzc2lnbmVkOwotICAgIGludCBudW1fYXNzaWduZWQsIGksIHJjOworICAgIGludCBudW1f
YXNzaWduZWQsIHJjOwogICAgIGludCBzdHViZG9taWQgPSAwOworICAgIHBjaV9hZGRfc3RhdGUg
KnBhczsKKworICAgIC8qIFN0b3JlICpwY2lkZXYgdG8gYmUgdXNlZCBieSBjYWxsYmFja3MgKi8K
KyAgICBhb2Rldi0+ZGV2aWNlX2NvbmZpZyA9IHBjaWRldjsKKyAgICBhb2Rldi0+ZGV2aWNlX3R5
cGUgPSAmbGlieGxfX3BjaWRldl9kZXZ0eXBlOworCisgICAgR0NORVcocGFzKTsKKyAgICBwYXMt
PmFvZGV2ID0gYW9kZXY7CisgICAgcGFzLT5kb21pZCA9IGRvbWlkOworICAgIHBhcy0+c3RhcnRp
bmcgPSBzdGFydGluZzsKKyAgICBwYXMtPmNhbGxiYWNrID0gZGV2aWNlX3BjaV9hZGRfc3R1YmRv
bV9kb25lOwogCiAgICAgaWYgKGxpYnhsX19kb21haW5fdHlwZShnYywgZG9taWQpID09IExJQlhM
X0RPTUFJTl9UWVBFX0hWTSkgewogICAgICAgICByYyA9IHhjX3Rlc3RfYXNzaWduX2RldmljZShj
dHgtPnhjaCwgZG9taWQsIHBjaWRldl9lbmNvZGVfYmRmKHBjaWRldikpOwpAQCAtMTI1NCwxMyAr
MTI5OCwzOSBAQCBpbnQgbGlieGxfX2RldmljZV9wY2lfYWRkKGxpYnhsX19nYyAqZ2MsIHVpbnQz
Ml90IGRvbWlkLAogCiAgICAgc3R1YmRvbWlkID0gbGlieGxfZ2V0X3N0dWJkb21faWQoY3R4LCBk
b21pZCk7CiAgICAgaWYgKHN0dWJkb21pZCAhPSAwKSB7Ci0gICAgICAgIGxpYnhsX2RldmljZV9w
Y2kgcGNpZGV2X3MgPSAqcGNpZGV2OworICAgICAgICBsaWJ4bF9kZXZpY2VfcGNpICpwY2lkZXZf
czsKKworICAgICAgICBHQ05FVyhwY2lkZXZfcyk7CisgICAgICAgIGxpYnhsX2RldmljZV9wY2lf
aW5pdChwY2lkZXZfcyk7CisgICAgICAgIGxpYnhsX2RldmljZV9wY2lfY29weShDVFgsIHBjaWRl
dl9zLCBwY2lkZXYpOwogICAgICAgICAvKiBzdHViZG9tYWluIGlzIGFsd2F5cyBydW5uaW5nIGJ5
IG5vdywgZXZlbiBhdCBjcmVhdGUgdGltZSAqLwotICAgICAgICByYyA9IGRvX3BjaV9hZGQoZ2Ms
IHN0dWJkb21pZCwgJnBjaWRldl9zLCBmYWxzZSk7Ci0gICAgICAgIGlmICggcmMgKQotICAgICAg
ICAgICAgZ290byBvdXQ7CisgICAgICAgIHBhcy0+Y2FsbGJhY2sgPSBkZXZpY2VfcGNpX2FkZF9z
dHViZG9tX2RvbmU7CisgICAgICAgIGRvX3BjaV9hZGQoZWdjLCBzdHViZG9taWQsIHBjaWRldl9z
LCBwYXMpOyAvKiBtdXN0IGJlIGxhc3QgKi8KKyAgICAgICAgcmV0dXJuOwogICAgIH0KIAorICAg
IGRldmljZV9wY2lfYWRkX3N0dWJkb21fZG9uZShlZ2MsIHBhcywgMCk7IC8qIG11c3QgYmUgbGFz
dCAqLworICAgIHJldHVybjsKKworb3V0OgorICAgIGRldmljZV9wY2lfYWRkX2RvbmUoZWdjLCBw
YXMsIHJjKTsgLyogbXVzdCBiZSBsYXN0ICovCit9CisKK3N0YXRpYyB2b2lkIGRldmljZV9wY2lf
YWRkX3N0dWJkb21fZG9uZShsaWJ4bF9fZWdjICplZ2MsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgcGNpX2FkZF9zdGF0ZSAqcGFzLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGludCByYykKK3sKKyAgICBTVEFURV9BT19HQyhwYXMtPmFv
ZGV2LT5hbyk7CisgICAgdW5zaWduZWQgaW50IG9yaWdfdmRldiwgcGZ1bmNfbWFzazsKKyAgICBp
bnQgaTsKKworICAgIC8qIENvbnZlbmllbmNlIGFsaWFzZXMgKi8KKyAgICBsaWJ4bF9fYW9fZGV2
aWNlICphb2RldiA9IHBhcy0+YW9kZXY7CisgICAgbGlieGxfZG9taWQgZG9taWQgPSBwYXMtPmRv
bWlkOworICAgIGxpYnhsX2RldmljZV9wY2kgKnBjaWRldiA9IGFvZGV2LT5kZXZpY2VfY29uZmln
OworCisgICAgaWYgKHJjKSBnb3RvIG91dDsKKwogICAgIG9yaWdfdmRldiA9IHBjaWRldi0+dmRl
dmZuICYgfjdVOwogCiAgICAgaWYgKCBwY2lkZXYtPnZmdW5jX21hc2sgPT0gTElCWExfUENJX0ZV
TkNfQUxMICkgewpAQCAtMTI5MSwzMSArMTM2MSw4MyBAQCBpbnQgbGlieGxfX2RldmljZV9wY2lf
YWRkKGxpYnhsX19nYyAqZ2MsIHVpbnQzMl90IGRvbWlkLAogICAgICAgICAgICAgICAgICAqLwog
ICAgICAgICAgICAgICAgIHBjaWRldi0+dmRldmZuID0gb3JpZ192ZGV2OwogICAgICAgICAgICAg
fQotICAgICAgICAgICAgaWYgKCBkb19wY2lfYWRkKGdjLCBkb21pZCwgcGNpZGV2LCBzdGFydGlu
ZykgKQotICAgICAgICAgICAgICAgIHJjID0gRVJST1JfRkFJTDsKKyAgICAgICAgICAgIHBhcy0+
Y2FsbGJhY2sgPSBkZXZpY2VfcGNpX2FkZF9kb25lOworICAgICAgICAgICAgZG9fcGNpX2FkZChl
Z2MsIGRvbWlkLCBwY2lkZXYsIHBhcyk7IC8qIG11c3QgYmUgbGFzdCAqLworICAgICAgICAgICAg
cmV0dXJuOwogICAgICAgICB9CiAgICAgfQogCiBvdXQ6Ci0gICAgcmV0dXJuIHJjOworICAgIGRl
dmljZV9wY2lfYWRkX2RvbmUoZWdjLCBwYXMsIHJjKTsKK30KKworc3RhdGljIHZvaWQgZGV2aWNl
X3BjaV9hZGRfZG9uZShsaWJ4bF9fZWdjICplZ2MsCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHBjaV9hZGRfc3RhdGUgKnBhcywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgaW50IHJjKQoreworICAgIEVHQ19HQzsKKyAgICBsaWJ4bF9fYW9fZGV2aWNlICphb2RldiA9
IHBhcy0+YW9kZXY7CisgICAgbGlieGxfZG9taWQgZG9taWQgPSBwYXMtPmRvbWlkOworICAgIGxp
YnhsX2RldmljZV9wY2kgKnBjaWRldiA9IGFvZGV2LT5kZXZpY2VfY29uZmlnOworCisgICAgaWYg
KHJjKSB7CisgICAgICAgIExPR0QoRVJST1IsIGRvbWlkLAorICAgICAgICAgICAgICJsaWJ4bF9f
ZGV2aWNlX3BjaV9hZGQgIGZhaWxlZCBmb3IgIgorICAgICAgICAgICAgICJQQ0kgZGV2aWNlICV4
OiV4OiV4LiV4IChyYyAlZCkiLAorICAgICAgICAgICAgIHBjaWRldi0+ZG9tYWluLCBwY2lkZXYt
PmJ1cywgcGNpZGV2LT5kZXYsIHBjaWRldi0+ZnVuYywKKyAgICAgICAgICAgICByYyk7CisgICAg
fQorICAgIGFvZGV2LT5yYyA9IHJjOworICAgIGFvZGV2LT5jYWxsYmFjayhlZ2MsIGFvZGV2KTsK
IH0KIAordHlwZWRlZiBzdHJ1Y3QgeworICAgIGxpYnhsX19tdWx0aWRldiBtdWx0aWRldjsKKyAg
ICBsaWJ4bF9fYW9fZGV2aWNlICpvdXRlcl9hb2RldjsKKyAgICBsaWJ4bF9kb21haW5fY29uZmln
ICpkX2NvbmZpZzsKKyAgICBsaWJ4bF9kb21pZCBkb21pZDsKK30gYWRkX3BjaWRldnNfc3RhdGU7
CisKK3N0YXRpYyB2b2lkIGFkZF9wY2lkZXZzX2RvbmUobGlieGxfX2VnYyAqLCBsaWJ4bF9fbXVs
dGlkZXYgKiwgaW50IHJjKTsKKwogc3RhdGljIHZvaWQgbGlieGxfX2FkZF9wY2lkZXZzKGxpYnhs
X19lZ2MgKmVnYywgbGlieGxfX2FvICphbywgdWludDMyX3QgZG9taWQsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcsCiAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfX211bHRpZGV2ICptdWx0aWRldikKIHsKICAg
ICBBT19HQzsKLSAgICBsaWJ4bF9fYW9fZGV2aWNlICphb2RldiA9IGxpYnhsX19tdWx0aWRldl9w
cmVwYXJlKG11bHRpZGV2KTsKLSAgICBpbnQgaSwgcmMgPSAwOworICAgIGFkZF9wY2lkZXZzX3N0
YXRlICphcGRzOworICAgIGludCBpOworCisgICAgLyogV2UgbmVlZCB0byBzdGFydCBhIG5ldyBt
dWx0aWRldiBpbiBvcmRlciB0byBiZSBhYmxlIHRvIGV4ZWN1dGUKKyAgICAgKiBsaWJ4bF9fY3Jl
YXRlX3BjaV9iYWNrZW5kIG9ubHkgb25jZS4gKi8KKworICAgIEdDTkVXKGFwZHMpOworICAgIGFw
ZHMtPm91dGVyX2FvZGV2ID0gbGlieGxfX211bHRpZGV2X3ByZXBhcmUobXVsdGlkZXYpOworICAg
IGFwZHMtPmRfY29uZmlnID0gZF9jb25maWc7CisgICAgYXBkcy0+ZG9taWQgPSBkb21pZDsKKyAg
ICBhcGRzLT5tdWx0aWRldi5jYWxsYmFjayA9IGFkZF9wY2lkZXZzX2RvbmU7CisgICAgbGlieGxf
X211bHRpZGV2X2JlZ2luKGFvLCAmYXBkcy0+bXVsdGlkZXYpOwogCiAgICAgZm9yIChpID0gMDsg
aSA8IGRfY29uZmlnLT5udW1fcGNpZGV2czsgaSsrKSB7Ci0gICAgICAgIHJjID0gbGlieGxfX2Rl
dmljZV9wY2lfYWRkKGdjLCBkb21pZCwgJmRfY29uZmlnLT5wY2lkZXZzW2ldLCB0cnVlKTsKLSAg
ICAgICAgaWYgKHJjIDwgMCkgewotICAgICAgICAgICAgTE9HRChFUlJPUiwgZG9taWQsICJsaWJ4
bF9kZXZpY2VfcGNpX2FkZCBmYWlsZWQ6ICVkIiwgcmMpOwotICAgICAgICAgICAgZ290byBvdXQ7
Ci0gICAgICAgIH0KKyAgICAgICAgbGlieGxfX2FvX2RldmljZSAqYW9kZXYgPSBsaWJ4bF9fbXVs
dGlkZXZfcHJlcGFyZSgmYXBkcy0+bXVsdGlkZXYpOworICAgICAgICBsaWJ4bF9fZGV2aWNlX3Bj
aV9hZGQoZWdjLCBkb21pZCwgJmRfY29uZmlnLT5wY2lkZXZzW2ldLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdHJ1ZSwgYW9kZXYpOwogICAgIH0KIAorICAgIGxpYnhsX19tdWx0aWRl
dl9wcmVwYXJlZChlZ2MsICZhcGRzLT5tdWx0aWRldiwgMCk7Cit9CisKK3N0YXRpYyB2b2lkIGFk
ZF9wY2lkZXZzX2RvbmUobGlieGxfX2VnYyAqZWdjLCBsaWJ4bF9fbXVsdGlkZXYgKm11bHRpZGV2
LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgcmMpCit7CisgICAgRUdDX0dDOwor
ICAgIGFkZF9wY2lkZXZzX3N0YXRlICphcGRzID0gQ09OVEFJTkVSX09GKG11bHRpZGV2LCAqYXBk
cywgbXVsdGlkZXYpOworCisgICAgLyogQ29udmVuaWVuY2UgYWxpYXNlcyAqLworICAgIGxpYnhs
X2RvbWFpbl9jb25maWcgKmRfY29uZmlnID0gYXBkcy0+ZF9jb25maWc7CisgICAgbGlieGxfZG9t
aWQgZG9taWQgPSBhcGRzLT5kb21pZDsKKyAgICBsaWJ4bF9fYW9fZGV2aWNlICphb2RldiA9IGFw
ZHMtPm91dGVyX2FvZGV2OworCiAgICAgaWYgKGRfY29uZmlnLT5udW1fcGNpZGV2cyA+IDApIHsK
ICAgICAgICAgcmMgPSBsaWJ4bF9fY3JlYXRlX3BjaV9iYWNrZW5kKGdjLCBkb21pZCwgZF9jb25m
aWctPnBjaWRldnMsCiAgICAgICAgICAgICBkX2NvbmZpZy0+bnVtX3BjaWRldnMpOwotLSAKQW50
aG9ueSBQRVJBUkQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9y
ZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 70926144B9
	for <lists+xen-devel@lfdr.de>; Mon,  6 May 2019 08:59:36 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hNXYt-0002Vn-7q; Mon, 06 May 2019 06:57:19 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=XZcu=TG=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hNXYk-0002Ch-4R
 for xen-devel@lists.xenproject.org; Mon, 06 May 2019 06:57:10 +0000
X-Inumbo-ID: 26aa5e9b-6fcc-11e9-843c-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 26aa5e9b-6fcc-11e9-843c-bc764e045a96;
 Mon, 06 May 2019 06:57:03 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id A51F3AF38;
 Mon,  6 May 2019 06:56:57 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon,  6 May 2019 08:56:32 +0200
Message-Id: <20190506065644.7415-34-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190506065644.7415-1-jgross@suse.com>
References: <20190506065644.7415-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH RFC V2 33/45] xen/sched: add code to sync
 scheduling of all vcpus of a sched item
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wei.liu2@citrix.com>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>,
 Dario Faggioli <dfaggioli@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiBzd2l0Y2hpbmcgc2NoZWQgaXRlbXMgc3luY2hyb25pemUgYWxsIHZjcHVzIG9mIHRoZSBu
ZXcgaXRlbSB0byBiZQpzY2hlZHVsZWQgYXQgdGhlIHNhbWUgdGltZS4KCkEgdmFyaWFibGUgc2No
ZWRfZ3JhbnVsYXJpdHkgaXMgYWRkZWQgd2hpY2ggaG9sZHMgdGhlIG51bWJlciBvZiB2Y3B1cwpw
ZXIgc2NoZWR1bGUgaXRlbS4KCkFzIHRhc2tsZXRzIHJlcXVpcmUgdG8gc2NoZWR1bGUgdGhlIGlk
bGUgaXRlbSBpdCBpcyByZXF1aXJlZCB0byBzZXQgdGhlCnRhc2tsZXRfd29ya19zY2hlZHVsZWQg
cGFyYW1ldGVyIG9mIGRvX3NjaGVkdWxlKCkgdG8gdHJ1ZSBpZiBhbnkgY3B1CmNvdmVyZWQgYnkg
dGhlIGN1cnJlbnQgc2NoZWR1bGUoKSBjYWxsIGhhcyBhbnkgcGVuZGluZyB0YXNrbGV0IHdvcmsu
CgpGb3Igam9pbmluZyBvdGhlciB2Y3B1cyBvZiB0aGUgc2NoZWR1bGUgaXRlbSB3ZSBuZWVkIHRv
IGFkZCBhIG5ldwpzb2Z0aXJxIFNDSEVEX1NMQVZFX1NPRlRJUlEgaW4gb3JkZXIgdG8gaGF2ZSBh
IHdheSB0byBpbml0aWF0ZSBhCmNvbnRleHQgc3dpdGNoIHdpdGhvdXQgY2FsbGluZyB0aGUgZ2Vu
ZXJpYyBzY2hlZHVsZSgpIGZ1bmN0aW9uCnNlbGVjdGluZyB0aGUgdmNwdSB0byBzd2l0Y2ggdG8s
IGFzIHdlIGFscmVhZHkga25vdyB3aGljaCB2Y3B1IHdlCndhbnQgdG8gcnVuLiBUaGlzIGhhcyB0
aGUgb3RoZXIgYWR2YW50YWdlIG5vdCB0byBsb29zZSBhbnkgb3RoZXIKY29uY3VycmVudCBTQ0hF
RFVMRV9TT0ZUSVJRIGV2ZW50cy4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9z
c0BzdXNlLmNvbT4KLS0tClJGQyBWMjogbW92ZSBzeW5jaW5nIGFmdGVyIGNvbnRleHRfc3dpdGNo
KCkgdG8gc2NoZWR1bGUuYwotLS0KIHhlbi9hcmNoL2FybS9kb21haW4uYyAgICAgIHwgICAyICst
CiB4ZW4vYXJjaC94ODYvZG9tYWluLmMgICAgICB8ICAgMyArLQogeGVuL2NvbW1vbi9zY2hlZHVs
ZS5jICAgICAgfCAzMzkgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0t
LS0tCiB4ZW4vY29tbW9uL3NvZnRpcnEuYyAgICAgICB8ICAgNiArLQogeGVuL2luY2x1ZGUveGVu
L3NjaGVkLWlmLmggfCAgIDEgKwogeGVuL2luY2x1ZGUveGVuL3NjaGVkLmggICAgfCAgMTYgKyst
CiB4ZW4vaW5jbHVkZS94ZW4vc29mdGlycS5oICB8ICAgMSArCiA3IGZpbGVzIGNoYW5nZWQsIDI2
OSBpbnNlcnRpb25zKCspLCA5OSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC9h
cm0vZG9tYWluLmMgYi94ZW4vYXJjaC9hcm0vZG9tYWluLmMKaW5kZXggNmRjNjMzZWQ1MC4uZjE4
ZmIzNWFjMiAxMDA2NDQKLS0tIGEveGVuL2FyY2gvYXJtL2RvbWFpbi5jCisrKyBiL3hlbi9hcmNo
L2FybS9kb21haW4uYwpAQCAtMzExLDcgKzMxMSw3IEBAIHN0YXRpYyB2b2lkIHNjaGVkdWxlX3Rh
aWwoc3RydWN0IHZjcHUgKnByZXYpCiAKICAgICBsb2NhbF9pcnFfZW5hYmxlKCk7CiAKLSAgICBj
b250ZXh0X3NhdmVkKHByZXYpOworICAgIHNjaGVkX2NvbnRleHRfc3dpdGNoZWQocHJldiwgY3Vy
cmVudCk7CiAKICAgICBpZiAoIHByZXYgIT0gY3VycmVudCApCiAgICAgICAgIHVwZGF0ZV9ydW5z
dGF0ZV9hcmVhKGN1cnJlbnQpOwpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2RvbWFpbi5jIGIv
eGVuL2FyY2gveDg2L2RvbWFpbi5jCmluZGV4IDllYWE5NzhjZTUuLjE1MjVjY2Q4ZTUgMTAwNjQ0
Ci0tLSBhL3hlbi9hcmNoL3g4Ni9kb21haW4uYworKysgYi94ZW4vYXJjaC94ODYvZG9tYWluLmMK
QEAgLTE3MTQsNyArMTcxNCw2IEBAIHN0YXRpYyB2b2lkIF9fY29udGV4dF9zd2l0Y2godm9pZCkK
ICAgICBwZXJfY3B1KGN1cnJfdmNwdSwgY3B1KSA9IG47CiB9CiAKLQogdm9pZCBjb250ZXh0X3N3
aXRjaChzdHJ1Y3QgdmNwdSAqcHJldiwgc3RydWN0IHZjcHUgKm5leHQpCiB7CiAgICAgdW5zaWdu
ZWQgaW50IGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKQEAgLTE3OTIsNyArMTc5MSw3IEBAIHZv
aWQgY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnByZXYsIHN0cnVjdCB2Y3B1ICpuZXh0KQog
ICAgICAgICB9CiAgICAgfQogCi0gICAgY29udGV4dF9zYXZlZChwcmV2KTsKKyAgICBzY2hlZF9j
b250ZXh0X3N3aXRjaGVkKHByZXYsIG5leHQpOwogCiAgICAgaWYgKCBwcmV2ICE9IG5leHQgKQog
ICAgIHsKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWR1bGUuYyBiL3hlbi9jb21tb24vc2No
ZWR1bGUuYwppbmRleCBiNWZiNDhjNTUzLi45ZDY1NTg2Y2FlIDEwMDY0NAotLS0gYS94ZW4vY29t
bW9uL3NjaGVkdWxlLmMKKysrIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCkBAIC01NCw2ICs1NCwx
MCBAQCBib29sZWFuX3BhcmFtKCJzY2hlZF9zbXRfcG93ZXJfc2F2aW5ncyIsIHNjaGVkX3NtdF9w
b3dlcl9zYXZpbmdzKTsKICAqICovCiBpbnQgc2NoZWRfcmF0ZWxpbWl0X3VzID0gU0NIRURfREVG
QVVMVF9SQVRFTElNSVRfVVM7CiBpbnRlZ2VyX3BhcmFtKCJzY2hlZF9yYXRlbGltaXRfdXMiLCBz
Y2hlZF9yYXRlbGltaXRfdXMpOworCisvKiBOdW1iZXIgb2YgdmNwdXMgcGVyIHN0cnVjdCBzY2hl
ZF9pdGVtLiAqLworc3RhdGljIHVuc2lnbmVkIGludCBzY2hlZF9ncmFudWxhcml0eSA9IDE7CisK
IC8qIFZhcmlvdXMgdGltZXIgaGFuZGxlcnMuICovCiBzdGF0aWMgdm9pZCBzX3RpbWVyX2ZuKHZv
aWQgKnVudXNlZCk7CiBzdGF0aWMgdm9pZCB2Y3B1X3BlcmlvZGljX3RpbWVyX2ZuKHZvaWQgKmRh
dGEpOwpAQCAtMTU2NCwxMzQgKzE1NjgsMjkxIEBAIHN0YXRpYyB2b2lkIHZjcHVfcGVyaW9kaWNf
dGltZXJfd29yayhzdHJ1Y3QgdmNwdSAqdikKICAgICBzZXRfdGltZXIoJnYtPnBlcmlvZGljX3Rp
bWVyLCBwZXJpb2RpY19uZXh0X2V2ZW50KTsKIH0KIAotLyoKLSAqIFRoZSBtYWluIGZ1bmN0aW9u
Ci0gKiAtIGRlc2NoZWR1bGUgdGhlIGN1cnJlbnQgZG9tYWluIChzY2hlZHVsZXIgaW5kZXBlbmRl
bnQpLgotICogLSBwaWNrIGEgbmV3IGRvbWFpbiAoc2NoZWR1bGVyIGRlcGVuZGVudCkuCi0gKi8K
LXN0YXRpYyB2b2lkIHNjaGVkdWxlKHZvaWQpCitzdGF0aWMgdm9pZCBzY2hlZF9zd2l0Y2hfaXRl
bXMoc3RydWN0IHNjaGVkX3Jlc291cmNlICpzZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBzdHJ1Y3Qgc2NoZWRfaXRlbSAqbmV4dCwgc3RydWN0IHNjaGVkX2l0ZW0gKnByZXYsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc190aW1lX3Qgbm93KQogewotICAgIHN0cnVj
dCBzY2hlZF9pdGVtICAgICpwcmV2ID0gY3VycmVudC0+c2NoZWRfaXRlbSwgKm5leHQgPSBOVUxM
OwotICAgIHNfdGltZV90ICAgICAgICAgICAgICBub3c7Ci0gICAgc3RydWN0IHNjaGVkdWxlciAg
ICAgKnNjaGVkOwotICAgIHVuc2lnbmVkIGxvbmcgICAgICAgICp0YXNrbGV0X3dvcmsgPSAmdGhp
c19jcHUodGFza2xldF93b3JrX3RvX2RvKTsKLSAgICBib29sICAgICAgICAgICAgICAgICAgdGFz
a2xldF93b3JrX3NjaGVkdWxlZCA9IGZhbHNlOwotICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAq
c2Q7Ci0gICAgc3BpbmxvY2tfdCAgICAgICAgICAgKmxvY2s7Ci0gICAgaW50IGNwdSA9IHNtcF9w
cm9jZXNzb3JfaWQoKTsKKyAgICBzZC0+Y3VyciA9IG5leHQ7CiAKLSAgICBBU1NFUlRfTk9UX0lO
X0FUT01JQygpOworICAgIFRSQUNFXzNEKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GUFJFViwgcHJldi0+
ZG9tYWluLT5kb21haW5faWQsIHByZXYtPml0ZW1faWQsCisgICAgICAgICAgICAgbm93IC0gcHJl
di0+c3RhdGVfZW50cnlfdGltZSk7CisgICAgVFJBQ0VfNEQoVFJDX1NDSEVEX1NXSVRDSF9JTkZO
RVhULCBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+aXRlbV9pZCwKKyAgICAgICAgICAg
ICAobmV4dC0+dmNwdS0+cnVuc3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmFibGUpID8KKyAg
ICAgICAgICAgICAobm93IC0gbmV4dC0+c3RhdGVfZW50cnlfdGltZSkgOiAwLCBwcmV2LT5uZXh0
X3RpbWUpOwogCi0gICAgU0NIRURfU1RBVF9DUkFOSyhzY2hlZF9ydW4pOworICAgIEFTU0VSVChw
cmV2LT52Y3B1LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uaW5nKTsKIAotICAgIHNk
ID0gdGhpc19jcHUoc2NoZWRfcmVzKTsKKyAgICBUUkFDRV80RChUUkNfU0NIRURfU1dJVENILCBw
cmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+aXRlbV9pZCwKKyAgICAgICAgICAgICBuZXh0
LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+aXRlbV9pZCk7CiAKLSAgICAvKiBVcGRhdGUgdGFz
a2xldCBzY2hlZHVsaW5nIHN0YXR1cy4gKi8KLSAgICBzd2l0Y2ggKCAqdGFza2xldF93b3JrICkK
KyAgICBzY2hlZF9pdGVtX3J1bnN0YXRlX2NoYW5nZShwcmV2LCBmYWxzZSwgbm93KTsKKyAgICBw
cmV2LT5sYXN0X3J1bl90aW1lID0gbm93OworCisgICAgQVNTRVJUKG5leHQtPnZjcHUtPnJ1bnN0
YXRlLnN0YXRlICE9IFJVTlNUQVRFX3J1bm5pbmcpOworICAgIHNjaGVkX2l0ZW1fcnVuc3RhdGVf
Y2hhbmdlKG5leHQsIHRydWUsIG5vdyk7CisKKyAgICAvKgorICAgICAqIE5CLiBEb24ndCBhZGQg
YW55IHRyYWNlIHJlY29yZHMgZnJvbSBoZXJlIHVudGlsIHRoZSBhY3R1YWwgY29udGV4dAorICAg
ICAqIHN3aXRjaCwgZWxzZSBsb3N0X3JlY29yZHMgcmVzdW1lIHdpbGwgbm90IHdvcmsgcHJvcGVy
bHkuCisgICAgICovCisKKyAgICBBU1NFUlQoIW5leHQtPmlzX3J1bm5pbmcpOworICAgIG5leHQt
PnZjcHUtPmlzX3J1bm5pbmcgPSAxOworICAgIG5leHQtPmlzX3J1bm5pbmcgPSAxOworfQorCitz
dGF0aWMgYm9vbCBzY2hlZF90YXNrbGV0X2NoZWNrKHZvaWQpCit7CisgICAgdW5zaWduZWQgbG9u
ZyAqdGFza2xldF93b3JrOworICAgIGJvb2wgdGFza2xldF93b3JrX3NjaGVkdWxlZCA9IGZhbHNl
OworICAgIGNvbnN0IGNwdW1hc2tfdCAqbWFzayA9IHRoaXNfY3B1KHNjaGVkX3JlcyktPmNwdXM7
CisgICAgaW50IGNwdTsKKworICAgIGZvcl9lYWNoX2NwdSAoIGNwdSwgbWFzayApCiAgICAgewot
ICAgIGNhc2UgVEFTS0xFVF9lbnF1ZXVlZDoKLSAgICAgICAgc2V0X2JpdChfVEFTS0xFVF9zY2hl
ZHVsZWQsIHRhc2tsZXRfd29yayk7Ci0gICAgICAgIC8qIGZhbGx0aHJvdWdoICovCi0gICAgY2Fz
ZSBUQVNLTEVUX2VucXVldWVkfFRBU0tMRVRfc2NoZWR1bGVkOgotICAgICAgICB0YXNrbGV0X3dv
cmtfc2NoZWR1bGVkID0gdHJ1ZTsKLSAgICAgICAgYnJlYWs7Ci0gICAgY2FzZSBUQVNLTEVUX3Nj
aGVkdWxlZDoKLSAgICAgICAgY2xlYXJfYml0KF9UQVNLTEVUX3NjaGVkdWxlZCwgdGFza2xldF93
b3JrKTsKLSAgICBjYXNlIDA6Ci0gICAgICAgIC8qdGFza2xldF93b3JrX3NjaGVkdWxlZCA9IGZh
bHNlOyovCi0gICAgICAgIGJyZWFrOwotICAgIGRlZmF1bHQ6Ci0gICAgICAgIEJVRygpOwotICAg
IH0KKyAgICAgICAgdGFza2xldF93b3JrID0gJnBlcl9jcHUodGFza2xldF93b3JrX3RvX2RvLCBj
cHUpOwogCi0gICAgbG9jayA9IHBjcHVfc2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKKyAgICAgICAg
c3dpdGNoICggKnRhc2tsZXRfd29yayApCisgICAgICAgIHsKKyAgICAgICAgY2FzZSBUQVNLTEVU
X2VucXVldWVkOgorICAgICAgICAgICAgc2V0X2JpdChfVEFTS0xFVF9zY2hlZHVsZWQsIHRhc2ts
ZXRfd29yayk7CisgICAgICAgICAgICAvKiBmYWxsdGhyb3VnaCAqLworICAgICAgICBjYXNlIFRB
U0tMRVRfZW5xdWV1ZWR8VEFTS0xFVF9zY2hlZHVsZWQ6CisgICAgICAgICAgICB0YXNrbGV0X3dv
cmtfc2NoZWR1bGVkID0gdHJ1ZTsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICBjYXNlIFRB
U0tMRVRfc2NoZWR1bGVkOgorICAgICAgICAgICAgY2xlYXJfYml0KF9UQVNLTEVUX3NjaGVkdWxl
ZCwgdGFza2xldF93b3JrKTsKKyAgICAgICAgY2FzZSAwOgorICAgICAgICAgICAgLyp0YXNrbGV0
X3dvcmtfc2NoZWR1bGVkID0gZmFsc2U7Ki8KKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICBk
ZWZhdWx0OgorICAgICAgICAgICAgQlVHKCk7CisgICAgICAgIH0KKyAgICB9CiAKLSAgICBub3cg
PSBOT1coKTsKKyAgICByZXR1cm4gdGFza2xldF93b3JrX3NjaGVkdWxlZDsKK30KIAotICAgIHN0
b3BfdGltZXIoJnNkLT5zX3RpbWVyKTsKK3N0YXRpYyBzdHJ1Y3Qgc2NoZWRfaXRlbSAqZG9fc2No
ZWR1bGUoc3RydWN0IHNjaGVkX2l0ZW0gKnByZXYsIHNfdGltZV90IG5vdykKK3sKKyAgICBzdHJ1
Y3Qgc2NoZWR1bGVyICpzY2hlZCA9IHRoaXNfY3B1KHNjaGVkdWxlcik7CisgICAgc3RydWN0IHNj
aGVkX3Jlc291cmNlICpzZCA9IHRoaXNfY3B1KHNjaGVkX3Jlcyk7CisgICAgc3RydWN0IHNjaGVk
X2l0ZW0gKm5leHQ7CiAKICAgICAvKiBnZXQgcG9saWN5LXNwZWNpZmljIGRlY2lzaW9uIG9uIHNj
aGVkdWxpbmcuLi4gKi8KLSAgICBzY2hlZCA9IHRoaXNfY3B1KHNjaGVkdWxlcik7Ci0gICAgc2No
ZWQtPmRvX3NjaGVkdWxlKHNjaGVkLCBwcmV2LCBub3csIHRhc2tsZXRfd29ya19zY2hlZHVsZWQp
OworICAgIHNjaGVkLT5kb19zY2hlZHVsZShzY2hlZCwgcHJldiwgbm93LCBzY2hlZF90YXNrbGV0
X2NoZWNrKCkpOwogCiAgICAgbmV4dCA9IHByZXYtPm5leHRfdGFzazsKIAotICAgIHNkLT5jdXJy
ID0gbmV4dDsKLQogICAgIGlmICggcHJldi0+bmV4dF90aW1lID49IDAgKSAvKiAtdmUgbWVhbnMg
bm8gbGltaXQgKi8KICAgICAgICAgc2V0X3RpbWVyKCZzZC0+c190aW1lciwgbm93ICsgcHJldi0+
bmV4dF90aW1lKTsKIAotICAgIGlmICggdW5saWtlbHkocHJldiA9PSBuZXh0KSApCisgICAgaWYg
KCBsaWtlbHkocHJldiAhPSBuZXh0KSApCisgICAgICAgIHNjaGVkX3N3aXRjaF9pdGVtcyhzZCwg
bmV4dCwgcHJldiwgbm93KTsKKworICAgIHJldHVybiBuZXh0OworfQorCitzdGF0aWMgdm9pZCBj
b250ZXh0X3NhdmVkKHN0cnVjdCB2Y3B1ICpwcmV2KQoreworICAgIHN0cnVjdCBzY2hlZF9pdGVt
ICppdGVtID0gcHJldi0+c2NoZWRfaXRlbTsKKworICAgIGl0ZW0tPmlzX3J1bm5pbmcgPSAwOwor
ICAgIGl0ZW0tPnN0YXRlX2VudHJ5X3RpbWUgPSBOT1coKTsKKworICAgIC8qIENoZWNrIGZvciBt
aWdyYXRpb24gcmVxdWVzdCAvYWZ0ZXIvIGNsZWFyaW5nIHJ1bm5pbmcgZmxhZy4gKi8KKyAgICBz
bXBfbWIoKTsKKworICAgIHNjaGVkX2NvbnRleHRfc2F2ZWQodmNwdV9zY2hlZHVsZXIocHJldiks
IGl0ZW0pOworCisgICAgc2NoZWRfaXRlbV9taWdyYXRlX2ZpbmlzaChpdGVtKTsKK30KKworLyoK
KyAqIFJlbmRlenZvdXMgb24gZW5kIG9mIGNvbnRleHQgc3dpdGNoLgorICogQXMgbm8gbG9jayBp
cyBwcm90ZWN0aW5nIHRoaXMgcmVuZGV6dm91cyBmdW5jdGlvbiB3ZSBuZWVkIHRvIHVzZSBhdG9t
aWMKKyAqIGFjY2VzcyBmdW5jdGlvbnMgb24gdGhlIGNvdW50ZXIuCisgKiBUaGUgY291bnRlciB3
aWxsIGJlIDAgaW4gY2FzZSBubyByZW5kZXp2b3VzIGlzIG5lZWRlZC4gRm9yIHRoZSByZW5kZXp2
b3VzCisgKiBjYXNlIGl0IGlzIGluaXRpYWxpc2VkIHRvIHRoZSBudW1iZXIgb2YgY3B1cyB0byBy
ZW5kZXp2b3VzIHBsdXMgMS4gRWFjaAorICogbWVtYmVyIGVudGVyaW5nIGRlY3JlbWVudHMgdGhl
IGNvdW50ZXIuIFRoZSBsYXN0IG9uZSB3aWxsIGRlY3JlbWVudCBpdCB0bworICogMSBhbmQgcGVy
Zm9ybSB0aGUgZmluYWwgbmVlZGVkIGFjdGlvbiBpbiB0aGF0IGNhc2UgKGNhbGwgb2YgY29udGV4
dF9zYXZlZCgpCisgKiBpZiB2Y3B1IHdhcyBzd2l0Y2hlZCksIGFuZCB0aGVuIHNldCB0aGUgY291
bnRlciB0byB6ZXJvLiBUaGUgb3RoZXIgbWVtYmVycworICogd2lsbCB3YWl0IHVudGlsIHRoZSBj
b3VudGVyIGJlY29tZXMgemVybyB1bnRpbCB0aGV5IHByb2NlZWQuCisgKi8KK3ZvaWQgc2NoZWRf
Y29udGV4dF9zd2l0Y2hlZChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCkK
K3sKKyAgICBzdHJ1Y3Qgc2NoZWRfaXRlbSAqbmV4dCA9IHZuZXh0LT5zY2hlZF9pdGVtOworCisg
ICAgLyogQ2xlYXIgcnVubmluZyBmbGFnIC9hZnRlci8gd3JpdGluZyBjb250ZXh0IHRvIG1lbW9y
eS4gKi8KKyAgICBzbXBfd21iKCk7CisKKyAgICB2cHJldi0+aXNfcnVubmluZyA9IDA7CisKKyAg
ICBpZiAoIGF0b21pY19yZWFkKCZuZXh0LT5yZW5kZXp2b3VzX291dF9jbnQpICkKKyAgICB7Cisg
ICAgICAgIGludCBjbnQgPSBhdG9taWNfZGVjX3JldHVybigmbmV4dC0+cmVuZGV6dm91c19vdXRf
Y250KTsKKworICAgICAgICAvKiBDYWxsIGNvbnRleHRfc2F2ZWQoKSBiZWZvcmUgcmVsZWFzaW5n
IG90aGVyIHdhaXRlcnMuICovCisgICAgICAgIGlmICggY250ID09IDEgKQorICAgICAgICB7Cisg
ICAgICAgICAgICBpZiAoIHZwcmV2ICE9IHZuZXh0ICkKKyAgICAgICAgICAgICAgICBjb250ZXh0
X3NhdmVkKHZwcmV2KTsKKyAgICAgICAgICAgIGF0b21pY19zZXQoJm5leHQtPnJlbmRlenZvdXNf
b3V0X2NudCwgMCk7CisgICAgICAgIH0KKyAgICAgICAgZWxzZQorICAgICAgICAgICAgd2hpbGUg
KCBhdG9taWNfcmVhZCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250KSApCisgICAgICAgICAgICAg
ICAgY3B1X3JlbGF4KCk7CisgICAgfQorICAgIGVsc2UgaWYgKCB2cHJldiAhPSB2bmV4dCApCisg
ICAgICAgIGNvbnRleHRfc2F2ZWQodnByZXYpOworfQorCitzdGF0aWMgdm9pZCBzY2hlZF9jb250
ZXh0X3N3aXRjaChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNfdGltZV90IG5vdykKK3sKKyAgICBpZiAoIHVu
bGlrZWx5KHZwcmV2ID09IHZuZXh0KSApCiAgICAgewotICAgICAgICBwY3B1X3NjaGVkdWxlX3Vu
bG9ja19pcnEobG9jaywgY3B1KTsKICAgICAgICAgVFJBQ0VfNEQoVFJDX1NDSEVEX1NXSVRDSF9J
TkZDT05ULAotICAgICAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+
aXRlbV9pZCwKLSAgICAgICAgICAgICAgICAgbm93IC0gcHJldi0+c3RhdGVfZW50cnlfdGltZSwK
LSAgICAgICAgICAgICAgICAgcHJldi0+bmV4dF90aW1lKTsKLSAgICAgICAgdHJhY2VfY29udGlu
dWVfcnVubmluZyhuZXh0LT52Y3B1KTsKLSAgICAgICAgcmV0dXJuIGNvbnRpbnVlX3J1bm5pbmco
cHJldi0+dmNwdSk7CisgICAgICAgICAgICAgICAgIHZuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwg
dm5leHQtPnNjaGVkX2l0ZW0tPml0ZW1faWQsCisgICAgICAgICAgICAgICAgIG5vdyAtIHZwcmV2
LT5ydW5zdGF0ZS5zdGF0ZV9lbnRyeV90aW1lLAorICAgICAgICAgICAgICAgICB2cHJldi0+c2No
ZWRfaXRlbS0+bmV4dF90aW1lKTsKKyAgICAgICAgc2NoZWRfY29udGV4dF9zd2l0Y2hlZCh2cHJl
diwgdm5leHQpOworICAgICAgICB0cmFjZV9jb250aW51ZV9ydW5uaW5nKHZuZXh0KTsKKyAgICAg
ICAgcmV0dXJuIGNvbnRpbnVlX3J1bm5pbmcodnByZXYpOwogICAgIH0KIAotICAgIFRSQUNFXzNE
KFRSQ19TQ0hFRF9TV0lUQ0hfSU5GUFJFViwKLSAgICAgICAgICAgICBwcmV2LT5kb21haW4tPmRv
bWFpbl9pZCwgcHJldi0+aXRlbV9pZCwKLSAgICAgICAgICAgICBub3cgLSBwcmV2LT5zdGF0ZV9l
bnRyeV90aW1lKTsKLSAgICBUUkFDRV80RChUUkNfU0NIRURfU1dJVENIX0lORk5FWFQsCi0gICAg
ICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQtPml0ZW1faWQsCi0gICAgICAg
ICAgICAgKG5leHQtPnZjcHUtPnJ1bnN0YXRlLnN0YXRlID09IFJVTlNUQVRFX3J1bm5hYmxlKSA/
Ci0gICAgICAgICAgICAgKG5vdyAtIG5leHQtPnN0YXRlX2VudHJ5X3RpbWUpIDogMCwKLSAgICAg
ICAgICAgICBwcmV2LT5uZXh0X3RpbWUpOworICAgIFNDSEVEX1NUQVRfQ1JBTksoc2NoZWRfY3R4
KTsKIAotICAgIEFTU0VSVChwcmV2LT52Y3B1LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9y
dW5uaW5nKTsKKyAgICBzdG9wX3RpbWVyKCZ2cHJldi0+cGVyaW9kaWNfdGltZXIpOwogCi0gICAg
VFJBQ0VfNEQoVFJDX1NDSEVEX1NXSVRDSCwKLSAgICAgICAgICAgICBwcmV2LT5kb21haW4tPmRv
bWFpbl9pZCwgcHJldi0+aXRlbV9pZCwKLSAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFp
bl9pZCwgbmV4dC0+aXRlbV9pZCk7CisgICAgaWYgKCB2bmV4dC0+c2NoZWRfaXRlbS0+bWlncmF0
ZWQgKQorICAgICAgICB2Y3B1X21vdmVfaXJxcyh2bmV4dCk7CiAKLSAgICBzY2hlZF9pdGVtX3J1
bnN0YXRlX2NoYW5nZShwcmV2LCBmYWxzZSwgbm93KTsKLSAgICBwcmV2LT5sYXN0X3J1bl90aW1l
ID0gbm93OworICAgIHZjcHVfcGVyaW9kaWNfdGltZXJfd29yayh2bmV4dCk7CiAKLSAgICBBU1NF
UlQobmV4dC0+dmNwdS0+cnVuc3RhdGUuc3RhdGUgIT0gUlVOU1RBVEVfcnVubmluZyk7Ci0gICAg
c2NoZWRfaXRlbV9ydW5zdGF0ZV9jaGFuZ2UobmV4dCwgdHJ1ZSwgbm93KTsKKyAgICBjb250ZXh0
X3N3aXRjaCh2cHJldiwgdm5leHQpOworfQogCi0gICAgLyoKLSAgICAgKiBOQi4gRG9uJ3QgYWRk
IGFueSB0cmFjZSByZWNvcmRzIGZyb20gaGVyZSB1bnRpbCB0aGUgYWN0dWFsIGNvbnRleHQKLSAg
ICAgKiBzd2l0Y2gsIGVsc2UgbG9zdF9yZWNvcmRzIHJlc3VtZSB3aWxsIG5vdCB3b3JrIHByb3Bl
cmx5LgotICAgICAqLworLyoKKyAqIFJlbmRlenZvdXMgYmVmb3JlIHRha2luZyBhIHNjaGVkdWxp
bmcgZGVjaXNpb24uCisgKiBDYWxsZWQgd2l0aCBzY2hlZHVsZSBsb2NrIGhlbGQsIHNvIGFsbCBh
Y2Nlc3NlcyB0byB0aGUgcmVuZGV6dm91cyBjb3VudGVyCisgKiBjYW4gYmUgbm9ybWFsIG9uZXMg
KG5vIGF0b21pYyBhY2Nlc3NlcyBuZWVkZWQpLgorICogVGhlIGNvdW50ZXIgaXMgaW5pdGlhbGl6
ZWQgdG8gdGhlIG51bWJlciBvZiBjcHVzIHRvIHJlbmRlenZvdXMgaW5pdGlhbGx5LgorICogRWFj
aCBjcHUgZW50ZXJpbmcgd2lsbCBkZWNyZW1lbnQgdGhlIGNvdW50ZXIuIEluIGNhc2UgdGhlIGNv
dW50ZXIgYmVjb21lcworICogemVybyBkb19zY2hlZHVsZSgpIGlzIGNhbGxlZCBhbmQgdGhlIHJl
bmRlenZvdXMgY291bnRlciBmb3IgbGVhdmluZworICogY29udGV4dF9zd2l0Y2goKSBpcyBzZXQu
IEFsbCBvdGhlciBtZW1iZXJzIHdpbGwgd2FpdCB1bnRpbCB0aGUgY291bnRlciBpcworICogYmVj
b21pbmcgemVybywgZHJvcHBpbmcgdGhlIHNjaGVkdWxlIGxvY2sgaW4gYmV0d2Vlbi4KKyAqLwor
c3RhdGljIHN0cnVjdCBzY2hlZF9pdGVtICpzY2hlZF93YWl0X3JlbmRlenZvdXNfaW4oc3RydWN0
IHNjaGVkX2l0ZW0gKnByZXYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBzcGlubG9ja190ICpsb2NrLCBpbnQgY3B1LAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc190aW1lX3Qgbm93KQoreworICAg
IHN0cnVjdCBzY2hlZF9pdGVtICpuZXh0OwogCi0gICAgQVNTRVJUKCFuZXh0LT5pc19ydW5uaW5n
KTsKLSAgICBuZXh0LT52Y3B1LT5pc19ydW5uaW5nID0gMTsKLSAgICBuZXh0LT5pc19ydW5uaW5n
ID0gMTsKLSAgICBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lID0gbm93OworICAgIGlmICggIS0tcHJl
di0+cmVuZGV6dm91c19pbl9jbnQgKQorICAgIHsKKyAgICAgICAgbmV4dCA9IGRvX3NjaGVkdWxl
KHByZXYsIG5vdyk7CisgICAgICAgIGF0b21pY19zZXQoJm5leHQtPnJlbmRlenZvdXNfb3V0X2Nu
dCwgc2NoZWRfZ3JhbnVsYXJpdHkgKyAxKTsKKyAgICAgICAgcmV0dXJuIG5leHQ7CisgICAgfQog
Ci0gICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CisgICAgd2hpbGUgKCBw
cmV2LT5yZW5kZXp2b3VzX2luX2NudCApCisgICAgeworICAgICAgICBwY3B1X3NjaGVkdWxlX3Vu
bG9ja19pcnEobG9jaywgY3B1KTsKKyAgICAgICAgY3B1X3JlbGF4KCk7CisgICAgICAgIHBjcHVf
c2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKKyAgICB9CiAKLSAgICBTQ0hFRF9TVEFUX0NSQU5LKHNj
aGVkX2N0eCk7CisgICAgcmV0dXJuIHByZXYtPm5leHRfdGFzazsKK30KKworc3RhdGljIHZvaWQg
c2NoZWRfc2xhdmUodm9pZCkKK3sKKyAgICBzdHJ1Y3QgdmNwdSAgICAgICAgICAqdnByZXYgPSBj
dXJyZW50OworICAgIHN0cnVjdCBzY2hlZF9pdGVtICAgICpwcmV2ID0gdnByZXYtPnNjaGVkX2l0
ZW0sICpuZXh0OworICAgIHNfdGltZV90ICAgICAgICAgICAgICBub3c7CisgICAgc3BpbmxvY2tf
dCAgICAgICAgICAgKmxvY2s7CisgICAgaW50IGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKKwor
ICAgIEFTU0VSVF9OT1RfSU5fQVRPTUlDKCk7CisKKyAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9s
b2NrX2lycShjcHUpOworCisgICAgbm93ID0gTk9XKCk7CisKKyAgICBpZiAoICFwcmV2LT5yZW5k
ZXp2b3VzX2luX2NudCApCisgICAgeworICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEo
bG9jaywgY3B1KTsKKyAgICAgICAgcmV0dXJuOworICAgIH0KIAotICAgIHN0b3BfdGltZXIoJnBy
ZXYtPnZjcHUtPnBlcmlvZGljX3RpbWVyKTsKKyAgICBzdG9wX3RpbWVyKCZ0aGlzX2NwdShzY2hl
ZF9yZXMpLT5zX3RpbWVyKTsKIAotICAgIGlmICggbmV4dC0+bWlncmF0ZWQgKQotICAgICAgICB2
Y3B1X21vdmVfaXJxcyhuZXh0LT52Y3B1KTsKKyAgICBuZXh0ID0gc2NoZWRfd2FpdF9yZW5kZXp2
b3VzX2luKHByZXYsIGxvY2ssIGNwdSwgbm93KTsKIAotICAgIHZjcHVfcGVyaW9kaWNfdGltZXJf
d29yayhuZXh0LT52Y3B1KTsKKyAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1
KTsKIAotICAgIGNvbnRleHRfc3dpdGNoKHByZXYtPnZjcHUsIG5leHQtPnZjcHUpOworICAgIHNj
aGVkX2NvbnRleHRfc3dpdGNoKHZwcmV2LCBuZXh0LT52Y3B1LCBub3cpOwogfQogCi12b2lkIGNv
bnRleHRfc2F2ZWQoc3RydWN0IHZjcHUgKnByZXYpCisvKgorICogVGhlIG1haW4gZnVuY3Rpb24K
KyAqIC0gZGVzY2hlZHVsZSB0aGUgY3VycmVudCBkb21haW4gKHNjaGVkdWxlciBpbmRlcGVuZGVu
dCkuCisgKiAtIHBpY2sgYSBuZXcgZG9tYWluIChzY2hlZHVsZXIgZGVwZW5kZW50KS4KKyAqLwor
c3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKIHsKLSAgICAvKiBDbGVhciBydW5uaW5nIGZsYWcg
L2FmdGVyLyB3cml0aW5nIGNvbnRleHQgdG8gbWVtb3J5LiAqLwotICAgIHNtcF93bWIoKTsKKyAg
ICBzdHJ1Y3QgdmNwdSAgICAgICAgICAqdm5leHQsICp2cHJldiA9IGN1cnJlbnQ7CisgICAgc3Ry
dWN0IHNjaGVkX2l0ZW0gICAgKnByZXYgPSB2cHJldi0+c2NoZWRfaXRlbSwgKm5leHQgPSBOVUxM
OworICAgIHNfdGltZV90ICAgICAgICAgICAgICBub3c7CisgICAgc3RydWN0IHNjaGVkX3Jlc291
cmNlICpzZDsKKyAgICBzcGlubG9ja190ICAgICAgICAgICAqbG9jazsKKyAgICBpbnQgY3B1ID0g
c21wX3Byb2Nlc3Nvcl9pZCgpOwogCi0gICAgcHJldi0+aXNfcnVubmluZyA9IDA7Ci0gICAgcHJl
di0+c2NoZWRfaXRlbS0+aXNfcnVubmluZyA9IDA7Ci0gICAgcHJldi0+c2NoZWRfaXRlbS0+c3Rh
dGVfZW50cnlfdGltZSA9IE5PVygpOworICAgIEFTU0VSVF9OT1RfSU5fQVRPTUlDKCk7CiAKLSAg
ICAvKiBDaGVjayBmb3IgbWlncmF0aW9uIHJlcXVlc3QgL2FmdGVyLyBjbGVhcmluZyBydW5uaW5n
IGZsYWcuICovCi0gICAgc21wX21iKCk7CisgICAgU0NIRURfU1RBVF9DUkFOSyhzY2hlZF9ydW4p
OwogCi0gICAgc2NoZWRfY29udGV4dF9zYXZlZCh2Y3B1X3NjaGVkdWxlcihwcmV2KSwgcHJldi0+
c2NoZWRfaXRlbSk7CisgICAgc2QgPSB0aGlzX2NwdShzY2hlZF9yZXMpOworCisgICAgbG9jayA9
IHBjcHVfc2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKKworICAgIGlmICggcHJldi0+cmVuZGV6dm91
c19pbl9jbnQgKQorICAgIHsKKyAgICAgICAgLyoKKyAgICAgICAgICogV2UgaGF2ZSBhIHJhY2U6
IHNjaGVkX3NsYXZlKCkgc2hvdWxkIGJlIGNhbGxlZCwgc28gcmFpc2UgYSBzb2Z0aXJxCisgICAg
ICAgICAqIGluIG9yZGVyIHRvIHJlLWVudGVyIHNjaGVkdWxlKCkgbGF0ZXIgYW5kIGNhbGwgc2No
ZWRfc2xhdmUoKSBub3cuCisgICAgICAgICAqLworICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9j
a19pcnEobG9jaywgY3B1KTsKKworICAgICAgICByYWlzZV9zb2Z0aXJxKFNDSEVEVUxFX1NPRlRJ
UlEpOworICAgICAgICByZXR1cm4gc2NoZWRfc2xhdmUoKTsKKyAgICB9CisKKyAgICBub3cgPSBO
T1coKTsKKworICAgIHN0b3BfdGltZXIoJnNkLT5zX3RpbWVyKTsKKworICAgIGlmICggc2NoZWRf
Z3JhbnVsYXJpdHkgPiAxICkKKyAgICB7CisgICAgICAgIGNwdW1hc2tfdCBtYXNrOworCisgICAg
ICAgIHByZXYtPnJlbmRlenZvdXNfaW5fY250ID0gc2NoZWRfZ3JhbnVsYXJpdHk7CisgICAgICAg
IGNwdW1hc2tfYW5kbm90KCZtYXNrLCBzZC0+Y3B1cywgY3B1bWFza19vZihjcHUpKTsKKyAgICAg
ICAgY3B1bWFza19yYWlzZV9zb2Z0aXJxKCZtYXNrLCBTQ0hFRF9TTEFWRV9TT0ZUSVJRKTsKKyAg
ICAgICAgbmV4dCA9IHNjaGVkX3dhaXRfcmVuZGV6dm91c19pbihwcmV2LCBsb2NrLCBjcHUsIG5v
dyk7CisgICAgfQorICAgIGVsc2UKKyAgICB7CisgICAgICAgIHByZXYtPnJlbmRlenZvdXNfaW5f
Y250ID0gMDsKKyAgICAgICAgbmV4dCA9IGRvX3NjaGVkdWxlKHByZXYsIG5vdyk7CisgICAgICAg
IGF0b21pY19zZXQoJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCwgMCk7CisgICAgfQorCisgICAg
cGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CiAKLSAgICBzY2hlZF9pdGVtX21p
Z3JhdGVfZmluaXNoKHByZXYtPnNjaGVkX2l0ZW0pOworICAgIHZuZXh0ID0gbmV4dC0+dmNwdTsK
KyAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgdm5leHQsIG5vdyk7CiB9CiAKIC8qIFRo
ZSBzY2hlZHVsZXIgdGltZXI6IGZvcmNlIGEgcnVuIHRocm91Z2ggdGhlIHNjaGVkdWxlciAqLwpA
QCAtMTczMyw2ICsxODk0LDcgQEAgc3RhdGljIGludCBjcHVfc2NoZWR1bGVfdXAodW5zaWduZWQg
aW50IGNwdSkKICAgICBpZiAoIHNkID09IE5VTEwgKQogICAgICAgICByZXR1cm4gLUVOT01FTTsK
ICAgICBzZC0+cHJvY2Vzc29yID0gY3B1OworICAgIHNkLT5jcHVzID0gY3B1bWFza19vZihjcHUp
OwogICAgIHBlcl9jcHUoc2NoZWRfcmVzLCBjcHUpID0gc2Q7CiAKICAgICBwZXJfY3B1KHNjaGVk
dWxlciwgY3B1KSA9ICZvcHM7CkBAIC0xODkyLDYgKzIwNTQsNyBAQCB2b2lkIF9faW5pdCBzY2hl
ZHVsZXJfaW5pdCh2b2lkKQogICAgIGludCBpOwogCiAgICAgb3Blbl9zb2Z0aXJxKFNDSEVEVUxF
X1NPRlRJUlEsIHNjaGVkdWxlKTsKKyAgICBvcGVuX3NvZnRpcnEoU0NIRURfU0xBVkVfU09GVElS
USwgc2NoZWRfc2xhdmUpOwogCiAgICAgZm9yICggaSA9IDA7IGkgPCBOVU1fU0NIRURVTEVSUzsg
aSsrKQogICAgIHsKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc29mdGlycS5jIGIveGVuL2NvbW1v
bi9zb2Z0aXJxLmMKaW5kZXggODNjM2MwOWJkNS4uMmQ2NjE5MzIwMyAxMDA2NDQKLS0tIGEveGVu
L2NvbW1vbi9zb2Z0aXJxLmMKKysrIGIveGVuL2NvbW1vbi9zb2Z0aXJxLmMKQEAgLTMzLDggKzMz
LDggQEAgc3RhdGljIHZvaWQgX19kb19zb2Z0aXJxKHVuc2lnbmVkIGxvbmcgaWdub3JlX21hc2sp
CiAgICAgZm9yICggOyA7ICkKICAgICB7CiAgICAgICAgIC8qCi0gICAgICAgICAqIEluaXRpYWxp
c2UgQGNwdSBvbiBldmVyeSBpdGVyYXRpb246IFNDSEVEVUxFX1NPRlRJUlEgbWF5IG1vdmUKLSAg
ICAgICAgICogdXMgdG8gYW5vdGhlciBwcm9jZXNzb3IuCisgICAgICAgICAqIEluaXRpYWxpc2Ug
QGNwdSBvbiBldmVyeSBpdGVyYXRpb246IFNDSEVEVUxFX1NPRlRJUlEgb3IKKyAgICAgICAgICog
U0NIRURfU0xBVkVfU09GVElSUSBtYXkgbW92ZSB1cyB0byBhbm90aGVyIHByb2Nlc3Nvci4KICAg
ICAgICAgICovCiAgICAgICAgIGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKIApAQCAtNTUsNyAr
NTUsNyBAQCB2b2lkIHByb2Nlc3NfcGVuZGluZ19zb2Z0aXJxcyh2b2lkKQogewogICAgIEFTU0VS
VCghaW5faXJxKCkgJiYgbG9jYWxfaXJxX2lzX2VuYWJsZWQoKSk7CiAgICAgLyogRG8gbm90IGVu
dGVyIHNjaGVkdWxlciBhcyBpdCBjYW4gcHJlZW1wdCB0aGUgY2FsbGluZyBjb250ZXh0LiAqLwot
ICAgIF9fZG9fc29mdGlycSgxdWw8PFNDSEVEVUxFX1NPRlRJUlEpOworICAgIF9fZG9fc29mdGly
cSgoMXVsIDw8IFNDSEVEVUxFX1NPRlRJUlEpIHwgKDF1bCA8PCBTQ0hFRF9TTEFWRV9TT0ZUSVJR
KSk7CiB9CiAKIHZvaWQgZG9fc29mdGlycSh2b2lkKQpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUv
eGVuL3NjaGVkLWlmLmggYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaAppbmRleCAwOTU0NGUw
NWMwLi4wODRiNzhkMmI3IDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaAor
KysgYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaApAQCAtNDEsNiArNDEsNyBAQCBzdHJ1Y3Qg
c2NoZWRfcmVzb3VyY2UgewogICAgIHN0cnVjdCB0aW1lciAgICAgICAgc190aW1lcjsgICAgICAg
IC8qIHNjaGVkdWxpbmcgdGltZXIgICAgICAgICAgICAgICAgKi8KICAgICBhdG9taWNfdCAgICAg
ICAgICAgIHVyZ2VudF9jb3VudDsgICAvKiBob3cgbWFueSB1cmdlbnQgdmNwdXMgICAgICAgICAg
ICovCiAgICAgdW5zaWduZWQgICAgICAgICAgICBwcm9jZXNzb3I7CisgICAgY29uc3QgY3B1bWFz
a190ICAgICpjcHVzOyAgICAgICAgICAgLyogY3B1cyBjb3ZlcmVkIGJ5IHRoaXMgc3RydWN0ICAg
ICAqLwogfTsKIAogI2RlZmluZSBjdXJyX29uX2NwdShjKSAgICAocGVyX2NwdShzY2hlZF9yZXMs
IGMpLT5jdXJyKQpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmggYi94ZW4vaW5j
bHVkZS94ZW4vc2NoZWQuaAppbmRleCA4YmRlNzkwZDI3Li41MjI0ZjBhYTcwIDEwMDY0NAotLS0g
YS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaAorKysgYi94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaApA
QCAtMjk1LDYgKzI5NSwxMiBAQCBzdHJ1Y3Qgc2NoZWRfaXRlbSB7CiAgICAgLyogTmV4dCBpdGVt
IHRvIHJ1bi4gKi8KICAgICBzdHJ1Y3Qgc2NoZWRfaXRlbSAgICAgICpuZXh0X3Rhc2s7CiAgICAg
c190aW1lX3QgICAgICAgICAgICAgICAgbmV4dF90aW1lOworCisgICAgLyogTnVtYmVyIG9mIHZj
cHVzIG5vdCB5ZXQgam9pbmVkIGZvciBjb250ZXh0IHN3aXRjaC4gKi8KKyAgICB1bnNpZ25lZCBp
bnQgICAgICAgICAgICByZW5kZXp2b3VzX2luX2NudDsKKworICAgIC8qIE51bWJlciBvZiB2Y3B1
cyBub3QgeWV0IGZpbmlzaGVkIHdpdGggY29udGV4dCBzd2l0Y2guICovCisgICAgYXRvbWljX3Qg
ICAgICAgICAgICAgICAgcmVuZGV6dm91c19vdXRfY250OwogfTsKIAogI2RlZmluZSBmb3JfZWFj
aF9zY2hlZF9pdGVtKGQsIGUpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBcCkBAIC02OTgsMTAgKzcwNCwxMCBAQCB2b2lkIHN5bmNfbG9jYWxfZXhlY3N0YXRlKHZvaWQp
OwogCiAvKgogICogQ2FsbGVkIGJ5IHRoZSBzY2hlZHVsZXIgdG8gc3dpdGNoIHRvIGFub3RoZXIg
VkNQVS4gVGhpcyBmdW5jdGlvbiBtdXN0Ci0gKiBjYWxsIGNvbnRleHRfc2F2ZWQoQHByZXYpIHdo
ZW4gdGhlIGxvY2FsIENQVSBpcyBubyBsb25nZXIgcnVubmluZyBpbgotICogQHByZXYncyBjb250
ZXh0LCBhbmQgdGhhdCBjb250ZXh0IGlzIHNhdmVkIHRvIG1lbW9yeS4gQWx0ZXJuYXRpdmVseSwg
aWYKLSAqIGltcGxlbWVudGluZyBsYXp5IGNvbnRleHQgc3dpdGNoaW5nLCBpdCBzdWZmaWNlcyB0
byBlbnN1cmUgdGhhdCBpbnZva2luZwotICogc3luY192Y3B1X2V4ZWNzdGF0ZSgpIHdpbGwgc3dp
dGNoIGFuZCBjb21taXQgQHByZXYncyBzdGF0ZS4KKyAqIGNhbGwgc2NoZWRfY29udGV4dF9zd2l0
Y2hlZChAcHJldiwgQG5leHQpIHdoZW4gdGhlIGxvY2FsIENQVSBpcyBubyBsb25nZXIKKyAqIHJ1
bm5pbmcgaW4gQHByZXYncyBjb250ZXh0LCBhbmQgdGhhdCBjb250ZXh0IGlzIHNhdmVkIHRvIG1l
bW9yeS4KKyAqIEFsdGVybmF0aXZlbHksIGlmIGltcGxlbWVudGluZyBsYXp5IGNvbnRleHQgc3dp
dGNoaW5nLCBpdCBzdWZmaWNlcyB0byBlbnN1cmUKKyAqIHRoYXQgaW52b2tpbmcgc3luY192Y3B1
X2V4ZWNzdGF0ZSgpIHdpbGwgc3dpdGNoIGFuZCBjb21taXQgQHByZXYncyBzdGF0ZS4KICAqLwog
dm9pZCBjb250ZXh0X3N3aXRjaCgKICAgICBzdHJ1Y3QgdmNwdSAqcHJldiwKQEAgLTcxMyw3ICs3
MTksNyBAQCB2b2lkIGNvbnRleHRfc3dpdGNoKAogICogc2F2ZWQgdG8gbWVtb3J5LiBBbHRlcm5h
dGl2ZWx5LCBpZiBpbXBsZW1lbnRpbmcgbGF6eSBjb250ZXh0IHN3aXRjaGluZywKICAqIGVuc3Vy
ZSB0aGF0IGludm9raW5nIHN5bmNfdmNwdV9leGVjc3RhdGUoKSB3aWxsIHN3aXRjaCBhbmQgY29t
bWl0IEBwcmV2LgogICovCi12b2lkIGNvbnRleHRfc2F2ZWQoc3RydWN0IHZjcHUgKnByZXYpOwor
dm9pZCBzY2hlZF9jb250ZXh0X3N3aXRjaGVkKHN0cnVjdCB2Y3B1ICpwcmV2LCBzdHJ1Y3QgdmNw
dSAqdm5leHQpOwogCiAvKiBDYWxsZWQgYnkgdGhlIHNjaGVkdWxlciB0byBjb250aW51ZSBydW5u
aW5nIHRoZSBjdXJyZW50IFZDUFUuICovCiB2b2lkIGNvbnRpbnVlX3J1bm5pbmcoCmRpZmYgLS1n
aXQgYS94ZW4vaW5jbHVkZS94ZW4vc29mdGlycS5oIGIveGVuL2luY2x1ZGUveGVuL3NvZnRpcnEu
aAppbmRleCBjMzI3YzliNmNkLi5kNzI3M2IzODliIDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS94
ZW4vc29mdGlycS5oCisrKyBiL3hlbi9pbmNsdWRlL3hlbi9zb2Z0aXJxLmgKQEAgLTQsNiArNCw3
IEBACiAvKiBMb3ctbGF0ZW5jeSBzb2Z0aXJxcyBjb21lIGZpcnN0IGluIHRoZSBmb2xsb3dpbmcg
bGlzdC4gKi8KIGVudW0gewogICAgIFRJTUVSX1NPRlRJUlEgPSAwLAorICAgIFNDSEVEX1NMQVZF
X1NPRlRJUlEsCiAgICAgU0NIRURVTEVfU09GVElSUSwKICAgICBORVdfVExCRkxVU0hfQ0xPQ0tf
UEVSSU9EX1NPRlRJUlEsCiAgICAgUkNVX1NPRlRJUlEsCi0tIAoyLjE2LjQKCgpfX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBs
aXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2pl
Y3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

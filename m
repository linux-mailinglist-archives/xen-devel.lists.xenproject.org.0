Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 94CF8FB48E
	for <lists+xen-devel@lfdr.de>; Wed, 13 Nov 2019 17:02:59 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iUv3u-0000eH-Dg; Wed, 13 Nov 2019 16:00:06 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=3XMH=ZF=citrix.com=roger.pau@srs-us1.protection.inumbo.net>)
 id 1iUv3t-0000Th-8r
 for xen-devel@lists.xenproject.org; Wed, 13 Nov 2019 16:00:05 +0000
X-Inumbo-ID: a72de23c-062e-11ea-a237-12813bfff9fa
Received: from esa4.hc3370-68.iphmx.com (unknown [216.71.155.144])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id a72de23c-062e-11ea-a237-12813bfff9fa;
 Wed, 13 Nov 2019 16:00:03 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1573660803;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=X1oDbAmauwWtuFAWXlOr5DGa14RPLRDRHRqxVKGG0ms=;
 b=BoIres4U4JLaM2rP9m7RFajzjboOEYCjvL+m9CmIOcK7hnXgFCDZpFqh
 NS8/7sceW3qxkYgd51ClBusOQhaJItjEdT00oKnsAkj57YB/mfi4mT4/o
 70EUu3s9axVRKD3qZhB2qmBPXJ0RdY6qiYc9vr/Hdxa+jf5K3t5xjSWSZ Y=;
Authentication-Results: esa4.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=roger.pau@citrix.com;
 spf=Pass smtp.mailfrom=roger.pau@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa4.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 roger.pau@citrix.com) identity=pra; client-ip=162.221.158.21;
 receiver=esa4.hc3370-68.iphmx.com;
 envelope-from="roger.pau@citrix.com";
 x-sender="roger.pau@citrix.com"; x-conformance=sidf_compatible
Received-SPF: Pass (esa4.hc3370-68.iphmx.com: domain of
 roger.pau@citrix.com designates 162.221.158.21 as permitted
 sender) identity=mailfrom; client-ip=162.221.158.21;
 receiver=esa4.hc3370-68.iphmx.com;
 envelope-from="roger.pau@citrix.com";
 x-sender="roger.pau@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83
 ip4:168.245.78.127 ~all"
Received-SPF: None (esa4.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa4.hc3370-68.iphmx.com;
 envelope-from="roger.pau@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: Z2R8kXFlY7xamkobaWVrB6yuC6+F0jWe072S3VWtlWoUEuVZn4N0DWZlBeVncTWSTF8Crf46XR
 IEap50omgzJ1ce8Vnb5jMCWEz87Prh2tV4ZgbiCeY/UWwr0D2NjNl/fcWz+hE01f8uJmK2k8Vf
 K1VOGLUElFH3qYznXl9/g1Wcq3p4XNKD/NeKe3N3mqPiabC4VYhG/jo/5Rk+O470Ztj/ukKAHw
 m7PU4/rtK0HISvPH7wCPn3jrVyxutoMaOU8H9TmD7IaXRhO/8JrUl9HNLs51YDsZDioDAxTN8l
 WrQ=
X-SBRS: 2.7
X-MesageID: 8804583
X-Ironport-Server: esa4.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.68,300,1569297600"; 
   d="scan'208";a="8804583"
From: Roger Pau Monne <roger.pau@citrix.com>
To: <xen-devel@lists.xenproject.org>
Date: Wed, 13 Nov 2019 16:59:39 +0100
Message-ID: <20191113155940.81837-3-roger.pau@citrix.com>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191113155940.81837-1-roger.pau@citrix.com>
References: <20191113155940.81837-1-roger.pau@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH for-4.13 v4 2/3] x86/passthrough: fix migration
 of MSI when using posted interrupts
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Wei Liu <wl@xen.org>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Joe Jin <joe.jin@oracle.com>,
 Jan Beulich <jbeulich@suse.com>, Roger Pau Monne <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiB1c2luZyBwb3N0ZWQgaW50ZXJydXB0cyBhbmQgdGhlIGd1ZXN0IG1pZ3JhdGVzIE1TSSBm
cm9tIHZDUFVzIFhlbgpuZWVkcyB0byBmbHVzaCBhbnkgcGVuZGluZyBQSVJSIHZlY3RvcnMgb24g
dGhlIHByZXZpb3VzIHZDUFUsIG9yIGVsc2UKdGhvc2UgdmVjdG9ycyBjb3VsZCBnZXQgd3Jvbmds
eSBpbmplY3RlZCBhdCBhIGxhdGVyIHBvaW50IHdoZW4gdGhlIE1TSQpmaWVsZHMgYXJlIGFscmVh
ZHkgdXBkYXRlZC4KClRoZSB1c2FnZSBvZiBhIGZpeGVkIHZDUFUgaW4gbG93ZXN0IHByaW9yaXR5
IG1vZGUgd2hlbiB1c2luZyBWVC1kCnBvc3RlZCBpbnRlcnJ1cHRzIGlzIGFsc28gcmVtb3ZlZCwg
YW5kIGFzIGEgcmVzdWx0IFZULWQgcG9zdGVkCmludGVycnVwdHMgYXJlIG5vdCB1c2VkIHRvZ2V0
aGVyIHdpdGggbG93ZXN0IHByaW9yaXR5IG1vZGUgYW5kCm11bHRpcGxlIGRlc3RpbmF0aW9ucy4g
VGhhdCBmb3JjZXMgdmxhcGljX2xvd2VzdF9wcmlvIHRvIGJlIGNhbGxlZCBpbgpvcmRlciB0byBz
ZWxlY3QgdGhlIGRlc3RpbmF0aW9uIHZDUFUgZHVyaW5nIGludGVycnVwdCBkaXNwYXRjaC4KCk5v
dGUgdGhhdCBQSVJSIGlzIHN5bmNlZCB0byBJUlIgYm90aCBpbiBwdF9pcnFfZGVzdHJveV9iaW5k
IGFuZApwdF9pcnFfY3JlYXRlX2JpbmQgd2hlbiB0aGUgaW50ZXJydXB0IGRlbGl2ZXJ5IGRhdGEg
aXMgYmVpbmcgdXBkYXRlZC4KClJlcG9ydGVkLWJ5OiBKb2UgSmluIDxqb2UuamluQG9yYWNsZS5j
b20+ClNpZ25lZC1vZmYtYnk6IFJvZ2VyIFBhdSBNb25uw6kgPHJvZ2VyLnBhdUBjaXRyaXguY29t
PgotLS0KQ2M6IEpvZSBKaW4gPGpvZS5qaW5Ab3JhY2xlLmNvbT4KQ2M6IEp1ZXJnZW4gR3Jvc3Mg
PGpncm9zc0BzdXNlLmNvbT4KLS0tCkNoYW5nZXMgc2luY2UgdjM6CiAtIEluIG11bHRpLWRlc3Rp
bmF0aW9uIG1vZGUgbWFrZSBzdXJlIGFsbCBkZXN0aW5hdGlvbiB2Q1BVcyBoYXZlIFBJUgogICBz
eW5jZWQgdG8gSVJSIGJ5IHVzaW5nIGEgYml0bWFwLgogLSBEcm9wIHRoZSBib2d1cyBzZWxlY3Rp
b24gb2YgYSBmaXhlZCB2Q1BVIHdoZW4gdXNpbmcgbG93ZXN0IHByaW9yaXR5CiAgIG1vZGUuCgpD
aGFuZ2VzIHNpbmNlIHYyOgogLSBBbHNvIHN5bmMgUElSUiB3aXRoIElSUiB3aGVuIHVzaW5nIENQ
VSBwb3N0ZWQgaW50ZXJydXB0cy4KIC0gRm9yY2UgdGhlIHNlbGVjdGlvbiBvZiBhIHNwZWNpZmlj
IHZDUFUgd2hlbiB1c2luZyBwb3N0ZWQgaW50ZXJydXB0cwogICBmb3IgbXVsdGktZGVzdC4KIC0g
Q2hhbmdlIHZtc2lfZGVsaXZlcl9waXJxIHRvIGhvbm9yIGRlc3RfdmNwdV9pZC4KCkNoYW5nZXMg
c2luY2UgdjE6CiAtIFN0b3JlIHRoZSB2Y3B1IGlkIGFsc28gaW4gbXVsdGktZGVzdCBtb2RlIGlm
IHRoZSBpbnRlcnJ1cHQgaXMgYm91bmQKICAgdG8gYSB2Y3B1IGZvciBwb3N0ZWQgZGVsaXZlcnku
CiAtIHMvI2lmLyNpZmRlZi8uCi0tLQogeGVuL2FyY2gveDg2L2h2bS9odm0uYyAgICAgICAgICAg
fCAgMzEgKysrKysrKysKIHhlbi9hcmNoL3g4Ni9odm0vdmxhcGljLmMgICAgICAgIHwgIDE5ICsr
KysrCiB4ZW4vYXJjaC94ODYvaHZtL3Ztc2kuYyAgICAgICAgICB8ICAyMyAtLS0tLS0KIHhlbi9k
cml2ZXJzL3Bhc3N0aHJvdWdoL2lvLmMgICAgIHwgMTE4ICsrKysrKysrKysrKysrLS0tLS0tLS0t
LS0tLS0tLS0KIHhlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oICAgIHwgICA1ICstCiB4ZW4v
aW5jbHVkZS9hc20teDg2L2h2bS92bGFwaWMuaCB8ICAgMyArCiA2IGZpbGVzIGNoYW5nZWQsIDEx
MCBpbnNlcnRpb25zKCspLCA4OSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94
ODYvaHZtL2h2bS5jIGIveGVuL2FyY2gveDg2L2h2bS9odm0uYwppbmRleCAwNmE3YjQwMTA3Li4w
ZTMzNzlmYTZmIDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCisrKyBiL3hlbi9h
cmNoL3g4Ni9odm0vaHZtLmMKQEAgLTQzLDYgKzQzLDcgQEAKICNpbmNsdWRlIDxhc20vY3VycmVu
dC5oPgogI2luY2x1ZGUgPGFzbS9lODIwLmg+CiAjaW5jbHVkZSA8YXNtL2lvLmg+CisjaW5jbHVk
ZSA8YXNtL2lvX2FwaWMuaD4KICNpbmNsdWRlIDxhc20vcmVncy5oPgogI2luY2x1ZGUgPGFzbS9j
cHVmZWF0dXJlLmg+CiAjaW5jbHVkZSA8YXNtL3Byb2Nlc3Nvci5oPgpAQCAtNTI2Niw2ICs1MjY3
LDM2IEBAIHZvaWQgaHZtX3NldF9zZWdtZW50X3JlZ2lzdGVyKHN0cnVjdCB2Y3B1ICp2LCBlbnVt
IHg4Nl9zZWdtZW50IHNlZywKICAgICBhbHRlcm5hdGl2ZV92Y2FsbChodm1fZnVuY3Muc2V0X3Nl
Z21lbnRfcmVnaXN0ZXIsIHYsIHNlZywgcmVnKTsKIH0KIAoraW50IGh2bV9pbnRyX2dldF9kZXN0
cyhzdHJ1Y3QgZG9tYWluICpkLCB1aW50OF90IGRlc3QsIHVpbnQ4X3QgZGVzdF9tb2RlLAorICAg
ICAgICAgICAgICAgICAgICAgICB1aW50OF90IGRlbGl2ZXJ5X21vZGUsIHVuc2lnbmVkIGxvbmcg
KnZjcHVzKQoreworICAgIHN0cnVjdCB2Y3B1ICp2OworCisgICAgc3dpdGNoICggZGVsaXZlcnlf
bW9kZSApCisgICAgeworICAgIGNhc2UgZGVzdF9Mb3dlc3RQcmlvOgorICAgICAgICAvKgorICAg
ICAgICAgKiBHZXQgYWxsIHRoZSBwb3NzaWJsZSBkZXN0aW5hdGlvbnMsIGJ1dCBub3RlIHRoYXQg
bG93ZXN0IHByaW9yaXR5CisgICAgICAgICAqIG1vZGUgaXMgb25seSBnb2luZyB0byBpbmplY3Qg
dGhlIGludGVycnVwdCB0byB0aGUgdkNQVSBydW5uaW5nIGF0CisgICAgICAgICAqIHRoZSBsZWFz
dCBwcml2aWxlZ2UgbGV2ZWwuCisgICAgICAgICAqCisgICAgICAgICAqIEZhbGx0aHJvdWdoCisg
ICAgICAgICAqLworICAgIGNhc2UgZGVzdF9GaXhlZDoKKyAgICAgICAgZm9yX2VhY2hfdmNwdSAo
IGQsIHYgKQorICAgICAgICAgICAgaWYgKCB2bGFwaWNfbWF0Y2hfZGVzdCh2Y3B1X3ZsYXBpYyh2
KSwgTlVMTCwgMCwgZGVzdCwgZGVzdF9tb2RlKSApCisgICAgICAgICAgICAgICAgX19zZXRfYml0
KHYtPnZjcHVfaWQsIHZjcHVzKTsKKyAgICAgICAgYnJlYWs7CisKKyAgICBkZWZhdWx0OgorICAg
ICAgICBncHJpbnRrKFhFTkxPR19XQVJOSU5HLCAidW5zdXBwb3J0ZWQgaW50ZXJydXB0IGRlbGl2
ZXJ5IG1vZGUgJXVcbiIsCisgICAgICAgICAgICAgICAgZGVsaXZlcnlfbW9kZSk7CisgICAgICAg
IHJldHVybiAtRUlOVkFMOworICAgIH0KKworICAgIHJldHVybiAwOworfQorCiAvKgogICogTG9j
YWwgdmFyaWFibGVzOgogICogbW9kZTogQwpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2h2bS92
bGFwaWMuYyBiL3hlbi9hcmNoL3g4Ni9odm0vdmxhcGljLmMKaW5kZXggOTQ2NjI1OGQ2Zi4uOWQ5
YzZkMzkxYSAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L2h2bS92bGFwaWMuYworKysgYi94ZW4v
YXJjaC94ODYvaHZtL3ZsYXBpYy5jCkBAIC0xMTIsNiArMTEyLDI1IEBAIHN0YXRpYyB2b2lkIHN5
bmNfcGlyX3RvX2lycihzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAgYWx0ZXJuYXRpdmVfdmNhbGwo
aHZtX2Z1bmNzLnN5bmNfcGlyX3RvX2lyciwgdik7CiB9CiAKK3ZvaWQgZG9tYWluX3N5bmNfdmxh
cGljX3BpcihzdHJ1Y3QgZG9tYWluICpkLCB1bnNpZ25lZCBsb25nICp2Y3B1cykKK3sKKyAgICB1
bnNpZ25lZCBpbnQgaWQ7CisKKyAgICBpZiAoICFiaXRtYXBfd2VpZ2h0KHZjcHVzLCBkLT5tYXhf
dmNwdXMpICkKKyAgICAgICAgcmV0dXJuOworCisgICAgZm9yICggaWQgPSBmaW5kX2ZpcnN0X2Jp
dCh2Y3B1cywgZC0+bWF4X3ZjcHVzKTsKKyAgICAgICAgICBpZCA8IGQtPm1heF92Y3B1czsKKyAg
ICAgICAgICBpZCA9IGZpbmRfbmV4dF9iaXQodmNwdXMsIGQtPm1heF92Y3B1cywgaWQgKyAxKSAp
CisgICAgeworICAgICAgICBpZiAoIGQtPnZjcHVbaWRdICE9IGN1cnJlbnQgKQorICAgICAgICAg
ICAgdmNwdV9wYXVzZShkLT52Y3B1W2lkXSk7CisgICAgICAgIHN5bmNfcGlyX3RvX2lycihkLT52
Y3B1W2lkXSk7CisgICAgICAgIGlmICggZC0+dmNwdVtpZF0gIT0gY3VycmVudCApCisgICAgICAg
ICAgICB2Y3B1X3VucGF1c2UoZC0+dmNwdVtpZF0pOworICAgIH0KK30KKwogc3RhdGljIGludCB2
bGFwaWNfZmluZF9oaWdoZXN0X2lycihzdHJ1Y3QgdmxhcGljICp2bGFwaWMpCiB7CiAgICAgc3lu
Y19waXJfdG9faXJyKHZsYXBpY192Y3B1KHZsYXBpYykpOwpkaWZmIC0tZ2l0IGEveGVuL2FyY2gv
eDg2L2h2bS92bXNpLmMgYi94ZW4vYXJjaC94ODYvaHZtL3Ztc2kuYwppbmRleCA2NTk3ZDlmNzE5
Li42Njg5MWQ3ZDIwIDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvaHZtL3Ztc2kuYworKysgYi94
ZW4vYXJjaC94ODYvaHZtL3Ztc2kuYwpAQCAtMTIxLDI5ICsxMjEsNiBAQCB2b2lkIHZtc2lfZGVs
aXZlcl9waXJxKHN0cnVjdCBkb21haW4gKmQsIGNvbnN0IHN0cnVjdCBodm1fcGlycV9kcGNpICpw
aXJxX2RwY2kpCiAgICAgdm1zaV9kZWxpdmVyKGQsIHZlY3RvciwgZGVzdCwgZGVzdF9tb2RlLCBk
ZWxpdmVyeV9tb2RlLCB0cmlnX21vZGUpOwogfQogCi0vKiBSZXR1cm4gdmFsdWUsIC0xIDogbXVs
dGktZGVzdHMsIG5vbi1uZWdhdGl2ZSB2YWx1ZTogZGVzdF92Y3B1X2lkICovCi1pbnQgaHZtX2dp
cnFfZGVzdF8yX3ZjcHVfaWQoc3RydWN0IGRvbWFpbiAqZCwgdWludDhfdCBkZXN0LCB1aW50OF90
IGRlc3RfbW9kZSkKLXsKLSAgICBpbnQgZGVzdF92Y3B1X2lkID0gLTEsIHcgPSAwOwotICAgIHN0
cnVjdCB2Y3B1ICp2OwotICAgIAotICAgIGlmICggZC0+bWF4X3ZjcHVzID09IDEgKQotICAgICAg
ICByZXR1cm4gMDsKLSAKLSAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCi0gICAgewotICAgICAg
ICBpZiAoIHZsYXBpY19tYXRjaF9kZXN0KHZjcHVfdmxhcGljKHYpLCBOVUxMLCAwLCBkZXN0LCBk
ZXN0X21vZGUpICkgCi0gICAgICAgIHsKLSAgICAgICAgICAgIHcrKzsKLSAgICAgICAgICAgIGRl
c3RfdmNwdV9pZCA9IHYtPnZjcHVfaWQ7Ci0gICAgICAgIH0KLSAgICB9Ci0gICAgaWYgKCB3ID4g
MSApCi0gICAgICAgIHJldHVybiAtMTsKLQotICAgIHJldHVybiBkZXN0X3ZjcHVfaWQ7Ci19Ci0K
IC8qIE1TSS1YIG1hc2sgYml0IGh5cGVydmlzb3IgaW50ZXJjZXB0aW9uICovCiBzdHJ1Y3QgbXNp
eHRibF9lbnRyeQogewpkaWZmIC0tZ2l0IGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvaW8uYyBi
L3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2lvLmMKaW5kZXggYjI5MmU3OTM4Mi4uNTI4OWU4OWJj
MSAxMDA2NDQKLS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvaW8uYworKysgYi94ZW4vZHJp
dmVycy9wYXNzdGhyb3VnaC9pby5jCkBAIC0yMTksNjIgKzIxOSw2IEBAIHZvaWQgZnJlZV9odm1f
aXJxX2RwY2koc3RydWN0IGh2bV9pcnFfZHBjaSAqZHBjaSkKICAgICB4ZnJlZShkcGNpKTsKIH0K
IAotLyoKLSAqIFRoaXMgcm91dGluZSBoYW5kbGVzIGxvd2VzdC1wcmlvcml0eSBpbnRlcnJ1cHRz
IHVzaW5nIHZlY3Rvci1oYXNoaW5nCi0gKiBtZWNoYW5pc20uIEFzIGFuIGV4YW1wbGUsIG1vZGVy
biBJbnRlbCBDUFVzIHVzZSB0aGlzIG1ldGhvZCB0byBoYW5kbGUKLSAqIGxvd2VzdC1wcmlvcml0
eSBpbnRlcnJ1cHRzLgotICoKLSAqIEhlcmUgaXMgdGhlIGRldGFpbHMgYWJvdXQgdGhlIHZlY3Rv
ci1oYXNoaW5nIG1lY2hhbmlzbToKLSAqIDEuIEZvciBsb3dlc3QtcHJpb3JpdHkgaW50ZXJydXB0
cywgc3RvcmUgYWxsIHRoZSBwb3NzaWJsZSBkZXN0aW5hdGlvbgotICogICAgdkNQVXMgaW4gYW4g
YXJyYXkuCi0gKiAyLiBVc2UgImd2ZWMgJSBtYXggbnVtYmVyIG9mIGRlc3RpbmF0aW9uIHZDUFVz
IiB0byBmaW5kIHRoZSByaWdodAotICogICAgZGVzdGluYXRpb24gdkNQVSBpbiB0aGUgYXJyYXkg
Zm9yIHRoZSBsb3dlc3QtcHJpb3JpdHkgaW50ZXJydXB0LgotICovCi1zdGF0aWMgc3RydWN0IHZj
cHUgKnZlY3Rvcl9oYXNoaW5nX2Rlc3QoY29uc3Qgc3RydWN0IGRvbWFpbiAqZCwKLSAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50MzJfdCBkZXN0X2lkLAotICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvb2wgZGVzdF9tb2RlLAotICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ4X3QgZ3ZlYykKLQotewotICAg
IHVuc2lnbmVkIGxvbmcgKmRlc3RfdmNwdV9iaXRtYXA7Ci0gICAgdW5zaWduZWQgaW50IGRlc3Rf
dmNwdXMgPSAwOwotICAgIHN0cnVjdCB2Y3B1ICp2LCAqZGVzdCA9IE5VTEw7Ci0gICAgdW5zaWdu
ZWQgaW50IGk7Ci0KLSAgICBkZXN0X3ZjcHVfYml0bWFwID0geHphbGxvY19hcnJheSh1bnNpZ25l
ZCBsb25nLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEJJVFNfVE9fTE9O
R1MoZC0+bWF4X3ZjcHVzKSk7Ci0gICAgaWYgKCAhZGVzdF92Y3B1X2JpdG1hcCApCi0gICAgICAg
IHJldHVybiBOVUxMOwotCi0gICAgZm9yX2VhY2hfdmNwdSAoIGQsIHYgKQotICAgIHsKLSAgICAg
ICAgaWYgKCAhdmxhcGljX21hdGNoX2Rlc3QodmNwdV92bGFwaWModiksIE5VTEwsIEFQSUNfREVT
VF9OT1NIT1JULAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0X2lkLCBkZXN0
X21vZGUpICkKLSAgICAgICAgICAgIGNvbnRpbnVlOwotCi0gICAgICAgIF9fc2V0X2JpdCh2LT52
Y3B1X2lkLCBkZXN0X3ZjcHVfYml0bWFwKTsKLSAgICAgICAgZGVzdF92Y3B1cysrOwotICAgIH0K
LQotICAgIGlmICggZGVzdF92Y3B1cyAhPSAwICkKLSAgICB7Ci0gICAgICAgIHVuc2lnbmVkIGlu
dCBtb2QgPSBndmVjICUgZGVzdF92Y3B1czsKLSAgICAgICAgdW5zaWduZWQgaW50IGlkeCA9IDA7
Ci0KLSAgICAgICAgZm9yICggaSA9IDA7IGkgPD0gbW9kOyBpKysgKQotICAgICAgICB7Ci0gICAg
ICAgICAgICBpZHggPSBmaW5kX25leHRfYml0KGRlc3RfdmNwdV9iaXRtYXAsIGQtPm1heF92Y3B1
cywgaWR4KSArIDE7Ci0gICAgICAgICAgICBCVUdfT04oaWR4ID4gZC0+bWF4X3ZjcHVzKTsKLSAg
ICAgICAgfQotCi0gICAgICAgIGRlc3QgPSBkLT52Y3B1W2lkeCAtIDFdOwotICAgIH0KLQotICAg
IHhmcmVlKGRlc3RfdmNwdV9iaXRtYXApOwotCi0gICAgcmV0dXJuIGRlc3Q7Ci19Ci0KIGludCBw
dF9pcnFfY3JlYXRlX2JpbmQoCiAgICAgc3RydWN0IGRvbWFpbiAqZCwgY29uc3Qgc3RydWN0IHhl
bl9kb21jdGxfYmluZF9wdF9pcnEgKnB0X2lycV9iaW5kKQogewpAQCAtMzQ1LDYgKzI4OSw4IEBA
IGludCBwdF9pcnFfY3JlYXRlX2JpbmQoCiAgICAgICAgIGNvbnN0IHN0cnVjdCB2Y3B1ICp2Y3B1
OwogICAgICAgICB1aW50MzJfdCBnZmxhZ3MgPSBwdF9pcnFfYmluZC0+dS5tc2kuZ2ZsYWdzICYK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgflhFTl9ET01DVExfVk1TSV9YODZfVU5NQVNLRUQ7
CisgICAgICAgIERFQ0xBUkVfQklUTUFQKGRlc3RfdmNwdXMsIE1BWF9WSVJUX0NQVVMpID0geyB9
OworICAgICAgICBERUNMQVJFX0JJVE1BUChwcmV2X3ZjcHVzLCBNQVhfVklSVF9DUFVTKSA9IHsg
fTsKIAogICAgICAgICBpZiAoICEocGlycV9kcGNpLT5mbGFncyAmIEhWTV9JUlFfRFBDSV9NQVBQ
RUQpICkKICAgICAgICAgewpAQCAtNDExLDYgKzM1NywyNCBAQCBpbnQgcHRfaXJxX2NyZWF0ZV9i
aW5kKAogCiAgICAgICAgICAgICAgICAgcGlycV9kcGNpLT5nbXNpLmd2ZWMgPSBwdF9pcnFfYmlu
ZC0+dS5tc2kuZ3ZlYzsKICAgICAgICAgICAgICAgICBwaXJxX2RwY2ktPmdtc2kuZ2ZsYWdzID0g
Z2ZsYWdzOworICAgICAgICAgICAgICAgIGlmICggcGlycV9kcGNpLT5nbXNpLmRlc3RfdmNwdV9p
ZCAhPSAtMSApCisgICAgICAgICAgICAgICAgICAgIF9fc2V0X2JpdChwaXJxX2RwY2ktPmdtc2ku
ZGVzdF92Y3B1X2lkLCBwcmV2X3ZjcHVzKTsKKyAgICAgICAgICAgICAgICBlbHNlCisgICAgICAg
ICAgICAgICAgeworICAgICAgICAgICAgICAgICAgICAvKgorICAgICAgICAgICAgICAgICAgICAg
KiBJZiBwcmV2aW91cyBjb25maWd1cmF0aW9uIGhhcyBtdWx0aXBsZSBwb3NzaWJsZQorICAgICAg
ICAgICAgICAgICAgICAgKiBkZXN0aW5hdGlvbnMgcmVjb3JkIHRoZW0gaW4gb3JkZXIgdG8gc3lu
YyB0aGUgUElSIHRvIElSUgorICAgICAgICAgICAgICAgICAgICAgKiBhZnRlcndhcmRzLgorICAg
ICAgICAgICAgICAgICAgICAgKi8KKyAgICAgICAgICAgICAgICAgICAgZGVzdCA9IE1BU0tfRVhU
UihwaXJxX2RwY2ktPmdtc2kuZ2ZsYWdzLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIFhFTl9ET01DVExfVk1TSV9YODZfREVTVF9JRF9NQVNLKTsKKyAgICAgICAgICAgICAg
ICAgICAgZGVzdF9tb2RlID0gcGlycV9kcGNpLT5nbXNpLmdmbGFncyAmCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIFhFTl9ET01DVExfVk1TSV9YODZfRE1fTUFTSzsKKyAgICAgICAg
ICAgICAgICAgICAgZGVsaXZlcnlfbW9kZSA9IE1BU0tfRVhUUihwaXJxX2RwY2ktPmdtc2kuZ2Zs
YWdzLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFhFTl9E
T01DVExfVk1TSV9YODZfREVMSVZfTUFTSyk7CisgICAgICAgICAgICAgICAgICAgIGh2bV9pbnRy
X2dldF9kZXN0cyhkLCBkZXN0LCBkZXN0X21vZGUsIGRlbGl2ZXJ5X21vZGUsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2X3ZjcHVzKTsKKyAgICAgICAgICAgICAg
ICB9CiAgICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgICAgLyogQ2FsY3VsYXRlIGRlc3Rf
dmNwdV9pZCBmb3IgTVNJLXR5cGUgcGlycSBtaWdyYXRpb24uICovCkBAIC00MjAsMjAgKzM4NCwx
NiBAQCBpbnQgcHRfaXJxX2NyZWF0ZV9iaW5kKAogICAgICAgICBkZWxpdmVyeV9tb2RlID0gTUFT
S19FWFRSKHBpcnFfZHBjaS0+Z21zaS5nZmxhZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgWEVOX0RPTUNUTF9WTVNJX1g4Nl9ERUxJVl9NQVNLKTsKIAotICAgICAgICBkZXN0
X3ZjcHVfaWQgPSBodm1fZ2lycV9kZXN0XzJfdmNwdV9pZChkLCBkZXN0LCBkZXN0X21vZGUpOwor
ICAgICAgICBodm1faW50cl9nZXRfZGVzdHMoZCwgZGVzdCwgZGVzdF9tb2RlLCBkZWxpdmVyeV9t
b2RlLCBkZXN0X3ZjcHVzKTsKKyAgICAgICAgZGVzdF92Y3B1X2lkID0gYml0bWFwX3dlaWdodChk
ZXN0X3ZjcHVzLCBkLT5tYXhfdmNwdXMpICE9IDEgPworICAgICAgICAgICAgLTEgOiBmaW5kX2Zp
cnN0X2JpdChkZXN0X3ZjcHVzLCBkLT5tYXhfdmNwdXMpOwogICAgICAgICBwaXJxX2RwY2ktPmdt
c2kuZGVzdF92Y3B1X2lkID0gZGVzdF92Y3B1X2lkOwogICAgICAgICBzcGluX3VubG9jaygmZC0+
ZXZlbnRfbG9jayk7CiAKICAgICAgICAgcGlycV9kcGNpLT5nbXNpLnBvc3RlZCA9IGZhbHNlOwog
ICAgICAgICB2Y3B1ID0gKGRlc3RfdmNwdV9pZCA+PSAwKSA/IGQtPnZjcHVbZGVzdF92Y3B1X2lk
XSA6IE5VTEw7Ci0gICAgICAgIGlmICggaW9tbXVfaW50cG9zdCApCi0gICAgICAgIHsKLSAgICAg
ICAgICAgIGlmICggZGVsaXZlcnlfbW9kZSA9PSBkZXN0X0xvd2VzdFByaW8gKQotICAgICAgICAg
ICAgICAgIHZjcHUgPSB2ZWN0b3JfaGFzaGluZ19kZXN0KGQsIGRlc3QsIGRlc3RfbW9kZSwKLSAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXJxX2RwY2ktPmdtc2ku
Z3ZlYyk7Ci0gICAgICAgICAgICBpZiAoIHZjcHUgKQotICAgICAgICAgICAgICAgIHBpcnFfZHBj
aS0+Z21zaS5wb3N0ZWQgPSB0cnVlOwotICAgICAgICB9CisgICAgICAgIGlmICggdmNwdSAmJiBp
b21tdV9pbnRwb3N0ICkKKyAgICAgICAgICAgIHBpcnFfZHBjaS0+Z21zaS5wb3N0ZWQgPSB0cnVl
OwogICAgICAgICBpZiAoIHZjcHUgJiYgaXNfaW9tbXVfZW5hYmxlZChkKSApCiAgICAgICAgICAg
ICBodm1fbWlncmF0ZV9waXJxKHBpcnFfZHBjaSwgdmNwdSk7CiAKQEAgLTQ0Miw2ICs0MDIsOSBA
QCBpbnQgcHRfaXJxX2NyZWF0ZV9iaW5kKAogICAgICAgICAgICAgcGlfdXBkYXRlX2lydGUodmNw
dSA/ICZ2Y3B1LT5hcmNoLmh2bS52bXgucGlfZGVzYyA6IE5VTEwsCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBpbmZvLCBwaXJxX2RwY2ktPmdtc2kuZ3ZlYyk7CiAKKyAgICAgICAgaWYgKCBo
dm1fZnVuY3MuZGVsaXZlcl9wb3N0ZWRfaW50ciApCisgICAgICAgICAgICBkb21haW5fc3luY192
bGFwaWNfcGlyKGQsIHByZXZfdmNwdXMpOworCiAgICAgICAgIGlmICggcHRfaXJxX2JpbmQtPnUu
bXNpLmdmbGFncyAmIFhFTl9ET01DVExfVk1TSV9YODZfVU5NQVNLRUQgKQogICAgICAgICB7CiAg
ICAgICAgICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwpAQCAtNzMxLDYgKzY5NCwzMSBAQCBpbnQg
cHRfaXJxX2Rlc3Ryb3lfYmluZCgKICAgICBlbHNlIGlmICggcGlycV9kcGNpICYmIHBpcnFfZHBj
aS0+Z21zaS5wb3N0ZWQgKQogICAgICAgICBwaV91cGRhdGVfaXJ0ZShOVUxMLCBwaXJxLCAwKTsK
IAorICAgIGlmICggaHZtX2Z1bmNzLmRlbGl2ZXJfcG9zdGVkX2ludHIgKQorICAgIHsKKyAgICAg
ICAgREVDTEFSRV9CSVRNQVAodmNwdXMsIE1BWF9WSVJUX0NQVVMpID0geyB9OworCisgICAgICAg
IGlmICggcGlycV9kcGNpLT5nbXNpLmRlc3RfdmNwdV9pZCAhPSAtMSApCisgICAgICAgICAgICBf
X3NldF9iaXQocGlycV9kcGNpLT5nbXNpLmRlc3RfdmNwdV9pZCwgdmNwdXMpOworICAgICAgICBl
bHNlCisgICAgICAgIHsKKyAgICAgICAgICAgIC8qCisgICAgICAgICAgICAgKiBJZiBwcmV2aW91
cyBjb25maWd1cmF0aW9uIGhhcyBtdWx0aXBsZSBwb3NzaWJsZQorICAgICAgICAgICAgICogZGVz
dGluYXRpb25zIHJlY29yZCB0aGVtIGluIG9yZGVyIHRvIHN5bmMgdGhlIFBJUiB0byBJUlIuCisg
ICAgICAgICAgICAgKi8KKyAgICAgICAgICAgIHVpbnQ4X3QgZGVzdCA9IE1BU0tfRVhUUihwaXJx
X2RwY2ktPmdtc2kuZ2ZsYWdzLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IFhFTl9ET01DVExfVk1TSV9YODZfREVTVF9JRF9NQVNLKTsKKyAgICAgICAgICAgIHVpbnQ4X3Qg
ZGVzdF9tb2RlID0gcGlycV9kcGNpLT5nbXNpLmdmbGFncyAmCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIFhFTl9ET01DVExfVk1TSV9YODZfRE1fTUFTSzsKKyAgICAgICAgICAgIHVp
bnQ4X3QgZGVsaXZlcnlfbW9kZSA9IE1BU0tfRVhUUihwaXJxX2RwY2ktPmdtc2kuZ2ZsYWdzLAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFhFTl9ET01DVExf
Vk1TSV9YODZfREVMSVZfTUFTSyk7CisKKyAgICAgICAgICAgIGh2bV9pbnRyX2dldF9kZXN0cyhk
LCBkZXN0LCBkZXN0X21vZGUsIGRlbGl2ZXJ5X21vZGUsIHZjcHVzKTsKKyAgICAgICAgfQorCisg
ICAgICAgIGRvbWFpbl9zeW5jX3ZsYXBpY19waXIoZCwgdmNwdXMpOworICAgIH0KKwogICAgIGlm
ICggcGlycV9kcGNpICYmIChwaXJxX2RwY2ktPmZsYWdzICYgSFZNX0lSUV9EUENJX01BUFBFRCkg
JiYKICAgICAgICAgIGxpc3RfZW1wdHkoJnBpcnFfZHBjaS0+ZGlnbF9saXN0KSApCiAgICAgewpk
aWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vaHZtLmggYi94ZW4vaW5jbHVkZS9h
c20teDg2L2h2bS9odm0uaAppbmRleCBmODZhZjA5ODk4Li44OTk2NjVmZWQ4IDEwMDY0NAotLS0g
YS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaAorKysgYi94ZW4vaW5jbHVkZS9hc20teDg2
L2h2bS9odm0uaApAQCAtMjY2LDcgKzI2Niw2IEBAIGludCB2bXNpX2RlbGl2ZXIoCiAgICAgdWlu
dDhfdCBkZWxpdmVyeV9tb2RlLCB1aW50OF90IHRyaWdfbW9kZSk7CiBzdHJ1Y3QgaHZtX3BpcnFf
ZHBjaTsKIHZvaWQgdm1zaV9kZWxpdmVyX3BpcnEoc3RydWN0IGRvbWFpbiAqZCwgY29uc3Qgc3Ry
dWN0IGh2bV9waXJxX2RwY2kgKik7Ci1pbnQgaHZtX2dpcnFfZGVzdF8yX3ZjcHVfaWQoc3RydWN0
IGRvbWFpbiAqZCwgdWludDhfdCBkZXN0LCB1aW50OF90IGRlc3RfbW9kZSk7CiAKIGVudW0gaHZt
X2ludGJsawogaHZtX2ludGVycnVwdF9ibG9ja2VkKHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QgaHZt
X2ludGFjayBpbnRhY2spOwpAQCAtMzM2LDYgKzMzNSwxMCBAQCB1bnNpZ25lZCBsb25nIGh2bV9j
cjRfZ3Vlc3RfdmFsaWRfYml0cyhjb25zdCBzdHJ1Y3QgZG9tYWluICpkLCBib29sIHJlc3RvcmUp
OwogYm9vbCBodm1fZmx1c2hfdmNwdV90bGIoYm9vbCAoKmZsdXNoX3ZjcHUpKHZvaWQgKmN0eHQs
IHN0cnVjdCB2Y3B1ICp2KSwKICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgKmN0eHQpOwog
CisvKiBHZXQgYWxsIHRoZSBwb3NzaWJsZSBkZXN0aW5hdGlvbiB2Q1BVcyBvZiBhbiBpbnRlcnJ1
cHQuICovCitpbnQgaHZtX2ludHJfZ2V0X2Rlc3RzKHN0cnVjdCBkb21haW4gKmQsIHVpbnQ4X3Qg
ZGVzdCwgdWludDhfdCBkZXN0X21vZGUsCisgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ4X3Qg
ZGVsaXZlcnlfbW9kZSwgdW5zaWduZWQgbG9uZyAqdmNwdXMpOworCiAjaWZkZWYgQ09ORklHX0hW
TQogCiAjZGVmaW5lIGh2bV9nZXRfZ3Vlc3RfdHNjKHYpIGh2bV9nZXRfZ3Vlc3RfdHNjX2ZpeGVk
KHYsIDApCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS92bGFwaWMuaCBiL3hl
bi9pbmNsdWRlL2FzbS14ODYvaHZtL3ZsYXBpYy5oCmluZGV4IGRkZTY2YjRmMGYuLjJiYzJlYmFk
ZjAgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvaHZtL3ZsYXBpYy5oCisrKyBiL3hl
bi9pbmNsdWRlL2FzbS14ODYvaHZtL3ZsYXBpYy5oCkBAIC0xNTAsNCArMTUwLDcgQEAgYm9vbF90
IHZsYXBpY19tYXRjaF9kZXN0KAogICAgIGNvbnN0IHN0cnVjdCB2bGFwaWMgKnRhcmdldCwgY29u
c3Qgc3RydWN0IHZsYXBpYyAqc291cmNlLAogICAgIGludCBzaG9ydF9oYW5kLCB1aW50MzJfdCBk
ZXN0LCBib29sX3QgZGVzdF9tb2RlKTsKIAorLyogU3luYyB0aGUgUElSIHRvIElSUiBvZiBhbGwg
dmxhcGljcyBpbiB0aGUgdmNwdXMgYml0bWFwLiAqLwordm9pZCBkb21haW5fc3luY192bGFwaWNf
cGlyKHN0cnVjdCBkb21haW4gKmQsIHVuc2lnbmVkIGxvbmcgKnZjcHVzKTsKKwogI2VuZGlmIC8q
IF9fQVNNX1g4Nl9IVk1fVkxBUElDX0hfXyAqLwotLSAKMi4yNC4wCgoKX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApY
ZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

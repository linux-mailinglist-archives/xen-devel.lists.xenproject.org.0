Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 83E62118EB
	for <lists+xen-devel@lfdr.de>; Thu,  2 May 2019 14:22:11 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hMAgE-0004P6-Kd; Thu, 02 May 2019 12:19:14 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=oUxd=TC=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1hMAgC-0004Ot-O1
 for xen-devel@lists.xenproject.org; Thu, 02 May 2019 12:19:12 +0000
X-Inumbo-ID: 7d3a1c2b-6cd4-11e9-843c-bc764e045a96
Received: from prv1-mh.provo.novell.com (unknown [137.65.248.33])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 7d3a1c2b-6cd4-11e9-843c-bc764e045a96;
 Thu, 02 May 2019 12:19:10 +0000 (UTC)
Received: from INET-PRV1-MTA by prv1-mh.provo.novell.com
 with Novell_GroupWise; Thu, 02 May 2019 06:19:09 -0600
Message-Id: <5CCAE03C020000780022B2E8@prv1-mh.provo.novell.com>
X-Mailer: Novell GroupWise Internet Agent 18.1.0 
Date: Thu, 02 May 2019 06:19:08 -0600
From: "Jan Beulich" <JBeulich@suse.com>
To: "xen-devel" <xen-devel@lists.xenproject.org>
References: <5CCAD5ED020000780022B2A2@prv1-mh.provo.novell.com>
In-Reply-To: <5CCAD5ED020000780022B2A2@prv1-mh.provo.novell.com>
Mime-Version: 1.0
Content-Disposition: inline
Subject: [Xen-devel] [PATCH 2/9] x86: limit the amount of TLB flushing in
 switch_cr3_cr4()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Wei Liu <wei.liu2@citrix.com>,
 Roger Pau Monne <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2UgcmVhbGx5IG5lZWQgdG8gZmx1c2ggdGhlIFRMQiBqdXN0IG9uY2UsIGlmIHdlIGRvIHNvIHdp
dGggb3IgYWZ0ZXIgdGhlCkNSMyB3cml0ZS4gVGhlIG9ubHkgY2FzZSB3aGVyZSB0d28gZmx1c2hl
cyBhcmUgdW5hdm9pZGFibGUgaXMgd2hlbiB3ZQptZWFuIHRvIHR1cm4gb2ZmIENSNC5QR0UgKHBl
cmhhcHMganVzdCB0ZW1wb3JhcmlseTsgc2VlIHRoZSBjb2RlCmNvbW1lbnQpLgoKU2lnbmVkLW9m
Zi1ieTogSmFuIEJldWxpY2ggPGpiZXVsaWNoQHN1c2UuY29tPgoKLS0tIGEveGVuL2FyY2gveDg2
L2ZsdXNodGxiLmMKKysrIGIveGVuL2FyY2gveDg2L2ZsdXNodGxiLmMKQEAgLTEwNCw4MiArMTA0
LDY1IEBAIHN0YXRpYyB2b2lkIGRvX3RsYl9mbHVzaCh2b2lkKQogdm9pZCBzd2l0Y2hfY3IzX2Ny
NCh1bnNpZ25lZCBsb25nIGNyMywgdW5zaWduZWQgbG9uZyBjcjQpCiB7CiAgICAgdW5zaWduZWQg
bG9uZyBmbGFncywgb2xkX2NyNDsKLSAgICB1bnNpZ25lZCBpbnQgb2xkX3BjaWQ7CiAgICAgdTMy
IHQ7CiAKKyAgICAvKiBUaHJvdWdob3V0IHRoaXMgZnVuY3Rpb24gd2UgbWFrZSB0aGlzIGFzc3Vt
cHRpb246ICovCisgICAgQVNTRVJUKCEoY3I0ICYgWDg2X0NSNF9QQ0lERSkgfHwgIShjcjQgJiBY
ODZfQ1I0X1BHRSkpOworCiAgICAgLyogVGhpcyBub24tcmVlbnRyYW50IGZ1bmN0aW9uIGlzIHNv
bWV0aW1lcyBjYWxsZWQgaW4gaW50ZXJydXB0IGNvbnRleHQuICovCiAgICAgbG9jYWxfaXJxX3Nh
dmUoZmxhZ3MpOwogCiAgICAgdCA9IHByZV9mbHVzaCgpOwogCiAgICAgb2xkX2NyNCA9IHJlYWRf
Y3I0KCk7Ci0gICAgaWYgKCBvbGRfY3I0ICYgWDg2X0NSNF9QR0UgKQorICAgIEFTU0VSVCghKG9s
ZF9jcjQgJiBYODZfQ1I0X1BDSURFKSB8fCAhKG9sZF9jcjQgJiBYODZfQ1I0X1BHRSkpOworCisg
ICAgLyoKKyAgICAgKiBXZSBuZWVkIHRvIHdyaXRlIENSNCBiZWZvcmUgQ1IzIGlmIHdlJ3JlIGFi
b3V0IHRvIGVuYWJsZSBQQ0lERSwgYXQgdGhlCisgICAgICogdmVyeSBsZWFzdCB3aGVuIHRoZSBu
ZXcgUENJRCBpcyBub24temVyby4KKyAgICAgKgorICAgICAqIEFzIHdlIGFsc28gbmVlZCB0byBk
byB0d28gQ1I0IHdyaXRlcyBpbiB0b3RhbCB3aGVuIFBHRSBpcyBlbmFibGVkIGFuZAorICAgICAq
IGlzIHRvIHJlbWFpbiBlbmFibGVkLCBkbyB0aGUgb25lIHRlbXBvcmFyaWx5IHR1cm5pbmcgb2Zm
IHRoZSBiaXQgcmlnaHQKKyAgICAgKiBoZXJlIGFzIHdlbGwuCisgICAgICoKKyAgICAgKiBUaGUg
b25seSBUTEIgZmx1c2hpbmcgZWZmZWN0IHdlIGRlcGVuZCBvbiBoZXJlIGlzIGluIGNhc2Ugd2Ug
bW92ZSBmcm9tCisgICAgICogUEdFIHNldCB0byBQQ0lERSBzZXQsIHdoZXJlIHdlIHdhbnQgZ2xv
YmFsIHBhZ2UgZW50cmllcyBnb25lIChhbmQgbm9uZQorICAgICAqIHRvIHJlLWFwcGVhcikgYWZ0
ZXIgdGhpcyB3cml0ZS4KKyAgICAgKi8KKyAgICBpZiAoICEob2xkX2NyNCAmIFg4Nl9DUjRfUENJ
REUpICYmCisgICAgICAgICAoKGNyNCAmIFg4Nl9DUjRfUENJREUpIHx8IChjcjQgJiBvbGRfY3I0
ICYgWDg2X0NSNF9QR0UpKSApCiAgICAgewotICAgICAgICAvKgotICAgICAgICAgKiBYODZfQ1I0
X1BHRSBzZXQgbWVhbnMgUENJRCBpcyBpbmFjdGl2ZS4KLSAgICAgICAgICogV2UgaGF2ZSB0byBw
dXJnZSB0aGUgVExCIHZpYSBmbGlwcGluZyBjcjQucGdlLgotICAgICAgICAgKi8KICAgICAgICAg
b2xkX2NyNCA9IGNyNCAmIH5YODZfQ1I0X1BHRTsKICAgICAgICAgd3JpdGVfY3I0KG9sZF9jcjQp
OwogICAgIH0KLSAgICBlbHNlIGlmICggdXNlX2ludnBjaWQgKQotICAgIHsKLSAgICAgICAgLyoK
LSAgICAgICAgICogRmx1c2hpbmcgdGhlIFRMQiB2aWEgSU5WUENJRCBpcyBuZWNlc3Nhcnkgb25s
eSBpbiBjYXNlIFBDSURzIGFyZQotICAgICAgICAgKiBpbiB1c2UsIHdoaWNoIGlzIHRydWUgb25s
eSB3aXRoIElOVlBDSUQgYmVpbmcgYXZhaWxhYmxlLgotICAgICAgICAgKiBXaXRob3V0IFBDSUQg
dXNhZ2UgdGhlIGZvbGxvd2luZyB3cml0ZV9jcjMoKSB3aWxsIHB1cmdlIHRoZSBUTEIKLSAgICAg
ICAgICogKHdlIGFyZSBpbiB0aGUgY3I0LnBnZSBvZmYgcGF0aCkgb2YgYWxsIGVudHJpZXMuCi0g
ICAgICAgICAqIFVzaW5nIGludnBjaWRfZmx1c2hfYWxsX25vbmdsb2JhbHMoKSBzZWVtcyB0byBi
ZSBmYXN0ZXIgdGhhbgotICAgICAgICAgKiBpbnZwY2lkX2ZsdXNoX2FsbCgpLCBzbyB1c2UgdGhh
dC4KLSAgICAgICAgICovCi0gICAgICAgIGludnBjaWRfZmx1c2hfYWxsX25vbmdsb2JhbHMoKTsK
LQotICAgICAgICAvKgotICAgICAgICAgKiBDUjQuUENJREUgbmVlZHMgdG8gYmUgc2V0IGJlZm9y
ZSB0aGUgQ1IzIHdyaXRlIGJlbG93LiBPdGhlcndpc2UKLSAgICAgICAgICogLSB0aGUgQ1IzIHdy
aXRlIHdpbGwgZmF1bHQgd2hlbiBDUjMuTk9GTFVTSCBpcyBzZXQgKHdoaWNoIGlzIHRoZQotICAg
ICAgICAgKiAgIGNhc2Ugbm9ybWFsbHkpLAotICAgICAgICAgKiAtIHRoZSBzdWJzZXF1ZW50IENS
NCB3cml0ZSB3aWxsIGZhdWx0IGlmIENSMy5QQ0lEICE9IDAuCi0gICAgICAgICAqLwotICAgICAg
ICBpZiAoIChvbGRfY3I0ICYgWDg2X0NSNF9QQ0lERSkgPCAoY3I0ICYgWDg2X0NSNF9QQ0lERSkg
KQotICAgICAgICB7Ci0gICAgICAgICAgICB3cml0ZV9jcjQoY3I0KTsKLSAgICAgICAgICAgIG9s
ZF9jcjQgPSBjcjQ7Ci0gICAgICAgIH0KLSAgICB9CiAKICAgICAvKgotICAgICAqIElmIHdlIGRv
bid0IGNoYW5nZSBQQ0lEcywgdGhlIENSMyB3cml0ZSBiZWxvdyBuZWVkcyB0byBmbHVzaCB0aGlz
IHZlcnkKLSAgICAgKiBQQ0lELCBldmVuIHdoZW4gYSBmdWxsIGZsdXNoIHdhcyBwZXJmb3JtZWQg
YWJvdmUsIGFzIHdlIGFyZSBjdXJyZW50bHkKLSAgICAgKiBhY2N1bXVsYXRpbmcgVExCIGVudHJp
ZXMgYWdhaW4gZnJvbSB0aGUgb2xkIGFkZHJlc3Mgc3BhY2UuCi0gICAgICogTkI6IENsZWFyaW5n
IHRoZSBiaXQgd2hlbiB3ZSBkb24ndCB1c2UgUENJRCBpcyBiZW5pZ24gKGFzIGl0IGlzIGNsZWFy
Ci0gICAgICogYWxyZWFkeSBpbiB0aGF0IGNhc2UpLCBidXQgYWxsb3dzIHRoZSBpZigpIHRvIGJl
IG1vcmUgc2ltcGxlLgorICAgICAqIElmIHRoZSBDUjQgd3JpdGUgaXMgdG8gdHVybiBvZmYgUENJ
REUsIHdlIGRvbid0IG5lZWQgdGhlIENSMyB3cml0ZSB0bworICAgICAqIGZsdXNoIGFueXRoaW5n
LCBhcyB0aGF0IHRyYW5zaXRpb24gaXMgYSBmdWxsIGZsdXNoIGl0c2VsZi4KICAgICAgKi8KLSAg
ICBvbGRfcGNpZCA9IGNyM19wY2lkKHJlYWRfY3IzKCkpOwotICAgIGlmICggb2xkX3BjaWQgPT0g
Y3IzX3BjaWQoY3IzKSApCi0gICAgICAgIGNyMyAmPSB+WDg2X0NSM19OT0ZMVVNIOwotCisgICAg
aWYgKCAob2xkX2NyNCAmIFg4Nl9DUjRfUENJREUpID4gKGNyNCAmIFg4Nl9DUjRfUENJREUpICkK
KyAgICAgICAgY3IzIHw9IFg4Nl9DUjNfTk9GTFVTSDsKICAgICB3cml0ZV9jcjMoY3IzKTsKIAog
ICAgIGlmICggb2xkX2NyNCAhPSBjcjQgKQogICAgICAgICB3cml0ZV9jcjQoY3I0KTsKIAogICAg
IC8qCi0gICAgICogTWFrZSBzdXJlIG5vIFRMQiBlbnRyaWVzIHJlbGF0ZWQgdG8gdGhlIG9sZCBQ
Q0lEIGNyZWF0ZWQgYmV0d2VlbgotICAgICAqIGZsdXNoaW5nIHRoZSBUTEIgYW5kIHdyaXRpbmcg
dGhlIG5ldyAlY3IzIHZhbHVlIHJlbWFpbiBpbiB0aGUgVExCLgotICAgICAqCi0gICAgICogVGhl
IHdyaXRlIHRvIENSNCBqdXN0IGFib3ZlIGhhcyBwZXJmb3JtZWQgYSB3aWRlciBmbHVzaCBpbiBj
ZXJ0YWluCi0gICAgICogY2FzZXMsIHdoaWNoIHRoZXJlZm9yZSBnZXQgZXhjbHVkZWQgaGVyZS4g
U2luY2UgdGhhdCB3cml0ZSBpcwotICAgICAqIGNvbmRpdGlvbmFsLCBub3RlIGluIHBhcnRpY3Vs
YXIgdGhhdCBpdCB3b24ndCBiZSBza2lwcGVkIGlmIFBDSURFCi0gICAgICogdHJhbnNpdGlvbnMg
ZnJvbSAxIHRvIDAuIFRoaXMgaXMgYmVjYXVzZSB0aGUgQ1I0IHdyaXRlIGZ1cnRoZXIgdXAgd2ls
bAotICAgICAqIGhhdmUgYmVlbiBza2lwcGVkIGluIHRoaXMgY2FzZSwgYXMgUENJREUgYW5kIFBH
RSB3b24ndCBib3RoIGJlIHNldCBhdAotICAgICAqIHRoZSBzYW1lIHRpbWUuCi0gICAgICoKLSAg
ICAgKiBOb3RlIGFsc28gdGhhdCBQR0UgaXMgYWx3YXlzIGNsZWFyIGluIG9sZF9jcjQuCisgICAg
ICogIFBHRSAgfCBQQ0lERSB8IGZsdXNoIGF0CisgICAgICogLS0tLS0tKy0tLS0tLS0rLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tCisgICAgICogIDAtPjAgfCAwLT4wICB8IENSMyB3cml0ZQorICAg
ICAqICAwLT4wIHwgMC0+MSAgfCBuL2EgKHNlZSAxc3QgQ1I0IHdyaXRlKQorICAgICAqICAwLT54
IHwgMS0+MCAgfCBDUjQgd3JpdGUKKyAgICAgKiAgeC0+MSB8IHgtPjEgIHwgbi9hCisgICAgICog
IDAtPjAgfCAxLT4xICB8IElOVlBDSUQKKyAgICAgKiAgMC0+MSB8IDAtPjAgIHwgQ1IzIGFuZCBD
UjQgd3JpdGVzCisgICAgICogIDEtPjAgfCAwLT4wICB8IENSNCB3cml0ZQorICAgICAqICAxLT4w
IHwgMC0+MSAgfCBuL2EgKHNlZSAxc3QgQ1I0IHdyaXRlKQorICAgICAqICAxLT4xIHwgMC0+MCAg
fCBuL2EgKHNlZSAxc3QgQ1I0IHdyaXRlKQorICAgICAqICAxLT54IHwgMS0+eCAgfCBuL2EKICAg
ICAgKi8KLSAgICBpZiAoIG9sZF9wY2lkICE9IGNyM19wY2lkKGNyMykgJiYKLSAgICAgICAgICEo
Y3I0ICYgWDg2X0NSNF9QR0UpICYmCi0gICAgICAgICAob2xkX2NyNCAmIFg4Nl9DUjRfUENJREUp
IDw9IChjcjQgJiBYODZfQ1I0X1BDSURFKSApCi0gICAgICAgIGludnBjaWRfZmx1c2hfc2luZ2xl
X2NvbnRleHQob2xkX3BjaWQpOworICAgIGlmICggY3I0ICYgWDg2X0NSNF9QQ0lERSApCisgICAg
ICAgIGludnBjaWRfZmx1c2hfYWxsX25vbmdsb2JhbHMoKTsKIAogICAgIHBvc3RfZmx1c2godCk7
CiAKCgoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhl
bi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBz
Oi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

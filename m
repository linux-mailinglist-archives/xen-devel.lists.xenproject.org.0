Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 23E6A43697
	for <lists+xen-devel@lfdr.de>; Thu, 13 Jun 2019 15:30:02 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hbPku-0001pq-Th; Thu, 13 Jun 2019 13:27:04 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=BOU1=UM=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1hbPkt-0001pd-44
 for xen-devel@lists.xenproject.org; Thu, 13 Jun 2019 13:27:03 +0000
X-Inumbo-ID: ed56cb81-8dde-11e9-8980-bc764e045a96
Received: from prv1-mh.provo.novell.com (unknown [137.65.248.33])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id ed56cb81-8dde-11e9-8980-bc764e045a96;
 Thu, 13 Jun 2019 13:27:01 +0000 (UTC)
Received: from INET-PRV1-MTA by prv1-mh.provo.novell.com
 with Novell_GroupWise; Thu, 13 Jun 2019 07:27:01 -0600
Message-Id: <5D024F220200007800237E2E@prv1-mh.provo.novell.com>
X-Mailer: Novell GroupWise Internet Agent 18.1.1 
Date: Thu, 13 Jun 2019 07:26:58 -0600
From: "Jan Beulich" <JBeulich@suse.com>
To: "xen-devel" <xen-devel@lists.xenproject.org>
References: <5D024C500200007800237DD8@prv1-mh.provo.novell.com>
In-Reply-To: <5D024C500200007800237DD8@prv1-mh.provo.novell.com>
Mime-Version: 1.0
Content-Disposition: inline
Subject: [Xen-devel] [PATCH 7/9] AMD/IOMMU: adjust setup of internal
 interrupt for x2APIC mode
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Brian Woods <brian.woods@amd.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SW4gb3JkZXIgdG8gYmUgYWJsZSB0byBleHByZXNzIGFsbCBwb3NzaWJsZSBkZXN0aW5hdGlvbnMg
d2UgbmVlZCB0byBtYWtlCnVzZSBvZiB0aGlzIG5vbi1NU0ktY2FwYWJpbGl0eSBiYXNlZCBtZWNo
YW5pc20uIFRoZSBuZXcgSVJRIGNvbnRyb2xsZXIKc3RydWN0dXJlIGNhbiByZS11c2UgY2VydGFp
biBNU0kgZnVuY3Rpb25zLCB0aG91Z2guCgpGb3Igbm93IGdlbmVyYWwgYW5kIFBQUiBpbnRlcnJ1
cHRzIHN0aWxsIHNoYXJlIGEgc2luZ2xlIHZlY3RvciwgSVJRLCBhbmQKaGVuY2UgaGFuZGxlci4K
ClNpZ25lZC1vZmYtYnk6IEphbiBCZXVsaWNoIDxqYmV1bGljaEBzdXNlLmNvbT4KCi0tLSBhL3hl
bi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9pb21tdV9pbml0LmMKKysrIGIveGVuL2RyaXZlcnMv
cGFzc3Rocm91Z2gvYW1kL2lvbW11X2luaXQuYwpAQCAtNDcyLDYgKzQ3Miw0NCBAQCBzdGF0aWMg
aHdfaXJxX2NvbnRyb2xsZXIgaW9tbXVfbWFza2FibGVfCiAgICAgLnNldF9hZmZpbml0eSA9IHNl
dF9tc2lfYWZmaW5pdHksCiB9OwogCitzdGF0aWMgdm9pZCBzZXRfeDJhcGljX2FmZmluaXR5KHN0
cnVjdCBpcnFfZGVzYyAqZGVzYywgY29uc3QgY3B1bWFza190ICptYXNrKQoreworICAgIHN0cnVj
dCBhbWRfaW9tbXUgKmlvbW11ID0gZGVzYy0+YWN0aW9uLT5kZXZfaWQ7CisgICAgdW5zaWduZWQg
aW50IGRlc3QgPSBzZXRfZGVzY19hZmZpbml0eShkZXNjLCBtYXNrKTsKKyAgICB1bmlvbiBhbWRf
aW9tbXVfeDJhcGljX2NvbnRyb2wgY3RybCA9IHt9OworICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7
CisKKyAgICBpZiAoIGRlc3QgPT0gQkFEX0FQSUNJRCApCisgICAgICAgIHJldHVybjsKKworICAg
IG1zaV9jb21wb3NlX21zZyhkZXNjLT5hcmNoLnZlY3RvciwgTlVMTCwgJmlvbW11LT5tc2kubXNn
KTsKKyAgICBpb21tdS0+bXNpLm1zZy5kZXN0MzIgPSBkZXN0OworCisgICAgY3RybC5kZXN0X21v
ZGUgPSBNQVNLX0VYVFIoaW9tbXUtPm1zaS5tc2cuYWRkcmVzc19sbywKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBNU0lfQUREUl9ERVNUTU9ERV9NQVNLKTsKKyAgICBjdHJsLmludF90
eXBlID0gTUFTS19FWFRSKGlvbW11LT5tc2kubXNnLmRhdGEsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBNU0lfREFUQV9ERUxJVkVSWV9NT0RFX01BU0spOworICAgIGN0cmwudmVjdG9y
ID0gZGVzYy0+YXJjaC52ZWN0b3I7CisgICAgY3RybC5kZXN0X2xvID0gZGVzdDsKKyAgICBjdHJs
LmRlc3RfaGkgPSBkZXN0ID4+IDI0OworCisgICAgc3Bpbl9sb2NrX2lycXNhdmUoJmlvbW11LT5s
b2NrLCBmbGFncyk7CisgICAgd3JpdGVxKGN0cmwucmF3LCBpb21tdS0+bW1pb19iYXNlICsgSU9N
TVVfWFRfSU5UX0NUUkxfTU1JT19PRkZTRVQpOworICAgIHdyaXRlcShjdHJsLnJhdywgaW9tbXUt
Pm1taW9fYmFzZSArIElPTU1VX1hUX1BQUl9JTlRfQ1RSTF9NTUlPX09GRlNFVCk7CisgICAgc3Bp
bl91bmxvY2tfaXJxcmVzdG9yZSgmaW9tbXUtPmxvY2ssIGZsYWdzKTsKK30KKworc3RhdGljIGh3
X2lycV9jb250cm9sbGVyIGlvbW11X3gyYXBpY190eXBlID0geworICAgIC50eXBlbmFtZSAgICAg
PSAiSU9NTVUteDJBUElDIiwKKyAgICAuc3RhcnR1cCAgICAgID0gaXJxX3N0YXJ0dXBfbm9uZSwK
KyAgICAuc2h1dGRvd24gICAgID0gaXJxX3NodXRkb3duX25vbmUsCisgICAgLmVuYWJsZSAgICAg
ICA9IGlycV9lbmFibGVfbm9uZSwKKyAgICAuZGlzYWJsZSAgICAgID0gaXJxX2Rpc2FibGVfbm9u
ZSwKKyAgICAuYWNrICAgICAgICAgID0gYWNrX25vbm1hc2thYmxlX21zaV9pcnEsCisgICAgLmVu
ZCAgICAgICAgICA9IGVuZF9ub25tYXNrYWJsZV9tc2lfaXJxLAorICAgIC5zZXRfYWZmaW5pdHkg
PSBzZXRfeDJhcGljX2FmZmluaXR5LAorfTsKKwogc3RhdGljIHZvaWQgcGFyc2VfZXZlbnRfbG9n
X2VudHJ5KHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11LCB1MzIgZW50cnlbXSkKIHsKICAgICB1MTYg
ZG9tYWluX2lkLCBkZXZpY2VfaWQsIGZsYWdzOwpAQCAtNzI2LDggKzc2NCw2IEBAIHN0YXRpYyB2
b2lkIGlvbW11X2ludGVycnVwdF9oYW5kbGVyKGludAogc3RhdGljIGJvb2xfdCBfX2luaXQgc2V0
X2lvbW11X2ludGVycnVwdF9oYW5kbGVyKHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11KQogewogICAg
IGludCBpcnEsIHJldDsKLSAgICBod19pcnFfY29udHJvbGxlciAqaGFuZGxlcjsKLSAgICB1MTYg
Y29udHJvbDsKIAogICAgIGlycSA9IGNyZWF0ZV9pcnEoTlVNQV9OT19OT0RFKTsKICAgICBpZiAo
IGlycSA8PSAwICkKQEAgLTc0NywyMCArNzgzLDQzIEBAIHN0YXRpYyBib29sX3QgX19pbml0IHNl
dF9pb21tdV9pbnRlcnJ1cHQKICAgICAgICAgICAgICAgICAgICAgICAgIFBDSV9TTE9UKGlvbW11
LT5iZGYpLCBQQ0lfRlVOQyhpb21tdS0+YmRmKSk7CiAgICAgICAgIHJldHVybiAwOwogICAgIH0K
LSAgICBjb250cm9sID0gcGNpX2NvbmZfcmVhZDE2KGlvbW11LT5zZWcsIFBDSV9CVVMoaW9tbXUt
PmJkZiksCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQQ0lfU0xPVChpb21tdS0+YmRm
KSwgUENJX0ZVTkMoaW9tbXUtPmJkZiksCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBp
b21tdS0+bXNpLm1zaV9hdHRyaWIucG9zICsgUENJX01TSV9GTEFHUyk7Ci0gICAgaW9tbXUtPm1z
aS5tc2kubnZlYyA9IDE7Ci0gICAgaWYgKCBpc19tYXNrX2JpdF9zdXBwb3J0KGNvbnRyb2wpICkK
LSAgICB7Ci0gICAgICAgIGlvbW11LT5tc2kubXNpX2F0dHJpYi5tYXNrYml0ID0gMTsKLSAgICAg
ICAgaW9tbXUtPm1zaS5tc2kubXBvcyA9IG1zaV9tYXNrX2JpdHNfcmVnKGlvbW11LT5tc2kubXNp
X2F0dHJpYi5wb3MsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBpc182NGJpdF9hZGRyZXNzKGNvbnRyb2wpKTsKLSAgICAgICAgaGFuZGxlciA9ICZpb21t
dV9tYXNrYWJsZV9tc2lfdHlwZTsKKworICAgIGlmICggaW9tbXUtPmN0cmwuaW50X2NhcF94dF9l
biApCisgICAgeworICAgICAgICBzdHJ1Y3QgaXJxX2Rlc2MgKmRlc2MgPSBpcnFfdG9fZGVzYyhp
cnEpOworCisgICAgICAgIGlvbW11LT5tc2kubXNpX2F0dHJpYi5wb3MgPSBNU0lfVFlQRV9JT01N
VTsKKyAgICAgICAgaW9tbXUtPm1zaS5tc2lfYXR0cmliLm1hc2tiaXQgPSAwOworICAgICAgICBp
b21tdS0+bXNpLm1zaV9hdHRyaWIuaXNfNjQgPSAxOworCisgICAgICAgIGRlc2MtPm1zaV9kZXNj
ID0gJmlvbW11LT5tc2k7CisgICAgICAgIGRlc2MtPmhhbmRsZXIgPSAmaW9tbXVfeDJhcGljX3R5
cGU7CisKKyAgICAgICAgcmV0ID0gMDsKICAgICB9CiAgICAgZWxzZQotICAgICAgICBoYW5kbGVy
ID0gJmlvbW11X21zaV90eXBlOwotICAgIHJldCA9IF9fc2V0dXBfbXNpX2lycShpcnFfdG9fZGVz
YyhpcnEpLCAmaW9tbXUtPm1zaSwgaGFuZGxlcik7CisgICAgeworICAgICAgICBod19pcnFfY29u
dHJvbGxlciAqaGFuZGxlcjsKKyAgICAgICAgdTE2IGNvbnRyb2w7CisKKyAgICAgICAgY29udHJv
bCA9IHBjaV9jb25mX3JlYWQxNihpb21tdS0+c2VnLCBQQ0lfQlVTKGlvbW11LT5iZGYpLAorICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBDSV9TTE9UKGlvbW11LT5iZGYpLCBQQ0lf
RlVOQyhpb21tdS0+YmRmKSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpb21t
dS0+bXNpLm1zaV9hdHRyaWIucG9zICsgUENJX01TSV9GTEFHUyk7CisKKyAgICAgICAgaW9tbXUt
Pm1zaS5tc2kubnZlYyA9IDE7CisgICAgICAgIGlmICggaXNfbWFza19iaXRfc3VwcG9ydChjb250
cm9sKSApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlvbW11LT5tc2kubXNpX2F0dHJpYi5tYXNr
Yml0ID0gMTsKKyAgICAgICAgICAgIGlvbW11LT5tc2kubXNpLm1wb3MgPSBtc2lfbWFza19iaXRz
X3JlZyhpb21tdS0+bXNpLm1zaV9hdHRyaWIucG9zLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzXzY0Yml0X2FkZHJlc3MoY29udHJvbCkpOwor
ICAgICAgICAgICAgaGFuZGxlciA9ICZpb21tdV9tYXNrYWJsZV9tc2lfdHlwZTsKKyAgICAgICAg
fQorICAgICAgICBlbHNlCisgICAgICAgICAgICBoYW5kbGVyID0gJmlvbW11X21zaV90eXBlOwor
CisgICAgICAgIHJldCA9IF9fc2V0dXBfbXNpX2lycShpcnFfdG9fZGVzYyhpcnEpLCAmaW9tbXUt
Pm1zaSwgaGFuZGxlcik7CisgICAgfQorCiAgICAgaWYgKCAhcmV0ICkKICAgICAgICAgcmV0ID0g
cmVxdWVzdF9pcnEoaXJxLCAwLCBpb21tdV9pbnRlcnJ1cHRfaGFuZGxlciwgImFtZF9pb21tdSIs
IGlvbW11KTsKICAgICBpZiAoIHJldCApCkBAIC04MzgsOCArODk3LDE5IEBAIHN0YXRpYyB2b2lk
IGVuYWJsZV9pb21tdShzdHJ1Y3QgYW1kX2lvbW0KICAgICAgICAgc3RydWN0IGlycV9kZXNjICpk
ZXNjID0gaXJxX3RvX2Rlc2MoaW9tbXUtPm1zaS5pcnEpOwogCiAgICAgICAgIHNwaW5fbG9jaygm
ZGVzYy0+bG9jayk7Ci0gICAgICAgIHNldF9tc2lfYWZmaW5pdHkoZGVzYywgJmNwdV9vbmxpbmVf
bWFwKTsKLSAgICAgICAgc3Bpbl91bmxvY2soJmRlc2MtPmxvY2spOworCisgICAgICAgIGlmICgg
aW9tbXUtPmN0cmwuaW50X2NhcF94dF9lbiApCisgICAgICAgIHsKKyAgICAgICAgICAgIHNldF94
MmFwaWNfYWZmaW5pdHkoZGVzYywgJmNwdV9vbmxpbmVfbWFwKTsKKyAgICAgICAgICAgIHNwaW5f
dW5sb2NrKCZkZXNjLT5sb2NrKTsKKyAgICAgICAgfQorICAgICAgICBlbHNlCisgICAgICAgIHsK
KyAgICAgICAgICAgIHNldF9tc2lfYWZmaW5pdHkoZGVzYywgJmNwdV9vbmxpbmVfbWFwKTsKKyAg
ICAgICAgICAgIHNwaW5fdW5sb2NrKCZkZXNjLT5sb2NrKTsKKworICAgICAgICAgICAgYW1kX2lv
bW11X21zaV9lbmFibGUoaW9tbXUsIElPTU1VX0NPTlRST0xfRU5BQkxFRCk7CisgICAgICAgIH0K
ICAgICB9CiAKICAgICBhbWRfaW9tbXVfbXNpX2VuYWJsZShpb21tdSwgSU9NTVVfQ09OVFJPTF9F
TkFCTEVEKTsKQEAgLTg3OSw3ICs5NDksOSBAQCBzdGF0aWMgdm9pZCBkaXNhYmxlX2lvbW11KHN0
cnVjdCBhbWRfaW9tCiAgICAgICAgIHJldHVybjsKICAgICB9CiAKLSAgICBhbWRfaW9tbXVfbXNp
X2VuYWJsZShpb21tdSwgSU9NTVVfQ09OVFJPTF9ESVNBQkxFRCk7CisgICAgaWYgKCAhaW9tbXUt
PmN0cmwuaW50X2NhcF94dF9lbiApCisgICAgICAgIGFtZF9pb21tdV9tc2lfZW5hYmxlKGlvbW11
LCBJT01NVV9DT05UUk9MX0RJU0FCTEVEKTsKKwogICAgIHNldF9pb21tdV9jb21tYW5kX2J1ZmZl
cl9jb250cm9sKGlvbW11LCBJT01NVV9DT05UUk9MX0RJU0FCTEVEKTsKICAgICBzZXRfaW9tbXVf
ZXZlbnRfbG9nX2NvbnRyb2woaW9tbXUsIElPTU1VX0NPTlRST0xfRElTQUJMRUQpOwogCi0tLSBh
L3hlbi9pbmNsdWRlL2FzbS14ODYvaHZtL3N2bS9hbWQtaW9tbXUtZGVmcy5oCisrKyBiL3hlbi9p
bmNsdWRlL2FzbS14ODYvaHZtL3N2bS9hbWQtaW9tbXUtZGVmcy5oCkBAIC00MTUsNiArNDE1LDI1
IEBAIHVuaW9uIGFtZF9pb21tdV9leHRfZmVhdHVyZXMgewogICAgIH0gZmxkczsKIH07CiAKKy8q
IHgyQVBJQyBDb250cm9sIFJlZ2lzdGVycyAqLworI2RlZmluZSBJT01NVV9YVF9JTlRfQ1RSTF9N
TUlPX09GRlNFVAkJMHgwMTcwCisjZGVmaW5lIElPTU1VX1hUX1BQUl9JTlRfQ1RSTF9NTUlPX09G
RlNFVAkweDAxNzgKKyNkZWZpbmUgSU9NTVVfWFRfR0FfSU5UX0NUUkxfTU1JT19PRkZTRVQJMHgw
MTgwCisKK3VuaW9uIGFtZF9pb21tdV94MmFwaWNfY29udHJvbCB7CisgICAgdWludDY0X3QgcmF3
OworICAgIHN0cnVjdCB7CisgICAgICAgIHVuc2lnbmVkIGludCA6MjsKKyAgICAgICAgdW5zaWdu
ZWQgaW50IGRlc3RfbW9kZToxOworICAgICAgICB1bnNpZ25lZCBpbnQgOjU7CisgICAgICAgIHVu
c2lnbmVkIGludCBkZXN0X2xvOjI0OworICAgICAgICB1bnNpZ25lZCBpbnQgdmVjdG9yOjg7Cisg
ICAgICAgIHVuc2lnbmVkIGludCBpbnRfdHlwZToxOyAvKiBETSBpbiBJT01NVSBzcGVjIDMuMDQg
Ki8KKyAgICAgICAgdW5zaWduZWQgaW50IDoxNTsKKyAgICAgICAgdW5zaWduZWQgaW50IGRlc3Rf
aGk6ODsKKyAgICB9OworfTsKKwogLyogU3RhdHVzIFJlZ2lzdGVyKi8KICNkZWZpbmUgSU9NTVVf
U1RBVFVTX01NSU9fT0ZGU0VUCQkweDIwMjAKICNkZWZpbmUgSU9NTVVfU1RBVFVTX0VWRU5UX09W
RVJGTE9XX01BU0sJMHgwMDAwMDAwMQoKCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMu
eGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL3hlbi1kZXZlbA==

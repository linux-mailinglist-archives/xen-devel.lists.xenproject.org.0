Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 6A338B7A63
	for <lists+xen-devel@lfdr.de>; Thu, 19 Sep 2019 15:25:10 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iAwP0-0007zg-Ih; Thu, 19 Sep 2019 13:23:18 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=5hYN=XO=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1iAwOz-0007zE-4s
 for xen-devel@lists.xenproject.org; Thu, 19 Sep 2019 13:23:17 +0000
X-Inumbo-ID: a2f78e80-dae0-11e9-978d-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id a2f78e80-dae0-11e9-978d-bc764e2007e4;
 Thu, 19 Sep 2019 13:23:15 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 16B0FAFB1;
 Thu, 19 Sep 2019 13:23:15 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <aa62726c-5aa4-8bcd-dc35-61eb8dfeaee3@suse.com>
Message-ID: <e8359b69-1e7c-6b3d-a7ce-7a7974dd0ac3@suse.com>
Date: Thu, 19 Sep 2019 15:23:23 +0200
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
 Thunderbird/60.9.0
MIME-Version: 1.0
In-Reply-To: <aa62726c-5aa4-8bcd-dc35-61eb8dfeaee3@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v6 4/8] AMD/IOMMU: replace INTREMAP_ENTRIES
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

UHJlcGFyZSBmb3IgdGhlIG51bWJlciBvZiBlbnRyaWVzIHRvIG5vdCBiZSB0aGUgbWF4aW11bSBw
b3NzaWJsZSwgYnkKc2VwYXJhdGluZyBjaGVja3MgYWdhaW5zdCBtYXhpbXVtIHNpemUgZnJvbSBv
bmVzIGFnYWluc3QgYWN0dWFsIHNpemUuCkZvciBjYWxsZXIgc2lkZSBzaW1wbGljaXR5IGhhdmUg
YWxsb2NfaW50cmVtYXBfZW50cnkoKSByZXR1cm4gdGhlCm1heGltdW0gcG9zc2libGUgdmFsdWUg
dXBvbiBhbGxvY2F0aW9uIGZhaWx1cmUsIHJhdGhlciB0aGFuIHRoZSBmaXJzdApqdXN0IG91dC1v
Zi1ib3VuZHMgb25lLgoKSGF2ZSB0aGUgaW52b2x2ZWQgZnVuY3Rpb25zIGFscmVhZHkgdGFrZSBh
bGwgdGhlIHN1YnNlcXVlbnRseSBuZWVkZWQKYXJndW1lbnRzIGhlcmUgYWxyZWFkeSwgdG8gcmVk
dWNlIGNvZGUgY2h1cm4gaW4gdGhlIHBhdGNoIGFjdHVhbGx5Cm1ha2luZyB0aGUgYWxsb2NhdGlv
biBzaXplIGR5bmFtaWMuCgpTaWduZWQtb2ZmLWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3Vz
ZS5jb20+CkFja2VkLWJ5OiBBbmRyZXcgQ29vcGVyIDxhbmRyZXcuY29vcGVyM0BjaXRyaXguY29t
PgotLS0KdjU6IE5ldy4KCi0tLQogeGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL2lvbW11X2lu
dHIuYyAgICAgIHwgICA5MyArKysrKysrKysrKysrKystLS0tLS0tLS0tLQogeGVuL2luY2x1ZGUv
YXNtLXg4Ni9odm0vc3ZtL2FtZC1pb21tdS1wcm90by5oIHwgICAgMiAKIDIgZmlsZXMgY2hhbmdl
ZCwgNTkgaW5zZXJ0aW9ucygrKSwgMzYgZGVsZXRpb25zKC0pCgotLS0gYS94ZW4vZHJpdmVycy9w
YXNzdGhyb3VnaC9hbWQvaW9tbXVfaW50ci5jCisrKyBiL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdo
L2FtZC9pb21tdV9pbnRyLmMKQEAgLTY5LDcgKzY5LDcgQEAgdW5pb24gaXJ0ZV9jcHRyIHsKICAg
ICBjb25zdCB1bmlvbiBpcnRlMTI4ICpwdHIxMjg7CiB9IF9fdHJhbnNwYXJlbnRfXzsKIAotI2Rl
ZmluZSBJTlRSRU1BUF9FTlRSSUVTICgxIDw8IElPTU1VX0lOVFJFTUFQX09SREVSKQorI2RlZmlu
ZSBJTlRSRU1BUF9NQVhfRU5UUklFUyAoMSA8PCBJT01NVV9JTlRSRU1BUF9PUkRFUikKIAogc3Ry
dWN0IGlvYXBpY19zYmRmIGlvYXBpY19zYmRmW01BWF9JT19BUElDU107CiBzdHJ1Y3QgaHBldF9z
YmRmIGhwZXRfc2JkZjsKQEAgLTgzLDggKzgzLDIwIEBAIHN0YXRpYyB2b2lkIGR1bXBfaW50cmVt
YXBfdGFibGVzKHVuc2lnbmUKIHN0YXRpYyB1bnNpZ25lZCBpbnQgX19pbml0IGludHJlbWFwX3Rh
YmxlX29yZGVyKGNvbnN0IHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11KQogewogICAgIHJldHVybiBp
b21tdS0+Y3RybC5nYV9lbgotICAgICAgICAgICA/IGdldF9vcmRlcl9mcm9tX2J5dGVzKElOVFJF
TUFQX0VOVFJJRVMgKiBzaXplb2YodW5pb24gaXJ0ZTEyOCkpCi0gICAgICAgICAgIDogZ2V0X29y
ZGVyX2Zyb21fYnl0ZXMoSU5UUkVNQVBfRU5UUklFUyAqIHNpemVvZih1bmlvbiBpcnRlMzIpKTsK
KyAgICAgICAgICAgPyBnZXRfb3JkZXJfZnJvbV9ieXRlcyhJTlRSRU1BUF9NQVhfRU5UUklFUyAq
IHNpemVvZih1bmlvbiBpcnRlMTI4KSkKKyAgICAgICAgICAgOiBnZXRfb3JkZXJfZnJvbV9ieXRl
cyhJTlRSRU1BUF9NQVhfRU5UUklFUyAqIHNpemVvZih1bmlvbiBpcnRlMzIpKTsKK30KKwordW5z
aWduZWQgaW50IGFtZF9pb21tdV9pbnRyZW1hcF90YWJsZV9vcmRlcigKKyAgICBjb25zdCB2b2lk
ICppcnQsIGNvbnN0IHN0cnVjdCBhbWRfaW9tbXUgKmlvbW11KQoreworICAgIHJldHVybiBJT01N
VV9JTlRSRU1BUF9PUkRFUjsKK30KKworc3RhdGljIHVuc2lnbmVkIGludCBpbnRyZW1hcF90YWJs
ZV9lbnRyaWVzKAorICAgIGNvbnN0IHZvaWQgKmlydCwgY29uc3Qgc3RydWN0IGFtZF9pb21tdSAq
aW9tbXUpCit7CisgICAgcmV0dXJuIDF1IDw8IGFtZF9pb21tdV9pbnRyZW1hcF90YWJsZV9vcmRl
cihpcnQsIGlvbW11KTsKIH0KIAogdW5zaWduZWQgaW50IGlvYXBpY19pZF90b19pbmRleCh1bnNp
Z25lZCBpbnQgYXBpY19pZCkKQEAgLTEyMiwyMCArMTM0LDI0IEBAIHN0YXRpYyBpbnQgZ2V0X2lu
dHJlbWFwX3JlcXVlc3Rvcl9pZChpbnQKICAgICByZXR1cm4gZ2V0X2l2cnNfbWFwcGluZ3Moc2Vn
KVtiZGZdLmR0ZV9yZXF1ZXN0b3JfaWQ7CiB9CiAKLXN0YXRpYyB1bnNpZ25lZCBpbnQgYWxsb2Nf
aW50cmVtYXBfZW50cnkoaW50IHNlZywgaW50IGJkZiwgdW5zaWduZWQgaW50IG5yKQorc3RhdGlj
IHVuc2lnbmVkIGludCBhbGxvY19pbnRyZW1hcF9lbnRyeShjb25zdCBzdHJ1Y3QgYW1kX2lvbW11
ICppb21tdSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWdu
ZWQgaW50IGJkZiwgdW5zaWduZWQgaW50IG5yKQogewotICAgIHVuc2lnbmVkIGxvbmcgKmludXNl
ID0gZ2V0X2l2cnNfbWFwcGluZ3Moc2VnKVtiZGZdLmludHJlbWFwX2ludXNlOwotICAgIHVuc2ln
bmVkIGludCBzbG90ID0gZmluZF9maXJzdF96ZXJvX2JpdChpbnVzZSwgSU5UUkVNQVBfRU5UUklF
Uyk7CisgICAgY29uc3Qgc3RydWN0IGl2cnNfbWFwcGluZ3MgKml2cnNfbWFwcGluZ3MgPSBnZXRf
aXZyc19tYXBwaW5ncyhpb21tdS0+c2VnKTsKKyAgICB1bnNpZ25lZCBsb25nICppbnVzZSA9IGl2
cnNfbWFwcGluZ3NbYmRmXS5pbnRyZW1hcF9pbnVzZTsKKyAgICB1bnNpZ25lZCBpbnQgbnJfZW50
cyA9CisgICAgICAgIGludHJlbWFwX3RhYmxlX2VudHJpZXMoaXZyc19tYXBwaW5nc1tiZGZdLmlu
dHJlbWFwX3RhYmxlLCBpb21tdSk7CisgICAgdW5zaWduZWQgaW50IHNsb3QgPSBmaW5kX2ZpcnN0
X3plcm9fYml0KGludXNlLCBucl9lbnRzKTsKIAogICAgIGZvciAoIDsgOyApCiAgICAgewogICAg
ICAgICB1bnNpZ25lZCBpbnQgZW5kOwogCi0gICAgICAgIGlmICggc2xvdCA+PSBJTlRSRU1BUF9F
TlRSSUVTICkKKyAgICAgICAgaWYgKCBzbG90ID49IG5yX2VudHMgKQogICAgICAgICAgICAgYnJl
YWs7Ci0gICAgICAgIGVuZCA9IGZpbmRfbmV4dF9iaXQoaW51c2UsIElOVFJFTUFQX0VOVFJJRVMs
IHNsb3QgKyAxKTsKLSAgICAgICAgaWYgKCBlbmQgPiBJTlRSRU1BUF9FTlRSSUVTICkKLSAgICAg
ICAgICAgIGVuZCA9IElOVFJFTUFQX0VOVFJJRVM7CisgICAgICAgIGVuZCA9IGZpbmRfbmV4dF9i
aXQoaW51c2UsIG5yX2VudHMsIHNsb3QgKyAxKTsKKyAgICAgICAgaWYgKCBlbmQgPiBucl9lbnRz
ICkKKyAgICAgICAgICAgIGVuZCA9IG5yX2VudHM7CiAgICAgICAgIHNsb3QgPSAoc2xvdCArIG5y
IC0gMSkgJiB+KG5yIC0gMSk7CiAgICAgICAgIGlmICggc2xvdCArIG5yIDw9IGVuZCApCiAgICAg
ICAgIHsKQEAgLTE0NCwxMiArMTYwLDEyIEBAIHN0YXRpYyB1bnNpZ25lZCBpbnQgYWxsb2NfaW50
cmVtYXBfZW50cnkKICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICB9CiAgICAgICAgIHNsb3Qg
PSAoZW5kICsgbnIpICYgfihuciAtIDEpOwotICAgICAgICBpZiAoIHNsb3QgPj0gSU5UUkVNQVBf
RU5UUklFUyApCisgICAgICAgIGlmICggc2xvdCA+PSBucl9lbnRzICkKICAgICAgICAgICAgIGJy
ZWFrOwotICAgICAgICBzbG90ID0gZmluZF9uZXh0X3plcm9fYml0KGludXNlLCBJTlRSRU1BUF9F
TlRSSUVTLCBzbG90KTsKKyAgICAgICAgc2xvdCA9IGZpbmRfbmV4dF96ZXJvX2JpdChpbnVzZSwg
bnJfZW50cywgc2xvdCk7CiAgICAgfQogCi0gICAgcmV0dXJuIHNsb3Q7CisgICAgcmV0dXJuIHNs
b3QgPCBucl9lbnRzID8gc2xvdCA6IElOVFJFTUFQX01BWF9FTlRSSUVTOwogfQogCiBzdGF0aWMg
dW5pb24gaXJ0ZV9wdHIgZ2V0X2ludHJlbWFwX2VudHJ5KGNvbnN0IHN0cnVjdCBhbWRfaW9tbXUg
KmlvbW11LApAQCAtMTU5LDcgKzE3NSw3IEBAIHN0YXRpYyB1bmlvbiBpcnRlX3B0ciBnZXRfaW50
cmVtYXBfZW50cnkKICAgICAgICAgLnB0ciA9IGdldF9pdnJzX21hcHBpbmdzKGlvbW11LT5zZWcp
W2JkZl0uaW50cmVtYXBfdGFibGUKICAgICB9OwogCi0gICAgQVNTRVJUKHRhYmxlLnB0ciAmJiAo
aW5kZXggPCBJTlRSRU1BUF9FTlRSSUVTKSk7CisgICAgQVNTRVJUKHRhYmxlLnB0ciAmJiAoaW5k
ZXggPCBpbnRyZW1hcF90YWJsZV9lbnRyaWVzKHRhYmxlLnB0ciwgaW9tbXUpKSk7CiAKICAgICBp
ZiAoIGlvbW11LT5jdHJsLmdhX2VuICkKICAgICAgICAgdGFibGUucHRyMTI4ICs9IGluZGV4OwpA
QCAtMjc5LDEwICsyOTUsMTAgQEAgc3RhdGljIGludCB1cGRhdGVfaW50cmVtYXBfZW50cnlfZnJv
bV9pbwogICAgIHNwaW5fbG9ja19pcnFzYXZlKGxvY2ssIGZsYWdzKTsKIAogICAgIG9mZnNldCA9
ICppbmRleDsKLSAgICBpZiAoIG9mZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVTICkKKyAgICBpZiAo
IG9mZnNldCA+PSBJTlRSRU1BUF9NQVhfRU5UUklFUyApCiAgICAgewotICAgICAgICBvZmZzZXQg
PSBhbGxvY19pbnRyZW1hcF9lbnRyeShpb21tdS0+c2VnLCByZXFfaWQsIDEpOwotICAgICAgICBp
ZiAoIG9mZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVTICkKKyAgICAgICAgb2Zmc2V0ID0gYWxsb2Nf
aW50cmVtYXBfZW50cnkoaW9tbXUsIHJlcV9pZCwgMSk7CisgICAgICAgIGlmICggb2Zmc2V0ID49
IElOVFJFTUFQX01BWF9FTlRSSUVTICkKICAgICAgICAgewogICAgICAgICAgICAgc3Bpbl91bmxv
Y2tfaXJxcmVzdG9yZShsb2NrLCBmbGFncyk7CiAgICAgICAgICAgICBydGUtPm1hc2sgPSAxOwpA
QCAtNDAwLDggKzQxNiw4IEBAIGludCBfX2luaXQgYW1kX2lvbW11X3NldHVwX2lvYXBpY19yZW1h
cHAKICAgICAgICAgICAgIH0KIAogICAgICAgICAgICAgc3Bpbl9sb2NrX2lycXNhdmUobG9jaywg
ZmxhZ3MpOwotICAgICAgICAgICAgb2Zmc2V0ID0gYWxsb2NfaW50cmVtYXBfZW50cnkoc2VnLCBy
ZXFfaWQsIDEpOwotICAgICAgICAgICAgQlVHX09OKG9mZnNldCA+PSBJTlRSRU1BUF9FTlRSSUVT
KTsKKyAgICAgICAgICAgIG9mZnNldCA9IGFsbG9jX2ludHJlbWFwX2VudHJ5KGlvbW11LCByZXFf
aWQsIDEpOworICAgICAgICAgICAgQlVHX09OKG9mZnNldCA+PSBJTlRSRU1BUF9NQVhfRU5UUklF
Uyk7CiAgICAgICAgICAgICBlbnRyeSA9IGdldF9pbnRyZW1hcF9lbnRyeShpb21tdSwgcmVxX2lk
LCBvZmZzZXQpOwogICAgICAgICAgICAgdXBkYXRlX2ludHJlbWFwX2VudHJ5KGlvbW11LCBlbnRy
eSwgdmVjdG9yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGl2ZXJ5X21v
ZGUsIGRlc3RfbW9kZSwgZGVzdCk7CkBAIC00NzYsNyArNDkyLDcgQEAgdm9pZCBhbWRfaW9tbXVf
aW9hcGljX3VwZGF0ZV9pcmUoCiAgICAgICAgICooKCh1MzIgKikmbmV3X3J0ZSkgKyAxKSA9IHZh
bHVlOwogICAgIH0KIAotICAgIGlmICggaW9hcGljX3NiZGZbaWR4XS5waW5fMl9pZHhbcGluXSA+
PSBJTlRSRU1BUF9FTlRSSUVTICkKKyAgICBpZiAoIGlvYXBpY19zYmRmW2lkeF0ucGluXzJfaWR4
W3Bpbl0gPj0gSU5UUkVNQVBfTUFYX0VOVFJJRVMgKQogICAgIHsKICAgICAgICAgQVNTRVJUKHNh
dmVkX21hc2spOwogCkBAIC01NDgsNyArNTY0LDcgQEAgdW5zaWduZWQgaW50IGFtZF9pb21tdV9y
ZWFkX2lvYXBpY19mcm9tXwogICAgICAgICByZXR1cm4gdmFsOwogCiAgICAgb2Zmc2V0ID0gaW9h
cGljX3NiZGZbaWR4XS5waW5fMl9pZHhbcGluXTsKLSAgICBpZiAoIG9mZnNldCA+PSBJTlRSRU1B
UF9FTlRSSUVTICkKKyAgICBpZiAoIG9mZnNldCA+PSBJTlRSRU1BUF9NQVhfRU5UUklFUyApCiAg
ICAgICAgIHJldHVybiB2YWw7CiAKICAgICBzZWcgPSBpb2FwaWNfc2JkZltpZHhdLnNlZzsKQEAg
LTU2MSw4ICs1NzcsOCBAQCB1bnNpZ25lZCBpbnQgYW1kX2lvbW11X3JlYWRfaW9hcGljX2Zyb21f
CiAKICAgICBpZiAoICEocmVnICYgMSkgKQogICAgIHsKLSAgICAgICAgQVNTRVJUKG9mZnNldCA9
PSAodmFsICYgKElOVFJFTUFQX0VOVFJJRVMgLSAxKSkpOwotICAgICAgICB2YWwgJj0gfihJTlRS
RU1BUF9FTlRSSUVTIC0gMSk7CisgICAgICAgIEFTU0VSVChvZmZzZXQgPT0gKHZhbCAmIChJTlRS
RU1BUF9NQVhfRU5UUklFUyAtIDEpKSk7CisgICAgICAgIHZhbCAmPSB+KElOVFJFTUFQX01BWF9F
TlRSSUVTIC0gMSk7CiAgICAgICAgIC8qIFRoZSBJbnRUeXBlIGZpZWxkcyBtYXRjaCBmb3IgYm90
aCBmb3JtYXRzLiAqLwogICAgICAgICB2YWwgfD0gTUFTS19JTlNSKGVudHJ5LnB0cjMyLT5mbGRz
LmludF90eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgIElPX0FQSUNfUkVESVJfREVMSVZf
TU9ERV9NQVNLKTsKQEAgLTYyMiwxMSArNjM4LDExIEBAIHN0YXRpYyBpbnQgdXBkYXRlX2ludHJl
bWFwX2VudHJ5X2Zyb21fbXMKICAgICAgICAgZGVzdCA9IE1BU0tfRVhUUihtc2ctPmFkZHJlc3Nf
bG8sIE1TSV9BRERSX0RFU1RfSURfTUFTSyk7CiAKICAgICBvZmZzZXQgPSAqcmVtYXBfaW5kZXg7
Ci0gICAgaWYgKCBvZmZzZXQgPj0gSU5UUkVNQVBfRU5UUklFUyApCisgICAgaWYgKCBvZmZzZXQg
Pj0gSU5UUkVNQVBfTUFYX0VOVFJJRVMgKQogICAgIHsKICAgICAgICAgQVNTRVJUKG5yKTsKLSAg
ICAgICAgb2Zmc2V0ID0gYWxsb2NfaW50cmVtYXBfZW50cnkoaW9tbXUtPnNlZywgYmRmLCBucik7
Ci0gICAgICAgIGlmICggb2Zmc2V0ID49IElOVFJFTUFQX0VOVFJJRVMgKQorICAgICAgICBvZmZz
ZXQgPSBhbGxvY19pbnRyZW1hcF9lbnRyeShpb21tdSwgYmRmLCBucik7CisgICAgICAgIGlmICgg
b2Zmc2V0ID49IElOVFJFTUFQX01BWF9FTlRSSUVTICkKICAgICAgICAgewogICAgICAgICAgICAg
c3Bpbl91bmxvY2tfaXJxcmVzdG9yZShsb2NrLCBmbGFncyk7CiAgICAgICAgICAgICByZXR1cm4g
LUVOT1NQQzsKQEAgLTY1NCw3ICs2NzAsNyBAQCBzdGF0aWMgaW50IHVwZGF0ZV9pbnRyZW1hcF9l
bnRyeV9mcm9tX21zCiAgICAgdXBkYXRlX2ludHJlbWFwX2VudHJ5KGlvbW11LCBlbnRyeSwgdmVj
dG9yLCBkZWxpdmVyeV9tb2RlLCBkZXN0X21vZGUsIGRlc3QpOwogICAgIHNwaW5fdW5sb2NrX2ly
cXJlc3RvcmUobG9jaywgZmxhZ3MpOwogCi0gICAgKmRhdGEgPSAobXNnLT5kYXRhICYgfihJTlRS
RU1BUF9FTlRSSUVTIC0gMSkpIHwgb2Zmc2V0OworICAgICpkYXRhID0gKG1zZy0+ZGF0YSAmIH4o
SU5UUkVNQVBfTUFYX0VOVFJJRVMgLSAxKSkgfCBvZmZzZXQ7CiAKICAgICAvKgogICAgICAqIElu
IHNvbWUgc3BlY2lhbCBjYXNlcywgYSBwY2ktZSBkZXZpY2UoZS5nIFNBVEEgY29udHJvbGxlciBp
biBJREUgbW9kZSkKQEAgLTczOCw3ICs3NTQsNyBAQCBpbnQgYW1kX2lvbW11X21zaV9tc2dfdXBk
YXRlX2lyZSgKIHZvaWQgYW1kX2lvbW11X3JlYWRfbXNpX2Zyb21faXJlKAogICAgIHN0cnVjdCBt
c2lfZGVzYyAqbXNpX2Rlc2MsIHN0cnVjdCBtc2lfbXNnICptc2cpCiB7Ci0gICAgdW5zaWduZWQg
aW50IG9mZnNldCA9IG1zZy0+ZGF0YSAmIChJTlRSRU1BUF9FTlRSSUVTIC0gMSk7CisgICAgdW5z
aWduZWQgaW50IG9mZnNldCA9IG1zZy0+ZGF0YSAmIChJTlRSRU1BUF9NQVhfRU5UUklFUyAtIDEp
OwogICAgIGNvbnN0IHN0cnVjdCBwY2lfZGV2ICpwZGV2ID0gbXNpX2Rlc2MtPmRldjsKICAgICB1
MTYgYmRmID0gcGRldiA/IFBDSV9CREYyKHBkZXYtPmJ1cywgcGRldi0+ZGV2Zm4pIDogaHBldF9z
YmRmLmJkZjsKICAgICB1MTYgc2VnID0gcGRldiA/IHBkZXYtPnNlZyA6IGhwZXRfc2JkZi5zZWc7
CkBAIC03NTgsNyArNzc0LDcgQEAgdm9pZCBhbWRfaW9tbXVfcmVhZF9tc2lfZnJvbV9pcmUoCiAg
ICAgICAgIG9mZnNldCB8PSBucjsKICAgICB9CiAKLSAgICBtc2ctPmRhdGEgJj0gfihJTlRSRU1B
UF9FTlRSSUVTIC0gMSk7CisgICAgbXNnLT5kYXRhICY9IH4oSU5UUkVNQVBfTUFYX0VOVFJJRVMg
LSAxKTsKICAgICAvKiBUaGUgSW50VHlwZSBmaWVsZHMgbWF0Y2ggZm9yIGJvdGggZm9ybWF0cy4g
Ki8KICAgICBtc2ctPmRhdGEgfD0gTUFTS19JTlNSKGVudHJ5LnB0cjMyLT5mbGRzLmludF90eXBl
LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTVNJX0RBVEFfREVMSVZFUllfTU9ERV9NQVNL
KTsKQEAgLTgyNCw4ICs4NDAsOSBAQCB2b2lkICphbWRfaW9tbXVfYWxsb2NfaW50cmVtYXBfdGFi
bGUoCiAKICAgICBpZiAoIHRiICkKICAgICB7Ci0gICAgICAgICppbnVzZV9tYXAgPSB4emFsbG9j
X2FycmF5KHVuc2lnbmVkIGxvbmcsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IEJJVFNfVE9fTE9OR1MoSU5UUkVNQVBfRU5UUklFUykpOworICAgICAgICB1bnNpZ25lZCBpbnQg
bnIgPSBpbnRyZW1hcF90YWJsZV9lbnRyaWVzKHRiLCBpb21tdSk7CisKKyAgICAgICAgKmludXNl
X21hcCA9IHh6YWxsb2NfYXJyYXkodW5zaWduZWQgbG9uZywgQklUU19UT19MT05HUyhucikpOwog
ICAgICAgICBpZiAoICppbnVzZV9tYXAgKQogICAgICAgICAgICAgbWVtc2V0KHRiLCAwLCBQQUdF
X1NJWkUgPDwgb3JkZXIpOwogICAgICAgICBlbHNlCkBAIC04NjksNiArODg2LDcgQEAgYm9vbCBf
X2luaXQgaW92X3N1cHBvcnRzX3h0KHZvaWQpCiAKIGludCBfX2luaXQgYW1kX3NldHVwX2hwZXRf
bXNpKHN0cnVjdCBtc2lfZGVzYyAqbXNpX2Rlc2MpCiB7CisgICAgY29uc3Qgc3RydWN0IGFtZF9p
b21tdSAqaW9tbXU7CiAgICAgc3BpbmxvY2tfdCAqbG9jazsKICAgICB1bnNpZ25lZCBsb25nIGZs
YWdzOwogICAgIGludCByYyA9IDA7CkBAIC04ODYsMTIgKzkwNCwxNSBAQCBpbnQgX19pbml0IGFt
ZF9zZXR1cF9ocGV0X21zaShzdHJ1Y3QgbXNpCiAgICAgICAgIHJldHVybiAtRU5PREVWOwogICAg
IH0KIAorICAgIGlvbW11ID0gZmluZF9pb21tdV9mb3JfZGV2aWNlKGhwZXRfc2JkZi5zZWcsIGhw
ZXRfc2JkZi5iZGYpOworICAgIGlmICggIWlvbW11ICkKKyAgICAgICAgcmV0dXJuIC1FTlhJTzsK
KwogICAgIGxvY2sgPSBnZXRfaW50cmVtYXBfbG9jayhocGV0X3NiZGYuc2VnLCBocGV0X3NiZGYu
YmRmKTsKICAgICBzcGluX2xvY2tfaXJxc2F2ZShsb2NrLCBmbGFncyk7CiAKLSAgICBtc2lfZGVz
Yy0+cmVtYXBfaW5kZXggPSBhbGxvY19pbnRyZW1hcF9lbnRyeShocGV0X3NiZGYuc2VnLAotICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhwZXRfc2JkZi5i
ZGYsIDEpOwotICAgIGlmICggbXNpX2Rlc2MtPnJlbWFwX2luZGV4ID49IElOVFJFTUFQX0VOVFJJ
RVMgKQorICAgIG1zaV9kZXNjLT5yZW1hcF9pbmRleCA9IGFsbG9jX2ludHJlbWFwX2VudHJ5KGlv
bW11LCBocGV0X3NiZGYuYmRmLCAxKTsKKyAgICBpZiAoIG1zaV9kZXNjLT5yZW1hcF9pbmRleCA+
PSBJTlRSRU1BUF9NQVhfRU5UUklFUyApCiAgICAgewogICAgICAgICBtc2lfZGVzYy0+cmVtYXBf
aW5kZXggPSAtMTsKICAgICAgICAgcmMgPSAtRU5YSU87CkBAIC05MDYsMTIgKzkyNywxMiBAQCBz
dGF0aWMgdm9pZCBkdW1wX2ludHJlbWFwX3RhYmxlKGNvbnN0IHN0CiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIHVuaW9uIGlydGVfY3B0ciB0YmwsCiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGNvbnN0IHN0cnVjdCBpdnJzX21hcHBpbmdzICppdnJzX21hcHBpbmcpCiB7
Ci0gICAgdW5zaWduZWQgaW50IGNvdW50OworICAgIHVuc2lnbmVkIGludCBjb3VudCwgbnIgPSBp
bnRyZW1hcF90YWJsZV9lbnRyaWVzKHRibC5wdHIsIGlvbW11KTsKIAogICAgIGlmICggIXRibC5w
dHIgKQogICAgICAgICByZXR1cm47CiAKLSAgICBmb3IgKCBjb3VudCA9IDA7IGNvdW50IDwgSU5U
UkVNQVBfRU5UUklFUzsgY291bnQrKyApCisgICAgZm9yICggY291bnQgPSAwOyBjb3VudCA8IG5y
OyBjb3VudCsrICkKICAgICB7CiAgICAgICAgIGlmICggaW9tbXUtPmN0cmwuZ2FfZW4KICAgICAg
ICAgICAgICA/ICF0YmwucHRyMTI4W2NvdW50XS5yYXdbMF0gJiYgIXRibC5wdHIxMjhbY291bnRd
LnJhd1sxXQotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9zdm0vYW1kLWlvbW11LXByb3Rv
LmgKKysrIGIveGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vc3ZtL2FtZC1pb21tdS1wcm90by5oCkBA
IC0xMDIsNiArMTAyLDggQEAgdm9pZCAqYW1kX2lvbW11X2FsbG9jX2ludHJlbWFwX3RhYmxlKAog
ICAgIGNvbnN0IHN0cnVjdCBhbWRfaW9tbXUgKiwgdW5zaWduZWQgbG9uZyAqKik7CiBpbnQgYW1k
X2lvbW11X2ZyZWVfaW50cmVtYXBfdGFibGUoCiAgICAgY29uc3Qgc3RydWN0IGFtZF9pb21tdSAq
LCBzdHJ1Y3QgaXZyc19tYXBwaW5ncyAqLCB1aW50MTZfdCk7Cit1bnNpZ25lZCBpbnQgYW1kX2lv
bW11X2ludHJlbWFwX3RhYmxlX29yZGVyKAorICAgIGNvbnN0IHZvaWQgKmlydCwgY29uc3Qgc3Ry
dWN0IGFtZF9pb21tdSAqaW9tbXUpOwogdm9pZCBhbWRfaW9tbXVfaW9hcGljX3VwZGF0ZV9pcmUo
CiAgICAgdW5zaWduZWQgaW50IGFwaWMsIHVuc2lnbmVkIGludCByZWcsIHVuc2lnbmVkIGludCB2
YWx1ZSk7CiB1bnNpZ25lZCBpbnQgYW1kX2lvbW11X3JlYWRfaW9hcGljX2Zyb21faXJlKAoKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBt
YWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMu
eGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

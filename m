Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id CD3B8178AAB
	for <lists+xen-devel@lfdr.de>; Wed,  4 Mar 2020 07:36:27 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j9Na0-0001uA-By; Wed, 04 Mar 2020 06:32:28 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Jt9l=4V=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1j9NZz-0001tt-6a
 for xen-devel@lists.xenproject.org; Wed, 04 Mar 2020 06:32:27 +0000
X-Inumbo-ID: e3d5bcb8-5de1-11ea-b52f-bc764e2007e4
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id e3d5bcb8-5de1-11ea-b52f-bc764e2007e4;
 Wed, 04 Mar 2020 06:32:16 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id 25C92AFB2;
 Wed,  4 Mar 2020 06:32:15 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Wed,  4 Mar 2020 07:32:08 +0100
Message-Id: <20200304063212.20843-3-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20200304063212.20843-1-jgross@suse.com>
References: <20200304063212.20843-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v3 2/6] xen/rcu: don't use stop_machine_run()
 for rcu_barrier()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Julien Grall <julien@xen.org>,
 Wei Liu <wl@xen.org>, Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>,
 George Dunlap <george.dunlap@citrix.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VG9kYXkgcmN1X2JhcnJpZXIoKSBpcyBjYWxsaW5nIHN0b3BfbWFjaGluZV9ydW4oKSB0byBzeW5j
aHJvbml6ZSBhbGwKcGh5c2ljYWwgY3B1cyBpbiBvcmRlciB0byBlbnN1cmUgYWxsIHBlbmRpbmcg
cmN1IGNhbGxzIGhhdmUgZmluaXNoZWQKd2hlbiByZXR1cm5pbmcuCgpBcyBzdG9wX21hY2hpbmVf
cnVuKCkgaXMgdXNpbmcgdGFza2xldHMgdGhpcyByZXF1aXJlcyBzY2hlZHVsaW5nIG9mCmlkbGUg
dmNwdXMgb24gYWxsIGNwdXMgaW1wb3NpbmcgdGhlIG5lZWQgdG8gY2FsbCByY3VfYmFycmllcigp
IG9uIGlkbGUKY3B1cyBvbmx5IGluIGNhc2Ugb2YgY29yZSBzY2hlZHVsaW5nIGJlaW5nIGFjdGl2
ZSwgYXMgb3RoZXJ3aXNlIGEKc2NoZWR1bGluZyBkZWFkbG9jayB3b3VsZCBvY2N1ci4KClRoZXJl
IGlzIG5vIG5lZWQgYXQgYWxsIHRvIGRvIHRoZSBzeW5jaW5nIG9mIHRoZSBjcHVzIGluIHRhc2ts
ZXRzLCBhcwpyY3UgYWN0aXZpdHkgaXMgc3RhcnRlZCBpbiBfX2RvX3NvZnRpcnEoKSBjYWxsZWQg
d2hlbmV2ZXIgc29mdGlycQphY3Rpdml0eSBpcyBhbGxvd2VkLiBTbyByY3VfYmFycmllcigpIGNh
biBlYXNpbHkgYmUgbW9kaWZpZWQgdG8gdXNlCnNvZnRpcnEgZm9yIHN5bmNocm9uaXphdGlvbiBv
ZiB0aGUgY3B1cyBubyBsb25nZXIgcmVxdWlyaW5nIGFueQpzY2hlZHVsaW5nIGFjdGl2aXR5LgoK
QXMgdGhlcmUgYWxyZWFkeSBpcyBhIHJjdSBzb2Z0aXJxIHJldXNlIHRoYXQgZm9yIHRoZSBzeW5j
aHJvbml6YXRpb24uCgpSZW1vdmUgdGhlIGJhcnJpZXIgZWxlbWVudCBmcm9tIHN0cnVjdCByY3Vf
ZGF0YSBhcyBpdCBpc24ndCB1c2VkLgoKRmluYWxseSBzd2l0Y2ggcmN1X2JhcnJpZXIoKSB0byBy
ZXR1cm4gdm9pZCBhcyBpdCBub3cgY2FuIG5ldmVyIGZhaWwuCgpQYXJ0aWFsbHktYmFzZWQtb24t
cGF0Y2gtYnk6IElnb3IgRHJ1emhpbmluIDxpZ29yLmRydXpoaW5pbkBjaXRyaXguY29tPgpTaWdu
ZWQtb2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+Ci0tLQpWMjoKLSBhZGQg
cmVjdXJzaW9uIGRldGVjdGlvbgoKVjM6Ci0gZml4IHJhY2VzIChJZ29yIERydXpoaW5pbikKLS0t
CiB4ZW4vY29tbW9uL3JjdXBkYXRlLmMgICAgICB8IDg1ICsrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKystLS0tLS0tLS0tLS0tLS0KIHhlbi9pbmNsdWRlL3hlbi9yY3VwZGF0ZS5oIHwgIDIg
Ky0KIDIgZmlsZXMgY2hhbmdlZCwgNTkgaW5zZXJ0aW9ucygrKSwgMjggZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9yY3VwZGF0ZS5jIGIveGVuL2NvbW1vbi9yY3VwZGF0ZS5j
CmluZGV4IDAzZDg0NzY0ZDIuLjI3ZDU5N2JiZWIgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vcmN1
cGRhdGUuYworKysgYi94ZW4vY29tbW9uL3JjdXBkYXRlLmMKQEAgLTgzLDcgKzgzLDYgQEAgc3Ry
dWN0IHJjdV9kYXRhIHsKICAgICBzdHJ1Y3QgcmN1X2hlYWQgKipkb25ldGFpbDsKICAgICBsb25n
ICAgICAgICAgICAgYmxpbWl0OyAgICAgICAgICAgLyogVXBwZXIgbGltaXQgb24gYSBwcm9jZXNz
ZWQgYmF0Y2ggKi8KICAgICBpbnQgY3B1OwotICAgIHN0cnVjdCByY3VfaGVhZCBiYXJyaWVyOwog
ICAgIGxvbmcgICAgICAgICAgICBsYXN0X3JzX3FsZW47ICAgICAvKiBxbGVuIGR1cmluZyB0aGUg
bGFzdCByZXNjaGVkICovCiAKICAgICAvKiAzKSBpZGxlIENQVXMgaGFuZGxpbmcgKi8KQEAgLTkx
LDYgKzkwLDcgQEAgc3RydWN0IHJjdV9kYXRhIHsKICAgICBib29sIGlkbGVfdGltZXJfYWN0aXZl
OwogCiAgICAgYm9vbCAgICAgICAgICAgIHByb2Nlc3NfY2FsbGJhY2tzOworICAgIGJvb2wgICAg
ICAgICAgICBiYXJyaWVyX2FjdGl2ZTsKIH07CiAKIC8qCkBAIC0xNDMsNTEgKzE0Myw3NSBAQCBz
dGF0aWMgaW50IHFoaW1hcmsgPSAxMDAwMDsKIHN0YXRpYyBpbnQgcWxvd21hcmsgPSAxMDA7CiBz
dGF0aWMgaW50IHJzaW50ZXJ2YWwgPSAxMDAwOwogCi1zdHJ1Y3QgcmN1X2JhcnJpZXJfZGF0YSB7
Ci0gICAgc3RydWN0IHJjdV9oZWFkIGhlYWQ7Ci0gICAgYXRvbWljX3QgKmNwdV9jb3VudDsKLX07
CisvKgorICogcmN1X2JhcnJpZXIoKSBoYW5kbGluZzoKKyAqIGNwdV9jb3VudCBob2xkcyB0aGUg
bnVtYmVyIG9mIGNwdSByZXF1aXJlZCB0byBmaW5pc2ggYmFycmllciBoYW5kbGluZy4KKyAqIENw
dXMgYXJlIHN5bmNocm9uaXplZCB2aWEgc29mdGlycSBtZWNoYW5pc20uIHJjdV9iYXJyaWVyKCkg
aXMgcmVnYXJkZWQgdG8KKyAqIGJlIGFjdGl2ZSBpZiBjcHVfY291bnQgaXMgbm90IHplcm8uIElu
IGNhc2UgcmN1X2JhcnJpZXIoKSBpcyBjYWxsZWQgb24KKyAqIG11bHRpcGxlIGNwdXMgaXQgaXMg
ZW5vdWdoIHRvIGNoZWNrIGZvciBjcHVfY291bnQgYmVpbmcgbm90IHplcm8gb24gZW50cnkKKyAq
IGFuZCB0byBjYWxsIHByb2Nlc3NfcGVuZGluZ19zb2Z0aXJxcygpIGluIGEgbG9vcCB1bnRpbCBj
cHVfY291bnQgZHJvcHMgdG8KKyAqIHplcm8sIGFzIHN5bmNpbmcgaGFzIGJlZW4gcmVxdWVzdGVk
IGFscmVhZHkgYW5kIHdlIGRvbid0IG5lZWQgdG8gc3luYworICogbXVsdGlwbGUgdGltZXMuCisg
KiBJbiBvcmRlciB0byBhdm9pZCBoYW5ncyB3aGVuIHJjdV9iYXJyaWVyKCkgaXMgY2FsbGVkIG11
dGlwbGUgdGltZXMgb24gdGhlCisgKiBzYW1lIGNwdSBpbiBmYXN0IHNlcXVlbmNlIGFuZCBhIHNs
YXZlIGNwdSBjb3VsZG4ndCBkcm9wIG91dCBvZiB0aGUKKyAqIGJhcnJpZXIgaGFuZGxpbmcgZmFz
dCBlbm91Z2ggYSBzZWNvbmQgY291bnRlciBkb25lX2NvdW50IGlzIG5lZWRlZC4KKyAqLworc3Rh
dGljIGF0b21pY190IGNwdV9jb3VudCA9IEFUT01JQ19JTklUKDApOworc3RhdGljIGF0b21pY190
IGRvbmVfY291bnQgPSBBVE9NSUNfSU5JVCgwKTsKIAogc3RhdGljIHZvaWQgcmN1X2JhcnJpZXJf
Y2FsbGJhY2soc3RydWN0IHJjdV9oZWFkICpoZWFkKQogewotICAgIHN0cnVjdCByY3VfYmFycmll
cl9kYXRhICpkYXRhID0gY29udGFpbmVyX29mKAotICAgICAgICBoZWFkLCBzdHJ1Y3QgcmN1X2Jh
cnJpZXJfZGF0YSwgaGVhZCk7Ci0gICAgYXRvbWljX2luYyhkYXRhLT5jcHVfY291bnQpOworICAg
IGF0b21pY19kZWMoJmNwdV9jb3VudCk7CiB9CiAKLXN0YXRpYyBpbnQgcmN1X2JhcnJpZXJfYWN0
aW9uKHZvaWQgKl9jcHVfY291bnQpCitzdGF0aWMgdm9pZCByY3VfYmFycmllcl9hY3Rpb24odm9p
ZCkKIHsKLSAgICBzdHJ1Y3QgcmN1X2JhcnJpZXJfZGF0YSBkYXRhID0geyAuY3B1X2NvdW50ID0g
X2NwdV9jb3VudCB9OwotCi0gICAgQVNTRVJUKCFsb2NhbF9pcnFfaXNfZW5hYmxlZCgpKTsKLSAg
ICBsb2NhbF9pcnFfZW5hYmxlKCk7CisgICAgc3RydWN0IHJjdV9oZWFkIGhlYWQ7CiAKICAgICAv
KgogICAgICAqIFdoZW4gY2FsbGJhY2sgaXMgZXhlY3V0ZWQsIGFsbCBwcmV2aW91c2x5LXF1ZXVl
ZCBSQ1Ugd29yayBvbiB0aGlzIENQVQotICAgICAqIGlzIGNvbXBsZXRlZC4gV2hlbiBhbGwgQ1BV
cyBoYXZlIGV4ZWN1dGVkIHRoZWlyIGNhbGxiYWNrLCBkYXRhLmNwdV9jb3VudAotICAgICAqIHdp
bGwgaGF2ZSBiZWVuIGluY3JlbWVudGVkIHRvIGluY2x1ZGUgZXZlcnkgb25saW5lIENQVS4KKyAg
ICAgKiBpcyBjb21wbGV0ZWQuIFdoZW4gYWxsIENQVXMgaGF2ZSBleGVjdXRlZCB0aGVpciBjYWxs
YmFjaywgY3B1X2NvdW50CisgICAgICogd2lsbCBoYXZlIGJlZW4gZGVjcmVtZW50ZWQgdG8gMC4K
ICAgICAgKi8KLSAgICBjYWxsX3JjdSgmZGF0YS5oZWFkLCByY3VfYmFycmllcl9jYWxsYmFjayk7
CisgICAgY2FsbF9yY3UoJmhlYWQsIHJjdV9iYXJyaWVyX2NhbGxiYWNrKTsKIAotICAgIHdoaWxl
ICggYXRvbWljX3JlYWQoZGF0YS5jcHVfY291bnQpICE9IG51bV9vbmxpbmVfY3B1cygpICkKKyAg
ICB3aGlsZSAoIGF0b21pY19yZWFkKCZjcHVfY291bnQpICkKICAgICB7CiAgICAgICAgIHByb2Nl
c3NfcGVuZGluZ19zb2Z0aXJxcygpOwogICAgICAgICBjcHVfcmVsYXgoKTsKICAgICB9CiAKLSAg
ICBsb2NhbF9pcnFfZGlzYWJsZSgpOwotCi0gICAgcmV0dXJuIDA7CisgICAgYXRvbWljX2RlYygm
ZG9uZV9jb3VudCk7CiB9CiAKLS8qCi0gKiBBcyByY3VfYmFycmllcigpIGlzIHVzaW5nIHN0b3Bf
bWFjaGluZV9ydW4oKSBpdCBpcyBhbGxvd2VkIHRvIGJlIHVzZWQgaW4KLSAqIGlkbGUgY29udGV4
dCBvbmx5IChzZWUgY29tbWVudCBmb3Igc3RvcF9tYWNoaW5lX3J1bigpKS4KLSAqLwotaW50IHJj
dV9iYXJyaWVyKHZvaWQpCit2b2lkIHJjdV9iYXJyaWVyKHZvaWQpCiB7Ci0gICAgYXRvbWljX3Qg
Y3B1X2NvdW50ID0gQVRPTUlDX0lOSVQoMCk7Ci0gICAgcmV0dXJuIHN0b3BfbWFjaGluZV9ydW4o
cmN1X2JhcnJpZXJfYWN0aW9uLCAmY3B1X2NvdW50LCBOUl9DUFVTKTsKKyAgICB1bnNpZ25lZCBp
bnQgbl9jcHVzOworCisgICAgd2hpbGUgKCAhZ2V0X2NwdV9tYXBzKCkgKQorICAgIHsKKyAgICAg
ICAgcHJvY2Vzc19wZW5kaW5nX3NvZnRpcnFzKCk7CisgICAgICAgIGlmICggIWF0b21pY19yZWFk
KCZjcHVfY291bnQpICkKKyAgICAgICAgICAgIHJldHVybjsKKworICAgICAgICBjcHVfcmVsYXgo
KTsKKyAgICB9CisKKyAgICBuX2NwdXMgPSBudW1fb25saW5lX2NwdXMoKTsKKworICAgIGlmICgg
YXRvbWljX2NtcHhjaGcoJmNwdV9jb3VudCwgMCwgbl9jcHVzKSA9PSAwICkKKyAgICB7CisgICAg
ICAgIGF0b21pY19hZGQobl9jcHVzLCAmZG9uZV9jb3VudCk7CisgICAgICAgIGNwdW1hc2tfcmFp
c2Vfc29mdGlycSgmY3B1X29ubGluZV9tYXAsIFJDVV9TT0ZUSVJRKTsKKyAgICB9CisKKyAgICB3
aGlsZSAoIGF0b21pY19yZWFkKCZkb25lX2NvdW50KSApCisgICAgeworICAgICAgICBwcm9jZXNz
X3BlbmRpbmdfc29mdGlycXMoKTsKKyAgICAgICAgY3B1X3JlbGF4KCk7CisgICAgfQorCisgICAg
cHV0X2NwdV9tYXBzKCk7CiB9CiAKIC8qIElzIGJhdGNoIGEgYmVmb3JlIGJhdGNoIGIgPyAqLwpA
QCAtNDI2LDYgKzQ1MCwxMyBAQCBzdGF0aWMgdm9pZCByY3VfcHJvY2Vzc19jYWxsYmFja3Modm9p
ZCkKICAgICAgICAgcmRwLT5wcm9jZXNzX2NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgICBfX3Jj
dV9wcm9jZXNzX2NhbGxiYWNrcygmcmN1X2N0cmxibGssIHJkcCk7CiAgICAgfQorCisgICAgaWYg
KCBhdG9taWNfcmVhZCgmY3B1X2NvdW50KSAmJiAhcmRwLT5iYXJyaWVyX2FjdGl2ZSApCisgICAg
eworICAgICAgICByZHAtPmJhcnJpZXJfYWN0aXZlID0gdHJ1ZTsKKyAgICAgICAgcmN1X2JhcnJp
ZXJfYWN0aW9uKCk7CisgICAgICAgIHJkcC0+YmFycmllcl9hY3RpdmUgPSBmYWxzZTsKKyAgICB9
CiB9CiAKIHN0YXRpYyBpbnQgX19yY3VfcGVuZGluZyhzdHJ1Y3QgcmN1X2N0cmxibGsgKnJjcCwg
c3RydWN0IHJjdV9kYXRhICpyZHApCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS94ZW4vcmN1cGRh
dGUuaCBiL3hlbi9pbmNsdWRlL3hlbi9yY3VwZGF0ZS5oCmluZGV4IDE3NGQwNTgxMTMuLjg3ZjM1
Yjc3MDQgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9yY3VwZGF0ZS5oCisrKyBiL3hlbi9p
bmNsdWRlL3hlbi9yY3VwZGF0ZS5oCkBAIC0xNDMsNyArMTQzLDcgQEAgdm9pZCByY3VfY2hlY2tf
Y2FsbGJhY2tzKGludCBjcHUpOwogdm9pZCBjYWxsX3JjdShzdHJ1Y3QgcmN1X2hlYWQgKmhlYWQs
IAogICAgICAgICAgICAgICB2b2lkICgqZnVuYykoc3RydWN0IHJjdV9oZWFkICpoZWFkKSk7CiAK
LWludCByY3VfYmFycmllcih2b2lkKTsKK3ZvaWQgcmN1X2JhcnJpZXIodm9pZCk7CiAKIHZvaWQg
cmN1X2lkbGVfZW50ZXIodW5zaWduZWQgaW50IGNwdSk7CiB2b2lkIHJjdV9pZGxlX2V4aXQodW5z
aWduZWQgaW50IGNwdSk7Ci0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0
cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlz
dGluZm8veGVuLWRldmVs

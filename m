Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id F21E8BF473
	for <lists+xen-devel@lfdr.de>; Thu, 26 Sep 2019 15:52:55 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDU9c-000266-Ok; Thu, 26 Sep 2019 13:49:56 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=njQ1=XV=intel.com=chao.gao@srs-us1.protection.inumbo.net>)
 id 1iDU9b-00025f-8E
 for xen-devel@lists.xenproject.org; Thu, 26 Sep 2019 13:49:55 +0000
X-Inumbo-ID: 7f0a89b2-e064-11e9-8628-bc764e2007e4
Received: from mga04.intel.com (unknown [192.55.52.120])
 by localhost (Halon) with ESMTPS
 id 7f0a89b2-e064-11e9-8628-bc764e2007e4;
 Thu, 26 Sep 2019 13:49:45 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga008.fm.intel.com ([10.253.24.58])
 by fmsmga104.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 26 Sep 2019 06:49:44 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,552,1559545200"; d="scan'208";a="189126035"
Received: from gao-cwp.sh.intel.com ([10.239.159.26])
 by fmsmga008.fm.intel.com with ESMTP; 26 Sep 2019 06:49:42 -0700
From: Chao Gao <chao.gao@intel.com>
To: xen-devel@lists.xenproject.org
Date: Thu, 26 Sep 2019 21:53:31 +0800
Message-Id: <1569506015-26938-4-git-send-email-chao.gao@intel.com>
X-Mailer: git-send-email 1.9.1
In-Reply-To: <1569506015-26938-1-git-send-email-chao.gao@intel.com>
References: <1569506015-26938-1-git-send-email-chao.gao@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v11 3/7] microcode: reduce memory allocation and
 copy when creating a patch
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Sergey Dyasli <sergey.dyasli@citrix.com>, Ashok Raj <ashok.raj@intel.com>,
 Wei Liu <wl@xen.org>, Andrew Cooper <andrew.cooper3@citrix.com>,
 Jan Beulich <jbeulich@suse.com>, Chao Gao <chao.gao@intel.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VG8gY3JlYXRlIGEgbWljcm9jb2RlIHBhdGNoIGZyb20gYSB2ZW5kb3Itc3BlY2lmaWMgdXBkYXRl
LAphbGxvY2F0ZV9taWNyb2NvZGVfcGF0Y2goKSBjb3BpZWQgZXZlcnl0aGluZyBmcm9tIHRoZSB1
cGRhdGUuCkl0IGlzIG5vdCBlZmZpY2llbnQuIEVzc2VudGlhbGx5LCB3ZSBqdXN0IG5lZWQgdG8g
Z28gdGhyb3VnaAp1Y29kZXMgaW4gdGhlIGJsb2IsIGZpbmQgdGhlIG9uZSB3aXRoIHRoZSBuZXdl
c3QgcmV2aXNpb24gYW5kCmluc3RhbGwgaXQgaW50byB0aGUgbWljcm9jb2RlX3BhdGNoLiBJbiB0
aGUgcHJvY2VzcywgYnVmZmVycwpsaWtlIG1jX2FtZCwgZXF1aXZfY3B1X3RhYmxlIChvbiBBTUQg
c2lkZSksIGFuZCBtYyAob24gSW50ZWwKc2lkZSkgY2FuIGJlIHJldXNlZC4gbWljcm9jb2RlX3Bh
dGNoIG5vdyBpcyBhbGxvY2F0ZWQgYWZ0ZXIKaXQgaXMgc3VyZSB0aGF0IHRoZXJlIGlzIGEgbWF0
Y2hpbmcgdWNvZGUuCgpTaWduZWQtb2ZmLWJ5OiBDaGFvIEdhbyA8Y2hhby5nYW9AaW50ZWwuY29t
PgpSZXZpZXdlZC1ieTogUm9nZXIgUGF1IE1vbm7DqSA8cm9nZXIucGF1QGNpdHJpeC5jb20+ClJl
dmlld2VkLWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+Ci0tLQpDaGFuZ2VzIGlu
IHYxMToKIC0gY29ycmVjdCBwYXJhbWV0ZXIgdHlwZSBpc3N1ZXMgb2YgZ2V0X25leHRfdWNvZGVf
ZnJvbV9idWZmZXIKCkNoYW5nZXMgaW4gdjEwOgogLSBhdm9pZCB1bm5lY2Vzc2FyeSB0eXBlIGNh
c3RpbmcKICAgKiBpbnRyb2R1Y2UgY29tcGFyZV9oZWFkZXIgb24gQU1EIHNpZGUKICAgKiBzcGVj
aWZ5IHRoZSB0eXBlIG9mIHRoZSBmaXJzdCBwYXJhbWV0ZXIgb2YgZ2V0X25leHRfdWNvZGVfZnJv
bV9idWZmZXIoKQogICAgIG9uIEludGVsIHNpZGUKCkNoYW5nZXMgaW4gdjk6CiAtIG5ldwotLS0K
IHhlbi9hcmNoL3g4Ni9taWNyb2NvZGVfYW1kLmMgICB8IDExMiArKysrKysrKysrKysrKysrKy0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogeGVuL2FyY2gveDg2L21pY3JvY29kZV9pbnRlbC5jIHwg
IDY3ICsrKysrKysrKy0tLS0tLS0tLS0tLS0tLQogMiBmaWxlcyBjaGFuZ2VkLCA2OSBpbnNlcnRp
b25zKCspLCAxMTAgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L21pY3Jv
Y29kZV9hbWQuYyBiL3hlbi9hcmNoL3g4Ni9taWNyb2NvZGVfYW1kLmMKaW5kZXggMDE5OTMwOC4u
OWE4ZjE3OSAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L21pY3JvY29kZV9hbWQuYworKysgYi94
ZW4vYXJjaC94ODYvbWljcm9jb2RlX2FtZC5jCkBAIC0xOTQsMzYgKzE5NCw2IEBAIHN0YXRpYyBi
b29sIG1hdGNoX2NwdShjb25zdCBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICpwYXRjaCkKICAgICBy
ZXR1cm4gcGF0Y2ggJiYgKG1pY3JvY29kZV9maXRzKHBhdGNoLT5tY19hbWQpID09IE5FV19VQ09E
RSk7CiB9CiAKLXN0YXRpYyBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICphbGxvY19taWNyb2NvZGVf
cGF0Y2goCi0gICAgY29uc3Qgc3RydWN0IG1pY3JvY29kZV9hbWQgKm1jX2FtZCkKLXsKLSAgICBz
dHJ1Y3QgbWljcm9jb2RlX3BhdGNoICptaWNyb2NvZGVfcGF0Y2ggPSB4bWFsbG9jKHN0cnVjdCBt
aWNyb2NvZGVfcGF0Y2gpOwotICAgIHN0cnVjdCBtaWNyb2NvZGVfYW1kICpjYWNoZSA9IHhtYWxs
b2Moc3RydWN0IG1pY3JvY29kZV9hbWQpOwotICAgIHZvaWQgKm1wYiA9IHhtYWxsb2NfYnl0ZXMo
bWNfYW1kLT5tcGJfc2l6ZSk7Ci0gICAgc3RydWN0IGVxdWl2X2NwdV9lbnRyeSAqZXF1aXZfY3B1
X3RhYmxlID0KLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1hbGxvY19ieXRlcyht
Y19hbWQtPmVxdWl2X2NwdV90YWJsZV9zaXplKTsKLQotICAgIGlmICggIW1pY3JvY29kZV9wYXRj
aCB8fCAhY2FjaGUgfHwgIW1wYiB8fCAhZXF1aXZfY3B1X3RhYmxlICkKLSAgICB7Ci0gICAgICAg
IHhmcmVlKG1pY3JvY29kZV9wYXRjaCk7Ci0gICAgICAgIHhmcmVlKGNhY2hlKTsKLSAgICAgICAg
eGZyZWUobXBiKTsKLSAgICAgICAgeGZyZWUoZXF1aXZfY3B1X3RhYmxlKTsKLSAgICAgICAgcmV0
dXJuIEVSUl9QVFIoLUVOT01FTSk7Ci0gICAgfQotCi0gICAgbWVtY3B5KG1wYiwgbWNfYW1kLT5t
cGIsIG1jX2FtZC0+bXBiX3NpemUpOwotICAgIGNhY2hlLT5tcGIgPSBtcGI7Ci0gICAgY2FjaGUt
Pm1wYl9zaXplID0gbWNfYW1kLT5tcGJfc2l6ZTsKLSAgICBtZW1jcHkoZXF1aXZfY3B1X3RhYmxl
LCBtY19hbWQtPmVxdWl2X2NwdV90YWJsZSwKLSAgICAgICAgICAgbWNfYW1kLT5lcXVpdl9jcHVf
dGFibGVfc2l6ZSk7Ci0gICAgY2FjaGUtPmVxdWl2X2NwdV90YWJsZSA9IGVxdWl2X2NwdV90YWJs
ZTsKLSAgICBjYWNoZS0+ZXF1aXZfY3B1X3RhYmxlX3NpemUgPSBtY19hbWQtPmVxdWl2X2NwdV90
YWJsZV9zaXplOwotICAgIG1pY3JvY29kZV9wYXRjaC0+bWNfYW1kID0gY2FjaGU7Ci0KLSAgICBy
ZXR1cm4gbWljcm9jb2RlX3BhdGNoOwotfQotCiBzdGF0aWMgdm9pZCBmcmVlX3BhdGNoKHZvaWQg
Km1jKQogewogICAgIHN0cnVjdCBtaWNyb2NvZGVfYW1kICptY19hbWQgPSBtYzsKQEAgLTIzNiw2
ICsyMDYsMTcgQEAgc3RhdGljIHZvaWQgZnJlZV9wYXRjaCh2b2lkICptYykKICAgICB9CiB9CiAK
K3N0YXRpYyBlbnVtIG1pY3JvY29kZV9tYXRjaF9yZXN1bHQgY29tcGFyZV9oZWFkZXIoCisgICAg
Y29uc3Qgc3RydWN0IG1pY3JvY29kZV9oZWFkZXJfYW1kICpuZXdfaGVhZGVyLAorICAgIGNvbnN0
IHN0cnVjdCBtaWNyb2NvZGVfaGVhZGVyX2FtZCAqb2xkX2hlYWRlcikKK3sKKyAgICBpZiAoIG5l
d19oZWFkZXItPnByb2Nlc3Nvcl9yZXZfaWQgPT0gb2xkX2hlYWRlci0+cHJvY2Vzc29yX3Jldl9p
ZCApCisgICAgICAgIHJldHVybiAobmV3X2hlYWRlci0+cGF0Y2hfaWQgPiBvbGRfaGVhZGVyLT5w
YXRjaF9pZCkgPyBORVdfVUNPREUKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICA6IE9MRF9VQ09ERTsKKworICAgIHJldHVybiBNSVNf
VUNPREU7Cit9CisKIHN0YXRpYyBlbnVtIG1pY3JvY29kZV9tYXRjaF9yZXN1bHQgY29tcGFyZV9w
YXRjaCgKICAgICBjb25zdCBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICpuZXcsIGNvbnN0IHN0cnVj
dCBtaWNyb2NvZGVfcGF0Y2ggKm9sZCkKIHsKQEAgLTI0NiwxMSArMjI3LDcgQEAgc3RhdGljIGVu
dW0gbWljcm9jb2RlX21hdGNoX3Jlc3VsdCBjb21wYXJlX3BhdGNoKAogICAgIEFTU0VSVChtaWNy
b2NvZGVfZml0cyhuZXctPm1jX2FtZCkgIT0gTUlTX1VDT0RFKTsKICAgICBBU1NFUlQobWljcm9j
b2RlX2ZpdHMobmV3LT5tY19hbWQpICE9IE1JU19VQ09ERSk7CiAKLSAgICBpZiAoIG5ld19oZWFk
ZXItPnByb2Nlc3Nvcl9yZXZfaWQgPT0gb2xkX2hlYWRlci0+cHJvY2Vzc29yX3Jldl9pZCApCi0g
ICAgICAgIHJldHVybiAobmV3X2hlYWRlci0+cGF0Y2hfaWQgPiBvbGRfaGVhZGVyLT5wYXRjaF9p
ZCkgPwotICAgICAgICAgICAgICAgIE5FV19VQ09ERSA6IE9MRF9VQ09ERTsKLQotICAgIHJldHVy
biBNSVNfVUNPREU7CisgICAgcmV0dXJuIGNvbXBhcmVfaGVhZGVyKG5ld19oZWFkZXIsIG9sZF9o
ZWFkZXIpOwogfQogCiBzdGF0aWMgaW50IGFwcGx5X21pY3JvY29kZShjb25zdCBzdHJ1Y3QgbWlj
cm9jb2RlX3BhdGNoICpwYXRjaCkKQEAgLTMyOCwxOCArMzA1LDEwIEBAIHN0YXRpYyBpbnQgZ2V0
X3Vjb2RlX2Zyb21fYnVmZmVyX2FtZCgKICAgICAgICAgcmV0dXJuIC1FSU5WQUw7CiAgICAgfQog
Ci0gICAgaWYgKCBtY19hbWQtPm1wYl9zaXplIDwgbXBidWYtPmxlbiApCi0gICAgewotICAgICAg
ICBpZiAoIG1jX2FtZC0+bXBiICkKLSAgICAgICAgewotICAgICAgICAgICAgeGZyZWUobWNfYW1k
LT5tcGIpOwotICAgICAgICAgICAgbWNfYW1kLT5tcGJfc2l6ZSA9IDA7Ci0gICAgICAgIH0KLSAg
ICAgICAgbWNfYW1kLT5tcGIgPSB4bWFsbG9jX2J5dGVzKG1wYnVmLT5sZW4pOwotICAgICAgICBp
ZiAoIG1jX2FtZC0+bXBiID09IE5VTEwgKQotICAgICAgICAgICAgcmV0dXJuIC1FTk9NRU07Ci0g
ICAgICAgIG1jX2FtZC0+bXBiX3NpemUgPSBtcGJ1Zi0+bGVuOwotICAgIH0KKyAgICBtY19hbWQt
Pm1wYiA9IHhtYWxsb2NfYnl0ZXMobXBidWYtPmxlbik7CisgICAgaWYgKCAhbWNfYW1kLT5tcGIg
KQorICAgICAgICByZXR1cm4gLUVOT01FTTsKKyAgICBtY19hbWQtPm1wYl9zaXplID0gbXBidWYt
PmxlbjsKICAgICBtZW1jcHkobWNfYW1kLT5tcGIsIG1wYnVmLT5kYXRhLCBtcGJ1Zi0+bGVuKTsK
IAogICAgIHByX2RlYnVnKCJtaWNyb2NvZGU6IENQVSVkIHNpemUgJXp1LCBibG9jayBzaXplICV1
IG9mZnNldCAlenUgZXF1aXZJRCAlI3ggcmV2ICUjeFxuIiwKQEAgLTQ1OSw4ICs0MjgsOSBAQCBz
dGF0aWMgc3RydWN0IG1pY3JvY29kZV9wYXRjaCAqY3B1X3JlcXVlc3RfbWljcm9jb2RlKGNvbnN0
IHZvaWQgKmJ1ZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgc2l6ZV90IGJ1ZnNpemUpCiB7CiAgICAgc3RydWN0IG1pY3JvY29kZV9hbWQgKm1j
X2FtZDsKKyAgICBzdHJ1Y3QgbWljcm9jb2RlX2hlYWRlcl9hbWQgKnNhdmVkID0gTlVMTDsKICAg
ICBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICpwYXRjaCA9IE5VTEw7Ci0gICAgc2l6ZV90IG9mZnNl
dCA9IDA7CisgICAgc2l6ZV90IG9mZnNldCA9IDAsIHNhdmVkX3NpemUgPSAwOwogICAgIGludCBl
cnJvciA9IDA7CiAgICAgdW5zaWduZWQgaW50IGN1cnJlbnRfY3B1X2lkOwogICAgIHVuc2lnbmVk
IGludCBlcXVpdl9jcHVfaWQ7CkBAIC01NTAsMjkgKzUyMCwyMiBAQCBzdGF0aWMgc3RydWN0IG1p
Y3JvY29kZV9wYXRjaCAqY3B1X3JlcXVlc3RfbWljcm9jb2RlKGNvbnN0IHZvaWQgKmJ1ZiwKICAg
ICB3aGlsZSAoIChlcnJvciA9IGdldF91Y29kZV9mcm9tX2J1ZmZlcl9hbWQobWNfYW1kLCBidWYs
IGJ1ZnNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICZvZmZzZXQpKSA9PSAwICkKICAgICB7Ci0gICAgICAgIHN0cnVjdCBtaWNyb2NvZGVfcGF0Y2gg
Km5ld19wYXRjaCA9IGFsbG9jX21pY3JvY29kZV9wYXRjaChtY19hbWQpOwotCi0gICAgICAgIGlm
ICggSVNfRVJSKG5ld19wYXRjaCkgKQotICAgICAgICB7Ci0gICAgICAgICAgICBlcnJvciA9IFBU
Ul9FUlIobmV3X3BhdGNoKTsKLSAgICAgICAgICAgIGJyZWFrOwotICAgICAgICB9Ci0KICAgICAg
ICAgLyoKLSAgICAgICAgICogSWYgdGhlIG5ldyBwYXRjaCBjb3ZlcnMgY3VycmVudCBDUFUsIGNv
bXBhcmUgcGF0Y2hlcyBhbmQgc3RvcmUgdGhlCisgICAgICAgICAqIElmIHRoZSBuZXcgdWNvZGUg
Y292ZXJzIGN1cnJlbnQgQ1BVLCBjb21wYXJlIHVjb2RlcyBhbmQgc3RvcmUgdGhlCiAgICAgICAg
ICAqIG9uZSB3aXRoIGhpZ2hlciByZXZpc2lvbi4KICAgICAgICAgICovCi0gICAgICAgIGlmICgg
KG1pY3JvY29kZV9maXRzKG5ld19wYXRjaC0+bWNfYW1kKSAhPSBNSVNfVUNPREUpICYmCi0gICAg
ICAgICAgICAgKCFwYXRjaCB8fCAoY29tcGFyZV9wYXRjaChuZXdfcGF0Y2gsIHBhdGNoKSA9PSBO
RVdfVUNPREUpKSApCisgICAgICAgIGlmICggKG1pY3JvY29kZV9maXRzKG1jX2FtZCkgIT0gTUlT
X1VDT0RFKSAmJgorICAgICAgICAgICAgICghc2F2ZWQgfHwgKGNvbXBhcmVfaGVhZGVyKG1jX2Ft
ZC0+bXBiLCBzYXZlZCkgPT0gTkVXX1VDT0RFKSkgKQogICAgICAgICB7Ci0gICAgICAgICAgICBz
dHJ1Y3QgbWljcm9jb2RlX3BhdGNoICp0bXAgPSBwYXRjaDsKLQotICAgICAgICAgICAgcGF0Y2gg
PSBuZXdfcGF0Y2g7Ci0gICAgICAgICAgICBuZXdfcGF0Y2ggPSB0bXA7CisgICAgICAgICAgICB4
ZnJlZShzYXZlZCk7CisgICAgICAgICAgICBzYXZlZCA9IG1jX2FtZC0+bXBiOworICAgICAgICAg
ICAgc2F2ZWRfc2l6ZSA9IG1jX2FtZC0+bXBiX3NpemU7CisgICAgICAgIH0KKyAgICAgICAgZWxz
ZQorICAgICAgICB7CisgICAgICAgICAgICB4ZnJlZShtY19hbWQtPm1wYik7CisgICAgICAgICAg
ICBtY19hbWQtPm1wYiA9IE5VTEw7CiAgICAgICAgIH0KLQotICAgICAgICBpZiAoIG5ld19wYXRj
aCApCi0gICAgICAgICAgICBtaWNyb2NvZGVfZnJlZV9wYXRjaChuZXdfcGF0Y2gpOwogCiAgICAg
ICAgIGlmICggb2Zmc2V0ID49IGJ1ZnNpemUgKQogICAgICAgICAgICAgYnJlYWs7CkBAIC02MDEs
NyArNTY0LDIyIEBAIHN0YXRpYyBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICpjcHVfcmVxdWVzdF9t
aWNyb2NvZGUoY29uc3Qgdm9pZCAqYnVmLAogICAgICAgICAgICAgICooY29uc3QgdWludDMyX3Qg
KikoYnVmICsgb2Zmc2V0KSA9PSBVQ09ERV9NQUdJQyApCiAgICAgICAgICAgICBicmVhazsKICAg
ICB9Ci0gICAgZnJlZV9wYXRjaChtY19hbWQpOworCisgICAgaWYgKCBzYXZlZCApCisgICAgewor
ICAgICAgICBtY19hbWQtPm1wYiA9IHNhdmVkOworICAgICAgICBtY19hbWQtPm1wYl9zaXplID0g
c2F2ZWRfc2l6ZTsKKyAgICAgICAgcGF0Y2ggPSB4bWFsbG9jKHN0cnVjdCBtaWNyb2NvZGVfcGF0
Y2gpOworICAgICAgICBpZiAoIHBhdGNoICkKKyAgICAgICAgICAgIHBhdGNoLT5tY19hbWQgPSBt
Y19hbWQ7CisgICAgICAgIGVsc2UKKyAgICAgICAgeworICAgICAgICAgICAgZnJlZV9wYXRjaCht
Y19hbWQpOworICAgICAgICAgICAgZXJyb3IgPSAtRU5PTUVNOworICAgICAgICB9CisgICAgfQor
ICAgIGVsc2UKKyAgICAgICAgZnJlZV9wYXRjaChtY19hbWQpOwogCiAgIG91dDoKICAgICBpZiAo
IGVycm9yICYmICFwYXRjaCApCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvbWljcm9jb2RlX2lu
dGVsLmMgYi94ZW4vYXJjaC94ODYvbWljcm9jb2RlX2ludGVsLmMKaW5kZXggMWIzYWM5My4uYzA4
M2UxNyAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L21pY3JvY29kZV9pbnRlbC5jCisrKyBiL3hl
bi9hcmNoL3g4Ni9taWNyb2NvZGVfaW50ZWwuYwpAQCAtMjg1LDI1ICsyODUsNiBAQCBzdGF0aWMg
ZW51bSBtaWNyb2NvZGVfbWF0Y2hfcmVzdWx0IGNvbXBhcmVfcGF0Y2goCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBPTERfVUNP
REU7CiB9CiAKLXN0YXRpYyBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICphbGxvY19taWNyb2NvZGVf
cGF0Y2goCi0gICAgY29uc3Qgc3RydWN0IG1pY3JvY29kZV9oZWFkZXJfaW50ZWwgKm1jX2hlYWRl
cikKLXsKLSAgICB1bnNpZ25lZCBsb25nIHRvdGFsX3NpemUgPSBnZXRfdG90YWxzaXplKG1jX2hl
YWRlcik7Ci0gICAgdm9pZCAqbmV3X21jID0geG1hbGxvY19ieXRlcyh0b3RhbF9zaXplKTsKLSAg
ICBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICpuZXdfcGF0Y2ggPSB4bWFsbG9jKHN0cnVjdCBtaWNy
b2NvZGVfcGF0Y2gpOwotCi0gICAgaWYgKCAhbmV3X3BhdGNoIHx8ICFuZXdfbWMgKQotICAgIHsK
LSAgICAgICAgeGZyZWUobmV3X3BhdGNoKTsKLSAgICAgICAgeGZyZWUobmV3X21jKTsKLSAgICAg
ICAgcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7Ci0gICAgfQotICAgIG1lbWNweShuZXdfbWMsIG1j
X2hlYWRlciwgdG90YWxfc2l6ZSk7Ci0gICAgbmV3X3BhdGNoLT5tY19pbnRlbCA9IG5ld19tYzsK
LQotICAgIHJldHVybiBuZXdfcGF0Y2g7Ci19Ci0KIHN0YXRpYyBpbnQgYXBwbHlfbWljcm9jb2Rl
KGNvbnN0IHN0cnVjdCBtaWNyb2NvZGVfcGF0Y2ggKnBhdGNoKQogewogICAgIHVuc2lnbmVkIGxv
bmcgZmxhZ3M7CkBAIC0zNTIsOCArMzMzLDkgQEAgc3RhdGljIGludCBhcHBseV9taWNyb2NvZGUo
Y29uc3Qgc3RydWN0IG1pY3JvY29kZV9wYXRjaCAqcGF0Y2gpCiAgICAgcmV0dXJuIDA7CiB9CiAK
LXN0YXRpYyBsb25nIGdldF9uZXh0X3Vjb2RlX2Zyb21fYnVmZmVyKHZvaWQgKiptYywgY29uc3Qg
dTggKmJ1ZiwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVk
IGxvbmcgc2l6ZSwgbG9uZyBvZmZzZXQpCitzdGF0aWMgbG9uZyBnZXRfbmV4dF91Y29kZV9mcm9t
X2J1ZmZlcihzdHJ1Y3QgbWljcm9jb2RlX2ludGVsICoqbWMsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBjb25zdCB1aW50OF90ICpidWYsIHVuc2lnbmVkIGxvbmcgc2l6
ZSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGxvbmcg
b2Zmc2V0KQogewogICAgIHN0cnVjdCBtaWNyb2NvZGVfaGVhZGVyX2ludGVsICptY19oZWFkZXI7
CiAgICAgdW5zaWduZWQgbG9uZyB0b3RhbF9zaXplOwpAQCAtMzg1LDQ3ICszNjcsNDYgQEAgc3Rh
dGljIHN0cnVjdCBtaWNyb2NvZGVfcGF0Y2ggKmNwdV9yZXF1ZXN0X21pY3JvY29kZShjb25zdCB2
b2lkICpidWYsCiB7CiAgICAgbG9uZyBvZmZzZXQgPSAwOwogICAgIGludCBlcnJvciA9IDA7Ci0g
ICAgdm9pZCAqbWM7CisgICAgc3RydWN0IG1pY3JvY29kZV9pbnRlbCAqbWMsICpzYXZlZCA9IE5V
TEw7CiAgICAgc3RydWN0IG1pY3JvY29kZV9wYXRjaCAqcGF0Y2ggPSBOVUxMOwogCiAgICAgd2hp
bGUgKCAob2Zmc2V0ID0gZ2V0X25leHRfdWNvZGVfZnJvbV9idWZmZXIoJm1jLCBidWYsIHNpemUs
IG9mZnNldCkpID4gMCApCiAgICAgewotICAgICAgICBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICpu
ZXdfcGF0Y2g7Ci0KICAgICAgICAgZXJyb3IgPSBtaWNyb2NvZGVfc2FuaXR5X2NoZWNrKG1jKTsK
ICAgICAgICAgaWYgKCBlcnJvciApCi0gICAgICAgICAgICBicmVhazsKLQotICAgICAgICBuZXdf
cGF0Y2ggPSBhbGxvY19taWNyb2NvZGVfcGF0Y2gobWMpOwotICAgICAgICBpZiAoIElTX0VSUihu
ZXdfcGF0Y2gpICkKICAgICAgICAgewotICAgICAgICAgICAgZXJyb3IgPSBQVFJfRVJSKG5ld19w
YXRjaCk7CisgICAgICAgICAgICB4ZnJlZShtYyk7CiAgICAgICAgICAgICBicmVhazsKICAgICAg
ICAgfQogCiAgICAgICAgIC8qCi0gICAgICAgICAqIElmIHRoZSBuZXcgcGF0Y2ggY292ZXJzIGN1
cnJlbnQgQ1BVLCBjb21wYXJlIHBhdGNoZXMgYW5kIHN0b3JlIHRoZQorICAgICAgICAgKiBJZiB0
aGUgbmV3IHVwZGF0ZSBjb3ZlcnMgY3VycmVudCBDUFUsIGNvbXBhcmUgdXBkYXRlcyBhbmQgc3Rv
cmUgdGhlCiAgICAgICAgICAqIG9uZSB3aXRoIGhpZ2hlciByZXZpc2lvbi4KICAgICAgICAgICov
Ci0gICAgICAgIGlmICggKG1pY3JvY29kZV91cGRhdGVfbWF0Y2goJm5ld19wYXRjaC0+bWNfaW50
ZWwtPmhkcikgIT0gTUlTX1VDT0RFKSAmJgotICAgICAgICAgICAgICghcGF0Y2ggfHwgKGNvbXBh
cmVfcGF0Y2gobmV3X3BhdGNoLCBwYXRjaCkgPT0gTkVXX1VDT0RFKSkgKQorICAgICAgICBpZiAo
IChtaWNyb2NvZGVfdXBkYXRlX21hdGNoKCZtYy0+aGRyKSAhPSBNSVNfVUNPREUpICYmCisgICAg
ICAgICAgICAgKCFzYXZlZCB8fCAobWMtPmhkci5yZXYgPiBzYXZlZC0+aGRyLnJldikpICkKICAg
ICAgICAgewotICAgICAgICAgICAgc3RydWN0IG1pY3JvY29kZV9wYXRjaCAqdG1wID0gcGF0Y2g7
Ci0KLSAgICAgICAgICAgIHBhdGNoID0gbmV3X3BhdGNoOwotICAgICAgICAgICAgbmV3X3BhdGNo
ID0gdG1wOworICAgICAgICAgICAgeGZyZWUoc2F2ZWQpOworICAgICAgICAgICAgc2F2ZWQgPSBt
YzsKICAgICAgICAgfQotCi0gICAgICAgIGlmICggbmV3X3BhdGNoICkKLSAgICAgICAgICAgIG1p
Y3JvY29kZV9mcmVlX3BhdGNoKG5ld19wYXRjaCk7Ci0KLSAgICAgICAgeGZyZWUobWMpOworICAg
ICAgICBlbHNlCisgICAgICAgICAgICB4ZnJlZShtYyk7CiAgICAgfQotICAgIGlmICggb2Zmc2V0
ID4gMCApCi0gICAgICAgIHhmcmVlKG1jKTsKICAgICBpZiAoIG9mZnNldCA8IDAgKQogICAgICAg
ICBlcnJvciA9IG9mZnNldDsKIAorICAgIGlmICggc2F2ZWQgKQorICAgIHsKKyAgICAgICAgcGF0
Y2ggPSB4bWFsbG9jKHN0cnVjdCBtaWNyb2NvZGVfcGF0Y2gpOworICAgICAgICBpZiAoIHBhdGNo
ICkKKyAgICAgICAgICAgIHBhdGNoLT5tY19pbnRlbCA9IHNhdmVkOworICAgICAgICBlbHNlCisg
ICAgICAgIHsKKyAgICAgICAgICAgIHhmcmVlKHNhdmVkKTsKKyAgICAgICAgICAgIGVycm9yID0g
LUVOT01FTTsKKyAgICAgICAgfQorICAgIH0KKwogICAgIGlmICggZXJyb3IgJiYgIXBhdGNoICkK
ICAgICAgICAgcGF0Y2ggPSBFUlJfUFRSKGVycm9yKTsKIAotLSAKMS44LjMuMQoKCl9fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5n
IGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJv
amVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id D5BD91443A7
	for <lists+xen-devel@lfdr.de>; Tue, 21 Jan 2020 18:53:42 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1itxfK-0004aq-9c; Tue, 21 Jan 2020 17:50:14 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=ThP3=3K=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1itxfI-0004aJ-HN
 for xen-devel@lists.xenproject.org; Tue, 21 Jan 2020 17:50:12 +0000
X-Inumbo-ID: 7283f14c-3c76-11ea-aecd-bc764e2007e4
Received: from mga04.intel.com (unknown [192.55.52.120])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 7283f14c-3c76-11ea-aecd-bc764e2007e4;
 Tue, 21 Jan 2020 17:50:02 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by fmsmga104.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 21 Jan 2020 09:50:00 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.70,346,1574150400"; d="scan'208";a="228929112"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.251.23.127])
 by orsmga006.jf.intel.com with ESMTP; 21 Jan 2020 09:49:59 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 21 Jan 2020 09:49:34 -0800
Message-Id: <8b7e04b4f853de484f5f15f4523b4ae85134d5e9.1579628566.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1579628566.git.tamas.lengyel@intel.com>
References: <cover.1579628566.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v5 01/18] x86/hvm: introduce
 hvm_copy_context_and_params
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q3VycmVudGx5IHRoZSBodm0gcGFyYW1ldGVycyBhcmUgb25seSBhY2Nlc3NpYmxlIHZpYSB0aGUg
SFZNT1AgaHlwZXJjYWxscy4gSW4KdGhpcyBwYXRjaCB3ZSBpbnRyb2R1Y2UgYSBuZXcgZnVuY3Rp
b24gdGhhdCBjYW4gY29weSBib3RoIHRoZSBodm0gY29udGV4dCBhbmQKcGFyYW1ldGVycyBkaXJl
Y3RseSBpbnRvIGEgdGFyZ2V0IGRvbWFpbi4gTm8gZnVuY3Rpb25hbCBjaGFuZ2VzIGluIGV4aXN0
aW5nCmNvZGUuCgpTaWduZWQtb2ZmLWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxA
aW50ZWwuY29tPgotLS0KIHhlbi9hcmNoL3g4Ni9odm0vaHZtLmMgICAgICAgIHwgMjQwICsrKysr
KysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0KIHhlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2
bS5oIHwgICAyICsKIDIgZmlsZXMgY2hhbmdlZCwgMTUxIGluc2VydGlvbnMoKyksIDkxIGRlbGV0
aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMgYi94ZW4vYXJjaC94
ODYvaHZtL2h2bS5jCmluZGV4IDQ3MjNmNWQwOWMuLjY1MTk5OGU3ODMgMTAwNjQ0Ci0tLSBhL3hl
bi9hcmNoL3g4Ni9odm0vaHZtLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS9odm0uYwpAQCAtNDA2
NywxNiArNDA2NywxNyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9ldnRjaG5fdXBjYWxsX3ZlY3Rv
cigKIH0KIAogc3RhdGljIGludCBodm1fYWxsb3dfc2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQs
Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RydWN0IHhlbl9odm1fcGFy
YW0gKmEpCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgaW5kZXgsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDY0X3QgbmV3X3ZhbHVlKQogewotICAg
IHVpbnQ2NF90IHZhbHVlID0gZC0+YXJjaC5odm0ucGFyYW1zW2EtPmluZGV4XTsKKyAgICB1aW50
NjRfdCB2YWx1ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tpbmRleF07CiAgICAgaW50IHJjOwogCiAg
ICAgcmMgPSB4c21faHZtX3BhcmFtKFhTTV9UQVJHRVQsIGQsIEhWTU9QX3NldF9wYXJhbSk7CiAg
ICAgaWYgKCByYyApCiAgICAgICAgIHJldHVybiByYzsKIAotICAgIHN3aXRjaCAoIGEtPmluZGV4
ICkKKyAgICBzd2l0Y2ggKCBpbmRleCApCiAgICAgewogICAgIC8qIFRoZSBmb2xsb3dpbmcgcGFy
YW1ldGVycyBjYW4gYmUgc2V0IGJ5IHRoZSBndWVzdC4gKi8KICAgICBjYXNlIEhWTV9QQVJBTV9D
QUxMQkFDS19JUlE6CkBAIC00MTA5LDcgKzQxMTAsNyBAQCBzdGF0aWMgaW50IGh2bV9hbGxvd19z
ZXRfcGFyYW0oc3RydWN0IGRvbWFpbiAqZCwKICAgICBpZiAoIHJjICkKICAgICAgICAgcmV0dXJu
IHJjOwogCi0gICAgc3dpdGNoICggYS0+aW5kZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAg
ICB7CiAgICAgLyogVGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzIHNob3VsZCBvbmx5IGJlIGNoYW5n
ZWQgb25jZS4gKi8KICAgICBjYXNlIEhWTV9QQVJBTV9WSVJJRElBTjoKQEAgLTQxMTksNyArNDEy
MCw3IEBAIHN0YXRpYyBpbnQgaHZtX2FsbG93X3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAog
ICAgIGNhc2UgSFZNX1BBUkFNX05SX0lPUkVRX1NFUlZFUl9QQUdFUzoKICAgICBjYXNlIEhWTV9Q
QVJBTV9BTFRQMk06CiAgICAgY2FzZSBIVk1fUEFSQU1fTUNBX0NBUDoKLSAgICAgICAgaWYgKCB2
YWx1ZSAhPSAwICYmIGEtPnZhbHVlICE9IHZhbHVlICkKKyAgICAgICAgaWYgKCB2YWx1ZSAhPSAw
ICYmIG5ld192YWx1ZSAhPSB2YWx1ZSApCiAgICAgICAgICAgICByYyA9IC1FRVhJU1Q7CiAgICAg
ICAgIGJyZWFrOwogICAgIGRlZmF1bHQ6CkBAIC00MTI5LDQ5ICs0MTMwLDMyIEBAIHN0YXRpYyBp
bnQgaHZtX2FsbG93X3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHJldHVybiByYzsK
IH0KIAotc3RhdGljIGludCBodm1vcF9zZXRfcGFyYW0oCi0gICAgWEVOX0dVRVNUX0hBTkRMRV9Q
QVJBTSh4ZW5faHZtX3BhcmFtX3QpIGFyZykKK3N0YXRpYyBpbnQgaHZtX3NldF9wYXJhbShzdHJ1
Y3QgZG9tYWluICpkLCB1aW50MzJfdCBpbmRleCwgdWludDY0X3QgdmFsdWUpCiB7CiAgICAgc3Ry
dWN0IGRvbWFpbiAqY3Vycl9kID0gY3VycmVudC0+ZG9tYWluOwotICAgIHN0cnVjdCB4ZW5faHZt
X3BhcmFtIGE7Ci0gICAgc3RydWN0IGRvbWFpbiAqZDsKLSAgICBzdHJ1Y3QgdmNwdSAqdjsKICAg
ICBpbnQgcmM7CisgICAgc3RydWN0IHZjcHUgKnY7CiAKLSAgICBpZiAoIGNvcHlfZnJvbV9ndWVz
dCgmYSwgYXJnLCAxKSApCi0gICAgICAgIHJldHVybiAtRUZBVUxUOwotCi0gICAgaWYgKCBhLmlu
ZGV4ID49IEhWTV9OUl9QQVJBTVMgKQorICAgIGlmICggaW5kZXggPj0gSFZNX05SX1BBUkFNUyAp
CiAgICAgICAgIHJldHVybiAtRUlOVkFMOwogCi0gICAgLyogTWFrZSBzdXJlIHRoZSBhYm92ZSBi
b3VuZCBjaGVjayBpcyBub3QgYnlwYXNzZWQgZHVyaW5nIHNwZWN1bGF0aW9uLiAqLwotICAgIGJs
b2NrX3NwZWN1bGF0aW9uKCk7Ci0KLSAgICBkID0gcmN1X2xvY2tfZG9tYWluX2J5X2FueV9pZChh
LmRvbWlkKTsKLSAgICBpZiAoIGQgPT0gTlVMTCApCi0gICAgICAgIHJldHVybiAtRVNSQ0g7Ci0K
LSAgICByYyA9IC1FSU5WQUw7Ci0gICAgaWYgKCAhaXNfaHZtX2RvbWFpbihkKSApCi0gICAgICAg
IGdvdG8gb3V0OwotCi0gICAgcmMgPSBodm1fYWxsb3dfc2V0X3BhcmFtKGQsICZhKTsKKyAgICBy
YyA9IGh2bV9hbGxvd19zZXRfcGFyYW0oZCwgaW5kZXgsIHZhbHVlKTsKICAgICBpZiAoIHJjICkK
ICAgICAgICAgZ290byBvdXQ7CiAKLSAgICBzd2l0Y2ggKCBhLmluZGV4ICkKKyAgICBzd2l0Y2gg
KCBpbmRleCApCiAgICAgewogICAgIGNhc2UgSFZNX1BBUkFNX0NBTExCQUNLX0lSUToKLSAgICAg
ICAgaHZtX3NldF9jYWxsYmFja192aWEoZCwgYS52YWx1ZSk7CisgICAgICAgIGh2bV9zZXRfY2Fs
bGJhY2tfdmlhKGQsIHZhbHVlKTsKICAgICAgICAgaHZtX2xhdGNoX3NoaW5mb19zaXplKGQpOwog
ICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJBTV9USU1FUl9NT0RFOgotICAgICAgICBp
ZiAoIGEudmFsdWUgPiBIVk1QVE1fb25lX21pc3NlZF90aWNrX3BlbmRpbmcgKQorICAgICAgICBp
ZiAoIHZhbHVlID4gSFZNUFRNX29uZV9taXNzZWRfdGlja19wZW5kaW5nICkKICAgICAgICAgICAg
IHJjID0gLUVJTlZBTDsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fVklSSURJ
QU46Ci0gICAgICAgIGlmICggKGEudmFsdWUgJiB+SFZNUFZfZmVhdHVyZV9tYXNrKSB8fAotICAg
ICAgICAgICAgICEoYS52YWx1ZSAmIEhWTVBWX2Jhc2VfZnJlcSkgKQorICAgICAgICBpZiAoICh2
YWx1ZSAmIH5IVk1QVl9mZWF0dXJlX21hc2spIHx8CisgICAgICAgICAgICAgISh2YWx1ZSAmIEhW
TVBWX2Jhc2VfZnJlcSkgKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAgICBicmVh
azsKICAgICBjYXNlIEhWTV9QQVJBTV9JREVOVF9QVDoKQEAgLTQxODEsNyArNDE2NSw3IEBAIHN0
YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogICAgICAgICAgKi8KICAgICAgICAgaWYgKCAhcGFn
aW5nX21vZGVfaGFwKGQpIHx8ICFjcHVfaGFzX3ZteCApCiAgICAgICAgIHsKLSAgICAgICAgICAg
IGQtPmFyY2guaHZtLnBhcmFtc1thLmluZGV4XSA9IGEudmFsdWU7CisgICAgICAgICAgICBkLT5h
cmNoLmh2bS5wYXJhbXNbaW5kZXhdID0gdmFsdWU7CiAgICAgICAgICAgICBicmVhazsKICAgICAg
ICAgfQogCkBAIC00MTk2LDcgKzQxODAsNyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgK
IAogICAgICAgICByYyA9IDA7CiAgICAgICAgIGRvbWFpbl9wYXVzZShkKTsKLSAgICAgICAgZC0+
YXJjaC5odm0ucGFyYW1zW2EuaW5kZXhdID0gYS52YWx1ZTsKKyAgICAgICAgZC0+YXJjaC5odm0u
cGFyYW1zW2luZGV4XSA9IHZhbHVlOwogICAgICAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCiAg
ICAgICAgICAgICBwYWdpbmdfdXBkYXRlX2NyMyh2LCBmYWxzZSk7CiAgICAgICAgIGRvbWFpbl91
bnBhdXNlKGQpOwpAQCAtNDIwNSwyMyArNDE4OSwyMyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9w
YXJhbSgKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fRE1fRE9NQUlOOgogICAg
ICAgICAvKiBUaGUgb25seSB2YWx1ZSB0aGlzIHNob3VsZCBldmVyIGJlIHNldCB0byBpcyBET01J
RF9TRUxGICovCi0gICAgICAgIGlmICggYS52YWx1ZSAhPSBET01JRF9TRUxGICkKKyAgICAgICAg
aWYgKCB2YWx1ZSAhPSBET01JRF9TRUxGICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKIAot
ICAgICAgICBhLnZhbHVlID0gY3Vycl9kLT5kb21haW5faWQ7CisgICAgICAgIHZhbHVlID0gY3Vy
cl9kLT5kb21haW5faWQ7CiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX0FDUElf
U19TVEFURToKICAgICAgICAgcmMgPSAwOwotICAgICAgICBpZiAoIGEudmFsdWUgPT0gMyApCisg
ICAgICAgIGlmICggdmFsdWUgPT0gMyApCiAgICAgICAgICAgICBodm1fczNfc3VzcGVuZChkKTsK
LSAgICAgICAgZWxzZSBpZiAoIGEudmFsdWUgPT0gMCApCisgICAgICAgIGVsc2UgaWYgKCB2YWx1
ZSA9PSAwICkKICAgICAgICAgICAgIGh2bV9zM19yZXN1bWUoZCk7CiAgICAgICAgIGVsc2UKICAg
ICAgICAgICAgIHJjID0gLUVJTlZBTDsKIAogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9Q
QVJBTV9BQ1BJX0lPUE9SVFNfTE9DQVRJT046Ci0gICAgICAgIHJjID0gcG10aW1lcl9jaGFuZ2Vf
aW9wb3J0KGQsIGEudmFsdWUpOworICAgICAgICByYyA9IHBtdGltZXJfY2hhbmdlX2lvcG9ydChk
LCB2YWx1ZSk7CiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX01FTU9SWV9FVkVO
VF9DUjA6CiAgICAgY2FzZSBIVk1fUEFSQU1fTUVNT1JZX0VWRU5UX0NSMzoKQEAgLTQyMzYsMjQg
KzQyMjAsMjQgQEAgc3RhdGljIGludCBodm1vcF9zZXRfcGFyYW0oCiAgICAgICAgIHJjID0geHNt
X2h2bV9wYXJhbV9uZXN0ZWQoWFNNX1BSSVYsIGQpOwogICAgICAgICBpZiAoIHJjICkKICAgICAg
ICAgICAgIGJyZWFrOwotICAgICAgICBpZiAoIGEudmFsdWUgPiAxICkKKyAgICAgICAgaWYgKCB2
YWx1ZSA+IDEgKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAgICAvKgogICAgICAg
ICAgKiBSZW1vdmUgdGhlIGNoZWNrIGJlbG93IG9uY2Ugd2UgaGF2ZQogICAgICAgICAgKiBzaGFk
b3ctb24tc2hhZG93LgogICAgICAgICAgKi8KLSAgICAgICAgaWYgKCAhcGFnaW5nX21vZGVfaGFw
KGQpICYmIGEudmFsdWUgKQorICAgICAgICBpZiAoICFwYWdpbmdfbW9kZV9oYXAoZCkgJiYgdmFs
dWUgKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwotICAgICAgICBpZiAoIGEudmFsdWUgJiYK
KyAgICAgICAgaWYgKCB2YWx1ZSAmJgogICAgICAgICAgICAgIGQtPmFyY2guaHZtLnBhcmFtc1tI
Vk1fUEFSQU1fQUxUUDJNXSApCiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgIC8q
IFNldCB1cCBOSFZNIHN0YXRlIGZvciBhbnkgdmNwdXMgdGhhdCBhcmUgYWxyZWFkeSB1cC4gKi8K
LSAgICAgICAgaWYgKCBhLnZhbHVlICYmCisgICAgICAgIGlmICggdmFsdWUgJiYKICAgICAgICAg
ICAgICAhZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9ORVNURURIVk1dICkKICAgICAgICAg
ICAgIGZvcl9lYWNoX3ZjcHUoZCwgdikKICAgICAgICAgICAgICAgICBpZiAoIHJjID09IDAgKQog
ICAgICAgICAgICAgICAgICAgICByYyA9IG5lc3RlZGh2bV92Y3B1X2luaXRpYWxpc2Uodik7Ci0g
ICAgICAgIGlmICggIWEudmFsdWUgfHwgcmMgKQorICAgICAgICBpZiAoICF2YWx1ZSB8fCByYyAp
CiAgICAgICAgICAgICBmb3JfZWFjaF92Y3B1KGQsIHYpCiAgICAgICAgICAgICAgICAgbmVzdGVk
aHZtX3ZjcHVfZGVzdHJveSh2KTsKICAgICAgICAgYnJlYWs7CkBAIC00MjYxLDMwICs0MjQ1LDMw
IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogICAgICAgICByYyA9IHhzbV9odm1fcGFy
YW1fYWx0cDJtaHZtKFhTTV9QUklWLCBkKTsKICAgICAgICAgaWYgKCByYyApCiAgICAgICAgICAg
ICBicmVhazsKLSAgICAgICAgaWYgKCBhLnZhbHVlID4gWEVOX0FMVFAyTV9saW1pdGVkICkKKyAg
ICAgICAgaWYgKCB2YWx1ZSA+IFhFTl9BTFRQMk1fbGltaXRlZCApCiAgICAgICAgICAgICByYyA9
IC1FSU5WQUw7Ci0gICAgICAgIGlmICggYS52YWx1ZSAmJgorICAgICAgICBpZiAoIHZhbHVlICYm
CiAgICAgICAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9ORVNURURIVk1dICkK
ICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1f
UEFSQU1fVFJJUExFX0ZBVUxUX1JFQVNPTjoKLSAgICAgICAgaWYgKCBhLnZhbHVlID4gU0hVVERP
V05fTUFYICkKKyAgICAgICAgaWYgKCB2YWx1ZSA+IFNIVVRET1dOX01BWCApCiAgICAgICAgICAg
ICByYyA9IC1FSU5WQUw7CiAgICAgICAgIGJyZWFrOwogICAgIGNhc2UgSFZNX1BBUkFNX0lPUkVR
X1NFUlZFUl9QRk46Ci0gICAgICAgIGQtPmFyY2guaHZtLmlvcmVxX2dmbi5iYXNlID0gYS52YWx1
ZTsKKyAgICAgICAgZC0+YXJjaC5odm0uaW9yZXFfZ2ZuLmJhc2UgPSB2YWx1ZTsKICAgICAgICAg
YnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fTlJfSU9SRVFfU0VSVkVSX1BBR0VTOgogICAgIHsK
ICAgICAgICAgdW5zaWduZWQgaW50IGk7CiAKLSAgICAgICAgaWYgKCBhLnZhbHVlID09IDAgfHwK
LSAgICAgICAgICAgICBhLnZhbHVlID4gc2l6ZW9mKGQtPmFyY2guaHZtLmlvcmVxX2dmbi5tYXNr
KSAqIDggKQorICAgICAgICBpZiAoIHZhbHVlID09IDAgfHwKKyAgICAgICAgICAgICB2YWx1ZSA+
IHNpemVvZihkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubWFzaykgKiA4ICkKICAgICAgICAgewogICAg
ICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIH0KLSAg
ICAgICAgZm9yICggaSA9IDA7IGkgPCBhLnZhbHVlOyBpKysgKQorICAgICAgICBmb3IgKCBpID0g
MDsgaSA8IHZhbHVlOyBpKysgKQogICAgICAgICAgICAgc2V0X2JpdChpLCAmZC0+YXJjaC5odm0u
aW9yZXFfZ2ZuLm1hc2spOwogCiAgICAgICAgIGJyZWFrOwpAQCAtNDI5NiwzNSArNDI4MCwzNSBA
QCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgKICAgICAgICAgICAgICAgICAgICAgIHNpemVv
ZihkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubGVnYWN5X21hc2spICogOCk7CiAgICAgICAgIEJVSUxE
X0JVR19PTihIVk1fUEFSQU1fQlVGSU9SRVFfUEZOID4KICAgICAgICAgICAgICAgICAgICAgIHNp
emVvZihkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubGVnYWN5X21hc2spICogOCk7Ci0gICAgICAgIGlm
ICggYS52YWx1ZSApCi0gICAgICAgICAgICBzZXRfYml0KGEuaW5kZXgsICZkLT5hcmNoLmh2bS5p
b3JlcV9nZm4ubGVnYWN5X21hc2spOworICAgICAgICBpZiAoIHZhbHVlICkKKyAgICAgICAgICAg
IHNldF9iaXQoaW5kZXgsICZkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubGVnYWN5X21hc2spOwogICAg
ICAgICBicmVhazsKIAogICAgIGNhc2UgSFZNX1BBUkFNX1g4N19GSVBfV0lEVEg6Ci0gICAgICAg
IGlmICggYS52YWx1ZSAhPSAwICYmIGEudmFsdWUgIT0gNCAmJiBhLnZhbHVlICE9IDggKQorICAg
ICAgICBpZiAoIHZhbHVlICE9IDAgJiYgdmFsdWUgIT0gNCAmJiB2YWx1ZSAhPSA4ICkKICAgICAg
ICAgewogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAgICAgICAgYnJlYWs7CiAgICAg
ICAgIH0KLSAgICAgICAgZC0+YXJjaC54ODdfZmlwX3dpZHRoID0gYS52YWx1ZTsKKyAgICAgICAg
ZC0+YXJjaC54ODdfZmlwX3dpZHRoID0gdmFsdWU7CiAgICAgICAgIGJyZWFrOwogCiAgICAgY2Fz
ZSBIVk1fUEFSQU1fVk04Nl9UU1M6CiAgICAgICAgIC8qIEhhcmR3YXJlIHdvdWxkIHNpbGVudGx5
IHRydW5jYXRlIGhpZ2ggYml0cy4gKi8KLSAgICAgICAgaWYgKCBhLnZhbHVlICE9ICh1aW50MzJf
dClhLnZhbHVlICkKKyAgICAgICAgaWYgKCB2YWx1ZSAhPSAodWludDMyX3QpdmFsdWUgKQogICAg
ICAgICB7CiAgICAgICAgICAgICBpZiAoIGQgPT0gY3Vycl9kICkKICAgICAgICAgICAgICAgICBk
b21haW5fY3Jhc2goZCk7CiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgIH0KICAg
ICAgICAgLyogT2xkIGh2bWxvYWRlciBiaW5hcmllcyBoYXJkY29kZSB0aGUgc2l6ZSB0byAxMjgg
Ynl0ZXMuICovCi0gICAgICAgIGlmICggYS52YWx1ZSApCi0gICAgICAgICAgICBhLnZhbHVlIHw9
ICgxMjhVTEwgPDwgMzIpIHwgVk04Nl9UU1NfVVBEQVRFRDsKLSAgICAgICAgYS5pbmRleCA9IEhW
TV9QQVJBTV9WTTg2X1RTU19TSVpFRDsKKyAgICAgICAgaWYgKCB2YWx1ZSApCisgICAgICAgICAg
ICB2YWx1ZSB8PSAoMTI4VUxMIDw8IDMyKSB8IFZNODZfVFNTX1VQREFURUQ7CisgICAgICAgIGlu
ZGV4ID0gSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEOwogICAgICAgICBicmVhazsKIAogICAgIGNh
c2UgSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEOgotICAgICAgICBpZiAoIChhLnZhbHVlID4+IDMy
KSA8IHNpemVvZihzdHJ1Y3QgdHNzMzIpICkKKyAgICAgICAgaWYgKCAodmFsdWUgPj4gMzIpIDwg
c2l6ZW9mKHN0cnVjdCB0c3MzMikgKQogICAgICAgICB7CiAgICAgICAgICAgICBpZiAoIGQgPT0g
Y3Vycl9kICkKICAgICAgICAgICAgICAgICBkb21haW5fY3Jhc2goZCk7CkBAIC00MzM1LDI2ICs0
MzE5LDU2IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogICAgICAgICAgKiAyNTYgYml0
cyBpbnRlcnJ1cHQgcmVkaXJlY3Rpb24gYml0bWFwICsgNjRrIGJpdHMgSS9PIGJpdG1hcAogICAg
ICAgICAgKiBwbHVzIG9uZSBwYWRkaW5nIGJ5dGUpLgogICAgICAgICAgKi8KLSAgICAgICAgaWYg
KCAoYS52YWx1ZSA+PiAzMikgPiBzaXplb2Yoc3RydWN0IHRzczMyKSArCisgICAgICAgIGlmICgg
KHZhbHVlID4+IDMyKSA+IHNpemVvZihzdHJ1Y3QgdHNzMzIpICsKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAoMHgxMDAgLyA4KSArICgweDEwMDAwIC8gOCkgKyAxICkKLSAgICAgICAg
ICAgIGEudmFsdWUgPSAodWludDMyX3QpYS52YWx1ZSB8CisgICAgICAgICAgICB2YWx1ZSA9ICh1
aW50MzJfdCl2YWx1ZSB8CiAgICAgICAgICAgICAgICAgICAgICAgKChzaXplb2Yoc3RydWN0IHRz
czMyKSArICgweDEwMCAvIDgpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgKDB4MTAwMDAgLyA4KSArIDEpIDw8IDMyKTsKLSAgICAgICAgYS52YWx1ZSB8
PSBWTTg2X1RTU19VUERBVEVEOworICAgICAgICB2YWx1ZSB8PSBWTTg2X1RTU19VUERBVEVEOwog
ICAgICAgICBicmVhazsKIAogICAgIGNhc2UgSFZNX1BBUkFNX01DQV9DQVA6Ci0gICAgICAgIHJj
ID0gdm1jZV9lbmFibGVfbWNhX2NhcChkLCBhLnZhbHVlKTsKKyAgICAgICAgcmMgPSB2bWNlX2Vu
YWJsZV9tY2FfY2FwKGQsIHZhbHVlKTsKICAgICAgICAgYnJlYWs7CiAgICAgfQogCiAgICAgaWYg
KCByYyAhPSAwICkKICAgICAgICAgZ290byBvdXQ7CiAKLSAgICBkLT5hcmNoLmh2bS5wYXJhbXNb
YS5pbmRleF0gPSBhLnZhbHVlOworICAgIGQtPmFyY2guaHZtLnBhcmFtc1tpbmRleF0gPSB2YWx1
ZTsKIAogICAgIEhWTV9EQkdfTE9HKERCR19MRVZFTF9IQ0FMTCwgInNldCBwYXJhbSAldSA9ICUi
UFJJeDY0LAotICAgICAgICAgICAgICAgIGEuaW5kZXgsIGEudmFsdWUpOworICAgICAgICAgICAg
ICAgIGluZGV4LCB2YWx1ZSk7CisKKyBvdXQ6CisgICAgcmV0dXJuIHJjOworfQorCitpbnQgaHZt
b3Bfc2V0X3BhcmFtKAorICAgIFhFTl9HVUVTVF9IQU5ETEVfUEFSQU0oeGVuX2h2bV9wYXJhbV90
KSBhcmcpCit7CisgICAgc3RydWN0IHhlbl9odm1fcGFyYW0gYTsKKyAgICBzdHJ1Y3QgZG9tYWlu
ICpkOworICAgIGludCByYzsKKworICAgIGlmICggY29weV9mcm9tX2d1ZXN0KCZhLCBhcmcsIDEp
ICkKKyAgICAgICAgcmV0dXJuIC1FRkFVTFQ7CisKKyAgICBpZiAoIGEuaW5kZXggPj0gSFZNX05S
X1BBUkFNUyApCisgICAgICAgIHJldHVybiAtRUlOVkFMOworCisgICAgLyogTWFrZSBzdXJlIHRo
ZSBhYm92ZSBib3VuZCBjaGVjayBpcyBub3QgYnlwYXNzZWQgZHVyaW5nIHNwZWN1bGF0aW9uLiAq
LworICAgIGJsb2NrX3NwZWN1bGF0aW9uKCk7CisKKyAgICBkID0gcmN1X2xvY2tfZG9tYWluX2J5
X2FueV9pZChhLmRvbWlkKTsKKyAgICBpZiAoIGQgPT0gTlVMTCApCisgICAgICAgIHJldHVybiAt
RVNSQ0g7CisKKyAgICByYyA9IC1FSU5WQUw7CisgICAgaWYgKCAhaXNfaHZtX2RvbWFpbihkKSAp
CisgICAgICAgIGdvdG8gb3V0OworCisgICAgcmMgPSBodm1fc2V0X3BhcmFtKGQsIGEuaW5kZXgs
IGEudmFsdWUpOwogCiAgb3V0OgogICAgIHJjdV91bmxvY2tfZG9tYWluKGQpOwpAQCAtNDM2Miw3
ICs0Mzc2LDcgQEAgc3RhdGljIGludCBodm1vcF9zZXRfcGFyYW0oCiB9CiAKIHN0YXRpYyBpbnQg
aHZtX2FsbG93X2dldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAotICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGNvbnN0IHN0cnVjdCB4ZW5faHZtX3BhcmFtICphKQorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIHVpbnQzMl90IGluZGV4KQogewogICAgIGludCByYzsKIApAQCAt
NDM3MCw3ICs0Mzg0LDcgQEAgc3RhdGljIGludCBodm1fYWxsb3dfZ2V0X3BhcmFtKHN0cnVjdCBk
b21haW4gKmQsCiAgICAgaWYgKCByYyApCiAgICAgICAgIHJldHVybiByYzsKIAotICAgIHN3aXRj
aCAoIGEtPmluZGV4ICkKKyAgICBzd2l0Y2ggKCBpbmRleCApCiAgICAgewogICAgIC8qIFRoZSBm
b2xsb3dpbmcgcGFyYW1ldGVycyBjYW4gYmUgcmVhZCBieSB0aGUgZ3Vlc3QuICovCiAgICAgY2Fz
ZSBIVk1fUEFSQU1fQ0FMTEJBQ0tfSVJROgpAQCAtNDQwMCw2ICs0NDE0LDQzIEBAIHN0YXRpYyBp
bnQgaHZtX2FsbG93X2dldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHJldHVybiByYzsK
IH0KIAorc3RhdGljIGludCBodm1fZ2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsIHVpbnQzMl90
IGluZGV4LCB1aW50NjRfdCAqdmFsdWUpCit7CisgICAgaW50IHJjOworCisgICAgaWYgKCBpbmRl
eCA+PSBIVk1fTlJfUEFSQU1TIHx8ICF2YWx1ZSApCisgICAgICAgIHJldHVybiAtRUlOVkFMOwor
CisgICAgcmMgPSBodm1fYWxsb3dfZ2V0X3BhcmFtKGQsIGluZGV4KTsKKyAgICBpZiAoIHJjICkK
KyAgICAgICAgcmV0dXJuIHJjOworCisgICAgc3dpdGNoICggaW5kZXggKQorICAgIHsKKyAgICBj
YXNlIEhWTV9QQVJBTV9BQ1BJX1NfU1RBVEU6CisgICAgICAgICp2YWx1ZSA9IGQtPmFyY2guaHZt
LmlzX3MzX3N1c3BlbmRlZCA/IDMgOiAwOworICAgICAgICBicmVhazsKKworICAgIGNhc2UgSFZN
X1BBUkFNX1ZNODZfVFNTOgorICAgICAgICAqdmFsdWUgPSAodWludDMyX3QpZC0+YXJjaC5odm0u
cGFyYW1zW0hWTV9QQVJBTV9WTTg2X1RTU19TSVpFRF07CisgICAgICAgIGJyZWFrOworCisgICAg
Y2FzZSBIVk1fUEFSQU1fVk04Nl9UU1NfU0laRUQ6CisgICAgICAgICp2YWx1ZSA9IGQtPmFyY2gu
aHZtLnBhcmFtc1tIVk1fUEFSQU1fVk04Nl9UU1NfU0laRURdICYKKyAgICAgICAgICAgICAgICAg
ICB+Vk04Nl9UU1NfVVBEQVRFRDsKKyAgICAgICAgYnJlYWs7CisKKyAgICBjYXNlIEhWTV9QQVJB
TV9YODdfRklQX1dJRFRIOgorICAgICAgICAqdmFsdWUgPSBkLT5hcmNoLng4N19maXBfd2lkdGg7
CisgICAgICAgIGJyZWFrOworICAgIGRlZmF1bHQ6CisgICAgICAgICp2YWx1ZSA9IGQtPmFyY2gu
aHZtLnBhcmFtc1tpbmRleF07CisgICAgICAgIGJyZWFrOworICAgIH0KKworICAgIHJldHVybiAw
OworfTsKKwogc3RhdGljIGludCBodm1vcF9nZXRfcGFyYW0oCiAgICAgWEVOX0dVRVNUX0hBTkRM
RV9QQVJBTSh4ZW5faHZtX3BhcmFtX3QpIGFyZykKIHsKQEAgLTQ0MjQsMzMgKzQ0NzUsMTAgQEAg
c3RhdGljIGludCBodm1vcF9nZXRfcGFyYW0oCiAgICAgaWYgKCAhaXNfaHZtX2RvbWFpbihkKSAp
CiAgICAgICAgIGdvdG8gb3V0OwogCi0gICAgcmMgPSBodm1fYWxsb3dfZ2V0X3BhcmFtKGQsICZh
KTsKKyAgICByYyA9IGh2bV9nZXRfcGFyYW0oZCwgYS5pbmRleCwgJmEudmFsdWUpOwogICAgIGlm
ICggcmMgKQogICAgICAgICBnb3RvIG91dDsKIAotICAgIHN3aXRjaCAoIGEuaW5kZXggKQotICAg
IHsKLSAgICBjYXNlIEhWTV9QQVJBTV9BQ1BJX1NfU1RBVEU6Ci0gICAgICAgIGEudmFsdWUgPSBk
LT5hcmNoLmh2bS5pc19zM19zdXNwZW5kZWQgPyAzIDogMDsKLSAgICAgICAgYnJlYWs7Ci0KLSAg
ICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RTUzoKLSAgICAgICAgYS52YWx1ZSA9ICh1aW50MzJfdClk
LT5hcmNoLmh2bS5wYXJhbXNbSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEXTsKLSAgICAgICAgYnJl
YWs7Ci0KLSAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RTU19TSVpFRDoKLSAgICAgICAgYS52YWx1
ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1fVk04Nl9UU1NfU0laRURdICYKLSAgICAg
ICAgICAgICAgICAgIH5WTTg2X1RTU19VUERBVEVEOwotICAgICAgICBicmVhazsKLQotICAgIGNh
c2UgSFZNX1BBUkFNX1g4N19GSVBfV0lEVEg6Ci0gICAgICAgIGEudmFsdWUgPSBkLT5hcmNoLng4
N19maXBfd2lkdGg7Ci0gICAgICAgIGJyZWFrOwotICAgIGRlZmF1bHQ6Ci0gICAgICAgIGEudmFs
dWUgPSBkLT5hcmNoLmh2bS5wYXJhbXNbYS5pbmRleF07Ci0gICAgICAgIGJyZWFrOwotICAgIH0K
LQogICAgIHJjID0gX19jb3B5X3RvX2d1ZXN0KGFyZywgJmEsIDEpID8gLUVGQVVMVCA6IDA7CiAK
ICAgICBIVk1fREJHX0xPRyhEQkdfTEVWRUxfSENBTEwsICJnZXQgcGFyYW0gJXUgPSAlIlBSSXg2
NCwKQEAgLTUyNjYsNiArNTI5NCwzNiBAQCB2b2lkIGh2bV9zZXRfc2VnbWVudF9yZWdpc3Rlcihz
dHJ1Y3QgdmNwdSAqdiwgZW51bSB4ODZfc2VnbWVudCBzZWcsCiAgICAgYWx0ZXJuYXRpdmVfdmNh
bGwoaHZtX2Z1bmNzLnNldF9zZWdtZW50X3JlZ2lzdGVyLCB2LCBzZWcsIHJlZyk7CiB9CiAKK2lu
dCBodm1fY29weV9jb250ZXh0X2FuZF9wYXJhbXMoc3RydWN0IGRvbWFpbiAqc3JjLCBzdHJ1Y3Qg
ZG9tYWluICpkc3QpCit7CisgICAgaW50IHJjLCBpOworICAgIHN0cnVjdCBodm1fZG9tYWluX2Nv
bnRleHQgYyA9IHsgfTsKKworICAgIGZvciAoIGkgPSAwOyBpIDwgSFZNX05SX1BBUkFNUzsgaSsr
ICkKKyAgICB7CisgICAgICAgIHVpbnQ2NF90IHZhbHVlID0gMDsKKworICAgICAgICBpZiAoIGh2
bV9nZXRfcGFyYW0oc3JjLCBpLCAmdmFsdWUpIHx8ICF2YWx1ZSApCisgICAgICAgICAgICBjb250
aW51ZTsKKworICAgICAgICBpZiAoIChyYyA9IGh2bV9zZXRfcGFyYW0oZHN0LCBpLCB2YWx1ZSkp
ICkKKyAgICAgICAgICAgIHJldHVybiByYzsKKyAgICB9CisKKyAgICBjLnNpemUgPSBodm1fc2F2
ZV9zaXplKHNyYyk7CisgICAgaWYgKCAoYy5kYXRhID0gdm1hbGxvYyhjLnNpemUpKSA9PSBOVUxM
ICkKKyAgICAgICAgcmV0dXJuIC1FTk9NRU07CisKKyAgICBpZiAoICEocmMgPSBodm1fc2F2ZShz
cmMsICZjKSkgKQorICAgIHsKKyAgICAgICAgYy5jdXIgPSAwOworICAgICAgICByYyA9IGh2bV9s
b2FkKGRzdCwgJmMpOworICAgIH0KKworICAgIHZmcmVlKGMuZGF0YSk7CisgICAgcmV0dXJuIHJj
OworfQorCiAvKgogICogTG9jYWwgdmFyaWFibGVzOgogICogbW9kZTogQwpkaWZmIC0tZ2l0IGEv
eGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vaHZtLmggYi94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9o
dm0uaAppbmRleCAwOTc5M2MxMmU5Li42MTA2YjgyYzk1IDEwMDY0NAotLS0gYS94ZW4vaW5jbHVk
ZS9hc20teDg2L2h2bS9odm0uaAorKysgYi94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaApA
QCAtMzM2LDYgKzMzNiw4IEBAIHVuc2lnbmVkIGxvbmcgaHZtX2NyNF9ndWVzdF92YWxpZF9iaXRz
KGNvbnN0IHN0cnVjdCBkb21haW4gKmQsIGJvb2wgcmVzdG9yZSk7CiBib29sIGh2bV9mbHVzaF92
Y3B1X3RsYihib29sICgqZmx1c2hfdmNwdSkodm9pZCAqY3R4dCwgc3RydWN0IHZjcHUgKnYpLAog
ICAgICAgICAgICAgICAgICAgICAgICAgdm9pZCAqY3R4dCk7CiAKK2ludCBodm1fY29weV9jb250
ZXh0X2FuZF9wYXJhbXMoc3RydWN0IGRvbWFpbiAqc3JjLCBzdHJ1Y3QgZG9tYWluICpkc3QpOwor
CiAjaWZkZWYgQ09ORklHX0hWTQogCiAjZGVmaW5lIGh2bV9nZXRfZ3Vlc3RfdHNjKHYpIGh2bV9n
ZXRfZ3Vlc3RfdHNjX2ZpeGVkKHYsIDApCi0tIAoyLjIwLjEKCgpfX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1k
ZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21h
aWxtYW4vbGlzdGluZm8veGVuLWRldmVs

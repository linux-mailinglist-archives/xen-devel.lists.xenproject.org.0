Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 361C2177D56
	for <lists+xen-devel@lfdr.de>; Tue,  3 Mar 2020 18:24:05 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j9BEG-0007Rc-Bj; Tue, 03 Mar 2020 17:21:12 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=Dy3W=4U=citrix.com=roger.pau@srs-us1.protection.inumbo.net>)
 id 1j9BEE-0007R0-MU
 for xen-devel@lists.xenproject.org; Tue, 03 Mar 2020 17:21:10 +0000
X-Inumbo-ID: 5e5e0cf2-5d73-11ea-a1d1-12813bfff9fa
Received: from esa1.hc3370-68.iphmx.com (unknown [216.71.145.142])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 5e5e0cf2-5d73-11ea-a1d1-12813bfff9fa;
 Tue, 03 Mar 2020 17:21:07 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1583256068;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=RvKGTTAMFbfbu2wkCeN52kNt/+inpH4s6rTLJxQYrgc=;
 b=bpnfAzRo1Jj6MH5XHgkXEz8Pyvuc/EQAfGUeocuksMLPpMWoEQknk8cZ
 uWXnhp7F70bDfQFXI5ZgY4yHhScshb2T81CwnVg7mdFgglUdg4mt8Ys+7
 NBSl4SfRDTnFmVlURcHocb0Kp1HiP4j3z1i3uMvx0EiiuFrMwuVpAET8c 8=;
Authentication-Results: esa1.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=roger.pau@citrix.com;
 spf=Pass smtp.mailfrom=roger.pau@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa1.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 roger.pau@citrix.com) identity=pra; client-ip=162.221.158.21;
 receiver=esa1.hc3370-68.iphmx.com;
 envelope-from="roger.pau@citrix.com";
 x-sender="roger.pau@citrix.com"; x-conformance=sidf_compatible
Received-SPF: Pass (esa1.hc3370-68.iphmx.com: domain of
 roger.pau@citrix.com designates 162.221.158.21 as permitted
 sender) identity=mailfrom; client-ip=162.221.158.21;
 receiver=esa1.hc3370-68.iphmx.com;
 envelope-from="roger.pau@citrix.com";
 x-sender="roger.pau@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83
 ip4:168.245.78.127 ~all"
Received-SPF: None (esa1.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa1.hc3370-68.iphmx.com;
 envelope-from="roger.pau@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: De1icEufwIgbLLB259t/CoI4EdBRTUEr1qGahlW6sOYPUdRuMixCDhrTnQXkLw31Zt/0KUmkaf
 hsA5HFYk9n53zVv89cH2eOTPh1uFKBLS94N+ptqWsuhkd8E5UiAmIqe8QkK6uVqIS9GVl9wmQ1
 KqJZAelsrGE8pai38KfONm9s8Bs4k6c0Ck4ZIbuPjLcM1B1+XqnkiBV0ZrqfPrZ+YCZ53f+rr3
 +3eypH/+Bxrff9XLUUF/V8wmKb7JVUhoC0hF6JO2neUKyVylqRHJ490my44mDBy57b2kWPbVtY
 ltY=
X-SBRS: 2.7
X-MesageID: 13528282
X-Ironport-Server: esa1.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.70,511,1574139600"; d="scan'208";a="13528282"
From: Roger Pau Monne <roger.pau@citrix.com>
To: <xen-devel@lists.xenproject.org>
Date: Tue, 3 Mar 2020 18:20:42 +0100
Message-ID: <20200303172046.50569-3-roger.pau@citrix.com>
X-Mailer: git-send-email 2.25.0
In-Reply-To: <20200303172046.50569-1-roger.pau@citrix.com>
References: <20200303172046.50569-1-roger.pau@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v6 2/6] x86/paging: add TLB flush hooks
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Wei Liu <wl@xen.org>, Andrew Cooper <andrew.cooper3@citrix.com>,
 Paul Durrant <pdurrant@amazon.com>, Tim Deegan <tim@xen.org>,
 George Dunlap <george.dunlap@citrix.com>, Jan Beulich <jbeulich@suse.com>,
 Roger Pau Monne <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QWRkIHNoYWRvdyBhbmQgaGFwIGltcGxlbWVudGF0aW9uIHNwZWNpZmljIGhlbHBlcnMgdG8gcGVy
Zm9ybSBndWVzdApUTEIgZmx1c2hlcy4gTm90ZSB0aGF0IHRoZSBjb2RlIGZvciBib3RoIGlzIGV4
YWN0bHkgdGhlIHNhbWUgYXQgdGhlCm1vbWVudCwgYW5kIGlzIGNvcGllZCBmcm9tIGh2bV9mbHVz
aF92Y3B1X3RsYi4gVGhpcyB3aWxsIGJlIGNoYW5nZWQgYnkKZnVydGhlciBwYXRjaGVzIHRoYXQg
d2lsbCBhZGQgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMgb3B0aW1pemF0aW9ucyB0bwp0aGVtLgoK
Tm8gZnVuY3Rpb25hbCBjaGFuZ2UgaW50ZW5kZWQuCgpTaWduZWQtb2ZmLWJ5OiBSb2dlciBQYXUg
TW9ubsOpIDxyb2dlci5wYXVAY2l0cml4LmNvbT4KUmV2aWV3ZWQtYnk6IFdlaSBMaXUgPHdsQHhl
bi5vcmc+CkFja2VkLWJ5OiBUaW0gRGVlZ2FuIDx0aW1AeGVuLm9yZz4KLS0tCkNoYW5nZXMgc2lu
Y2UgdjU6CiAtIE1ha2UgdGhlIGZsdXNoIHRsYiBvcGVyYXRpb24gYSBwYWdpbmdfbW9kZSBob29r
LgoKQ2hhbmdlcyBzaW5jZSB2MzoKIC0gRml4IHN0cmF5IG5ld2xpbmUgcmVtb3ZhbC4KIC0gRml4
IHJldHVybiBvZiBzaGFkb3dfZmx1c2hfdGxiIGR1bW15IGZ1bmN0aW9uLgotLS0KIHhlbi9hcmNo
L3g4Ni9odm0vaHZtLmMgICAgICAgICAgICAgICB8IDU2ICstLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLQogeGVuL2FyY2gveDg2L2h2bS92aXJpZGlhbi92aXJpZGlhbi5jIHwgIDIgKy0KIHhlbi9h
cmNoL3g4Ni9tbS9oYXAvaGFwLmMgICAgICAgICAgICB8IDU4ICsrKysrKysrKysrKysrKysrKysr
KysrKysrKysKIHhlbi9hcmNoL3g4Ni9tbS9zaGFkb3cvY29tbW9uLmMgICAgICB8IDU1ICsrKysr
KysrKysrKysrKysrKysrKysrKysrCiB4ZW4vYXJjaC94ODYvbW0vc2hhZG93L211bHRpLmMgICAg
ICAgfCAgMSArCiB4ZW4vYXJjaC94ODYvbW0vc2hhZG93L3ByaXZhdGUuaCAgICAgfCAgNCArKwog
eGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vaHZtLmggICAgICAgIHwgIDMgLS0KIHhlbi9pbmNsdWRl
L2FzbS14ODYvcGFnaW5nLmggICAgICAgICB8IDEwICsrKysrCiA4IGZpbGVzIGNoYW5nZWQsIDEz
MCBpbnNlcnRpb25zKCspLCA1OSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94
ODYvaHZtL2h2bS5jIGIveGVuL2FyY2gveDg2L2h2bS9odm0uYwppbmRleCBkYjVkN2I0ZDMwLi5h
MmFiYWQ5Zjc2IDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCisrKyBiL3hlbi9h
cmNoL3g4Ni9odm0vaHZtLmMKQEAgLTM5ODgsNjAgKzM5ODgsNiBAQCBzdGF0aWMgdm9pZCBodm1f
czNfcmVzdW1lKHN0cnVjdCBkb21haW4gKmQpCiAgICAgfQogfQogCi1ib29sIGh2bV9mbHVzaF92
Y3B1X3RsYihib29sICgqZmx1c2hfdmNwdSkodm9pZCAqY3R4dCwgc3RydWN0IHZjcHUgKnYpLAot
ICAgICAgICAgICAgICAgICAgICAgICAgdm9pZCAqY3R4dCkKLXsKLSAgICBzdGF0aWMgREVGSU5F
X1BFUl9DUFUoY3B1bWFza190LCBmbHVzaF9jcHVtYXNrKTsKLSAgICBjcHVtYXNrX3QgKm1hc2sg
PSAmdGhpc19jcHUoZmx1c2hfY3B1bWFzayk7Ci0gICAgc3RydWN0IGRvbWFpbiAqZCA9IGN1cnJl
bnQtPmRvbWFpbjsKLSAgICBzdHJ1Y3QgdmNwdSAqdjsKLQotICAgIC8qIEF2b2lkIGRlYWRsb2Nr
IGlmIG1vcmUgdGhhbiBvbmUgdmNwdSB0cmllcyB0aGlzIGF0IHRoZSBzYW1lIHRpbWUuICovCi0g
ICAgaWYgKCAhc3Bpbl90cnlsb2NrKCZkLT5oeXBlcmNhbGxfZGVhZGxvY2tfbXV0ZXgpICkKLSAg
ICAgICAgcmV0dXJuIGZhbHNlOwotCi0gICAgLyogUGF1c2UgYWxsIG90aGVyIHZjcHVzLiAqLwot
ICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKLSAgICAgICAgaWYgKCB2ICE9IGN1cnJlbnQgJiYg
Zmx1c2hfdmNwdShjdHh0LCB2KSApCi0gICAgICAgICAgICB2Y3B1X3BhdXNlX25vc3luYyh2KTsK
LQotICAgIC8qIE5vdyB0aGF0IGFsbCBWQ1BVcyBhcmUgc2lnbmFsbGVkIHRvIGRlc2NoZWR1bGUs
IHdlIHdhaXQuLi4gKi8KLSAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCi0gICAgICAgIGlmICgg
diAhPSBjdXJyZW50ICYmIGZsdXNoX3ZjcHUoY3R4dCwgdikgKQotICAgICAgICAgICAgd2hpbGUg
KCAhdmNwdV9ydW5uYWJsZSh2KSAmJiB2LT5pc19ydW5uaW5nICkKLSAgICAgICAgICAgICAgICBj
cHVfcmVsYXgoKTsKLQotICAgIC8qIEFsbCBvdGhlciB2Y3B1cyBhcmUgcGF1c2VkLCBzYWZlIHRv
IHVubG9jayBub3cuICovCi0gICAgc3Bpbl91bmxvY2soJmQtPmh5cGVyY2FsbF9kZWFkbG9ja19t
dXRleCk7Ci0KLSAgICBjcHVtYXNrX2NsZWFyKG1hc2spOwotCi0gICAgLyogRmx1c2ggcGFnaW5n
LW1vZGUgc29mdCBzdGF0ZSAoZS5nLiwgdmEtPmdmbiBjYWNoZTsgUEFFIFBEUEUgY2FjaGUpLiAq
LwotICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKLSAgICB7Ci0gICAgICAgIHVuc2lnbmVkIGlu
dCBjcHU7Ci0KLSAgICAgICAgaWYgKCAhZmx1c2hfdmNwdShjdHh0LCB2KSApCi0gICAgICAgICAg
ICBjb250aW51ZTsKLQotICAgICAgICBwYWdpbmdfdXBkYXRlX2NyMyh2LCBmYWxzZSk7Ci0KLSAg
ICAgICAgY3B1ID0gcmVhZF9hdG9taWMoJnYtPmRpcnR5X2NwdSk7Ci0gICAgICAgIGlmICggaXNf
dmNwdV9kaXJ0eV9jcHUoY3B1KSApCi0gICAgICAgICAgICBfX2NwdW1hc2tfc2V0X2NwdShjcHUs
IG1hc2spOwotICAgIH0KLQotICAgIC8qIEZsdXNoIFRMQnMgb24gYWxsIENQVXMgd2l0aCBkaXJ0
eSB2Y3B1IHN0YXRlLiAqLwotICAgIGZsdXNoX3RsYl9tYXNrKG1hc2spOwotCi0gICAgLyogRG9u
ZS4gKi8KLSAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCi0gICAgICAgIGlmICggdiAhPSBjdXJy
ZW50ICYmIGZsdXNoX3ZjcHUoY3R4dCwgdikgKQotICAgICAgICAgICAgdmNwdV91bnBhdXNlKHYp
OwotCi0gICAgcmV0dXJuIHRydWU7Ci19Ci0KIHN0YXRpYyBib29sIGFsd2F5c19mbHVzaCh2b2lk
ICpjdHh0LCBzdHJ1Y3QgdmNwdSAqdikKIHsKICAgICByZXR1cm4gdHJ1ZTsKQEAgLTQwNTIsNyAr
Mzk5OCw3IEBAIHN0YXRpYyBpbnQgaHZtb3BfZmx1c2hfdGxiX2FsbCh2b2lkKQogICAgIGlmICgg
IWlzX2h2bV9kb21haW4oY3VycmVudC0+ZG9tYWluKSApCiAgICAgICAgIHJldHVybiAtRUlOVkFM
OwogCi0gICAgcmV0dXJuIGh2bV9mbHVzaF92Y3B1X3RsYihhbHdheXNfZmx1c2gsIE5VTEwpID8g
MCA6IC1FUkVTVEFSVDsKKyAgICByZXR1cm4gcGFnaW5nX2ZsdXNoX3RsYihhbHdheXNfZmx1c2gs
IE5VTEwpID8gMCA6IC1FUkVTVEFSVDsKIH0KIAogc3RhdGljIGludCBodm1vcF9zZXRfZXZ0Y2hu
X3VwY2FsbF92ZWN0b3IoCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvaHZtL3ZpcmlkaWFuL3Zp
cmlkaWFuLmMgYi94ZW4vYXJjaC94ODYvaHZtL3ZpcmlkaWFuL3ZpcmlkaWFuLmMKaW5kZXggY2Q4
ZjIxMDE5OC4uOTc3YzFiYzU0ZiAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L2h2bS92aXJpZGlh
bi92aXJpZGlhbi5jCisrKyBiL3hlbi9hcmNoL3g4Ni9odm0vdmlyaWRpYW4vdmlyaWRpYW4uYwpA
QCAtNjA5LDcgKzYwOSw3IEBAIGludCB2aXJpZGlhbl9oeXBlcmNhbGwoc3RydWN0IGNwdV91c2Vy
X3JlZ3MgKnJlZ3MpCiAgICAgICAgICAqIEEgZmFsc2UgcmV0dXJuIG1lYW5zIHRoYXQgYW5vdGhl
ciB2Y3B1IGlzIGN1cnJlbnRseSB0cnlpbmcKICAgICAgICAgICogYSBzaW1pbGFyIG9wZXJhdGlv
biwgc28gYmFjayBvZmYuCiAgICAgICAgICAqLwotICAgICAgICBpZiAoICFodm1fZmx1c2hfdmNw
dV90bGIobmVlZF9mbHVzaCwgJmlucHV0X3BhcmFtcy52Y3B1X21hc2spICkKKyAgICAgICAgaWYg
KCAhcGFnaW5nX2ZsdXNoX3RsYihuZWVkX2ZsdXNoLCAmaW5wdXRfcGFyYW1zLnZjcHVfbWFzaykg
KQogICAgICAgICAgICAgcmV0dXJuIEhWTV9IQ0FMTF9wcmVlbXB0ZWQ7CiAKICAgICAgICAgb3V0
cHV0LnJlcF9jb21wbGV0ZSA9IGlucHV0LnJlcF9jb3VudDsKZGlmZiAtLWdpdCBhL3hlbi9hcmNo
L3g4Ni9tbS9oYXAvaGFwLmMgYi94ZW4vYXJjaC94ODYvbW0vaGFwL2hhcC5jCmluZGV4IDNkOTNm
MzQ1MWMuLjU2MTYyMzViZDggMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9tbS9oYXAvaGFwLmMK
KysrIGIveGVuL2FyY2gveDg2L21tL2hhcC9oYXAuYwpAQCAtNjY5LDYgKzY2OSw2MCBAQCBzdGF0
aWMgdm9pZCBoYXBfdXBkYXRlX2NyMyhzdHJ1Y3QgdmNwdSAqdiwgaW50IGRvX2xvY2tpbmcsIGJv
b2wgbm9mbHVzaCkKICAgICBodm1fdXBkYXRlX2d1ZXN0X2NyMyh2LCBub2ZsdXNoKTsKIH0KIAor
c3RhdGljIGJvb2wgZmx1c2hfdGxiKGJvb2wgKCpmbHVzaF92Y3B1KSh2b2lkICpjdHh0LCBzdHJ1
Y3QgdmNwdSAqdiksCisgICAgICAgICAgICAgICAgICAgICAgdm9pZCAqY3R4dCkKK3sKKyAgICBz
dGF0aWMgREVGSU5FX1BFUl9DUFUoY3B1bWFza190LCBmbHVzaF9jcHVtYXNrKTsKKyAgICBjcHVt
YXNrX3QgKm1hc2sgPSAmdGhpc19jcHUoZmx1c2hfY3B1bWFzayk7CisgICAgc3RydWN0IGRvbWFp
biAqZCA9IGN1cnJlbnQtPmRvbWFpbjsKKyAgICBzdHJ1Y3QgdmNwdSAqdjsKKworICAgIC8qIEF2
b2lkIGRlYWRsb2NrIGlmIG1vcmUgdGhhbiBvbmUgdmNwdSB0cmllcyB0aGlzIGF0IHRoZSBzYW1l
IHRpbWUuICovCisgICAgaWYgKCAhc3Bpbl90cnlsb2NrKCZkLT5oeXBlcmNhbGxfZGVhZGxvY2tf
bXV0ZXgpICkKKyAgICAgICAgcmV0dXJuIGZhbHNlOworCisgICAgLyogUGF1c2UgYWxsIG90aGVy
IHZjcHVzLiAqLworICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICAgICAgaWYgKCB2ICE9
IGN1cnJlbnQgJiYgZmx1c2hfdmNwdShjdHh0LCB2KSApCisgICAgICAgICAgICB2Y3B1X3BhdXNl
X25vc3luYyh2KTsKKworICAgIC8qIE5vdyB0aGF0IGFsbCBWQ1BVcyBhcmUgc2lnbmFsbGVkIHRv
IGRlc2NoZWR1bGUsIHdlIHdhaXQuLi4gKi8KKyAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCisg
ICAgICAgIGlmICggdiAhPSBjdXJyZW50ICYmIGZsdXNoX3ZjcHUoY3R4dCwgdikgKQorICAgICAg
ICAgICAgd2hpbGUgKCAhdmNwdV9ydW5uYWJsZSh2KSAmJiB2LT5pc19ydW5uaW5nICkKKyAgICAg
ICAgICAgICAgICBjcHVfcmVsYXgoKTsKKworICAgIC8qIEFsbCBvdGhlciB2Y3B1cyBhcmUgcGF1
c2VkLCBzYWZlIHRvIHVubG9jayBub3cuICovCisgICAgc3Bpbl91bmxvY2soJmQtPmh5cGVyY2Fs
bF9kZWFkbG9ja19tdXRleCk7CisKKyAgICBjcHVtYXNrX2NsZWFyKG1hc2spOworCisgICAgLyog
Rmx1c2ggcGFnaW5nLW1vZGUgc29mdCBzdGF0ZSAoZS5nLiwgdmEtPmdmbiBjYWNoZTsgUEFFIFBE
UEUgY2FjaGUpLiAqLworICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICB7CisgICAgICAg
IHVuc2lnbmVkIGludCBjcHU7CisKKyAgICAgICAgaWYgKCAhZmx1c2hfdmNwdShjdHh0LCB2KSAp
CisgICAgICAgICAgICBjb250aW51ZTsKKworICAgICAgICBwYWdpbmdfdXBkYXRlX2NyMyh2LCBm
YWxzZSk7CisKKyAgICAgICAgY3B1ID0gcmVhZF9hdG9taWMoJnYtPmRpcnR5X2NwdSk7CisgICAg
ICAgIGlmICggaXNfdmNwdV9kaXJ0eV9jcHUoY3B1KSApCisgICAgICAgICAgICBfX2NwdW1hc2tf
c2V0X2NwdShjcHUsIG1hc2spOworICAgIH0KKworICAgIC8qIEZsdXNoIFRMQnMgb24gYWxsIENQ
VXMgd2l0aCBkaXJ0eSB2Y3B1IHN0YXRlLiAqLworICAgIGZsdXNoX3RsYl9tYXNrKG1hc2spOwor
CisgICAgLyogRG9uZS4gKi8KKyAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgICAgIGlm
ICggdiAhPSBjdXJyZW50ICYmIGZsdXNoX3ZjcHUoY3R4dCwgdikgKQorICAgICAgICAgICAgdmNw
dV91bnBhdXNlKHYpOworCisgICAgcmV0dXJuIHRydWU7Cit9CisKIGNvbnN0IHN0cnVjdCBwYWdp
bmdfbW9kZSAqCiBoYXBfcGFnaW5nX2dldF9tb2RlKHN0cnVjdCB2Y3B1ICp2KQogewpAQCAtNzgx
LDYgKzgzNSw3IEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3QgcGFnaW5nX21vZGUgaGFwX3BhZ2luZ19y
ZWFsX21vZGUgPSB7CiAgICAgLnVwZGF0ZV9jcjMgICAgICAgICAgICAgPSBoYXBfdXBkYXRlX2Ny
MywKICAgICAudXBkYXRlX3BhZ2luZ19tb2RlcyAgICA9IGhhcF91cGRhdGVfcGFnaW5nX21vZGVz
LAogICAgIC53cml0ZV9wMm1fZW50cnkgICAgICAgID0gaGFwX3dyaXRlX3AybV9lbnRyeSwKKyAg
ICAuZmx1c2hfdGxiICAgICAgICAgICAgICA9IGZsdXNoX3RsYiwKICAgICAuZ3Vlc3RfbGV2ZWxz
ICAgICAgICAgICA9IDEKIH07CiAKQEAgLTc5Miw2ICs4NDcsNyBAQCBzdGF0aWMgY29uc3Qgc3Ry
dWN0IHBhZ2luZ19tb2RlIGhhcF9wYWdpbmdfcHJvdGVjdGVkX21vZGUgPSB7CiAgICAgLnVwZGF0
ZV9jcjMgICAgICAgICAgICAgPSBoYXBfdXBkYXRlX2NyMywKICAgICAudXBkYXRlX3BhZ2luZ19t
b2RlcyAgICA9IGhhcF91cGRhdGVfcGFnaW5nX21vZGVzLAogICAgIC53cml0ZV9wMm1fZW50cnkg
ICAgICAgID0gaGFwX3dyaXRlX3AybV9lbnRyeSwKKyAgICAuZmx1c2hfdGxiICAgICAgICAgICAg
ICA9IGZsdXNoX3RsYiwKICAgICAuZ3Vlc3RfbGV2ZWxzICAgICAgICAgICA9IDIKIH07CiAKQEAg
LTgwMyw2ICs4NTksNyBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IHBhZ2luZ19tb2RlIGhhcF9wYWdp
bmdfcGFlX21vZGUgPSB7CiAgICAgLnVwZGF0ZV9jcjMgICAgICAgICAgICAgPSBoYXBfdXBkYXRl
X2NyMywKICAgICAudXBkYXRlX3BhZ2luZ19tb2RlcyAgICA9IGhhcF91cGRhdGVfcGFnaW5nX21v
ZGVzLAogICAgIC53cml0ZV9wMm1fZW50cnkgICAgICAgID0gaGFwX3dyaXRlX3AybV9lbnRyeSwK
KyAgICAuZmx1c2hfdGxiICAgICAgICAgICAgICA9IGZsdXNoX3RsYiwKICAgICAuZ3Vlc3RfbGV2
ZWxzICAgICAgICAgICA9IDMKIH07CiAKQEAgLTgxNCw2ICs4NzEsNyBAQCBzdGF0aWMgY29uc3Qg
c3RydWN0IHBhZ2luZ19tb2RlIGhhcF9wYWdpbmdfbG9uZ19tb2RlID0gewogICAgIC51cGRhdGVf
Y3IzICAgICAgICAgICAgID0gaGFwX3VwZGF0ZV9jcjMsCiAgICAgLnVwZGF0ZV9wYWdpbmdfbW9k
ZXMgICAgPSBoYXBfdXBkYXRlX3BhZ2luZ19tb2RlcywKICAgICAud3JpdGVfcDJtX2VudHJ5ICAg
ICAgICA9IGhhcF93cml0ZV9wMm1fZW50cnksCisgICAgLmZsdXNoX3RsYiAgICAgICAgICAgICAg
PSBmbHVzaF90bGIsCiAgICAgLmd1ZXN0X2xldmVscyAgICAgICAgICAgPSA0CiB9OwogCmRpZmYg
LS1naXQgYS94ZW4vYXJjaC94ODYvbW0vc2hhZG93L2NvbW1vbi5jIGIveGVuL2FyY2gveDg2L21t
L3NoYWRvdy9jb21tb24uYwppbmRleCBjYmEzYWIxZWJhLi4xMjFkZGYxMjU1IDEwMDY0NAotLS0g
YS94ZW4vYXJjaC94ODYvbW0vc2hhZG93L2NvbW1vbi5jCisrKyBiL3hlbi9hcmNoL3g4Ni9tbS9z
aGFkb3cvY29tbW9uLmMKQEAgLTMzNTcsNiArMzM1Nyw2MSBAQCBvdXQ6CiAgICAgcmV0dXJuIHJj
OwogfQogCisvKiBGbHVocyBUTEIgb2Ygc2VsZWN0ZWQgdkNQVXMuICovCitib29sIHNoYWRvd19m
bHVzaF90bGIoYm9vbCAoKmZsdXNoX3ZjcHUpKHZvaWQgKmN0eHQsIHN0cnVjdCB2Y3B1ICp2KSwK
KyAgICAgICAgICAgICAgICAgICAgICB2b2lkICpjdHh0KQoreworICAgIHN0YXRpYyBERUZJTkVf
UEVSX0NQVShjcHVtYXNrX3QsIGZsdXNoX2NwdW1hc2spOworICAgIGNwdW1hc2tfdCAqbWFzayA9
ICZ0aGlzX2NwdShmbHVzaF9jcHVtYXNrKTsKKyAgICBzdHJ1Y3QgZG9tYWluICpkID0gY3VycmVu
dC0+ZG9tYWluOworICAgIHN0cnVjdCB2Y3B1ICp2OworCisgICAgLyogQXZvaWQgZGVhZGxvY2sg
aWYgbW9yZSB0aGFuIG9uZSB2Y3B1IHRyaWVzIHRoaXMgYXQgdGhlIHNhbWUgdGltZS4gKi8KKyAg
ICBpZiAoICFzcGluX3RyeWxvY2soJmQtPmh5cGVyY2FsbF9kZWFkbG9ja19tdXRleCkgKQorICAg
ICAgICByZXR1cm4gZmFsc2U7CisKKyAgICAvKiBQYXVzZSBhbGwgb3RoZXIgdmNwdXMuICovCisg
ICAgZm9yX2VhY2hfdmNwdSAoIGQsIHYgKQorICAgICAgICBpZiAoIHYgIT0gY3VycmVudCAmJiBm
bHVzaF92Y3B1KGN0eHQsIHYpICkKKyAgICAgICAgICAgIHZjcHVfcGF1c2Vfbm9zeW5jKHYpOwor
CisgICAgLyogTm93IHRoYXQgYWxsIFZDUFVzIGFyZSBzaWduYWxsZWQgdG8gZGVzY2hlZHVsZSwg
d2Ugd2FpdC4uLiAqLworICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICAgICAgaWYgKCB2
ICE9IGN1cnJlbnQgJiYgZmx1c2hfdmNwdShjdHh0LCB2KSApCisgICAgICAgICAgICB3aGlsZSAo
ICF2Y3B1X3J1bm5hYmxlKHYpICYmIHYtPmlzX3J1bm5pbmcgKQorICAgICAgICAgICAgICAgIGNw
dV9yZWxheCgpOworCisgICAgLyogQWxsIG90aGVyIHZjcHVzIGFyZSBwYXVzZWQsIHNhZmUgdG8g
dW5sb2NrIG5vdy4gKi8KKyAgICBzcGluX3VubG9jaygmZC0+aHlwZXJjYWxsX2RlYWRsb2NrX211
dGV4KTsKKworICAgIGNwdW1hc2tfY2xlYXIobWFzayk7CisKKyAgICAvKiBGbHVzaCBwYWdpbmct
bW9kZSBzb2Z0IHN0YXRlIChlLmcuLCB2YS0+Z2ZuIGNhY2hlOyBQQUUgUERQRSBjYWNoZSkuICov
CisgICAgZm9yX2VhY2hfdmNwdSAoIGQsIHYgKQorICAgIHsKKyAgICAgICAgdW5zaWduZWQgaW50
IGNwdTsKKworICAgICAgICBpZiAoICFmbHVzaF92Y3B1KGN0eHQsIHYpICkKKyAgICAgICAgICAg
IGNvbnRpbnVlOworCisgICAgICAgIHBhZ2luZ191cGRhdGVfY3IzKHYsIGZhbHNlKTsKKworICAg
ICAgICBjcHUgPSByZWFkX2F0b21pYygmdi0+ZGlydHlfY3B1KTsKKyAgICAgICAgaWYgKCBpc192
Y3B1X2RpcnR5X2NwdShjcHUpICkKKyAgICAgICAgICAgIF9fY3B1bWFza19zZXRfY3B1KGNwdSwg
bWFzayk7CisgICAgfQorCisgICAgLyogRmx1c2ggVExCcyBvbiBhbGwgQ1BVcyB3aXRoIGRpcnR5
IHZjcHUgc3RhdGUuICovCisgICAgZmx1c2hfdGxiX21hc2sobWFzayk7CisKKyAgICAvKiBEb25l
LiAqLworICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICAgICAgaWYgKCB2ICE9IGN1cnJl
bnQgJiYgZmx1c2hfdmNwdShjdHh0LCB2KSApCisgICAgICAgICAgICB2Y3B1X3VucGF1c2Uodik7
CisKKyAgICByZXR1cm4gdHJ1ZTsKK30KKwogLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwogLyogU2hhZG93
LWNvbnRyb2wgWEVOX0RPTUNUTCBkaXNwYXRjaGVyICovCiAKZGlmZiAtLWdpdCBhL3hlbi9hcmNo
L3g4Ni9tbS9zaGFkb3cvbXVsdGkuYyBiL3hlbi9hcmNoL3g4Ni9tbS9zaGFkb3cvbXVsdGkuYwpp
bmRleCAyNjc5OGIzMTdjLi5iNmFmYzBmYmE0IDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvbW0v
c2hhZG93L211bHRpLmMKKysrIGIveGVuL2FyY2gveDg2L21tL3NoYWRvdy9tdWx0aS5jCkBAIC00
ODczLDYgKzQ4NzMsNyBAQCBjb25zdCBzdHJ1Y3QgcGFnaW5nX21vZGUgc2hfcGFnaW5nX21vZGUg
PSB7CiAgICAgLnVwZGF0ZV9jcjMgICAgICAgICAgICAgICAgICAgID0gc2hfdXBkYXRlX2NyMywK
ICAgICAudXBkYXRlX3BhZ2luZ19tb2RlcyAgICAgICAgICAgPSBzaGFkb3dfdXBkYXRlX3BhZ2lu
Z19tb2RlcywKICAgICAud3JpdGVfcDJtX2VudHJ5ICAgICAgICAgICAgICAgPSBzaGFkb3dfd3Jp
dGVfcDJtX2VudHJ5LAorICAgIC5mbHVzaF90bGIgICAgICAgICAgICAgICAgICAgICA9IHNoYWRv
d19mbHVzaF90bGIsCiAgICAgLmd1ZXN0X2xldmVscyAgICAgICAgICAgICAgICAgID0gR1VFU1Rf
UEFHSU5HX0xFVkVMUywKICAgICAuc2hhZG93LmRldGFjaF9vbGRfdGFibGVzICAgICAgPSBzaF9k
ZXRhY2hfb2xkX3RhYmxlcywKICNpZmRlZiBDT05GSUdfUFYKZGlmZiAtLWdpdCBhL3hlbi9hcmNo
L3g4Ni9tbS9zaGFkb3cvcHJpdmF0ZS5oIGIveGVuL2FyY2gveDg2L21tL3NoYWRvdy9wcml2YXRl
LmgKaW5kZXggMzIxNzc3NzkyMS4uZThiMDI4YTM2NSAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2
L21tL3NoYWRvdy9wcml2YXRlLmgKKysrIGIveGVuL2FyY2gveDg2L21tL3NoYWRvdy9wcml2YXRl
LmgKQEAgLTgxNCw2ICs4MTQsMTAgQEAgc3RhdGljIGlubGluZSBpbnQgc2hfY2hlY2tfcGFnZV9o
YXNfbm9fcmVmcyhzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlKQogICAgICAgICAgICAgICgoY291bnQg
JiBQR0NfYWxsb2NhdGVkKSA/IDEgOiAwKSApOwogfQogCisvKiBGbHVzaCB0aGUgVExCIG9mIHRo
ZSBzZWxlY3RlZCB2Q1BVcy4gKi8KK2Jvb2wgc2hhZG93X2ZsdXNoX3RsYihib29sICgqZmx1c2hf
dmNwdSkodm9pZCAqY3R4dCwgc3RydWN0IHZjcHUgKnYpLAorICAgICAgICAgICAgICAgICAgICAg
IHZvaWQgKmN0eHQpOworCiAjZW5kaWYgLyogX1hFTl9TSEFET1dfUFJJVkFURV9IICovCiAKIC8q
CmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaCBiL3hlbi9pbmNsdWRl
L2FzbS14ODYvaHZtL2h2bS5oCmluZGV4IDI0ZGE4MjRjYmYuLmFhZTAwYTc4NjAgMTAwNjQ0Ci0t
LSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oCisrKyBiL3hlbi9pbmNsdWRlL2FzbS14
ODYvaHZtL2h2bS5oCkBAIC0zMzQsOSArMzM0LDYgQEAgY29uc3QgY2hhciAqaHZtX2VmZXJfdmFs
aWQoY29uc3Qgc3RydWN0IHZjcHUgKnYsIHVpbnQ2NF90IHZhbHVlLAogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgc2lnbmVkIGludCBjcjBfcGcpOwogdW5zaWduZWQgbG9uZyBodm1fY3I0X2d1
ZXN0X3ZhbGlkX2JpdHMoY29uc3Qgc3RydWN0IGRvbWFpbiAqZCwgYm9vbCByZXN0b3JlKTsKIAot
Ym9vbCBodm1fZmx1c2hfdmNwdV90bGIoYm9vbCAoKmZsdXNoX3ZjcHUpKHZvaWQgKmN0eHQsIHN0
cnVjdCB2Y3B1ICp2KSwKLSAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgKmN0eHQpOwotCiBp
bnQgaHZtX2NvcHlfY29udGV4dF9hbmRfcGFyYW1zKHN0cnVjdCBkb21haW4gKnNyYywgc3RydWN0
IGRvbWFpbiAqZHN0KTsKIAogI2lmZGVmIENPTkZJR19IVk0KZGlmZiAtLWdpdCBhL3hlbi9pbmNs
dWRlL2FzbS14ODYvcGFnaW5nLmggYi94ZW4vaW5jbHVkZS9hc20teDg2L3BhZ2luZy5oCmluZGV4
IDc1NDRmNzMxMjEuLjA1MTE2MTQ4MWMgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYv
cGFnaW5nLmgKKysrIGIveGVuL2luY2x1ZGUvYXNtLXg4Ni9wYWdpbmcuaApAQCAtMTQwLDYgKzE0
MCw5IEBAIHN0cnVjdCBwYWdpbmdfbW9kZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIHVuc2lnbmVkIGxvbmcgZ2ZuLAogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBsMV9wZ2VudHJ5X3QgKnAsIGwxX3BnZW50cnlfdCBuZXcs
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGlu
dCBsZXZlbCk7CisgICAgYm9vbCAgICAgICAgICAoKmZsdXNoX3RsYiAgICAgICAgICAgICApKGJv
b2wgKCpmbHVzaF92Y3B1KSh2b2lkICpjdHh0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHZjcHUgKnYpLAorICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpjdHh0KTsKIAog
ICAgIHVuc2lnbmVkIGludCBndWVzdF9sZXZlbHM7CiAKQEAgLTM5Nyw2ICs0MDAsMTMgQEAgc3Rh
dGljIGFsd2F5c19pbmxpbmUgdW5zaWduZWQgaW50IHBhZ2luZ19tYXhfcGFkZHJfYml0cyhjb25z
dCBzdHJ1Y3QgZG9tYWluICpkKQogICAgIHJldHVybiBiaXRzOwogfQogCitzdGF0aWMgaW5saW5l
IGJvb2wgcGFnaW5nX2ZsdXNoX3RsYihib29sICgqZmx1c2hfdmNwdSkodm9pZCAqY3R4dCwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJ1
Y3QgdmNwdSAqdiksCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpj
dHh0KQoreworICAgIHJldHVybiBwYWdpbmdfZ2V0X2hvc3Rtb2RlKGN1cnJlbnQpLT5mbHVzaF90
bGIoZmx1c2hfdmNwdSwgY3R4dCk7Cit9CisKICNlbmRpZiAvKiBYRU5fUEFHSU5HX0ggKi8KIAog
LyoKLS0gCjIuMjUuMAoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qu
b3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2
ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 05038C1AF7
	for <lists+xen-devel@lfdr.de>; Mon, 30 Sep 2019 07:25:14 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iEo8q-0002jc-0S; Mon, 30 Sep 2019 05:22:36 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=hbFO=XZ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iEo8o-0002i7-CY
 for xen-devel@lists.xenproject.org; Mon, 30 Sep 2019 05:22:34 +0000
X-Inumbo-ID: 3171eea8-e342-11e9-bf31-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 3171eea8-e342-11e9-bf31-bc764e2007e4;
 Mon, 30 Sep 2019 05:21:45 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 02560B112;
 Mon, 30 Sep 2019 05:21:43 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 30 Sep 2019 07:21:30 +0200
Message-Id: <20190930052135.11257-15-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190930052135.11257-1-jgross@suse.com>
References: <20190930052135.11257-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v5 14/19] xen/sched: protect scheduling resource
 via rcu
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SW4gb3JkZXIgdG8gYmUgYWJsZSB0byBtb3ZlIGNwdXMgdG8gY3B1cG9vbHMgd2l0aCBjb3JlIHNj
aGVkdWxpbmcKYWN0aXZlIGl0IGlzIG1hbmRhdG9yeSB0byBtZXJnZSBtdWx0aXBsZSBjcHVzIGlu
dG8gb25lIHNjaGVkdWxpbmcKcmVzb3VyY2Ugb3IgdG8gc3BsaXQgYSBzY2hlZHVsaW5nIHJlc291
cmNlIHdpdGggbXVsdGlwbGUgY3B1cyBpbiBpdAppbnRvIG11bHRpcGxlIHNjaGVkdWxpbmcgcmVz
b3VyY2VzLiBUaGlzIGluIHR1cm4gcmVxdWlyZXMgdG8gbW9kaWZ5CnRoZSBjcHUgPC0+IHNjaGVk
dWxpbmcgcmVzb3VyY2UgcmVsYXRpb24uIEluIG9yZGVyIHRvIGJlIGFibGUgdG8gZnJlZQp1bnVz
ZWQgcmVzb3VyY2VzIHByb3RlY3Qgc3RydWN0IHNjaGVkX3Jlc291cmNlIHZpYSBSQ1UuIFRoaXMg
ZW5zdXJlcwp0aGVyZSBhcmUgbm8gdXNlcnMgbGVmdCB3aGVuIGZyZWVpbmcgc3VjaCBhIHJlc291
cmNlLgoKU2lnbmVkLW9mZi1ieTogSnVlcmdlbiBHcm9zcyA8amdyb3NzQHN1c2UuY29tPgpSZXZp
ZXdlZC1ieTogRGFyaW8gRmFnZ2lvbGkgPGRmYWdnaW9saUBzdXNlLmNvbT4KLS0tClYxOiBuZXcg
cGF0Y2gKLS0tCiB4ZW4vY29tbW9uL2NwdXBvb2wuYyAgICAgICB8ICAgNCArCiB4ZW4vY29tbW9u
L3NjaGVkdWxlLmMgICAgICB8IDE4NyArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrLS0tLS0KIHhlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oIHwgICA3ICstCiAzIGZpbGVz
IGNoYW5nZWQsIDE3OCBpbnNlcnRpb25zKCspLCAyMCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS94ZW4vY29tbW9uL2NwdXBvb2wuYyBiL3hlbi9jb21tb24vY3B1cG9vbC5jCmluZGV4IDAyODI1
ZTc3OWQuLjcyMjhjYTg0YjQgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vY3B1cG9vbC5jCisrKyBi
L3hlbi9jb21tb24vY3B1cG9vbC5jCkBAIC01MTEsOCArNTExLDEwIEBAIHN0YXRpYyBpbnQgY3B1
cG9vbF9jcHVfYWRkKHVuc2lnbmVkIGludCBjcHUpCiAgICAgICogKG9yIHVucGx1Z2dpbmcgd291
bGQgaGF2ZSBmYWlsZWQpIGFuZCB0aGF0IGlzIHRoZSBkZWZhdWx0IGJlaGF2aW9yCiAgICAgICog
YW55d2F5LgogICAgICAqLworICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsK
ICAgICBnZXRfc2NoZWRfcmVzKGNwdSktPmNwdXBvb2wgPSBOVUxMOwogICAgIHJldCA9IGNwdXBv
b2xfYXNzaWduX2NwdV9sb2NrZWQoY3B1cG9vbDAsIGNwdSk7CisgICAgcmN1X3JlYWRfdW5sb2Nr
KCZzY2hlZF9yZXNfcmN1bG9jayk7CiAKICAgICBzcGluX3VubG9jaygmY3B1cG9vbF9sb2NrKTsK
IApAQCAtNTk3LDcgKzU5OSw5IEBAIHN0YXRpYyB2b2lkIGNwdXBvb2xfY3B1X3JlbW92ZV9mb3Jj
ZWQodW5zaWduZWQgaW50IGNwdSkKICAgICAgICAgfQogICAgIH0KIAorICAgIHJjdV9yZWFkX2xv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKICAgICBzY2hlZF9ybV9jcHUoY3B1KTsKKyAgICByY3Vf
cmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogLyoKZGlmZiAtLWdpdCBhL3hl
bi9jb21tb24vc2NoZWR1bGUuYyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwppbmRleCBhOTZmYzgy
MjgyLi4xZjIzYmYwZTgzIDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMKKysrIGIv
eGVuL2NvbW1vbi9zY2hlZHVsZS5jCkBAIC03Nyw2ICs3Nyw3IEBAIHN0YXRpYyB2b2lkIHBvbGxf
dGltZXJfZm4odm9pZCAqZGF0YSk7CiAvKiBUaGlzIGlzIGdsb2JhbCBmb3Igbm93IHNvIHRoYXQg
cHJpdmF0ZSBpbXBsZW1lbnRhdGlvbnMgY2FuIHJlYWNoIGl0ICovCiBERUZJTkVfUEVSX0NQVV9S
RUFEX01PU1RMWShzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKiwgc2NoZWRfcmVzKTsKIHN0YXRpYyBE
RUZJTkVfUEVSX0NQVV9SRUFEX01PU1RMWSh1bnNpZ25lZCBpbnQsIHNjaGVkX3Jlc19pZHgpOwor
REVGSU5FX1JDVV9SRUFEX0xPQ0soc2NoZWRfcmVzX3JjdWxvY2spOwogCiAvKiBTY3JhdGNoIHNw
YWNlIGZvciBjcHVtYXNrcy4gKi8KIERFRklORV9QRVJfQ1BVKGNwdW1hc2tfdCwgY3B1bWFza19z
Y3JhdGNoKTsKQEAgLTMwMCwxMCArMzAxLDEyIEBAIHZvaWQgc2NoZWRfZ3Vlc3RfaWRsZSh2b2lk
ICgqaWRsZSkgKHZvaWQpLCB1bnNpZ25lZCBpbnQgY3B1KQogCiB2b2lkIHZjcHVfcnVuc3RhdGVf
Z2V0KHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QgdmNwdV9ydW5zdGF0ZV9pbmZvICpydW5zdGF0ZSkK
IHsKLSAgICBzcGlubG9ja190ICpsb2NrID0gbGlrZWx5KHYgPT0gY3VycmVudCkKLSAgICAgICAg
ICAgICAgICAgICAgICAgPyBOVUxMIDogdW5pdF9zY2hlZHVsZV9sb2NrX2lycSh2LT5zY2hlZF91
bml0KTsKKyAgICBzcGlubG9ja190ICpsb2NrOwogICAgIHNfdGltZV90IGRlbHRhOwogCisgICAg
cmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCisgICAgbG9jayA9IGxpa2VseSh2
ID09IGN1cnJlbnQpID8gTlVMTCA6IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodi0+c2NoZWRfdW5p
dCk7CiAgICAgbWVtY3B5KHJ1bnN0YXRlLCAmdi0+cnVuc3RhdGUsIHNpemVvZigqcnVuc3RhdGUp
KTsKICAgICBkZWx0YSA9IE5PVygpIC0gcnVuc3RhdGUtPnN0YXRlX2VudHJ5X3RpbWU7CiAgICAg
aWYgKCBkZWx0YSA+IDAgKQpAQCAtMzExLDYgKzMxNCw4IEBAIHZvaWQgdmNwdV9ydW5zdGF0ZV9n
ZXQoc3RydWN0IHZjcHUgKnYsIHN0cnVjdCB2Y3B1X3J1bnN0YXRlX2luZm8gKnJ1bnN0YXRlKQog
CiAgICAgaWYgKCB1bmxpa2VseShsb2NrICE9IE5VTEwpICkKICAgICAgICAgdW5pdF9zY2hlZHVs
ZV91bmxvY2tfaXJxKGxvY2ssIHYtPnNjaGVkX3VuaXQpOworCisgICAgcmN1X3JlYWRfdW5sb2Nr
KCZzY2hlZF9yZXNfcmN1bG9jayk7CiB9CiAKIHVpbnQ2NF90IGdldF9jcHVfaWRsZV90aW1lKHVu
c2lnbmVkIGludCBjcHUpCkBAIC01MjIsNiArNTI3LDggQEAgaW50IHNjaGVkX2luaXRfdmNwdShz
dHJ1Y3QgdmNwdSAqdikKICAgICAgICAgcmV0dXJuIDA7CiAgICAgfQogCisgICAgcmN1X3JlYWRf
bG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgLyogVGhlIGZpcnN0IHZjcHUgb2YgYW4g
dW5pdCBjYW4gYmUgc2V0IHZpYSBzY2hlZF9zZXRfcmVzKCkuICovCiAgICAgc2NoZWRfc2V0X3Jl
cyh1bml0LCBnZXRfc2NoZWRfcmVzKHByb2Nlc3NvcikpOwogCkBAIC01MjksNiArNTM2LDcgQEAg
aW50IHNjaGVkX2luaXRfdmNwdShzdHJ1Y3QgdmNwdSAqdikKICAgICBpZiAoIHVuaXQtPnByaXYg
PT0gTlVMTCApCiAgICAgewogICAgICAgICBzY2hlZF9mcmVlX3VuaXQodW5pdCwgdik7CisgICAg
ICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAgICAgICByZXR1cm4g
MTsKICAgICB9CiAKQEAgLTU1NSw2ICs1NjMsOCBAQCBpbnQgc2NoZWRfaW5pdF92Y3B1KHN0cnVj
dCB2Y3B1ICp2KQogICAgICAgICBzY2hlZF9pbnNlcnRfdW5pdChkb21fc2NoZWR1bGVyKGQpLCB1
bml0KTsKICAgICB9CiAKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsK
KwogICAgIHJldHVybiAwOwogfQogCkBAIC01ODMsNiArNTkzLDcgQEAgaW50IHNjaGVkX21vdmVf
ZG9tYWluKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpjKQogICAgIHN0cnVjdCBz
Y2hlZHVsZXIgKm9sZF9vcHM7CiAgICAgdm9pZCAqb2xkX2RvbWRhdGE7CiAgICAgdW5zaWduZWQg
aW50IGdyYW4gPSBjcHVwb29sX2dldF9ncmFudWxhcml0eShjKTsKKyAgICBpbnQgcmV0ID0gMDsK
IAogICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKICAgICB7CkBAIC01OTAsMTUgKzYwMSwyMSBA
QCBpbnQgc2NoZWRfbW92ZV9kb21haW4oc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wg
KmMpCiAgICAgICAgICAgICByZXR1cm4gLUVCVVNZOwogICAgIH0KIAorICAgIHJjdV9yZWFkX2xv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGRvbWRhdGEgPSBzY2hlZF9hbGxvY19kb21k
YXRhKGMtPnNjaGVkLCBkKTsKICAgICBpZiAoIElTX0VSUihkb21kYXRhKSApCi0gICAgICAgIHJl
dHVybiBQVFJfRVJSKGRvbWRhdGEpOworICAgIHsKKyAgICAgICAgcmV0ID0gUFRSX0VSUihkb21k
YXRhKTsKKyAgICAgICAgZ290byBvdXQ7CisgICAgfQogCiAgICAgdW5pdF9wcml2ID0geHphbGxv
Y19hcnJheSh2b2lkICosIERJVl9ST1VORF9VUChkLT5tYXhfdmNwdXMsIGdyYW4pKTsKICAgICBp
ZiAoIHVuaXRfcHJpdiA9PSBOVUxMICkKICAgICB7CiAgICAgICAgIHNjaGVkX2ZyZWVfZG9tZGF0
YShjLT5zY2hlZCwgZG9tZGF0YSk7Ci0gICAgICAgIHJldHVybiAtRU5PTUVNOworICAgICAgICBy
ZXQgPSAtRU5PTUVNOworICAgICAgICBnb3RvIG91dDsKICAgICB9CiAKICAgICB1bml0X2lkeCA9
IDA7CkBAIC02MTEsNyArNjI4LDggQEAgaW50IHNjaGVkX21vdmVfZG9tYWluKHN0cnVjdCBkb21h
aW4gKmQsIHN0cnVjdCBjcHVwb29sICpjKQogICAgICAgICAgICAgICAgIHNjaGVkX2ZyZWVfdWRh
dGEoYy0+c2NoZWQsIHVuaXRfcHJpdlt1bml0X2lkeF0pOwogICAgICAgICAgICAgeGZyZWUodW5p
dF9wcml2KTsKICAgICAgICAgICAgIHNjaGVkX2ZyZWVfZG9tZGF0YShjLT5zY2hlZCwgZG9tZGF0
YSk7Ci0gICAgICAgICAgICByZXR1cm4gLUVOT01FTTsKKyAgICAgICAgICAgIHJldCA9IC1FTk9N
RU07CisgICAgICAgICAgICBnb3RvIG91dDsKICAgICAgICAgfQogICAgICAgICB1bml0X2lkeCsr
OwogICAgIH0KQEAgLTY3Nyw3ICs2OTUsMTAgQEAgaW50IHNjaGVkX21vdmVfZG9tYWluKHN0cnVj
dCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpjKQogCiAgICAgeGZyZWUodW5pdF9wcml2KTsK
IAotICAgIHJldHVybiAwOworb3V0OgorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOworCisgICAgcmV0dXJuIHJldDsKIH0KIAogdm9pZCBzY2hlZF9kZXN0cm95X3ZjcHUo
c3RydWN0IHZjcHUgKnYpCkBAIC02OTUsOSArNzE2LDEzIEBAIHZvaWQgc2NoZWRfZGVzdHJveV92
Y3B1KHN0cnVjdCB2Y3B1ICp2KQogICAgICAqLwogICAgIGlmICggdW5pdC0+dmNwdV9saXN0ID09
IHYgKQogICAgIHsKKyAgICAgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwor
CiAgICAgICAgIHNjaGVkX3JlbW92ZV91bml0KHZjcHVfc2NoZWR1bGVyKHYpLCB1bml0KTsKICAg
ICAgICAgc2NoZWRfZnJlZV91ZGF0YSh2Y3B1X3NjaGVkdWxlcih2KSwgdW5pdC0+cHJpdik7CiAg
ICAgICAgIHNjaGVkX2ZyZWVfdW5pdCh1bml0LCB2KTsKKworICAgICAgICByY3VfcmVhZF91bmxv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKICAgICB9CiB9CiAKQEAgLTcxNSw3ICs3NDAsMTIgQEAg
aW50IHNjaGVkX2luaXRfZG9tYWluKHN0cnVjdCBkb21haW4gKmQsIGludCBwb29saWQpCiAgICAg
U0NIRURfU1RBVF9DUkFOSyhkb21faW5pdCk7CiAgICAgVFJBQ0VfMUQoVFJDX1NDSEVEX0RPTV9B
REQsIGQtPmRvbWFpbl9pZCk7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9j
ayk7CisKICAgICBzZG9tID0gc2NoZWRfYWxsb2NfZG9tZGF0YShkb21fc2NoZWR1bGVyKGQpLCBk
KTsKKworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgaWYg
KCBJU19FUlIoc2RvbSkgKQogICAgICAgICByZXR1cm4gUFRSX0VSUihzZG9tKTsKIApAQCAtNzMz
LDkgKzc2MywxMyBAQCB2b2lkIHNjaGVkX2Rlc3Ryb3lfZG9tYWluKHN0cnVjdCBkb21haW4gKmQp
CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksoZG9tX2Rlc3Ryb3kpOwogICAgICAgICBUUkFDRV8x
RChUUkNfU0NIRURfRE9NX1JFTSwgZC0+ZG9tYWluX2lkKTsKIAorICAgICAgICByY3VfcmVhZF9s
b2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICAgICAgc2NoZWRfZnJlZV9kb21kYXRhKGRv
bV9zY2hlZHVsZXIoZCksIGQtPnNjaGVkX3ByaXYpOwogICAgICAgICBkLT5zY2hlZF9wcml2ID0g
TlVMTDsKIAorICAgICAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwog
ICAgICAgICBjcHVwb29sX3JtX2RvbWFpbihkKTsKICAgICB9CiB9CkBAIC03NzAsMTEgKzgwNCwx
NSBAQCB2b2lkIHZjcHVfc2xlZXBfbm9zeW5jKHN0cnVjdCB2Y3B1ICp2KQogCiAgICAgVFJBQ0Vf
MkQoVFJDX1NDSEVEX1NMRUVQLCB2LT5kb21haW4tPmRvbWFpbl9pZCwgdi0+dmNwdV9pZCk7CiAK
KyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBsb2NrID0gdW5p
dF9zY2hlZHVsZV9sb2NrX2lycXNhdmUodi0+c2NoZWRfdW5pdCwgJmZsYWdzKTsKIAogICAgIHZj
cHVfc2xlZXBfbm9zeW5jX2xvY2tlZCh2KTsKIAogICAgIHVuaXRfc2NoZWR1bGVfdW5sb2NrX2ly
cXJlc3RvcmUobG9jaywgZmxhZ3MsIHYtPnNjaGVkX3VuaXQpOworCisgICAgcmN1X3JlYWRfdW5s
b2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiB9CiAKIHZvaWQgdmNwdV9zbGVlcF9zeW5jKHN0cnVj
dCB2Y3B1ICp2KQpAQCAtNzk1LDYgKzgzMyw4IEBAIHZvaWQgdmNwdV93YWtlKHN0cnVjdCB2Y3B1
ICp2KQogCiAgICAgVFJBQ0VfMkQoVFJDX1NDSEVEX1dBS0UsIHYtPmRvbWFpbi0+ZG9tYWluX2lk
LCB2LT52Y3B1X2lkKTsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsK
KwogICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxc2F2ZSh1bml0LCAmZmxhZ3MpOwog
CiAgICAgaWYgKCBsaWtlbHkodmNwdV9ydW5uYWJsZSh2KSkgKQpAQCAtODIwLDYgKzg2MCw4IEBA
IHZvaWQgdmNwdV93YWtlKHN0cnVjdCB2Y3B1ICp2KQogICAgIH0KIAogICAgIHVuaXRfc2NoZWR1
bGVfdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIHVuaXQpOworCisgICAgcmN1X3JlYWRf
dW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiB9CiAKIHZvaWQgdmNwdV91bmJsb2NrKHN0cnVj
dCB2Y3B1ICp2KQpAQCAtODUzLDYgKzg5NSw4IEBAIHN0YXRpYyB2b2lkIHNjaGVkX3VuaXRfbW92
ZV9sb2NrZWQoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCiAgICAgdW5zaWduZWQgaW50IG9sZF9j
cHUgPSB1bml0LT5yZXMtPm1hc3Rlcl9jcHU7CiAgICAgc3RydWN0IHZjcHUgKnY7CiAKKyAgICBy
Y3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICAvKgogICAgICAqIFRyYW5z
ZmVyIHVyZ2VuY3kgc3RhdHVzIHRvIG5ldyBDUFUgYmVmb3JlIHN3aXRjaGluZyBDUFVzLCBhcwog
ICAgICAqIG9uY2UgdGhlIHN3aXRjaCBvY2N1cnMsIHYtPmlzX3VyZ2VudCBpcyBubyBsb25nZXIg
cHJvdGVjdGVkIGJ5CkBAIC04NzIsNiArOTE2LDggQEAgc3RhdGljIHZvaWQgc2NoZWRfdW5pdF9t
b3ZlX2xvY2tlZChzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKICAgICAgKiBwb2ludGVyIGNhbid0
IGNoYW5nZSB3aGlsZSB0aGUgY3VycmVudCBsb2NrIGlzIGhlbGQuCiAgICAgICovCiAgICAgc2No
ZWRfbWlncmF0ZSh1bml0X3NjaGVkdWxlcih1bml0KSwgdW5pdCwgbmV3X2NwdSk7CisKKyAgICBy
Y3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogLyoKQEAgLTEwMzksNiAr
MTA4NSw4IEBAIHZvaWQgcmVzdG9yZV92Y3B1X2FmZmluaXR5KHN0cnVjdCBkb21haW4gKmQpCiAK
ICAgICBBU1NFUlQoc3lzdGVtX3N0YXRlID09IFNZU19TVEFURV9yZXN1bWUpOwogCisgICAgcmN1
X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgZm9yX2VhY2hfc2NoZWRfdW5p
dCAoIGQsIHVuaXQgKQogICAgIHsKICAgICAgICAgc3BpbmxvY2tfdCAqbG9jazsKQEAgLTEwOTUs
NiArMTE0Myw4IEBAIHZvaWQgcmVzdG9yZV92Y3B1X2FmZmluaXR5KHN0cnVjdCBkb21haW4gKmQp
CiAgICAgICAgICAgICBzY2hlZF9tb3ZlX2lycXModW5pdCk7CiAgICAgfQogCisgICAgcmN1X3Jl
YWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBkb21haW5fdXBkYXRlX25vZGVf
YWZmaW5pdHkoZCk7CiB9CiAKQEAgLTExMTAsOSArMTE2MCwxMSBAQCBpbnQgY3B1X2Rpc2FibGVf
c2NoZWR1bGVyKHVuc2lnbmVkIGludCBjcHUpCiAgICAgY3B1bWFza190IG9ubGluZV9hZmZpbml0
eTsKICAgICBpbnQgcmV0ID0gMDsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vs
b2NrKTsKKwogICAgIGMgPSBnZXRfc2NoZWRfcmVzKGNwdSktPmNwdXBvb2w7CiAgICAgaWYgKCBj
ID09IE5VTEwgKQotICAgICAgICByZXR1cm4gcmV0OworICAgICAgICBnb3RvIG91dDsKIAogICAg
IGZvcl9lYWNoX2RvbWFpbl9pbl9jcHVwb29sICggZCwgYyApCiAgICAgewpAQCAtMTE3MCw2ICsx
MjIyLDkgQEAgaW50IGNwdV9kaXNhYmxlX3NjaGVkdWxlcih1bnNpZ25lZCBpbnQgY3B1KQogICAg
ICAgICB9CiAgICAgfQogCitvdXQ6CisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1
bG9jayk7CisKICAgICByZXR1cm4gcmV0OwogfQogCkBAIC0xMjAxLDcgKzEyNTYsOSBAQCBzdGF0
aWMgaW50IGNwdV9kaXNhYmxlX3NjaGVkdWxlcl9jaGVjayh1bnNpZ25lZCBpbnQgY3B1KQogc3Rh
dGljIHZvaWQgc2NoZWRfc2V0X2FmZmluaXR5KAogICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0
LCBjb25zdCBjcHVtYXNrX3QgKmhhcmQsIGNvbnN0IGNwdW1hc2tfdCAqc29mdCkKIHsKKyAgICBy
Y3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAgICAgc2NoZWRfYWRqdXN0X2FmZmlu
aXR5KGRvbV9zY2hlZHVsZXIodW5pdC0+ZG9tYWluKSwgdW5pdCwgaGFyZCwgc29mdCk7CisgICAg
cmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAKICAgICBpZiAoIGhhcmQgKQog
ICAgICAgICBjcHVtYXNrX2NvcHkodW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHksIGhhcmQpOwpAQCAt
MTIyMSw2ICsxMjc4LDggQEAgc3RhdGljIGludCB2Y3B1X3NldF9hZmZpbml0eSgKICAgICBzcGlu
bG9ja190ICpsb2NrOwogICAgIGludCByZXQgPSAwOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2No
ZWRfcmVzX3JjdWxvY2spOworCiAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5p
dCk7CiAKICAgICBpZiAoIHYtPmFmZmluaXR5X2Jyb2tlbiApCkBAIC0xMjQ5LDYgKzEzMDgsOCBA
QCBzdGF0aWMgaW50IHZjcHVfc2V0X2FmZmluaXR5KAogCiAgICAgc2NoZWRfdW5pdF9taWdyYXRl
X2ZpbmlzaCh1bml0KTsKIAorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2sp
OworCiAgICAgcmV0dXJuIHJldDsKIH0KIApAQCAtMTM3NSwxMSArMTQzNiwxNiBAQCBzdGF0aWMg
bG9uZyBkb19wb2xsKHN0cnVjdCBzY2hlZF9wb2xsICpzY2hlZF9wb2xsKQogbG9uZyB2Y3B1X3lp
ZWxkKHZvaWQpCiB7CiAgICAgc3RydWN0IHZjcHUgKiB2PWN1cnJlbnQ7Ci0gICAgc3BpbmxvY2tf
dCAqbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodi0+c2NoZWRfdW5pdCk7CisgICAgc3Bp
bmxvY2tfdCAqbG9jazsKKworICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsK
IAorICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHYtPnNjaGVkX3VuaXQpOwogICAg
IHNjaGVkX3lpZWxkKHZjcHVfc2NoZWR1bGVyKHYpLCB2LT5zY2hlZF91bml0KTsKICAgICB1bml0
X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgdi0+c2NoZWRfdW5pdCk7CiAKKyAgICByY3VfcmVh
ZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIFNDSEVEX1NUQVRfQ1JBTksodmNw
dV95aWVsZCk7CiAKICAgICBUUkFDRV8yRChUUkNfU0NIRURfWUlFTEQsIGN1cnJlbnQtPmRvbWFp
bi0+ZG9tYWluX2lkLCBjdXJyZW50LT52Y3B1X2lkKTsKQEAgLTE0NzYsNiArMTU0Miw4IEBAIGlu
dCB2Y3B1X3RlbXBvcmFyeV9hZmZpbml0eShzdHJ1Y3QgdmNwdSAqdiwgdW5zaWduZWQgaW50IGNw
dSwgdWludDhfdCByZWFzb24pCiAgICAgaW50IHJldCA9IC1FSU5WQUw7CiAgICAgYm9vbCBtaWdy
YXRlOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgbG9j
ayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5pdCk7CiAKICAgICBpZiAoIGNwdSA9PSBOUl9D
UFVTICkKQEAgLTE1MTUsNiArMTU4Myw4IEBAIGludCB2Y3B1X3RlbXBvcmFyeV9hZmZpbml0eShz
dHJ1Y3QgdmNwdSAqdiwgdW5zaWduZWQgaW50IGNwdSwgdWludDhfdCByZWFzb24pCiAgICAgaWYg
KCBtaWdyYXRlICkKICAgICAgICAgc2NoZWRfdW5pdF9taWdyYXRlX2ZpbmlzaCh1bml0KTsKIAor
ICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgcmV0dXJuIHJl
dDsKIH0KIApAQCAtMTcyNiw5ICsxNzk2LDEzIEBAIGxvbmcgc2NoZWRfYWRqdXN0KHN0cnVjdCBk
b21haW4gKmQsIHN0cnVjdCB4ZW5fZG9tY3RsX3NjaGVkdWxlcl9vcCAqb3ApCiAKICAgICAvKiBO
QjogdGhlIHBsdWdnYWJsZSBzY2hlZHVsZXIgY29kZSBuZWVkcyB0byB0YWtlIGNhcmUKICAgICAg
KiBvZiBsb2NraW5nIGJ5IGl0c2VsZi4gKi8KKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNf
cmN1bG9jayk7CisKICAgICBpZiAoIChyZXQgPSBzY2hlZF9hZGp1c3RfZG9tKGRvbV9zY2hlZHVs
ZXIoZCksIGQsIG9wKSkgPT0gMCApCiAgICAgICAgIFRSQUNFXzFEKFRSQ19TQ0hFRF9BREpET00s
IGQtPmRvbWFpbl9pZCk7CiAKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2Nr
KTsKKwogICAgIHJldHVybiByZXQ7CiB9CiAKQEAgLTE3NDksOSArMTgyMywxMyBAQCBsb25nIHNj
aGVkX2FkanVzdF9nbG9iYWwoc3RydWN0IHhlbl9zeXNjdGxfc2NoZWR1bGVyX29wICpvcCkKICAg
ICBpZiAoIHBvb2wgPT0gTlVMTCApCiAgICAgICAgIHJldHVybiAtRVNSQ0g7CiAKKyAgICByY3Vf
cmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICByYyA9ICgob3AtPnNjaGVkX2lk
ID09IHBvb2wtPnNjaGVkLT5zY2hlZF9pZCkKICAgICAgICAgICA/IHNjaGVkX2FkanVzdF9jcHVw
b29sKHBvb2wtPnNjaGVkLCBvcCkgOiAtRUlOVkFMKTsKIAorICAgIHJjdV9yZWFkX3VubG9jaygm
c2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgY3B1cG9vbF9wdXQocG9vbCk7CiAKICAgICByZXR1
cm4gcmM7CkBAIC0xOTcxLDcgKzIwNDksMTEgQEAgc3RhdGljIHZvaWQgdW5pdF9jb250ZXh0X3Nh
dmVkKHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3IpCiB2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNo
ZWQoc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQpCiB7CiAgICAgc3RydWN0
IHNjaGVkX3VuaXQgKm5leHQgPSB2bmV4dC0+c2NoZWRfdW5pdDsKLSAgICBzdHJ1Y3Qgc2NoZWRf
cmVzb3VyY2UgKnNyID0gZ2V0X3NjaGVkX3JlcyhzbXBfcHJvY2Vzc29yX2lkKCkpOworICAgIHN0
cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3I7CisKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNf
cmN1bG9jayk7CisKKyAgICBzciA9IGdldF9zY2hlZF9yZXMoc21wX3Byb2Nlc3Nvcl9pZCgpKTsK
IAogICAgIGlmICggYXRvbWljX3JlYWQoJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCkgKQogICAg
IHsKQEAgLTE5OTgsNiArMjA4MCw4IEBAIHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2hlZChzdHJ1
Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCkKIAogICAgIGlmICggaXNfaWRsZV92
Y3B1KHZwcmV2KSAmJiB2cHJldiAhPSB2bmV4dCApCiAgICAgICAgIHZwcmV2LT5zY2hlZF91bml0
ID0gc3ItPnNjaGVkX3VuaXRfaWRsZTsKKworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVz
X3JjdWxvY2spOwogfQogCiBzdGF0aWMgdm9pZCBzY2hlZF9jb250ZXh0X3N3aXRjaChzdHJ1Y3Qg
dmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCwKQEAgLTIwMjEsNiArMjEwNSw4IEBAIHN0
YXRpYyB2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNoKHN0cnVjdCB2Y3B1ICp2cHJldiwgc3RydWN0
IHZjcHUgKnZuZXh0LAogICAgICAgICAgICAgdm5leHQtPnNjaGVkX3VuaXQgPQogICAgICAgICAg
ICAgICAgIGdldF9zY2hlZF9yZXMoc21wX3Byb2Nlc3Nvcl9pZCgpKS0+c2NoZWRfdW5pdF9pZGxl
OwogCisgICAgICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAg
ICAgIHRyYWNlX2NvbnRpbnVlX3J1bm5pbmcodm5leHQpOwogICAgICAgICByZXR1cm4gY29udGlu
dWVfcnVubmluZyh2cHJldik7CiAgICAgfQpAQCAtMjAzNCw2ICsyMTIwLDggQEAgc3RhdGljIHZv
aWQgc2NoZWRfY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNwdSAq
dm5leHQsCiAKICAgICB2Y3B1X3BlcmlvZGljX3RpbWVyX3dvcmsodm5leHQpOwogCisgICAgcmN1
X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBjb250ZXh0X3N3aXRjaCh2
cHJldiwgdm5leHQpOwogfQogCkBAIC0yMTg2LDYgKzIyNzQsOCBAQCBzdGF0aWMgdm9pZCBzY2hl
ZF9zbGF2ZSh2b2lkKQogCiAgICAgQVNTRVJUX05PVF9JTl9BVE9NSUMoKTsKIAorICAgIHJjdV9y
ZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGxvY2sgPSBwY3B1X3NjaGVkdWxl
X2xvY2tfaXJxKGNwdSk7CiAKICAgICBub3cgPSBOT1coKTsKQEAgLTIyMDksNiArMjI5OSw4IEBA
IHN0YXRpYyB2b2lkIHNjaGVkX3NsYXZlKHZvaWQpCiAgICAgewogICAgICAgICBwY3B1X3NjaGVk
dWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKIAorICAgICAgICByY3VfcmVhZF91bmxvY2soJnNj
aGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgICAgICAvKiBDaGVjayBmb3IgZmFpbGVkIGZvcmNlZCBj
b250ZXh0IHN3aXRjaC4gKi8KICAgICAgICAgaWYgKCBkb19zb2Z0aXJxICkKICAgICAgICAgICAg
IHJhaXNlX3NvZnRpcnEoU0NIRURVTEVfU09GVElSUSk7CkBAIC0yMjQxLDEzICsyMzMzLDE2IEBA
IHN0YXRpYyB2b2lkIHNjaGVkdWxlKHZvaWQpCiAgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpz
cjsKICAgICBzcGlubG9ja190ICAgICAgICAgICAqbG9jazsKICAgICBpbnQgY3B1ID0gc21wX3By
b2Nlc3Nvcl9pZCgpOwotICAgIHVuc2lnbmVkIGludCAgICAgICAgICBncmFuID0gZ2V0X3NjaGVk
X3JlcyhjcHUpLT5ncmFudWxhcml0eTsKKyAgICB1bnNpZ25lZCBpbnQgICAgICAgICAgZ3JhbjsK
IAogICAgIEFTU0VSVF9OT1RfSU5fQVRPTUlDKCk7CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKHNj
aGVkX3J1bik7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAg
ICBzciA9IGdldF9zY2hlZF9yZXMoY3B1KTsKKyAgICBncmFuID0gc3ItPmdyYW51bGFyaXR5Owog
CiAgICAgbG9jayA9IHBjcHVfc2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKIApAQCAtMjI1OSw2ICsy
MzU0LDggQEAgc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKICAgICAgICAgICovCiAgICAgICAg
IHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOwogCisgICAgICAgIHJjdV9yZWFk
X3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgICAgIHJhaXNlX3NvZnRpcnEoU0NI
RURVTEVfU09GVElSUSk7CiAgICAgICAgIHJldHVybiBzY2hlZF9zbGF2ZSgpOwogICAgIH0KQEAg
LTIzNzAsMTQgKzI0NjcsMjcgQEAgc3RhdGljIGludCBjcHVfc2NoZWR1bGVfdXAodW5zaWduZWQg
aW50IGNwdSkKICAgICByZXR1cm4gMDsKIH0KIAorc3RhdGljIHZvaWQgc2NoZWRfcmVzX2ZyZWUo
c3RydWN0IHJjdV9oZWFkICpoZWFkKQoreworICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3Ig
PSBjb250YWluZXJfb2YoaGVhZCwgc3RydWN0IHNjaGVkX3Jlc291cmNlLCByY3UpOworCisgICAg
eGZyZWUoc3IpOworfQorCiBzdGF0aWMgdm9pZCBjcHVfc2NoZWR1bGVfZG93bih1bnNpZ25lZCBp
bnQgY3B1KQogewotICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3IgPSBnZXRfc2NoZWRfcmVz
KGNwdSk7CisgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcjsKKworICAgIHJjdV9yZWFkX2xv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKworICAgIHNyID0gZ2V0X3NjaGVkX3JlcyhjcHUpOwog
CiAgICAga2lsbF90aW1lcigmc3ItPnNfdGltZXIpOwogCiAgICAgc2V0X3NjaGVkX3JlcyhjcHUs
IE5VTEwpOwotICAgIHhmcmVlKHNyKTsKKyAgICBjYWxsX3JjdSgmc3ItPnJjdSwgc2NoZWRfcmVz
X2ZyZWUpOworCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiB9CiAK
IHZvaWQgc2NoZWRfcm1fY3B1KHVuc2lnbmVkIGludCBjcHUpCkBAIC0yMzk3LDYgKzI1MDcsOCBA
QCBzdGF0aWMgaW50IGNwdV9zY2hlZHVsZV9jYWxsYmFjaygKICAgICB1bnNpZ25lZCBpbnQgY3B1
ID0gKHVuc2lnbmVkIGxvbmcpaGNwdTsKICAgICBpbnQgcmMgPSAwOwogCisgICAgcmN1X3JlYWRf
bG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgLyoKICAgICAgKiBGcm9tIHRoZSBzY2hl
ZHVsZXIgcGVyc3BlY3RpdmUsIGJyaW5naW5nIHVwIGEgcENQVSByZXF1aXJlcwogICAgICAqIGFs
bG9jYXRpbmcgYW5kIGluaXRpYWxpemluZyB0aGUgcGVyLXBDUFUgc2NoZWR1bGVyIHNwZWNpZmlj
IGRhdGEsCkBAIC0yNDQzLDYgKzI1NTUsOCBAQCBzdGF0aWMgaW50IGNwdV9zY2hlZHVsZV9jYWxs
YmFjaygKICAgICAgICAgYnJlYWs7CiAgICAgfQogCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hl
ZF9yZXNfcmN1bG9jayk7CisKICAgICByZXR1cm4gIXJjID8gTk9USUZZX0RPTkUgOiBub3RpZmll
cl9mcm9tX2Vycm5vKHJjKTsKIH0KIApAQCAtMjUzMiw4ICsyNjQ2LDEzIEBAIHZvaWQgX19pbml0
IHNjaGVkdWxlcl9pbml0KHZvaWQpCiAgICAgaWRsZV9kb21haW4tPm1heF92Y3B1cyA9IG5yX2Nw
dV9pZHM7CiAgICAgaWYgKCB2Y3B1X2NyZWF0ZShpZGxlX2RvbWFpbiwgMCkgPT0gTlVMTCApCiAg
ICAgICAgIEJVRygpOworCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwor
CiAgICAgZ2V0X3NjaGVkX3JlcygwKS0+Y3VyciA9IGlkbGVfdmNwdVswXS0+c2NoZWRfdW5pdDsK
ICAgICBnZXRfc2NoZWRfcmVzKDApLT5zY2hlZF91bml0X2lkbGUgPSBpZGxlX3ZjcHVbMF0tPnNj
aGVkX3VuaXQ7CisKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0K
IAogLyoKQEAgLTI1NDYsOSArMjY2NSwxNCBAQCBpbnQgc2NoZWR1bGVfY3B1X2FkZCh1bnNpZ25l
ZCBpbnQgY3B1LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICBzdHJ1Y3QgdmNwdSAqaWRsZTsKICAg
ICB2b2lkICpwcHJpdiwgKnZwcml2OwogICAgIHN0cnVjdCBzY2hlZHVsZXIgKm5ld19vcHMgPSBj
LT5zY2hlZDsKLSAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyID0gZ2V0X3NjaGVkX3Jlcyhj
cHUpOworICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3I7CiAgICAgc3BpbmxvY2tfdCAqb2xk
X2xvY2ssICpuZXdfbG9jazsKICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOworICAgIGludCByZXQg
PSAwOworCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCisgICAgc3Ig
PSBnZXRfc2NoZWRfcmVzKGNwdSk7CiAKICAgICBBU1NFUlQoY3B1bWFza190ZXN0X2NwdShjcHUs
ICZjcHVwb29sX2ZyZWVfY3B1cykpOwogICAgIEFTU0VSVCghY3B1bWFza190ZXN0X2NwdShjcHUs
IGMtPmNwdV92YWxpZCkpOwpAQCAtMjU2OCwxMyArMjY5MiwxOCBAQCBpbnQgc2NoZWR1bGVfY3B1
X2FkZCh1bnNpZ25lZCBpbnQgY3B1LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICBpZGxlID0gaWRs
ZV92Y3B1W2NwdV07CiAgICAgcHByaXYgPSBzY2hlZF9hbGxvY19wZGF0YShuZXdfb3BzLCBjcHUp
OwogICAgIGlmICggSVNfRVJSKHBwcml2KSApCi0gICAgICAgIHJldHVybiBQVFJfRVJSKHBwcml2
KTsKKyAgICB7CisgICAgICAgIHJldCA9IFBUUl9FUlIocHByaXYpOworICAgICAgICBnb3RvIG91
dDsKKyAgICB9CisKICAgICB2cHJpdiA9IHNjaGVkX2FsbG9jX3VkYXRhKG5ld19vcHMsIGlkbGUt
PnNjaGVkX3VuaXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZGxlLT5kb21haW4t
PnNjaGVkX3ByaXYpOwogICAgIGlmICggdnByaXYgPT0gTlVMTCApCiAgICAgewogICAgICAgICBz
Y2hlZF9mcmVlX3BkYXRhKG5ld19vcHMsIHBwcml2LCBjcHUpOwotICAgICAgICByZXR1cm4gLUVO
T01FTTsKKyAgICAgICAgcmV0ID0gLUVOT01FTTsKKyAgICAgICAgZ290byBvdXQ7CiAgICAgfQog
CiAgICAgLyoKQEAgLTI2MTMsNyArMjc0MiwxMCBAQCBpbnQgc2NoZWR1bGVfY3B1X2FkZCh1bnNp
Z25lZCBpbnQgY3B1LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICAvKiBUaGUgIGNwdSBpcyBhZGRl
ZCB0byBhIHBvb2wsIHRyaWdnZXIgaXQgdG8gZ28gcGljayB1cCBzb21lIHdvcmsgKi8KICAgICBj
cHVfcmFpc2Vfc29mdGlycShjcHUsIFNDSEVEVUxFX1NPRlRJUlEpOwogCi0gICAgcmV0dXJuIDA7
CitvdXQ6CisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKKyAgICBy
ZXR1cm4gcmV0OwogfQogCiAvKgpAQCAtMjYyNiwxMSArMjc1OCwxNiBAQCBpbnQgc2NoZWR1bGVf
Y3B1X3JtKHVuc2lnbmVkIGludCBjcHUpCiB7CiAgICAgc3RydWN0IHZjcHUgKmlkbGU7CiAgICAg
dm9pZCAqcHByaXZfb2xkLCAqdnByaXZfb2xkOwotICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAq
c3IgPSBnZXRfc2NoZWRfcmVzKGNwdSk7Ci0gICAgc3RydWN0IHNjaGVkdWxlciAqb2xkX29wcyA9
IHNyLT5zY2hlZHVsZXI7CisgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcjsKKyAgICBzdHJ1
Y3Qgc2NoZWR1bGVyICpvbGRfb3BzOwogICAgIHNwaW5sb2NrX3QgKm9sZF9sb2NrOwogICAgIHVu
c2lnbmVkIGxvbmcgZmxhZ3M7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9j
ayk7CisKKyAgICBzciA9IGdldF9zY2hlZF9yZXMoY3B1KTsKKyAgICBvbGRfb3BzID0gc3ItPnNj
aGVkdWxlcjsKKwogICAgIEFTU0VSVChzci0+Y3B1cG9vbCAhPSBOVUxMKTsKICAgICBBU1NFUlQo
Y3B1bWFza190ZXN0X2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1cykpOwogICAgIEFTU0VSVCgh
Y3B1bWFza190ZXN0X2NwdShjcHUsIHNyLT5jcHVwb29sLT5jcHVfdmFsaWQpKTsKQEAgLTI2NjMs
NiArMjgwMCw4IEBAIGludCBzY2hlZHVsZV9jcHVfcm0odW5zaWduZWQgaW50IGNwdSkKICAgICBz
ci0+Z3JhbnVsYXJpdHkgPSAxOwogICAgIHNyLT5jcHVwb29sID0gTlVMTDsKIAorICAgIHJjdV9y
ZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgcmV0dXJuIDA7CiB9CiAKQEAg
LTI3MTEsNiArMjg1MCw4IEBAIHZvaWQgc2NoZWR1bGVfZHVtcChzdHJ1Y3QgY3B1cG9vbCAqYykK
IAogICAgIC8qIExvY2tpbmcsIGlmIG5lY2Vzc2FyeSwgbXVzdCBiZSBoYW5kbGVkIHdpdGhpbmcg
ZWFjaCBzY2hlZHVsZXIgKi8KIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2Nr
KTsKKwogICAgIGlmICggYyAhPSBOVUxMICkKICAgICB7CiAgICAgICAgIHNjaGVkID0gYy0+c2No
ZWQ7CkBAIC0yNzMwLDYgKzI4NzEsOCBAQCB2b2lkIHNjaGVkdWxlX2R1bXAoc3RydWN0IGNwdXBv
b2wgKmMpCiAgICAgICAgIGZvcl9lYWNoX2NwdSAoaSwgY3B1cykKICAgICAgICAgICAgIHNjaGVk
X2R1bXBfY3B1X3N0YXRlKHNjaGVkLCBpKTsKICAgICB9CisKKyAgICByY3VfcmVhZF91bmxvY2so
JnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogdm9pZCBzY2hlZF90aWNrX3N1c3BlbmQodm9pZCkK
QEAgLTI3MzcsMTAgKzI4ODAsMTQgQEAgdm9pZCBzY2hlZF90aWNrX3N1c3BlbmQodm9pZCkKICAg
ICBzdHJ1Y3Qgc2NoZWR1bGVyICpzY2hlZDsKICAgICB1bnNpZ25lZCBpbnQgY3B1ID0gc21wX3By
b2Nlc3Nvcl9pZCgpOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwor
CiAgICAgc2NoZWQgPSBnZXRfc2NoZWRfcmVzKGNwdSktPnNjaGVkdWxlcjsKICAgICBzY2hlZF9k
b190aWNrX3N1c3BlbmQoc2NoZWQsIGNwdSk7CiAgICAgcmN1X2lkbGVfZW50ZXIoY3B1KTsKICAg
ICByY3VfaWRsZV90aW1lcl9zdGFydCgpOworCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9y
ZXNfcmN1bG9jayk7CiB9CiAKIHZvaWQgc2NoZWRfdGlja19yZXN1bWUodm9pZCkKQEAgLTI3NDgs
MTAgKzI4OTUsMTQgQEAgdm9pZCBzY2hlZF90aWNrX3Jlc3VtZSh2b2lkKQogICAgIHN0cnVjdCBz
Y2hlZHVsZXIgKnNjaGVkOwogICAgIHVuc2lnbmVkIGludCBjcHUgPSBzbXBfcHJvY2Vzc29yX2lk
KCk7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICByY3Vf
aWRsZV90aW1lcl9zdG9wKCk7CiAgICAgcmN1X2lkbGVfZXhpdChjcHUpOwogICAgIHNjaGVkID0g
Z2V0X3NjaGVkX3JlcyhjcHUpLT5zY2hlZHVsZXI7CiAgICAgc2NoZWRfZG9fdGlja19yZXN1bWUo
c2NoZWQsIGNwdSk7CisKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsK
IH0KIAogdm9pZCB3YWl0KHZvaWQpCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQt
aWYuaCBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCmluZGV4IGY4ZjBmNDg0Y2IuLjM5ODg5
ODVlZTYgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCisrKyBiL3hlbi9p
bmNsdWRlL3hlbi9zY2hlZC1pZi5oCkBAIC0xMCw2ICsxMCw3IEBACiAKICNpbmNsdWRlIDx4ZW4v
cGVyY3B1Lmg+CiAjaW5jbHVkZSA8eGVuL2Vyci5oPgorI2luY2x1ZGUgPHhlbi9yY3VwZGF0ZS5o
PgogCiAvKiBBIGdsb2JhbCBwb2ludGVyIHRvIHRoZSBpbml0aWFsIGNwdXBvb2wgKFBPT0wwKS4g
Ki8KIGV4dGVybiBzdHJ1Y3QgY3B1cG9vbCAqY3B1cG9vbDA7CkBAIC01NywxOCArNTgsMjAgQEAg
c3RydWN0IHNjaGVkX3Jlc291cmNlIHsKICAgICB1bnNpZ25lZCBpbnQgICAgICAgIG1hc3Rlcl9j
cHU7CiAgICAgdW5zaWduZWQgaW50ICAgICAgICBncmFudWxhcml0eTsKICAgICBjb25zdCBjcHVt
YXNrX3QgICAgKmNwdXM7ICAgICAgICAgICAvKiBjcHVzIGNvdmVyZWQgYnkgdGhpcyBzdHJ1Y3Qg
ICAgICovCisgICAgc3RydWN0IHJjdV9oZWFkICAgICByY3U7CiB9OwogCiBERUNMQVJFX1BFUl9D
UFUoc3RydWN0IHNjaGVkX3Jlc291cmNlICosIHNjaGVkX3Jlcyk7CitleHRlcm4gcmN1X3JlYWRf
bG9ja190IHNjaGVkX3Jlc19yY3Vsb2NrOwogCiBzdGF0aWMgaW5saW5lIHN0cnVjdCBzY2hlZF9y
ZXNvdXJjZSAqZ2V0X3NjaGVkX3Jlcyh1bnNpZ25lZCBpbnQgY3B1KQogewotICAgIHJldHVybiBw
ZXJfY3B1KHNjaGVkX3JlcywgY3B1KTsKKyAgICByZXR1cm4gcmN1X2RlcmVmZXJlbmNlKHBlcl9j
cHUoc2NoZWRfcmVzLCBjcHUpKTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lkIHNldF9zY2hlZF9y
ZXModW5zaWduZWQgaW50IGNwdSwgc3RydWN0IHNjaGVkX3Jlc291cmNlICpyZXMpCiB7Ci0gICAg
cGVyX2NwdShzY2hlZF9yZXMsIGNwdSkgPSByZXM7CisgICAgcmN1X2Fzc2lnbl9wb2ludGVyKHBl
cl9jcHUoc2NoZWRfcmVzLCBjcHUpLCByZXMpOwogfQogCiBzdGF0aWMgaW5saW5lIHN0cnVjdCBz
Y2hlZF91bml0ICpjdXJyX29uX2NwdSh1bnNpZ25lZCBpbnQgY3B1KQotLSAKMi4xNi40CgoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1h
aWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54
ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

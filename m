Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 7EB7017A2CF
	for <lists+xen-devel@lfdr.de>; Thu,  5 Mar 2020 11:05:47 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j9nLt-000110-40; Thu, 05 Mar 2020 10:03:37 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=eGB2=4W=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1j9nLr-00010p-Dk
 for xen-devel@lists.xenproject.org; Thu, 05 Mar 2020 10:03:35 +0000
X-Inumbo-ID: 92c94dca-5ec8-11ea-90c4-bc764e2007e4
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 92c94dca-5ec8-11ea-90c4-bc764e2007e4;
 Thu, 05 Mar 2020 10:03:34 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id 1FA98B2DE;
 Thu,  5 Mar 2020 10:03:33 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org, linux-block@vger.kernel.org,
 linux-kernel@vger.kernel.org
Date: Thu,  5 Mar 2020 11:03:31 +0100
Message-Id: <20200305100331.16790-1-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
Subject: [Xen-devel] [PATCH] xen/blkfront: fix ring info addressing
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Jens Axboe <axboe@kernel.dk>,
 Stefano Stabellini <sstabellini@kernel.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 Boris Ostrovsky <boris.ostrovsky@oracle.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q29tbWl0IDAyNjVkNmU4ZGRiODkwICgieGVuL2Jsa2Zyb250OiBsaW1pdCBhbGxvY2F0ZWQgbWVt
b3J5IHNpemUgdG8KYWN0dWFsIHVzZSBjYXNlIikgbWFkZSBzdHJ1Y3QgYmxrZnJvbnRfcmluZ19p
bmZvIHNpemUgZHluYW1pYy4gVGhpcyBpcwpmaW5lIHdoZW4gcnVubmluZyB3aXRoIG9ubHkgb25l
IHF1ZXVlLCBidXQgd2l0aCBtdWx0aXBsZSBxdWV1ZXMgdGhlCmFkZHJlc3Npbmcgb2YgdGhlIHNp
bmdsZSBxdWV1ZXMgaGFzIHRvIGJlIGFkYXB0ZWQgYXMgdGhlIHN0cnVjdHMgYXJlCmFsbG9jYXRl
ZCBpbiBhbiBhcnJheS4KCkZpeGVzOiAwMjY1ZDZlOGRkYjg5MCAoInhlbi9ibGtmcm9udDogbGlt
aXQgYWxsb2NhdGVkIG1lbW9yeSBzaXplIHRvIGFjdHVhbCB1c2UgY2FzZSIpClNpZ25lZC1vZmYt
Ynk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tCiBkcml2ZXJzL2Jsb2NrL3hl
bi1ibGtmcm9udC5jIHwgODIgKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0t
LS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA0NSBpbnNlcnRpb25zKCspLCAzNyBkZWxldGlvbnMoLSkK
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2Jsb2NrL3hlbi1ibGtmcm9udC5jIGIvZHJpdmVycy9ibG9j
ay94ZW4tYmxrZnJvbnQuYwppbmRleCBlMmFkNmJiYTIyODEuLmE4ZDRhMzgzOGU1ZCAxMDA2NDQK
LS0tIGEvZHJpdmVycy9ibG9jay94ZW4tYmxrZnJvbnQuYworKysgYi9kcml2ZXJzL2Jsb2NrL3hl
bi1ibGtmcm9udC5jCkBAIC0yMTMsNiArMjEzLDcgQEAgc3RydWN0IGJsa2Zyb250X2luZm8KIAlz
dHJ1Y3QgYmxrX21xX3RhZ19zZXQgdGFnX3NldDsKIAlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZv
ICpyaW5mbzsKIAl1bnNpZ25lZCBpbnQgbnJfcmluZ3M7CisJdW5zaWduZWQgaW50IHJpbmZvX3Np
emU7CiAJLyogU2F2ZSB1bmNvbXBsZXRlIHJlcXMgYW5kIGJpb3MgZm9yIG1pZ3JhdGlvbi4gKi8K
IAlzdHJ1Y3QgbGlzdF9oZWFkIHJlcXVlc3RzOwogCXN0cnVjdCBiaW9fbGlzdCBiaW9fbGlzdDsK
QEAgLTI1OSw2ICsyNjAsMjEgQEAgc3RhdGljIGludCBibGtmcm9udF9zZXR1cF9pbmRpcmVjdChz
dHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbyk7CiBzdGF0aWMgdm9pZCBibGtmcm9udF9n
YXRoZXJfYmFja2VuZF9mZWF0dXJlcyhzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbyk7CiBzdGF0
aWMgaW50IG5lZ290aWF0ZV9tcShzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbyk7CiAKKyNkZWZp
bmUgcmluZm9fcHRyKHJpbmZvLCBvZmYpIFwKKwkoc3RydWN0IGJsa2Zyb250X3JpbmdfaW5mbyAq
KSgodW5zaWduZWQgbG9uZykocmluZm8pICsgKG9mZikpCisKKyNkZWZpbmUgZm9yX2VhY2hfcmlu
Zm8oaW5mbywgcmluZm8sIGlkeCkJCQkJXAorCWZvciAocmluZm8gPSBpbmZvLT5yaW5mbywgaWR4
ID0gMDsJCQkJXAorCSAgICAgaWR4IDwgaW5mby0+bnJfcmluZ3M7CQkJCQlcCisJICAgICBpZHgr
KywgcmluZm8gPSByaW5mb19wdHIocmluZm8sIGluZm8tPnJpbmZvX3NpemUpKQorCitzdGF0aWMg
c3RydWN0IGJsa2Zyb250X3JpbmdfaW5mbyAqZ2V0X3JpbmZvKHN0cnVjdCBibGtmcm9udF9pbmZv
ICppbmZvLAorCQkJCQkgICAgdW5zaWduZWQgaW50IGkpCit7CisJQlVHX09OKGkgPj0gaW5mby0+
bnJfcmluZ3MpOworCXJldHVybiByaW5mb19wdHIoaW5mby0+cmluZm8sIGkgKiBpbmZvLT5yaW5m
b19zaXplKTsKK30KKwogc3RhdGljIGludCBnZXRfaWRfZnJvbV9mcmVlbGlzdChzdHJ1Y3QgYmxr
ZnJvbnRfcmluZ19pbmZvICpyaW5mbykKIHsKIAl1bnNpZ25lZCBsb25nIGZyZWUgPSByaW5mby0+
c2hhZG93X2ZyZWU7CkBAIC04ODMsOCArODk5LDcgQEAgc3RhdGljIGJsa19zdGF0dXNfdCBibGtp
Zl9xdWV1ZV9ycShzdHJ1Y3QgYmxrX21xX2h3X2N0eCAqaGN0eCwKIAlzdHJ1Y3QgYmxrZnJvbnRf
aW5mbyAqaW5mbyA9IGhjdHgtPnF1ZXVlLT5xdWV1ZWRhdGE7CiAJc3RydWN0IGJsa2Zyb250X3Jp
bmdfaW5mbyAqcmluZm8gPSBOVUxMOwogCi0JQlVHX09OKGluZm8tPm5yX3JpbmdzIDw9IHFpZCk7
Ci0JcmluZm8gPSAmaW5mby0+cmluZm9bcWlkXTsKKwlyaW5mbyA9IGdldF9yaW5mbyhpbmZvLCBx
aWQpOwogCWJsa19tcV9zdGFydF9yZXF1ZXN0KHFkLT5ycSk7CiAJc3Bpbl9sb2NrX2lycXNhdmUo
JnJpbmZvLT5yaW5nX2xvY2ssIGZsYWdzKTsKIAlpZiAoUklOR19GVUxMKCZyaW5mby0+cmluZykp
CkBAIC0xMTgxLDYgKzExOTYsNyBAQCBzdGF0aWMgaW50IHhsdmJkX2FsbG9jX2dlbmRpc2soYmxr
aWZfc2VjdG9yX3QgY2FwYWNpdHksCiBzdGF0aWMgdm9pZCB4bHZiZF9yZWxlYXNlX2dlbmRpc2so
c3RydWN0IGJsa2Zyb250X2luZm8gKmluZm8pCiB7CiAJdW5zaWduZWQgaW50IG1pbm9yLCBucl9t
aW5vcnMsIGk7CisJc3RydWN0IGJsa2Zyb250X3JpbmdfaW5mbyAqcmluZm87CiAKIAlpZiAoaW5m
by0+cnEgPT0gTlVMTCkKIAkJcmV0dXJuOwpAQCAtMTE4OCw4ICsxMjA0LDcgQEAgc3RhdGljIHZv
aWQgeGx2YmRfcmVsZWFzZV9nZW5kaXNrKHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvKQogCS8q
IE5vIG1vcmUgYmxraWZfcmVxdWVzdCgpLiAqLwogCWJsa19tcV9zdG9wX2h3X3F1ZXVlcyhpbmZv
LT5ycSk7CiAKLQlmb3IgKGkgPSAwOyBpIDwgaW5mby0+bnJfcmluZ3M7IGkrKykgewotCQlzdHJ1
Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbyA9ICZpbmZvLT5yaW5mb1tpXTsKKwlmb3JfZWFj
aF9yaW5mbyhpbmZvLCByaW5mbywgaSkgewogCiAJCS8qIE5vIG1vcmUgZ250dGFiIGNhbGxiYWNr
IHdvcmsuICovCiAJCWdudHRhYl9jYW5jZWxfZnJlZV9jYWxsYmFjaygmcmluZm8tPmNhbGxiYWNr
KTsKQEAgLTEzMzksNiArMTM1NCw3IEBAIHN0YXRpYyB2b2lkIGJsa2lmX2ZyZWVfcmluZyhzdHJ1
Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbykKIHN0YXRpYyB2b2lkIGJsa2lmX2ZyZWUoc3Ry
dWN0IGJsa2Zyb250X2luZm8gKmluZm8sIGludCBzdXNwZW5kKQogewogCXVuc2lnbmVkIGludCBp
OworCXN0cnVjdCBibGtmcm9udF9yaW5nX2luZm8gKnJpbmZvOwogCiAJLyogUHJldmVudCBuZXcg
cmVxdWVzdHMgYmVpbmcgaXNzdWVkIHVudGlsIHdlIGZpeCB0aGluZ3MgdXAuICovCiAJaW5mby0+
Y29ubmVjdGVkID0gc3VzcGVuZCA/CkBAIC0xMzQ3LDggKzEzNjMsOCBAQCBzdGF0aWMgdm9pZCBi
bGtpZl9mcmVlKHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvLCBpbnQgc3VzcGVuZCkKIAlpZiAo
aW5mby0+cnEpCiAJCWJsa19tcV9zdG9wX2h3X3F1ZXVlcyhpbmZvLT5ycSk7CiAKLQlmb3IgKGkg
PSAwOyBpIDwgaW5mby0+bnJfcmluZ3M7IGkrKykKLQkJYmxraWZfZnJlZV9yaW5nKCZpbmZvLT5y
aW5mb1tpXSk7CisJZm9yX2VhY2hfcmluZm8oaW5mbywgcmluZm8sIGkpCisJCWJsa2lmX2ZyZWVf
cmluZyhyaW5mbyk7CiAKIAlrdmZyZWUoaW5mby0+cmluZm8pOwogCWluZm8tPnJpbmZvID0gTlVM
TDsKQEAgLTE3NzUsNiArMTc5MSw3IEBAIHN0YXRpYyBpbnQgdGFsa190b19ibGtiYWNrKHN0cnVj
dCB4ZW5idXNfZGV2aWNlICpkZXYsCiAJaW50IGVycjsKIAl1bnNpZ25lZCBpbnQgaSwgbWF4X3Bh
Z2Vfb3JkZXI7CiAJdW5zaWduZWQgaW50IHJpbmdfcGFnZV9vcmRlcjsKKwlzdHJ1Y3QgYmxrZnJv
bnRfcmluZ19pbmZvICpyaW5mbzsKIAogCWlmICghaW5mbykKIAkJcmV0dXJuIC1FTk9ERVY7CkBA
IC0xNzg4LDkgKzE4MDUsNyBAQCBzdGF0aWMgaW50IHRhbGtfdG9fYmxrYmFjayhzdHJ1Y3QgeGVu
YnVzX2RldmljZSAqZGV2LAogCWlmIChlcnIpCiAJCWdvdG8gZGVzdHJveV9ibGtyaW5nOwogCi0J
Zm9yIChpID0gMDsgaSA8IGluZm8tPm5yX3JpbmdzOyBpKyspIHsKLQkJc3RydWN0IGJsa2Zyb250
X3JpbmdfaW5mbyAqcmluZm8gPSAmaW5mby0+cmluZm9baV07Ci0KKwlmb3JfZWFjaF9yaW5mbyhp
bmZvLCByaW5mbywgaSkgewogCQkvKiBDcmVhdGUgc2hhcmVkIHJpbmcsIGFsbG9jIGV2ZW50IGNo
YW5uZWwuICovCiAJCWVyciA9IHNldHVwX2Jsa3JpbmcoZGV2LCByaW5mbyk7CiAJCWlmIChlcnIp
CkBAIC0xODE1LDcgKzE4MzAsNyBAQCBzdGF0aWMgaW50IHRhbGtfdG9fYmxrYmFjayhzdHJ1Y3Qg
eGVuYnVzX2RldmljZSAqZGV2LAogCiAJLyogV2UgYWxyZWFkeSBnb3QgdGhlIG51bWJlciBvZiBx
dWV1ZXMvcmluZ3MgaW4gX3Byb2JlICovCiAJaWYgKGluZm8tPm5yX3JpbmdzID09IDEpIHsKLQkJ
ZXJyID0gd3JpdGVfcGVyX3Jpbmdfbm9kZXMoeGJ0LCAmaW5mby0+cmluZm9bMF0sIGRldi0+bm9k
ZW5hbWUpOworCQllcnIgPSB3cml0ZV9wZXJfcmluZ19ub2Rlcyh4YnQsIGluZm8tPnJpbmZvLCBk
ZXYtPm5vZGVuYW1lKTsKIAkJaWYgKGVycikKIAkJCWdvdG8gZGVzdHJveV9ibGtyaW5nOwogCX0g
ZWxzZSB7CkBAIC0xODM3LDEwICsxODUyLDEwIEBAIHN0YXRpYyBpbnQgdGFsa190b19ibGtiYWNr
KHN0cnVjdCB4ZW5idXNfZGV2aWNlICpkZXYsCiAJCQlnb3RvIGFib3J0X3RyYW5zYWN0aW9uOwog
CQl9CiAKLQkJZm9yIChpID0gMDsgaSA8IGluZm8tPm5yX3JpbmdzOyBpKyspIHsKKwkJZm9yX2Vh
Y2hfcmluZm8oaW5mbywgcmluZm8sIGkpIHsKIAkJCW1lbXNldChwYXRoLCAwLCBwYXRoc2l6ZSk7
CiAJCQlzbnByaW50ZihwYXRoLCBwYXRoc2l6ZSwgIiVzL3F1ZXVlLSV1IiwgZGV2LT5ub2RlbmFt
ZSwgaSk7Ci0JCQllcnIgPSB3cml0ZV9wZXJfcmluZ19ub2Rlcyh4YnQsICZpbmZvLT5yaW5mb1tp
XSwgcGF0aCk7CisJCQllcnIgPSB3cml0ZV9wZXJfcmluZ19ub2Rlcyh4YnQsIHJpbmZvLCBwYXRo
KTsKIAkJCWlmIChlcnIpIHsKIAkJCQlrZnJlZShwYXRoKTsKIAkJCQlnb3RvIGRlc3Ryb3lfYmxr
cmluZzsKQEAgLTE4NjgsOSArMTg4Myw4IEBAIHN0YXRpYyBpbnQgdGFsa190b19ibGtiYWNrKHN0
cnVjdCB4ZW5idXNfZGV2aWNlICpkZXYsCiAJCWdvdG8gZGVzdHJveV9ibGtyaW5nOwogCX0KIAot
CWZvciAoaSA9IDA7IGkgPCBpbmZvLT5ucl9yaW5nczsgaSsrKSB7CisJZm9yX2VhY2hfcmluZm8o
aW5mbywgcmluZm8sIGkpIHsKIAkJdW5zaWduZWQgaW50IGo7Ci0JCXN0cnVjdCBibGtmcm9udF9y
aW5nX2luZm8gKnJpbmZvID0gJmluZm8tPnJpbmZvW2ldOwogCiAJCWZvciAoaiA9IDA7IGogPCBC
TEtfUklOR19TSVpFKGluZm8pOyBqKyspCiAJCQlyaW5mby0+c2hhZG93W2pdLnJlcS51LnJ3Lmlk
ID0gaiArIDE7CkBAIC0xOTAwLDYgKzE5MTQsNyBAQCBzdGF0aWMgaW50IG5lZ290aWF0ZV9tcShz
dHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbykKIHsKIAl1bnNpZ25lZCBpbnQgYmFja2VuZF9tYXhf
cXVldWVzOwogCXVuc2lnbmVkIGludCBpOworCXN0cnVjdCBibGtmcm9udF9yaW5nX2luZm8gKnJp
bmZvOwogCiAJQlVHX09OKGluZm8tPm5yX3JpbmdzKTsKIApAQCAtMTkxMSwyMCArMTkyNiwxNiBA
QCBzdGF0aWMgaW50IG5lZ290aWF0ZV9tcShzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbykKIAlp
ZiAoIWluZm8tPm5yX3JpbmdzKQogCQlpbmZvLT5ucl9yaW5ncyA9IDE7CiAKLQlpbmZvLT5yaW5m
byA9IGt2Y2FsbG9jKGluZm8tPm5yX3JpbmdzLAotCQkJICAgICAgIHN0cnVjdF9zaXplKGluZm8t
PnJpbmZvLCBzaGFkb3csCi0JCQkJCSAgIEJMS19SSU5HX1NJWkUoaW5mbykpLAotCQkJICAgICAg
IEdGUF9LRVJORUwpOworCWluZm8tPnJpbmZvX3NpemUgPSBzdHJ1Y3Rfc2l6ZShpbmZvLT5yaW5m
bywgc2hhZG93LAorCQkJCSAgICAgICBCTEtfUklOR19TSVpFKGluZm8pKTsKKwlpbmZvLT5yaW5m
byA9IGt2Y2FsbG9jKGluZm8tPm5yX3JpbmdzLCBpbmZvLT5yaW5mb19zaXplLCBHRlBfS0VSTkVM
KTsKIAlpZiAoIWluZm8tPnJpbmZvKSB7CiAJCXhlbmJ1c19kZXZfZmF0YWwoaW5mby0+eGJkZXYs
IC1FTk9NRU0sICJhbGxvY2F0aW5nIHJpbmdfaW5mbyBzdHJ1Y3R1cmUiKTsKIAkJaW5mby0+bnJf
cmluZ3MgPSAwOwogCQlyZXR1cm4gLUVOT01FTTsKIAl9CiAKLQlmb3IgKGkgPSAwOyBpIDwgaW5m
by0+bnJfcmluZ3M7IGkrKykgewotCQlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbzsK
LQotCQlyaW5mbyA9ICZpbmZvLT5yaW5mb1tpXTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5m
bywgaSkgewogCQlJTklUX0xJU1RfSEVBRCgmcmluZm8tPmluZGlyZWN0X3BhZ2VzKTsKIAkJSU5J
VF9MSVNUX0hFQUQoJnJpbmZvLT5ncmFudHMpOwogCQlyaW5mby0+ZGV2X2luZm8gPSBpbmZvOwpA
QCAtMjAxNyw2ICsyMDI4LDcgQEAgc3RhdGljIGludCBibGtpZl9yZWNvdmVyKHN0cnVjdCBibGtm
cm9udF9pbmZvICppbmZvKQogCWludCByYzsKIAlzdHJ1Y3QgYmlvICpiaW87CiAJdW5zaWduZWQg
aW50IHNlZ3M7CisJc3RydWN0IGJsa2Zyb250X3JpbmdfaW5mbyAqcmluZm87CiAKIAlibGtmcm9u
dF9nYXRoZXJfYmFja2VuZF9mZWF0dXJlcyhpbmZvKTsKIAkvKiBSZXNldCBsaW1pdHMgY2hhbmdl
ZCBieSBibGtfbXFfdXBkYXRlX25yX2h3X3F1ZXVlcygpLiAqLwpAQCAtMjAyNCw5ICsyMDM2LDcg
QEAgc3RhdGljIGludCBibGtpZl9yZWNvdmVyKHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvKQog
CXNlZ3MgPSBpbmZvLT5tYXhfaW5kaXJlY3Rfc2VnbWVudHMgPyA6IEJMS0lGX01BWF9TRUdNRU5U
U19QRVJfUkVRVUVTVDsKIAlibGtfcXVldWVfbWF4X3NlZ21lbnRzKGluZm8tPnJxLCBzZWdzIC8g
R1JBTlRTX1BFUl9QU0VHKTsKIAotCWZvciAocl9pbmRleCA9IDA7IHJfaW5kZXggPCBpbmZvLT5u
cl9yaW5nczsgcl9pbmRleCsrKSB7Ci0JCXN0cnVjdCBibGtmcm9udF9yaW5nX2luZm8gKnJpbmZv
ID0gJmluZm8tPnJpbmZvW3JfaW5kZXhdOwotCisJZm9yX2VhY2hfcmluZm8oaW5mbywgcmluZm8s
IHJfaW5kZXgpIHsKIAkJcmMgPSBibGtmcm9udF9zZXR1cF9pbmRpcmVjdChyaW5mbyk7CiAJCWlm
IChyYykKIAkJCXJldHVybiByYzsKQEAgLTIwMzYsMTAgKzIwNDYsNyBAQCBzdGF0aWMgaW50IGJs
a2lmX3JlY292ZXIoc3RydWN0IGJsa2Zyb250X2luZm8gKmluZm8pCiAJLyogTm93IHNhZmUgZm9y
IHVzIHRvIHVzZSB0aGUgc2hhcmVkIHJpbmcgKi8KIAlpbmZvLT5jb25uZWN0ZWQgPSBCTEtJRl9T
VEFURV9DT05ORUNURUQ7CiAKLQlmb3IgKHJfaW5kZXggPSAwOyByX2luZGV4IDwgaW5mby0+bnJf
cmluZ3M7IHJfaW5kZXgrKykgewotCQlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbzsK
LQotCQlyaW5mbyA9ICZpbmZvLT5yaW5mb1tyX2luZGV4XTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZv
LCByaW5mbywgcl9pbmRleCkgewogCQkvKiBLaWNrIGFueSBvdGhlciBuZXcgcmVxdWVzdHMgcXVl
dWVkIHNpbmNlIHdlIHJlc3VtZWQgKi8KIAkJa2lja19wZW5kaW5nX3JlcXVlc3RfcXVldWVzKHJp
bmZvKTsKIAl9CkBAIC0yMDcyLDEzICsyMDc5LDEzIEBAIHN0YXRpYyBpbnQgYmxrZnJvbnRfcmVz
dW1lKHN0cnVjdCB4ZW5idXNfZGV2aWNlICpkZXYpCiAJc3RydWN0IGJsa2Zyb250X2luZm8gKmlu
Zm8gPSBkZXZfZ2V0X2RydmRhdGEoJmRldi0+ZGV2KTsKIAlpbnQgZXJyID0gMDsKIAl1bnNpZ25l
ZCBpbnQgaSwgajsKKwlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbzsKIAogCWRldl9k
YmcoJmRldi0+ZGV2LCAiYmxrZnJvbnRfcmVzdW1lOiAlc1xuIiwgZGV2LT5ub2RlbmFtZSk7CiAK
IAliaW9fbGlzdF9pbml0KCZpbmZvLT5iaW9fbGlzdCk7CiAJSU5JVF9MSVNUX0hFQUQoJmluZm8t
PnJlcXVlc3RzKTsKLQlmb3IgKGkgPSAwOyBpIDwgaW5mby0+bnJfcmluZ3M7IGkrKykgewotCQlz
dHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZvICpyaW5mbyA9ICZpbmZvLT5yaW5mb1tpXTsKKwlmb3Jf
ZWFjaF9yaW5mbyhpbmZvLCByaW5mbywgaSkgewogCQlzdHJ1Y3QgYmlvX2xpc3QgbWVyZ2VfYmlv
OwogCQlzdHJ1Y3QgYmxrX3NoYWRvdyAqc2hhZG93ID0gcmluZm8tPnNoYWRvdzsKIApAQCAtMjMz
Nyw2ICsyMzQ0LDcgQEAgc3RhdGljIHZvaWQgYmxrZnJvbnRfY29ubmVjdChzdHJ1Y3QgYmxrZnJv
bnRfaW5mbyAqaW5mbykKIAl1bnNpZ25lZCBpbnQgYmluZm87CiAJY2hhciAqZW52cFtdID0geyAi
UkVTSVpFPTEiLCBOVUxMIH07CiAJaW50IGVyciwgaTsKKwlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19p
bmZvICpyaW5mbzsKIAogCXN3aXRjaCAoaW5mby0+Y29ubmVjdGVkKSB7CiAJY2FzZSBCTEtJRl9T
VEFURV9DT05ORUNURUQ6CkBAIC0yMzk0LDggKzI0MDIsOCBAQCBzdGF0aWMgdm9pZCBibGtmcm9u
dF9jb25uZWN0KHN0cnVjdCBibGtmcm9udF9pbmZvICppbmZvKQogCQkJCQkJICAgICJwaHlzaWNh
bC1zZWN0b3Itc2l6ZSIsCiAJCQkJCQkgICAgc2VjdG9yX3NpemUpOwogCWJsa2Zyb250X2dhdGhl
cl9iYWNrZW5kX2ZlYXR1cmVzKGluZm8pOwotCWZvciAoaSA9IDA7IGkgPCBpbmZvLT5ucl9yaW5n
czsgaSsrKSB7Ci0JCWVyciA9IGJsa2Zyb250X3NldHVwX2luZGlyZWN0KCZpbmZvLT5yaW5mb1tp
XSk7CisJZm9yX2VhY2hfcmluZm8oaW5mbywgcmluZm8sIGkpIHsKKwkJZXJyID0gYmxrZnJvbnRf
c2V0dXBfaW5kaXJlY3QocmluZm8pOwogCQlpZiAoZXJyKSB7CiAJCQl4ZW5idXNfZGV2X2ZhdGFs
KGluZm8tPnhiZGV2LCBlcnIsICJzZXR1cF9pbmRpcmVjdCBhdCAlcyIsCiAJCQkJCSBpbmZvLT54
YmRldi0+b3RoZXJlbmQpOwpAQCAtMjQxNiw4ICsyNDI0LDggQEAgc3RhdGljIHZvaWQgYmxrZnJv
bnRfY29ubmVjdChzdHJ1Y3QgYmxrZnJvbnRfaW5mbyAqaW5mbykKIAogCS8qIEtpY2sgcGVuZGlu
ZyByZXF1ZXN0cy4gKi8KIAlpbmZvLT5jb25uZWN0ZWQgPSBCTEtJRl9TVEFURV9DT05ORUNURUQ7
Ci0JZm9yIChpID0gMDsgaSA8IGluZm8tPm5yX3JpbmdzOyBpKyspCi0JCWtpY2tfcGVuZGluZ19y
ZXF1ZXN0X3F1ZXVlcygmaW5mby0+cmluZm9baV0pOworCWZvcl9lYWNoX3JpbmZvKGluZm8sIHJp
bmZvLCBpKQorCQlraWNrX3BlbmRpbmdfcmVxdWVzdF9xdWV1ZXMocmluZm8pOwogCiAJZGV2aWNl
X2FkZF9kaXNrKCZpbmZvLT54YmRldi0+ZGV2LCBpbmZvLT5nZCwgTlVMTCk7CiAKQEAgLTI2NTIs
OSArMjY2MCw5IEBAIHN0YXRpYyB2b2lkIHB1cmdlX3BlcnNpc3RlbnRfZ3JhbnRzKHN0cnVjdCBi
bGtmcm9udF9pbmZvICppbmZvKQogewogCXVuc2lnbmVkIGludCBpOwogCXVuc2lnbmVkIGxvbmcg
ZmxhZ3M7CisJc3RydWN0IGJsa2Zyb250X3JpbmdfaW5mbyAqcmluZm87CiAKLQlmb3IgKGkgPSAw
OyBpIDwgaW5mby0+bnJfcmluZ3M7IGkrKykgewotCQlzdHJ1Y3QgYmxrZnJvbnRfcmluZ19pbmZv
ICpyaW5mbyA9ICZpbmZvLT5yaW5mb1tpXTsKKwlmb3JfZWFjaF9yaW5mbyhpbmZvLCByaW5mbywg
aSkgewogCQlzdHJ1Y3QgZ3JhbnQgKmdudF9saXN0X2VudHJ5LCAqdG1wOwogCiAJCXNwaW5fbG9j
a19pcnFzYXZlKCZyaW5mby0+cmluZ19sb2NrLCBmbGFncyk7Ci0tIAoyLjE2LjQKCgpfX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGlu
ZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnBy
b2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

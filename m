Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 6805614A9DB
	for <lists+xen-devel@lfdr.de>; Mon, 27 Jan 2020 19:36:15 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iw9DS-00025O-1E; Mon, 27 Jan 2020 18:34:30 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=5jYl=3Q=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1iw9DQ-00024I-3p
 for xen-devel@lists.xenproject.org; Mon, 27 Jan 2020 18:34:28 +0000
X-Inumbo-ID: 9d95c90c-4133-11ea-b45d-bc764e2007e4
Received: from mga07.intel.com (unknown [134.134.136.100])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 9d95c90c-4133-11ea-b45d-bc764e2007e4;
 Mon, 27 Jan 2020 18:34:13 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 27 Jan 2020 10:06:47 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.70,370,1574150400"; d="scan'208";a="231562357"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.254.183.124])
 by orsmga006.jf.intel.com with ESMTP; 27 Jan 2020 10:06:47 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 27 Jan 2020 10:06:30 -0800
Message-Id: <0f94706731f30e8407f64064d33a27f549554250.1580148227.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1580148227.git.tamas.lengyel@intel.com>
References: <cover.1580148227.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v6 2/9] x86/hvm: introduce
 hvm_copy_context_and_params
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Tamas K Lengyel <tamas.lengyel@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Q3VycmVudGx5IHRoZSBodm0gcGFyYW1ldGVycyBhcmUgb25seSBhY2Nlc3NpYmxlIHZpYSB0aGUg
SFZNT1AgaHlwZXJjYWxscy4gSW4KdGhpcyBwYXRjaCB3ZSBpbnRyb2R1Y2UgYSBuZXcgZnVuY3Rp
b24gdGhhdCBjYW4gY29weSBib3RoIHRoZSBodm0gY29udGV4dCBhbmQKcGFyYW1ldGVycyBkaXJl
Y3RseSBpbnRvIGEgdGFyZ2V0IGRvbWFpbi4gTm8gZnVuY3Rpb25hbCBjaGFuZ2VzIGluIGV4aXN0
aW5nCmNvZGUuCgpTaWduZWQtb2ZmLWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxA
aW50ZWwuY29tPgotLS0KdjY6IGZpbmlzaCBhZGRyZXNzaW5nIGFsbCBvZiBKYW4ncyBjb21tZW50
cwotLS0KIHhlbi9hcmNoL3g4Ni9odm0vaHZtLmMgICAgICAgIHwgMjM2ICsrKysrKysrKysrKysr
KysrKysrKy0tLS0tLS0tLS0tLS0KIHhlbi9pbmNsdWRlL2FzbS14ODYvaHZtL2h2bS5oIHwgICAy
ICsKIDIgZmlsZXMgY2hhbmdlZCwgMTQ4IGluc2VydGlvbnMoKyksIDkwIGRlbGV0aW9ucygtKQoK
ZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMgYi94ZW4vYXJjaC94ODYvaHZtL2h2
bS5jCmluZGV4IDBiOTM2MDlhODIuLjA1MDVjNzU2NjEgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4
Ni9odm0vaHZtLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS9odm0uYwpAQCAtNDA3NywxNiArNDA3
NywxNyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9ldnRjaG5fdXBjYWxsX3ZlY3RvcigKIH0KIAog
c3RhdGljIGludCBodm1fYWxsb3dfc2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsCi0gICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RydWN0IHhlbl9odm1fcGFyYW0gKmEpCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgaW5kZXgsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgdWludDY0X3QgbmV3X3ZhbHVlKQogewotICAgIHVpbnQ2NF90
IHZhbHVlID0gZC0+YXJjaC5odm0ucGFyYW1zW2EtPmluZGV4XTsKKyAgICB1aW50NjRfdCB2YWx1
ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tpbmRleF07CiAgICAgaW50IHJjOwogCiAgICAgcmMgPSB4
c21faHZtX3BhcmFtKFhTTV9UQVJHRVQsIGQsIEhWTU9QX3NldF9wYXJhbSk7CiAgICAgaWYgKCBy
YyApCiAgICAgICAgIHJldHVybiByYzsKIAotICAgIHN3aXRjaCAoIGEtPmluZGV4ICkKKyAgICBz
d2l0Y2ggKCBpbmRleCApCiAgICAgewogICAgIC8qIFRoZSBmb2xsb3dpbmcgcGFyYW1ldGVycyBj
YW4gYmUgc2V0IGJ5IHRoZSBndWVzdC4gKi8KICAgICBjYXNlIEhWTV9QQVJBTV9DQUxMQkFDS19J
UlE6CkBAIC00MTE5LDcgKzQxMjAsNyBAQCBzdGF0aWMgaW50IGh2bV9hbGxvd19zZXRfcGFyYW0o
c3RydWN0IGRvbWFpbiAqZCwKICAgICBpZiAoIHJjICkKICAgICAgICAgcmV0dXJuIHJjOwogCi0g
ICAgc3dpdGNoICggYS0+aW5kZXggKQorICAgIHN3aXRjaCAoIGluZGV4ICkKICAgICB7CiAgICAg
LyogVGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzIHNob3VsZCBvbmx5IGJlIGNoYW5nZWQgb25jZS4g
Ki8KICAgICBjYXNlIEhWTV9QQVJBTV9WSVJJRElBTjoKQEAgLTQxMjksNyArNDEzMCw3IEBAIHN0
YXRpYyBpbnQgaHZtX2FsbG93X3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIGNhc2Ug
SFZNX1BBUkFNX05SX0lPUkVRX1NFUlZFUl9QQUdFUzoKICAgICBjYXNlIEhWTV9QQVJBTV9BTFRQ
Mk06CiAgICAgY2FzZSBIVk1fUEFSQU1fTUNBX0NBUDoKLSAgICAgICAgaWYgKCB2YWx1ZSAhPSAw
ICYmIGEtPnZhbHVlICE9IHZhbHVlICkKKyAgICAgICAgaWYgKCB2YWx1ZSAhPSAwICYmIG5ld192
YWx1ZSAhPSB2YWx1ZSApCiAgICAgICAgICAgICByYyA9IC1FRVhJU1Q7CiAgICAgICAgIGJyZWFr
OwogICAgIGRlZmF1bHQ6CkBAIC00MTM5LDQ5ICs0MTQwLDMyIEBAIHN0YXRpYyBpbnQgaHZtX2Fs
bG93X3NldF9wYXJhbShzdHJ1Y3QgZG9tYWluICpkLAogICAgIHJldHVybiByYzsKIH0KIAotc3Rh
dGljIGludCBodm1vcF9zZXRfcGFyYW0oCi0gICAgWEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5f
aHZtX3BhcmFtX3QpIGFyZykKK3N0YXRpYyBpbnQgaHZtX3NldF9wYXJhbShzdHJ1Y3QgZG9tYWlu
ICpkLCB1aW50MzJfdCBpbmRleCwgdWludDY0X3QgdmFsdWUpCiB7CiAgICAgc3RydWN0IGRvbWFp
biAqY3Vycl9kID0gY3VycmVudC0+ZG9tYWluOwotICAgIHN0cnVjdCB4ZW5faHZtX3BhcmFtIGE7
Ci0gICAgc3RydWN0IGRvbWFpbiAqZDsKICAgICBzdHJ1Y3QgdmNwdSAqdjsKICAgICBpbnQgcmM7
CiAKLSAgICBpZiAoIGNvcHlfZnJvbV9ndWVzdCgmYSwgYXJnLCAxKSApCi0gICAgICAgIHJldHVy
biAtRUZBVUxUOwotCi0gICAgaWYgKCBhLmluZGV4ID49IEhWTV9OUl9QQVJBTVMgKQorICAgIGlm
ICggaW5kZXggPj0gSFZNX05SX1BBUkFNUyApCiAgICAgICAgIHJldHVybiAtRUlOVkFMOwogCi0g
ICAgLyogTWFrZSBzdXJlIHRoZSBhYm92ZSBib3VuZCBjaGVjayBpcyBub3QgYnlwYXNzZWQgZHVy
aW5nIHNwZWN1bGF0aW9uLiAqLwotICAgIGJsb2NrX3NwZWN1bGF0aW9uKCk7Ci0KLSAgICBkID0g
cmN1X2xvY2tfZG9tYWluX2J5X2FueV9pZChhLmRvbWlkKTsKLSAgICBpZiAoIGQgPT0gTlVMTCAp
Ci0gICAgICAgIHJldHVybiAtRVNSQ0g7Ci0KLSAgICByYyA9IC1FSU5WQUw7Ci0gICAgaWYgKCAh
aXNfaHZtX2RvbWFpbihkKSApCi0gICAgICAgIGdvdG8gb3V0OwotCi0gICAgcmMgPSBodm1fYWxs
b3dfc2V0X3BhcmFtKGQsICZhKTsKKyAgICByYyA9IGh2bV9hbGxvd19zZXRfcGFyYW0oZCwgaW5k
ZXgsIHZhbHVlKTsKICAgICBpZiAoIHJjICkKICAgICAgICAgZ290byBvdXQ7CiAKLSAgICBzd2l0
Y2ggKCBhLmluZGV4ICkKKyAgICBzd2l0Y2ggKCBpbmRleCApCiAgICAgewogICAgIGNhc2UgSFZN
X1BBUkFNX0NBTExCQUNLX0lSUToKLSAgICAgICAgaHZtX3NldF9jYWxsYmFja192aWEoZCwgYS52
YWx1ZSk7CisgICAgICAgIGh2bV9zZXRfY2FsbGJhY2tfdmlhKGQsIHZhbHVlKTsKICAgICAgICAg
aHZtX2xhdGNoX3NoaW5mb19zaXplKGQpOwogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9Q
QVJBTV9USU1FUl9NT0RFOgotICAgICAgICBpZiAoIGEudmFsdWUgPiBIVk1QVE1fb25lX21pc3Nl
ZF90aWNrX3BlbmRpbmcgKQorICAgICAgICBpZiAoIHZhbHVlID4gSFZNUFRNX29uZV9taXNzZWRf
dGlja19wZW5kaW5nICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAgICAgICAgYnJlYWs7
CiAgICAgY2FzZSBIVk1fUEFSQU1fVklSSURJQU46Ci0gICAgICAgIGlmICggKGEudmFsdWUgJiB+
SFZNUFZfZmVhdHVyZV9tYXNrKSB8fAotICAgICAgICAgICAgICEoYS52YWx1ZSAmIEhWTVBWX2Jh
c2VfZnJlcSkgKQorICAgICAgICBpZiAoICh2YWx1ZSAmIH5IVk1QVl9mZWF0dXJlX21hc2spIHx8
CisgICAgICAgICAgICAgISh2YWx1ZSAmIEhWTVBWX2Jhc2VfZnJlcSkgKQogICAgICAgICAgICAg
cmMgPSAtRUlOVkFMOwogICAgICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJBTV9JREVOVF9Q
VDoKQEAgLTQxOTEsNyArNDE3NSw3IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFtKAogICAg
ICAgICAgKi8KICAgICAgICAgaWYgKCAhcGFnaW5nX21vZGVfaGFwKGQpIHx8ICFjcHVfaGFzX3Zt
eCApCiAgICAgICAgIHsKLSAgICAgICAgICAgIGQtPmFyY2guaHZtLnBhcmFtc1thLmluZGV4XSA9
IGEudmFsdWU7CisgICAgICAgICAgICBkLT5hcmNoLmh2bS5wYXJhbXNbaW5kZXhdID0gdmFsdWU7
CiAgICAgICAgICAgICBicmVhazsKICAgICAgICAgfQogCkBAIC00MjA2LDcgKzQxOTAsNyBAQCBz
dGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgKIAogICAgICAgICByYyA9IDA7CiAgICAgICAgIGRv
bWFpbl9wYXVzZShkKTsKLSAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1zW2EuaW5kZXhdID0gYS52
YWx1ZTsKKyAgICAgICAgZC0+YXJjaC5odm0ucGFyYW1zW2luZGV4XSA9IHZhbHVlOwogICAgICAg
ICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCiAgICAgICAgICAgICBwYWdpbmdfdXBkYXRlX2NyMyh2
LCBmYWxzZSk7CiAgICAgICAgIGRvbWFpbl91bnBhdXNlKGQpOwpAQCAtNDIxNSwyMyArNDE5OSwy
MyBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgKICAgICAgICAgYnJlYWs7CiAgICAgY2Fz
ZSBIVk1fUEFSQU1fRE1fRE9NQUlOOgogICAgICAgICAvKiBUaGUgb25seSB2YWx1ZSB0aGlzIHNo
b3VsZCBldmVyIGJlIHNldCB0byBpcyBET01JRF9TRUxGICovCi0gICAgICAgIGlmICggYS52YWx1
ZSAhPSBET01JRF9TRUxGICkKKyAgICAgICAgaWYgKCB2YWx1ZSAhPSBET01JRF9TRUxGICkKICAg
ICAgICAgICAgIHJjID0gLUVJTlZBTDsKIAotICAgICAgICBhLnZhbHVlID0gY3Vycl9kLT5kb21h
aW5faWQ7CisgICAgICAgIHZhbHVlID0gY3Vycl9kLT5kb21haW5faWQ7CiAgICAgICAgIGJyZWFr
OwogICAgIGNhc2UgSFZNX1BBUkFNX0FDUElfU19TVEFURToKICAgICAgICAgcmMgPSAwOwotICAg
ICAgICBpZiAoIGEudmFsdWUgPT0gMyApCisgICAgICAgIGlmICggdmFsdWUgPT0gMyApCiAgICAg
ICAgICAgICBodm1fczNfc3VzcGVuZChkKTsKLSAgICAgICAgZWxzZSBpZiAoIGEudmFsdWUgPT0g
MCApCisgICAgICAgIGVsc2UgaWYgKCB2YWx1ZSA9PSAwICkKICAgICAgICAgICAgIGh2bV9zM19y
ZXN1bWUoZCk7CiAgICAgICAgIGVsc2UKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKIAogICAg
ICAgICBicmVhazsKICAgICBjYXNlIEhWTV9QQVJBTV9BQ1BJX0lPUE9SVFNfTE9DQVRJT046Ci0g
ICAgICAgIHJjID0gcG10aW1lcl9jaGFuZ2VfaW9wb3J0KGQsIGEudmFsdWUpOworICAgICAgICBy
YyA9IHBtdGltZXJfY2hhbmdlX2lvcG9ydChkLCB2YWx1ZSk7CiAgICAgICAgIGJyZWFrOwogICAg
IGNhc2UgSFZNX1BBUkFNX01FTU9SWV9FVkVOVF9DUjA6CiAgICAgY2FzZSBIVk1fUEFSQU1fTUVN
T1JZX0VWRU5UX0NSMzoKQEAgLTQyNDYsMjQgKzQyMzAsMjQgQEAgc3RhdGljIGludCBodm1vcF9z
ZXRfcGFyYW0oCiAgICAgICAgIHJjID0geHNtX2h2bV9wYXJhbV9uZXN0ZWQoWFNNX1BSSVYsIGQp
OwogICAgICAgICBpZiAoIHJjICkKICAgICAgICAgICAgIGJyZWFrOwotICAgICAgICBpZiAoIGEu
dmFsdWUgPiAxICkKKyAgICAgICAgaWYgKCB2YWx1ZSA+IDEgKQogICAgICAgICAgICAgcmMgPSAt
RUlOVkFMOwogICAgICAgICAvKgogICAgICAgICAgKiBSZW1vdmUgdGhlIGNoZWNrIGJlbG93IG9u
Y2Ugd2UgaGF2ZQogICAgICAgICAgKiBzaGFkb3ctb24tc2hhZG93LgogICAgICAgICAgKi8KLSAg
ICAgICAgaWYgKCAhcGFnaW5nX21vZGVfaGFwKGQpICYmIGEudmFsdWUgKQorICAgICAgICBpZiAo
ICFwYWdpbmdfbW9kZV9oYXAoZCkgJiYgdmFsdWUgKQogICAgICAgICAgICAgcmMgPSAtRUlOVkFM
OwotICAgICAgICBpZiAoIGEudmFsdWUgJiYKKyAgICAgICAgaWYgKCB2YWx1ZSAmJgogICAgICAg
ICAgICAgIGQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1fQUxUUDJNXSApCiAgICAgICAgICAg
ICByYyA9IC1FSU5WQUw7CiAgICAgICAgIC8qIFNldCB1cCBOSFZNIHN0YXRlIGZvciBhbnkgdmNw
dXMgdGhhdCBhcmUgYWxyZWFkeSB1cC4gKi8KLSAgICAgICAgaWYgKCBhLnZhbHVlICYmCisgICAg
ICAgIGlmICggdmFsdWUgJiYKICAgICAgICAgICAgICAhZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9Q
QVJBTV9ORVNURURIVk1dICkKICAgICAgICAgICAgIGZvcl9lYWNoX3ZjcHUoZCwgdikKICAgICAg
ICAgICAgICAgICBpZiAoIHJjID09IDAgKQogICAgICAgICAgICAgICAgICAgICByYyA9IG5lc3Rl
ZGh2bV92Y3B1X2luaXRpYWxpc2Uodik7Ci0gICAgICAgIGlmICggIWEudmFsdWUgfHwgcmMgKQor
ICAgICAgICBpZiAoICF2YWx1ZSB8fCByYyApCiAgICAgICAgICAgICBmb3JfZWFjaF92Y3B1KGQs
IHYpCiAgICAgICAgICAgICAgICAgbmVzdGVkaHZtX3ZjcHVfZGVzdHJveSh2KTsKICAgICAgICAg
YnJlYWs7CkBAIC00MjcxLDMwICs0MjU1LDMwIEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0X3BhcmFt
KAogICAgICAgICByYyA9IHhzbV9odm1fcGFyYW1fYWx0cDJtaHZtKFhTTV9QUklWLCBkKTsKICAg
ICAgICAgaWYgKCByYyApCiAgICAgICAgICAgICBicmVhazsKLSAgICAgICAgaWYgKCBhLnZhbHVl
ID4gWEVOX0FMVFAyTV9saW1pdGVkICkKKyAgICAgICAgaWYgKCB2YWx1ZSA+IFhFTl9BTFRQMk1f
bGltaXRlZCApCiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7Ci0gICAgICAgIGlmICggYS52YWx1
ZSAmJgorICAgICAgICBpZiAoIHZhbHVlICYmCiAgICAgICAgICAgICAgZC0+YXJjaC5odm0ucGFy
YW1zW0hWTV9QQVJBTV9ORVNURURIVk1dICkKICAgICAgICAgICAgIHJjID0gLUVJTlZBTDsKICAg
ICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fVFJJUExFX0ZBVUxUX1JFQVNPTjoKLSAg
ICAgICAgaWYgKCBhLnZhbHVlID4gU0hVVERPV05fTUFYICkKKyAgICAgICAgaWYgKCB2YWx1ZSA+
IFNIVVRET1dOX01BWCApCiAgICAgICAgICAgICByYyA9IC1FSU5WQUw7CiAgICAgICAgIGJyZWFr
OwogICAgIGNhc2UgSFZNX1BBUkFNX0lPUkVRX1NFUlZFUl9QRk46Ci0gICAgICAgIGQtPmFyY2gu
aHZtLmlvcmVxX2dmbi5iYXNlID0gYS52YWx1ZTsKKyAgICAgICAgZC0+YXJjaC5odm0uaW9yZXFf
Z2ZuLmJhc2UgPSB2YWx1ZTsKICAgICAgICAgYnJlYWs7CiAgICAgY2FzZSBIVk1fUEFSQU1fTlJf
SU9SRVFfU0VSVkVSX1BBR0VTOgogICAgIHsKICAgICAgICAgdW5zaWduZWQgaW50IGk7CiAKLSAg
ICAgICAgaWYgKCBhLnZhbHVlID09IDAgfHwKLSAgICAgICAgICAgICBhLnZhbHVlID4gc2l6ZW9m
KGQtPmFyY2guaHZtLmlvcmVxX2dmbi5tYXNrKSAqIDggKQorICAgICAgICBpZiAoIHZhbHVlID09
IDAgfHwKKyAgICAgICAgICAgICB2YWx1ZSA+IHNpemVvZihkLT5hcmNoLmh2bS5pb3JlcV9nZm4u
bWFzaykgKiA4ICkKICAgICAgICAgewogICAgICAgICAgICAgcmMgPSAtRUlOVkFMOwogICAgICAg
ICAgICAgYnJlYWs7CiAgICAgICAgIH0KLSAgICAgICAgZm9yICggaSA9IDA7IGkgPCBhLnZhbHVl
OyBpKysgKQorICAgICAgICBmb3IgKCBpID0gMDsgaSA8IHZhbHVlOyBpKysgKQogICAgICAgICAg
ICAgc2V0X2JpdChpLCAmZC0+YXJjaC5odm0uaW9yZXFfZ2ZuLm1hc2spOwogCiAgICAgICAgIGJy
ZWFrOwpAQCAtNDMwNiwzNSArNDI5MCwzNSBAQCBzdGF0aWMgaW50IGh2bW9wX3NldF9wYXJhbSgK
ICAgICAgICAgICAgICAgICAgICAgIHNpemVvZihkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubGVnYWN5
X21hc2spICogOCk7CiAgICAgICAgIEJVSUxEX0JVR19PTihIVk1fUEFSQU1fQlVGSU9SRVFfUEZO
ID4KICAgICAgICAgICAgICAgICAgICAgIHNpemVvZihkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubGVn
YWN5X21hc2spICogOCk7Ci0gICAgICAgIGlmICggYS52YWx1ZSApCi0gICAgICAgICAgICBzZXRf
Yml0KGEuaW5kZXgsICZkLT5hcmNoLmh2bS5pb3JlcV9nZm4ubGVnYWN5X21hc2spOworICAgICAg
ICBpZiAoIHZhbHVlICkKKyAgICAgICAgICAgIHNldF9iaXQoaW5kZXgsICZkLT5hcmNoLmh2bS5p
b3JlcV9nZm4ubGVnYWN5X21hc2spOwogICAgICAgICBicmVhazsKIAogICAgIGNhc2UgSFZNX1BB
UkFNX1g4N19GSVBfV0lEVEg6Ci0gICAgICAgIGlmICggYS52YWx1ZSAhPSAwICYmIGEudmFsdWUg
IT0gNCAmJiBhLnZhbHVlICE9IDggKQorICAgICAgICBpZiAoIHZhbHVlICE9IDAgJiYgdmFsdWUg
IT0gNCAmJiB2YWx1ZSAhPSA4ICkKICAgICAgICAgewogICAgICAgICAgICAgcmMgPSAtRUlOVkFM
OwogICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIH0KLSAgICAgICAgZC0+YXJjaC54ODdfZmlw
X3dpZHRoID0gYS52YWx1ZTsKKyAgICAgICAgZC0+YXJjaC54ODdfZmlwX3dpZHRoID0gdmFsdWU7
CiAgICAgICAgIGJyZWFrOwogCiAgICAgY2FzZSBIVk1fUEFSQU1fVk04Nl9UU1M6CiAgICAgICAg
IC8qIEhhcmR3YXJlIHdvdWxkIHNpbGVudGx5IHRydW5jYXRlIGhpZ2ggYml0cy4gKi8KLSAgICAg
ICAgaWYgKCBhLnZhbHVlICE9ICh1aW50MzJfdClhLnZhbHVlICkKKyAgICAgICAgaWYgKCB2YWx1
ZSAhPSAodWludDMyX3QpdmFsdWUgKQogICAgICAgICB7CiAgICAgICAgICAgICBpZiAoIGQgPT0g
Y3Vycl9kICkKICAgICAgICAgICAgICAgICBkb21haW5fY3Jhc2goZCk7CiAgICAgICAgICAgICBy
YyA9IC1FSU5WQUw7CiAgICAgICAgIH0KICAgICAgICAgLyogT2xkIGh2bWxvYWRlciBiaW5hcmll
cyBoYXJkY29kZSB0aGUgc2l6ZSB0byAxMjggYnl0ZXMuICovCi0gICAgICAgIGlmICggYS52YWx1
ZSApCi0gICAgICAgICAgICBhLnZhbHVlIHw9ICgxMjhVTEwgPDwgMzIpIHwgVk04Nl9UU1NfVVBE
QVRFRDsKLSAgICAgICAgYS5pbmRleCA9IEhWTV9QQVJBTV9WTTg2X1RTU19TSVpFRDsKKyAgICAg
ICAgaWYgKCB2YWx1ZSApCisgICAgICAgICAgICB2YWx1ZSB8PSAoMTI4VUxMIDw8IDMyKSB8IFZN
ODZfVFNTX1VQREFURUQ7CisgICAgICAgIGluZGV4ID0gSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVE
OwogICAgICAgICBicmVhazsKIAogICAgIGNhc2UgSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEOgot
ICAgICAgICBpZiAoIChhLnZhbHVlID4+IDMyKSA8IHNpemVvZihzdHJ1Y3QgdHNzMzIpICkKKyAg
ICAgICAgaWYgKCAodmFsdWUgPj4gMzIpIDwgc2l6ZW9mKHN0cnVjdCB0c3MzMikgKQogICAgICAg
ICB7CiAgICAgICAgICAgICBpZiAoIGQgPT0gY3Vycl9kICkKICAgICAgICAgICAgICAgICBkb21h
aW5fY3Jhc2goZCk7CkBAIC00MzQ1LDI2ICs0MzI5LDU2IEBAIHN0YXRpYyBpbnQgaHZtb3Bfc2V0
X3BhcmFtKAogICAgICAgICAgKiAyNTYgYml0cyBpbnRlcnJ1cHQgcmVkaXJlY3Rpb24gYml0bWFw
ICsgNjRrIGJpdHMgSS9PIGJpdG1hcAogICAgICAgICAgKiBwbHVzIG9uZSBwYWRkaW5nIGJ5dGUp
LgogICAgICAgICAgKi8KLSAgICAgICAgaWYgKCAoYS52YWx1ZSA+PiAzMikgPiBzaXplb2Yoc3Ry
dWN0IHRzczMyKSArCisgICAgICAgIGlmICggKHZhbHVlID4+IDMyKSA+IHNpemVvZihzdHJ1Y3Qg
dHNzMzIpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMHgxMDAgLyA4KSArICgw
eDEwMDAwIC8gOCkgKyAxICkKLSAgICAgICAgICAgIGEudmFsdWUgPSAodWludDMyX3QpYS52YWx1
ZSB8CisgICAgICAgICAgICB2YWx1ZSA9ICh1aW50MzJfdCl2YWx1ZSB8CiAgICAgICAgICAgICAg
ICAgICAgICAgKChzaXplb2Yoc3RydWN0IHRzczMyKSArICgweDEwMCAvIDgpICsKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKDB4MTAwMDAgLyA4KSArIDEp
IDw8IDMyKTsKLSAgICAgICAgYS52YWx1ZSB8PSBWTTg2X1RTU19VUERBVEVEOworICAgICAgICB2
YWx1ZSB8PSBWTTg2X1RTU19VUERBVEVEOwogICAgICAgICBicmVhazsKIAogICAgIGNhc2UgSFZN
X1BBUkFNX01DQV9DQVA6Ci0gICAgICAgIHJjID0gdm1jZV9lbmFibGVfbWNhX2NhcChkLCBhLnZh
bHVlKTsKKyAgICAgICAgcmMgPSB2bWNlX2VuYWJsZV9tY2FfY2FwKGQsIHZhbHVlKTsKICAgICAg
ICAgYnJlYWs7CiAgICAgfQogCiAgICAgaWYgKCByYyAhPSAwICkKICAgICAgICAgZ290byBvdXQ7
CiAKLSAgICBkLT5hcmNoLmh2bS5wYXJhbXNbYS5pbmRleF0gPSBhLnZhbHVlOworICAgIGQtPmFy
Y2guaHZtLnBhcmFtc1tpbmRleF0gPSB2YWx1ZTsKIAogICAgIEhWTV9EQkdfTE9HKERCR19MRVZF
TF9IQ0FMTCwgInNldCBwYXJhbSAldSA9ICUiUFJJeDY0LAotICAgICAgICAgICAgICAgIGEuaW5k
ZXgsIGEudmFsdWUpOworICAgICAgICAgICAgICAgIGluZGV4LCB2YWx1ZSk7CisKKyBvdXQ6Cisg
ICAgcmV0dXJuIHJjOworfQorCitpbnQgaHZtb3Bfc2V0X3BhcmFtKAorICAgIFhFTl9HVUVTVF9I
QU5ETEVfUEFSQU0oeGVuX2h2bV9wYXJhbV90KSBhcmcpCit7CisgICAgc3RydWN0IHhlbl9odm1f
cGFyYW0gYTsKKyAgICBzdHJ1Y3QgZG9tYWluICpkOworICAgIGludCByYzsKKworICAgIGlmICgg
Y29weV9mcm9tX2d1ZXN0KCZhLCBhcmcsIDEpICkKKyAgICAgICAgcmV0dXJuIC1FRkFVTFQ7CisK
KyAgICBpZiAoIGEuaW5kZXggPj0gSFZNX05SX1BBUkFNUyApCisgICAgICAgIHJldHVybiAtRUlO
VkFMOworCisgICAgLyogTWFrZSBzdXJlIHRoZSBhYm92ZSBib3VuZCBjaGVjayBpcyBub3QgYnlw
YXNzZWQgZHVyaW5nIHNwZWN1bGF0aW9uLiAqLworICAgIGJsb2NrX3NwZWN1bGF0aW9uKCk7CisK
KyAgICBkID0gcmN1X2xvY2tfZG9tYWluX2J5X2FueV9pZChhLmRvbWlkKTsKKyAgICBpZiAoIGQg
PT0gTlVMTCApCisgICAgICAgIHJldHVybiAtRVNSQ0g7CisKKyAgICByYyA9IC1FSU5WQUw7Cisg
ICAgaWYgKCAhaXNfaHZtX2RvbWFpbihkKSApCisgICAgICAgIGdvdG8gb3V0OworCisgICAgcmMg
PSBodm1fc2V0X3BhcmFtKGQsIGEuaW5kZXgsIGEudmFsdWUpOwogCiAgb3V0OgogICAgIHJjdV91
bmxvY2tfZG9tYWluKGQpOwpAQCAtNDM3Miw3ICs0Mzg2LDcgQEAgc3RhdGljIGludCBodm1vcF9z
ZXRfcGFyYW0oCiB9CiAKIHN0YXRpYyBpbnQgaHZtX2FsbG93X2dldF9wYXJhbShzdHJ1Y3QgZG9t
YWluICpkLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cnVjdCB4ZW5f
aHZtX3BhcmFtICphKQorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90IGlu
ZGV4KQogewogICAgIGludCByYzsKIApAQCAtNDM4MCw3ICs0Mzk0LDcgQEAgc3RhdGljIGludCBo
dm1fYWxsb3dfZ2V0X3BhcmFtKHN0cnVjdCBkb21haW4gKmQsCiAgICAgaWYgKCByYyApCiAgICAg
ICAgIHJldHVybiByYzsKIAotICAgIHN3aXRjaCAoIGEtPmluZGV4ICkKKyAgICBzd2l0Y2ggKCBp
bmRleCApCiAgICAgewogICAgIC8qIFRoZSBmb2xsb3dpbmcgcGFyYW1ldGVycyBjYW4gYmUgcmVh
ZCBieSB0aGUgZ3Vlc3QuICovCiAgICAgY2FzZSBIVk1fUEFSQU1fQ0FMTEJBQ0tfSVJROgpAQCAt
NDQxMCw2ICs0NDI0LDQwIEBAIHN0YXRpYyBpbnQgaHZtX2FsbG93X2dldF9wYXJhbShzdHJ1Y3Qg
ZG9tYWluICpkLAogICAgIHJldHVybiByYzsKIH0KIAorc3RhdGljIGludCBodm1fZ2V0X3BhcmFt
KHN0cnVjdCBkb21haW4gKmQsIHVpbnQzMl90IGluZGV4LCB1aW50NjRfdCAqdmFsdWUpCit7Cisg
ICAgaW50IHJjOworCisgICAgcmMgPSBodm1fYWxsb3dfZ2V0X3BhcmFtKGQsIGluZGV4KTsKKyAg
ICBpZiAoIHJjICkKKyAgICAgICAgcmV0dXJuIHJjOworCisgICAgc3dpdGNoICggaW5kZXggKQor
ICAgIHsKKyAgICBjYXNlIEhWTV9QQVJBTV9BQ1BJX1NfU1RBVEU6CisgICAgICAgICp2YWx1ZSA9
IGQtPmFyY2guaHZtLmlzX3MzX3N1c3BlbmRlZCA/IDMgOiAwOworICAgICAgICBicmVhazsKKwor
ICAgIGNhc2UgSFZNX1BBUkFNX1ZNODZfVFNTOgorICAgICAgICAqdmFsdWUgPSAodWludDMyX3Qp
ZC0+YXJjaC5odm0ucGFyYW1zW0hWTV9QQVJBTV9WTTg2X1RTU19TSVpFRF07CisgICAgICAgIGJy
ZWFrOworCisgICAgY2FzZSBIVk1fUEFSQU1fVk04Nl9UU1NfU0laRUQ6CisgICAgICAgICp2YWx1
ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1fVk04Nl9UU1NfU0laRURdICYKKyAgICAg
ICAgICAgICAgICAgICB+Vk04Nl9UU1NfVVBEQVRFRDsKKyAgICAgICAgYnJlYWs7CisKKyAgICBj
YXNlIEhWTV9QQVJBTV9YODdfRklQX1dJRFRIOgorICAgICAgICAqdmFsdWUgPSBkLT5hcmNoLng4
N19maXBfd2lkdGg7CisgICAgICAgIGJyZWFrOworICAgIGRlZmF1bHQ6CisgICAgICAgICp2YWx1
ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tpbmRleF07CisgICAgICAgIGJyZWFrOworICAgIH0KKwor
ICAgIHJldHVybiAwOworfTsKKwogc3RhdGljIGludCBodm1vcF9nZXRfcGFyYW0oCiAgICAgWEVO
X0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5faHZtX3BhcmFtX3QpIGFyZykKIHsKQEAgLTQ0MzQsMzMg
KzQ0ODIsMTAgQEAgc3RhdGljIGludCBodm1vcF9nZXRfcGFyYW0oCiAgICAgaWYgKCAhaXNfaHZt
X2RvbWFpbihkKSApCiAgICAgICAgIGdvdG8gb3V0OwogCi0gICAgcmMgPSBodm1fYWxsb3dfZ2V0
X3BhcmFtKGQsICZhKTsKKyAgICByYyA9IGh2bV9nZXRfcGFyYW0oZCwgYS5pbmRleCwgJmEudmFs
dWUpOwogICAgIGlmICggcmMgKQogICAgICAgICBnb3RvIG91dDsKIAotICAgIHN3aXRjaCAoIGEu
aW5kZXggKQotICAgIHsKLSAgICBjYXNlIEhWTV9QQVJBTV9BQ1BJX1NfU1RBVEU6Ci0gICAgICAg
IGEudmFsdWUgPSBkLT5hcmNoLmh2bS5pc19zM19zdXNwZW5kZWQgPyAzIDogMDsKLSAgICAgICAg
YnJlYWs7Ci0KLSAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RTUzoKLSAgICAgICAgYS52YWx1ZSA9
ICh1aW50MzJfdClkLT5hcmNoLmh2bS5wYXJhbXNbSFZNX1BBUkFNX1ZNODZfVFNTX1NJWkVEXTsK
LSAgICAgICAgYnJlYWs7Ci0KLSAgICBjYXNlIEhWTV9QQVJBTV9WTTg2X1RTU19TSVpFRDoKLSAg
ICAgICAgYS52YWx1ZSA9IGQtPmFyY2guaHZtLnBhcmFtc1tIVk1fUEFSQU1fVk04Nl9UU1NfU0la
RURdICYKLSAgICAgICAgICAgICAgICAgIH5WTTg2X1RTU19VUERBVEVEOwotICAgICAgICBicmVh
azsKLQotICAgIGNhc2UgSFZNX1BBUkFNX1g4N19GSVBfV0lEVEg6Ci0gICAgICAgIGEudmFsdWUg
PSBkLT5hcmNoLng4N19maXBfd2lkdGg7Ci0gICAgICAgIGJyZWFrOwotICAgIGRlZmF1bHQ6Ci0g
ICAgICAgIGEudmFsdWUgPSBkLT5hcmNoLmh2bS5wYXJhbXNbYS5pbmRleF07Ci0gICAgICAgIGJy
ZWFrOwotICAgIH0KLQogICAgIHJjID0gX19jb3B5X3RvX2d1ZXN0KGFyZywgJmEsIDEpID8gLUVG
QVVMVCA6IDA7CiAKICAgICBIVk1fREJHX0xPRyhEQkdfTEVWRUxfSENBTEwsICJnZXQgcGFyYW0g
JXUgPSAlIlBSSXg2NCwKQEAgLTUyOTcsNiArNTMyMiwzNyBAQCB2b2lkIGh2bV9zZXRfc2VnbWVu
dF9yZWdpc3RlcihzdHJ1Y3QgdmNwdSAqdiwgZW51bSB4ODZfc2VnbWVudCBzZWcsCiAgICAgYWx0
ZXJuYXRpdmVfdmNhbGwoaHZtX2Z1bmNzLnNldF9zZWdtZW50X3JlZ2lzdGVyLCB2LCBzZWcsIHJl
Zyk7CiB9CiAKK2ludCBodm1fY29weV9jb250ZXh0X2FuZF9wYXJhbXMoc3RydWN0IGRvbWFpbiAq
ZHN0LCBzdHJ1Y3QgZG9tYWluICpzcmMpCit7CisgICAgaW50IHJjOworICAgIHVuc2lnbmVkIGlu
dCBpOworICAgIHN0cnVjdCBodm1fZG9tYWluX2NvbnRleHQgYyA9IHsgfTsKKworICAgIGZvciAo
IGkgPSAwOyBpIDwgSFZNX05SX1BBUkFNUzsgaSsrICkKKyAgICB7CisgICAgICAgIHVpbnQ2NF90
IHZhbHVlID0gMDsKKworICAgICAgICBpZiAoIGh2bV9nZXRfcGFyYW0oc3JjLCBpLCAmdmFsdWUp
IHx8ICF2YWx1ZSApCisgICAgICAgICAgICBjb250aW51ZTsKKworICAgICAgICBpZiAoIChyYyA9
IGh2bV9zZXRfcGFyYW0oZHN0LCBpLCB2YWx1ZSkpICkKKyAgICAgICAgICAgIHJldHVybiByYzsK
KyAgICB9CisKKyAgICBjLnNpemUgPSBodm1fc2F2ZV9zaXplKHNyYyk7CisgICAgaWYgKCAoYy5k
YXRhID0gdm1hbGxvYyhjLnNpemUpKSA9PSBOVUxMICkKKyAgICAgICAgcmV0dXJuIC1FTk9NRU07
CisKKyAgICBpZiAoICEocmMgPSBodm1fc2F2ZShzcmMsICZjKSkgKQorICAgIHsKKyAgICAgICAg
Yy5jdXIgPSAwOworICAgICAgICByYyA9IGh2bV9sb2FkKGRzdCwgJmMpOworICAgIH0KKworICAg
IHZmcmVlKGMuZGF0YSk7CisgICAgcmV0dXJuIHJjOworfQorCiAvKgogICogTG9jYWwgdmFyaWFi
bGVzOgogICogbW9kZTogQwpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9odm0vaHZt
LmggYi94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaAppbmRleCA5ZWFiMWQ3NDkzLi4yNGRh
ODI0Y2JmIDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaAorKysgYi94
ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9odm0uaApAQCAtMzM3LDYgKzMzNyw4IEBAIHVuc2lnbmVk
IGxvbmcgaHZtX2NyNF9ndWVzdF92YWxpZF9iaXRzKGNvbnN0IHN0cnVjdCBkb21haW4gKmQsIGJv
b2wgcmVzdG9yZSk7CiBib29sIGh2bV9mbHVzaF92Y3B1X3RsYihib29sICgqZmx1c2hfdmNwdSko
dm9pZCAqY3R4dCwgc3RydWN0IHZjcHUgKnYpLAogICAgICAgICAgICAgICAgICAgICAgICAgdm9p
ZCAqY3R4dCk7CiAKK2ludCBodm1fY29weV9jb250ZXh0X2FuZF9wYXJhbXMoc3RydWN0IGRvbWFp
biAqc3JjLCBzdHJ1Y3QgZG9tYWluICpkc3QpOworCiAjaWZkZWYgQ09ORklHX0hWTQogCiAjZGVm
aW5lIGh2bV9nZXRfZ3Vlc3RfdHNjKHYpIGh2bV9nZXRfZ3Vlc3RfdHNjX2ZpeGVkKHYsIDApCi0t
IAoyLjIwLjEKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
XwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpo
dHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 5988FBFF9E
	for <lists+xen-devel@lfdr.de>; Fri, 27 Sep 2019 09:04:39 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDkGi-0004ir-Ep; Fri, 27 Sep 2019 07:02:20 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Rbpq=XW=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iDkGf-0004eq-R2
 for xen-devel@lists.xenproject.org; Fri, 27 Sep 2019 07:02:17 +0000
X-Inumbo-ID: 92097eac-e0f4-11e9-bf31-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 92097eac-e0f4-11e9-bf31-bc764e2007e4;
 Fri, 27 Sep 2019 07:01:08 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id A0D72AFBE;
 Fri, 27 Sep 2019 07:01:01 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 27 Sep 2019 09:00:28 +0200
Message-Id: <20190927070050.12405-25-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190927070050.12405-1-jgross@suse.com>
References: <20190927070050.12405-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v4 24/46] xen: switch from for_each_vcpu() to
 for_each_sched_unit()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlcmUgYXBwcm9wcmlhdGUgc3dpdGNoIGZyb20gZm9yX2VhY2hfdmNwdSgpIHRvIGZvcl9lYWNo
X3NjaGVkX3VuaXQoKQppbiBvcmRlciB0byBwcmVwYXJlIGNvcmUgc2NoZWR1bGluZy4KCkFzIGl0
IGlzIGJlbmVmaWNpYWwgb25jZSBoZXJlIGFuZCBmb3Igc3VyZSBpbiBmdXR1cmUgYWRkIGEKdW5p
dF9zY2hlZHVsZXIoKSBoZWxwZXIgYW5kIGxldCB2Y3B1X3NjaGVkdWxlcigpIHVzZSBpdC4KClNp
Z25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tClYyOgotIGhh
bmRsZSBhZmZpbml0eV9icm9rZW4gY29ycmVjdGx5IChKYW4gQmV1bGljaCkKLSBhZGQgdW5pdF9z
Y2hlZHVsZXIoKSAoSmFuIEJldWxpY2gpClYzOgotIGFkZCBjb25zdCAoSmFuIEJldWxpY2gpCi0g
YWRkIFRPRE9zIGZvciBtaXNzaW5nIG11bHRpcGxlIHZjcHUgcGVyIHVuaXQgc3VwcG9ydCAoSmFu
IEJldWxpY2gpClY0OgotIHNpbXBsaWZ5IHRlc3QgZm9yIGNvcnJlY3QgY3B1IChKYW4gQmV1bGlj
aCkKLSByZW1vdmUgc3RhbGUgY2hhbmdlIChKYW4gQmV1bGljaCkKLSB1c2Ugc2NoZWRfY2hlY2tf
YWZmaW5pdHlfYnJva2VuKHVuaXQpIChKYW4gQmV1bGljaCkKLS0tCiB4ZW4vY29tbW9uL2RvbWFp
bi5jICAgfCAgIDkgKystCiB4ZW4vY29tbW9uL3NjaGVkdWxlLmMgfCAxNTUgKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0KIDIgZmlsZXMgY2hhbmdlZCwg
MTAwIGluc2VydGlvbnMoKyksIDY0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9jb21t
b24vZG9tYWluLmMgYi94ZW4vY29tbW9uL2RvbWFpbi5jCmluZGV4IGIzM2E3MDMxZWQuLjY5OWU2
MzM2MWIgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vZG9tYWluLmMKKysrIGIveGVuL2NvbW1vbi9k
b21haW4uYwpAQCAtNTY4LDcgKzU2OCw3IEBAIHZvaWQgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmlu
aXR5KHN0cnVjdCBkb21haW4gKmQpCiAgICAgY3B1bWFza192YXJfdCBkb21fY3B1bWFzaywgZG9t
X2NwdW1hc2tfc29mdDsKICAgICBjcHVtYXNrX3QgKmRvbV9hZmZpbml0eTsKICAgICBjb25zdCBj
cHVtYXNrX3QgKm9ubGluZTsKLSAgICBzdHJ1Y3QgdmNwdSAqdjsKKyAgICBzdHJ1Y3Qgc2NoZWRf
dW5pdCAqdW5pdDsKICAgICB1bnNpZ25lZCBpbnQgY3B1OwogCiAgICAgLyogRG8gd2UgaGF2ZSB2
Y3B1cyBhbHJlYWR5PyBJZiBub3QsIG5vIG5lZWQgdG8gdXBkYXRlIG5vZGUtYWZmaW5pdHkuICov
CkBAIC02MDEsMTIgKzYwMSwxMSBAQCB2b2lkIGRvbWFpbl91cGRhdGVfbm9kZV9hZmZpbml0eShz
dHJ1Y3QgZG9tYWluICpkKQogICAgICAgICAgKiBhbmQgdGhlIGZ1bGwgbWFzayBvZiB3aGVyZSBp
dCB3b3VsZCBwcmVmZXIgdG8gcnVuICh0aGUgdW5pb24gb2YKICAgICAgICAgICogdGhlIHNvZnQg
YWZmaW5pdHkgb2YgYWxsIGl0cyB2YXJpb3VzIHZjcHVzKS4gTGV0J3MgYnVpbGQgdGhlbS4KICAg
ICAgICAgICovCi0gICAgICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICAgICAgZm9yX2Vh
Y2hfc2NoZWRfdW5pdCAoIGQsIHVuaXQgKQogICAgICAgICB7Ci0gICAgICAgICAgICBjcHVtYXNr
X29yKGRvbV9jcHVtYXNrLCBkb21fY3B1bWFzaywKLSAgICAgICAgICAgICAgICAgICAgICAgdi0+
c2NoZWRfdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHkpOworICAgICAgICAgICAgY3B1bWFza19vcihk
b21fY3B1bWFzaywgZG9tX2NwdW1hc2ssIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5KTsKICAgICAg
ICAgICAgIGNwdW1hc2tfb3IoZG9tX2NwdW1hc2tfc29mdCwgZG9tX2NwdW1hc2tfc29mdCwKLSAg
ICAgICAgICAgICAgICAgICAgICAgdi0+c2NoZWRfdW5pdC0+Y3B1X3NvZnRfYWZmaW5pdHkpOwor
ICAgICAgICAgICAgICAgICAgICAgICB1bml0LT5jcHVfc29mdF9hZmZpbml0eSk7CiAgICAgICAg
IH0KICAgICAgICAgLyogRmlsdGVyIG91dCBub24tb25saW5lIGNwdXMgKi8KICAgICAgICAgY3B1
bWFza19hbmQoZG9tX2NwdW1hc2ssIGRvbV9jcHVtYXNrLCBvbmxpbmUpOwpkaWZmIC0tZ2l0IGEv
eGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCmluZGV4IDQ2ZjNj
ODVjYzUuLmRjNjhjYjkxMmUgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWR1bGUuYworKysg
Yi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTE1NywyNiArMTU3LDMyIEBAIHN0YXRpYyBpbmxp
bmUgc3RydWN0IHNjaGVkdWxlciAqZG9tX3NjaGVkdWxlcihjb25zdCBzdHJ1Y3QgZG9tYWluICpk
KQogICAgIHJldHVybiAmb3BzOwogfQogCi1zdGF0aWMgaW5saW5lIHN0cnVjdCBzY2hlZHVsZXIg
KnZjcHVfc2NoZWR1bGVyKGNvbnN0IHN0cnVjdCB2Y3B1ICp2KQorc3RhdGljIGlubGluZSBzdHJ1
Y3Qgc2NoZWR1bGVyICp1bml0X3NjaGVkdWxlcihjb25zdCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5p
dCkKIHsKLSAgICBzdHJ1Y3QgZG9tYWluICpkID0gdi0+ZG9tYWluOworICAgIHN0cnVjdCBkb21h
aW4gKmQgPSB1bml0LT5kb21haW47CiAKICAgICBpZiAoIGxpa2VseShkLT5jcHVwb29sICE9IE5V
TEwpICkKICAgICAgICAgcmV0dXJuIGQtPmNwdXBvb2wtPnNjaGVkOwogCiAgICAgLyoKLSAgICAg
KiBJZiBkLT5jcHVwb29sIGlzIE5VTEwsIHRoaXMgaXMgYSB2Q1BVIG9mIHRoZSBpZGxlIGRvbWFp
bi4gQW5kIHRoaXMKKyAgICAgKiBJZiBkLT5jcHVwb29sIGlzIE5VTEwsIHRoaXMgaXMgYSB1bml0
IG9mIHRoZSBpZGxlIGRvbWFpbi4gQW5kIHRoaXMKICAgICAgKiBjYXNlIGlzIHNwZWNpYWwgYmVj
YXVzZSB0aGUgaWRsZSBkb21haW4gZG9lcyBub3QgcmVhbGx5IGJlbG9uZyB0bwogICAgICAqIGEg
Y3B1cG9vbCBhbmQsIGhlbmNlLCBkb2Vzbid0IHJlYWxseSBoYXZlIGEgc2NoZWR1bGVyKS4gSW4g
ZmFjdCwgaXRzCi0gICAgICogdkNQVXMgKG1heSkgcnVuIG9uIHBDUFVzIHdoaWNoIGFyZSBpbiBk
aWZmZXJlbnQgcG9vbHMsIHdpdGggZGlmZmVyZW50CisgICAgICogdW5pdHMgKG1heSkgcnVuIG9u
IHBDUFVzIHdoaWNoIGFyZSBpbiBkaWZmZXJlbnQgcG9vbHMsIHdpdGggZGlmZmVyZW50CiAgICAg
ICogc2NoZWR1bGVycy4KICAgICAgKgogICAgICAqIFdoYXQgd2Ugd2FudCwgaW4gdGhpcyBjYXNl
LCBpcyB0aGUgc2NoZWR1bGVyIG9mIHRoZSBwQ1BVIHdoZXJlIHRoaXMKLSAgICAgKiBwYXJ0aWN1
bGFyIGlkbGUgdkNQVSBpcyBydW5uaW5nLiBBbmQsIHNpbmNlIHYtPnByb2Nlc3NvciBuZXZlciBj
aGFuZ2VzCi0gICAgICogZm9yIGlkbGUgdkNQVXMsIGl0IGlzIHNhZmUgdG8gdXNlIGl0LCB3aXRo
IG5vIGxvY2tzLCB0byBmaWd1cmUgdGhhdCBvdXQuCisgICAgICogcGFydGljdWxhciBpZGxlIHVu
aXQgaXMgcnVubmluZy4gQW5kLCBzaW5jZSB1bml0LT5yZXMgbmV2ZXIgY2hhbmdlcworICAgICAq
IGZvciBpZGxlIHVuaXRzLCBpdCBpcyBzYWZlIHRvIHVzZSBpdCwgd2l0aCBubyBsb2NrcywgdG8g
ZmlndXJlIHRoYXQgb3V0LgogICAgICAqLworCiAgICAgQVNTRVJUKGlzX2lkbGVfZG9tYWluKGQp
KTsKLSAgICByZXR1cm4gcGVyX2NwdShzY2hlZHVsZXIsIHYtPnByb2Nlc3Nvcik7CisgICAgcmV0
dXJuIHBlcl9jcHUoc2NoZWR1bGVyLCB1bml0LT5yZXMtPm1hc3Rlcl9jcHUpOworfQorCitzdGF0
aWMgaW5saW5lIHN0cnVjdCBzY2hlZHVsZXIgKnZjcHVfc2NoZWR1bGVyKGNvbnN0IHN0cnVjdCB2
Y3B1ICp2KQoreworICAgIHJldHVybiB1bml0X3NjaGVkdWxlcih2LT5zY2hlZF91bml0KTsKIH0K
ICNkZWZpbmUgVkNQVTJPTkxJTkUoX3YpIGNwdXBvb2xfZG9tYWluX2NwdW1hc2soKF92KS0+ZG9t
YWluKQogCkBAIC01MDIsMTAgKzUwOCwxMSBAQCBzdGF0aWMgdm9pZCBzY2hlZF9tb3ZlX2lycXMo
Y29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiBpbnQgc2NoZWRfbW92ZV9kb21haW4oc3Ry
dWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wgKmMpCiB7CiAgICAgc3RydWN0IHZjcHUgKnY7
Ci0gICAgdW5zaWduZWQgaW50IG5ld19wOwotICAgIHZvaWQgKip2Y3B1X3ByaXY7CisgICAgc3Ry
dWN0IHNjaGVkX3VuaXQgKnVuaXQ7CisgICAgdW5zaWduZWQgaW50IG5ld19wLCB1bml0X2lkeDsK
KyAgICB2b2lkICoqdW5pdF9wcml2OwogICAgIHZvaWQgKmRvbWRhdGE7Ci0gICAgdm9pZCAqdmNw
dWRhdGE7CisgICAgdm9pZCAqdW5pdGRhdGE7CiAgICAgc3RydWN0IHNjaGVkdWxlciAqb2xkX29w
czsKICAgICB2b2lkICpvbGRfZG9tZGF0YTsKIApAQCAtNTE5LDI1ICs1MjYsMjcgQEAgaW50IHNj
aGVkX21vdmVfZG9tYWluKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpjKQogICAg
IGlmICggSVNfRVJSKGRvbWRhdGEpICkKICAgICAgICAgcmV0dXJuIFBUUl9FUlIoZG9tZGF0YSk7
CiAKLSAgICB2Y3B1X3ByaXYgPSB4emFsbG9jX2FycmF5KHZvaWQgKiwgZC0+bWF4X3ZjcHVzKTsK
LSAgICBpZiAoIHZjcHVfcHJpdiA9PSBOVUxMICkKKyAgICAvKiBUT0RPOiBmaXggYXJyYXkgc2l6
ZSB3aXRoIG11bHRpcGxlIHZjcHVzIHBlciB1bml0LiAqLworICAgIHVuaXRfcHJpdiA9IHh6YWxs
b2NfYXJyYXkodm9pZCAqLCBkLT5tYXhfdmNwdXMpOworICAgIGlmICggdW5pdF9wcml2ID09IE5V
TEwgKQogICAgIHsKICAgICAgICAgc2NoZWRfZnJlZV9kb21kYXRhKGMtPnNjaGVkLCBkb21kYXRh
KTsKICAgICAgICAgcmV0dXJuIC1FTk9NRU07CiAgICAgfQogCi0gICAgZm9yX2VhY2hfdmNwdSAo
IGQsIHYgKQorICAgIHVuaXRfaWR4ID0gMDsKKyAgICBmb3JfZWFjaF9zY2hlZF91bml0ICggZCwg
dW5pdCApCiAgICAgewotICAgICAgICB2Y3B1X3ByaXZbdi0+dmNwdV9pZF0gPSBzY2hlZF9hbGxv
Y191ZGF0YShjLT5zY2hlZCwgdi0+c2NoZWRfdW5pdCwKLSAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tZGF0YSk7Ci0gICAgICAgIGlmICggdmNwdV9w
cml2W3YtPnZjcHVfaWRdID09IE5VTEwgKQorICAgICAgICB1bml0X3ByaXZbdW5pdF9pZHhdID0g
c2NoZWRfYWxsb2NfdWRhdGEoYy0+c2NoZWQsIHVuaXQsIGRvbWRhdGEpOworICAgICAgICBpZiAo
IHVuaXRfcHJpdlt1bml0X2lkeF0gPT0gTlVMTCApCiAgICAgICAgIHsKLSAgICAgICAgICAgIGZv
cl9lYWNoX3ZjcHUgKCBkLCB2ICkKLSAgICAgICAgICAgICAgICBzY2hlZF9mcmVlX3VkYXRhKGMt
PnNjaGVkLCB2Y3B1X3ByaXZbdi0+dmNwdV9pZF0pOwotICAgICAgICAgICAgeGZyZWUodmNwdV9w
cml2KTsKKyAgICAgICAgICAgIGZvciAoIHVuaXRfaWR4ID0gMDsgdW5pdF9wcml2W3VuaXRfaWR4
XTsgdW5pdF9pZHgrKyApCisgICAgICAgICAgICAgICAgc2NoZWRfZnJlZV91ZGF0YShjLT5zY2hl
ZCwgdW5pdF9wcml2W3VuaXRfaWR4XSk7CisgICAgICAgICAgICB4ZnJlZSh1bml0X3ByaXYpOwog
ICAgICAgICAgICAgc2NoZWRfZnJlZV9kb21kYXRhKGMtPnNjaGVkLCBkb21kYXRhKTsKICAgICAg
ICAgICAgIHJldHVybiAtRU5PTUVNOwogICAgICAgICB9CisgICAgICAgIHVuaXRfaWR4Kys7CiAg
ICAgfQogCiAgICAgZG9tYWluX3BhdXNlKGQpOwpAQCAtNTQ1LDMwICs1NTQsMzYgQEAgaW50IHNj
aGVkX21vdmVfZG9tYWluKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpjKQogICAg
IG9sZF9vcHMgPSBkb21fc2NoZWR1bGVyKGQpOwogICAgIG9sZF9kb21kYXRhID0gZC0+c2NoZWRf
cHJpdjsKIAotICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICBmb3JfZWFjaF9zY2hlZF91
bml0ICggZCwgdW5pdCApCiAgICAgewotICAgICAgICBzY2hlZF9yZW1vdmVfdW5pdChvbGRfb3Bz
LCB2LT5zY2hlZF91bml0KTsKKyAgICAgICAgc2NoZWRfcmVtb3ZlX3VuaXQob2xkX29wcywgdW5p
dCk7CiAgICAgfQogCiAgICAgZC0+Y3B1cG9vbCA9IGM7CiAgICAgZC0+c2NoZWRfcHJpdiA9IGRv
bWRhdGE7CiAKICAgICBuZXdfcCA9IGNwdW1hc2tfZmlyc3QoYy0+Y3B1X3ZhbGlkKTsKLSAgICBm
b3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgdW5pdF9pZHggPSAwOworICAgIGZvcl9lYWNoX3Nj
aGVkX3VuaXQgKCBkLCB1bml0ICkKICAgICB7CiAgICAgICAgIHNwaW5sb2NrX3QgKmxvY2s7Cisg
ICAgICAgIHVuc2lnbmVkIGludCB1bml0X3AgPSBuZXdfcDsKIAotICAgICAgICB2Y3B1ZGF0YSA9
IHYtPnNjaGVkX3VuaXQtPnByaXY7CisgICAgICAgIHVuaXRkYXRhID0gdW5pdC0+cHJpdjsKIAot
ICAgICAgICBtaWdyYXRlX3RpbWVyKCZ2LT5wZXJpb2RpY190aW1lciwgbmV3X3ApOwotICAgICAg
ICBtaWdyYXRlX3RpbWVyKCZ2LT5zaW5nbGVzaG90X3RpbWVyLCBuZXdfcCk7Ci0gICAgICAgIG1p
Z3JhdGVfdGltZXIoJnYtPnBvbGxfdGltZXIsIG5ld19wKTsKKyAgICAgICAgZm9yX2VhY2hfc2No
ZWRfdW5pdF92Y3B1ICggdW5pdCwgdiApCisgICAgICAgIHsKKyAgICAgICAgICAgIG1pZ3JhdGVf
dGltZXIoJnYtPnBlcmlvZGljX3RpbWVyLCBuZXdfcCk7CisgICAgICAgICAgICBtaWdyYXRlX3Rp
bWVyKCZ2LT5zaW5nbGVzaG90X3RpbWVyLCBuZXdfcCk7CisgICAgICAgICAgICBtaWdyYXRlX3Rp
bWVyKCZ2LT5wb2xsX3RpbWVyLCBuZXdfcCk7CisgICAgICAgICAgICBuZXdfcCA9IGNwdW1hc2tf
Y3ljbGUobmV3X3AsIGMtPmNwdV92YWxpZCk7CisgICAgICAgIH0KIAotICAgICAgICBsb2NrID0g
dW5pdF9zY2hlZHVsZV9sb2NrX2lycSh2LT5zY2hlZF91bml0KTsKKyAgICAgICAgbG9jayA9IHVu
aXRfc2NoZWR1bGVfbG9ja19pcnEodW5pdCk7CiAKLSAgICAgICAgc2NoZWRfc2V0X2FmZmluaXR5
KHYtPnNjaGVkX3VuaXQsICZjcHVtYXNrX2FsbCwgJmNwdW1hc2tfYWxsKTsKKyAgICAgICAgc2No
ZWRfc2V0X2FmZmluaXR5KHVuaXQsICZjcHVtYXNrX2FsbCwgJmNwdW1hc2tfYWxsKTsKIAotICAg
ICAgICBzY2hlZF9zZXRfcmVzKHYtPnNjaGVkX3VuaXQsIGdldF9zY2hlZF9yZXMobmV3X3ApKTsK
KyAgICAgICAgc2NoZWRfc2V0X3Jlcyh1bml0LCBnZXRfc2NoZWRfcmVzKHVuaXRfcCkpOwogICAg
ICAgICAvKgogICAgICAgICAgKiBXaXRoIHYtPnByb2Nlc3NvciBtb2RpZmllZCB3ZSBtdXN0IG5v
dAogICAgICAgICAgKiAtIG1ha2UgYW55IGZ1cnRoZXIgY2hhbmdlcyBhc3N1bWluZyB3ZSBob2xk
IHRoZSBzY2hlZHVsZXIgbG9jaywKQEAgLTU3NiwxNSArNTkxLDE1IEBAIGludCBzY2hlZF9tb3Zl
X2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICAgICAgICov
CiAgICAgICAgIHNwaW5fdW5sb2NrX2lycShsb2NrKTsKIAotICAgICAgICB2LT5zY2hlZF91bml0
LT5wcml2ID0gdmNwdV9wcml2W3YtPnZjcHVfaWRdOworICAgICAgICB1bml0LT5wcml2ID0gdW5p
dF9wcml2W3VuaXRfaWR4XTsKICAgICAgICAgaWYgKCAhZC0+aXNfZHlpbmcgKQotICAgICAgICAg
ICAgc2NoZWRfbW92ZV9pcnFzKHYtPnNjaGVkX3VuaXQpOworICAgICAgICAgICAgc2NoZWRfbW92
ZV9pcnFzKHVuaXQpOwogCi0gICAgICAgIG5ld19wID0gY3B1bWFza19jeWNsZShuZXdfcCwgYy0+
Y3B1X3ZhbGlkKTsKKyAgICAgICAgc2NoZWRfaW5zZXJ0X3VuaXQoYy0+c2NoZWQsIHVuaXQpOwog
Ci0gICAgICAgIHNjaGVkX2luc2VydF91bml0KGMtPnNjaGVkLCB2LT5zY2hlZF91bml0KTsKKyAg
ICAgICAgc2NoZWRfZnJlZV91ZGF0YShvbGRfb3BzLCB1bml0ZGF0YSk7CiAKLSAgICAgICAgc2No
ZWRfZnJlZV91ZGF0YShvbGRfb3BzLCB2Y3B1ZGF0YSk7CisgICAgICAgIHVuaXRfaWR4Kys7CiAg
ICAgfQogCiAgICAgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmluaXR5KGQpOwpAQCAtNTkzLDcgKzYw
OCw3IEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgY3B1
cG9vbCAqYykKIAogICAgIHNjaGVkX2ZyZWVfZG9tZGF0YShvbGRfb3BzLCBvbGRfZG9tZGF0YSk7
CiAKLSAgICB4ZnJlZSh2Y3B1X3ByaXYpOworICAgIHhmcmVlKHVuaXRfcHJpdik7CiAKICAgICBy
ZXR1cm4gMDsKIH0KQEAgLTg3NywxOCArODkyLDM2IEBAIHN0YXRpYyB2b2lkIHZjcHVfbWlncmF0
ZV9maW5pc2goc3RydWN0IHZjcHUgKnYpCiAgICAgdmNwdV93YWtlKHYpOwogfQogCitzdGF0aWMg
Ym9vbCBzY2hlZF9jaGVja19hZmZpbml0eV9icm9rZW4oY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQg
KnVuaXQpCit7CisgICAgY29uc3Qgc3RydWN0IHZjcHUgKnY7CisKKyAgICBmb3JfZWFjaF9zY2hl
ZF91bml0X3ZjcHUgKCB1bml0LCB2ICkKKyAgICAgICAgaWYgKCB2LT5hZmZpbml0eV9icm9rZW4g
KQorICAgICAgICAgICAgcmV0dXJuIHRydWU7CisKKyAgICByZXR1cm4gZmFsc2U7Cit9CisKK3N0
YXRpYyB2b2lkIHNjaGVkX3Jlc2V0X2FmZmluaXR5X2Jyb2tlbihzdHJ1Y3Qgc2NoZWRfdW5pdCAq
dW5pdCkKK3sKKyAgICBzdHJ1Y3QgdmNwdSAqdjsKKworICAgIGZvcl9lYWNoX3NjaGVkX3VuaXRf
dmNwdSAoIHVuaXQsIHYgKQorICAgICAgICB2LT5hZmZpbml0eV9icm9rZW4gPSBmYWxzZTsKK30K
Kwogdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKIHsKICAgICB1
bnNpZ25lZCBpbnQgY3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOwotICAgIHN0cnVjdCB2Y3B1ICp2
OworICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0OwogCiAgICAgQVNTRVJUKHN5c3RlbV9zdGF0
ZSA9PSBTWVNfU1RBVEVfcmVzdW1lKTsKIAotICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAg
ICBmb3JfZWFjaF9zY2hlZF91bml0ICggZCwgdW5pdCApCiAgICAgewogICAgICAgICBzcGlubG9j
a190ICpsb2NrOwotICAgICAgICB1bnNpZ25lZCBpbnQgb2xkX2NwdSA9IHYtPnByb2Nlc3NvcjsK
LSAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSB2LT5zY2hlZF91bml0OworICAgICAg
ICB1bnNpZ25lZCBpbnQgb2xkX2NwdSA9IHNjaGVkX3VuaXRfbWFzdGVyKHVuaXQpOwogICAgICAg
ICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnJlczsKIAogICAgICAgICBBU1NFUlQoIXVuaXRfcnVu
bmFibGUodW5pdCkpOwpAQCAtOTA3LDE3ICs5NDAsMTkgQEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZm
aW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAgICAgICAgICAgICAgY3B1cG9vbF9kb21h
aW5fY3B1bWFzayhkKSk7CiAgICAgICAgIGlmICggY3B1bWFza19lbXB0eShjcHVtYXNrX3NjcmF0
Y2hfY3B1KGNwdSkpICkKICAgICAgICAgewotICAgICAgICAgICAgaWYgKCB2LT5hZmZpbml0eV9i
cm9rZW4gKQorICAgICAgICAgICAgaWYgKCBzY2hlZF9jaGVja19hZmZpbml0eV9icm9rZW4odW5p
dCkgKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh1
bml0LCB1bml0LT5jcHVfaGFyZF9hZmZpbml0eV9zYXZlZCwgTlVMTCk7Ci0gICAgICAgICAgICAg
ICAgdi0+YWZmaW5pdHlfYnJva2VuID0gMDsKKyAgICAgICAgICAgICAgICBzY2hlZF9yZXNldF9h
ZmZpbml0eV9icm9rZW4odW5pdCk7CiAgICAgICAgICAgICAgICAgY3B1bWFza19hbmQoY3B1bWFz
a19zY3JhdGNoX2NwdShjcHUpLCB1bml0LT5jcHVfaGFyZF9hZmZpbml0eSwKICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBjcHVwb29sX2RvbWFpbl9jcHVtYXNrKGQpKTsKICAgICAgICAgICAg
IH0KIAogICAgICAgICAgICAgaWYgKCBjcHVtYXNrX2VtcHR5KGNwdW1hc2tfc2NyYXRjaF9jcHUo
Y3B1KSkgKQogICAgICAgICAgICAgewotICAgICAgICAgICAgICAgIHByaW50ayhYRU5MT0dfREVC
VUcgIkJyZWFraW5nIGFmZmluaXR5IGZvciAlcHZcbiIsIHYpOworICAgICAgICAgICAgICAgIC8q
IEFmZmluaXR5IHNldHRpbmdzIG9mIG9uZSB2Y3B1IGFyZSBmb3IgdGhlIGNvbXBsZXRlIHVuaXQu
ICovCisgICAgICAgICAgICAgICAgcHJpbnRrKFhFTkxPR19ERUJVRyAiQnJlYWtpbmcgYWZmaW5p
dHkgZm9yICVwdlxuIiwKKyAgICAgICAgICAgICAgICAgICAgICAgdW5pdC0+dmNwdV9saXN0KTsK
ICAgICAgICAgICAgICAgICBzY2hlZF9zZXRfYWZmaW5pdHkodW5pdCwgJmNwdW1hc2tfYWxsLCBO
VUxMKTsKICAgICAgICAgICAgICAgICBjcHVtYXNrX2FuZChjcHVtYXNrX3NjcmF0Y2hfY3B1KGNw
dSksIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAg
IGNwdXBvb2xfZG9tYWluX2NwdW1hc2soZCkpOwpAQCAtOTMxLDEyICs5NjYsMTIgQEAgdm9pZCBy
ZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKIAogICAgICAgICAvKiB2LT5w
cm9jZXNzb3IgbWlnaHQgaGF2ZSBjaGFuZ2VkLCBzbyByZWFjcXVpcmUgdGhlIGxvY2suICovCiAg
ICAgICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHVuaXQpOwotICAgICAgICByZXMg
PSBzY2hlZF9waWNrX3Jlc291cmNlKHZjcHVfc2NoZWR1bGVyKHYpLCB1bml0KTsKKyAgICAgICAg
cmVzID0gc2NoZWRfcGlja19yZXNvdXJjZSh1bml0X3NjaGVkdWxlcih1bml0KSwgdW5pdCk7CiAg
ICAgICAgIHNjaGVkX3NldF9yZXModW5pdCwgcmVzKTsKICAgICAgICAgc3Bpbl91bmxvY2tfaXJx
KGxvY2spOwogCi0gICAgICAgIGlmICggb2xkX2NwdSAhPSB2LT5wcm9jZXNzb3IgKQotICAgICAg
ICAgICAgc2NoZWRfbW92ZV9pcnFzKHYtPnNjaGVkX3VuaXQpOworICAgICAgICBpZiAoIG9sZF9j
cHUgIT0gc2NoZWRfdW5pdF9tYXN0ZXIodW5pdCkgKQorICAgICAgICAgICAgc2NoZWRfbW92ZV9p
cnFzKHVuaXQpOwogICAgIH0KIAogICAgIGRvbWFpbl91cGRhdGVfbm9kZV9hZmZpbml0eShkKTsK
QEAgLTk1MCw3ICs5ODUsNiBAQCB2b2lkIHJlc3RvcmVfdmNwdV9hZmZpbml0eShzdHJ1Y3QgZG9t
YWluICpkKQogaW50IGNwdV9kaXNhYmxlX3NjaGVkdWxlcih1bnNpZ25lZCBpbnQgY3B1KQogewog
ICAgIHN0cnVjdCBkb21haW4gKmQ7Ci0gICAgc3RydWN0IHZjcHUgKnY7CiAgICAgc3RydWN0IGNw
dXBvb2wgKmM7CiAgICAgY3B1bWFza190IG9ubGluZV9hZmZpbml0eTsKICAgICBpbnQgcmV0ID0g
MDsKQEAgLTk2MSwzMiArOTk1LDM0IEBAIGludCBjcHVfZGlzYWJsZV9zY2hlZHVsZXIodW5zaWdu
ZWQgaW50IGNwdSkKIAogICAgIGZvcl9lYWNoX2RvbWFpbl9pbl9jcHVwb29sICggZCwgYyApCiAg
ICAgewotICAgICAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgICAgIHN0cnVjdCBzY2hl
ZF91bml0ICp1bml0OworCisgICAgICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkK
ICAgICAgICAgewogICAgICAgICAgICAgdW5zaWduZWQgbG9uZyBmbGFnczsKLSAgICAgICAgICAg
IHN0cnVjdCBzY2hlZF91bml0ICp1bml0ID0gdi0+c2NoZWRfdW5pdDsKICAgICAgICAgICAgIHNw
aW5sb2NrX3QgKmxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxc2F2ZSh1bml0LCAmZmxhZ3Mp
OwogCiAgICAgICAgICAgICBjcHVtYXNrX2FuZCgmb25saW5lX2FmZmluaXR5LCB1bml0LT5jcHVf
aGFyZF9hZmZpbml0eSwgYy0+Y3B1X3ZhbGlkKTsKICAgICAgICAgICAgIGlmICggY3B1bWFza19l
bXB0eSgmb25saW5lX2FmZmluaXR5KSAmJgogICAgICAgICAgICAgICAgICBjcHVtYXNrX3Rlc3Rf
Y3B1KGNwdSwgdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHkpICkKICAgICAgICAgICAgIHsKLSAgICAg
ICAgICAgICAgICBpZiAoIHYtPmFmZmluaXR5X2Jyb2tlbiApCisgICAgICAgICAgICAgICAgaWYg
KCBzY2hlZF9jaGVja19hZmZpbml0eV9icm9rZW4odW5pdCkgKQogICAgICAgICAgICAgICAgIHsK
LSAgICAgICAgICAgICAgICAgICAgLyogVGhlIHZjcHUgaXMgdGVtcG9yYXJpbHkgcGlubmVkLCBj
YW4ndCBtb3ZlIGl0LiAqLworICAgICAgICAgICAgICAgICAgICAvKiBUaGUgdW5pdCBpcyB0ZW1w
b3JhcmlseSBwaW5uZWQsIGNhbid0IG1vdmUgaXQuICovCiAgICAgICAgICAgICAgICAgICAgIHVu
aXRfc2NoZWR1bGVfdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIHVuaXQpOwogICAgICAg
ICAgICAgICAgICAgICByZXQgPSAtRUFERFJJTlVTRTsKICAgICAgICAgICAgICAgICAgICAgYnJl
YWs7CiAgICAgICAgICAgICAgICAgfQogCi0gICAgICAgICAgICAgICAgcHJpbnRrKFhFTkxPR19E
RUJVRyAiQnJlYWtpbmcgYWZmaW5pdHkgZm9yICVwdlxuIiwgdik7CisgICAgICAgICAgICAgICAg
cHJpbnRrKFhFTkxPR19ERUJVRyAiQnJlYWtpbmcgYWZmaW5pdHkgZm9yICVwdlxuIiwKKyAgICAg
ICAgICAgICAgICAgICAgICAgdW5pdC0+dmNwdV9saXN0KTsKIAogICAgICAgICAgICAgICAgIHNj
aGVkX3NldF9hZmZpbml0eSh1bml0LCAmY3B1bWFza19hbGwsIE5VTEwpOwogICAgICAgICAgICAg
fQogCi0gICAgICAgICAgICBpZiAoIHYtPnByb2Nlc3NvciAhPSBjcHUgKQorICAgICAgICAgICAg
aWYgKCB1bml0LT5yZXMgIT0gZ2V0X3NjaGVkX3JlcyhjcHUpICkKICAgICAgICAgICAgIHsKLSAg
ICAgICAgICAgICAgICAvKiBUaGUgdmNwdSBpcyBub3Qgb24gdGhpcyBjcHUsIHNvIHdlIGNhbiBt
b3ZlIG9uLiAqLworICAgICAgICAgICAgICAgIC8qIFRoZSB1bml0IGlzIG5vdCBvbiB0aGlzIGNw
dSwgc28gd2UgY2FuIG1vdmUgb24uICovCiAgICAgICAgICAgICAgICAgdW5pdF9zY2hlZHVsZV91
bmxvY2tfaXJxcmVzdG9yZShsb2NrLCBmbGFncywgdW5pdCk7CiAgICAgICAgICAgICAgICAgY29u
dGludWU7CiAgICAgICAgICAgICB9CkBAIC05OTksMTcgKzEwMzUsMTggQEAgaW50IGNwdV9kaXNh
YmxlX3NjaGVkdWxlcih1bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICAgICAgICogICogdGhlIHNj
aGVkdWxlciB3aWxsIGFsd2F5cyBmaW5kIGEgc3VpdGFibGUgc29sdXRpb24sIG9yCiAgICAgICAg
ICAgICAgKiAgICB0aGluZ3Mgd291bGQgaGF2ZSBmYWlsZWQgYmVmb3JlIGdldHRpbmcgaW4gaGVy
ZS4KICAgICAgICAgICAgICAqLwotICAgICAgICAgICAgdmNwdV9taWdyYXRlX3N0YXJ0KHYpOwor
ICAgICAgICAgICAgLyogVE9ETzogbXVsdGlwbGUgdmNwdXMgcGVyIHVuaXQuICovCisgICAgICAg
ICAgICB2Y3B1X21pZ3JhdGVfc3RhcnQodW5pdC0+dmNwdV9saXN0KTsKICAgICAgICAgICAgIHVu
aXRfc2NoZWR1bGVfdW5sb2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIHVuaXQpOwogCi0gICAg
ICAgICAgICB2Y3B1X21pZ3JhdGVfZmluaXNoKHYpOworICAgICAgICAgICAgdmNwdV9taWdyYXRl
X2ZpbmlzaCh1bml0LT52Y3B1X2xpc3QpOwogCiAgICAgICAgICAgICAvKgogICAgICAgICAgICAg
ICogVGhlIG9ubHkgY2F2ZWF0LCBpbiB0aGlzIGNhc2UsIGlzIHRoYXQgaWYgYSB2Y3B1IGFjdGl2
ZSBpbgogICAgICAgICAgICAgICogdGhlIGh5cGVydmlzb3IgaXNuJ3QgbWlncmF0YWJsZS4gSW4g
dGhpcyBjYXNlLCB0aGUgY2FsbGVyCiAgICAgICAgICAgICAgKiBzaG91bGQgdHJ5IGFnYWluIGFm
dGVyIHJlbGVhc2luZyBhbmQgcmVhcXVpcmluZyBhbGwgbG9ja3MuCiAgICAgICAgICAgICAgKi8K
LSAgICAgICAgICAgIGlmICggdi0+cHJvY2Vzc29yID09IGNwdSApCisgICAgICAgICAgICBpZiAo
IHVuaXQtPnJlcyA9PSBnZXRfc2NoZWRfcmVzKGNwdSkgKQogICAgICAgICAgICAgICAgIHJldCA9
IC1FQUdBSU47CiAgICAgICAgIH0KICAgICB9CkBAIC0xMzI5LDE3ICsxMzY2LDE3IEBAIGludCB2
Y3B1X3RlbXBvcmFyeV9hZmZpbml0eShzdHJ1Y3QgdmNwdSAqdiwgdW5zaWduZWQgaW50IGNwdSwg
dWludDhfdCByZWFzb24pCiAgICAgICAgICAgICByZXQgPSAwOwogICAgICAgICAgICAgdi0+YWZm
aW5pdHlfYnJva2VuICY9IH5yZWFzb247CiAgICAgICAgIH0KLSAgICAgICAgaWYgKCAhcmV0ICYm
ICF2LT5hZmZpbml0eV9icm9rZW4gKQorICAgICAgICBpZiAoICFyZXQgJiYgIXNjaGVkX2NoZWNr
X2FmZmluaXR5X2Jyb2tlbih1bml0KSApCiAgICAgICAgICAgICBzY2hlZF9zZXRfYWZmaW5pdHko
dW5pdCwgdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHlfc2F2ZWQsIE5VTEwpOwogICAgIH0KICAgICBl
bHNlIGlmICggY3B1IDwgbnJfY3B1X2lkcyApCiAgICAgewogICAgICAgICBpZiAoICh2LT5hZmZp
bml0eV9icm9rZW4gJiByZWFzb24pIHx8Ci0gICAgICAgICAgICAgKHYtPmFmZmluaXR5X2Jyb2tl
biAmJiB2LT5wcm9jZXNzb3IgIT0gY3B1KSApCisgICAgICAgICAgICAgKHNjaGVkX2NoZWNrX2Fm
ZmluaXR5X2Jyb2tlbih1bml0KSAmJiB2LT5wcm9jZXNzb3IgIT0gY3B1KSApCiAgICAgICAgICAg
ICByZXQgPSAtRUJVU1k7CiAgICAgICAgIGVsc2UgaWYgKCBjcHVtYXNrX3Rlc3RfY3B1KGNwdSwg
VkNQVTJPTkxJTkUodikpICkKICAgICAgICAgewotICAgICAgICAgICAgaWYgKCAhdi0+YWZmaW5p
dHlfYnJva2VuICkKKyAgICAgICAgICAgIGlmICggIXNjaGVkX2NoZWNrX2FmZmluaXR5X2Jyb2tl
bih1bml0KSApCiAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgY3B1bWFza19jb3B5KHVu
aXQtPmNwdV9oYXJkX2FmZmluaXR5X3NhdmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICB1bml0LT5jcHVfaGFyZF9hZmZpbml0eSk7Ci0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhl
bi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3Jn
L21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id E1147BFFC0
	for <lists+xen-devel@lfdr.de>; Fri, 27 Sep 2019 09:06:13 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDkHO-0005yx-9g; Fri, 27 Sep 2019 07:03:02 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Rbpq=XW=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iDkHM-0005wV-70
 for xen-devel@lists.xenproject.org; Fri, 27 Sep 2019 07:03:00 +0000
X-Inumbo-ID: 94e035dc-e0f4-11e9-966c-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 94e035dc-e0f4-11e9-966c-12813bfff9fa;
 Fri, 27 Sep 2019 07:01:09 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 1D7D1B183;
 Fri, 27 Sep 2019 07:01:07 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 27 Sep 2019 09:00:45 +0200
Message-Id: <20190927070050.12405-42-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190927070050.12405-1-jgross@suse.com>
References: <20190927070050.12405-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v4 41/46] xen/sched: protect scheduling resource
 via rcu
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SW4gb3JkZXIgdG8gYmUgYWJsZSB0byBtb3ZlIGNwdXMgdG8gY3B1cG9vbHMgd2l0aCBjb3JlIHNj
aGVkdWxpbmcKYWN0aXZlIGl0IGlzIG1hbmRhdG9yeSB0byBtZXJnZSBtdWx0aXBsZSBjcHVzIGlu
dG8gb25lIHNjaGVkdWxpbmcKcmVzb3VyY2Ugb3IgdG8gc3BsaXQgYSBzY2hlZHVsaW5nIHJlc291
cmNlIHdpdGggbXVsdGlwbGUgY3B1cyBpbiBpdAppbnRvIG11bHRpcGxlIHNjaGVkdWxpbmcgcmVz
b3VyY2VzLiBUaGlzIGluIHR1cm4gcmVxdWlyZXMgdG8gbW9kaWZ5CnRoZSBjcHUgPC0+IHNjaGVk
dWxpbmcgcmVzb3VyY2UgcmVsYXRpb24uIEluIG9yZGVyIHRvIGJlIGFibGUgdG8gZnJlZQp1bnVz
ZWQgcmVzb3VyY2VzIHByb3RlY3Qgc3RydWN0IHNjaGVkX3Jlc291cmNlIHZpYSBSQ1UuIFRoaXMg
ZW5zdXJlcwp0aGVyZSBhcmUgbm8gdXNlcnMgbGVmdCB3aGVuIGZyZWVpbmcgc3VjaCBhIHJlc291
cmNlLgoKU2lnbmVkLW9mZi1ieTogSnVlcmdlbiBHcm9zcyA8amdyb3NzQHN1c2UuY29tPgotLS0K
VjE6IG5ldyBwYXRjaAotLS0KIHhlbi9jb21tb24vY3B1cG9vbC5jICAgICAgIHwgICA0ICsKIHhl
bi9jb21tb24vc2NoZWR1bGUuYyAgICAgIHwgMTg3ICsrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKystLS0tLQogeGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmggfCAgIDcgKy0K
IDMgZmlsZXMgY2hhbmdlZCwgMTc4IGluc2VydGlvbnMoKyksIDIwIGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL3hlbi9jb21tb24vY3B1cG9vbC5jIGIveGVuL2NvbW1vbi9jcHVwb29sLmMKaW5k
ZXggMDI4MjVlNzc5ZC4uNzIyOGNhODRiNCAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9jcHVwb29s
LmMKKysrIGIveGVuL2NvbW1vbi9jcHVwb29sLmMKQEAgLTUxMSw4ICs1MTEsMTAgQEAgc3RhdGlj
IGludCBjcHVwb29sX2NwdV9hZGQodW5zaWduZWQgaW50IGNwdSkKICAgICAgKiAob3IgdW5wbHVn
Z2luZyB3b3VsZCBoYXZlIGZhaWxlZCkgYW5kIHRoYXQgaXMgdGhlIGRlZmF1bHQgYmVoYXZpb3IK
ICAgICAgKiBhbnl3YXkuCiAgICAgICovCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOwogICAgIGdldF9zY2hlZF9yZXMoY3B1KS0+Y3B1cG9vbCA9IE5VTEw7CiAgICAgcmV0
ID0gY3B1cG9vbF9hc3NpZ25fY3B1X2xvY2tlZChjcHVwb29sMCwgY3B1KTsKKyAgICByY3VfcmVh
ZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIAogICAgIHNwaW5fdW5sb2NrKCZjcHVwb29s
X2xvY2spOwogCkBAIC01OTcsNyArNTk5LDkgQEAgc3RhdGljIHZvaWQgY3B1cG9vbF9jcHVfcmVt
b3ZlX2ZvcmNlZCh1bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICB9CiAgICAgfQogCisgICAgcmN1
X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAgIHNjaGVkX3JtX2NwdShjcHUpOwor
ICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogfQogCiAvKgpkaWZmIC0t
Z2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCmluZGV4
IGM3NWVjOTY5YzIuLmMxNGE2NmQ1ZjAgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWR1bGUu
YworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTc1LDYgKzc1LDcgQEAgc3RhdGljIHZv
aWQgcG9sbF90aW1lcl9mbih2b2lkICpkYXRhKTsKIC8qIFRoaXMgaXMgZ2xvYmFsIGZvciBub3cg
c28gdGhhdCBwcml2YXRlIGltcGxlbWVudGF0aW9ucyBjYW4gcmVhY2ggaXQgKi8KIERFRklORV9Q
RVJfQ1BVX1JFQURfTU9TVExZKHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqLCBzY2hlZF9yZXMpOwog
c3RhdGljIERFRklORV9QRVJfQ1BVX1JFQURfTU9TVExZKHVuc2lnbmVkIGludCwgc2NoZWRfcmVz
X2lkeCk7CitERUZJTkVfUkNVX1JFQURfTE9DSyhzY2hlZF9yZXNfcmN1bG9jayk7CiAKIC8qIFNj
cmF0Y2ggc3BhY2UgZm9yIGNwdW1hc2tzLiAqLwogREVGSU5FX1BFUl9DUFUoY3B1bWFza190LCBj
cHVtYXNrX3NjcmF0Y2gpOwpAQCAtMjkxLDEwICsyOTIsMTIgQEAgdm9pZCBzY2hlZF9ndWVzdF9p
ZGxlKHZvaWQgKCppZGxlKSAodm9pZCksIHVuc2lnbmVkIGludCBjcHUpCiAKIHZvaWQgdmNwdV9y
dW5zdGF0ZV9nZXQoc3RydWN0IHZjcHUgKnYsIHN0cnVjdCB2Y3B1X3J1bnN0YXRlX2luZm8gKnJ1
bnN0YXRlKQogewotICAgIHNwaW5sb2NrX3QgKmxvY2sgPSBsaWtlbHkodiA9PSBjdXJyZW50KQot
ICAgICAgICAgICAgICAgICAgICAgICA/IE5VTEwgOiB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHYt
PnNjaGVkX3VuaXQpOworICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAgICAgc190aW1lX3QgZGVsdGE7
CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKKyAgICBsb2NrID0g
bGlrZWx5KHYgPT0gY3VycmVudCkgPyBOVUxMIDogdW5pdF9zY2hlZHVsZV9sb2NrX2lycSh2LT5z
Y2hlZF91bml0KTsKICAgICBtZW1jcHkocnVuc3RhdGUsICZ2LT5ydW5zdGF0ZSwgc2l6ZW9mKCpy
dW5zdGF0ZSkpOwogICAgIGRlbHRhID0gTk9XKCkgLSBydW5zdGF0ZS0+c3RhdGVfZW50cnlfdGlt
ZTsKICAgICBpZiAoIGRlbHRhID4gMCApCkBAIC0zMDIsNiArMzA1LDggQEAgdm9pZCB2Y3B1X3J1
bnN0YXRlX2dldChzdHJ1Y3QgdmNwdSAqdiwgc3RydWN0IHZjcHVfcnVuc3RhdGVfaW5mbyAqcnVu
c3RhdGUpCiAKICAgICBpZiAoIHVubGlrZWx5KGxvY2sgIT0gTlVMTCkgKQogICAgICAgICB1bml0
X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgdi0+c2NoZWRfdW5pdCk7CisKKyAgICByY3VfcmVh
ZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogdWludDY0X3QgZ2V0X2NwdV9pZGxl
X3RpbWUodW5zaWduZWQgaW50IGNwdSkKQEAgLTUxMyw2ICs1MTgsOCBAQCBpbnQgc2NoZWRfaW5p
dF92Y3B1KHN0cnVjdCB2Y3B1ICp2KQogICAgICAgICByZXR1cm4gMDsKICAgICB9CiAKKyAgICBy
Y3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICAvKiBUaGUgZmlyc3QgdmNw
dSBvZiBhbiB1bml0IGNhbiBiZSBzZXQgdmlhIHNjaGVkX3NldF9yZXMoKS4gKi8KICAgICBzY2hl
ZF9zZXRfcmVzKHVuaXQsIGdldF9zY2hlZF9yZXMocHJvY2Vzc29yKSk7CiAKQEAgLTUyMCw2ICs1
MjcsNyBAQCBpbnQgc2NoZWRfaW5pdF92Y3B1KHN0cnVjdCB2Y3B1ICp2KQogICAgIGlmICggdW5p
dC0+cHJpdiA9PSBOVUxMICkKICAgICB7CiAgICAgICAgIHNjaGVkX2ZyZWVfdW5pdCh1bml0LCB2
KTsKKyAgICAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CiAgICAgICAg
IHJldHVybiAxOwogICAgIH0KIApAQCAtNTQ2LDYgKzU1NCw4IEBAIGludCBzY2hlZF9pbml0X3Zj
cHUoc3RydWN0IHZjcHUgKnYpCiAgICAgICAgIHNjaGVkX2luc2VydF91bml0KGRvbV9zY2hlZHVs
ZXIoZCksIHVuaXQpOwogICAgIH0KIAorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOworCiAgICAgcmV0dXJuIDA7CiB9CiAKQEAgLTU3NCw2ICs1ODQsNyBAQCBpbnQgc2No
ZWRfbW92ZV9kb21haW4oc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wgKmMpCiAgICAg
c3RydWN0IHNjaGVkdWxlciAqb2xkX29wczsKICAgICB2b2lkICpvbGRfZG9tZGF0YTsKICAgICB1
bnNpZ25lZCBpbnQgZ3JhbiA9IGNwdXBvb2xfZ2V0X2dyYW51bGFyaXR5KGMpOworICAgIGludCBy
ZXQgPSAwOwogCiAgICAgZm9yX2VhY2hfdmNwdSAoIGQsIHYgKQogICAgIHsKQEAgLTU4MSwxNSAr
NTkyLDIxIEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3Qg
Y3B1cG9vbCAqYykKICAgICAgICAgICAgIHJldHVybiAtRUJVU1k7CiAgICAgfQogCisgICAgcmN1
X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgZG9tZGF0YSA9IHNjaGVkX2Fs
bG9jX2RvbWRhdGEoYy0+c2NoZWQsIGQpOwogICAgIGlmICggSVNfRVJSKGRvbWRhdGEpICkKLSAg
ICAgICAgcmV0dXJuIFBUUl9FUlIoZG9tZGF0YSk7CisgICAgeworICAgICAgICByZXQgPSBQVFJf
RVJSKGRvbWRhdGEpOworICAgICAgICBnb3RvIG91dDsKKyAgICB9CiAKICAgICB1bml0X3ByaXYg
PSB4emFsbG9jX2FycmF5KHZvaWQgKiwgRElWX1JPVU5EX1VQKGQtPm1heF92Y3B1cywgZ3Jhbikp
OwogICAgIGlmICggdW5pdF9wcml2ID09IE5VTEwgKQogICAgIHsKICAgICAgICAgc2NoZWRfZnJl
ZV9kb21kYXRhKGMtPnNjaGVkLCBkb21kYXRhKTsKLSAgICAgICAgcmV0dXJuIC1FTk9NRU07Cisg
ICAgICAgIHJldCA9IC1FTk9NRU07CisgICAgICAgIGdvdG8gb3V0OwogICAgIH0KIAogICAgIHVu
aXRfaWR4ID0gMDsKQEAgLTYwMiw3ICs2MTksOCBAQCBpbnQgc2NoZWRfbW92ZV9kb21haW4oc3Ry
dWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wgKmMpCiAgICAgICAgICAgICAgICAgc2NoZWRf
ZnJlZV91ZGF0YShjLT5zY2hlZCwgdW5pdF9wcml2W3VuaXRfaWR4XSk7CiAgICAgICAgICAgICB4
ZnJlZSh1bml0X3ByaXYpOwogICAgICAgICAgICAgc2NoZWRfZnJlZV9kb21kYXRhKGMtPnNjaGVk
LCBkb21kYXRhKTsKLSAgICAgICAgICAgIHJldHVybiAtRU5PTUVNOworICAgICAgICAgICAgcmV0
ID0gLUVOT01FTTsKKyAgICAgICAgICAgIGdvdG8gb3V0OwogICAgICAgICB9CiAgICAgICAgIHVu
aXRfaWR4Kys7CiAgICAgfQpAQCAtNjY4LDcgKzY4NiwxMCBAQCBpbnQgc2NoZWRfbW92ZV9kb21h
aW4oc3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IGNwdXBvb2wgKmMpCiAKICAgICB4ZnJlZSh1bml0
X3ByaXYpOwogCi0gICAgcmV0dXJuIDA7CitvdXQ6CisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hl
ZF9yZXNfcmN1bG9jayk7CisKKyAgICByZXR1cm4gcmV0OwogfQogCiB2b2lkIHNjaGVkX2Rlc3Ry
b3lfdmNwdShzdHJ1Y3QgdmNwdSAqdikKQEAgLTY4Niw5ICs3MDcsMTMgQEAgdm9pZCBzY2hlZF9k
ZXN0cm95X3ZjcHUoc3RydWN0IHZjcHUgKnYpCiAgICAgICovCiAgICAgaWYgKCB1bml0LT52Y3B1
X2xpc3QgPT0gdiApCiAgICAgeworICAgICAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1
bG9jayk7CisKICAgICAgICAgc2NoZWRfcmVtb3ZlX3VuaXQodmNwdV9zY2hlZHVsZXIodiksIHVu
aXQpOwogICAgICAgICBzY2hlZF9mcmVlX3VkYXRhKHZjcHVfc2NoZWR1bGVyKHYpLCB1bml0LT5w
cml2KTsKICAgICAgICAgc2NoZWRfZnJlZV91bml0KHVuaXQsIHYpOworCisgICAgICAgIHJjdV9y
ZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAgIH0KIH0KIApAQCAtNzA2LDcgKzcz
MSwxMiBAQCBpbnQgc2NoZWRfaW5pdF9kb21haW4oc3RydWN0IGRvbWFpbiAqZCwgaW50IHBvb2xp
ZCkKICAgICBTQ0hFRF9TVEFUX0NSQU5LKGRvbV9pbml0KTsKICAgICBUUkFDRV8xRChUUkNfU0NI
RURfRE9NX0FERCwgZC0+ZG9tYWluX2lkKTsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jl
c19yY3Vsb2NrKTsKKwogICAgIHNkb20gPSBzY2hlZF9hbGxvY19kb21kYXRhKGRvbV9zY2hlZHVs
ZXIoZCksIGQpOworCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisK
ICAgICBpZiAoIElTX0VSUihzZG9tKSApCiAgICAgICAgIHJldHVybiBQVFJfRVJSKHNkb20pOwog
CkBAIC03MjQsOSArNzU0LDEzIEBAIHZvaWQgc2NoZWRfZGVzdHJveV9kb21haW4oc3RydWN0IGRv
bWFpbiAqZCkKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyhkb21fZGVzdHJveSk7CiAgICAgICAg
IFRSQUNFXzFEKFRSQ19TQ0hFRF9ET01fUkVNLCBkLT5kb21haW5faWQpOwogCisgICAgICAgIHJj
dV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgICAgICBzY2hlZF9mcmVlX2Rv
bWRhdGEoZG9tX3NjaGVkdWxlcihkKSwgZC0+c2NoZWRfcHJpdik7CiAgICAgICAgIGQtPnNjaGVk
X3ByaXYgPSBOVUxMOwogCisgICAgICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxv
Y2spOworCiAgICAgICAgIGNwdXBvb2xfcm1fZG9tYWluKGQpOwogICAgIH0KIH0KQEAgLTc2MCwx
MSArNzk0LDE1IEBAIHZvaWQgdmNwdV9zbGVlcF9ub3N5bmMoc3RydWN0IHZjcHUgKnYpCiAKICAg
ICBUUkFDRV8yRChUUkNfU0NIRURfU0xFRVAsIHYtPmRvbWFpbi0+ZG9tYWluX2lkLCB2LT52Y3B1
X2lkKTsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGxv
Y2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxc2F2ZSh2LT5zY2hlZF91bml0LCAmZmxhZ3MpOwog
CiAgICAgdmNwdV9zbGVlcF9ub3N5bmNfbG9ja2VkKHYpOwogCiAgICAgdW5pdF9zY2hlZHVsZV91
bmxvY2tfaXJxcmVzdG9yZShsb2NrLCBmbGFncywgdi0+c2NoZWRfdW5pdCk7CisKKyAgICByY3Vf
cmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogdm9pZCB2Y3B1X3NsZWVwX3N5
bmMoc3RydWN0IHZjcHUgKnYpCkBAIC03ODUsNiArODIzLDggQEAgdm9pZCB2Y3B1X3dha2Uoc3Ry
dWN0IHZjcHUgKnYpCiAKICAgICBUUkFDRV8yRChUUkNfU0NIRURfV0FLRSwgdi0+ZG9tYWluLT5k
b21haW5faWQsIHYtPnZjcHVfaWQpOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOworCiAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnFzYXZlKHVuaXQsICZm
bGFncyk7CiAKICAgICBpZiAoIGxpa2VseSh2Y3B1X3J1bm5hYmxlKHYpKSApCkBAIC04MDUsNiAr
ODQ1LDggQEAgdm9pZCB2Y3B1X3dha2Uoc3RydWN0IHZjcHUgKnYpCiAgICAgfQogCiAgICAgdW5p
dF9zY2hlZHVsZV91bmxvY2tfaXJxcmVzdG9yZShsb2NrLCBmbGFncywgdW5pdCk7CisKKyAgICBy
Y3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogdm9pZCB2Y3B1X3VuYmxv
Y2soc3RydWN0IHZjcHUgKnYpCkBAIC04MzgsNiArODgwLDggQEAgc3RhdGljIHZvaWQgc2NoZWRf
dW5pdF9tb3ZlX2xvY2tlZChzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKICAgICB1bnNpZ25lZCBp
bnQgb2xkX2NwdSA9IHVuaXQtPnJlcy0+bWFzdGVyX2NwdTsKICAgICBzdHJ1Y3QgdmNwdSAqdjsK
IAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIC8qCiAgICAg
ICogVHJhbnNmZXIgdXJnZW5jeSBzdGF0dXMgdG8gbmV3IENQVSBiZWZvcmUgc3dpdGNoaW5nIENQ
VXMsIGFzCiAgICAgICogb25jZSB0aGUgc3dpdGNoIG9jY3Vycywgdi0+aXNfdXJnZW50IGlzIG5v
IGxvbmdlciBwcm90ZWN0ZWQgYnkKQEAgLTg1Nyw2ICs5MDEsOCBAQCBzdGF0aWMgdm9pZCBzY2hl
ZF91bml0X21vdmVfbG9ja2VkKHN0cnVjdCBzY2hlZF91bml0ICp1bml0LAogICAgICAqIHBvaW50
ZXIgY2FuJ3QgY2hhbmdlIHdoaWxlIHRoZSBjdXJyZW50IGxvY2sgaXMgaGVsZC4KICAgICAgKi8K
ICAgICBzY2hlZF9taWdyYXRlKHVuaXRfc2NoZWR1bGVyKHVuaXQpLCB1bml0LCBuZXdfY3B1KTsK
KworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogfQogCiAvKgpAQCAt
MTAyNCw2ICsxMDcwLDggQEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFp
biAqZCkKIAogICAgIEFTU0VSVChzeXN0ZW1fc3RhdGUgPT0gU1lTX1NUQVRFX3Jlc3VtZSk7CiAK
KyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBmb3JfZWFjaF9z
Y2hlZF91bml0ICggZCwgdW5pdCApCiAgICAgewogICAgICAgICBzcGlubG9ja190ICpsb2NrOwpA
QCAtMTA4MCw2ICsxMTI4LDggQEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRv
bWFpbiAqZCkKICAgICAgICAgICAgIHNjaGVkX21vdmVfaXJxcyh1bml0KTsKICAgICB9CiAKKyAg
ICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGRvbWFpbl91cGRh
dGVfbm9kZV9hZmZpbml0eShkKTsKIH0KIApAQCAtMTA5NSw5ICsxMTQ1LDExIEBAIGludCBjcHVf
ZGlzYWJsZV9zY2hlZHVsZXIodW5zaWduZWQgaW50IGNwdSkKICAgICBjcHVtYXNrX3Qgb25saW5l
X2FmZmluaXR5OwogICAgIGludCByZXQgPSAwOwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRf
cmVzX3JjdWxvY2spOworCiAgICAgYyA9IGdldF9zY2hlZF9yZXMoY3B1KS0+Y3B1cG9vbDsKICAg
ICBpZiAoIGMgPT0gTlVMTCApCi0gICAgICAgIHJldHVybiByZXQ7CisgICAgICAgIGdvdG8gb3V0
OwogCiAgICAgZm9yX2VhY2hfZG9tYWluX2luX2NwdXBvb2wgKCBkLCBjICkKICAgICB7CkBAIC0x
MTU1LDYgKzEyMDcsOSBAQCBpbnQgY3B1X2Rpc2FibGVfc2NoZWR1bGVyKHVuc2lnbmVkIGludCBj
cHUpCiAgICAgICAgIH0KICAgICB9CiAKK291dDoKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVk
X3Jlc19yY3Vsb2NrKTsKKwogICAgIHJldHVybiByZXQ7CiB9CiAKQEAgLTExODYsNyArMTI0MSw5
IEBAIHN0YXRpYyBpbnQgY3B1X2Rpc2FibGVfc2NoZWR1bGVyX2NoZWNrKHVuc2lnbmVkIGludCBj
cHUpCiBzdGF0aWMgdm9pZCBzY2hlZF9zZXRfYWZmaW5pdHkoCiAgICAgc3RydWN0IHNjaGVkX3Vu
aXQgKnVuaXQsIGNvbnN0IGNwdW1hc2tfdCAqaGFyZCwgY29uc3QgY3B1bWFza190ICpzb2Z0KQog
eworICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKICAgICBzY2hlZF9hZGp1
c3RfYWZmaW5pdHkoZG9tX3NjaGVkdWxlcih1bml0LT5kb21haW4pLCB1bml0LCBoYXJkLCBzb2Z0
KTsKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIAogICAgIGlmICgg
aGFyZCApCiAgICAgICAgIGNwdW1hc2tfY29weSh1bml0LT5jcHVfaGFyZF9hZmZpbml0eSwgaGFy
ZCk7CkBAIC0xMjA2LDYgKzEyNjMsOCBAQCBzdGF0aWMgaW50IHZjcHVfc2V0X2FmZmluaXR5KAog
ICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAgICAgaW50IHJldCA9IDA7CiAKKyAgICByY3VfcmVhZF9s
b2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2Nr
X2lycSh1bml0KTsKIAogICAgIGlmICggdi0+YWZmaW5pdHlfYnJva2VuICkKQEAgLTEyMzQsNiAr
MTI5Myw4IEBAIHN0YXRpYyBpbnQgdmNwdV9zZXRfYWZmaW5pdHkoCiAKICAgICBzY2hlZF91bml0
X21pZ3JhdGVfZmluaXNoKHVuaXQpOwogCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNf
cmN1bG9jayk7CisKICAgICByZXR1cm4gcmV0OwogfQogCkBAIC0xMzYwLDExICsxNDIxLDE2IEBA
IHN0YXRpYyBsb25nIGRvX3BvbGwoc3RydWN0IHNjaGVkX3BvbGwgKnNjaGVkX3BvbGwpCiBsb25n
IHZjcHVfeWllbGQodm9pZCkKIHsKICAgICBzdHJ1Y3QgdmNwdSAqIHY9Y3VycmVudDsKLSAgICBz
cGlubG9ja190ICpsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2NrX2lycSh2LT5zY2hlZF91bml0KTsK
KyAgICBzcGlubG9ja190ICpsb2NrOworCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOwogCisgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodi0+c2NoZWRfdW5p
dCk7CiAgICAgc2NoZWRfeWllbGQodmNwdV9zY2hlZHVsZXIodiksIHYtPnNjaGVkX3VuaXQpOwog
ICAgIHVuaXRfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCB2LT5zY2hlZF91bml0KTsKIAorICAg
IHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgU0NIRURfU1RBVF9D
UkFOSyh2Y3B1X3lpZWxkKTsKIAogICAgIFRSQUNFXzJEKFRSQ19TQ0hFRF9ZSUVMRCwgY3VycmVu
dC0+ZG9tYWluLT5kb21haW5faWQsIGN1cnJlbnQtPnZjcHVfaWQpOwpAQCAtMTQ2MSw2ICsxNTI3
LDggQEAgaW50IHZjcHVfdGVtcG9yYXJ5X2FmZmluaXR5KHN0cnVjdCB2Y3B1ICp2LCB1bnNpZ25l
ZCBpbnQgY3B1LCB1aW50OF90IHJlYXNvbikKICAgICBpbnQgcmV0ID0gLUVJTlZBTDsKICAgICBi
b29sIG1pZ3JhdGU7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisK
ICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2NrX2lycSh1bml0KTsKIAogICAgIGlmICggY3B1
ID09IE5SX0NQVVMgKQpAQCAtMTUwMCw2ICsxNTY4LDggQEAgaW50IHZjcHVfdGVtcG9yYXJ5X2Fm
ZmluaXR5KHN0cnVjdCB2Y3B1ICp2LCB1bnNpZ25lZCBpbnQgY3B1LCB1aW50OF90IHJlYXNvbikK
ICAgICBpZiAoIG1pZ3JhdGUgKQogICAgICAgICBzY2hlZF91bml0X21pZ3JhdGVfZmluaXNoKHVu
aXQpOwogCisgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBy
ZXR1cm4gcmV0OwogfQogCkBAIC0xNzExLDkgKzE3ODEsMTMgQEAgbG9uZyBzY2hlZF9hZGp1c3Qo
c3RydWN0IGRvbWFpbiAqZCwgc3RydWN0IHhlbl9kb21jdGxfc2NoZWR1bGVyX29wICpvcCkKIAog
ICAgIC8qIE5COiB0aGUgcGx1Z2dhYmxlIHNjaGVkdWxlciBjb2RlIG5lZWRzIHRvIHRha2UgY2Fy
ZQogICAgICAqIG9mIGxvY2tpbmcgYnkgaXRzZWxmLiAqLworICAgIHJjdV9yZWFkX2xvY2soJnNj
aGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGlmICggKHJldCA9IHNjaGVkX2FkanVzdF9kb20oZG9t
X3NjaGVkdWxlcihkKSwgZCwgb3ApKSA9PSAwICkKICAgICAgICAgVFJBQ0VfMUQoVFJDX1NDSEVE
X0FESkRPTSwgZC0+ZG9tYWluX2lkKTsKIAorICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVz
X3JjdWxvY2spOworCiAgICAgcmV0dXJuIHJldDsKIH0KIApAQCAtMTczNCw5ICsxODA4LDEzIEBA
IGxvbmcgc2NoZWRfYWRqdXN0X2dsb2JhbChzdHJ1Y3QgeGVuX3N5c2N0bF9zY2hlZHVsZXJfb3Ag
Km9wKQogICAgIGlmICggcG9vbCA9PSBOVUxMICkKICAgICAgICAgcmV0dXJuIC1FU1JDSDsKIAor
ICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIHJjID0gKChvcC0+
c2NoZWRfaWQgPT0gcG9vbC0+c2NoZWQtPnNjaGVkX2lkKQogICAgICAgICAgID8gc2NoZWRfYWRq
dXN0X2NwdXBvb2wocG9vbC0+c2NoZWQsIG9wKSA6IC1FSU5WQUwpOwogCisgICAgcmN1X3JlYWRf
dW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICBjcHVwb29sX3B1dChwb29sKTsKIAog
ICAgIHJldHVybiByYzsKQEAgLTE5NTYsNyArMjAzNCwxMSBAQCBzdGF0aWMgdm9pZCB1bml0X2Nv
bnRleHRfc2F2ZWQoc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcikKIHZvaWQgc2NoZWRfY29udGV4
dF9zd2l0Y2hlZChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCkKIHsKICAg
ICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqbmV4dCA9IHZuZXh0LT5zY2hlZF91bml0OwotICAgIHN0cnVj
dCBzY2hlZF9yZXNvdXJjZSAqc3IgPSBnZXRfc2NoZWRfcmVzKHNtcF9wcm9jZXNzb3JfaWQoKSk7
CisgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcjsKKworICAgIHJjdV9yZWFkX2xvY2soJnNj
aGVkX3Jlc19yY3Vsb2NrKTsKKworICAgIHNyID0gZ2V0X3NjaGVkX3JlcyhzbXBfcHJvY2Vzc29y
X2lkKCkpOwogCiAgICAgaWYgKCBhdG9taWNfcmVhZCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250
KSApCiAgICAgewpAQCAtMTk4Myw2ICsyMDY1LDggQEAgdm9pZCBzY2hlZF9jb250ZXh0X3N3aXRj
aGVkKHN0cnVjdCB2Y3B1ICp2cHJldiwgc3RydWN0IHZjcHUgKnZuZXh0KQogCiAgICAgaWYgKCBp
c19pZGxlX3ZjcHUodnByZXYpICYmIHZwcmV2ICE9IHZuZXh0ICkKICAgICAgICAgdnByZXYtPnNj
aGVkX3VuaXQgPSBzci0+c2NoZWRfdW5pdF9pZGxlOworCisgICAgcmN1X3JlYWRfdW5sb2NrKCZz
Y2hlZF9yZXNfcmN1bG9jayk7CiB9CiAKIHN0YXRpYyB2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNo
KHN0cnVjdCB2Y3B1ICp2cHJldiwgc3RydWN0IHZjcHUgKnZuZXh0LApAQCAtMjAwNiw2ICsyMDkw
LDggQEAgc3RhdGljIHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnZwcmV2
LCBzdHJ1Y3QgdmNwdSAqdm5leHQsCiAgICAgICAgICAgICB2bmV4dC0+c2NoZWRfdW5pdCA9CiAg
ICAgICAgICAgICAgICAgZ2V0X3NjaGVkX3JlcyhzbXBfcHJvY2Vzc29yX2lkKCkpLT5zY2hlZF91
bml0X2lkbGU7CiAKKyAgICAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7
CisKICAgICAgICAgdHJhY2VfY29udGludWVfcnVubmluZyh2bmV4dCk7CiAgICAgICAgIHJldHVy
biBjb250aW51ZV9ydW5uaW5nKHZwcmV2KTsKICAgICB9CkBAIC0yMDE5LDYgKzIxMDUsOCBAQCBz
dGF0aWMgdm9pZCBzY2hlZF9jb250ZXh0X3N3aXRjaChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVj
dCB2Y3B1ICp2bmV4dCwKIAogICAgIHZjcHVfcGVyaW9kaWNfdGltZXJfd29yayh2bmV4dCk7CiAK
KyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIGNvbnRleHRf
c3dpdGNoKHZwcmV2LCB2bmV4dCk7CiB9CiAKQEAgLTIxNzEsNiArMjI1OSw4IEBAIHN0YXRpYyB2
b2lkIHNjaGVkX3NsYXZlKHZvaWQpCiAKICAgICBBU1NFUlRfTk9UX0lOX0FUT01JQygpOwogCisg
ICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgbG9jayA9IHBjcHVf
c2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKIAogICAgIG5vdyA9IE5PVygpOwpAQCAtMjE5NCw2ICsy
Mjg0LDggQEAgc3RhdGljIHZvaWQgc2NoZWRfc2xhdmUodm9pZCkKICAgICB7CiAgICAgICAgIHBj
cHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOwogCisgICAgICAgIHJjdV9yZWFkX3Vu
bG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCiAgICAgICAgIC8qIENoZWNrIGZvciBmYWlsZWQg
Zm9yY2VkIGNvbnRleHQgc3dpdGNoLiAqLwogICAgICAgICBpZiAoIGRvX3NvZnRpcnEgKQogICAg
ICAgICAgICAgcmFpc2Vfc29mdGlycShTQ0hFRFVMRV9TT0ZUSVJRKTsKQEAgLTIyMjYsMTMgKzIz
MTgsMTYgQEAgc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKICAgICBzdHJ1Y3Qgc2NoZWRfcmVz
b3VyY2UgKnNyOwogICAgIHNwaW5sb2NrX3QgICAgICAgICAgICpsb2NrOwogICAgIGludCBjcHUg
PSBzbXBfcHJvY2Vzc29yX2lkKCk7Ci0gICAgdW5zaWduZWQgaW50ICAgICAgICAgIGdyYW4gPSBn
ZXRfc2NoZWRfcmVzKGNwdSktPmdyYW51bGFyaXR5OworICAgIHVuc2lnbmVkIGludCAgICAgICAg
ICBncmFuOwogCiAgICAgQVNTRVJUX05PVF9JTl9BVE9NSUMoKTsKIAogICAgIFNDSEVEX1NUQVRf
Q1JBTksoc2NoZWRfcnVuKTsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2Nr
KTsKKwogICAgIHNyID0gZ2V0X3NjaGVkX3JlcyhjcHUpOworICAgIGdyYW4gPSBzci0+Z3JhbnVs
YXJpdHk7CiAKICAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycShjcHUpOwogCkBAIC0y
MjQ0LDYgKzIzMzksOCBAQCBzdGF0aWMgdm9pZCBzY2hlZHVsZSh2b2lkKQogICAgICAgICAgKi8K
ICAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CiAKKyAgICAgICAg
cmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICAgICAgcmFpc2Vfc29m
dGlycShTQ0hFRFVMRV9TT0ZUSVJRKTsKICAgICAgICAgcmV0dXJuIHNjaGVkX3NsYXZlKCk7CiAg
ICAgfQpAQCAtMjM1NSwxNCArMjQ1MiwyNyBAQCBzdGF0aWMgaW50IGNwdV9zY2hlZHVsZV91cCh1
bnNpZ25lZCBpbnQgY3B1KQogICAgIHJldHVybiAwOwogfQogCitzdGF0aWMgdm9pZCBzY2hlZF9y
ZXNfZnJlZShzdHJ1Y3QgcmN1X2hlYWQgKmhlYWQpCit7CisgICAgc3RydWN0IHNjaGVkX3Jlc291
cmNlICpzciA9IGNvbnRhaW5lcl9vZihoZWFkLCBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UsIHJjdSk7
CisKKyAgICB4ZnJlZShzcik7Cit9CisKIHN0YXRpYyB2b2lkIGNwdV9zY2hlZHVsZV9kb3duKHVu
c2lnbmVkIGludCBjcHUpCiB7Ci0gICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzciA9IGdldF9z
Y2hlZF9yZXMoY3B1KTsKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyOworCisgICAgcmN1
X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOworCisgICAgc3IgPSBnZXRfc2NoZWRfcmVz
KGNwdSk7CiAKICAgICBraWxsX3RpbWVyKCZzci0+c190aW1lcik7CiAKICAgICBzZXRfc2NoZWRf
cmVzKGNwdSwgTlVMTCk7Ci0gICAgeGZyZWUoc3IpOworICAgIGNhbGxfcmN1KCZzci0+cmN1LCBz
Y2hlZF9yZXNfZnJlZSk7CisKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2Nr
KTsKIH0KIAogdm9pZCBzY2hlZF9ybV9jcHUodW5zaWduZWQgaW50IGNwdSkKQEAgLTIzODIsNiAr
MjQ5Miw4IEBAIHN0YXRpYyBpbnQgY3B1X3NjaGVkdWxlX2NhbGxiYWNrKAogICAgIHVuc2lnbmVk
IGludCBjcHUgPSAodW5zaWduZWQgbG9uZyloY3B1OwogICAgIGludCByYyA9IDA7CiAKKyAgICBy
Y3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICAvKgogICAgICAqIEZyb20g
dGhlIHNjaGVkdWxlciBwZXJzcGVjdGl2ZSwgYnJpbmdpbmcgdXAgYSBwQ1BVIHJlcXVpcmVzCiAg
ICAgICogYWxsb2NhdGluZyBhbmQgaW5pdGlhbGl6aW5nIHRoZSBwZXItcENQVSBzY2hlZHVsZXIg
c3BlY2lmaWMgZGF0YSwKQEAgLTI0MjgsNiArMjU0MCw4IEBAIHN0YXRpYyBpbnQgY3B1X3NjaGVk
dWxlX2NhbGxiYWNrKAogICAgICAgICBicmVhazsKICAgICB9CiAKKyAgICByY3VfcmVhZF91bmxv
Y2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwogICAgIHJldHVybiAhcmMgPyBOT1RJRllfRE9ORSA6
IG5vdGlmaWVyX2Zyb21fZXJybm8ocmMpOwogfQogCkBAIC0yNTE3LDggKzI2MzEsMTMgQEAgdm9p
ZCBfX2luaXQgc2NoZWR1bGVyX2luaXQodm9pZCkKICAgICBpZGxlX2RvbWFpbi0+bWF4X3ZjcHVz
ID0gbnJfY3B1X2lkczsKICAgICBpZiAoIHZjcHVfY3JlYXRlKGlkbGVfZG9tYWluLCAwKSA9PSBO
VUxMICkKICAgICAgICAgQlVHKCk7CisKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1
bG9jayk7CisKICAgICBnZXRfc2NoZWRfcmVzKDApLT5jdXJyID0gaWRsZV92Y3B1WzBdLT5zY2hl
ZF91bml0OwogICAgIGdldF9zY2hlZF9yZXMoMCktPnNjaGVkX3VuaXRfaWRsZSA9IGlkbGVfdmNw
dVswXS0+c2NoZWRfdW5pdDsKKworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxv
Y2spOwogfQogCiAvKgpAQCAtMjUzMSw5ICsyNjUwLDE0IEBAIGludCBzY2hlZHVsZV9jcHVfYWRk
KHVuc2lnbmVkIGludCBjcHUsIHN0cnVjdCBjcHVwb29sICpjKQogICAgIHN0cnVjdCB2Y3B1ICpp
ZGxlOwogICAgIHZvaWQgKnBwcml2LCAqdnByaXY7CiAgICAgc3RydWN0IHNjaGVkdWxlciAqbmV3
X29wcyA9IGMtPnNjaGVkOwotICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc3IgPSBnZXRfc2No
ZWRfcmVzKGNwdSk7CisgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcjsKICAgICBzcGlubG9j
a190ICpvbGRfbG9jaywgKm5ld19sb2NrOwogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7CisgICAg
aW50IHJldCA9IDA7CisKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisK
KyAgICBzciA9IGdldF9zY2hlZF9yZXMoY3B1KTsKIAogICAgIEFTU0VSVChjcHVtYXNrX3Rlc3Rf
Y3B1KGNwdSwgJmNwdXBvb2xfZnJlZV9jcHVzKSk7CiAgICAgQVNTRVJUKCFjcHVtYXNrX3Rlc3Rf
Y3B1KGNwdSwgYy0+Y3B1X3ZhbGlkKSk7CkBAIC0yNTUzLDEzICsyNjc3LDE4IEBAIGludCBzY2hl
ZHVsZV9jcHVfYWRkKHVuc2lnbmVkIGludCBjcHUsIHN0cnVjdCBjcHVwb29sICpjKQogICAgIGlk
bGUgPSBpZGxlX3ZjcHVbY3B1XTsKICAgICBwcHJpdiA9IHNjaGVkX2FsbG9jX3BkYXRhKG5ld19v
cHMsIGNwdSk7CiAgICAgaWYgKCBJU19FUlIocHByaXYpICkKLSAgICAgICAgcmV0dXJuIFBUUl9F
UlIocHByaXYpOworICAgIHsKKyAgICAgICAgcmV0ID0gUFRSX0VSUihwcHJpdik7CisgICAgICAg
IGdvdG8gb3V0OworICAgIH0KKwogICAgIHZwcml2ID0gc2NoZWRfYWxsb2NfdWRhdGEobmV3X29w
cywgaWRsZS0+c2NoZWRfdW5pdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkbGUt
PmRvbWFpbi0+c2NoZWRfcHJpdik7CiAgICAgaWYgKCB2cHJpdiA9PSBOVUxMICkKICAgICB7CiAg
ICAgICAgIHNjaGVkX2ZyZWVfcGRhdGEobmV3X29wcywgcHByaXYsIGNwdSk7Ci0gICAgICAgIHJl
dHVybiAtRU5PTUVNOworICAgICAgICByZXQgPSAtRU5PTUVNOworICAgICAgICBnb3RvIG91dDsK
ICAgICB9CiAKICAgICAvKgpAQCAtMjU5OCw3ICsyNzI3LDEwIEBAIGludCBzY2hlZHVsZV9jcHVf
YWRkKHVuc2lnbmVkIGludCBjcHUsIHN0cnVjdCBjcHVwb29sICpjKQogICAgIC8qIFRoZSAgY3B1
IGlzIGFkZGVkIHRvIGEgcG9vbCwgdHJpZ2dlciBpdCB0byBnbyBwaWNrIHVwIHNvbWUgd29yayAq
LwogICAgIGNwdV9yYWlzZV9zb2Z0aXJxKGNwdSwgU0NIRURVTEVfU09GVElSUSk7CiAKLSAgICBy
ZXR1cm4gMDsKK291dDoKKyAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsK
KworICAgIHJldHVybiByZXQ7CiB9CiAKIC8qCkBAIC0yNjExLDExICsyNzQzLDE2IEBAIGludCBz
Y2hlZHVsZV9jcHVfcm0odW5zaWduZWQgaW50IGNwdSkKIHsKICAgICBzdHJ1Y3QgdmNwdSAqaWRs
ZTsKICAgICB2b2lkICpwcHJpdl9vbGQsICp2cHJpdl9vbGQ7Ci0gICAgc3RydWN0IHNjaGVkX3Jl
c291cmNlICpzciA9IGdldF9zY2hlZF9yZXMoY3B1KTsKLSAgICBzdHJ1Y3Qgc2NoZWR1bGVyICpv
bGRfb3BzID0gc3ItPnNjaGVkdWxlcjsKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyOwor
ICAgIHN0cnVjdCBzY2hlZHVsZXIgKm9sZF9vcHM7CiAgICAgc3BpbmxvY2tfdCAqb2xkX2xvY2s7
CiAgICAgdW5zaWduZWQgbG9uZyBmbGFnczsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jl
c19yY3Vsb2NrKTsKKworICAgIHNyID0gZ2V0X3NjaGVkX3JlcyhjcHUpOworICAgIG9sZF9vcHMg
PSBzci0+c2NoZWR1bGVyOworCiAgICAgQVNTRVJUKHNyLT5jcHVwb29sICE9IE5VTEwpOwogICAg
IEFTU0VSVChjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgJmNwdXBvb2xfZnJlZV9jcHVzKSk7CiAgICAg
QVNTRVJUKCFjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgc3ItPmNwdXBvb2wtPmNwdV92YWxpZCkpOwpA
QCAtMjY0OCw2ICsyNzg1LDggQEAgaW50IHNjaGVkdWxlX2NwdV9ybSh1bnNpZ25lZCBpbnQgY3B1
KQogICAgIHNyLT5ncmFudWxhcml0eSA9IDE7CiAgICAgc3ItPmNwdXBvb2wgPSBOVUxMOwogCisg
ICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7CisKICAgICByZXR1cm4gMDsK
IH0KIApAQCAtMjY5Niw2ICsyODM1LDggQEAgdm9pZCBzY2hlZHVsZV9kdW1wKHN0cnVjdCBjcHVw
b29sICpjKQogCiAgICAgLyogTG9ja2luZywgaWYgbmVjZXNzYXJ5LCBtdXN0IGJlIGhhbmRsZWQg
d2l0aGluZyBlYWNoIHNjaGVkdWxlciAqLwogCisgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVz
X3JjdWxvY2spOworCiAgICAgaWYgKCBjICE9IE5VTEwgKQogICAgIHsKICAgICAgICAgc2NoZWQg
PSBjLT5zY2hlZDsKQEAgLTI3MTUsNiArMjg1Niw4IEBAIHZvaWQgc2NoZWR1bGVfZHVtcChzdHJ1
Y3QgY3B1cG9vbCAqYykKICAgICAgICAgZm9yX2VhY2hfY3B1IChpLCBjcHVzKQogICAgICAgICAg
ICAgc2NoZWRfZHVtcF9jcHVfc3RhdGUoc2NoZWQsIGkpOwogICAgIH0KKworICAgIHJjdV9yZWFk
X3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogfQogCiB2b2lkIHNjaGVkX3RpY2tfc3VzcGVu
ZCh2b2lkKQpAQCAtMjcyMiwxMCArMjg2NSwxNCBAQCB2b2lkIHNjaGVkX3RpY2tfc3VzcGVuZCh2
b2lkKQogICAgIHN0cnVjdCBzY2hlZHVsZXIgKnNjaGVkOwogICAgIHVuc2lnbmVkIGludCBjcHUg
PSBzbXBfcHJvY2Vzc29yX2lkKCk7CiAKKyAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1
bG9jayk7CisKICAgICBzY2hlZCA9IGdldF9zY2hlZF9yZXMoY3B1KS0+c2NoZWR1bGVyOwogICAg
IHNjaGVkX2RvX3RpY2tfc3VzcGVuZChzY2hlZCwgY3B1KTsKICAgICByY3VfaWRsZV9lbnRlcihj
cHUpOwogICAgIHJjdV9pZGxlX3RpbWVyX3N0YXJ0KCk7CisKKyAgICByY3VfcmVhZF91bmxvY2so
JnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAogdm9pZCBzY2hlZF90aWNrX3Jlc3VtZSh2b2lkKQpA
QCAtMjczMywxMCArMjg4MCwxNCBAQCB2b2lkIHNjaGVkX3RpY2tfcmVzdW1lKHZvaWQpCiAgICAg
c3RydWN0IHNjaGVkdWxlciAqc2NoZWQ7CiAgICAgdW5zaWduZWQgaW50IGNwdSA9IHNtcF9wcm9j
ZXNzb3JfaWQoKTsKIAorICAgIHJjdV9yZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKKwog
ICAgIHJjdV9pZGxlX3RpbWVyX3N0b3AoKTsKICAgICByY3VfaWRsZV9leGl0KGNwdSk7CiAgICAg
c2NoZWQgPSBnZXRfc2NoZWRfcmVzKGNwdSktPnNjaGVkdWxlcjsKICAgICBzY2hlZF9kb190aWNr
X3Jlc3VtZShzY2hlZCwgY3B1KTsKKworICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3Jj
dWxvY2spOwogfQogCiB2b2lkIHdhaXQodm9pZCkKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hl
bi9zY2hlZC1pZi5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKaW5kZXggZjhmMGY0ODRj
Yi4uMzk4ODk4NWVlNiAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKKysr
IGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKQEAgLTEwLDYgKzEwLDcgQEAKIAogI2luY2x1
ZGUgPHhlbi9wZXJjcHUuaD4KICNpbmNsdWRlIDx4ZW4vZXJyLmg+CisjaW5jbHVkZSA8eGVuL3Jj
dXBkYXRlLmg+CiAKIC8qIEEgZ2xvYmFsIHBvaW50ZXIgdG8gdGhlIGluaXRpYWwgY3B1cG9vbCAo
UE9PTDApLiAqLwogZXh0ZXJuIHN0cnVjdCBjcHVwb29sICpjcHVwb29sMDsKQEAgLTU3LDE4ICs1
OCwyMCBAQCBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgewogICAgIHVuc2lnbmVkIGludCAgICAgICAg
bWFzdGVyX2NwdTsKICAgICB1bnNpZ25lZCBpbnQgICAgICAgIGdyYW51bGFyaXR5OwogICAgIGNv
bnN0IGNwdW1hc2tfdCAgICAqY3B1czsgICAgICAgICAgIC8qIGNwdXMgY292ZXJlZCBieSB0aGlz
IHN0cnVjdCAgICAgKi8KKyAgICBzdHJ1Y3QgcmN1X2hlYWQgICAgIHJjdTsKIH07CiAKIERFQ0xB
UkVfUEVSX0NQVShzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKiwgc2NoZWRfcmVzKTsKK2V4dGVybiBy
Y3VfcmVhZF9sb2NrX3Qgc2NoZWRfcmVzX3JjdWxvY2s7CiAKIHN0YXRpYyBpbmxpbmUgc3RydWN0
IHNjaGVkX3Jlc291cmNlICpnZXRfc2NoZWRfcmVzKHVuc2lnbmVkIGludCBjcHUpCiB7Ci0gICAg
cmV0dXJuIHBlcl9jcHUoc2NoZWRfcmVzLCBjcHUpOworICAgIHJldHVybiByY3VfZGVyZWZlcmVu
Y2UocGVyX2NwdShzY2hlZF9yZXMsIGNwdSkpOwogfQogCiBzdGF0aWMgaW5saW5lIHZvaWQgc2V0
X3NjaGVkX3Jlcyh1bnNpZ25lZCBpbnQgY3B1LCBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnJlcykK
IHsKLSAgICBwZXJfY3B1KHNjaGVkX3JlcywgY3B1KSA9IHJlczsKKyAgICByY3VfYXNzaWduX3Bv
aW50ZXIocGVyX2NwdShzY2hlZF9yZXMsIGNwdSksIHJlcyk7CiB9CiAKIHN0YXRpYyBpbmxpbmUg
c3RydWN0IHNjaGVkX3VuaXQgKmN1cnJfb25fY3B1KHVuc2lnbmVkIGludCBjcHUpCi0tIAoyLjE2
LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4t
ZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczov
L2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

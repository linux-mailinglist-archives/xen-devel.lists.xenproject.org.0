Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 7EB86B7825
	for <lists+xen-devel@lfdr.de>; Thu, 19 Sep 2019 13:07:25 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iAuF8-0003B1-Rx; Thu, 19 Sep 2019 11:04:58 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=vwgP=XO=citrix.com=anthony.perard@srs-us1.protection.inumbo.net>)
 id 1iAuF7-0003AJ-Mx
 for xen-devel@lists.xenproject.org; Thu, 19 Sep 2019 11:04:57 +0000
X-Inumbo-ID: 4a8b99ea-dacd-11e9-9656-12813bfff9fa
Received: from esa2.hc3370-68.iphmx.com (unknown [216.71.145.153])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 4a8b99ea-dacd-11e9-9656-12813bfff9fa;
 Thu, 19 Sep 2019 11:04:47 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1568891088;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=c/X1kAtunOTd0Rp883uPK6Xt10M+dQzHralPJlY9zws=;
 b=LDqYBLmMqWOdwy5s5wXXHnm7wIYDFzXUMf9APUYJc5DVE87f514/TVmY
 PWKY3jITL61IST00UyDRklENRRtvZhBxwPQZPL38bB3b/Y8R2wLjxjGJr
 TZPV+NSGMsvMoJeZDeruPK57On9ygc1gBJNetef9CT0v1ueZV9CUJISvG g=;
Authentication-Results: esa2.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=anthony.perard@citrix.com;
 spf=Pass smtp.mailfrom=anthony.perard@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa2.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 anthony.perard@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa2.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa2.hc3370-68.iphmx.com: domain of
 anthony.perard@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa2.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83 ~all"
Received-SPF: None (esa2.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa2.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: ysXiLdwkv5v76d55sl3LorW8/e3qU83mlkaLYiOkyK/eKnXbtUDlOefHsNWDCdp597II/b94Z2
 KBwu0riujcTWXZw6w7Y1c5BEircF6JaZwFznry6ZYCzxp9zMxUZS5Q6xUBYQye+wtKmtWyPRmK
 5SINhAIIll6aegyFBu23p26YuEophLuDpsp0fkvG6qV1GGyQhwNYvh9ENIKhKzPPyt4aP37a0/
 4zYBM6bU7Oc8Cz7Vt3NysGlnWfTUM+NZrgPf2mXoWOsas4bCcOrO8rt6V+7i0s8cs7cnCxDb0G
 UWM=
X-SBRS: 2.7
X-MesageID: 5777958
X-Ironport-Server: esa2.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.64,523,1559534400"; 
   d="scan'208";a="5777958"
From: Anthony PERARD <anthony.perard@citrix.com>
To: <xen-devel@lists.xenproject.org>
Date: Thu, 19 Sep 2019 12:04:40 +0100
Message-ID: <20190919110443.817594-7-anthony.perard@citrix.com>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190919110443.817594-1-anthony.perard@citrix.com>
References: <20190919110443.817594-1-anthony.perard@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v3 6/9] libxl_disk: Cut libxl_cdrom_insert into
 steps ..
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Wei Liu <wl@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Li4gYW5kIHVzZSBhIG5ldyAic2xvdyIgbG9jayB0byBhdm9pZCBob2xkaW5nIHRoZSB1c2VyZGF0
YSBsb2NrIGFjcm9zcwpzZXZlcmFsIGZ1bmN0aW9ucy4KClRoaXMgcGF0Y2ggY3V0cyBsaWJ4bF9j
ZHJvbV9pbnNlcnQgaW50byBkaWZmZXJlbnQgc3RlcC9mdW5jdGlvbiBidXQKdGhlcmUgYXJlIHN0
aWxsIGNhbGxlZCBzeW5jaHJvbm91c2x5LiAoVGFraW5nIHRoZSBldl9sb2NrIGlzIHRoZSBvbmx5
CnN0ZXAgdGhhdCBtaWdodCBiZSBhc3luY2hyb25vdXMuKSBBIGxhdGVyIHBhdGNoIHdpbGwgY2Fs
bCB0aGVtCmFzeW5jaHJvbm91c2x5IHdoZW4gUU1QIGlzIGludm9sdmVkLgoKVGhlZSB1c2VyZGF0
YSBsb2NrIChqc29uX2xvY2spIHVzZSB0byBwcm90ZWN0IGFnYWluc3QgY29uY3VycmVudCBjaGFu
Z2UKb2YgY2Ryb20gaXMgcmVwbGFjZWQgYnkgYW4gZXZfbG9jayB3aGljaCBjYW4gYmUgaGVsZCBh
Y3Jvc3MgZGlmZmVyZW50CkNUWF9MT0NLIHNlY3Rpb25zLiBUaGUganNvbl9sb2NrIGlzIHN0aWxs
IHVzZWQgd2hlbiByZWFkaW5nL21vZGlmeWluZwp0aGUgZG9tYWluIHVzZXJkYXRhIChtYW5kYXRv
cnkpIGFuZCB1cGRhdGUgeGVuc3RvcmUgKG1vc3RseSBiZWNhdXNlCml0J3MgdXBkYXRlZCBhcyB0
aGUgc2FtZSB0aW1lIGFzIHRoZSB1c2VyZGF0YSkuCgpTaWduZWQtb2ZmLWJ5OiBBbnRob255IFBF
UkFSRCA8YW50aG9ueS5wZXJhcmRAY2l0cml4LmNvbT4KQWNrZWQtYnk6IElhbiBKYWNrc29uIDxp
YW4uamFja3NvbkBldS5jaXRyaXguY29tPgotLS0KCk5vdGVzOgogICAgdjI6CiAgICAtIHJld3Jp
dGUgcGF0Y2ggZGVzY3JpcHRpb24KICAgIC0gcmV3b3JrIHVzZSBvZiB0aGUgbmV3IGxvY2sKCiB0
b29scy9saWJ4bC9saWJ4bF9kaXNrLmMgfCAxOTYgKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKy0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTU1IGluc2VydGlvbnMoKyksIDQxIGRlbGV0
aW9ucygtKQoKZGlmZiAtLWdpdCBhL3Rvb2xzL2xpYnhsL2xpYnhsX2Rpc2suYyBiL3Rvb2xzL2xp
YnhsL2xpYnhsX2Rpc2suYwppbmRleCA0NWJmNTU1MDYxZGYuLjk4MDIzZjE2OWNlNiAxMDA2NDQK
LS0tIGEvdG9vbHMvbGlieGwvbGlieGxfZGlzay5jCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2Rp
c2suYwpAQCAtNjQyLDI0ICs2NDIsNDMgQEAgaW50IGxpYnhsX2RldmljZV9kaXNrX2dldGluZm8o
bGlieGxfY3R4ICpjdHgsIHVpbnQzMl90IGRvbWlkLAogICAgIHJldHVybiByYzsKIH0KIAordHlw
ZWRlZiBzdHJ1Y3QgeworICAgIGxpYnhsX19hbyAqYW87CisgICAgbGlieGxfZG9taWQgZG9taWQ7
CisgICAgbGlieGxfZGV2aWNlX2Rpc2sgKmRpc2s7CisgICAgbGlieGxfZGV2aWNlX2Rpc2sgZGlz
a19zYXZlZDsKKyAgICBsaWJ4bF9fZXZfZGV2bG9jayBxbXBfbG9jazsKKyAgICBpbnQgZG1fdmVy
OworfSBsaWJ4bF9fY2Ryb21faW5zZXJ0X3N0YXRlOworCitzdGF0aWMgdm9pZCBjZHJvbV9pbnNl
cnRfbG9ja19hY3F1aXJlZChsaWJ4bF9fZWdjICosIGxpYnhsX19ldl9kZXZsb2NrICosCisgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgcmMpOworc3RhdGljIHZvaWQg
Y2Ryb21faW5zZXJ0X2VqZWN0ZWQobGlieGxfX2VnYyAqZWdjLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgbGlieGxfX2Nkcm9tX2luc2VydF9zdGF0ZSAqY2lzKTsKK3N0YXRpYyB2
b2lkIGNkcm9tX2luc2VydF9pbnNlcnRlZChsaWJ4bF9fZWdjICplZ2MsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgbGlieGxfX2Nkcm9tX2luc2VydF9zdGF0ZSAqY2lzKTsKK3N0
YXRpYyB2b2lkIGNkcm9tX2luc2VydF9kb25lKGxpYnhsX19lZ2MgKmVnYywKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIGxpYnhsX19jZHJvbV9pbnNlcnRfc3RhdGUgKmNpcywKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIGludCByYyk7CisKIGludCBsaWJ4bF9jZHJvbV9pbnNl
cnQobGlieGxfY3R4ICpjdHgsIHVpbnQzMl90IGRvbWlkLCBsaWJ4bF9kZXZpY2VfZGlzayAqZGlz
aywKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlieGxfYXN5bmNvcF9ob3cgKmFvX2hv
dykKIHsKICAgICBBT19DUkVBVEUoY3R4LCBkb21pZCwgYW9faG93KTsKICAgICBpbnQgbnVtID0g
MCwgaTsKLSAgICBsaWJ4bF9kZXZpY2VfZGlzayAqZGlza3MgPSBOVUxMLCBkaXNrX3NhdmVkOwot
ICAgIGxpYnhsX2RvbWFpbl9jb25maWcgZF9jb25maWc7Ci0gICAgaW50IHJjLCBkbV92ZXI7Ci0g
ICAgbGlieGxfX2RldmljZSBkZXZpY2U7Ci0gICAgY29uc3QgY2hhciAqYmVfcGF0aCwgKmxpYnhs
X3BhdGg7Ci0gICAgY2hhciAqIHRtcDsKLSAgICBsaWJ4bF9fZG9tYWluX3VzZXJkYXRhX2xvY2sg
KmxvY2sgPSBOVUxMOwotICAgIHhzX3RyYW5zYWN0aW9uX3QgdCA9IFhCVF9OVUxMOwotICAgIGZs
ZXhhcnJheV90ICppbnNlcnQgPSBOVUxMLCAqZW1wdHkgPSBOVUxMOwotCi0gICAgbGlieGxfZG9t
YWluX2NvbmZpZ19pbml0KCZkX2NvbmZpZyk7Ci0gICAgbGlieGxfZGV2aWNlX2Rpc2tfaW5pdCgm
ZGlza19zYXZlZCk7Ci0gICAgbGlieGxfZGV2aWNlX2Rpc2tfY29weShjdHgsICZkaXNrX3NhdmVk
LCBkaXNrKTsKKyAgICBsaWJ4bF9kZXZpY2VfZGlzayAqZGlza3MgPSBOVUxMOworICAgIGludCBy
YzsKKyAgICBsaWJ4bF9fY2Ryb21faW5zZXJ0X3N0YXRlICpjaXM7CisKKyAgICBHQ05FVyhjaXMp
OworICAgIGNpcy0+YW8gPSBhbzsKKyAgICBjaXMtPmRvbWlkID0gZG9taWQ7CisgICAgY2lzLT5k
aXNrID0gZGlzazsKKyAgICBsaWJ4bF9kZXZpY2VfZGlza19pbml0KCZjaXMtPmRpc2tfc2F2ZWQp
OworICAgIGxpYnhsX2RldmljZV9kaXNrX2NvcHkoY3R4LCAmY2lzLT5kaXNrX3NhdmVkLCBkaXNr
KTsKKyAgICBsaWJ4bF9fZXZfZGV2bG9ja19pbml0KCZjaXMtPnFtcF9sb2NrKTsKKyAgICBjaXMt
PnFtcF9sb2NrLmFvID0gYW87CisgICAgY2lzLT5xbXBfbG9jay5kb21pZCA9IGRvbWlkOwogCiAg
ICAgbGlieGxfZG9tYWluX3R5cGUgdHlwZSA9IGxpYnhsX19kb21haW5fdHlwZShnYywgZG9taWQp
OwogICAgIGlmICh0eXBlID09IExJQlhMX0RPTUFJTl9UWVBFX0lOVkFMSUQpIHsKQEAgLTY3OCw4
ICs2OTcsOCBAQCBpbnQgbGlieGxfY2Ryb21faW5zZXJ0KGxpYnhsX2N0eCAqY3R4LCB1aW50MzJf
dCBkb21pZCwgbGlieGxfZGV2aWNlX2Rpc2sgKmRpc2ssCiAgICAgICAgIGdvdG8gb3V0OwogICAg
IH0KIAotICAgIGRtX3ZlciA9IGxpYnhsX19kZXZpY2VfbW9kZWxfdmVyc2lvbl9ydW5uaW5nKGdj
LCBkb21pZCk7Ci0gICAgaWYgKGRtX3ZlciA9PSAtMSkgeworICAgIGNpcy0+ZG1fdmVyID0gbGli
eGxfX2RldmljZV9tb2RlbF92ZXJzaW9uX3J1bm5pbmcoZ2MsIGRvbWlkKTsKKyAgICBpZiAoY2lz
LT5kbV92ZXIgPT0gLTEpIHsKICAgICAgICAgTE9HRChFUlJPUiwgZG9taWQsICJDYW5ub3QgZGV0
ZXJtaW5lIGRldmljZSBtb2RlbCB2ZXJzaW9uIik7CiAgICAgICAgIHJjID0gRVJST1JfRkFJTDsK
ICAgICAgICAgZ290byBvdXQ7CkBAIC03MDgsNDAgKzcyNyw4MiBAQCBpbnQgbGlieGxfY2Ryb21f
aW5zZXJ0KGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBkb21pZCwgbGlieGxfZGV2aWNlX2Rpc2sg
KmRpc2ssCiAgICAgICAgIGRpc2stPmZvcm1hdCA9IExJQlhMX0RJU0tfRk9STUFUX0VNUFRZOwog
ICAgIH0KIAotICAgIHJjID0gbGlieGxfX2RldmljZV9mcm9tX2Rpc2soZ2MsIGRvbWlkLCBkaXNr
LCAmZGV2aWNlKTsKLSAgICBpZiAocmMpIGdvdG8gb3V0Oworb3V0OgorICAgIGxpYnhsX19kZXZp
Y2VfbGlzdF9mcmVlKCZsaWJ4bF9fZGlza19kZXZ0eXBlLCBkaXNrcywgbnVtKTsKKyAgICBpZiAo
cmMpIHsKKyAgICAgICAgY2Ryb21faW5zZXJ0X2RvbmUoZWdjLCBjaXMsIHJjKTsgLyogbXVzdCBi
ZSBsYXN0ICovCisgICAgfSBlbHNlIHsKKyAgICAgICAgY2lzLT5xbXBfbG9jay5jYWxsYmFjayA9
IGNkcm9tX2luc2VydF9sb2NrX2FjcXVpcmVkOworICAgICAgICBsaWJ4bF9fZXZfZGV2bG9ja19s
b2NrKGVnYywgJmNpcy0+cW1wX2xvY2spOyAvKiBtdXN0IGJlIGxhc3QgKi8KKyAgICB9CisgICAg
cmV0dXJuIEFPX0lOUFJPR1JFU1M7Cit9CiAKLSAgICBiZV9wYXRoID0gbGlieGxfX2RldmljZV9i
YWNrZW5kX3BhdGgoZ2MsICZkZXZpY2UpOwotICAgIGxpYnhsX3BhdGggPSBsaWJ4bF9fZGV2aWNl
X2xpYnhsX3BhdGgoZ2MsICZkZXZpY2UpOworc3RhdGljIHZvaWQgY2Ryb21faW5zZXJ0X2xvY2tf
YWNxdWlyZWQobGlieGxfX2VnYyAqZWdjLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgbGlieGxfX2V2X2RldmxvY2sgKmxvY2ssCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBpbnQgcmMpCit7CisgICAgbGlieGxfX2Nkcm9tX2luc2VydF9zdGF0
ZSAqY2lzID0gQ09OVEFJTkVSX09GKGxvY2ssICpjaXMsIHFtcF9sb2NrKTsKKyAgICBTVEFURV9B
T19HQyhjaXMtPmFvKTsKIAotICAgIC8qIE5vdGU6IENUWCBsb2NrIGlzIGFscmVhZHkgaGVsZCBh
dCB0aGlzIHBvaW50IHNvIGxvY2sgaGllcmFyY2h5Ci0gICAgICogaXMgbWFpbnRhaW5lZC4KLSAg
ICAgKi8KLSAgICBsb2NrID0gbGlieGxfX2xvY2tfZG9tYWluX3VzZXJkYXRhKGdjLCBkb21pZCk7
Ci0gICAgaWYgKCFsb2NrKSB7Ci0gICAgICAgIHJjID0gRVJST1JfTE9DS19GQUlMOwotICAgICAg
ICBnb3RvIG91dDsKLSAgICB9CisgICAgaWYgKHJjKSBnb3RvIG91dDsKIAogICAgIC8qIFdlIG5l
ZWQgdG8gZWplY3QgdGhlIG9yaWdpbmFsIGltYWdlIGZpcnN0LiBUaGlzIGlzIGltcGxlbWVudGVk
CiAgICAgICogYnkgaW5zZXJ0aW5nIGVtcHR5IG1lZGlhLiBKU09OIGlzIG5vdCB1cGRhdGVkLgog
ICAgICAqLwogCi0gICAgaWYgKGRtX3ZlciA9PSBMSUJYTF9ERVZJQ0VfTU9ERUxfVkVSU0lPTl9R
RU1VX1hFTikgeworICAgIGlmIChjaXMtPmRtX3ZlciA9PSBMSUJYTF9ERVZJQ0VfTU9ERUxfVkVS
U0lPTl9RRU1VX1hFTikgewogICAgICAgICBsaWJ4bF9kZXZpY2VfZGlzayBkaXNrX2VtcHR5Owog
CiAgICAgICAgIGxpYnhsX2RldmljZV9kaXNrX2luaXQoJmRpc2tfZW1wdHkpOwogICAgICAgICBk
aXNrX2VtcHR5LmZvcm1hdCA9IExJQlhMX0RJU0tfRk9STUFUX0VNUFRZOwotICAgICAgICBkaXNr
X2VtcHR5LnZkZXYgPSBsaWJ4bF9fc3RyZHVwKE5PR0MsIGRpc2stPnZkZXYpOworICAgICAgICBk
aXNrX2VtcHR5LnZkZXYgPSBsaWJ4bF9fc3RyZHVwKE5PR0MsIGNpcy0+ZGlzay0+dmRldik7CiAg
ICAgICAgIGRpc2tfZW1wdHkucGRldl9wYXRoID0gbGlieGxfX3N0cmR1cChOT0dDLCAiIik7CiAg
ICAgICAgIGRpc2tfZW1wdHkuaXNfY2Ryb20gPSAxOwotICAgICAgICBsaWJ4bF9fZGV2aWNlX2Rp
c2tfc2V0ZGVmYXVsdChnYywgZG9taWQsICZkaXNrX2VtcHR5LCBmYWxzZSk7CisgICAgICAgIGxp
YnhsX19kZXZpY2VfZGlza19zZXRkZWZhdWx0KGdjLCBjaXMtPmRvbWlkLCAmZGlza19lbXB0eSwg
ZmFsc2UpOwogCi0gICAgICAgIHJjID0gbGlieGxfX3FtcF9pbnNlcnRfY2Ryb20oZ2MsIGRvbWlk
LCAmZGlza19lbXB0eSk7CisgICAgICAgIHJjID0gbGlieGxfX3FtcF9pbnNlcnRfY2Ryb20oZ2Ms
IGNpcy0+ZG9taWQsICZkaXNrX2VtcHR5KTsKICAgICAgICAgbGlieGxfZGV2aWNlX2Rpc2tfZGlz
cG9zZSgmZGlza19lbXB0eSk7CiAgICAgICAgIGlmIChyYykgZ290byBvdXQ7CiAgICAgfQogCisg
ICAgY2Ryb21faW5zZXJ0X2VqZWN0ZWQoZWdjLCBjaXMpOyAvKiBtdXN0IGJlIGxhc3QgKi8KKyAg
ICByZXR1cm47CisKK291dDoKKyAgICBjZHJvbV9pbnNlcnRfZG9uZShlZ2MsIGNpcywgcmMpOyAv
KiBtdXN0IGJlIGxhc3QgKi8KK30KKworc3RhdGljIHZvaWQgY2Ryb21faW5zZXJ0X2VqZWN0ZWQo
bGlieGxfX2VnYyAqZWdjLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxf
X2Nkcm9tX2luc2VydF9zdGF0ZSAqY2lzKQoreworICAgIEVHQ19HQzsKKyAgICBpbnQgcmM7Cisg
ICAgbGlieGxfX2RvbWFpbl91c2VyZGF0YV9sb2NrICpkYXRhX2xvY2sgPSBOVUxMOworICAgIGxp
YnhsX19kZXZpY2UgZGV2aWNlOworICAgIGNvbnN0IGNoYXIgKmJlX3BhdGgsICpsaWJ4bF9wYXRo
OworICAgIGZsZXhhcnJheV90ICplbXB0eSA9IE5VTEw7CisgICAgeHNfdHJhbnNhY3Rpb25fdCB0
ID0gWEJUX05VTEw7CisgICAgY2hhciAqdG1wOworICAgIGxpYnhsX2RvbWFpbl9jb25maWcgZF9j
b25maWc7CisKKyAgICAvKiBjb252ZW5pZW5jZSBhbGlhc2VzICovCisgICAgbGlieGxfZG9taWQg
ZG9taWQgPSBjaXMtPmRvbWlkOworICAgIGxpYnhsX2RldmljZV9kaXNrICpkaXNrID0gY2lzLT5k
aXNrOworCisgICAgbGlieGxfZG9tYWluX2NvbmZpZ19pbml0KCZkX2NvbmZpZyk7CisKKyAgICBy
YyA9IGxpYnhsX19kZXZpY2VfZnJvbV9kaXNrKGdjLCBkb21pZCwgZGlzaywgJmRldmljZSk7Cisg
ICAgaWYgKHJjKSBnb3RvIG91dDsKKyAgICBiZV9wYXRoID0gbGlieGxfX2RldmljZV9iYWNrZW5k
X3BhdGgoZ2MsICZkZXZpY2UpOworICAgIGxpYnhsX3BhdGggPSBsaWJ4bF9fZGV2aWNlX2xpYnhs
X3BhdGgoZ2MsICZkZXZpY2UpOworCisgICAgZGF0YV9sb2NrID0gbGlieGxfX2xvY2tfZG9tYWlu
X3VzZXJkYXRhKGdjLCBkb21pZCk7CisgICAgaWYgKCFkYXRhX2xvY2spIHsKKyAgICAgICAgcmMg
PSBFUlJPUl9MT0NLX0ZBSUw7CisgICAgICAgIGdvdG8gb3V0OworICAgIH0KKwogICAgIGVtcHR5
ID0gZmxleGFycmF5X21ha2UoZ2MsIDQsIDEpOwogICAgIGZsZXhhcnJheV9hcHBlbmRfcGFpcihl
bXB0eSwgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICBsaWJ4bF9fZGV2aWNlX2Rp
c2tfc3RyaW5nX29mX2JhY2tlbmQoZGlzay0+YmFja2VuZCkpOwpAQCAtNzgwLDE2ICs4NDEsNjYg
QEAgaW50IGxpYnhsX2Nkcm9tX2luc2VydChsaWJ4bF9jdHggKmN0eCwgdWludDMyX3QgZG9taWQs
IGxpYnhsX2RldmljZV9kaXNrICpkaXNrLAogICAgIHJjID0gbGlieGxfX2dldF9kb21haW5fY29u
ZmlndXJhdGlvbihnYywgZG9taWQsICZkX2NvbmZpZyk7CiAgICAgaWYgKHJjKSBnb3RvIG91dDsK
IAotICAgIGRldmljZV9hZGRfZG9tYWluX2NvbmZpZyhnYywgJmRfY29uZmlnLCAmbGlieGxfX2Rp
c2tfZGV2dHlwZSwgJmRpc2tfc2F2ZWQpOworICAgIGRldmljZV9hZGRfZG9tYWluX2NvbmZpZyhn
YywgJmRfY29uZmlnLCAmbGlieGxfX2Rpc2tfZGV2dHlwZSwKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgJmNpcy0+ZGlza19zYXZlZCk7CiAKICAgICByYyA9IGxpYnhsX19kbV9jaGVja19z
dGFydChnYywgJmRfY29uZmlnLCBkb21pZCk7CiAgICAgaWYgKHJjKSBnb3RvIG91dDsKIAotICAg
IGlmIChkbV92ZXIgPT0gTElCWExfREVWSUNFX01PREVMX1ZFUlNJT05fUUVNVV9YRU4pIHsKKyAg
ICBpZiAoY2lzLT5kbV92ZXIgPT0gTElCWExfREVWSUNFX01PREVMX1ZFUlNJT05fUUVNVV9YRU4p
IHsKICAgICAgICAgcmMgPSBsaWJ4bF9fcW1wX2luc2VydF9jZHJvbShnYywgZG9taWQsIGRpc2sp
OwogICAgICAgICBpZiAocmMpIGdvdG8gb3V0OwogICAgIH0KIAorICAgIHJjID0gMDsKKworb3V0
OgorICAgIGxpYnhsX194c190cmFuc2FjdGlvbl9hYm9ydChnYywgJnQpOworICAgIGxpYnhsX2Rv
bWFpbl9jb25maWdfZGlzcG9zZSgmZF9jb25maWcpOworICAgIGlmIChkYXRhX2xvY2spIGxpYnhs
X191bmxvY2tfZG9tYWluX3VzZXJkYXRhKGRhdGFfbG9jayk7CisgICAgaWYgKHJjKSB7CisgICAg
ICAgIGNkcm9tX2luc2VydF9kb25lKGVnYywgY2lzLCByYyk7IC8qIG11c3QgYmUgbGFzdCAqLwor
ICAgIH0gZWxzZSB7CisgICAgICAgIGNkcm9tX2luc2VydF9pbnNlcnRlZChlZ2MsIGNpcyk7IC8q
IG11c3QgYmUgbGFzdCAqLworICAgIH0KK30KKworc3RhdGljIHZvaWQgY2Ryb21faW5zZXJ0X2lu
c2VydGVkKGxpYnhsX19lZ2MgKmVnYywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBsaWJ4bF9fY2Ryb21faW5zZXJ0X3N0YXRlICpjaXMpCit7CisgICAgRUdDX0dDOworICAgIGlu
dCByYzsKKyAgICBsaWJ4bF9fZG9tYWluX3VzZXJkYXRhX2xvY2sgKmRhdGFfbG9jayA9IE5VTEw7
CisgICAgbGlieGxfZG9tYWluX2NvbmZpZyBkX2NvbmZpZzsKKyAgICBmbGV4YXJyYXlfdCAqaW5z
ZXJ0ID0gTlVMTDsKKyAgICB4c190cmFuc2FjdGlvbl90IHQgPSBYQlRfTlVMTDsKKyAgICBsaWJ4
bF9fZGV2aWNlIGRldmljZTsKKyAgICBjb25zdCBjaGFyICpiZV9wYXRoLCAqbGlieGxfcGF0aDsK
KyAgICBjaGFyICp0bXA7CisKKyAgICAvKiBjb252ZW5pZW5jZSBhbGlhc2VzICovCisgICAgbGli
eGxfZG9taWQgZG9taWQgPSBjaXMtPmRvbWlkOworICAgIGxpYnhsX2RldmljZV9kaXNrICpkaXNr
ID0gY2lzLT5kaXNrOworCisgICAgbGlieGxfZG9tYWluX2NvbmZpZ19pbml0KCZkX2NvbmZpZyk7
CisKKyAgICByYyA9IGxpYnhsX19kZXZpY2VfZnJvbV9kaXNrKGdjLCBkb21pZCwgZGlzaywgJmRl
dmljZSk7CisgICAgaWYgKHJjKSBnb3RvIG91dDsKKyAgICBiZV9wYXRoID0gbGlieGxfX2Rldmlj
ZV9iYWNrZW5kX3BhdGgoZ2MsICZkZXZpY2UpOworICAgIGxpYnhsX3BhdGggPSBsaWJ4bF9fZGV2
aWNlX2xpYnhsX3BhdGgoZ2MsICZkZXZpY2UpOworCisgICAgZGF0YV9sb2NrID0gbGlieGxfX2xv
Y2tfZG9tYWluX3VzZXJkYXRhKGdjLCBkb21pZCk7CisgICAgaWYgKCFkYXRhX2xvY2spIHsKKyAg
ICAgICAgcmMgPSBFUlJPUl9MT0NLX0ZBSUw7CisgICAgICAgIGdvdG8gb3V0OworICAgIH0KKwor
ICAgIHJjID0gbGlieGxfX2dldF9kb21haW5fY29uZmlndXJhdGlvbihnYywgZG9taWQsICZkX2Nv
bmZpZyk7CisgICAgaWYgKHJjKSBnb3RvIG91dDsKKworICAgIGRldmljZV9hZGRfZG9tYWluX2Nv
bmZpZyhnYywgJmRfY29uZmlnLCAmbGlieGxfX2Rpc2tfZGV2dHlwZSwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgJmNpcy0+ZGlza19zYXZlZCk7CisKICAgICBpbnNlcnQgPSBmbGV4YXJy
YXlfbWFrZShnYywgNCwgMSk7CiAgICAgZmxleGFycmF5X2FwcGVuZF9wYWlyKGluc2VydCwgInR5
cGUiLAogICAgICAgICAgICAgICAgICAgICAgIGxpYnhsX19kZXZpY2VfZGlza19zdHJpbmdfb2Zf
YmFja2VuZChkaXNrLT5iYWNrZW5kKSk7CkBAIC04MzAsMjEgKzk0MSwyNCBAQCBpbnQgbGlieGxf
Y2Ryb21faW5zZXJ0KGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBkb21pZCwgbGlieGxfZGV2aWNl
X2Rpc2sgKmRpc2ssCiAgICAgICAgIGlmIChyYyA8IDApIGdvdG8gb3V0OwogICAgIH0KIAotICAg
IC8qIHN1Y2Nlc3MsIG5vIGFjdHVhbCBhc3luYyAqLwotICAgIGxpYnhsX19hb19jb21wbGV0ZShl
Z2MsIGFvLCAwKTsKLQogICAgIHJjID0gMDsKIAogb3V0OgogICAgIGxpYnhsX194c190cmFuc2Fj
dGlvbl9hYm9ydChnYywgJnQpOwotICAgIGxpYnhsX19kZXZpY2VfbGlzdF9mcmVlKCZsaWJ4bF9f
ZGlza19kZXZ0eXBlLCBkaXNrcywgbnVtKTsKLSAgICBsaWJ4bF9kZXZpY2VfZGlza19kaXNwb3Nl
KCZkaXNrX3NhdmVkKTsKICAgICBsaWJ4bF9kb21haW5fY29uZmlnX2Rpc3Bvc2UoJmRfY29uZmln
KTsKKyAgICBpZiAoZGF0YV9sb2NrKSBsaWJ4bF9fdW5sb2NrX2RvbWFpbl91c2VyZGF0YShkYXRh
X2xvY2spOworICAgIGNkcm9tX2luc2VydF9kb25lKGVnYywgY2lzLCByYyk7IC8qIG11c3QgYmUg
bGFzdCAqLworfQogCi0gICAgaWYgKGxvY2spIGxpYnhsX191bmxvY2tfZG9tYWluX3VzZXJkYXRh
KGxvY2spOworc3RhdGljIHZvaWQgY2Ryb21faW5zZXJ0X2RvbmUobGlieGxfX2VnYyAqZWdjLAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfX2Nkcm9tX2luc2VydF9zdGF0ZSAq
Y2lzLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50IHJjKQoreworICAgIEVHQ19H
QzsKIAotICAgIGlmIChyYykgcmV0dXJuIEFPX0NSRUFURV9GQUlMKHJjKTsKLSAgICByZXR1cm4g
QU9fSU5QUk9HUkVTUzsKKyAgICBsaWJ4bF9fZXZfZGV2bG9ja191bmxvY2soZ2MsICZjaXMtPnFt
cF9sb2NrKTsKKyAgICBsaWJ4bF9kZXZpY2VfZGlza19kaXNwb3NlKCZjaXMtPmRpc2tfc2F2ZWQp
OworICAgIGxpYnhsX19hb19jb21wbGV0ZShlZ2MsIGNpcy0+YW8sIHJjKTsKIH0KIAogLyogbGli
eGxfX2FsbG9jX3ZkZXYgb25seSB3b3JrcyBvbiB0aGUgbG9jYWwgZG9tYWluLCB0aGF0IGlzIHRo
ZSBkb21haW4KLS0gCkFudGhvbnkgUEVSQVJECgoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlz
dHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xp
c3RpbmZvL3hlbi1kZXZlbA==

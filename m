Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id B2E26B0965
	for <lists+xen-devel@lfdr.de>; Thu, 12 Sep 2019 09:22:14 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i8JO4-0001pi-4m; Thu, 12 Sep 2019 07:19:28 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=+knL=XH=intel.com=chao.gao@srs-us1.protection.inumbo.net>)
 id 1i8JO3-0001oj-5x
 for xen-devel@lists.xenproject.org; Thu, 12 Sep 2019 07:19:27 +0000
X-Inumbo-ID: 9ac2198c-d52d-11e9-83e3-12813bfff9fa
Received: from mga01.intel.com (unknown [192.55.52.88])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 9ac2198c-d52d-11e9-83e3-12813bfff9fa;
 Thu, 12 Sep 2019 07:19:05 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by fmsmga101.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 12 Sep 2019 00:19:05 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,492,1559545200"; d="scan'208";a="189906348"
Received: from gao-cwp.sh.intel.com ([10.239.159.26])
 by orsmga006.jf.intel.com with ESMTP; 12 Sep 2019 00:19:02 -0700
From: Chao Gao <chao.gao@intel.com>
To: xen-devel@lists.xenproject.org
Date: Thu, 12 Sep 2019 15:22:25 +0800
Message-Id: <1568272949-1086-13-git-send-email-chao.gao@intel.com>
X-Mailer: git-send-email 1.9.1
In-Reply-To: <1568272949-1086-1-git-send-email-chao.gao@intel.com>
References: <1568272949-1086-1-git-send-email-chao.gao@intel.com>
Subject: [Xen-devel] [PATCH v10 12/16] x86/microcode: Synchronize late
 microcode loading
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Sergey Dyasli <sergey.dyasli@citrix.com>, Kevin Tian <kevin.tian@intel.com>,
 Borislav Petkov <bp@suse.de>, Ashok Raj <ashok.raj@intel.com>,
 Wei Liu <wl@xen.org>, Jun Nakajima <jun.nakajima@intel.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Jan Beulich <jbeulich@suse.com>,
 Thomas Gleixner <tglx@linutronix.de>, Chao Gao <chao.gao@intel.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhpcyBwYXRjaCBwb3J0cyBtaWNyb2NvZGUgaW1wcm92ZW1lbnQgcGF0Y2hlcyBmcm9tIGxpbnV4
IGtlcm5lbC4KCkJlZm9yZSB5b3UgcmVhZCBhbnkgZnVydGhlcjogdGhlIGVhcmx5IGxvYWRpbmcg
bWV0aG9kIGlzIHN0aWxsIHRoZQpwcmVmZXJyZWQgb25lIGFuZCB5b3Ugc2hvdWxkIGFsd2F5cyBk
byB0aGF0LiBUaGUgZm9sbG93aW5nIHBhdGNoIGlzCmltcHJvdmluZyB0aGUgbGF0ZSBsb2FkaW5n
IG1lY2hhbmlzbSBmb3IgbG9uZyBydW5uaW5nIGpvYnMgYW5kIGNsb3VkIHVzZQpjYXNlcy4KCkdh
dGhlciBhbGwgY29yZXMgYW5kIHNlcmlhbGl6ZSB0aGUgbWljcm9jb2RlIHVwZGF0ZSBvbiB0aGVt
IGJ5IGRvaW5nIGl0Cm9uZS1ieS1vbmUgdG8gbWFrZSB0aGUgbGF0ZSB1cGRhdGUgcHJvY2VzcyBh
cyByZWxpYWJsZSBhcyBwb3NzaWJsZSBhbmQKYXZvaWQgcG90ZW50aWFsIGlzc3VlcyBjYXVzZWQg
YnkgdGhlIG1pY3JvY29kZSB1cGRhdGUuCgpTaWduZWQtb2ZmLWJ5OiBDaGFvIEdhbyA8Y2hhby5n
YW9AaW50ZWwuY29tPgpUZXN0ZWQtYnk6IENoYW8gR2FvIDxjaGFvLmdhb0BpbnRlbC5jb20+Clts
aW51eCBjb21taXQ6IGE1MzIxYWVjNjQxMmIyMGI1YWQxNWRiMmQ2YjkxNmMwNTM0OWRiZmZdClts
aW51eCBjb21taXQ6IGJiOGMxM2Q2MWE2MjkyNzZhMTYyYzFkMmIxYTIwYTgxNWNiY2ZiYjddCkNj
OiBLZXZpbiBUaWFuIDxrZXZpbi50aWFuQGludGVsLmNvbT4KQ2M6IEp1biBOYWthamltYSA8anVu
Lm5ha2FqaW1hQGludGVsLmNvbT4KQ2M6IEFzaG9rIFJhaiA8YXNob2sucmFqQGludGVsLmNvbT4K
Q2M6IEJvcmlzbGF2IFBldGtvdiA8YnBAc3VzZS5kZT4KQ2M6IFRob21hcyBHbGVpeG5lciA8dGds
eEBsaW51dHJvbml4LmRlPgpDYzogQW5kcmV3IENvb3BlciA8YW5kcmV3LmNvb3BlcjNAY2l0cml4
LmNvbT4KQ2M6IEphbiBCZXVsaWNoIDxqYmV1bGljaEBzdXNlLmNvbT4KLS0tCkNoYW5nZXMgaW4g
djEwOgogLSBpbnRyb2R1Y2Ugd2FpdF9mb3Jfc3RhdGUoKSBhbmQgc2V0X3N0YXRlKCkgaGVscGVy
IGZ1bmN0aW9ucwogLSBtYWtlIHdhaXRfZm9yX2NvbmRpdGlvbigpIHJldHVybiBib29sIGFuZCB0
YWtlIGNvbnN0IHZvaWQgKgogLSBkaXNhYmxlL2VuYWJsZSB3YXRjaGRvZyBpbiBjb250cm9sIHRo
cmVhZAogLSByZW5hbWUgIm1hc3RlciIgYW5kICJzbGF2ZSIgdGhyZWFkIHRvICJwcmltYXJ5IiBh
bmQgInNlY29uZGFyeSIKCkNoYW5nZXMgaW4gdjk6CiAtIGxvZyBfX2J1aWxkaW5fcmV0dXJuX2Fk
ZHJlc3MoMCkgd2hlbiB0aW1lb3V0CiAtIGRpdmlkZSBDUFVzIGludG8gdGhyZWUgbG9naWNhbCBz
ZXRzIGFuZCB0aGV5IHdpbGwgY2FsbCBkaWZmZXJlbnQKIGZ1bmN0aW9ucyBkdXJpbmcgdWNvZGUg
bG9hZGluZy4gVGhlICdjb250cm9sIHRocmVhZCcgaXMgY2hvc2VuIHRvCiBjb29yZGluYXRlIHVj
b2RlIGxvYWRpbmcgb24gYWxsIENQVXMuIFNpbmNlIG9ubHkgY29udHJvbCB0aHJlYWQgd291bGQK
IHNldCAnbG9hZGluZ19zdGF0ZScsIHdlIGNhbiBnZXQgcmlkIG9mICdjbXB4Y2hnJyBzdHVmZiBp
biB2OC4KIC0gcy9yZXBfbm9wL2NwdV9yZWxheAogLSBlYWNoIHRocmVhZCB1cGRhdGVzIGl0cyBy
ZXZpc2lvbiBudW1iZXIgaXRzZWxmCiAtIGFkZCBYRU5MT0dfRVJSIHByZWZpeCBmb3IgZWFjaCBs
aW5lIG9mIG11bHRpLWxpbmUgbG9nIG1lc3NhZ2VzCgpDaGFuZ2VzIGluIHY4OgogLSB0byBzdXBw
b3J0IGJsb2NraW5nICNOTUkgaGFuZGxpbmcgZHVyaW5nIGxvYWRpbmcgdWNvZGUKICAgKiBpbnRy
b2R1Y2UgYSBmbGFnLCAnbG9hZGluZ19zdGF0ZScsIHRvIG1hcmsgdGhlIHN0YXJ0IG9yIGVuZCBv
ZgogICAgIHVjb2RlIGxvYWRpbmcuCiAgICogdXNlIGEgYml0bWFwIGZvciBjcHUgY2FsbGluIHNp
bmNlIGlmIGNwdSBtYXkgc3RheSBpbiAjTk1JIGhhbmRsaW5nLAogICAgIHRoZXJlIGFyZSB0d28g
cGxhY2VzIGZvciBhIGNwdSB0byBjYWxsIGluLiBiaXRtYXAgd29uJ3QgYmUgY291bnRlZAogICAg
IHR3aWNlLgogICAqIGRvbid0IHdhaXQgZm9yIGFsbCBDUFVzIGNhbGxvdXQsIGp1c3Qgd2FpdCBm
b3IgQ1BVcyB0aGF0IHBlcmZvcm0gdGhlCiAgICAgdXBkYXRlLiBXZSBoYXZlIHRvIGRvIHRoaXMg
YmVjYXVzZSBzb21lIHRocmVhZHMgbWF5IGJlIHN0dWNrIGluIE5NSQogICAgIGhhbmRsaW5nICh3
aGVyZSBjYW5ub3QgcmVhY2ggdGhlIHJlbmRlenZvdXMpLgogLSBlbWl0IGEgd2FybmluZyBpZiB0
aGUgc3lzdGVtIHN0YXlzIGluIHN0b3BfbWFjaGluZSBjb250ZXh0IGZvciBtb3JlCiB0aGFuIDFz
CiAtIGNvbW1lbnQgdGhhdCByZHRzYyBpcyBmaW5lIHdoaWxlIGxvYWRpbmcgYW4gdXBkYXRlCiAt
IHVzZSBjbXB4Y2hnKCkgdG8gYXZvaWQgcGFuaWMgYmVpbmcgY2FsbGVkIG9uIG11bHRpcGxlIENQ
VXMKIC0gUHJvcGFnYXRlIHJldmlzaW9uIG51bWJlciB0byBvdGhlciB0aHJlYWRzCiAtIHJlZmlu
ZSBjb21tZW50cyBhbmQgcHJvbXB0IG1lc3NhZ2VzCgpDaGFuZ2VzIGluIHY3OgogLSBDaGVjayB3
aGV0aGVyICd0aW1lb3V0JyBpcyAwIHJhdGhlciB0aGFuICI8PTAiIHNpbmNlIGl0IGlzIHVuc2ln
bmVkIGludC4KIC0gcmV3b3JkIHRoZSBjb21tZW50IGFib3ZlIG1pY3JvY29kZV91cGRhdGVfY3B1
KCkgdG8gY2xlYXJseSBzdGF0ZSB0aGF0CiBvbmUgdGhyZWFkIHBlciBjb3JlIHNob3VsZCBkbyB0
aGUgdXBkYXRlLgotLS0KIHhlbi9hcmNoL3g4Ni9taWNyb2NvZGUuYyB8IDI5NiArKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tLQogMSBmaWxlIGNoYW5nZWQsIDI2
OSBpbnNlcnRpb25zKCspLCAyNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94
ODYvbWljcm9jb2RlLmMgYi94ZW4vYXJjaC94ODYvbWljcm9jb2RlLmMKaW5kZXggYzJlYTIwZi4u
MDQ5ZWRhNiAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L21pY3JvY29kZS5jCisrKyBiL3hlbi9h
cmNoL3g4Ni9taWNyb2NvZGUuYwpAQCAtMzAsMTggKzMwLDUyIEBACiAjaW5jbHVkZSA8eGVuL3Nt
cC5oPgogI2luY2x1ZGUgPHhlbi9zb2Z0aXJxLmg+CiAjaW5jbHVkZSA8eGVuL3NwaW5sb2NrLmg+
CisjaW5jbHVkZSA8eGVuL3N0b3BfbWFjaGluZS5oPgogI2luY2x1ZGUgPHhlbi90YXNrbGV0Lmg+
CiAjaW5jbHVkZSA8eGVuL2d1ZXN0X2FjY2Vzcy5oPgogI2luY2x1ZGUgPHhlbi9lYXJseWNwaW8u
aD4KKyNpbmNsdWRlIDx4ZW4vd2F0Y2hkb2cuaD4KIAorI2luY2x1ZGUgPGFzbS9kZWxheS5oPgog
I2luY2x1ZGUgPGFzbS9tc3IuaD4KICNpbmNsdWRlIDxhc20vcHJvY2Vzc29yLmg+CiAjaW5jbHVk
ZSA8YXNtL3NldHVwLmg+CiAjaW5jbHVkZSA8YXNtL21pY3JvY29kZS5oPgogCisvKgorICogQmVm
b3JlIHBlcmZvcm1pbmcgYSBsYXRlIG1pY3JvY29kZSB1cGRhdGUgb24gYW55IHRocmVhZCwgd2UK
KyAqIHJlbmRlenZvdXMgYWxsIGNwdXMgaW4gc3RvcF9tYWNoaW5lIGNvbnRleHQuIFRoZSB0aW1l
b3V0IGZvcgorICogd2FpdGluZyBmb3IgY3B1IHJlbmRlenZvdXMgaXMgMzBtcy4gSXQgaXMgdGhl
IHRpbWVvdXQgdXNlZCBieQorICogbGl2ZSBwYXRjaGluZworICovCisjZGVmaW5lIE1JQ1JPQ09E
RV9DQUxMSU5fVElNRU9VVF9VUyAzMDAwMAorCisvKgorICogVGltZW91dCBmb3IgZWFjaCB0aHJl
YWQgdG8gY29tcGxldGUgdXBkYXRlIGlzIHNldCB0byAxcy4gSXQgaXMgYQorICogY29uc2VydmF0
aXZlIGNob2ljZSBjb25zaWRlcmluZyBhbGwgcG9zc2libGUgaW50ZXJmZXJlbmNlLgorICovCisj
ZGVmaW5lIE1JQ1JPQ09ERV9VUERBVEVfVElNRU9VVF9VUyAxMDAwMDAwCisKIHN0YXRpYyBtb2R1
bGVfdCBfX2luaXRkYXRhIHVjb2RlX21vZDsKIHN0YXRpYyBzaWduZWQgaW50IF9faW5pdGRhdGEg
dWNvZGVfbW9kX2lkeDsKIHN0YXRpYyBib29sX3QgX19pbml0ZGF0YSB1Y29kZV9tb2RfZm9yY2Vk
Oworc3RhdGljIHVuc2lnbmVkIGludCBucl9jb3JlczsKKworLyoKKyAqIFRoZXNlIHN0YXRlcyBo
ZWxwIHRvIGNvb3JkaW5hdGUgQ1BVcyBkdXJpbmcgbG9hZGluZyBhbiB1cGRhdGUuCisgKgorICog
VGhlIHNlbWFudGljcyBvZiBlYWNoIHN0YXRlIGlzIGFzIGZvbGxvdzoKKyAqICAtIExPQURJTkdf
UFJFUEFSRTogaW5pdGlhbCBzdGF0ZSBvZiAnbG9hZGluZ19zdGF0ZScuCisgKiAgLSBMT0FESU5H
X0NBTExJTjogQ1BVcyBhcmUgYWxsb3dlZCB0byBjYWxsaW4uCisgKiAgLSBMT0FESU5HX0VOVEVS
OiBhbGwgQ1BVcyBoYXZlIGNhbGxlZCBpbi4gSW5pdGlhdGUgdWNvZGUgbG9hZGluZy4KKyAqICAt
IExPQURJTkdfRVhJVDogdWNvZGUgbG9hZGluZyBpcyBkb25lIG9yIGFib3J0ZWQuCisgKi8KK3N0
YXRpYyBlbnVtIHsKKyAgICBMT0FESU5HX1BSRVBBUkUsCisgICAgTE9BRElOR19DQUxMSU4sCisg
ICAgTE9BRElOR19FTlRFUiwKKyAgICBMT0FESU5HX0VYSVQsCit9IGxvYWRpbmdfc3RhdGU7CiAK
IC8qCiAgKiBJZiB3ZSBzY2FuIHRoZSBpbml0cmFtZnMuY3BpbyBmb3IgdGhlIGVhcmx5IG1pY3Jv
Y29kZSBjb2RlCkBAIC0xOTAsNiArMjI0LDE2IEBAIHN0YXRpYyBERUZJTkVfU1BJTkxPQ0sobWlj
cm9jb2RlX211dGV4KTsKIERFRklORV9QRVJfQ1BVKHN0cnVjdCBjcHVfc2lnbmF0dXJlLCBjcHVf
c2lnKTsKIAogLyoKKyAqIENvdW50IHRoZSBDUFVzIHRoYXQgaGF2ZSBlbnRlcmVkLCBleGl0ZWQg
dGhlIHJlbmRlenZvdXMgYW5kIHN1Y2NlZWRlZCBpbgorICogbWljcm9jb2RlIHVwZGF0ZSBkdXJp
bmcgbGF0ZSBtaWNyb2NvZGUgdXBkYXRlIHJlc3BlY3RpdmVseS4KKyAqCisgKiBOb3RlIHRoYXQg
YSBiaXRtYXAgaXMgdXNlZCBmb3IgY2FsbGluIHRvIGFsbG93IGNwdSB0byBzZXQgYSBiaXQgbXVs
dGlwbGUKKyAqIHRpbWVzLiBJdCBpcyByZXF1aXJlZCB0byBkbyBidXN5LWxvb3AgaW4gI05NSSBo
YW5kbGluZy4KKyAqLworc3RhdGljIGNwdW1hc2tfdCBjcHVfY2FsbGluX21hcDsKK3N0YXRpYyBh
dG9taWNfdCBjcHVfb3V0LCBjcHVfdXBkYXRlZDsKKworLyoKICAqIFJldHVybiBhIHBhdGNoIHRo
YXQgY292ZXJzIGN1cnJlbnQgQ1BVLiBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgcGF0Y2hlcywKICAq
IHJldHVybiB0aGUgb25lIHdpdGggdGhlIGhpZ2hlc3QgcmV2aXNpb24gbnVtYmVyLiBSZXR1cm4g
ZXJyb3IgSWYgbm8KICAqIHBhdGNoIGlzIGZvdW5kIGFuZCBhbiBlcnJvciBvY2N1cnMgZHVyaW5n
IHRoZSBwYXJzaW5nIHByb2Nlc3MuIE90aGVyd2lzZQpAQCAtMjMxLDYgKzI3NSwzNCBAQCBzdGF0
aWMgYm9vbCBtaWNyb2NvZGVfdXBkYXRlX2NhY2hlKHN0cnVjdCBtaWNyb2NvZGVfcGF0Y2ggKnBh
dGNoKQogICAgIHJldHVybiB0cnVlOwogfQogCisvKiBXYWl0IGZvciBhIGNvbmRpdGlvbiB0byBi
ZSBtZXQgd2l0aCBhIHRpbWVvdXQgKHVzKS4gKi8KK3N0YXRpYyBpbnQgd2FpdF9mb3JfY29uZGl0
aW9uKGJvb2wgKCpmdW5jKShjb25zdCB2b2lkICpkYXRhKSwgdm9pZCAqZGF0YSwKKyAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCB0aW1lb3V0KQoreworICAgIHdoaWxl
ICggIWZ1bmMoZGF0YSkgKQorICAgIHsKKyAgICAgICAgaWYgKCAhdGltZW91dC0tICkKKyAgICAg
ICAgeworICAgICAgICAgICAgcHJpbnRrKCJDUFUldTogVGltZW91dCBpbiAlcFNcbiIsCisgICAg
ICAgICAgICAgICAgICAgc21wX3Byb2Nlc3Nvcl9pZCgpLCBfX2J1aWx0aW5fcmV0dXJuX2FkZHJl
c3MoMCkpOworICAgICAgICAgICAgcmV0dXJuIC1FQlVTWTsKKyAgICAgICAgfQorICAgICAgICB1
ZGVsYXkoMSk7CisgICAgfQorCisgICAgcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBib29sIHdhaXRf
Y3B1X2NhbGxpbihjb25zdCB2b2lkICpucikKK3sKKyAgICByZXR1cm4gY3B1bWFza193ZWlnaHQo
JmNwdV9jYWxsaW5fbWFwKSA+PSAodW5zaWduZWQgbG9uZylucjsKK30KKworc3RhdGljIGJvb2wg
d2FpdF9jcHVfY2FsbG91dChjb25zdCB2b2lkICpucikKK3sKKyAgICByZXR1cm4gYXRvbWljX3Jl
YWQoJmNwdV9vdXQpID49ICh1bnNpZ25lZCBsb25nKW5yOworfQorCiAvKgogICogTG9hZCBhIG1p
Y3JvY29kZSB1cGRhdGUgdG8gY3VycmVudCBDUFUuCiAgKgpAQCAtMjY0LDM4ICszMzYsMTU4IEBA
IHN0YXRpYyBpbnQgbWljcm9jb2RlX3VwZGF0ZV9jcHUoY29uc3Qgc3RydWN0IG1pY3JvY29kZV9w
YXRjaCAqcGF0Y2gpCiAgICAgcmV0dXJuIGVycjsKIH0KIAotc3RhdGljIGxvbmcgZG9fbWljcm9j
b2RlX3VwZGF0ZSh2b2lkICpwYXRjaCkKK3N0YXRpYyBib29sIHdhaXRfZm9yX3N0YXRlKHVuc2ln
bmVkIGludCBzdGF0ZSkKK3sKKyAgICB3aGlsZSAoIGxvYWRpbmdfc3RhdGUgIT0gc3RhdGUgKQor
ICAgIHsKKyAgICAgICAgaWYgKCBzdGF0ZSAhPSBMT0FESU5HX0VYSVQgJiYgbG9hZGluZ19zdGF0
ZSA9PSBMT0FESU5HX0VYSVQgKQorICAgICAgICAgICAgcmV0dXJuIGZhbHNlOworICAgICAgICBj
cHVfcmVsYXgoKTsKKyAgICB9CisKKyAgICByZXR1cm4gdHJ1ZTsKK30KKworc3RhdGljIHZvaWQg
c2V0X3N0YXRlKHVuc2lnbmVkIGludCBzdGF0ZSkKK3sKKyAgICBsb2FkaW5nX3N0YXRlID0gc3Rh
dGU7CisgICAgc21wX3dtYigpOworfQorCitzdGF0aWMgaW50IHNlY29uZGFyeV90aHJlYWRfZm4o
dm9pZCkKK3sKKyAgICB1bnNpZ25lZCBpbnQgcHJpbWFyeSA9IGNwdW1hc2tfZmlyc3QodGhpc19j
cHUoY3B1X3NpYmxpbmdfbWFzaykpOworCisgICAgaWYgKCAhd2FpdF9mb3Jfc3RhdGUoTE9BRElO
R19DQUxMSU4pICkKKyAgICAgICAgcmV0dXJuIC1FQlVTWTsKKworICAgIGNwdW1hc2tfc2V0X2Nw
dShzbXBfcHJvY2Vzc29yX2lkKCksICZjcHVfY2FsbGluX21hcCk7CisKKyAgICBpZiAoICF3YWl0
X2Zvcl9zdGF0ZShMT0FESU5HX0VYSVQpICkKKyAgICAgICAgcmV0dXJuIC1FQlVTWTsKKworICAg
IC8qIENvcHkgdXBkYXRlIHJldmlzaW9uIGZyb20gdGhlIHByaW1hcnkgdGhyZWFkLiAqLworICAg
IHRoaXNfY3B1KGNwdV9zaWcpLnJldiA9IHBlcl9jcHUoY3B1X3NpZywgcHJpbWFyeSkucmV2Owor
CisgICAgcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgcHJpbWFyeV90aHJlYWRfZm4oY29uc3Qg
c3RydWN0IG1pY3JvY29kZV9wYXRjaCAqcGF0Y2gpCit7CisgICAgaW50IHJldCA9IDA7CisKKyAg
ICBpZiAoICF3YWl0X2Zvcl9zdGF0ZShMT0FESU5HX0NBTExJTikgKQorICAgICAgICByZXR1cm4g
LUVCVVNZOworCisgICAgY3B1bWFza19zZXRfY3B1KHNtcF9wcm9jZXNzb3JfaWQoKSwgJmNwdV9j
YWxsaW5fbWFwKTsKKworICAgIGlmICggIXdhaXRfZm9yX3N0YXRlKExPQURJTkdfRU5URVIpICkK
KyAgICAgICAgcmV0dXJuIC1FQlVTWTsKKworICAgIHJldCA9IG1pY3JvY29kZV9vcHMtPmFwcGx5
X21pY3JvY29kZShwYXRjaCk7CisgICAgaWYgKCAhcmV0ICkKKyAgICAgICAgYXRvbWljX2luYygm
Y3B1X3VwZGF0ZWQpOworICAgIGF0b21pY19pbmMoJmNwdV9vdXQpOworCisgICAgcmV0dXJuIHJl
dDsKK30KKworc3RhdGljIGludCBjb250cm9sX3RocmVhZF9mbihjb25zdCBzdHJ1Y3QgbWljcm9j
b2RlX3BhdGNoICpwYXRjaCkKIHsKLSAgICB1bnNpZ25lZCBpbnQgY3B1OwotICAgIGludCByZXQg
PSBtaWNyb2NvZGVfdXBkYXRlX2NwdShwYXRjaCk7CisgICAgdW5zaWduZWQgaW50IGNwdSA9IHNt
cF9wcm9jZXNzb3JfaWQoKSwgZG9uZTsKKyAgICB1bnNpZ25lZCBsb25nIHRpY2s7CisgICAgaW50
IHJldDsKKworICAgIC8qCisgICAgICogV2UgaW50ZW5kIHRvIGRpc2FibGUgaW50ZXJydXB0IGZv
ciBsb25nIHRpbWUsIHdoaWNoIG1heSBsZWFkIHRvCisgICAgICogd2F0Y2hkb2cgdGltZW91dC4K
KyAgICAgKi8KKyAgICB3YXRjaGRvZ19kaXNhYmxlKCk7CiAKLSAgICAvKiBTdG9yZSB0aGUgcGF0
Y2ggYWZ0ZXIgYSBzdWNjZXNzZnVsIGxvYWRpbmcgKi8KLSAgICBpZiAoICFyZXQgJiYgcGF0Y2gg
KQorICAgIC8qIEFsbG93IHRocmVhZHMgdG8gY2FsbCBpbiAqLworICAgIHNldF9zdGF0ZShMT0FE
SU5HX0NBTExJTik7CisKKyAgICBjcHVtYXNrX3NldF9jcHUoY3B1LCAmY3B1X2NhbGxpbl9tYXAp
OworCisgICAgLyogV2FpdGluZyBmb3IgYWxsIHRocmVhZHMgY2FsbGluZyBpbiAqLworICAgIHJl
dCA9IHdhaXRfZm9yX2NvbmRpdGlvbih3YWl0X2NwdV9jYWxsaW4sCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICh2b2lkICopKHVuc2lnbmVkIGxvbmcpbnVtX29ubGluZV9jcHVzKCksCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1JQ1JPQ09ERV9DQUxMSU5fVElNRU9VVF9VUyk7
CisgICAgaWYgKCByZXQgKQogICAgIHsKLSAgICAgICAgc3Bpbl9sb2NrKCZtaWNyb2NvZGVfbXV0
ZXgpOwotICAgICAgICBtaWNyb2NvZGVfdXBkYXRlX2NhY2hlKHBhdGNoKTsKLSAgICAgICAgc3Bp
bl91bmxvY2soJm1pY3JvY29kZV9tdXRleCk7Ci0gICAgICAgIHBhdGNoID0gTlVMTDsKKyAgICAg
ICAgc2V0X3N0YXRlKExPQURJTkdfRVhJVCk7CisgICAgICAgIHJldHVybiByZXQ7CiAgICAgfQog
Ci0gICAgaWYgKCBtaWNyb2NvZGVfb3BzLT5lbmRfdXBkYXRlX3BlcmNwdSApCi0gICAgICAgIG1p
Y3JvY29kZV9vcHMtPmVuZF91cGRhdGVfcGVyY3B1KCk7CisgICAgLyogTGV0IHByaW1hcnkgdGhy
ZWFkcyBsb2FkIHRoZSBnaXZlbiB1Y29kZSB1cGRhdGUgKi8KKyAgICBzZXRfc3RhdGUoTE9BRElO
R19FTlRFUik7CiAKKyAgICByZXQgPSBtaWNyb2NvZGVfb3BzLT5hcHBseV9taWNyb2NvZGUocGF0
Y2gpOworICAgIGlmICggIXJldCApCisgICAgICAgIGF0b21pY19pbmMoJmNwdV91cGRhdGVkKTsK
KyAgICBhdG9taWNfaW5jKCZjcHVfb3V0KTsKKworICAgIHRpY2sgPSByZHRzY19vcmRlcmVkKCk7
CisgICAgLyogV2FpdCBmb3IgcHJpbWFyeSB0aHJlYWRzIGZpbmlzaGluZyB1cGRhdGUgKi8KKyAg
ICBkb25lID0gYXRvbWljX3JlYWQoJmNwdV9vdXQpOworICAgIHdoaWxlICggZG9uZSAhPSBucl9j
b3JlcyApCisgICAgeworICAgICAgICAvKgorICAgICAgICAgKiBEdXJpbmcgZWFjaCB0aW1lb3V0
IGludGVydmFsLCBhdCBsZWFzdCBhIENQVSBpcyBleHBlY3RlZCB0bworICAgICAgICAgKiBmaW5p
c2ggaXRzIHVwZGF0ZS4gT3RoZXJ3aXNlLCBzb21ldGhpbmcgZ29lcyB3cm9uZy4KKyAgICAgICAg
ICoKKyAgICAgICAgICogTm90ZSB0aGF0IFJEVFNDIChpbiB3YWl0X2Zvcl9jb25kaXRpb24oKSkg
aXMgc2FmZSBmb3IgdGhyZWFkcyB0bworICAgICAgICAgKiBleGVjdXRlIHdoaWxlIHdhaXRpbmcg
Zm9yIGNvbXBsZXRpb24gb2YgbG9hZGluZyBhbiB1cGRhdGUuCisgICAgICAgICAqLworICAgICAg
ICBpZiAoIHdhaXRfZm9yX2NvbmRpdGlvbih3YWl0X2NwdV9jYWxsb3V0LAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAodm9pZCAqKSh1bnNpZ25lZCBsb25nKShkb25lICsgMSksCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1JQ1JPQ09ERV9VUERBVEVfVElNRU9VVF9V
UykgKQorICAgICAgICAgICAgcGFuaWMoIlRpbWVvdXQgd2hlbiBmaW5pc2hlZCB1cGRhdGluZyBt
aWNyb2NvZGUgKGZpbmlzaGVkICV1LyV1KSIsCisgICAgICAgICAgICAgICAgICBkb25lLCBucl9j
b3Jlcyk7CisKKyAgICAgICAgLyogUHJpbnQgd2FybmluZyBtZXNzYWdlIG9uY2UgaWYgbG9uZyB0
aW1lIGlzIHNwZW50IGhlcmUgKi8KKyAgICAgICAgaWYgKCB0aWNrICYmIHJkdHNjX29yZGVyZWQo
KSAtIHRpY2sgPj0gY3B1X2toeiAqIDEwMDAgKQorICAgICAgICB7CisgICAgICAgICAgICBwcmlu
dGsoWEVOTE9HX1dBUk5JTkcKKyAgICAgICAgICAgICAgICAgICAiV0FSTklORzogVVBEQVRJTkcg
TUlDUk9DT0RFIEhBUyBDT05TVU1FRCBNT1JFIFRIQU4gMSBTRUNPTkQhXG4iKTsKKyAgICAgICAg
ICAgIHRpY2sgPSAwOworICAgICAgICB9CisgICAgICAgIGRvbmUgPSBhdG9taWNfcmVhZCgmY3B1
X291dCk7CisgICAgfQorCisgICAgLyogTWFyayBsb2FkaW5nIGlzIGRvbmUgdG8gdW5ibG9jayBv
dGhlciB0aHJlYWRzICovCisgICAgc2V0X3N0YXRlKExPQURJTkdfRVhJVCk7CisKKyAgICB3YXRj
aGRvZ19lbmFibGUoKTsKKworICAgIHJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBpbnQgZG9fbWlj
cm9jb2RlX3VwZGF0ZSh2b2lkICpwYXRjaCkKK3sKKyAgICB1bnNpZ25lZCBpbnQgY3B1ID0gc21w
X3Byb2Nlc3Nvcl9pZCgpOwogICAgIC8qCi0gICAgICogRWFjaCB0aHJlYWQgdHJpZXMgdG8gbG9h
ZCB1Y29kZSBhbmQgb25seSB0aGUgZmlyc3QgdGhyZWFkIG9mIGEgY29yZQotICAgICAqIHdvdWxk
IHN1Y2NlZWQuIElnbm9yZSBlcnJvciBvdGhlciB0aGFuIC1FSU8uCisgICAgICogcHJpbWFyeSB0
aHJlYWQgaXMgdGhlIG9uZSB3aXRoIHRoZSBsb3dlc3QgdGhyZWFkIGlkIGFtb25nIGFsbCBzaWJs
aW5ncworICAgICAqIHRocmVhZCBpbiBhIGNvcmUgb3IgYSBjb21wdXRlIHVuaXQuIEl0IGlzIGNo
b3NlbiB0byBsb2FkIGEgbWljcm9jb2RlCisgICAgICogdXBkYXRlLgogICAgICAqLwotICAgIGlm
ICggcmV0ICE9IC1FSU8gKQotICAgICAgICByZXQgPSAwOworICAgIHVuc2lnbmVkIGludCBwcmlt
YXJ5ID0gY3B1bWFza19maXJzdCh0aGlzX2NwdShjcHVfc2libGluZ19tYXNrKSk7CisgICAgaW50
IHJldDsKIAotICAgIGNwdSA9IGNwdW1hc2tfbmV4dChzbXBfcHJvY2Vzc29yX2lkKCksICZjcHVf
b25saW5lX21hcCk7Ci0gICAgaWYgKCBjcHUgPCBucl9jcHVfaWRzICkKLSAgICAgICAgcmV0dXJu
IGNvbnRpbnVlX2h5cGVyY2FsbF9vbl9jcHUoY3B1LCBkb19taWNyb2NvZGVfdXBkYXRlLCBwYXRj
aCkgPwotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICA6IHJldDsKKyAgICAvKgorICAgICAqIFRoZSBjb250cm9s
IHRocmVhZCBzZXQgc3RhdGUgdG8gY29vcmRpbmF0ZSB1Y29kZSBsb2FkaW5nLiBQcmltYXJ5Cisg
ICAgICogdGhyZWFkcyBsb2FkIHRoZSBnaXZlbiB1Y29kZSBwYXRjaC4gU2Vjb25kYXJ5IHRocmVh
ZHMganVzdCB3YWl0IGZvcgorICAgICAqIHRoZSBjb21wbGV0aW9uIG9mIHRoZSB1Y29kZSBsb2Fk
aW5nIHByb2Nlc3MuCisgICAgICovCisgICAgaWYgKCBjcHUgPT0gY3B1bWFza19maXJzdCgmY3B1
X29ubGluZV9tYXApICkKKyAgICAgICAgcmV0ID0gY29udHJvbF90aHJlYWRfZm4ocGF0Y2gpOwor
ICAgIGVsc2UgaWYgKCBjcHUgPT0gcHJpbWFyeSApCisgICAgICAgIHJldCA9IHByaW1hcnlfdGhy
ZWFkX2ZuKHBhdGNoKTsKKyAgICBlbHNlCisgICAgICAgIHJldCA9IHNlY29uZGFyeV90aHJlYWRf
Zm4oKTsKIAotICAgIC8qIEZyZWUgdGhlIHBhdGNoIGlmIG5vIENQVSBoYXMgbG9hZGVkIGl0IHN1
Y2Nlc3NmdWxseS4gKi8KLSAgICBpZiAoIHBhdGNoICkKLSAgICAgICAgbWljcm9jb2RlX2ZyZWVf
cGF0Y2gocGF0Y2gpOworICAgIGlmICggbWljcm9jb2RlX29wcy0+ZW5kX3VwZGF0ZV9wZXJjcHUg
KQorICAgICAgICBtaWNyb2NvZGVfb3BzLT5lbmRfdXBkYXRlX3BlcmNwdSgpOwogCiAgICAgcmV0
dXJuIHJldDsKIH0KQEAgLTMwNCw2ICs0OTYsNyBAQCBpbnQgbWljcm9jb2RlX3VwZGF0ZShYRU5f
R1VFU1RfSEFORExFX1BBUkFNKGNvbnN0X3ZvaWQpIGJ1ZiwgdW5zaWduZWQgbG9uZyBsZW4pCiB7
CiAgICAgaW50IHJldDsKICAgICB2b2lkICpidWZmZXI7CisgICAgdW5zaWduZWQgaW50IGNwdSwg
dXBkYXRlZDsKICAgICBzdHJ1Y3QgbWljcm9jb2RlX3BhdGNoICpwYXRjaDsKIAogICAgIGlmICgg
bGVuICE9ICh1aW50MzJfdClsZW4gKQpAQCAtMzIyLDE4ICs1MTUsMjUgQEAgaW50IG1pY3JvY29k
ZV91cGRhdGUoWEVOX0dVRVNUX0hBTkRMRV9QQVJBTShjb25zdF92b2lkKSBidWYsIHVuc2lnbmVk
IGxvbmcgbGVuKQogICAgICAgICBnb3RvIGZyZWU7CiAgICAgfQogCisgICAgLyogY3B1X29ubGlu
ZV9tYXAgbXVzdCBub3QgY2hhbmdlIGR1cmluZyB1cGRhdGUgKi8KKyAgICBpZiAoICFnZXRfY3B1
X21hcHMoKSApCisgICAgeworICAgICAgICByZXQgPSAtRUJVU1k7CisgICAgICAgIGdvdG8gZnJl
ZTsKKyAgICB9CisKICAgICBwYXRjaCA9IHBhcnNlX2Jsb2IoYnVmZmVyLCBsZW4pOwogICAgIGlm
ICggSVNfRVJSKHBhdGNoKSApCiAgICAgewogICAgICAgICByZXQgPSBQVFJfRVJSKHBhdGNoKTsK
ICAgICAgICAgcHJpbnRrKFhFTkxPR19XQVJOSU5HICJQYXJzaW5nIG1pY3JvY29kZSBibG9iIGVy
cm9yICVkXG4iLCByZXQpOwotICAgICAgICBnb3RvIGZyZWU7CisgICAgICAgIGdvdG8gcHV0Owog
ICAgIH0KIAogICAgIGlmICggIXBhdGNoICkKICAgICB7CiAgICAgICAgIHJldCA9IC1FTk9FTlQ7
Ci0gICAgICAgIGdvdG8gZnJlZTsKKyAgICAgICAgZ290byBwdXQ7CiAgICAgfQogCiAgICAgaWYg
KCBtaWNyb2NvZGVfb3BzLT5zdGFydF91cGRhdGUgKQpAQCAtMzQyLDEzICs1NDIsNTUgQEAgaW50
IG1pY3JvY29kZV91cGRhdGUoWEVOX0dVRVNUX0hBTkRMRV9QQVJBTShjb25zdF92b2lkKSBidWYs
IHVuc2lnbmVkIGxvbmcgbGVuKQogICAgICAgICBpZiAoIHJldCAhPSAwICkKICAgICAgICAgewog
ICAgICAgICAgICAgbWljcm9jb2RlX2ZyZWVfcGF0Y2gocGF0Y2gpOwotICAgICAgICAgICAgZ290
byBmcmVlOworICAgICAgICAgICAgZ290byBwdXQ7CiAgICAgICAgIH0KICAgICB9CiAKLSAgICBy
ZXQgPSBjb250aW51ZV9oeXBlcmNhbGxfb25fY3B1KGNwdW1hc2tfZmlyc3QoJmNwdV9vbmxpbmVf
bWFwKSwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvX21pY3JvY29kZV91
cGRhdGUsIHBhdGNoKTsKKyAgICBjcHVtYXNrX2NsZWFyKCZjcHVfY2FsbGluX21hcCk7CisgICAg
YXRvbWljX3NldCgmY3B1X291dCwgMCk7CisgICAgYXRvbWljX3NldCgmY3B1X3VwZGF0ZWQsIDAp
OworICAgIGxvYWRpbmdfc3RhdGUgPSBMT0FESU5HX1BSRVBBUkU7CisKKyAgICAvKiBDYWxjdWxh
dGUgdGhlIG51bWJlciBvZiBvbmxpbmUgQ1BVIGNvcmUgKi8KKyAgICBucl9jb3JlcyA9IDA7Cisg
ICAgZm9yX2VhY2hfb25saW5lX2NwdShjcHUpCisgICAgICAgIGlmICggY3B1ID09IGNwdW1hc2tf
Zmlyc3QocGVyX2NwdShjcHVfc2libGluZ19tYXNrLCBjcHUpKSApCisgICAgICAgICAgICBucl9j
b3JlcysrOworCisgICAgcHJpbnRrKFhFTkxPR19JTkZPICIldSBjb3JlcyBhcmUgdG8gdXBkYXRl
IHRoZWlyIG1pY3JvY29kZVxuIiwgbnJfY29yZXMpOworCisgICAgLyoKKyAgICAgKiBMYXRlIGxv
YWRpbmcgZGFuY2UuIFdoeSB0aGUgaGVhdnktaGFuZGVkIHN0b3BfbWFjaGluZSBlZmZvcnQ/Cisg
ICAgICoKKyAgICAgKiAtIEhUIHNpYmxpbmdzIG11c3QgYmUgaWRsZSBhbmQgbm90IGV4ZWN1dGUg
b3RoZXIgY29kZSB3aGlsZSB0aGUgb3RoZXIKKyAgICAgKiAgIHNpYmxpbmcgaXMgbG9hZGluZyBt
aWNyb2NvZGUgaW4gb3JkZXIgdG8gYXZvaWQgYW55IG5lZ2F0aXZlCisgICAgICogICBpbnRlcmFj
dGlvbnMgY2F1c2UgYnkgdGhlIGxvYWRpbmcuCisgICAgICoKKyAgICAgKiAtIEluIGFkZGl0aW9u
LCBtaWNyb2NvZGUgdXBkYXRlIG9uIHRoZSBjb3JlcyBtdXN0IGJlIHNlcmlhbGl6ZWQgdW50aWwK
KyAgICAgKiAgIHRoaXMgcmVxdWlyZW1lbnQgY2FuIGJlIHJlbGF4ZWQgaW4gdGhlIGZ1dHVyZS4g
UmlnaHQgbm93LCB0aGlzIGlzCisgICAgICogICBjb25zZXJ2YXRpdmUgYW5kIGdvb2QuCisgICAg
ICovCisgICAgcmV0ID0gc3RvcF9tYWNoaW5lX3J1bihkb19taWNyb2NvZGVfdXBkYXRlLCBwYXRj
aCwgTlJfQ1BVUyk7CisKKyAgICB1cGRhdGVkID0gYXRvbWljX3JlYWQoJmNwdV91cGRhdGVkKTsK
KyAgICBpZiAoIHVwZGF0ZWQgPiAwICkKKyAgICB7CisgICAgICAgIHNwaW5fbG9jaygmbWljcm9j
b2RlX211dGV4KTsKKyAgICAgICAgbWljcm9jb2RlX3VwZGF0ZV9jYWNoZShwYXRjaCk7CisgICAg
ICAgIHNwaW5fdW5sb2NrKCZtaWNyb2NvZGVfbXV0ZXgpOworICAgIH0KKyAgICBlbHNlCisgICAg
ICAgIG1pY3JvY29kZV9mcmVlX3BhdGNoKHBhdGNoKTsKKworICAgIGlmICggdXBkYXRlZCAmJiB1
cGRhdGVkICE9IG5yX2NvcmVzICkKKyAgICAgICAgcHJpbnRrKFhFTkxPR19FUlIgIkVSUk9SOiBV
cGRhdGluZyBtaWNyb2NvZGUgc3VjY2VlZGVkIG9uICV1IGNvcmVzIGFuZCBmYWlsZWRcbiIKKyAg
ICAgICAgICAgICAgIFhFTkxPR19FUlIgIm9uIG90aGVyICV1IGNvcmVzLiBBIHN5c3RlbSB3aXRo
IGRpZmZlcmluZyBtaWNyb2NvZGVcbiIKKyAgICAgICAgICAgICAgIFhFTkxPR19FUlIgInJldmlz
aW9ucyBpcyBjb25zaWRlcmVkIHVuc3RhYmxlLiBQbGVhc2UgcmVib290IGFuZCBkbyBub3RcbiIK
KyAgICAgICAgICAgICAgIFhFTkxPR19FUlIgImxvYWQgdGhlIG1pY3JvY29kZSB0aGF0IHRyaWdn
ZXJzIHRoaXMgd2FybmluZyFcbiIsCisgICAgICAgICAgICAgICB1cGRhdGVkLCBucl9jb3JlcyAt
IHVwZGF0ZWQpOwogCisgcHV0OgorICAgIHB1dF9jcHVfbWFwcygpOwogIGZyZWU6CiAgICAgeGZy
ZWUoYnVmZmVyKTsKICAgICByZXR1cm4gcmV0OwotLSAKMS44LjMuMQoKCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QK
WGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5v
cmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

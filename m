Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 426705AEE7F
	for <lists+xen-devel@lfdr.de>; Tue,  6 Sep 2022 17:19:33 +0200 (CEST)
Received: from list by lists.xenproject.org with outflank-mailman.399941.641371 (Exim 4.92)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1oVaLu-0003QO-67; Tue, 06 Sep 2022 15:19:02 +0000
X-Outflank-Mailman: Message body and most headers restored to incoming version
Received: by outflank-mailman (output) from mailman id 399941.641371; Tue, 06 Sep 2022 15:19:02 +0000
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.92)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1oVaLu-0003Nv-1L; Tue, 06 Sep 2022 15:19:02 +0000
Received: by outflank-mailman (input) for mailman id 399941;
 Tue, 06 Sep 2022 15:19:00 +0000
Received: from se1-gles-sth1-in.inumbo.com ([159.253.27.254]
 helo=se1-gles-sth1.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.92)
 (envelope-from <SRS0=2M6J=ZJ=kernel.org=maz@srs-se1.protection.inumbo.net>)
 id 1oVaLs-0003KR-Mq
 for xen-devel@lists.xenproject.org; Tue, 06 Sep 2022 15:19:00 +0000
Received: from ams.source.kernel.org (ams.source.kernel.org
 [2604:1380:4601:e00::1])
 by se1-gles-sth1.inumbo.com (Halon) with ESMTPS
 id 3b307981-2df7-11ed-a016-b9edf5238543;
 Tue, 06 Sep 2022 17:18:59 +0200 (CEST)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
 (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
 (No client certificate requested)
 by ams.source.kernel.org (Postfix) with ESMTPS id 8E679B81604;
 Tue,  6 Sep 2022 15:18:58 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 4EAF2C433D6;
 Tue,  6 Sep 2022 15:18:57 +0000 (UTC)
Received: from sofa.misterjones.org ([185.219.108.64] helo=why.misterjones.org)
 by disco-boy.misterjones.org with esmtpsa (TLS1.3) tls
 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (Exim 4.95)
 (envelope-from <maz@kernel.org>) id 1oVaLn-008Nzo-1U;
 Tue, 06 Sep 2022 16:18:55 +0100
X-BeenThere: xen-devel@lists.xenproject.org
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Errors-To: xen-devel-bounces@lists.xenproject.org
Precedence: list
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>
X-Inumbo-ID: 3b307981-2df7-11ed-a016-b9edf5238543
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1662477537;
	bh=mNJaIZb91PSi9lvS5+CXgUk5XGql3Zf6HOlb64/gTRY=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=fqsPje10yjJEAchvtSZ2UACKrRYrs7jup+8WPZHs2QwB/7GDnYaESRZ/RfadGDLBC
	 V51G6xVy4eti1IMODx4iRnJOhx7JRyGK88plNCmtUZMfRz+9ZPsV2CKlW8qBPbyprS
	 AQ7zgmW38Dd4KfVMErUULP5or/ocKmQfBoS37sE6ppsjYA3GG8EwZlSXoLRMANT5Hp
	 Df16hL+EzG7fvTZCs0pwari7NRQELHaynNmVLqN5NMlNi9S7TCQUqzcgcA/eHS6ppB
	 LoJnQNbSq4XsFrQHPit21rWdDhh5Gy/FWLEVhg1Yy6l6BYBCiSHifXBVpOMitxU3yT
	 RRcgrL5MlNDuQ==
Date: Tue, 06 Sep 2022 16:18:54 +0100
Message-ID: <87mtbcv8dd.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Leo Yan <leo.yan@linaro.org>
Cc: Julien Grall <julien@xen.org>,
	Ard Biesheuvel <ardb@kernel.org>,
	Jan Beulich <jbeulich@suse.com>,
	Bertrand Marquis <Bertrand.Marquis@arm.com>,
	Rahul Singh <Rahul.Singh@arm.com>,
	Peter Griffin <peter.griffin@linaro.org>,
	xen-devel <xen-devel@lists.xenproject.org>,
	Julien Grall <jgrall@amazon.com>,
	Mathieu Poirier <mathieu.poirier@linaro.org>
Subject: Re: [PATCH] xen/arm: acpi: Support memory reserve configuration table
In-Reply-To: <YxdjlddwusPJ4GTU@leoy-huanghe.lan>
References: <871qtcsacd.wl-maz@kernel.org>
	<Ywcr1849LiEHezd3@leoy-huanghe>
	<12a8c169-55aa-5e9f-19f8-acd77ea2a8fe@xen.org>
	<YwdiDr2uLXGEl2TC@leoy-huanghe>
	<52f24132-ba2b-d4ab-ebd0-613f673b5658@xen.org>
	<YweJ6ZpRhMkT5bab@leoy-yangtze.lan>
	<CALZQ+UN8cQ4avggxqgjed=DsitfEteQpuhEqb+p747vmeFCyUA@mail.gmail.com>
	<87r10puiey.wl-maz@kernel.org>
	<Yxbz+pOs5+1RkEkx@leoy-huanghe.lan>
	<87leqxq6qp.wl-maz@kernel.org>
	<YxdjlddwusPJ4GTU@leoy-huanghe.lan>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: leo.yan@linaro.org, julien@xen.org, ardb@kernel.org, jbeulich@suse.com, Bertrand.Marquis@arm.com, Rahul.Singh@arm.com, peter.griffin@linaro.org, xen-devel@lists.xenproject.org, jgrall@amazon.com, mathieu.poirier@linaro.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Tue, 06 Sep 2022 16:13:25 +0100,
Leo Yan <leo.yan@linaro.org> wrote:
> 
> On Tue, Sep 06, 2022 at 08:53:02AM +0100, Marc Zyngier wrote:
> 
> [...]
> 
> > > Okay, I think have two questions for you:
> > > 
> > > - The first question is if we really need to reserve persistent memory
> > >   for RD pending table and configuration table when Linux kernel runs
> > >   in Xen domain?
> > 
> > I have no idea, and really I don't want to know. The architecture
> > doesn't make it safe to reuse that memory, and the driver does the
> > right thing by always reserving that memory when the FW is supposed to
> > support it.
> > 
> > The "oh but it is safe on so and so" approach doesn't scale. If you
> > want to have such a thing, just convince people at ARM that it is
> > possible to implement a GICv3-compliant system without the RD tables,
> > get them to update the architecture to allow this scheme and advertise
> > it in a discoverable register. Xen could then implement it, Linux
> > could check this bit, and we'd all be a happy family.
> 
> I agree that my patch is not based on a scale approach, this is also
> my concern.
> 
> To be honest, convincing Arm GIC team is a bit out of my working scope.
> I am working on automative project, when I saw verbose log with bunch of
> kernel warnings with Xen, it motivated me to chase down, this is the
> main reason I tried to explore some solutions at here.

And it is fine to explore things. But I don't think there is a cheap
option here.

[...]

> > - When the kexec kernel boots, all of the memory except for the
> >   reserved memory is reused. If your RD tables are used for anything,
> >   you'll see memory corruption as the GIC writes pending bits in the
> >   pending table, and you'll be unable to configure interrupts
> >   correctly.
> 
> This gives me impression that when do a power cycle, CPUs are reset
> but GIC is still alive, so for every booting time the same memory
> region should be reserved for RD tables.
>
> To be honest, it's a bit weird for me that if a system cannot reset
> CPUs and GIC together.

There is no reset involved across kexec. That's the whole point.
Nothing is reset, nothing is powered off. This is why kexec is so
fast, and this is why it is so fragile.

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.


Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 7A15BC4883
	for <lists+xen-devel@lfdr.de>; Wed,  2 Oct 2019 09:30:43 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iFZ3B-0001F4-VR; Wed, 02 Oct 2019 07:27:53 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=lglc=X3=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iFZ39-0001Ek-Mf
 for xen-devel@lists.xenproject.org; Wed, 02 Oct 2019 07:27:51 +0000
X-Inumbo-ID: 22ddf1ac-e4e6-11e9-9710-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 22ddf1ac-e4e6-11e9-9710-12813bfff9fa;
 Wed, 02 Oct 2019 07:27:49 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 9B2FBAF41;
 Wed,  2 Oct 2019 07:27:48 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Wed,  2 Oct 2019 09:27:26 +0200
Message-Id: <20191002072745.24919-2-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20191002072745.24919-1-jgross@suse.com>
References: <20191002072745.24919-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v6 01/20] xen/sched: add code to sync scheduling
 of all vcpus of a sched unit
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Julien Grall <julien@xen.org>,
 Wei Liu <wl@xen.org>, Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Jan Beulich <jbeulich@suse.com>, Dario Faggioli <dfaggioli@suse.com>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiBzd2l0Y2hpbmcgc2NoZWQgdW5pdHMgc3luY2hyb25pemUgYWxsIHZjcHVzIG9mIHRoZSBu
ZXcgdW5pdCB0byBiZQpzY2hlZHVsZWQgYXQgdGhlIHNhbWUgdGltZS4KCkEgdmFyaWFibGUgc2No
ZWRfZ3JhbnVsYXJpdHkgaXMgYWRkZWQgd2hpY2ggaG9sZHMgdGhlIG51bWJlciBvZiB2Y3B1cwpw
ZXIgc2NoZWR1bGUgdW5pdC4KCkFzIHRhc2tsZXRzIHJlcXVpcmUgdG8gc2NoZWR1bGUgdGhlIGlk
bGUgdW5pdCBpdCBpcyByZXF1aXJlZCB0byBzZXQgdGhlCnRhc2tsZXRfd29ya19zY2hlZHVsZWQg
cGFyYW1ldGVyIG9mIGRvX3NjaGVkdWxlKCkgdG8gdHJ1ZSBpZiBhbnkgY3B1CmNvdmVyZWQgYnkg
dGhlIGN1cnJlbnQgc2NoZWR1bGUoKSBjYWxsIGhhcyBhbnkgcGVuZGluZyB0YXNrbGV0IHdvcmsu
CgpGb3Igam9pbmluZyBvdGhlciB2Y3B1cyBvZiB0aGUgc2NoZWR1bGUgdW5pdCB3ZSBuZWVkIHRv
IGFkZCBhIG5ldwpzb2Z0aXJxIFNDSEVEX1NMQVZFX1NPRlRJUlEgaW4gb3JkZXIgdG8gaGF2ZSBh
IHdheSB0byBpbml0aWF0ZSBhCmNvbnRleHQgc3dpdGNoIHdpdGhvdXQgY2FsbGluZyB0aGUgZ2Vu
ZXJpYyBzY2hlZHVsZSgpIGZ1bmN0aW9uCnNlbGVjdGluZyB0aGUgdmNwdSB0byBzd2l0Y2ggdG8s
IGFzIHdlIGFscmVhZHkga25vdyB3aGljaCB2Y3B1IHdlCndhbnQgdG8gcnVuLiBUaGlzIGhhcyB0
aGUgb3RoZXIgYWR2YW50YWdlIG5vdCB0byBsb29zZSBhbnkgb3RoZXIKY29uY3VycmVudCBTQ0hF
RFVMRV9TT0ZUSVJRIGV2ZW50cy4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9z
c0BzdXNlLmNvbT4KUmV2aWV3ZWQtYnk6IERhcmlvIEZhZ2dpb2xpIDxkZmFnZ2lvbGlAc3VzZS5j
b20+CkFja2VkLWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+Ci0tLQpSRkMgVjI6
Ci0gbW92ZSBzeW5jaW5nIGFmdGVyIGNvbnRleHRfc3dpdGNoKCkgdG8gc2NoZWR1bGUuYwpWMjoK
LSBkb24ndCBydW4gdGFza2xldHMgZGlyZWN0bHkgZnJvbSBzY2hlZF93YWl0X3JlbmRlenZvdXNf
aW4oKQpWMzoKLSBhZGFwdCBhcnJheSBzaXplIGluIHNjaGVkX21vdmVfZG9tYWluKCkgKEphbiBC
ZXVsaWNoKQotIGludCAtPiB1bnNpZ25lZCBpbnQgKEphbiBCZXVsaWNoKQpWNDoKLSByZW5hbWVk
IHNkIHRvIHNyIGluIHNldmVyYWwgcGxhY2VzIChKYW4gQmV1bGljaCkKLSBzd2FwIHN0b3BfdGlt
ZXIoKSBhbmQgTk9XKCkgY2FsbHMgKEphbiBCZXVsaWNoKQotIGNvbnRleHRfc3dpdGNoKCkgb24g
QVJNIHJldHVybnMgLSBoYW5kbGUgdGhhdCAoSmFuIEJldWxpY2gpCi0tLQogeGVuL2FyY2gvYXJt
L2RvbWFpbi5jICAgICAgfCAgIDIgKy0KIHhlbi9hcmNoL3g4Ni9kb21haW4uYyAgICAgIHwgICAz
ICstCiB4ZW4vY29tbW9uL3NjaGVkdWxlLmMgICAgICB8IDM1MyArKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKy0tLS0tLS0tLS0KIHhlbi9jb21tb24vc29mdGlycS5jICAgICAgIHwg
ICA2ICstCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaCB8ICAgMSArCiB4ZW4vaW5jbHVkZS94
ZW4vc2NoZWQuaCAgICB8ICAxNiArLQogeGVuL2luY2x1ZGUveGVuL3NvZnRpcnEuaCAgfCAgIDEg
KwogNyBmaWxlcyBjaGFuZ2VkLCAyOTQgaW5zZXJ0aW9ucygrKSwgODggZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEveGVuL2FyY2gvYXJtL2RvbWFpbi5jIGIveGVuL2FyY2gvYXJtL2RvbWFpbi5j
CmluZGV4IGYwZWU1YTIxNDAuLjQ2MGU5NjhlOTcgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL2FybS9k
b21haW4uYworKysgYi94ZW4vYXJjaC9hcm0vZG9tYWluLmMKQEAgLTMxOCw3ICszMTgsNyBAQCBz
dGF0aWMgdm9pZCBzY2hlZHVsZV90YWlsKHN0cnVjdCB2Y3B1ICpwcmV2KQogCiAgICAgbG9jYWxf
aXJxX2VuYWJsZSgpOwogCi0gICAgY29udGV4dF9zYXZlZChwcmV2KTsKKyAgICBzY2hlZF9jb250
ZXh0X3N3aXRjaGVkKHByZXYsIGN1cnJlbnQpOwogCiAgICAgdXBkYXRlX3J1bnN0YXRlX2FyZWEo
Y3VycmVudCk7CiAKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9kb21haW4uYyBiL3hlbi9hcmNo
L3g4Ni9kb21haW4uYwppbmRleCBjN2ZhMjI0Yzg5Li4yN2Y5OWQzYmNjIDEwMDY0NAotLS0gYS94
ZW4vYXJjaC94ODYvZG9tYWluLmMKKysrIGIveGVuL2FyY2gveDg2L2RvbWFpbi5jCkBAIC0xNzg0
LDcgKzE3ODQsNiBAQCBzdGF0aWMgdm9pZCBfX2NvbnRleHRfc3dpdGNoKHZvaWQpCiAgICAgcGVy
X2NwdShjdXJyX3ZjcHUsIGNwdSkgPSBuOwogfQogCi0KIHZvaWQgY29udGV4dF9zd2l0Y2goc3Ry
dWN0IHZjcHUgKnByZXYsIHN0cnVjdCB2Y3B1ICpuZXh0KQogewogICAgIHVuc2lnbmVkIGludCBj
cHUgPSBzbXBfcHJvY2Vzc29yX2lkKCk7CkBAIC0xODYwLDcgKzE4NTksNyBAQCB2b2lkIGNvbnRl
eHRfc3dpdGNoKHN0cnVjdCB2Y3B1ICpwcmV2LCBzdHJ1Y3QgdmNwdSAqbmV4dCkKICAgICAgICAg
fQogICAgIH0KIAotICAgIGNvbnRleHRfc2F2ZWQocHJldik7CisgICAgc2NoZWRfY29udGV4dF9z
d2l0Y2hlZChwcmV2LCBuZXh0KTsKIAogICAgIF91cGRhdGVfcnVuc3RhdGVfYXJlYShuZXh0KTsK
ICAgICAvKiBNdXN0IGJlIGRvbmUgd2l0aCBpbnRlcnJ1cHRzIGVuYWJsZWQgKi8KZGlmZiAtLWdp
dCBhL3hlbi9jb21tb24vc2NoZWR1bGUuYyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwppbmRleCA0
NzExZWNlMWVmLi5mZjY3ZmIzNjMzIDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMK
KysrIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCkBAIC02MSw2ICs2MSw5IEBAIGJvb2xlYW5fcGFy
YW0oInNjaGVkX3NtdF9wb3dlcl9zYXZpbmdzIiwgc2NoZWRfc210X3Bvd2VyX3NhdmluZ3MpOwog
aW50IHNjaGVkX3JhdGVsaW1pdF91cyA9IFNDSEVEX0RFRkFVTFRfUkFURUxJTUlUX1VTOwogaW50
ZWdlcl9wYXJhbSgic2NoZWRfcmF0ZWxpbWl0X3VzIiwgc2NoZWRfcmF0ZWxpbWl0X3VzKTsKIAor
LyogTnVtYmVyIG9mIHZjcHVzIHBlciBzdHJ1Y3Qgc2NoZWRfdW5pdC4gKi8KK3N0YXRpYyB1bnNp
Z25lZCBpbnQgX19yZWFkX21vc3RseSBzY2hlZF9ncmFudWxhcml0eSA9IDE7CisKIC8qIENvbW1v
biBsb2NrIGZvciBmcmVlIGNwdXMuICovCiBzdGF0aWMgREVGSU5FX1NQSU5MT0NLKHNjaGVkX2Zy
ZWVfY3B1X2xvY2spOwogCkBAIC01MzIsOCArNTM1LDggQEAgaW50IHNjaGVkX21vdmVfZG9tYWlu
KHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpjKQogICAgIGlmICggSVNfRVJSKGRv
bWRhdGEpICkKICAgICAgICAgcmV0dXJuIFBUUl9FUlIoZG9tZGF0YSk7CiAKLSAgICAvKiBUT0RP
OiBmaXggYXJyYXkgc2l6ZSB3aXRoIG11bHRpcGxlIHZjcHVzIHBlciB1bml0LiAqLwotICAgIHVu
aXRfcHJpdiA9IHh6YWxsb2NfYXJyYXkodm9pZCAqLCBkLT5tYXhfdmNwdXMpOworICAgIHVuaXRf
cHJpdiA9IHh6YWxsb2NfYXJyYXkodm9pZCAqLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgRElWX1JPVU5EX1VQKGQtPm1heF92Y3B1cywgc2NoZWRfZ3JhbnVsYXJpdHkpKTsKICAgICBp
ZiAoIHVuaXRfcHJpdiA9PSBOVUxMICkKICAgICB7CiAgICAgICAgIHNjaGVkX2ZyZWVfZG9tZGF0
YShjLT5zY2hlZCwgZG9tZGF0YSk7CkBAIC0xNzE0LDEzMyArMTcxNywzMjUgQEAgdm9pZCB2Y3B1
X3NldF9wZXJpb2RpY190aW1lcihzdHJ1Y3QgdmNwdSAqdiwgc190aW1lX3QgdmFsdWUpCiAgICAg
c3Bpbl91bmxvY2soJnYtPnBlcmlvZGljX3RpbWVyX2xvY2spOwogfQogCi0vKgotICogVGhlIG1h
aW4gZnVuY3Rpb24KLSAqIC0gZGVzY2hlZHVsZSB0aGUgY3VycmVudCBkb21haW4gKHNjaGVkdWxl
ciBpbmRlcGVuZGVudCkuCi0gKiAtIHBpY2sgYSBuZXcgZG9tYWluIChzY2hlZHVsZXIgZGVwZW5k
ZW50KS4KLSAqLwotc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKK3N0YXRpYyB2b2lkIHNjaGVk
X3N3aXRjaF91bml0cyhzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICpuZXh0LCBzdHJ1Y3Qgc2NoZWRfdW5p
dCAqcHJldiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzX3RpbWVfdCBub3cpCiB7
Ci0gICAgc3RydWN0IHNjaGVkX3VuaXQgICAgKnByZXYgPSBjdXJyZW50LT5zY2hlZF91bml0LCAq
bmV4dCA9IE5VTEw7Ci0gICAgc190aW1lX3QgICAgICAgICAgICAgIG5vdzsKLSAgICBzdHJ1Y3Qg
c2NoZWR1bGVyICAgICAqc2NoZWQ7Ci0gICAgdW5zaWduZWQgbG9uZyAgICAgICAgKnRhc2tsZXRf
d29yayA9ICZ0aGlzX2NwdSh0YXNrbGV0X3dvcmtfdG9fZG8pOwotICAgIGJvb2wgICAgICAgICAg
ICAgICAgICB0YXNrbGV0X3dvcmtfc2NoZWR1bGVkID0gZmFsc2U7Ci0gICAgc3RydWN0IHNjaGVk
X3Jlc291cmNlICpzZDsKLSAgICBzcGlubG9ja190ICAgICAgICAgICAqbG9jazsKLSAgICBpbnQg
Y3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOworICAgIHNyLT5jdXJyID0gbmV4dDsKIAotICAgIEFT
U0VSVF9OT1RfSU5fQVRPTUlDKCk7CisgICAgVFJBQ0VfM0QoVFJDX1NDSEVEX1NXSVRDSF9JTkZQ
UkVWLCBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKKyAgICAgICAgICAg
ICBub3cgLSBwcmV2LT5zdGF0ZV9lbnRyeV90aW1lKTsKKyAgICBUUkFDRV80RChUUkNfU0NIRURf
U1dJVENIX0lORk5FWFQsIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0LT51bml0X2lkLAor
ICAgICAgICAgICAgIChuZXh0LT52Y3B1X2xpc3QtPnJ1bnN0YXRlLnN0YXRlID09IFJVTlNUQVRF
X3J1bm5hYmxlKSA/CisgICAgICAgICAgICAgKG5vdyAtIG5leHQtPnN0YXRlX2VudHJ5X3RpbWUp
IDogMCwgcHJldi0+bmV4dF90aW1lKTsKIAotICAgIFNDSEVEX1NUQVRfQ1JBTksoc2NoZWRfcnVu
KTsKKyAgICBBU1NFUlQocHJldi0+dmNwdV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFU
RV9ydW5uaW5nKTsKKworICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0gsIHByZXYtPmRvbWFp
bi0+ZG9tYWluX2lkLCBwcmV2LT51bml0X2lkLAorICAgICAgICAgICAgIG5leHQtPmRvbWFpbi0+
ZG9tYWluX2lkLCBuZXh0LT51bml0X2lkKTsKKworICAgIHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hh
bmdlKHByZXYsIGZhbHNlLCBub3cpOworCisgICAgQVNTRVJUKG5leHQtPnZjcHVfbGlzdC0+cnVu
c3RhdGUuc3RhdGUgIT0gUlVOU1RBVEVfcnVubmluZyk7CisgICAgc2NoZWRfdW5pdF9ydW5zdGF0
ZV9jaGFuZ2UobmV4dCwgdHJ1ZSwgbm93KTsKIAotICAgIHNkID0gZ2V0X3NjaGVkX3JlcyhjcHUp
OworICAgIC8qCisgICAgICogTkIuIERvbid0IGFkZCBhbnkgdHJhY2UgcmVjb3JkcyBmcm9tIGhl
cmUgdW50aWwgdGhlIGFjdHVhbCBjb250ZXh0CisgICAgICogc3dpdGNoLCBlbHNlIGxvc3RfcmVj
b3JkcyByZXN1bWUgd2lsbCBub3Qgd29yayBwcm9wZXJseS4KKyAgICAgKi8KKworICAgIEFTU0VS
VCghbmV4dC0+aXNfcnVubmluZyk7CisgICAgbmV4dC0+dmNwdV9saXN0LT5pc19ydW5uaW5nID0g
MTsKKyAgICBuZXh0LT5pc19ydW5uaW5nID0gdHJ1ZTsKKyAgICBuZXh0LT5zdGF0ZV9lbnRyeV90
aW1lID0gbm93OworfQorCitzdGF0aWMgYm9vbCBzY2hlZF90YXNrbGV0X2NoZWNrX2NwdSh1bnNp
Z25lZCBpbnQgY3B1KQoreworICAgIHVuc2lnbmVkIGxvbmcgKnRhc2tsZXRfd29yayA9ICZwZXJf
Y3B1KHRhc2tsZXRfd29ya190b19kbywgY3B1KTsKIAotICAgIC8qIFVwZGF0ZSB0YXNrbGV0IHNj
aGVkdWxpbmcgc3RhdHVzLiAqLwogICAgIHN3aXRjaCAoICp0YXNrbGV0X3dvcmsgKQogICAgIHsK
ICAgICBjYXNlIFRBU0tMRVRfZW5xdWV1ZWQ6CiAgICAgICAgIHNldF9iaXQoX1RBU0tMRVRfc2No
ZWR1bGVkLCB0YXNrbGV0X3dvcmspOwogICAgICAgICAvKiBmYWxsdGhyb3VnaCAqLwogICAgIGNh
c2UgVEFTS0xFVF9lbnF1ZXVlZHxUQVNLTEVUX3NjaGVkdWxlZDoKLSAgICAgICAgdGFza2xldF93
b3JrX3NjaGVkdWxlZCA9IHRydWU7CisgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICBicmVh
azsKICAgICBjYXNlIFRBU0tMRVRfc2NoZWR1bGVkOgogICAgICAgICBjbGVhcl9iaXQoX1RBU0tM
RVRfc2NoZWR1bGVkLCB0YXNrbGV0X3dvcmspOworICAgICAgICAvKiBmYWxsdGhyb3VnaCAqLwog
ICAgIGNhc2UgMDoKLSAgICAgICAgLyp0YXNrbGV0X3dvcmtfc2NoZWR1bGVkID0gZmFsc2U7Ki8K
KyAgICAgICAgLyogcmV0dXJuIGZhbHNlOyAqLwogICAgICAgICBicmVhazsKICAgICBkZWZhdWx0
OgogICAgICAgICBCVUcoKTsKICAgICB9CiAKLSAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2Nr
X2lycShjcHUpOworICAgIHJldHVybiBmYWxzZTsKK30KIAotICAgIG5vdyA9IE5PVygpOworc3Rh
dGljIGJvb2wgc2NoZWRfdGFza2xldF9jaGVjayh1bnNpZ25lZCBpbnQgY3B1KQoreworICAgIGJv
b2wgdGFza2xldF93b3JrX3NjaGVkdWxlZCA9IGZhbHNlOworICAgIGNvbnN0IGNwdW1hc2tfdCAq
bWFzayA9IGdldF9zY2hlZF9yZXMoY3B1KS0+Y3B1czsKKyAgICB1bnNpZ25lZCBpbnQgY3B1X2l0
ZXI7CisKKyAgICBmb3JfZWFjaF9jcHUgKCBjcHVfaXRlciwgbWFzayApCisgICAgICAgIGlmICgg
c2NoZWRfdGFza2xldF9jaGVja19jcHUoY3B1X2l0ZXIpICkKKyAgICAgICAgICAgIHRhc2tsZXRf
d29ya19zY2hlZHVsZWQgPSB0cnVlOwogCi0gICAgc3RvcF90aW1lcigmc2QtPnNfdGltZXIpOwor
ICAgIHJldHVybiB0YXNrbGV0X3dvcmtfc2NoZWR1bGVkOworfQorCitzdGF0aWMgc3RydWN0IHNj
aGVkX3VuaXQgKmRvX3NjaGVkdWxlKHN0cnVjdCBzY2hlZF91bml0ICpwcmV2LCBzX3RpbWVfdCBu
b3csCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBj
cHUpCit7CisgICAgc3RydWN0IHNjaGVkdWxlciAqc2NoZWQgPSBwZXJfY3B1KHNjaGVkdWxlciwg
Y3B1KTsKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyID0gZ2V0X3NjaGVkX3JlcyhjcHUp
OworICAgIHN0cnVjdCBzY2hlZF91bml0ICpuZXh0OwogCiAgICAgLyogZ2V0IHBvbGljeS1zcGVj
aWZpYyBkZWNpc2lvbiBvbiBzY2hlZHVsaW5nLi4uICovCi0gICAgc2NoZWQgPSB0aGlzX2NwdShz
Y2hlZHVsZXIpOwotICAgIHNjaGVkLT5kb19zY2hlZHVsZShzY2hlZCwgcHJldiwgbm93LCB0YXNr
bGV0X3dvcmtfc2NoZWR1bGVkKTsKKyAgICBzY2hlZC0+ZG9fc2NoZWR1bGUoc2NoZWQsIHByZXYs
IG5vdywgc2NoZWRfdGFza2xldF9jaGVjayhjcHUpKTsKIAogICAgIG5leHQgPSBwcmV2LT5uZXh0
X3Rhc2s7CiAKLSAgICBzZC0+Y3VyciA9IG5leHQ7Ci0KICAgICBpZiAoIHByZXYtPm5leHRfdGlt
ZSA+PSAwICkgLyogLXZlIG1lYW5zIG5vIGxpbWl0ICovCi0gICAgICAgIHNldF90aW1lcigmc2Qt
PnNfdGltZXIsIG5vdyArIHByZXYtPm5leHRfdGltZSk7CisgICAgICAgIHNldF90aW1lcigmc3It
PnNfdGltZXIsIG5vdyArIHByZXYtPm5leHRfdGltZSk7CisKKyAgICBpZiAoIGxpa2VseShwcmV2
ICE9IG5leHQpICkKKyAgICAgICAgc2NoZWRfc3dpdGNoX3VuaXRzKHNyLCBuZXh0LCBwcmV2LCBu
b3cpOworCisgICAgcmV0dXJuIG5leHQ7Cit9CisKK3N0YXRpYyB2b2lkIGNvbnRleHRfc2F2ZWQo
c3RydWN0IHZjcHUgKnByZXYpCit7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSBwcmV2
LT5zY2hlZF91bml0OworCisgICAgLyogQ2xlYXIgcnVubmluZyBmbGFnIC9hZnRlci8gd3JpdGlu
ZyBjb250ZXh0IHRvIG1lbW9yeS4gKi8KKyAgICBzbXBfd21iKCk7CisKKyAgICBwcmV2LT5pc19y
dW5uaW5nID0gMDsKKyAgICB1bml0LT5pc19ydW5uaW5nID0gZmFsc2U7CisgICAgdW5pdC0+c3Rh
dGVfZW50cnlfdGltZSA9IE5PVygpOworCisgICAgLyogQ2hlY2sgZm9yIG1pZ3JhdGlvbiByZXF1
ZXN0IC9hZnRlci8gY2xlYXJpbmcgcnVubmluZyBmbGFnLiAqLworICAgIHNtcF9tYigpOworCisg
ICAgc2NoZWRfY29udGV4dF9zYXZlZCh2Y3B1X3NjaGVkdWxlcihwcmV2KSwgdW5pdCk7CiAKLSAg
ICBpZiAoIHVubGlrZWx5KHByZXYgPT0gbmV4dCkgKQorICAgIHNjaGVkX3VuaXRfbWlncmF0ZV9m
aW5pc2godW5pdCk7Cit9CisKKy8qCisgKiBSZW5kZXp2b3VzIG9uIGVuZCBvZiBjb250ZXh0IHN3
aXRjaC4KKyAqIEFzIG5vIGxvY2sgaXMgcHJvdGVjdGluZyB0aGlzIHJlbmRlenZvdXMgZnVuY3Rp
b24gd2UgbmVlZCB0byB1c2UgYXRvbWljCisgKiBhY2Nlc3MgZnVuY3Rpb25zIG9uIHRoZSBjb3Vu
dGVyLgorICogVGhlIGNvdW50ZXIgd2lsbCBiZSAwIGluIGNhc2Ugbm8gcmVuZGV6dm91cyBpcyBu
ZWVkZWQuIEZvciB0aGUgcmVuZGV6dm91cworICogY2FzZSBpdCBpcyBpbml0aWFsaXNlZCB0byB0
aGUgbnVtYmVyIG9mIGNwdXMgdG8gcmVuZGV6dm91cyBwbHVzIDEuIEVhY2gKKyAqIG1lbWJlciBl
bnRlcmluZyBkZWNyZW1lbnRzIHRoZSBjb3VudGVyLiBUaGUgbGFzdCBvbmUgd2lsbCBkZWNyZW1l
bnQgaXQgdG8KKyAqIDEgYW5kIHBlcmZvcm0gdGhlIGZpbmFsIG5lZWRlZCBhY3Rpb24gaW4gdGhh
dCBjYXNlIChjYWxsIG9mIGNvbnRleHRfc2F2ZWQoKQorICogaWYgdmNwdSB3YXMgc3dpdGNoZWQp
LCBhbmQgdGhlbiBzZXQgdGhlIGNvdW50ZXIgdG8gemVyby4gVGhlIG90aGVyIG1lbWJlcnMKKyAq
IHdpbGwgd2FpdCB1bnRpbCB0aGUgY291bnRlciBiZWNvbWVzIHplcm8gdW50aWwgdGhleSBwcm9j
ZWVkLgorICovCit2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNoZWQoc3RydWN0IHZjcHUgKnZwcmV2
LCBzdHJ1Y3QgdmNwdSAqdm5leHQpCit7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKm5leHQgPSB2
bmV4dC0+c2NoZWRfdW5pdDsKKworICAgIGlmICggYXRvbWljX3JlYWQoJm5leHQtPnJlbmRlenZv
dXNfb3V0X2NudCkgKQorICAgIHsKKyAgICAgICAgaW50IGNudCA9IGF0b21pY19kZWNfcmV0dXJu
KCZuZXh0LT5yZW5kZXp2b3VzX291dF9jbnQpOworCisgICAgICAgIC8qIENhbGwgY29udGV4dF9z
YXZlZCgpIGJlZm9yZSByZWxlYXNpbmcgb3RoZXIgd2FpdGVycy4gKi8KKyAgICAgICAgaWYgKCBj
bnQgPT0gMSApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggdnByZXYgIT0gdm5leHQgKQor
ICAgICAgICAgICAgICAgIGNvbnRleHRfc2F2ZWQodnByZXYpOworICAgICAgICAgICAgYXRvbWlj
X3NldCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250LCAwKTsKKyAgICAgICAgfQorICAgICAgICBl
bHNlCisgICAgICAgICAgICB3aGlsZSAoIGF0b21pY19yZWFkKCZuZXh0LT5yZW5kZXp2b3VzX291
dF9jbnQpICkKKyAgICAgICAgICAgICAgICBjcHVfcmVsYXgoKTsKKyAgICB9CisgICAgZWxzZSBp
ZiAoIHZwcmV2ICE9IHZuZXh0ICkKKyAgICAgICAgY29udGV4dF9zYXZlZCh2cHJldik7Cit9CisK
K3N0YXRpYyB2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNoKHN0cnVjdCB2Y3B1ICp2cHJldiwgc3Ry
dWN0IHZjcHUgKnZuZXh0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc190aW1l
X3Qgbm93KQoreworICAgIGlmICggdW5saWtlbHkodnByZXYgPT0gdm5leHQpICkKICAgICB7Ci0g
ICAgICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOwogICAgICAgICBUUkFD
RV80RChUUkNfU0NIRURfU1dJVENIX0lORkNPTlQsCi0gICAgICAgICAgICAgICAgIG5leHQtPmRv
bWFpbi0+ZG9tYWluX2lkLCBuZXh0LT51bml0X2lkLAotICAgICAgICAgICAgICAgICBub3cgLSBw
cmV2LT5zdGF0ZV9lbnRyeV90aW1lLAotICAgICAgICAgICAgICAgICBwcmV2LT5uZXh0X3RpbWUp
OwotICAgICAgICB0cmFjZV9jb250aW51ZV9ydW5uaW5nKG5leHQtPnZjcHVfbGlzdCk7Ci0gICAg
ICAgIHJldHVybiBjb250aW51ZV9ydW5uaW5nKHByZXYtPnZjcHVfbGlzdCk7CisgICAgICAgICAg
ICAgICAgIHZuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgdm5leHQtPnNjaGVkX3VuaXQtPnVuaXRf
aWQsCisgICAgICAgICAgICAgICAgIG5vdyAtIHZwcmV2LT5ydW5zdGF0ZS5zdGF0ZV9lbnRyeV90
aW1lLAorICAgICAgICAgICAgICAgICB2cHJldi0+c2NoZWRfdW5pdC0+bmV4dF90aW1lKTsKKyAg
ICAgICAgc2NoZWRfY29udGV4dF9zd2l0Y2hlZCh2cHJldiwgdm5leHQpOworICAgICAgICB0cmFj
ZV9jb250aW51ZV9ydW5uaW5nKHZuZXh0KTsKKyAgICAgICAgcmV0dXJuIGNvbnRpbnVlX3J1bm5p
bmcodnByZXYpOwogICAgIH0KIAotICAgIFRSQUNFXzNEKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GUFJF
ViwKLSAgICAgICAgICAgICBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwK
LSAgICAgICAgICAgICBub3cgLSBwcmV2LT5zdGF0ZV9lbnRyeV90aW1lKTsKLSAgICBUUkFDRV80
RChUUkNfU0NIRURfU1dJVENIX0lORk5FWFQsCi0gICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5k
b21haW5faWQsIG5leHQtPnVuaXRfaWQsCi0gICAgICAgICAgICAgKG5leHQtPnZjcHVfbGlzdC0+
cnVuc3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmFibGUpID8KLSAgICAgICAgICAgICAobm93
IC0gbmV4dC0+c3RhdGVfZW50cnlfdGltZSkgOiAwLAotICAgICAgICAgICAgIHByZXYtPm5leHRf
dGltZSk7CisgICAgU0NIRURfU1RBVF9DUkFOSyhzY2hlZF9jdHgpOwogCi0gICAgQVNTRVJUKHBy
ZXYtPnZjcHVfbGlzdC0+cnVuc3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmluZyk7CisgICAg
c3RvcF90aW1lcigmdnByZXYtPnBlcmlvZGljX3RpbWVyKTsKIAotICAgIFRSQUNFXzREKFRSQ19T
Q0hFRF9TV0lUQ0gsCi0gICAgICAgICAgICAgcHJldi0+ZG9tYWluLT5kb21haW5faWQsIHByZXYt
PnVuaXRfaWQsCi0gICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQtPnVu
aXRfaWQpOworICAgIGlmICggdm5leHQtPnNjaGVkX3VuaXQtPm1pZ3JhdGVkICkKKyAgICAgICAg
dmNwdV9tb3ZlX2lycXModm5leHQpOwogCi0gICAgc2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2Uo
cHJldiwgZmFsc2UsIG5vdyk7CisgICAgdmNwdV9wZXJpb2RpY190aW1lcl93b3JrKHZuZXh0KTsK
IAotICAgIEFTU0VSVChuZXh0LT52Y3B1X2xpc3QtPnJ1bnN0YXRlLnN0YXRlICE9IFJVTlNUQVRF
X3J1bm5pbmcpOwotICAgIHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hhbmdlKG5leHQsIHRydWUsIG5v
dyk7CisgICAgY29udGV4dF9zd2l0Y2godnByZXYsIHZuZXh0KTsKK30KIAotICAgIC8qCi0gICAg
ICogTkIuIERvbid0IGFkZCBhbnkgdHJhY2UgcmVjb3JkcyBmcm9tIGhlcmUgdW50aWwgdGhlIGFj
dHVhbCBjb250ZXh0Ci0gICAgICogc3dpdGNoLCBlbHNlIGxvc3RfcmVjb3JkcyByZXN1bWUgd2ls
bCBub3Qgd29yayBwcm9wZXJseS4KLSAgICAgKi8KKy8qCisgKiBSZW5kZXp2b3VzIGJlZm9yZSB0
YWtpbmcgYSBzY2hlZHVsaW5nIGRlY2lzaW9uLgorICogQ2FsbGVkIHdpdGggc2NoZWR1bGUgbG9j
ayBoZWxkLCBzbyBhbGwgYWNjZXNzZXMgdG8gdGhlIHJlbmRlenZvdXMgY291bnRlcgorICogY2Fu
IGJlIG5vcm1hbCBvbmVzIChubyBhdG9taWMgYWNjZXNzZXMgbmVlZGVkKS4KKyAqIFRoZSBjb3Vu
dGVyIGlzIGluaXRpYWxpemVkIHRvIHRoZSBudW1iZXIgb2YgY3B1cyB0byByZW5kZXp2b3VzIGlu
aXRpYWxseS4KKyAqIEVhY2ggY3B1IGVudGVyaW5nIHdpbGwgZGVjcmVtZW50IHRoZSBjb3VudGVy
LiBJbiBjYXNlIHRoZSBjb3VudGVyIGJlY29tZXMKKyAqIHplcm8gZG9fc2NoZWR1bGUoKSBpcyBj
YWxsZWQgYW5kIHRoZSByZW5kZXp2b3VzIGNvdW50ZXIgZm9yIGxlYXZpbmcKKyAqIGNvbnRleHRf
c3dpdGNoKCkgaXMgc2V0LiBBbGwgb3RoZXIgbWVtYmVycyB3aWxsIHdhaXQgdW50aWwgdGhlIGNv
dW50ZXIgaXMKKyAqIGJlY29taW5nIHplcm8sIGRyb3BwaW5nIHRoZSBzY2hlZHVsZSBsb2NrIGlu
IGJldHdlZW4uCisgKi8KK3N0YXRpYyBzdHJ1Y3Qgc2NoZWRfdW5pdCAqc2NoZWRfd2FpdF9yZW5k
ZXp2b3VzX2luKHN0cnVjdCBzY2hlZF91bml0ICpwcmV2LAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BpbmxvY2tfdCAqKmxvY2ssIGludCBjcHUs
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzX3Rp
bWVfdCBub3cpCit7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKm5leHQ7CiAKLSAgICBBU1NFUlQo
IW5leHQtPmlzX3J1bm5pbmcpOwotICAgIG5leHQtPnZjcHVfbGlzdC0+aXNfcnVubmluZyA9IDE7
Ci0gICAgbmV4dC0+aXNfcnVubmluZyA9IHRydWU7Ci0gICAgbmV4dC0+c3RhdGVfZW50cnlfdGlt
ZSA9IG5vdzsKKyAgICBpZiAoICEtLXByZXYtPnJlbmRlenZvdXNfaW5fY250ICkKKyAgICB7Cisg
ICAgICAgIG5leHQgPSBkb19zY2hlZHVsZShwcmV2LCBub3csIGNwdSk7CisgICAgICAgIGF0b21p
Y19zZXQoJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCwgc2NoZWRfZ3JhbnVsYXJpdHkgKyAxKTsK
KyAgICAgICAgcmV0dXJuIG5leHQ7CisgICAgfQogCi0gICAgcGNwdV9zY2hlZHVsZV91bmxvY2tf
aXJxKGxvY2ssIGNwdSk7CisgICAgd2hpbGUgKCBwcmV2LT5yZW5kZXp2b3VzX2luX2NudCApCisg
ICAgeworICAgICAgICAvKgorICAgICAgICAgKiBDb21pbmcgZnJvbSBpZGxlIG1pZ2h0IG5lZWQg
dG8gZG8gdGFza2xldCB3b3JrLgorICAgICAgICAgKiBJbiBvcmRlciB0byBhdm9pZCBkZWFkbG9j
a3Mgd2UgY2FuJ3QgZG8gdGhhdCBoZXJlLCBidXQgaGF2ZSB0bworICAgICAgICAgKiBjb250aW51
ZSB0aGUgaWRsZSBsb29wLgorICAgICAgICAgKiBVbmRvIHRoZSByZW5kZXp2b3VzX2luX2NudCBk
ZWNyZW1lbnQgYW5kIHNjaGVkdWxlIGFub3RoZXIgY2FsbCBvZgorICAgICAgICAgKiBzY2hlZF9z
bGF2ZSgpLgorICAgICAgICAgKi8KKyAgICAgICAgaWYgKCBpc19pZGxlX3VuaXQocHJldikgJiYg
c2NoZWRfdGFza2xldF9jaGVja19jcHUoY3B1KSApCisgICAgICAgIHsKKyAgICAgICAgICAgIHN0
cnVjdCB2Y3B1ICp2cHJldiA9IGN1cnJlbnQ7CiAKLSAgICBTQ0hFRF9TVEFUX0NSQU5LKHNjaGVk
X2N0eCk7CisgICAgICAgICAgICBwcmV2LT5yZW5kZXp2b3VzX2luX2NudCsrOworICAgICAgICAg
ICAgYXRvbWljX3NldCgmcHJldi0+cmVuZGV6dm91c19vdXRfY250LCAwKTsKKworICAgICAgICAg
ICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKCpsb2NrLCBjcHUpOworCisgICAgICAgICAgICBy
YWlzZV9zb2Z0aXJxKFNDSEVEX1NMQVZFX1NPRlRJUlEpOworICAgICAgICAgICAgc2NoZWRfY29u
dGV4dF9zd2l0Y2godnByZXYsIHZwcmV2LCBub3cpOworCisgICAgICAgICAgICByZXR1cm4gTlVM
TDsgICAgICAgICAvKiBBUk0gb25seS4gKi8KKyAgICAgICAgfQogCi0gICAgc3RvcF90aW1lcigm
cHJldi0+dmNwdV9saXN0LT5wZXJpb2RpY190aW1lcik7CisgICAgICAgIHBjcHVfc2NoZWR1bGVf
dW5sb2NrX2lycSgqbG9jaywgY3B1KTsKIAotICAgIGlmICggbmV4dC0+bWlncmF0ZWQgKQotICAg
ICAgICB2Y3B1X21vdmVfaXJxcyhuZXh0LT52Y3B1X2xpc3QpOworICAgICAgICBjcHVfcmVsYXgo
KTsKIAotICAgIHZjcHVfcGVyaW9kaWNfdGltZXJfd29yayhuZXh0LT52Y3B1X2xpc3QpOworICAg
ICAgICAqbG9jayA9IHBjcHVfc2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKKyAgICB9CiAKLSAgICBj
b250ZXh0X3N3aXRjaChwcmV2LT52Y3B1X2xpc3QsIG5leHQtPnZjcHVfbGlzdCk7CisgICAgcmV0
dXJuIHByZXYtPm5leHRfdGFzazsKIH0KIAotdm9pZCBjb250ZXh0X3NhdmVkKHN0cnVjdCB2Y3B1
ICpwcmV2KQorc3RhdGljIHZvaWQgc2NoZWRfc2xhdmUodm9pZCkKIHsKLSAgICAvKiBDbGVhciBy
dW5uaW5nIGZsYWcgL2FmdGVyLyB3cml0aW5nIGNvbnRleHQgdG8gbWVtb3J5LiAqLwotICAgIHNt
cF93bWIoKTsKKyAgICBzdHJ1Y3QgdmNwdSAgICAgICAgICAqdnByZXYgPSBjdXJyZW50OworICAg
IHN0cnVjdCBzY2hlZF91bml0ICAgICpwcmV2ID0gdnByZXYtPnNjaGVkX3VuaXQsICpuZXh0Owor
ICAgIHNfdGltZV90ICAgICAgICAgICAgICBub3c7CisgICAgc3BpbmxvY2tfdCAgICAgICAgICAg
KmxvY2s7CisgICAgdW5zaWduZWQgaW50ICAgICAgICAgIGNwdSA9IHNtcF9wcm9jZXNzb3JfaWQo
KTsKIAotICAgIHByZXYtPmlzX3J1bm5pbmcgPSAwOwotICAgIHByZXYtPnNjaGVkX3VuaXQtPmlz
X3J1bm5pbmcgPSBmYWxzZTsKLSAgICBwcmV2LT5zY2hlZF91bml0LT5zdGF0ZV9lbnRyeV90aW1l
ID0gTk9XKCk7CisgICAgQVNTRVJUX05PVF9JTl9BVE9NSUMoKTsKIAotICAgIC8qIENoZWNrIGZv
ciBtaWdyYXRpb24gcmVxdWVzdCAvYWZ0ZXIvIGNsZWFyaW5nIHJ1bm5pbmcgZmxhZy4gKi8KLSAg
ICBzbXBfbWIoKTsKKyAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycShjcHUpOwogCi0g
ICAgc2NoZWRfY29udGV4dF9zYXZlZCh2Y3B1X3NjaGVkdWxlcihwcmV2KSwgcHJldi0+c2NoZWRf
dW5pdCk7CisgICAgbm93ID0gTk9XKCk7CisKKyAgICBpZiAoICFwcmV2LT5yZW5kZXp2b3VzX2lu
X2NudCApCisgICAgeworICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1
KTsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAgIHN0b3BfdGltZXIoJmdldF9zY2hlZF9y
ZXMoY3B1KS0+c190aW1lcik7CisKKyAgICBuZXh0ID0gc2NoZWRfd2FpdF9yZW5kZXp2b3VzX2lu
KHByZXYsICZsb2NrLCBjcHUsIG5vdyk7CisgICAgaWYgKCAhbmV4dCApCisgICAgICAgIHJldHVy
bjsKKworICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOwogCi0gICAgc2No
ZWRfdW5pdF9taWdyYXRlX2ZpbmlzaChwcmV2LT5zY2hlZF91bml0KTsKKyAgICBzY2hlZF9jb250
ZXh0X3N3aXRjaCh2cHJldiwgbmV4dC0+dmNwdV9saXN0LCBub3cpOworfQorCisvKgorICogVGhl
IG1haW4gZnVuY3Rpb24KKyAqIC0gZGVzY2hlZHVsZSB0aGUgY3VycmVudCBkb21haW4gKHNjaGVk
dWxlciBpbmRlcGVuZGVudCkuCisgKiAtIHBpY2sgYSBuZXcgZG9tYWluIChzY2hlZHVsZXIgZGVw
ZW5kZW50KS4KKyAqLworc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKK3sKKyAgICBzdHJ1Y3Qg
dmNwdSAgICAgICAgICAqdm5leHQsICp2cHJldiA9IGN1cnJlbnQ7CisgICAgc3RydWN0IHNjaGVk
X3VuaXQgICAgKnByZXYgPSB2cHJldi0+c2NoZWRfdW5pdCwgKm5leHQgPSBOVUxMOworICAgIHNf
dGltZV90ICAgICAgICAgICAgICBub3c7CisgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzcjsK
KyAgICBzcGlubG9ja190ICAgICAgICAgICAqbG9jazsKKyAgICBpbnQgY3B1ID0gc21wX3Byb2Nl
c3Nvcl9pZCgpOworCisgICAgQVNTRVJUX05PVF9JTl9BVE9NSUMoKTsKKworICAgIFNDSEVEX1NU
QVRfQ1JBTksoc2NoZWRfcnVuKTsKKworICAgIHNyID0gZ2V0X3NjaGVkX3JlcyhjcHUpOworCisg
ICAgbG9jayA9IHBjcHVfc2NoZWR1bGVfbG9ja19pcnEoY3B1KTsKKworICAgIGlmICggcHJldi0+
cmVuZGV6dm91c19pbl9jbnQgKQorICAgIHsKKyAgICAgICAgLyoKKyAgICAgICAgICogV2UgaGF2
ZSBhIHJhY2U6IHNjaGVkX3NsYXZlKCkgc2hvdWxkIGJlIGNhbGxlZCwgc28gcmFpc2UgYSBzb2Z0
aXJxCisgICAgICAgICAqIGluIG9yZGVyIHRvIHJlLWVudGVyIHNjaGVkdWxlKCkgbGF0ZXIgYW5k
IGNhbGwgc2NoZWRfc2xhdmUoKSBub3cuCisgICAgICAgICAqLworICAgICAgICBwY3B1X3NjaGVk
dWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKKworICAgICAgICByYWlzZV9zb2Z0aXJxKFNDSEVE
VUxFX1NPRlRJUlEpOworICAgICAgICByZXR1cm4gc2NoZWRfc2xhdmUoKTsKKyAgICB9CisKKyAg
ICBzdG9wX3RpbWVyKCZzci0+c190aW1lcik7CisKKyAgICBub3cgPSBOT1coKTsKKworICAgIGlm
ICggc2NoZWRfZ3JhbnVsYXJpdHkgPiAxICkKKyAgICB7CisgICAgICAgIGNwdW1hc2tfdCBtYXNr
OworCisgICAgICAgIHByZXYtPnJlbmRlenZvdXNfaW5fY250ID0gc2NoZWRfZ3JhbnVsYXJpdHk7
CisgICAgICAgIGNwdW1hc2tfYW5kbm90KCZtYXNrLCBzci0+Y3B1cywgY3B1bWFza19vZihjcHUp
KTsKKyAgICAgICAgY3B1bWFza19yYWlzZV9zb2Z0aXJxKCZtYXNrLCBTQ0hFRF9TTEFWRV9TT0ZU
SVJRKTsKKyAgICAgICAgbmV4dCA9IHNjaGVkX3dhaXRfcmVuZGV6dm91c19pbihwcmV2LCAmbG9j
aywgY3B1LCBub3cpOworICAgICAgICBpZiAoICFuZXh0ICkKKyAgICAgICAgICAgIHJldHVybjsK
KyAgICB9CisgICAgZWxzZQorICAgIHsKKyAgICAgICAgcHJldi0+cmVuZGV6dm91c19pbl9jbnQg
PSAwOworICAgICAgICBuZXh0ID0gZG9fc2NoZWR1bGUocHJldiwgbm93LCBjcHUpOworICAgICAg
ICBhdG9taWNfc2V0KCZuZXh0LT5yZW5kZXp2b3VzX291dF9jbnQsIDApOworICAgIH0KKworICAg
IHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOworCisgICAgdm5leHQgPSBuZXh0
LT52Y3B1X2xpc3Q7CisgICAgc2NoZWRfY29udGV4dF9zd2l0Y2godnByZXYsIHZuZXh0LCBub3cp
OwogfQogCiAvKiBUaGUgc2NoZWR1bGVyIHRpbWVyOiBmb3JjZSBhIHJ1biB0aHJvdWdoIHRoZSBz
Y2hlZHVsZXIgKi8KQEAgLTE4ODEsNiArMjA3Niw3IEBAIHN0YXRpYyBpbnQgY3B1X3NjaGVkdWxl
X3VwKHVuc2lnbmVkIGludCBjcHUpCiAgICAgaWYgKCBzciA9PSBOVUxMICkKICAgICAgICAgcmV0
dXJuIC1FTk9NRU07CiAgICAgc3ItPm1hc3Rlcl9jcHUgPSBjcHU7CisgICAgc3ItPmNwdXMgPSBj
cHVtYXNrX29mKGNwdSk7CiAgICAgc2V0X3NjaGVkX3JlcyhjcHUsIHNyKTsKIAogICAgIHBlcl9j
cHUoc2NoZWR1bGVyLCBjcHUpID0gJnNjaGVkX2lkbGVfb3BzOwpAQCAtMTkwMSw2ICsyMDk3LDgg
QEAgc3RhdGljIGludCBjcHVfc2NoZWR1bGVfdXAodW5zaWduZWQgaW50IGNwdSkKICAgICBpZiAo
IGlkbGVfdmNwdVtjcHVdID09IE5VTEwgKQogICAgICAgICByZXR1cm4gLUVOT01FTTsKIAorICAg
IGlkbGVfdmNwdVtjcHVdLT5zY2hlZF91bml0LT5yZW5kZXp2b3VzX2luX2NudCA9IDA7CisKICAg
ICAvKgogICAgICAqIE5vIG5lZWQgdG8gYWxsb2NhdGUgYW55IHNjaGVkdWxlciBkYXRhLCBhcyBj
cHVzIGNvbWluZyBvbmxpbmUgYXJlCiAgICAgICogZnJlZSBpbml0aWFsbHkgYW5kIHRoZSBpZGxl
IHNjaGVkdWxlciBkb2Vzbid0IG5lZWQgYW55IGRhdGEgYXJlYXMKQEAgLTIwMDEsNiArMjE5OSw3
IEBAIHZvaWQgX19pbml0IHNjaGVkdWxlcl9pbml0KHZvaWQpCiAgICAgaW50IGk7CiAKICAgICBv
cGVuX3NvZnRpcnEoU0NIRURVTEVfU09GVElSUSwgc2NoZWR1bGUpOworICAgIG9wZW5fc29mdGly
cShTQ0hFRF9TTEFWRV9TT0ZUSVJRLCBzY2hlZF9zbGF2ZSk7CiAKICAgICBmb3IgKCBpID0gMDsg
aSA8IE5VTV9TQ0hFRFVMRVJTOyBpKyspCiAgICAgewpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9z
b2Z0aXJxLmMgYi94ZW4vY29tbW9uL3NvZnRpcnEuYwppbmRleCA4M2MzYzA5YmQ1Li4yZDY2MTkz
MjAzIDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NvZnRpcnEuYworKysgYi94ZW4vY29tbW9uL3Nv
ZnRpcnEuYwpAQCAtMzMsOCArMzMsOCBAQCBzdGF0aWMgdm9pZCBfX2RvX3NvZnRpcnEodW5zaWdu
ZWQgbG9uZyBpZ25vcmVfbWFzaykKICAgICBmb3IgKCA7IDsgKQogICAgIHsKICAgICAgICAgLyoK
LSAgICAgICAgICogSW5pdGlhbGlzZSBAY3B1IG9uIGV2ZXJ5IGl0ZXJhdGlvbjogU0NIRURVTEVf
U09GVElSUSBtYXkgbW92ZQotICAgICAgICAgKiB1cyB0byBhbm90aGVyIHByb2Nlc3Nvci4KKyAg
ICAgICAgICogSW5pdGlhbGlzZSBAY3B1IG9uIGV2ZXJ5IGl0ZXJhdGlvbjogU0NIRURVTEVfU09G
VElSUSBvcgorICAgICAgICAgKiBTQ0hFRF9TTEFWRV9TT0ZUSVJRIG1heSBtb3ZlIHVzIHRvIGFu
b3RoZXIgcHJvY2Vzc29yLgogICAgICAgICAgKi8KICAgICAgICAgY3B1ID0gc21wX3Byb2Nlc3Nv
cl9pZCgpOwogCkBAIC01NSw3ICs1NSw3IEBAIHZvaWQgcHJvY2Vzc19wZW5kaW5nX3NvZnRpcnFz
KHZvaWQpCiB7CiAgICAgQVNTRVJUKCFpbl9pcnEoKSAmJiBsb2NhbF9pcnFfaXNfZW5hYmxlZCgp
KTsKICAgICAvKiBEbyBub3QgZW50ZXIgc2NoZWR1bGVyIGFzIGl0IGNhbiBwcmVlbXB0IHRoZSBj
YWxsaW5nIGNvbnRleHQuICovCi0gICAgX19kb19zb2Z0aXJxKDF1bDw8U0NIRURVTEVfU09GVElS
USk7CisgICAgX19kb19zb2Z0aXJxKCgxdWwgPDwgU0NIRURVTEVfU09GVElSUSkgfCAoMXVsIDw8
IFNDSEVEX1NMQVZFX1NPRlRJUlEpKTsKIH0KIAogdm9pZCBkb19zb2Z0aXJxKHZvaWQpCmRpZmYg
LS1naXQgYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaCBiL3hlbi9pbmNsdWRlL3hlbi9zY2hl
ZC1pZi5oCmluZGV4IDA0MjNiZTk4N2QuLmM2NWRmYTk0M2IgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNs
dWRlL3hlbi9zY2hlZC1pZi5oCisrKyBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCkBAIC00
Miw2ICs0Miw3IEBAIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSB7CiAKICAgICAvKiBDcHUgd2l0aCBs
b3dlc3QgaWQgaW4gc2NoZWR1bGluZyByZXNvdXJjZS4gKi8KICAgICB1bnNpZ25lZCBpbnQgICAg
ICAgIG1hc3Rlcl9jcHU7CisgICAgY29uc3QgY3B1bWFza190ICAgICpjcHVzOyAgICAgICAgICAg
LyogY3B1cyBjb3ZlcmVkIGJ5IHRoaXMgc3RydWN0ICAgICAqLwogfTsKIAogREVDTEFSRV9QRVJf
Q1BVKHN0cnVjdCBzY2hlZHVsZXIgKiwgc2NoZWR1bGVyKTsKZGlmZiAtLWdpdCBhL3hlbi9pbmNs
dWRlL3hlbi9zY2hlZC5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKaW5kZXggZWJmNzIzYTg2
Ni4uYzc3MGFiNGFhMCAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKKysrIGIv
eGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKQEAgLTI5Miw2ICsyOTIsMTIgQEAgc3RydWN0IHNjaGVk
X3VuaXQgewogICAgIC8qIE5leHQgdW5pdCB0byBydW4uICovCiAgICAgc3RydWN0IHNjaGVkX3Vu
aXQgICAgICAqbmV4dF90YXNrOwogICAgIHNfdGltZV90ICAgICAgICAgICAgICAgIG5leHRfdGlt
ZTsKKworICAgIC8qIE51bWJlciBvZiB2Y3B1cyBub3QgeWV0IGpvaW5lZCBmb3IgY29udGV4dCBz
d2l0Y2guICovCisgICAgdW5zaWduZWQgaW50ICAgICAgICAgICAgcmVuZGV6dm91c19pbl9jbnQ7
CisKKyAgICAvKiBOdW1iZXIgb2YgdmNwdXMgbm90IHlldCBmaW5pc2hlZCB3aXRoIGNvbnRleHQg
c3dpdGNoLiAqLworICAgIGF0b21pY190ICAgICAgICAgICAgICAgIHJlbmRlenZvdXNfb3V0X2Nu
dDsKIH07CiAKICNkZWZpbmUgZm9yX2VhY2hfc2NoZWRfdW5pdChkLCB1KSAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgXApAQCAtNjk2LDEwICs3MDIsMTAgQEAgdm9pZCBz
eW5jX2xvY2FsX2V4ZWNzdGF0ZSh2b2lkKTsKIAogLyoKICAqIENhbGxlZCBieSB0aGUgc2NoZWR1
bGVyIHRvIHN3aXRjaCB0byBhbm90aGVyIFZDUFUuIFRoaXMgZnVuY3Rpb24gbXVzdAotICogY2Fs
bCBjb250ZXh0X3NhdmVkKEBwcmV2KSB3aGVuIHRoZSBsb2NhbCBDUFUgaXMgbm8gbG9uZ2VyIHJ1
bm5pbmcgaW4KLSAqIEBwcmV2J3MgY29udGV4dCwgYW5kIHRoYXQgY29udGV4dCBpcyBzYXZlZCB0
byBtZW1vcnkuIEFsdGVybmF0aXZlbHksIGlmCi0gKiBpbXBsZW1lbnRpbmcgbGF6eSBjb250ZXh0
IHN3aXRjaGluZywgaXQgc3VmZmljZXMgdG8gZW5zdXJlIHRoYXQgaW52b2tpbmcKLSAqIHN5bmNf
dmNwdV9leGVjc3RhdGUoKSB3aWxsIHN3aXRjaCBhbmQgY29tbWl0IEBwcmV2J3Mgc3RhdGUuCisg
KiBjYWxsIHNjaGVkX2NvbnRleHRfc3dpdGNoZWQoQHByZXYsIEBuZXh0KSB3aGVuIHRoZSBsb2Nh
bCBDUFUgaXMgbm8gbG9uZ2VyCisgKiBydW5uaW5nIGluIEBwcmV2J3MgY29udGV4dCwgYW5kIHRo
YXQgY29udGV4dCBpcyBzYXZlZCB0byBtZW1vcnkuCisgKiBBbHRlcm5hdGl2ZWx5LCBpZiBpbXBs
ZW1lbnRpbmcgbGF6eSBjb250ZXh0IHN3aXRjaGluZywgaXQgc3VmZmljZXMgdG8gZW5zdXJlCisg
KiB0aGF0IGludm9raW5nIHN5bmNfdmNwdV9leGVjc3RhdGUoKSB3aWxsIHN3aXRjaCBhbmQgY29t
bWl0IEBwcmV2J3Mgc3RhdGUuCiAgKi8KIHZvaWQgY29udGV4dF9zd2l0Y2goCiAgICAgc3RydWN0
IHZjcHUgKnByZXYsCkBAIC03MTEsNyArNzE3LDcgQEAgdm9pZCBjb250ZXh0X3N3aXRjaCgKICAq
IHNhdmVkIHRvIG1lbW9yeS4gQWx0ZXJuYXRpdmVseSwgaWYgaW1wbGVtZW50aW5nIGxhenkgY29u
dGV4dCBzd2l0Y2hpbmcsCiAgKiBlbnN1cmUgdGhhdCBpbnZva2luZyBzeW5jX3ZjcHVfZXhlY3N0
YXRlKCkgd2lsbCBzd2l0Y2ggYW5kIGNvbW1pdCBAcHJldi4KICAqLwotdm9pZCBjb250ZXh0X3Nh
dmVkKHN0cnVjdCB2Y3B1ICpwcmV2KTsKK3ZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2hlZChzdHJ1
Y3QgdmNwdSAqcHJldiwgc3RydWN0IHZjcHUgKnZuZXh0KTsKIAogLyogQ2FsbGVkIGJ5IHRoZSBz
Y2hlZHVsZXIgdG8gY29udGludWUgcnVubmluZyB0aGUgY3VycmVudCBWQ1BVLiAqLwogdm9pZCBj
b250aW51ZV9ydW5uaW5nKApkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUveGVuL3NvZnRpcnEuaCBi
L3hlbi9pbmNsdWRlL3hlbi9zb2Z0aXJxLmgKaW5kZXggYzMyN2M5YjZjZC4uZDcyNzNiMzg5YiAx
MDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NvZnRpcnEuaAorKysgYi94ZW4vaW5jbHVkZS94
ZW4vc29mdGlycS5oCkBAIC00LDYgKzQsNyBAQAogLyogTG93LWxhdGVuY3kgc29mdGlycXMgY29t
ZSBmaXJzdCBpbiB0aGUgZm9sbG93aW5nIGxpc3QuICovCiBlbnVtIHsKICAgICBUSU1FUl9TT0ZU
SVJRID0gMCwKKyAgICBTQ0hFRF9TTEFWRV9TT0ZUSVJRLAogICAgIFNDSEVEVUxFX1NPRlRJUlEs
CiAgICAgTkVXX1RMQkZMVVNIX0NMT0NLX1BFUklPRF9TT0ZUSVJRLAogICAgIFJDVV9TT0ZUSVJR
LAotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5v
cmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZl
bA==

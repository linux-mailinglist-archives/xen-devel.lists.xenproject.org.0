Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 5726E87D75
	for <lists+xen-devel@lfdr.de>; Fri,  9 Aug 2019 17:02:18 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hw6MH-00075O-8j; Fri, 09 Aug 2019 14:59:09 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=yG4W=WF=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hw6M2-0006bs-Iu
 for xen-devel@lists.xenproject.org; Fri, 09 Aug 2019 14:58:54 +0000
X-Inumbo-ID: 31558a10-bab6-11e9-b0c9-87196e65e4e6
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 31558a10-bab6-11e9-b0c9-87196e65e4e6;
 Fri, 09 Aug 2019 14:58:49 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 2AF61B008;
 Fri,  9 Aug 2019 14:58:48 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri,  9 Aug 2019 16:58:14 +0200
Message-Id: <20190809145833.1020-30-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190809145833.1020-1-jgross@suse.com>
References: <20190809145833.1020-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v2 29/48] xen/sched: add code to sync scheduling
 of all vcpus of a sched unit
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>,
 Dario Faggioli <dfaggioli@suse.com>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiBzd2l0Y2hpbmcgc2NoZWQgdW5pdHMgc3luY2hyb25pemUgYWxsIHZjcHVzIG9mIHRoZSBu
ZXcgdW5pdCB0byBiZQpzY2hlZHVsZWQgYXQgdGhlIHNhbWUgdGltZS4KCkEgdmFyaWFibGUgc2No
ZWRfZ3JhbnVsYXJpdHkgaXMgYWRkZWQgd2hpY2ggaG9sZHMgdGhlIG51bWJlciBvZiB2Y3B1cwpw
ZXIgc2NoZWR1bGUgdW5pdC4KCkFzIHRhc2tsZXRzIHJlcXVpcmUgdG8gc2NoZWR1bGUgdGhlIGlk
bGUgdW5pdCBpdCBpcyByZXF1aXJlZCB0byBzZXQgdGhlCnRhc2tsZXRfd29ya19zY2hlZHVsZWQg
cGFyYW1ldGVyIG9mIGRvX3NjaGVkdWxlKCkgdG8gdHJ1ZSBpZiBhbnkgY3B1CmNvdmVyZWQgYnkg
dGhlIGN1cnJlbnQgc2NoZWR1bGUoKSBjYWxsIGhhcyBhbnkgcGVuZGluZyB0YXNrbGV0IHdvcmsu
CgpGb3Igam9pbmluZyBvdGhlciB2Y3B1cyBvZiB0aGUgc2NoZWR1bGUgdW5pdCB3ZSBuZWVkIHRv
IGFkZCBhIG5ldwpzb2Z0aXJxIFNDSEVEX1NMQVZFX1NPRlRJUlEgaW4gb3JkZXIgdG8gaGF2ZSBh
IHdheSB0byBpbml0aWF0ZSBhCmNvbnRleHQgc3dpdGNoIHdpdGhvdXQgY2FsbGluZyB0aGUgZ2Vu
ZXJpYyBzY2hlZHVsZSgpIGZ1bmN0aW9uCnNlbGVjdGluZyB0aGUgdmNwdSB0byBzd2l0Y2ggdG8s
IGFzIHdlIGFscmVhZHkga25vdyB3aGljaCB2Y3B1IHdlCndhbnQgdG8gcnVuLiBUaGlzIGhhcyB0
aGUgb3RoZXIgYWR2YW50YWdlIG5vdCB0byBsb29zZSBhbnkgb3RoZXIKY29uY3VycmVudCBTQ0hF
RFVMRV9TT0ZUSVJRIGV2ZW50cy4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9z
c0BzdXNlLmNvbT4KLS0tClJGQyBWMjoKLSBtb3ZlIHN5bmNpbmcgYWZ0ZXIgY29udGV4dF9zd2l0
Y2goKSB0byBzY2hlZHVsZS5jClYyOgotIGRvbid0IHJ1biB0YXNrbGV0cyBkaXJlY3RseSBmcm9t
IHNjaGVkX3dhaXRfcmVuZGV6dm91c19pbigpCi0tLQogeGVuL2FyY2gvYXJtL2RvbWFpbi5jICAg
ICAgfCAgIDIgKy0KIHhlbi9hcmNoL3g4Ni9kb21haW4uYyAgICAgIHwgICAzICstCiB4ZW4vY29t
bW9uL3NjaGVkdWxlLmMgICAgICB8IDMzOCArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKy0tLS0tLS0tLS0KIHhlbi9jb21tb24vc29mdGlycS5jICAgICAgIHwgICA2ICstCiB4ZW4v
aW5jbHVkZS94ZW4vc2NoZWQtaWYuaCB8ICAgMSArCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCAg
ICB8ICAxNiArKy0KIHhlbi9pbmNsdWRlL3hlbi9zb2Z0aXJxLmggIHwgICAxICsKIDcgZmlsZXMg
Y2hhbmdlZCwgMjg0IGluc2VydGlvbnMoKyksIDgzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBh
L3hlbi9hcmNoL2FybS9kb21haW4uYyBiL3hlbi9hcmNoL2FybS9kb21haW4uYwppbmRleCA5NDFi
YmZmNGZlLi40MGRjYmNlNjc1IDEwMDY0NAotLS0gYS94ZW4vYXJjaC9hcm0vZG9tYWluLmMKKysr
IGIveGVuL2FyY2gvYXJtL2RvbWFpbi5jCkBAIC0zMTUsNyArMzE1LDcgQEAgc3RhdGljIHZvaWQg
c2NoZWR1bGVfdGFpbChzdHJ1Y3QgdmNwdSAqcHJldikKIAogICAgIGxvY2FsX2lycV9lbmFibGUo
KTsKIAotICAgIGNvbnRleHRfc2F2ZWQocHJldik7CisgICAgc2NoZWRfY29udGV4dF9zd2l0Y2hl
ZChwcmV2LCBjdXJyZW50KTsKIAogICAgIHVwZGF0ZV9ydW5zdGF0ZV9hcmVhKGN1cnJlbnQpOwog
CmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvZG9tYWluLmMgYi94ZW4vYXJjaC94ODYvZG9tYWlu
LmMKaW5kZXggNWU2OTI4N2Y4Ny4uYzQ1YmVjODg2NCAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2
L2RvbWFpbi5jCisrKyBiL3hlbi9hcmNoL3g4Ni9kb21haW4uYwpAQCAtMTc2Niw3ICsxNzY2LDYg
QEAgc3RhdGljIHZvaWQgX19jb250ZXh0X3N3aXRjaCh2b2lkKQogICAgIHBlcl9jcHUoY3Vycl92
Y3B1LCBjcHUpID0gbjsKIH0KIAotCiB2b2lkIGNvbnRleHRfc3dpdGNoKHN0cnVjdCB2Y3B1ICpw
cmV2LCBzdHJ1Y3QgdmNwdSAqbmV4dCkKIHsKICAgICB1bnNpZ25lZCBpbnQgY3B1ID0gc21wX3By
b2Nlc3Nvcl9pZCgpOwpAQCAtMTg0Miw3ICsxODQxLDcgQEAgdm9pZCBjb250ZXh0X3N3aXRjaChz
dHJ1Y3QgdmNwdSAqcHJldiwgc3RydWN0IHZjcHUgKm5leHQpCiAgICAgICAgIH0KICAgICB9CiAK
LSAgICBjb250ZXh0X3NhdmVkKHByZXYpOworICAgIHNjaGVkX2NvbnRleHRfc3dpdGNoZWQocHJl
diwgbmV4dCk7CiAKICAgICBfdXBkYXRlX3J1bnN0YXRlX2FyZWEobmV4dCk7CiAgICAgLyogTXVz
dCBiZSBkb25lIHdpdGggaW50ZXJydXB0cyBlbmFibGVkICovCmRpZmYgLS1naXQgYS94ZW4vY29t
bW9uL3NjaGVkdWxlLmMgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKaW5kZXggZDJmYzg5ZDk4My4u
MDE2MGMzMDQ2NSAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jCisrKyBiL3hlbi9j
b21tb24vc2NoZWR1bGUuYwpAQCAtNTUsNiArNTUsOSBAQCBib29sZWFuX3BhcmFtKCJzY2hlZF9z
bXRfcG93ZXJfc2F2aW5ncyIsIHNjaGVkX3NtdF9wb3dlcl9zYXZpbmdzKTsKIGludCBzY2hlZF9y
YXRlbGltaXRfdXMgPSBTQ0hFRF9ERUZBVUxUX1JBVEVMSU1JVF9VUzsKIGludGVnZXJfcGFyYW0o
InNjaGVkX3JhdGVsaW1pdF91cyIsIHNjaGVkX3JhdGVsaW1pdF91cyk7CiAKKy8qIE51bWJlciBv
ZiB2Y3B1cyBwZXIgc3RydWN0IHNjaGVkX3VuaXQuICovCitzdGF0aWMgdW5zaWduZWQgaW50IF9f
cmVhZF9tb3N0bHkgc2NoZWRfZ3JhbnVsYXJpdHkgPSAxOworCiAvKiBDb21tb24gbG9jayBmb3Ig
ZnJlZSBjcHVzLiAqLwogc3RhdGljIERFRklORV9TUElOTE9DSyhzY2hlZF9mcmVlX2NwdV9sb2Nr
KTsKIApAQCAtMTY4NiwxMzEgKzE2ODksMzE4IEBAIHN0YXRpYyB2b2lkIHZjcHVfcGVyaW9kaWNf
dGltZXJfd29yayhzdHJ1Y3QgdmNwdSAqdikKICAgICBzZXRfdGltZXIoJnYtPnBlcmlvZGljX3Rp
bWVyLCBwZXJpb2RpY19uZXh0X2V2ZW50KTsKIH0KIAotLyoKLSAqIFRoZSBtYWluIGZ1bmN0aW9u
Ci0gKiAtIGRlc2NoZWR1bGUgdGhlIGN1cnJlbnQgZG9tYWluIChzY2hlZHVsZXIgaW5kZXBlbmRl
bnQpLgotICogLSBwaWNrIGEgbmV3IGRvbWFpbiAoc2NoZWR1bGVyIGRlcGVuZGVudCkuCi0gKi8K
LXN0YXRpYyB2b2lkIHNjaGVkdWxlKHZvaWQpCitzdGF0aWMgdm9pZCBzY2hlZF9zd2l0Y2hfdW5p
dHMoc3RydWN0IHNjaGVkX3Jlc291cmNlICpzZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqbmV4dCwgc3RydWN0IHNjaGVkX3VuaXQgKnByZXYsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc190aW1lX3Qgbm93KQogewotICAgIHN0cnVj
dCBzY2hlZF91bml0ICAgICpwcmV2ID0gY3VycmVudC0+c2NoZWRfdW5pdCwgKm5leHQgPSBOVUxM
OwotICAgIHNfdGltZV90ICAgICAgICAgICAgICBub3c7Ci0gICAgc3RydWN0IHNjaGVkdWxlciAg
ICAgKnNjaGVkOwotICAgIHVuc2lnbmVkIGxvbmcgICAgICAgICp0YXNrbGV0X3dvcmsgPSAmdGhp
c19jcHUodGFza2xldF93b3JrX3RvX2RvKTsKLSAgICBib29sICAgICAgICAgICAgICAgICAgdGFz
a2xldF93b3JrX3NjaGVkdWxlZCA9IGZhbHNlOwotICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAq
c2Q7Ci0gICAgc3BpbmxvY2tfdCAgICAgICAgICAgKmxvY2s7Ci0gICAgaW50IGNwdSA9IHNtcF9w
cm9jZXNzb3JfaWQoKTsKKyAgICBzZC0+Y3VyciA9IG5leHQ7CiAKLSAgICBBU1NFUlRfTk9UX0lO
X0FUT01JQygpOworICAgIFRSQUNFXzNEKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GUFJFViwgcHJldi0+
ZG9tYWluLT5kb21haW5faWQsIHByZXYtPnVuaXRfaWQsCisgICAgICAgICAgICAgbm93IC0gcHJl
di0+c3RhdGVfZW50cnlfdGltZSk7CisgICAgVFJBQ0VfNEQoVFJDX1NDSEVEX1NXSVRDSF9JTkZO
RVhULCBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCwKKyAgICAgICAgICAg
ICAobmV4dC0+dmNwdV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uYWJsZSkg
PworICAgICAgICAgICAgIChub3cgLSBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lKSA6IDAsIHByZXYt
Pm5leHRfdGltZSk7CiAKLSAgICBTQ0hFRF9TVEFUX0NSQU5LKHNjaGVkX3J1bik7CisgICAgQVNT
RVJUKHByZXYtPnZjcHVfbGlzdC0+cnVuc3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmluZyk7
CiAKLSAgICBzZCA9IGdldF9zY2hlZF9yZXMoY3B1KTsKKyAgICBUUkFDRV80RChUUkNfU0NIRURf
U1dJVENILCBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKKyAgICAgICAg
ICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCk7CisKKyAgICBzY2hl
ZF91bml0X3J1bnN0YXRlX2NoYW5nZShwcmV2LCBmYWxzZSwgbm93KTsKKworICAgIEFTU0VSVChu
ZXh0LT52Y3B1X2xpc3QtPnJ1bnN0YXRlLnN0YXRlICE9IFJVTlNUQVRFX3J1bm5pbmcpOworICAg
IHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hhbmdlKG5leHQsIHRydWUsIG5vdyk7CisKKyAgICAvKgor
ICAgICAqIE5CLiBEb24ndCBhZGQgYW55IHRyYWNlIHJlY29yZHMgZnJvbSBoZXJlIHVudGlsIHRo
ZSBhY3R1YWwgY29udGV4dAorICAgICAqIHN3aXRjaCwgZWxzZSBsb3N0X3JlY29yZHMgcmVzdW1l
IHdpbGwgbm90IHdvcmsgcHJvcGVybHkuCisgICAgICovCisKKyAgICBBU1NFUlQoIW5leHQtPmlz
X3J1bm5pbmcpOworICAgIG5leHQtPnZjcHVfbGlzdC0+aXNfcnVubmluZyA9IDE7CisgICAgbmV4
dC0+aXNfcnVubmluZyA9IDE7Cit9CisKK3N0YXRpYyBib29sIHNjaGVkX3Rhc2tsZXRfY2hlY2tf
Y3B1KHVuc2lnbmVkIGludCBjcHUpCit7CisgICAgdW5zaWduZWQgbG9uZyAqdGFza2xldF93b3Jr
ID0gJnBlcl9jcHUodGFza2xldF93b3JrX3RvX2RvLCBjcHUpOwogCi0gICAgLyogVXBkYXRlIHRh
c2tsZXQgc2NoZWR1bGluZyBzdGF0dXMuICovCiAgICAgc3dpdGNoICggKnRhc2tsZXRfd29yayAp
CiAgICAgewogICAgIGNhc2UgVEFTS0xFVF9lbnF1ZXVlZDoKICAgICAgICAgc2V0X2JpdChfVEFT
S0xFVF9zY2hlZHVsZWQsIHRhc2tsZXRfd29yayk7CiAgICAgICAgIC8qIGZhbGx0aHJvdWdoICov
CiAgICAgY2FzZSBUQVNLTEVUX2VucXVldWVkfFRBU0tMRVRfc2NoZWR1bGVkOgotICAgICAgICB0
YXNrbGV0X3dvcmtfc2NoZWR1bGVkID0gdHJ1ZTsKKyAgICAgICAgcmV0dXJuIHRydWU7CiAgICAg
ICAgIGJyZWFrOwogICAgIGNhc2UgVEFTS0xFVF9zY2hlZHVsZWQ6CiAgICAgICAgIGNsZWFyX2Jp
dChfVEFTS0xFVF9zY2hlZHVsZWQsIHRhc2tsZXRfd29yayk7CisgICAgICAgIC8qIGZhbGx0aHJv
dWdoICovCiAgICAgY2FzZSAwOgotICAgICAgICAvKnRhc2tsZXRfd29ya19zY2hlZHVsZWQgPSBm
YWxzZTsqLworICAgICAgICAvKiByZXR1cm4gZmFsc2U7ICovCiAgICAgICAgIGJyZWFrOwogICAg
IGRlZmF1bHQ6CiAgICAgICAgIEJVRygpOwogICAgIH0KIAotICAgIGxvY2sgPSBwY3B1X3NjaGVk
dWxlX2xvY2tfaXJxKGNwdSk7CisgICAgcmV0dXJuIGZhbHNlOworfQogCi0gICAgbm93ID0gTk9X
KCk7CitzdGF0aWMgYm9vbCBzY2hlZF90YXNrbGV0X2NoZWNrKHVuc2lnbmVkIGludCBjcHUpCit7
CisgICAgYm9vbCB0YXNrbGV0X3dvcmtfc2NoZWR1bGVkID0gZmFsc2U7CisgICAgY29uc3QgY3B1
bWFza190ICptYXNrID0gZ2V0X3NjaGVkX3JlcyhjcHUpLT5jcHVzOworICAgIGludCBjcHVfaXRl
cjsKIAotICAgIHN0b3BfdGltZXIoJnNkLT5zX3RpbWVyKTsKKyAgICBmb3JfZWFjaF9jcHUgKCBj
cHVfaXRlciwgbWFzayApCisgICAgICAgIGlmICggc2NoZWRfdGFza2xldF9jaGVja19jcHUoY3B1
X2l0ZXIpICkKKyAgICAgICAgICAgIHRhc2tsZXRfd29ya19zY2hlZHVsZWQgPSB0cnVlOworCisg
ICAgcmV0dXJuIHRhc2tsZXRfd29ya19zY2hlZHVsZWQ7Cit9CisKK3N0YXRpYyBzdHJ1Y3Qgc2No
ZWRfdW5pdCAqZG9fc2NoZWR1bGUoc3RydWN0IHNjaGVkX3VuaXQgKnByZXYsIHNfdGltZV90IG5v
dywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGNw
dSkKK3sKKyAgICBzdHJ1Y3Qgc2NoZWR1bGVyICpzY2hlZCA9IHBlcl9jcHUoc2NoZWR1bGVyLCBj
cHUpOworICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc2QgPSBnZXRfc2NoZWRfcmVzKGNwdSk7
CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKm5leHQ7CiAKICAgICAvKiBnZXQgcG9saWN5LXNwZWNp
ZmljIGRlY2lzaW9uIG9uIHNjaGVkdWxpbmcuLi4gKi8KLSAgICBzY2hlZCA9IHRoaXNfY3B1KHNj
aGVkdWxlcik7Ci0gICAgc2NoZWQtPmRvX3NjaGVkdWxlKHNjaGVkLCBwcmV2LCBub3csIHRhc2ts
ZXRfd29ya19zY2hlZHVsZWQpOworICAgIHNjaGVkLT5kb19zY2hlZHVsZShzY2hlZCwgcHJldiwg
bm93LCBzY2hlZF90YXNrbGV0X2NoZWNrKGNwdSkpOwogCiAgICAgbmV4dCA9IHByZXYtPm5leHRf
dGFzazsKIAotICAgIHNkLT5jdXJyID0gbmV4dDsKLQogICAgIGlmICggcHJldi0+bmV4dF90aW1l
ID49IDAgKSAvKiAtdmUgbWVhbnMgbm8gbGltaXQgKi8KICAgICAgICAgc2V0X3RpbWVyKCZzZC0+
c190aW1lciwgbm93ICsgcHJldi0+bmV4dF90aW1lKTsKIAotICAgIGlmICggdW5saWtlbHkocHJl
diA9PSBuZXh0KSApCisgICAgaWYgKCBsaWtlbHkocHJldiAhPSBuZXh0KSApCisgICAgICAgIHNj
aGVkX3N3aXRjaF91bml0cyhzZCwgbmV4dCwgcHJldiwgbm93KTsKKworICAgIHJldHVybiBuZXh0
OworfQorCitzdGF0aWMgdm9pZCBjb250ZXh0X3NhdmVkKHN0cnVjdCB2Y3B1ICpwcmV2KQorewor
ICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0ID0gcHJldi0+c2NoZWRfdW5pdDsKKworICAgIC8q
IENsZWFyIHJ1bm5pbmcgZmxhZyAvYWZ0ZXIvIHdyaXRpbmcgY29udGV4dCB0byBtZW1vcnkuICov
CisgICAgc21wX3dtYigpOworCisgICAgcHJldi0+aXNfcnVubmluZyA9IDA7CisgICAgdW5pdC0+
aXNfcnVubmluZyA9IDA7CisgICAgdW5pdC0+c3RhdGVfZW50cnlfdGltZSA9IE5PVygpOworCisg
ICAgLyogQ2hlY2sgZm9yIG1pZ3JhdGlvbiByZXF1ZXN0IC9hZnRlci8gY2xlYXJpbmcgcnVubmlu
ZyBmbGFnLiAqLworICAgIHNtcF9tYigpOworCisgICAgc2NoZWRfY29udGV4dF9zYXZlZCh2Y3B1
X3NjaGVkdWxlcihwcmV2KSwgdW5pdCk7CisKKyAgICBzY2hlZF91bml0X21pZ3JhdGVfZmluaXNo
KHVuaXQpOworfQorCisvKgorICogUmVuZGV6dm91cyBvbiBlbmQgb2YgY29udGV4dCBzd2l0Y2gu
CisgKiBBcyBubyBsb2NrIGlzIHByb3RlY3RpbmcgdGhpcyByZW5kZXp2b3VzIGZ1bmN0aW9uIHdl
IG5lZWQgdG8gdXNlIGF0b21pYworICogYWNjZXNzIGZ1bmN0aW9ucyBvbiB0aGUgY291bnRlci4K
KyAqIFRoZSBjb3VudGVyIHdpbGwgYmUgMCBpbiBjYXNlIG5vIHJlbmRlenZvdXMgaXMgbmVlZGVk
LiBGb3IgdGhlIHJlbmRlenZvdXMKKyAqIGNhc2UgaXQgaXMgaW5pdGlhbGlzZWQgdG8gdGhlIG51
bWJlciBvZiBjcHVzIHRvIHJlbmRlenZvdXMgcGx1cyAxLiBFYWNoCisgKiBtZW1iZXIgZW50ZXJp
bmcgZGVjcmVtZW50cyB0aGUgY291bnRlci4gVGhlIGxhc3Qgb25lIHdpbGwgZGVjcmVtZW50IGl0
IHRvCisgKiAxIGFuZCBwZXJmb3JtIHRoZSBmaW5hbCBuZWVkZWQgYWN0aW9uIGluIHRoYXQgY2Fz
ZSAoY2FsbCBvZiBjb250ZXh0X3NhdmVkKCkKKyAqIGlmIHZjcHUgd2FzIHN3aXRjaGVkKSwgYW5k
IHRoZW4gc2V0IHRoZSBjb3VudGVyIHRvIHplcm8uIFRoZSBvdGhlciBtZW1iZXJzCisgKiB3aWxs
IHdhaXQgdW50aWwgdGhlIGNvdW50ZXIgYmVjb21lcyB6ZXJvIHVudGlsIHRoZXkgcHJvY2VlZC4K
KyAqLwordm9pZCBzY2hlZF9jb250ZXh0X3N3aXRjaGVkKHN0cnVjdCB2Y3B1ICp2cHJldiwgc3Ry
dWN0IHZjcHUgKnZuZXh0KQoreworICAgIHN0cnVjdCBzY2hlZF91bml0ICpuZXh0ID0gdm5leHQt
PnNjaGVkX3VuaXQ7CisKKyAgICBpZiAoIGF0b21pY19yZWFkKCZuZXh0LT5yZW5kZXp2b3VzX291
dF9jbnQpICkKKyAgICB7CisgICAgICAgIGludCBjbnQgPSBhdG9taWNfZGVjX3JldHVybigmbmV4
dC0+cmVuZGV6dm91c19vdXRfY250KTsKKworICAgICAgICAvKiBDYWxsIGNvbnRleHRfc2F2ZWQo
KSBiZWZvcmUgcmVsZWFzaW5nIG90aGVyIHdhaXRlcnMuICovCisgICAgICAgIGlmICggY250ID09
IDEgKQorICAgICAgICB7CisgICAgICAgICAgICBpZiAoIHZwcmV2ICE9IHZuZXh0ICkKKyAgICAg
ICAgICAgICAgICBjb250ZXh0X3NhdmVkKHZwcmV2KTsKKyAgICAgICAgICAgIGF0b21pY19zZXQo
Jm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCwgMCk7CisgICAgICAgIH0KKyAgICAgICAgZWxzZQor
ICAgICAgICAgICAgd2hpbGUgKCBhdG9taWNfcmVhZCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250
KSApCisgICAgICAgICAgICAgICAgY3B1X3JlbGF4KCk7CisgICAgfQorICAgIGVsc2UgaWYgKCB2
cHJldiAhPSB2bmV4dCApCisgICAgICAgIGNvbnRleHRfc2F2ZWQodnByZXYpOworfQorCitzdGF0
aWMgdm9pZCBzY2hlZF9jb250ZXh0X3N3aXRjaChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2
Y3B1ICp2bmV4dCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNfdGltZV90IG5v
dykKK3sKKyAgICBpZiAoIHVubGlrZWx5KHZwcmV2ID09IHZuZXh0KSApCiAgICAgewotICAgICAg
ICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKICAgICAgICAgVFJBQ0VfNEQo
VFJDX1NDSEVEX1NXSVRDSF9JTkZDT05ULAotICAgICAgICAgICAgICAgICBuZXh0LT5kb21haW4t
PmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCwKLSAgICAgICAgICAgICAgICAgbm93IC0gcHJldi0+
c3RhdGVfZW50cnlfdGltZSwKLSAgICAgICAgICAgICAgICAgcHJldi0+bmV4dF90aW1lKTsKKyAg
ICAgICAgICAgICAgICAgdm5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCB2bmV4dC0+c2NoZWRfdW5p
dC0+dW5pdF9pZCwKKyAgICAgICAgICAgICAgICAgbm93IC0gdnByZXYtPnJ1bnN0YXRlLnN0YXRl
X2VudHJ5X3RpbWUsCisgICAgICAgICAgICAgICAgIHZwcmV2LT5zY2hlZF91bml0LT5uZXh0X3Rp
bWUpOworICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaGVkKHZwcmV2LCB2bmV4dCk7CisgICAg
ICAgIHRyYWNlX2NvbnRpbnVlX3J1bm5pbmcodm5leHQpOworICAgICAgICByZXR1cm4gY29udGlu
dWVfcnVubmluZyh2cHJldik7CiAgICAgfQogCi0gICAgVFJBQ0VfM0QoVFJDX1NDSEVEX1NXSVRD
SF9JTkZQUkVWLAotICAgICAgICAgICAgIHByZXYtPmRvbWFpbi0+ZG9tYWluX2lkLCBwcmV2LT51
bml0X2lkLAotICAgICAgICAgICAgIG5vdyAtIHByZXYtPnN0YXRlX2VudHJ5X3RpbWUpOwotICAg
IFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GTkVYVCwKLSAgICAgICAgICAgICBuZXh0LT5k
b21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCwKLSAgICAgICAgICAgICAobmV4dC0+dmNw
dV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uYWJsZSkgPwotICAgICAgICAg
ICAgIChub3cgLSBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lKSA6IDAsCi0gICAgICAgICAgICAgcHJl
di0+bmV4dF90aW1lKTsKKyAgICBTQ0hFRF9TVEFUX0NSQU5LKHNjaGVkX2N0eCk7CiAKLSAgICBB
U1NFUlQocHJldi0+dmNwdV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uaW5n
KTsKKyAgICBzdG9wX3RpbWVyKCZ2cHJldi0+cGVyaW9kaWNfdGltZXIpOwogCi0gICAgVFJBQ0Vf
NEQoVFJDX1NDSEVEX1NXSVRDSCwKLSAgICAgICAgICAgICBwcmV2LT5kb21haW4tPmRvbWFpbl9p
ZCwgcHJldi0+dW5pdF9pZCwKLSAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwg
bmV4dC0+dW5pdF9pZCk7CisgICAgaWYgKCB2bmV4dC0+c2NoZWRfdW5pdC0+bWlncmF0ZWQgKQor
ICAgICAgICB2Y3B1X21vdmVfaXJxcyh2bmV4dCk7CiAKLSAgICBzY2hlZF91bml0X3J1bnN0YXRl
X2NoYW5nZShwcmV2LCBmYWxzZSwgbm93KTsKKyAgICB2Y3B1X3BlcmlvZGljX3RpbWVyX3dvcmso
dm5leHQpOwogCi0gICAgQVNTRVJUKG5leHQtPnZjcHVfbGlzdC0+cnVuc3RhdGUuc3RhdGUgIT0g
UlVOU1RBVEVfcnVubmluZyk7Ci0gICAgc2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2UobmV4dCwg
dHJ1ZSwgbm93KTsKKyAgICBjb250ZXh0X3N3aXRjaCh2cHJldiwgdm5leHQpOworfQogCi0gICAg
LyoKLSAgICAgKiBOQi4gRG9uJ3QgYWRkIGFueSB0cmFjZSByZWNvcmRzIGZyb20gaGVyZSB1bnRp
bCB0aGUgYWN0dWFsIGNvbnRleHQKLSAgICAgKiBzd2l0Y2gsIGVsc2UgbG9zdF9yZWNvcmRzIHJl
c3VtZSB3aWxsIG5vdCB3b3JrIHByb3Blcmx5LgotICAgICAqLworLyoKKyAqIFJlbmRlenZvdXMg
YmVmb3JlIHRha2luZyBhIHNjaGVkdWxpbmcgZGVjaXNpb24uCisgKiBDYWxsZWQgd2l0aCBzY2hl
ZHVsZSBsb2NrIGhlbGQsIHNvIGFsbCBhY2Nlc3NlcyB0byB0aGUgcmVuZGV6dm91cyBjb3VudGVy
CisgKiBjYW4gYmUgbm9ybWFsIG9uZXMgKG5vIGF0b21pYyBhY2Nlc3NlcyBuZWVkZWQpLgorICog
VGhlIGNvdW50ZXIgaXMgaW5pdGlhbGl6ZWQgdG8gdGhlIG51bWJlciBvZiBjcHVzIHRvIHJlbmRl
enZvdXMgaW5pdGlhbGx5LgorICogRWFjaCBjcHUgZW50ZXJpbmcgd2lsbCBkZWNyZW1lbnQgdGhl
IGNvdW50ZXIuIEluIGNhc2UgdGhlIGNvdW50ZXIgYmVjb21lcworICogemVybyBkb19zY2hlZHVs
ZSgpIGlzIGNhbGxlZCBhbmQgdGhlIHJlbmRlenZvdXMgY291bnRlciBmb3IgbGVhdmluZworICog
Y29udGV4dF9zd2l0Y2goKSBpcyBzZXQuIEFsbCBvdGhlciBtZW1iZXJzIHdpbGwgd2FpdCB1bnRp
bCB0aGUgY291bnRlciBpcworICogYmVjb21pbmcgemVybywgZHJvcHBpbmcgdGhlIHNjaGVkdWxl
IGxvY2sgaW4gYmV0d2Vlbi4KKyAqLworc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF93
YWl0X3JlbmRlenZvdXNfaW4oc3RydWN0IHNjaGVkX3VuaXQgKnByZXYsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGlubG9ja190ICoqbG9jaywg
aW50IGNwdSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHNfdGltZV90IG5vdykKK3sKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqbmV4dDsKIAotICAg
IEFTU0VSVCghbmV4dC0+aXNfcnVubmluZyk7Ci0gICAgbmV4dC0+dmNwdV9saXN0LT5pc19ydW5u
aW5nID0gMTsKLSAgICBuZXh0LT5pc19ydW5uaW5nID0gMTsKLSAgICBuZXh0LT5zdGF0ZV9lbnRy
eV90aW1lID0gbm93OworICAgIGlmICggIS0tcHJldi0+cmVuZGV6dm91c19pbl9jbnQgKQorICAg
IHsKKyAgICAgICAgbmV4dCA9IGRvX3NjaGVkdWxlKHByZXYsIG5vdywgY3B1KTsKKyAgICAgICAg
YXRvbWljX3NldCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250LCBzY2hlZF9ncmFudWxhcml0eSAr
IDEpOworICAgICAgICByZXR1cm4gbmV4dDsKKyAgICB9CiAKLSAgICBwY3B1X3NjaGVkdWxlX3Vu
bG9ja19pcnEobG9jaywgY3B1KTsKKyAgICB3aGlsZSAoIHByZXYtPnJlbmRlenZvdXNfaW5fY250
ICkKKyAgICB7CisgICAgICAgIC8qCisgICAgICAgICAqIENvbWluZyBmcm9tIGlkbGUgbWlnaHQg
bmVlZCB0byBkbyB0YXNrbGV0IHdvcmsuCisgICAgICAgICAqIEluIG9yZGVyIHRvIGF2b2lkIGRl
YWRsb2NrcyB3ZSBjYW4ndCBkbyB0aGF0IGhlcmUsIGJ1dCBoYXZlIHRvCisgICAgICAgICAqIGNv
bnRpbnVlIHRoZSBpZGxlIGxvb3AuCisgICAgICAgICAqIFVuZG8gdGhlIHJlbmRlenZvdXNfaW5f
Y250IGRlY3JlbWVudCBhbmQgc2NoZWR1bGUgYW5vdGhlciBjYWxsIG9mCisgICAgICAgICAqIHNj
aGVkX3NsYXZlKCkuCisgICAgICAgICAqLworICAgICAgICBpZiAoIGlzX2lkbGVfdW5pdChwcmV2
KSAmJiBzY2hlZF90YXNrbGV0X2NoZWNrX2NwdShjcHUpICkKKyAgICAgICAgeworICAgICAgICAg
ICAgc3RydWN0IHZjcHUgKnZwcmV2ID0gY3VycmVudDsKIAotICAgIFNDSEVEX1NUQVRfQ1JBTkso
c2NoZWRfY3R4KTsKKyAgICAgICAgICAgIHByZXYtPnJlbmRlenZvdXNfaW5fY250Kys7CisgICAg
ICAgICAgICBhdG9taWNfc2V0KCZwcmV2LT5yZW5kZXp2b3VzX291dF9jbnQsIDApOworCisgICAg
ICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEoKmxvY2ssIGNwdSk7CisKKyAgICAgICAg
ICAgIHJhaXNlX3NvZnRpcnEoU0NIRURfU0xBVkVfU09GVElSUSk7CisgICAgICAgICAgICBzY2hl
ZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgdnByZXYsIG5vdyk7CisgICAgICAgIH0KIAotICAgIHN0
b3BfdGltZXIoJnByZXYtPnZjcHVfbGlzdC0+cGVyaW9kaWNfdGltZXIpOworICAgICAgICBwY3B1
X3NjaGVkdWxlX3VubG9ja19pcnEoKmxvY2ssIGNwdSk7CiAKLSAgICBpZiAoIG5leHQtPm1pZ3Jh
dGVkICkKLSAgICAgICAgdmNwdV9tb3ZlX2lycXMobmV4dC0+dmNwdV9saXN0KTsKKyAgICAgICAg
Y3B1X3JlbGF4KCk7CiAKLSAgICB2Y3B1X3BlcmlvZGljX3RpbWVyX3dvcmsobmV4dC0+dmNwdV9s
aXN0KTsKKyAgICAgICAgKmxvY2sgPSBwY3B1X3NjaGVkdWxlX2xvY2tfaXJxKGNwdSk7CisgICAg
fQogCi0gICAgY29udGV4dF9zd2l0Y2gocHJldi0+dmNwdV9saXN0LCBuZXh0LT52Y3B1X2xpc3Qp
OworICAgIHJldHVybiBwcmV2LT5uZXh0X3Rhc2s7CiB9CiAKLXZvaWQgY29udGV4dF9zYXZlZChz
dHJ1Y3QgdmNwdSAqcHJldikKK3N0YXRpYyB2b2lkIHNjaGVkX3NsYXZlKHZvaWQpCiB7Ci0gICAg
LyogQ2xlYXIgcnVubmluZyBmbGFnIC9hZnRlci8gd3JpdGluZyBjb250ZXh0IHRvIG1lbW9yeS4g
Ki8KLSAgICBzbXBfd21iKCk7CisgICAgc3RydWN0IHZjcHUgICAgICAgICAgKnZwcmV2ID0gY3Vy
cmVudDsKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAgICAqcHJldiA9IHZwcmV2LT5zY2hlZF91bml0
LCAqbmV4dDsKKyAgICBzX3RpbWVfdCAgICAgICAgICAgICAgbm93OworICAgIHNwaW5sb2NrX3Qg
ICAgICAgICAgICpsb2NrOworICAgIGludCBjcHUgPSBzbXBfcHJvY2Vzc29yX2lkKCk7CiAKLSAg
ICBwcmV2LT5pc19ydW5uaW5nID0gMDsKLSAgICBwcmV2LT5zY2hlZF91bml0LT5pc19ydW5uaW5n
ID0gMDsKLSAgICBwcmV2LT5zY2hlZF91bml0LT5zdGF0ZV9lbnRyeV90aW1lID0gTk9XKCk7Cisg
ICAgQVNTRVJUX05PVF9JTl9BVE9NSUMoKTsKIAotICAgIC8qIENoZWNrIGZvciBtaWdyYXRpb24g
cmVxdWVzdCAvYWZ0ZXIvIGNsZWFyaW5nIHJ1bm5pbmcgZmxhZy4gKi8KLSAgICBzbXBfbWIoKTsK
KyAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycShjcHUpOworCisgICAgbm93ID0gTk9X
KCk7CisKKyAgICBpZiAoICFwcmV2LT5yZW5kZXp2b3VzX2luX2NudCApCisgICAgeworICAgICAg
ICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKKyAgICAgICAgcmV0dXJuOwor
ICAgIH0KKworICAgIHN0b3BfdGltZXIoJmdldF9zY2hlZF9yZXMoY3B1KS0+c190aW1lcik7CisK
KyAgICBuZXh0ID0gc2NoZWRfd2FpdF9yZW5kZXp2b3VzX2luKHByZXYsICZsb2NrLCBjcHUsIG5v
dyk7CisKKyAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKKworICAgIHNj
aGVkX2NvbnRleHRfc3dpdGNoKHZwcmV2LCBuZXh0LT52Y3B1X2xpc3QsIG5vdyk7Cit9CisKKy8q
CisgKiBUaGUgbWFpbiBmdW5jdGlvbgorICogLSBkZXNjaGVkdWxlIHRoZSBjdXJyZW50IGRvbWFp
biAoc2NoZWR1bGVyIGluZGVwZW5kZW50KS4KKyAqIC0gcGljayBhIG5ldyBkb21haW4gKHNjaGVk
dWxlciBkZXBlbmRlbnQpLgorICovCitzdGF0aWMgdm9pZCBzY2hlZHVsZSh2b2lkKQoreworICAg
IHN0cnVjdCB2Y3B1ICAgICAgICAgICp2bmV4dCwgKnZwcmV2ID0gY3VycmVudDsKKyAgICBzdHJ1
Y3Qgc2NoZWRfdW5pdCAgICAqcHJldiA9IHZwcmV2LT5zY2hlZF91bml0LCAqbmV4dCA9IE5VTEw7
CisgICAgc190aW1lX3QgICAgICAgICAgICAgIG5vdzsKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3Vy
Y2UgKnNkOworICAgIHNwaW5sb2NrX3QgICAgICAgICAgICpsb2NrOworICAgIGludCBjcHUgPSBz
bXBfcHJvY2Vzc29yX2lkKCk7CisKKyAgICBBU1NFUlRfTk9UX0lOX0FUT01JQygpOworCisgICAg
U0NIRURfU1RBVF9DUkFOSyhzY2hlZF9ydW4pOworCisgICAgc2QgPSBnZXRfc2NoZWRfcmVzKGNw
dSk7CisKKyAgICBsb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycShjcHUpOworCisgICAgaWYg
KCBwcmV2LT5yZW5kZXp2b3VzX2luX2NudCApCisgICAgeworICAgICAgICAvKgorICAgICAgICAg
KiBXZSBoYXZlIGEgcmFjZTogc2NoZWRfc2xhdmUoKSBzaG91bGQgYmUgY2FsbGVkLCBzbyByYWlz
ZSBhIHNvZnRpcnEKKyAgICAgICAgICogaW4gb3JkZXIgdG8gcmUtZW50ZXIgc2NoZWR1bGUoKSBs
YXRlciBhbmQgY2FsbCBzY2hlZF9zbGF2ZSgpIG5vdy4KKyAgICAgICAgICovCisgICAgICAgIHBj
cHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOworCisgICAgICAgIHJhaXNlX3NvZnRp
cnEoU0NIRURVTEVfU09GVElSUSk7CisgICAgICAgIHJldHVybiBzY2hlZF9zbGF2ZSgpOworICAg
IH0KKworICAgIG5vdyA9IE5PVygpOwogCi0gICAgc2NoZWRfY29udGV4dF9zYXZlZCh2Y3B1X3Nj
aGVkdWxlcihwcmV2KSwgcHJldi0+c2NoZWRfdW5pdCk7CisgICAgc3RvcF90aW1lcigmc2QtPnNf
dGltZXIpOworCisgICAgaWYgKCBzY2hlZF9ncmFudWxhcml0eSA+IDEgKQorICAgIHsKKyAgICAg
ICAgY3B1bWFza190IG1hc2s7CiAKLSAgICBzY2hlZF91bml0X21pZ3JhdGVfZmluaXNoKHByZXYt
PnNjaGVkX3VuaXQpOworICAgICAgICBwcmV2LT5yZW5kZXp2b3VzX2luX2NudCA9IHNjaGVkX2dy
YW51bGFyaXR5OworICAgICAgICBjcHVtYXNrX2FuZG5vdCgmbWFzaywgc2QtPmNwdXMsIGNwdW1h
c2tfb2YoY3B1KSk7CisgICAgICAgIGNwdW1hc2tfcmFpc2Vfc29mdGlycSgmbWFzaywgU0NIRURf
U0xBVkVfU09GVElSUSk7CisgICAgICAgIG5leHQgPSBzY2hlZF93YWl0X3JlbmRlenZvdXNfaW4o
cHJldiwgJmxvY2ssIGNwdSwgbm93KTsKKyAgICB9CisgICAgZWxzZQorICAgIHsKKyAgICAgICAg
cHJldi0+cmVuZGV6dm91c19pbl9jbnQgPSAwOworICAgICAgICBuZXh0ID0gZG9fc2NoZWR1bGUo
cHJldiwgbm93LCBjcHUpOworICAgICAgICBhdG9taWNfc2V0KCZuZXh0LT5yZW5kZXp2b3VzX291
dF9jbnQsIDApOworICAgIH0KKworICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBj
cHUpOworCisgICAgdm5leHQgPSBuZXh0LT52Y3B1X2xpc3Q7CisgICAgc2NoZWRfY29udGV4dF9z
d2l0Y2godnByZXYsIHZuZXh0LCBub3cpOwogfQogCiAvKiBUaGUgc2NoZWR1bGVyIHRpbWVyOiBm
b3JjZSBhIHJ1biB0aHJvdWdoIHRoZSBzY2hlZHVsZXIgKi8KQEAgLTE4NTEsNiArMjA0MSw3IEBA
IHN0YXRpYyBpbnQgY3B1X3NjaGVkdWxlX3VwKHVuc2lnbmVkIGludCBjcHUpCiAgICAgaWYgKCBz
ZCA9PSBOVUxMICkKICAgICAgICAgcmV0dXJuIC1FTk9NRU07CiAgICAgc2QtPnByb2Nlc3NvciA9
IGNwdTsKKyAgICBzZC0+Y3B1cyA9IGNwdW1hc2tfb2YoY3B1KTsKICAgICBzZXRfc2NoZWRfcmVz
KGNwdSwgc2QpOwogCiAgICAgcGVyX2NwdShzY2hlZHVsZXIsIGNwdSkgPSAmc2NoZWRfaWRsZV9v
cHM7CkBAIC0xODcxLDYgKzIwNjIsOCBAQCBzdGF0aWMgaW50IGNwdV9zY2hlZHVsZV91cCh1bnNp
Z25lZCBpbnQgY3B1KQogICAgIGlmICggaWRsZV92Y3B1W2NwdV0gPT0gTlVMTCApCiAgICAgICAg
IHJldHVybiAtRU5PTUVNOwogCisgICAgaWRsZV92Y3B1W2NwdV0tPnNjaGVkX3VuaXQtPnJlbmRl
enZvdXNfaW5fY250ID0gMDsKKwogICAgIC8qCiAgICAgICogTm8gbmVlZCB0byBhbGxvY2F0ZSBh
bnkgc2NoZWR1bGVyIGRhdGEsIGFzIGNwdXMgY29taW5nIG9ubGluZSBhcmUKICAgICAgKiBmcmVl
IGluaXRpYWxseSBhbmQgdGhlIGlkbGUgc2NoZWR1bGVyIGRvZXNuJ3QgbmVlZCBhbnkgZGF0YSBh
cmVhcwpAQCAtMTk3MSw2ICsyMTY0LDcgQEAgdm9pZCBfX2luaXQgc2NoZWR1bGVyX2luaXQodm9p
ZCkKICAgICBpbnQgaTsKIAogICAgIG9wZW5fc29mdGlycShTQ0hFRFVMRV9TT0ZUSVJRLCBzY2hl
ZHVsZSk7CisgICAgb3Blbl9zb2Z0aXJxKFNDSEVEX1NMQVZFX1NPRlRJUlEsIHNjaGVkX3NsYXZl
KTsKIAogICAgIGZvciAoIGkgPSAwOyBpIDwgTlVNX1NDSEVEVUxFUlM7IGkrKykKICAgICB7CmRp
ZmYgLS1naXQgYS94ZW4vY29tbW9uL3NvZnRpcnEuYyBiL3hlbi9jb21tb24vc29mdGlycS5jCmlu
ZGV4IDgzYzNjMDliZDUuLjJkNjYxOTMyMDMgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc29mdGly
cS5jCisrKyBiL3hlbi9jb21tb24vc29mdGlycS5jCkBAIC0zMyw4ICszMyw4IEBAIHN0YXRpYyB2
b2lkIF9fZG9fc29mdGlycSh1bnNpZ25lZCBsb25nIGlnbm9yZV9tYXNrKQogICAgIGZvciAoIDsg
OyApCiAgICAgewogICAgICAgICAvKgotICAgICAgICAgKiBJbml0aWFsaXNlIEBjcHUgb24gZXZl
cnkgaXRlcmF0aW9uOiBTQ0hFRFVMRV9TT0ZUSVJRIG1heSBtb3ZlCi0gICAgICAgICAqIHVzIHRv
IGFub3RoZXIgcHJvY2Vzc29yLgorICAgICAgICAgKiBJbml0aWFsaXNlIEBjcHUgb24gZXZlcnkg
aXRlcmF0aW9uOiBTQ0hFRFVMRV9TT0ZUSVJRIG9yCisgICAgICAgICAqIFNDSEVEX1NMQVZFX1NP
RlRJUlEgbWF5IG1vdmUgdXMgdG8gYW5vdGhlciBwcm9jZXNzb3IuCiAgICAgICAgICAqLwogICAg
ICAgICBjcHUgPSBzbXBfcHJvY2Vzc29yX2lkKCk7CiAKQEAgLTU1LDcgKzU1LDcgQEAgdm9pZCBw
cm9jZXNzX3BlbmRpbmdfc29mdGlycXModm9pZCkKIHsKICAgICBBU1NFUlQoIWluX2lycSgpICYm
IGxvY2FsX2lycV9pc19lbmFibGVkKCkpOwogICAgIC8qIERvIG5vdCBlbnRlciBzY2hlZHVsZXIg
YXMgaXQgY2FuIHByZWVtcHQgdGhlIGNhbGxpbmcgY29udGV4dC4gKi8KLSAgICBfX2RvX3NvZnRp
cnEoMXVsPDxTQ0hFRFVMRV9TT0ZUSVJRKTsKKyAgICBfX2RvX3NvZnRpcnEoKDF1bCA8PCBTQ0hF
RFVMRV9TT0ZUSVJRKSB8ICgxdWwgPDwgU0NIRURfU0xBVkVfU09GVElSUSkpOwogfQogCiB2b2lk
IGRvX3NvZnRpcnEodm9pZCkKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5o
IGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKaW5kZXggYmE5MWMzYTY4MC4uZjgxMGE5ZmJh
MSAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKKysrIGIveGVuL2luY2x1
ZGUveGVuL3NjaGVkLWlmLmgKQEAgLTQxLDYgKzQxLDcgQEAgc3RydWN0IHNjaGVkX3Jlc291cmNl
IHsKICAgICBzdHJ1Y3QgdGltZXIgICAgICAgIHNfdGltZXI7ICAgICAgICAvKiBzY2hlZHVsaW5n
IHRpbWVyICAgICAgICAgICAgICAgICovCiAgICAgYXRvbWljX3QgICAgICAgICAgICB1cmdlbnRf
Y291bnQ7ICAgLyogaG93IG1hbnkgdXJnZW50IHZjcHVzICAgICAgICAgICAqLwogICAgIHVuc2ln
bmVkIGludCAgICAgICAgcHJvY2Vzc29yOworICAgIGNvbnN0IGNwdW1hc2tfdCAgICAqY3B1czsg
ICAgICAgICAgIC8qIGNwdXMgY292ZXJlZCBieSB0aGlzIHN0cnVjdCAgICAgKi8KIH07CiAKICNk
ZWZpbmUgY3Vycl9vbl9jcHUoYykgICAgKGdldF9zY2hlZF9yZXMoYyktPmN1cnIpCmRpZmYgLS1n
aXQgYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oCmlu
ZGV4IDlhMTc5NjIxMzIuLjhmNGUzODliM2IgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9z
Y2hlZC5oCisrKyBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oCkBAIC0yOTMsNiArMjkzLDEyIEBA
IHN0cnVjdCBzY2hlZF91bml0IHsKICAgICAvKiBOZXh0IHVuaXQgdG8gcnVuLiAqLwogICAgIHN0
cnVjdCBzY2hlZF91bml0ICAgICAgKm5leHRfdGFzazsKICAgICBzX3RpbWVfdCAgICAgICAgICAg
ICAgICBuZXh0X3RpbWU7CisKKyAgICAvKiBOdW1iZXIgb2YgdmNwdXMgbm90IHlldCBqb2luZWQg
Zm9yIGNvbnRleHQgc3dpdGNoLiAqLworICAgIHVuc2lnbmVkIGludCAgICAgICAgICAgIHJlbmRl
enZvdXNfaW5fY250OworCisgICAgLyogTnVtYmVyIG9mIHZjcHVzIG5vdCB5ZXQgZmluaXNoZWQg
d2l0aCBjb250ZXh0IHN3aXRjaC4gKi8KKyAgICBhdG9taWNfdCAgICAgICAgICAgICAgICByZW5k
ZXp2b3VzX291dF9jbnQ7CiB9OwogCiAjZGVmaW5lIGZvcl9lYWNoX3NjaGVkX3VuaXQoZCwgZSkg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKQEAgLTY5NywxMCArNzAz
LDEwIEBAIHZvaWQgc3luY19sb2NhbF9leGVjc3RhdGUodm9pZCk7CiAKIC8qCiAgKiBDYWxsZWQg
YnkgdGhlIHNjaGVkdWxlciB0byBzd2l0Y2ggdG8gYW5vdGhlciBWQ1BVLiBUaGlzIGZ1bmN0aW9u
IG11c3QKLSAqIGNhbGwgY29udGV4dF9zYXZlZChAcHJldikgd2hlbiB0aGUgbG9jYWwgQ1BVIGlz
IG5vIGxvbmdlciBydW5uaW5nIGluCi0gKiBAcHJldidzIGNvbnRleHQsIGFuZCB0aGF0IGNvbnRl
eHQgaXMgc2F2ZWQgdG8gbWVtb3J5LiBBbHRlcm5hdGl2ZWx5LCBpZgotICogaW1wbGVtZW50aW5n
IGxhenkgY29udGV4dCBzd2l0Y2hpbmcsIGl0IHN1ZmZpY2VzIHRvIGVuc3VyZSB0aGF0IGludm9r
aW5nCi0gKiBzeW5jX3ZjcHVfZXhlY3N0YXRlKCkgd2lsbCBzd2l0Y2ggYW5kIGNvbW1pdCBAcHJl
didzIHN0YXRlLgorICogY2FsbCBzY2hlZF9jb250ZXh0X3N3aXRjaGVkKEBwcmV2LCBAbmV4dCkg
d2hlbiB0aGUgbG9jYWwgQ1BVIGlzIG5vIGxvbmdlcgorICogcnVubmluZyBpbiBAcHJldidzIGNv
bnRleHQsIGFuZCB0aGF0IGNvbnRleHQgaXMgc2F2ZWQgdG8gbWVtb3J5LgorICogQWx0ZXJuYXRp
dmVseSwgaWYgaW1wbGVtZW50aW5nIGxhenkgY29udGV4dCBzd2l0Y2hpbmcsIGl0IHN1ZmZpY2Vz
IHRvIGVuc3VyZQorICogdGhhdCBpbnZva2luZyBzeW5jX3ZjcHVfZXhlY3N0YXRlKCkgd2lsbCBz
d2l0Y2ggYW5kIGNvbW1pdCBAcHJldidzIHN0YXRlLgogICovCiB2b2lkIGNvbnRleHRfc3dpdGNo
KAogICAgIHN0cnVjdCB2Y3B1ICpwcmV2LApAQCAtNzEyLDcgKzcxOCw3IEBAIHZvaWQgY29udGV4
dF9zd2l0Y2goCiAgKiBzYXZlZCB0byBtZW1vcnkuIEFsdGVybmF0aXZlbHksIGlmIGltcGxlbWVu
dGluZyBsYXp5IGNvbnRleHQgc3dpdGNoaW5nLAogICogZW5zdXJlIHRoYXQgaW52b2tpbmcgc3lu
Y192Y3B1X2V4ZWNzdGF0ZSgpIHdpbGwgc3dpdGNoIGFuZCBjb21taXQgQHByZXYuCiAgKi8KLXZv
aWQgY29udGV4dF9zYXZlZChzdHJ1Y3QgdmNwdSAqcHJldik7Cit2b2lkIHNjaGVkX2NvbnRleHRf
c3dpdGNoZWQoc3RydWN0IHZjcHUgKnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCk7CiAKIC8qIENh
bGxlZCBieSB0aGUgc2NoZWR1bGVyIHRvIGNvbnRpbnVlIHJ1bm5pbmcgdGhlIGN1cnJlbnQgVkNQ
VS4gKi8KIHZvaWQgY29udGludWVfcnVubmluZygKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hl
bi9zb2Z0aXJxLmggYi94ZW4vaW5jbHVkZS94ZW4vc29mdGlycS5oCmluZGV4IGMzMjdjOWI2Y2Qu
LmQ3MjczYjM4OWIgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9zb2Z0aXJxLmgKKysrIGIv
eGVuL2luY2x1ZGUveGVuL3NvZnRpcnEuaApAQCAtNCw2ICs0LDcgQEAKIC8qIExvdy1sYXRlbmN5
IHNvZnRpcnFzIGNvbWUgZmlyc3QgaW4gdGhlIGZvbGxvd2luZyBsaXN0LiAqLwogZW51bSB7CiAg
ICAgVElNRVJfU09GVElSUSA9IDAsCisgICAgU0NIRURfU0xBVkVfU09GVElSUSwKICAgICBTQ0hF
RFVMRV9TT0ZUSVJRLAogICAgIE5FV19UTEJGTFVTSF9DTE9DS19QRVJJT0RfU09GVElSUSwKICAg
ICBSQ1VfU09GVElSUSwKLS0gCjIuMTYuNAoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3Rz
LnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0
aW5mby94ZW4tZGV2ZWw=

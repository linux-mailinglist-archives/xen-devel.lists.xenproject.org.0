Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 400CF14439F
	for <lists+xen-devel@lfdr.de>; Tue, 21 Jan 2020 18:52:54 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1itxfc-0004n1-Mi; Tue, 21 Jan 2020 17:50:32 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=ThP3=3K=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1itxfb-0004lo-5h
 for xen-devel@lists.xenproject.org; Tue, 21 Jan 2020 17:50:31 +0000
X-Inumbo-ID: 7e823ddc-3c76-11ea-aecd-bc764e2007e4
Received: from mga04.intel.com (unknown [192.55.52.120])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 7e823ddc-3c76-11ea-aecd-bc764e2007e4;
 Tue, 21 Jan 2020 17:50:21 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by fmsmga104.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 21 Jan 2020 09:50:09 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.70,346,1574150400"; d="scan'208";a="228929250"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.251.23.127])
 by orsmga006.jf.intel.com with ESMTP; 21 Jan 2020 09:50:07 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 21 Jan 2020 09:49:48 -0800
Message-Id: <d2a7c532b8ff412cdda102d81c114e0c642dfcbc.1579628566.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1579628566.git.tamas.lengyel@intel.com>
References: <cover.1579628566.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v5 15/18] xen/mem_sharing: VM forking
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Stefano Stabellini <sstabellini@kernel.org>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tamas K Lengyel <tamas@tklengyel.com>,
 Julien Grall <julien@xen.org>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Vk0gZm9ya2luZyBpcyB0aGUgcHJvY2VzcyBvZiBjcmVhdGluZyBhIGRvbWFpbiB3aXRoIGFuIGVt
cHR5IG1lbW9yeSBzcGFjZSBhbmQgYQpwYXJlbnQgZG9tYWluIHNwZWNpZmllZCBmcm9tIHdoaWNo
IHRvIHBvcHVsYXRlIHRoZSBtZW1vcnkgd2hlbiBuZWNlc3NhcnkuIEZvcgp0aGUgbmV3IGRvbWFp
biB0byBiZSBmdW5jdGlvbmFsIHRoZSBWTSBzdGF0ZSBpcyBjb3BpZWQgb3ZlciBhcyBwYXJ0IG9m
IHRoZSBmb3JrCm9wZXJhdGlvbiAoSFZNIHBhcmFtcywgaGFwIGFsbG9jYXRpb24sIGV0YykuCgpT
aWduZWQtb2ZmLWJ5OiBUYW1hcyBLIExlbmd5ZWwgPHRhbWFzLmxlbmd5ZWxAaW50ZWwuY29tPgot
LS0KIHhlbi9hcmNoL3g4Ni9kb21haW4uYyAgICAgICAgICAgICB8ICAgOSArKwogeGVuL2FyY2gv
eDg2L2h2bS9odm0uYyAgICAgICAgICAgIHwgICAyICstCiB4ZW4vYXJjaC94ODYvbW0vbWVtX3No
YXJpbmcuYyAgICAgfCAyMjAgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrCiB4ZW4vYXJj
aC94ODYvbW0vcDJtLmMgICAgICAgICAgICAgfCAgMTEgKy0KIHhlbi9pbmNsdWRlL2FzbS14ODYv
bWVtX3NoYXJpbmcuaCB8ICAyMCArKy0KIHhlbi9pbmNsdWRlL3B1YmxpYy9tZW1vcnkuaCAgICAg
ICB8ICAgNSArCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCAgICAgICAgICAgfCAgIDIgKwogNyBm
aWxlcyBjaGFuZ2VkLCAyNjUgaW5zZXJ0aW9ucygrKSwgNCBkZWxldGlvbnMoLSkKCmRpZmYgLS1n
aXQgYS94ZW4vYXJjaC94ODYvZG9tYWluLmMgYi94ZW4vYXJjaC94ODYvZG9tYWluLmMKaW5kZXgg
MjhmZWZhMWY4MS4uOTUzYWJjYzFmYyAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L2RvbWFpbi5j
CisrKyBiL3hlbi9hcmNoL3g4Ni9kb21haW4uYwpAQCAtMjE5OCw2ICsyMTk4LDE1IEBAIGludCBk
b21haW5fcmVsaW5xdWlzaF9yZXNvdXJjZXMoc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAgICAg
IHJldCA9IHJlbGlucXVpc2hfc2hhcmVkX3BhZ2VzKGQpOwogICAgICAgICAgICAgaWYgKCByZXQg
KQogICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CisKKyAgICAgICAgICAgIC8qCisgICAgICAg
ICAgICAgKiBJZiB0aGUgZG9tYWluIGlzIGZvcmtlZCwgZGVjcmVtZW50IHRoZSBwYXJlbnQncyBw
YXVzZSBjb3VudC4KKyAgICAgICAgICAgICAqLworICAgICAgICAgICAgaWYgKCBkLT5wYXJlbnQg
KQorICAgICAgICAgICAgeworICAgICAgICAgICAgICAgIGRvbWFpbl91bnBhdXNlKGQtPnBhcmVu
dCk7CisgICAgICAgICAgICAgICAgZC0+cGFyZW50ID0gTlVMTDsKKyAgICAgICAgICAgIH0KICAg
ICAgICAgfQogI2VuZGlmCiAKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMgYi94
ZW4vYXJjaC94ODYvaHZtL2h2bS5jCmluZGV4IGU2MGI0OTMxYmYuLjYwMTJiODg4NDUgMTAwNjQ0
Ci0tLSBhL3hlbi9hcmNoL3g4Ni9odm0vaHZtLmMKKysrIGIveGVuL2FyY2gveDg2L2h2bS9odm0u
YwpAQCAtMTkwNiw3ICsxOTA2LDcgQEAgaW50IGh2bV9oYXBfbmVzdGVkX3BhZ2VfZmF1bHQocGFk
ZHJfdCBncGEsIHVuc2lnbmVkIGxvbmcgZ2xhLAogICAgIH0KICNlbmRpZgogCi0gICAgLyogU3B1
cmlvdXMgZmF1bHQ/IFBvRCBhbmQgbG9nLWRpcnR5IGFsc28gdGFrZSB0aGlzIHBhdGguICovCisg
ICAgLyogU3B1cmlvdXMgZmF1bHQ/IFBvRCwgbG9nLWRpcnR5IGFuZCBWTSBmb3JraW5nIGFsc28g
dGFrZSB0aGlzIHBhdGguICovCiAgICAgaWYgKCBwMm1faXNfcmFtKHAybXQpICkKICAgICB7CiAg
ICAgICAgIHJjID0gMTsKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmluZy5j
IGIveGVuL2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMKaW5kZXggZTNkZGI2M2I0Zi4uNzQ5MzA1
NDE3YyAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMKKysrIGIveGVu
L2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMKQEAgLTIyLDExICsyMiwxMyBAQAogCiAjaW5jbHVk
ZSA8eGVuL3R5cGVzLmg+CiAjaW5jbHVkZSA8eGVuL2RvbWFpbl9wYWdlLmg+CisjaW5jbHVkZSA8
eGVuL2V2ZW50Lmg+CiAjaW5jbHVkZSA8eGVuL3NwaW5sb2NrLmg+CiAjaW5jbHVkZSA8eGVuL3J3
bG9jay5oPgogI2luY2x1ZGUgPHhlbi9tbS5oPgogI2luY2x1ZGUgPHhlbi9ncmFudF90YWJsZS5o
PgogI2luY2x1ZGUgPHhlbi9zY2hlZC5oPgorI2luY2x1ZGUgPHhlbi9zY2hlZC1pZi5oPgogI2lu
Y2x1ZGUgPHhlbi9yY3VwZGF0ZS5oPgogI2luY2x1ZGUgPHhlbi9ndWVzdF9hY2Nlc3MuaD4KICNp
bmNsdWRlIDx4ZW4vdm1fZXZlbnQuaD4KQEAgLTM2LDYgKzM4LDkgQEAKICNpbmNsdWRlIDxhc20v
YWx0cDJtLmg+CiAjaW5jbHVkZSA8YXNtL2F0b21pYy5oPgogI2luY2x1ZGUgPGFzbS9ldmVudC5o
PgorI2luY2x1ZGUgPGFzbS9oYXAuaD4KKyNpbmNsdWRlIDxhc20vaHZtL2h2bS5oPgorI2luY2x1
ZGUgPGFzbS9odm0vc2F2ZS5oPgogI2luY2x1ZGUgPHhzbS94c20uaD4KIAogI2luY2x1ZGUgIm1t
LWxvY2tzLmgiCkBAIC0xNDIxLDYgKzE0MjYsMTkxIEBAIHN0YXRpYyBpbmxpbmUgaW50IG1lbV9z
aGFyaW5nX2NvbnRyb2woc3RydWN0IGRvbWFpbiAqZCwgYm9vbCBlbmFibGUpCiAgICAgcmV0dXJu
IDA7CiB9CiAKKy8qCisgKiBGb3JraW5nIGEgcGFnZSBvbmx5IGdldHMgY2FsbGVkIHdoZW4gdGhl
IFZNIGZhdWx0cyBkdWUgdG8gbm8gZW50cnkgYmVpbmcKKyAqIGluIHRoZSBFUFQgZm9yIHRoZSBh
Y2Nlc3MuIERlcGVuZGluZyBvbiB0aGUgdHlwZSBvZiBhY2Nlc3Mgd2UgZWl0aGVyCisgKiBwb3B1
bGF0ZSB0aGUgcGh5c21hcCB3aXRoIGEgc2hhcmVkIGVudHJ5IGZvciByZWFkLW9ubHkgYWNjZXNz
IG9yCisgKiBmb3JrIHRoZSBwYWdlIGlmIGl0cyBhIHdyaXRlIGFjY2Vzcy4KKyAqCisgKiBUaGUg
Y2xpZW50IHAybSBpcyBhbHJlYWR5IGxvY2tlZCBzbyB3ZSBvbmx5IG5lZWQgdG8gbG9jaworICog
dGhlIHBhcmVudCdzIGhlcmUuCisgKi8KK2ludCBtZW1fc2hhcmluZ19mb3JrX3BhZ2Uoc3RydWN0
IGRvbWFpbiAqZCwgZ2ZuX3QgZ2ZuLCBib29sIHVuc2hhcmluZykKK3sKKyAgICBpbnQgcmMgPSAt
RU5PRU5UOworICAgIHNocl9oYW5kbGVfdCBoYW5kbGU7CisgICAgc3RydWN0IGRvbWFpbiAqcGFy
ZW50OworICAgIHN0cnVjdCBwMm1fZG9tYWluICpwMm07CisgICAgdW5zaWduZWQgbG9uZyBnZm5f
bCA9IGdmbl94KGdmbik7CisgICAgbWZuX3QgbWZuLCBuZXdfbWZuOworICAgIHAybV90eXBlX3Qg
cDJtdDsKKyAgICBzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlOworCisgICAgaWYgKCAhbWVtX3NoYXJp
bmdfaXNfZm9yayhkKSApCisgICAgICAgIHJldHVybiAtRU5PRU5UOworCisgICAgcGFyZW50ID0g
ZC0+cGFyZW50OworCisgICAgaWYgKCAhdW5zaGFyaW5nICkKKyAgICB7CisgICAgICAgIC8qIEZv
ciByZWFkLW9ubHkgYWNjZXNzZXMgd2UganVzdCBhZGQgYSBzaGFyZWQgZW50cnkgdG8gdGhlIHBo
eXNtYXAgKi8KKyAgICAgICAgd2hpbGUgKCBwYXJlbnQgKQorICAgICAgICB7CisgICAgICAgICAg
ICBpZiAoICEocmMgPSBub21pbmF0ZV9wYWdlKHBhcmVudCwgZ2ZuLCAwLCAmaGFuZGxlKSkgKQor
ICAgICAgICAgICAgICAgIGJyZWFrOworCisgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQtPnBh
cmVudDsKKyAgICAgICAgfQorCisgICAgICAgIGlmICggIXJjICkKKyAgICAgICAgeworICAgICAg
ICAgICAgLyogVGhlIGNsaWVudCdzIHAybSBpcyBhbHJlYWR5IGxvY2tlZCAqLworICAgICAgICAg
ICAgc3RydWN0IHAybV9kb21haW4gKnBwMm0gPSBwMm1fZ2V0X2hvc3RwMm0ocGFyZW50KTsKKwor
ICAgICAgICAgICAgcDJtX2xvY2socHAybSk7CisgICAgICAgICAgICByYyA9IGFkZF90b19waHlz
bWFwKHBhcmVudCwgZ2ZuX2wsIGhhbmRsZSwgZCwgZ2ZuX2wsIGZhbHNlKTsKKyAgICAgICAgICAg
IHAybV91bmxvY2socHAybSk7CisKKyAgICAgICAgICAgIGlmICggIXJjICkKKyAgICAgICAgICAg
ICAgICByZXR1cm4gMDsKKyAgICAgICAgfQorICAgIH0KKworICAgIC8qCisgICAgICogSWYgaXQn
cyBhIHdyaXRlIGFjY2VzcyAoaWUuIHVuc2hhcmluZykgb3IgaWYgYWRkaW5nIGEgc2hhcmVkIGVu
dHJ5IHRvCisgICAgICogdGhlIHBoeXNtYXAgZmFpbGVkIHdlJ2xsIGZvcmsgdGhlIHBhZ2UgZGly
ZWN0bHkuCisgICAgICovCisgICAgcDJtID0gcDJtX2dldF9ob3N0cDJtKGQpOworICAgIHBhcmVu
dCA9IGQtPnBhcmVudDsKKworICAgIHdoaWxlICggcGFyZW50ICkKKyAgICB7CisgICAgICAgIG1m
biA9IGdldF9nZm5fcXVlcnkocGFyZW50LCBnZm5fbCwgJnAybXQpOworCisgICAgICAgIGlmICgg
bWZuX3ZhbGlkKG1mbikgJiYgcDJtX2lzX2FueV9yYW0ocDJtdCkgKQorICAgICAgICAgICAgYnJl
YWs7CisKKyAgICAgICAgcHV0X2dmbihwYXJlbnQsIGdmbl9sKTsKKyAgICAgICAgcGFyZW50ID0g
cGFyZW50LT5wYXJlbnQ7CisgICAgfQorCisgICAgaWYgKCAhcGFyZW50ICkKKyAgICAgICAgcmV0
dXJuIC1FTk9FTlQ7CisKKyAgICBpZiAoICEocGFnZSA9IGFsbG9jX2RvbWhlYXBfcGFnZShkLCAw
KSkgKQorICAgIHsKKyAgICAgICAgcHV0X2dmbihwYXJlbnQsIGdmbl9sKTsKKyAgICAgICAgcmV0
dXJuIC1FTk9NRU07CisgICAgfQorCisgICAgbmV3X21mbiA9IHBhZ2VfdG9fbWZuKHBhZ2UpOwor
ICAgIGNvcHlfZG9tYWluX3BhZ2UobmV3X21mbiwgbWZuKTsKKyAgICBzZXRfZ3Bmbl9mcm9tX21m
bihtZm5feChuZXdfbWZuKSwgZ2ZuX2wpOworCisgICAgcHV0X2dmbihwYXJlbnQsIGdmbl9sKTsK
KworICAgIHJldHVybiBwMm0tPnNldF9lbnRyeShwMm0sIGdmbiwgbmV3X21mbiwgUEFHRV9PUkRF
Ul80SywgcDJtX3JhbV9ydywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgcDJtLT5kZWZhdWx0
X2FjY2VzcywgLTEpOworfQorCitzdGF0aWMgaW50IGJyaW5nX3VwX3ZjcHVzKHN0cnVjdCBkb21h
aW4gKmNkLCBzdHJ1Y3QgY3B1cG9vbCAqY3B1cG9vbCkKK3sKKyAgICBpbnQgcmV0OworICAgIHVu
c2lnbmVkIGludCBpOworCisgICAgaWYgKCAocmV0ID0gY3B1cG9vbF9tb3ZlX2RvbWFpbihjZCwg
Y3B1cG9vbCkpICkKKyAgICAgICAgcmV0dXJuIHJldDsKKworICAgIGZvciAoIGkgPSAwOyBpIDwg
Y2QtPm1heF92Y3B1czsgaSsrICkKKyAgICB7CisgICAgICAgIGlmICggY2QtPnZjcHVbaV0gKQor
ICAgICAgICAgICAgY29udGludWU7CisKKyAgICAgICAgaWYgKCAhdmNwdV9jcmVhdGUoY2QsIGkp
ICkKKyAgICAgICAgICAgIHJldHVybiAtRUlOVkFMOworICAgIH0KKworICAgIGRvbWFpbl91cGRh
dGVfbm9kZV9hZmZpbml0eShjZCk7CisgICAgcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgZm9y
a19oYXBfYWxsb2NhdGlvbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgZG9tYWluICpjZCkKK3sK
KyAgICBpbnQgcmM7CisgICAgYm9vbCBwcmVlbXB0ZWQ7CisgICAgdW5zaWduZWQgbG9uZyBtYiA9
IGhhcF9nZXRfYWxsb2NhdGlvbihkKTsKKworICAgIGlmICggbWIgPT0gaGFwX2dldF9hbGxvY2F0
aW9uKGNkKSApCisgICAgICAgIHJldHVybiAwOworCisgICAgcGFnaW5nX2xvY2soY2QpOworICAg
IHJjID0gaGFwX3NldF9hbGxvY2F0aW9uKGNkLCBtYiA8PCAoMjAgLSBQQUdFX1NISUZUKSwgJnBy
ZWVtcHRlZCk7CisgICAgcGFnaW5nX3VubG9jayhjZCk7CisKKyAgICBpZiAoIHJjICkKKyAgICAg
ICAgcmV0dXJuIHJjOworCisgICAgaWYgKCBwcmVlbXB0ZWQgKQorICAgICAgICByZXR1cm4gLUVS
RVNUQVJUOworCisgICAgcmV0dXJuIDA7Cit9CisKK3N0YXRpYyB2b2lkIGZvcmtfdHNjKHN0cnVj
dCBkb21haW4gKmQsIHN0cnVjdCBkb21haW4gKmNkKQoreworICAgIHVpbnQzMl90IHRzY19tb2Rl
OworICAgIHVpbnQzMl90IGd0c2Nfa2h6OworICAgIHVpbnQzMl90IGluY2FybmF0aW9uOworICAg
IHVpbnQ2NF90IGVsYXBzZWRfbnNlYzsKKworICAgIHRzY19nZXRfaW5mbyhkLCAmdHNjX21vZGUs
ICZlbGFwc2VkX25zZWMsICZndHNjX2toeiwgJmluY2FybmF0aW9uKTsKKyAgICB0c2Nfc2V0X2lu
Zm8oY2QsIHRzY19tb2RlLCBlbGFwc2VkX25zZWMsIGd0c2Nfa2h6LCBpbmNhcm5hdGlvbik7Cit9
CisKK3N0YXRpYyBpbnQgbWVtX3NoYXJpbmdfZm9yayhzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3Qg
ZG9tYWluICpjZCkKK3sKKyAgICBpbnQgcmMgPSAtRUlOVkFMOworCisgICAgaWYgKCAhY2QtPmNv
bnRyb2xsZXJfcGF1c2VfY291bnQgKQorICAgICAgICByZXR1cm4gcmM7CisKKyAgICAvKgorICAg
ICAqIFdlIG9ubHkgd2FudCB0byBwYXVzZSB0aGUgcGFyZW50IG9uY2UsIG5vdCBlYWNoIHRpbWUg
dGhpcworICAgICAqIG9wZXJhdGlvbiBpcyByZXN0YXJ0ZWQgZHVlIHRvIHByZWVtcHRpb24uCisg
ICAgICovCisgICAgaWYgKCAhY2QtPnBhcmVudF9wYXVzZWQgKQorICAgIHsKKyAgICAgICAgZG9t
YWluX3BhdXNlKGQpOworICAgICAgICBjZC0+cGFyZW50X3BhdXNlZCA9IHRydWU7CisgICAgfQor
CisgICAgY2QtPm1heF9wYWdlcyA9IGQtPm1heF9wYWdlczsKKyAgICBjZC0+bWF4X3ZjcHVzID0g
ZC0+bWF4X3ZjcHVzOworCisgICAgLyogdGhpcyBpcyBwcmVlbXB0aWJsZSBzbyBpdCdzIHRoZSBm
aXJzdCB0byBnZXQgZG9uZSAqLworICAgIGlmICggKHJjID0gZm9ya19oYXBfYWxsb2NhdGlvbihk
LCBjZCkpICkKKyAgICAgICAgZ290byBkb25lOworCisgICAgaWYgKCAocmMgPSBicmluZ191cF92
Y3B1cyhjZCwgZC0+Y3B1cG9vbCkpICkKKyAgICAgICAgZ290byBkb25lOworCisgICAgaWYgKCAo
cmMgPSBodm1fY29weV9jb250ZXh0X2FuZF9wYXJhbXMoZCwgY2QpKSApCisgICAgICAgIGdvdG8g
ZG9uZTsKKworICAgIGZvcmtfdHNjKGQsIGNkKTsKKworICAgIGNkLT5wYXJlbnQgPSBkOworCisg
ZG9uZToKKyAgICBpZiAoIHJjICYmIHJjICE9IC1FUkVTVEFSVCApCisgICAgeworICAgICAgICBk
b21haW5fdW5wYXVzZShkKTsKKyAgICAgICAgY2QtPnBhcmVudF9wYXVzZWQgPSBmYWxzZTsKKyAg
ICB9CisKKyAgICByZXR1cm4gcmM7Cit9CisKIGludCBtZW1fc2hhcmluZ19tZW1vcChYRU5fR1VF
U1RfSEFORExFX1BBUkFNKHhlbl9tZW1fc2hhcmluZ19vcF90KSBhcmcpCiB7CiAgICAgaW50IHJj
OwpAQCAtMTY3NSw2ICsxODY1LDM2IEBAIGludCBtZW1fc2hhcmluZ19tZW1vcChYRU5fR1VFU1Rf
SEFORExFX1BBUkFNKHhlbl9tZW1fc2hhcmluZ19vcF90KSBhcmcpCiAgICAgICAgIHJjID0gZGVi
dWdfZ3JlZihkLCBtc28udS5kZWJ1Zy51LmdyZWYpOwogICAgICAgICBicmVhazsKIAorICAgIGNh
c2UgWEVOTUVNX3NoYXJpbmdfb3BfZm9yazoKKyAgICB7CisgICAgICAgIHN0cnVjdCBkb21haW4g
KnBkOworCisgICAgICAgIHJjID0gLUVJTlZBTDsKKyAgICAgICAgaWYgKCBtc28udS5mb3JrLl9w
YWRbMF0gfHwgbXNvLnUuZm9yay5fcGFkWzFdIHx8CisgICAgICAgICAgICAgbXNvLnUuZm9yay5f
cGFkWzJdICkKKyAgICAgICAgICAgIGdvdG8gb3V0OworCisgICAgICAgIHJjID0gcmN1X2xvY2tf
bGl2ZV9yZW1vdGVfZG9tYWluX2J5X2lkKG1zby51LmZvcmsucGFyZW50X2RvbWFpbiwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJnBkKTsKKyAgICAgICAg
aWYgKCByYyApCisgICAgICAgICAgICBnb3RvIG91dDsKKworICAgICAgICBpZiAoICFtZW1fc2hh
cmluZ19lbmFibGVkKHBkKSApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggKHJjID0gbWVt
X3NoYXJpbmdfY29udHJvbChwZCwgdHJ1ZSkpICkKKyAgICAgICAgICAgICAgICBnb3RvIG91dDsK
KyAgICAgICAgfQorCisgICAgICAgIHJjID0gbWVtX3NoYXJpbmdfZm9yayhwZCwgZCk7CisKKyAg
ICAgICAgaWYgKCByYyA9PSAtRVJFU1RBUlQgKQorICAgICAgICAgICAgcmMgPSBoeXBlcmNhbGxf
Y3JlYXRlX2NvbnRpbnVhdGlvbihfX0hZUEVSVklTT1JfbWVtb3J5X29wLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGgiLCBYRU5NRU1fc2hhcmluZ19v
cCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnKTsK
KyAgICAgICAgcmN1X3VubG9ja19kb21haW4ocGQpOworICAgICAgICBicmVhazsKKyAgICB9CisK
ICAgICBkZWZhdWx0OgogICAgICAgICByYyA9IC1FTk9TWVM7CiAgICAgICAgIGJyZWFrOwpkaWZm
IC0tZ2l0IGEveGVuL2FyY2gveDg2L21tL3AybS5jIGIveGVuL2FyY2gveDg2L21tL3AybS5jCmlu
ZGV4IDQzZGQ0NmEzMmYuLmM3M2Y1YWVmYmIgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9tbS9w
Mm0uYworKysgYi94ZW4vYXJjaC94ODYvbW0vcDJtLmMKQEAgLTUwOCw2ICs1MDgsMTQgQEAgbWZu
X3QgX19nZXRfZ2ZuX3R5cGVfYWNjZXNzKHN0cnVjdCBwMm1fZG9tYWluICpwMm0sIHVuc2lnbmVk
IGxvbmcgZ2ZuX2wsCiAKICAgICBtZm4gPSBwMm0tPmdldF9lbnRyeShwMm0sIGdmbiwgdCwgYSwg
cSwgcGFnZV9vcmRlciwgTlVMTCk7CiAKKyAgICAvKiBDaGVjayBpZiB3ZSBuZWVkIHRvIGZvcmsg
dGhlIHBhZ2UgKi8KKyAgICBpZiAoIChxICYgUDJNX0FMTE9DKSAmJiBwMm1faXNfaG9sZSgqdCkg
JiYKKyAgICAgICAgICFtZW1fc2hhcmluZ19mb3JrX3BhZ2UocDJtLT5kb21haW4sIGdmbiwgISEo
cSAmIFAyTV9VTlNIQVJFKSkgKQorICAgIHsKKyAgICAgICAgbWZuID0gcDJtLT5nZXRfZW50cnko
cDJtLCBnZm4sIHQsIGEsIHEsIHBhZ2Vfb3JkZXIsIE5VTEwpOworICAgIH0KKworICAgIC8qIENo
ZWNrIGlmIHdlIG5lZWQgdG8gdW5zaGFyZSB0aGUgcGFnZSAqLwogICAgIGlmICggKHEgJiBQMk1f
VU5TSEFSRSkgJiYgcDJtX2lzX3NoYXJlZCgqdCkgKQogICAgIHsKICAgICAgICAgQVNTRVJUKHAy
bV9pc19ob3N0cDJtKHAybSkpOwpAQCAtNTg1LDcgKzU5Myw4IEBAIHN0cnVjdCBwYWdlX2luZm8g
KnAybV9nZXRfcGFnZV9mcm9tX2dmbigKICAgICAgICAgICAgIHJldHVybiBwYWdlOwogCiAgICAg
ICAgIC8qIEVycm9yIHBhdGg6IG5vdCBhIHN1aXRhYmxlIEdGTiBhdCBhbGwgKi8KLSAgICAgICAg
aWYgKCAhcDJtX2lzX3JhbSgqdCkgJiYgIXAybV9pc19wYWdpbmcoKnQpICYmICFwMm1faXNfcG9k
KCp0KSApCisgICAgICAgIGlmICggIXAybV9pc19yYW0oKnQpICYmICFwMm1faXNfcGFnaW5nKCp0
KSAmJiAhcDJtX2lzX3BvZCgqdCkgJiYKKyAgICAgICAgICAgICAhbWVtX3NoYXJpbmdfaXNfZm9y
ayhwMm0tPmRvbWFpbikgKQogICAgICAgICAgICAgcmV0dXJuIE5VTEw7CiAgICAgfQogCmRpZmYg
LS1naXQgYS94ZW4vaW5jbHVkZS9hc20teDg2L21lbV9zaGFyaW5nLmggYi94ZW4vaW5jbHVkZS9h
c20teDg2L21lbV9zaGFyaW5nLmgKaW5kZXggNTM3NjBhMjg5Ni4uODEyMTcxMjg0ZiAxMDA2NDQK
LS0tIGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oCisrKyBiL3hlbi9pbmNsdWRl
L2FzbS14ODYvbWVtX3NoYXJpbmcuaApAQCAtMjYsOCArMjYsNyBAQAogCiAjaWZkZWYgQ09ORklH
X01FTV9TSEFSSU5HCiAKLXN0cnVjdCBtZW1fc2hhcmluZ19kb21haW4KLXsKK3N0cnVjdCBtZW1f
c2hhcmluZ19kb21haW4gewogICAgIGJvb2wgZW5hYmxlZDsKIAogICAgIC8qCkBAIC0zOSw2ICsz
OCw5IEBAIHN0cnVjdCBtZW1fc2hhcmluZ19kb21haW4KIAogI2RlZmluZSBtZW1fc2hhcmluZ19l
bmFibGVkKGQpICgoZCktPmFyY2guaHZtLm1lbV9zaGFyaW5nLmVuYWJsZWQpCiAKKyNkZWZpbmUg
bWVtX3NoYXJpbmdfaXNfZm9yayhkKSBcCisgICAgKG1lbV9zaGFyaW5nX2VuYWJsZWQoZCkgJiYg
ISEoKGQpLT5wYXJlbnQpKQorCiAvKiBBdWRpdGluZyBvZiBtZW1vcnkgc2hhcmluZyBjb2RlPyAq
LwogI2lmbmRlZiBOREVCVUcKICNkZWZpbmUgTUVNX1NIQVJJTkdfQVVESVQgMQpAQCAtODgsNiAr
OTAsOSBAQCBzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ191bnNoYXJlX3BhZ2Uoc3RydWN0
IGRvbWFpbiAqZCwKICAgICByZXR1cm4gcmM7CiB9CiAKK2ludCBtZW1fc2hhcmluZ19mb3JrX3Bh
Z2Uoc3RydWN0IGRvbWFpbiAqZCwgZ2ZuX3QgZ2ZuLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICBib29sIHVuc2hhcmluZyk7CisKIC8qCiAgKiBJZiBjYWxsZWQgYnkgYSBmb3JlaWduIGRvbWFp
biwgcG9zc2libGUgZXJyb3JzIGFyZQogICogICAtRUJVU1kgLT4gcmluZyBmdWxsCkBAIC0xMTcs
NiArMTIyLDcgQEAgaW50IHJlbGlucXVpc2hfc2hhcmVkX3BhZ2VzKHN0cnVjdCBkb21haW4gKmQp
OwogI2Vsc2UKIAogI2RlZmluZSBtZW1fc2hhcmluZ19lbmFibGVkKGQpIGZhbHNlCisjZGVmaW5l
IG1lbV9zaGFyaW5nX2lzX2ZvcmsocDJtKSBmYWxzZQogCiBzdGF0aWMgaW5saW5lIHVuc2lnbmVk
IGludCBtZW1fc2hhcmluZ19nZXRfbnJfc2F2ZWRfbWZucyh2b2lkKQogewpAQCAtMTQxLDYgKzE0
NywxNiBAQCBzdGF0aWMgaW5saW5lIGludCBtZW1fc2hhcmluZ19ub3RpZnlfZW5vbWVtKHN0cnVj
dCBkb21haW4gKmQsIHVuc2lnbmVkIGxvbmcgZ2ZuLAogICAgIHJldHVybiAtRU9QTk9UU1VQUDsK
IH0KIAorc3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfZm9yayhzdHJ1Y3QgZG9tYWluICpk
LCBzdHJ1Y3QgZG9tYWluICpjZCwgYm9vbCB2Y3B1KQoreworICAgIHJldHVybiAtRU9QTk9UU1VQ
UDsKK30KKworc3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfZm9ya19wYWdlKHN0cnVjdCBk
b21haW4gKmQsIGdmbl90IGdmbiwgYm9vbCBsb2NrKQoreworICAgIHJldHVybiAtRU9QTk9UU1VQ
UDsKK30KKwogI2VuZGlmCiAKICNlbmRpZiAvKiBfX01FTV9TSEFSSU5HX0hfXyAqLwpkaWZmIC0t
Z2l0IGEveGVuL2luY2x1ZGUvcHVibGljL21lbW9yeS5oIGIveGVuL2luY2x1ZGUvcHVibGljL21l
bW9yeS5oCmluZGV4IGNmZGRhNmUyYTguLjkwYTNmNDQ5OGUgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNs
dWRlL3B1YmxpYy9tZW1vcnkuaAorKysgYi94ZW4vaW5jbHVkZS9wdWJsaWMvbWVtb3J5LmgKQEAg
LTQ4Miw2ICs0ODIsNyBAQCBERUZJTkVfWEVOX0dVRVNUX0hBTkRMRSh4ZW5fbWVtX2FjY2Vzc19v
cF90KTsKICNkZWZpbmUgWEVOTUVNX3NoYXJpbmdfb3BfYWRkX3BoeXNtYXAgICAgICAgNgogI2Rl
ZmluZSBYRU5NRU1fc2hhcmluZ19vcF9hdWRpdCAgICAgICAgICAgICA3CiAjZGVmaW5lIFhFTk1F
TV9zaGFyaW5nX29wX3JhbmdlX3NoYXJlICAgICAgIDgKKyNkZWZpbmUgWEVOTUVNX3NoYXJpbmdf
b3BfZm9yayAgICAgICAgICAgICAgOQogCiAjZGVmaW5lIFhFTk1FTV9TSEFSSU5HX09QX1NfSEFO
RExFX0lOVkFMSUQgICgtMTApCiAjZGVmaW5lIFhFTk1FTV9TSEFSSU5HX09QX0NfSEFORExFX0lO
VkFMSUQgICgtOSkKQEAgLTUzMiw2ICs1MzMsMTAgQEAgc3RydWN0IHhlbl9tZW1fc2hhcmluZ19v
cCB7CiAgICAgICAgICAgICAgICAgdWludDMyX3QgZ3JlZjsgICAgIC8qIElOOiBncmVmIHRvIGRl
YnVnICAgICAgICAgKi8KICAgICAgICAgICAgIH0gdTsKICAgICAgICAgfSBkZWJ1ZzsKKyAgICAg
ICAgc3RydWN0IG1lbV9zaGFyaW5nX29wX2ZvcmsgeworICAgICAgICAgICAgZG9taWRfdCBwYXJl
bnRfZG9tYWluOworICAgICAgICAgICAgdWludDE2X3QgX3BhZFszXTsgICAgICAgICAgICAgICAg
LyogTXVzdCBiZSBzZXQgdG8gMCAqLworICAgICAgICB9IGZvcms7CiAgICAgfSB1OwogfTsKIHR5
cGVkZWYgc3RydWN0IHhlbl9tZW1fc2hhcmluZ19vcCB4ZW5fbWVtX3NoYXJpbmdfb3BfdDsKZGlm
ZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVk
LmgKaW5kZXggY2M5NDJhMzYyMS4uNjdkNDRlMjE5YyAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUv
eGVuL3NjaGVkLmgKKysrIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKQEAgLTUwNCw2ICs1MDQs
OCBAQCBzdHJ1Y3QgZG9tYWluCiAgICAgLyogTWVtb3J5IHNoYXJpbmcgc3VwcG9ydCAqLwogI2lm
ZGVmIENPTkZJR19NRU1fU0hBUklORwogICAgIHN0cnVjdCB2bV9ldmVudF9kb21haW4gKnZtX2V2
ZW50X3NoYXJlOworICAgIHN0cnVjdCBkb21haW4gKnBhcmVudDsgLyogVk0gZm9yayBwYXJlbnQg
Ki8KKyAgICBib29sIHBhcmVudF9wYXVzZWQ7CiAjZW5kaWYKICAgICAvKiBNZW1vcnkgcGFnaW5n
IHN1cHBvcnQgKi8KICNpZmRlZiBDT05GSUdfSEFTX01FTV9QQUdJTkcKLS0gCjIuMjAuMQoKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBt
YWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMu
eGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 4F1A41667A
	for <lists+xen-devel@lfdr.de>; Tue,  7 May 2019 17:17:38 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hO1oe-0007Z3-FI; Tue, 07 May 2019 15:15:36 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=qCYz=TH=arm.com=julien.grall@srs-us1.protection.inumbo.net>)
 id 1hO1oc-0007WE-VI
 for xen-devel@lists.xenproject.org; Tue, 07 May 2019 15:15:35 +0000
X-Inumbo-ID: f50b4400-70da-11e9-843c-bc764e045a96
Received: from foss.arm.com (unknown [217.140.101.70])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTP
 id f50b4400-70da-11e9-843c-bc764e045a96;
 Tue, 07 May 2019 15:15:32 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.72.51.249])
 by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id A77F91682;
 Tue,  7 May 2019 08:15:32 -0700 (PDT)
Received: from e108454-lin.cambridge.arm.com (e108454-lin.cambridge.arm.com
 [10.1.196.50])
 by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id 741453F5AF;
 Tue,  7 May 2019 08:15:31 -0700 (PDT)
From: Julien Grall <julien.grall@arm.com>
To: xen-devel@lists.xenproject.org
Date: Tue,  7 May 2019 16:14:56 +0100
Message-Id: <20190507151458.29350-13-julien.grall@arm.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <20190507151458.29350-1-julien.grall@arm.com>
References: <20190507151458.29350-1-julien.grall@arm.com>
Subject: [Xen-devel] [PATCH 12/14] xen/x86: pv: Convert update_intpte() to
 use typesafe MFN
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Julien Grall <julien.grall@arm.com>, Wei Liu <wei.liu2@citrix.com>,
 Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhlIHRoaXJkIHBhcmFtZXRlciBvZiB1cGRhdGVfaW50cHRlKCkgaXMgYSBNRk4sIHNvIGl0IGNh
biBiZSBzd2l0Y2hlZAp0byB1c2UgdGhlIHR5cGVzYWZlLgoKQXQgdGhlIHNhbWUgdGltZSwgdGhl
IHR5cGVzYWZlIGlzIHByb3BhZ2F0ZWQgYXMgZmFyIGFzIHBvc3NpYmxlIHdpdGhvdXQKbWFqb3Ig
bW9kaWZpY2F0aW9ucy4KClNpZ25lZC1vZmYtYnk6IEp1bGllbiBHcmFsbCA8anVsaWVuLmdyYWxs
QGFybS5jb20+CgotLS0KICAgIENoYW5nZXMgaW4gdjI6CiAgICAgICAgLSBQYXRjaCBhZGRlZAot
LS0KIHhlbi9hcmNoL3g4Ni9tbS5jICAgICAgICAgICAgICAgfCA4NCArKysrKysrKysrKysrKysr
KysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLQogeGVuL2FyY2gveDg2L3B2L2dyYW50X3RhYmxlLmMg
ICB8ICA2ICstLQogeGVuL2FyY2gveDg2L3B2L21tLmggICAgICAgICAgICB8ICA2ICstLQogeGVu
L2FyY2gveDg2L3B2L3JvLXBhZ2UtZmF1bHQuYyB8ICAyICstCiA0IGZpbGVzIGNoYW5nZWQsIDQ5
IGluc2VydGlvbnMoKyksIDQ5IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4
Ni9tbS5jIGIveGVuL2FyY2gveDg2L21tLmMKaW5kZXggNTcwZTFlMGRlYi4uN2Q4ODdmMjY5OSAx
MDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L21tLmMKKysrIGIveGVuL2FyY2gveDg2L21tLmMKQEAg
LTIwODAsNyArMjA4MCw3IEBAIHZvaWQgcGFnZV91bmxvY2soc3RydWN0IHBhZ2VfaW5mbyAqcGFn
ZSkKIAogLyogVXBkYXRlIHRoZSBMMSBlbnRyeSBhdCBwbDFlIHRvIG5ldyB2YWx1ZSBubDFlLiAq
Lwogc3RhdGljIGludCBtb2RfbDFfZW50cnkobDFfcGdlbnRyeV90ICpwbDFlLCBsMV9wZ2VudHJ5
X3QgbmwxZSwKLSAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGxvbmcgZ2wxbWZuLCB1
bnNpZ25lZCBpbnQgY21kLAorICAgICAgICAgICAgICAgICAgICAgICAgbWZuX3QgZ2wxbWZuLCB1
bnNpZ25lZCBpbnQgY21kLAogICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHZjcHUgKnB0
X3ZjcHUsIHN0cnVjdCBkb21haW4gKnBnX2RvbSkKIHsKICAgICBib29sIHByZXNlcnZlX2FkID0g
KGNtZCA9PSBNTVVfUFRfVVBEQVRFX1BSRVNFUlZFX0FEKTsKQEAgLTIxNzcsOCArMjE3Nyw4IEBA
IHN0YXRpYyBpbnQgbW9kX2wxX2VudHJ5KGwxX3BnZW50cnlfdCAqcGwxZSwgbDFfcGdlbnRyeV90
IG5sMWUsCiAgICAgfQogICAgIGVsc2UgaWYgKCBwdl9sMXRmX2NoZWNrX2wxZShwdF9kb20sIG5s
MWUpICkKICAgICAgICAgcmV0dXJuIC1FUkVTVEFSVDsKLSAgICBlbHNlIGlmICggdW5saWtlbHko
IVVQREFURV9FTlRSWShsMSwgcGwxZSwgb2wxZSwgbmwxZSwgZ2wxbWZuLCBwdF92Y3B1LAotICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNlcnZlX2FkKSkgKQorICAgIGVs
c2UgaWYgKCB1bmxpa2VseSghVVBEQVRFX0VOVFJZKGwxLCBwbDFlLCBvbDFlLCBubDFlLCBnbDFt
Zm4sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHRfdmNwdSwgcHJlc2Vy
dmVfYWQpKSApCiAgICAgewogICAgICAgICByZXR1cm4gLUVCVVNZOwogICAgIH0KQEAgLTIxODgs
MTYgKzIxODgsMTYgQEAgc3RhdGljIGludCBtb2RfbDFfZW50cnkobDFfcGdlbnRyeV90ICpwbDFl
LCBsMV9wZ2VudHJ5X3QgbmwxZSwKIH0KIAogCi0vKiBVcGRhdGUgdGhlIEwyIGVudHJ5IGF0IHBs
MmUgdG8gbmV3IHZhbHVlIG5sMmUuIHBsMmUgaXMgd2l0aGluIGZyYW1lIHBmbi4gKi8KKy8qIFVw
ZGF0ZSB0aGUgTDIgZW50cnkgYXQgcGwyZSB0byBuZXcgdmFsdWUgbmwyZS4gcGwyZSBpcyB3aXRo
aW4gZnJhbWUgbWZuLiAqLwogc3RhdGljIGludCBtb2RfbDJfZW50cnkobDJfcGdlbnRyeV90ICpw
bDJlLAogICAgICAgICAgICAgICAgICAgICAgICAgbDJfcGdlbnRyeV90IG5sMmUsCi0gICAgICAg
ICAgICAgICAgICAgICAgICB1bnNpZ25lZCBsb25nIHBmbiwKKyAgICAgICAgICAgICAgICAgICAg
ICAgIG1mbl90IG1mbiwKICAgICAgICAgICAgICAgICAgICAgICAgIGludCBwcmVzZXJ2ZV9hZCwK
ICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCB2Y3B1ICp2Y3B1KQogewogICAgIGwyX3Bn
ZW50cnlfdCBvbDJlOwogICAgIHN0cnVjdCBkb21haW4gKmQgPSB2Y3B1LT5kb21haW47Ci0gICAg
c3RydWN0IHBhZ2VfaW5mbyAqbDJwZyA9IG1mbl90b19wYWdlKF9tZm4ocGZuKSk7CisgICAgc3Ry
dWN0IHBhZ2VfaW5mbyAqbDJwZyA9IG1mbl90b19wYWdlKG1mbik7CiAgICAgdW5zaWduZWQgbG9u
ZyB0eXBlID0gbDJwZy0+dS5pbnVzZS50eXBlX2luZm87CiAgICAgaW50IHJjID0gMDsKIApAQCAt
MjIyNCwxNiArMjIyNCwxNiBAQCBzdGF0aWMgaW50IG1vZF9sMl9lbnRyeShsMl9wZ2VudHJ5X3Qg
KnBsMmUsCiAgICAgICAgIGlmICggIWwyZV9oYXNfY2hhbmdlZChvbDJlLCBubDJlLCB+RkFTVFBB
VEhfRkxBR19XSElURUxJU1QpICkKICAgICAgICAgewogICAgICAgICAgICAgbmwyZSA9IGFkanVz
dF9ndWVzdF9sMmUobmwyZSwgZCk7Ci0gICAgICAgICAgICBpZiAoIFVQREFURV9FTlRSWShsMiwg
cGwyZSwgb2wyZSwgbmwyZSwgcGZuLCB2Y3B1LCBwcmVzZXJ2ZV9hZCkgKQorICAgICAgICAgICAg
aWYgKCBVUERBVEVfRU5UUlkobDIsIHBsMmUsIG9sMmUsIG5sMmUsIG1mbiwgdmNwdSwgcHJlc2Vy
dmVfYWQpICkKICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgIHJldHVybiAt
RUJVU1k7CiAgICAgICAgIH0KIAotICAgICAgICBpZiAoIHVubGlrZWx5KChyYyA9IGdldF9wYWdl
X2Zyb21fbDJlKG5sMmUsIHBmbiwgZCwgMCkpIDwgMCkgKQorICAgICAgICBpZiAoIHVubGlrZWx5
KChyYyA9IGdldF9wYWdlX2Zyb21fbDJlKG5sMmUsIG1mbl94KG1mbiksIGQsIDApKSA8IDApICkK
ICAgICAgICAgICAgIHJldHVybiByYzsKIAogICAgICAgICBubDJlID0gYWRqdXN0X2d1ZXN0X2wy
ZShubDJlLCBkKTsKLSAgICAgICAgaWYgKCB1bmxpa2VseSghVVBEQVRFX0VOVFJZKGwyLCBwbDJl
LCBvbDJlLCBubDJlLCBwZm4sIHZjcHUsCisgICAgICAgIGlmICggdW5saWtlbHkoIVVQREFURV9F
TlRSWShsMiwgcGwyZSwgb2wyZSwgbmwyZSwgbWZuLCB2Y3B1LAogICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgcHJlc2VydmVfYWQpKSApCiAgICAgICAgIHsKICAgICAgICAgICAg
IG9sMmUgPSBubDJlOwpAQCAtMjI0MiwyMSArMjI0MiwyMSBAQCBzdGF0aWMgaW50IG1vZF9sMl9l
bnRyeShsMl9wZ2VudHJ5X3QgKnBsMmUsCiAgICAgfQogICAgIGVsc2UgaWYgKCBwdl9sMXRmX2No
ZWNrX2wyZShkLCBubDJlKSApCiAgICAgICAgIHJldHVybiAtRVJFU1RBUlQ7Ci0gICAgZWxzZSBp
ZiAoIHVubGlrZWx5KCFVUERBVEVfRU5UUlkobDIsIHBsMmUsIG9sMmUsIG5sMmUsIHBmbiwgdmNw
dSwKKyAgICBlbHNlIGlmICggdW5saWtlbHkoIVVQREFURV9FTlRSWShsMiwgcGwyZSwgb2wyZSwg
bmwyZSwgbWZuLCB2Y3B1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBy
ZXNlcnZlX2FkKSkgKQogICAgIHsKICAgICAgICAgcmV0dXJuIC1FQlVTWTsKICAgICB9CiAKLSAg
ICBwdXRfcGFnZV9mcm9tX2wyZShvbDJlLCBwZm4sIDAsIHRydWUpOworICAgIHB1dF9wYWdlX2Zy
b21fbDJlKG9sMmUsIG1mbl94KG1mbiksIDAsIHRydWUpOwogCiAgICAgcmV0dXJuIHJjOwogfQog
Ci0vKiBVcGRhdGUgdGhlIEwzIGVudHJ5IGF0IHBsM2UgdG8gbmV3IHZhbHVlIG5sM2UuIHBsM2Ug
aXMgd2l0aGluIGZyYW1lIHBmbi4gKi8KKy8qIFVwZGF0ZSB0aGUgTDMgZW50cnkgYXQgcGwzZSB0
byBuZXcgdmFsdWUgbmwzZS4gcGwzZSBpcyB3aXRoaW4gZnJhbWUgbWZuLiAqLwogc3RhdGljIGlu
dCBtb2RfbDNfZW50cnkobDNfcGdlbnRyeV90ICpwbDNlLAogICAgICAgICAgICAgICAgICAgICAg
ICAgbDNfcGdlbnRyeV90IG5sM2UsCi0gICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBs
b25nIHBmbiwKKyAgICAgICAgICAgICAgICAgICAgICAgIG1mbl90IG1mbiwKICAgICAgICAgICAg
ICAgICAgICAgICAgIGludCBwcmVzZXJ2ZV9hZCwKICAgICAgICAgICAgICAgICAgICAgICAgIHN0
cnVjdCB2Y3B1ICp2Y3B1KQogewpAQCAtMjI4NywxNyArMjI4NywxNyBAQCBzdGF0aWMgaW50IG1v
ZF9sM19lbnRyeShsM19wZ2VudHJ5X3QgKnBsM2UsCiAgICAgICAgIGlmICggIWwzZV9oYXNfY2hh
bmdlZChvbDNlLCBubDNlLCB+RkFTVFBBVEhfRkxBR19XSElURUxJU1QpICkKICAgICAgICAgewog
ICAgICAgICAgICAgbmwzZSA9IGFkanVzdF9ndWVzdF9sM2UobmwzZSwgZCk7Ci0gICAgICAgICAg
ICByYyA9IFVQREFURV9FTlRSWShsMywgcGwzZSwgb2wzZSwgbmwzZSwgcGZuLCB2Y3B1LCBwcmVz
ZXJ2ZV9hZCk7CisgICAgICAgICAgICByYyA9IFVQREFURV9FTlRSWShsMywgcGwzZSwgb2wzZSwg
bmwzZSwgbWZuLCB2Y3B1LCBwcmVzZXJ2ZV9hZCk7CiAgICAgICAgICAgICByZXR1cm4gcmMgPyAw
IDogLUVGQVVMVDsKICAgICAgICAgfQogCi0gICAgICAgIHJjID0gZ2V0X3BhZ2VfZnJvbV9sM2Uo
bmwzZSwgcGZuLCBkLCAwKTsKKyAgICAgICAgcmMgPSBnZXRfcGFnZV9mcm9tX2wzZShubDNlLCBt
Zm5feChtZm4pLCBkLCAwKTsKICAgICAgICAgaWYgKCB1bmxpa2VseShyYyA8IDApICkKICAgICAg
ICAgICAgIHJldHVybiByYzsKICAgICAgICAgcmMgPSAwOwogCiAgICAgICAgIG5sM2UgPSBhZGp1
c3RfZ3Vlc3RfbDNlKG5sM2UsIGQpOwotICAgICAgICBpZiAoIHVubGlrZWx5KCFVUERBVEVfRU5U
UlkobDMsIHBsM2UsIG9sM2UsIG5sM2UsIHBmbiwgdmNwdSwKKyAgICAgICAgaWYgKCB1bmxpa2Vs
eSghVVBEQVRFX0VOVFJZKGwzLCBwbDNlLCBvbDNlLCBubDNlLCBtZm4sIHZjcHUsCiAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVzZXJ2ZV9hZCkpICkKICAgICAgICAgewog
ICAgICAgICAgICAgb2wzZSA9IG5sM2U7CkBAIC0yMzA2LDcgKzIzMDYsNyBAQCBzdGF0aWMgaW50
IG1vZF9sM19lbnRyeShsM19wZ2VudHJ5X3QgKnBsM2UsCiAgICAgfQogICAgIGVsc2UgaWYgKCBw
dl9sMXRmX2NoZWNrX2wzZShkLCBubDNlKSApCiAgICAgICAgIHJldHVybiAtRVJFU1RBUlQ7Ci0g
ICAgZWxzZSBpZiAoIHVubGlrZWx5KCFVUERBVEVfRU5UUlkobDMsIHBsM2UsIG9sM2UsIG5sM2Us
IHBmbiwgdmNwdSwKKyAgICBlbHNlIGlmICggdW5saWtlbHkoIVVQREFURV9FTlRSWShsMywgcGwz
ZSwgb2wzZSwgbmwzZSwgbWZuLCB2Y3B1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHByZXNlcnZlX2FkKSkgKQogICAgIHsKICAgICAgICAgcmV0dXJuIC1FRkFVTFQ7CkBA
IC0yMzE2LDE0ICsyMzE2LDE0IEBAIHN0YXRpYyBpbnQgbW9kX2wzX2VudHJ5KGwzX3BnZW50cnlf
dCAqcGwzZSwKICAgICAgICAgaWYgKCAhY3JlYXRlX3BhZV94ZW5fbWFwcGluZ3MoZCwgcGwzZSkg
KQogICAgICAgICAgICAgQlVHKCk7CiAKLSAgICBwdXRfcGFnZV9mcm9tX2wzZShvbDNlLCBwZm4s
IDAsIDEpOworICAgIHB1dF9wYWdlX2Zyb21fbDNlKG9sM2UsIG1mbl94KG1mbiksIDAsIDEpOwog
ICAgIHJldHVybiByYzsKIH0KIAotLyogVXBkYXRlIHRoZSBMNCBlbnRyeSBhdCBwbDRlIHRvIG5l
dyB2YWx1ZSBubDRlLiBwbDRlIGlzIHdpdGhpbiBmcmFtZSBwZm4uICovCisvKiBVcGRhdGUgdGhl
IEw0IGVudHJ5IGF0IHBsNGUgdG8gbmV3IHZhbHVlIG5sNGUuIHBsNGUgaXMgd2l0aGluIGZyYW1l
IG1mbi4gKi8KIHN0YXRpYyBpbnQgbW9kX2w0X2VudHJ5KGw0X3BnZW50cnlfdCAqcGw0ZSwKICAg
ICAgICAgICAgICAgICAgICAgICAgIGw0X3BnZW50cnlfdCBubDRlLAotICAgICAgICAgICAgICAg
ICAgICAgICAgdW5zaWduZWQgbG9uZyBwZm4sCisgICAgICAgICAgICAgICAgICAgICAgICBtZm5f
dCBtZm4sCiAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgcHJlc2VydmVfYWQsCiAgICAgICAg
ICAgICAgICAgICAgICAgICBzdHJ1Y3QgdmNwdSAqdmNwdSkKIHsKQEAgLTIzNTQsMTcgKzIzNTQs
MTcgQEAgc3RhdGljIGludCBtb2RfbDRfZW50cnkobDRfcGdlbnRyeV90ICpwbDRlLAogICAgICAg
ICBpZiAoICFsNGVfaGFzX2NoYW5nZWQob2w0ZSwgbmw0ZSwgfkZBU1RQQVRIX0ZMQUdfV0hJVEVM
SVNUKSApCiAgICAgICAgIHsKICAgICAgICAgICAgIG5sNGUgPSBhZGp1c3RfZ3Vlc3RfbDRlKG5s
NGUsIGQpOwotICAgICAgICAgICAgcmMgPSBVUERBVEVfRU5UUlkobDQsIHBsNGUsIG9sNGUsIG5s
NGUsIHBmbiwgdmNwdSwgcHJlc2VydmVfYWQpOworICAgICAgICAgICAgcmMgPSBVUERBVEVfRU5U
UlkobDQsIHBsNGUsIG9sNGUsIG5sNGUsIG1mbiwgdmNwdSwgcHJlc2VydmVfYWQpOwogICAgICAg
ICAgICAgcmV0dXJuIHJjID8gMCA6IC1FRkFVTFQ7CiAgICAgICAgIH0KIAotICAgICAgICByYyA9
IGdldF9wYWdlX2Zyb21fbDRlKG5sNGUsIHBmbiwgZCwgMCk7CisgICAgICAgIHJjID0gZ2V0X3Bh
Z2VfZnJvbV9sNGUobmw0ZSwgbWZuX3gobWZuKSwgZCwgMCk7CiAgICAgICAgIGlmICggdW5saWtl
bHkocmMgPCAwKSApCiAgICAgICAgICAgICByZXR1cm4gcmM7CiAgICAgICAgIHJjID0gMDsKIAog
ICAgICAgICBubDRlID0gYWRqdXN0X2d1ZXN0X2w0ZShubDRlLCBkKTsKLSAgICAgICAgaWYgKCB1
bmxpa2VseSghVVBEQVRFX0VOVFJZKGw0LCBwbDRlLCBvbDRlLCBubDRlLCBwZm4sIHZjcHUsCisg
ICAgICAgIGlmICggdW5saWtlbHkoIVVQREFURV9FTlRSWShsNCwgcGw0ZSwgb2w0ZSwgbmw0ZSwg
bWZuLCB2Y3B1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2VydmVf
YWQpKSApCiAgICAgICAgIHsKICAgICAgICAgICAgIG9sNGUgPSBubDRlOwpAQCAtMjM3MywxMyAr
MjM3MywxMyBAQCBzdGF0aWMgaW50IG1vZF9sNF9lbnRyeShsNF9wZ2VudHJ5X3QgKnBsNGUsCiAg
ICAgfQogICAgIGVsc2UgaWYgKCBwdl9sMXRmX2NoZWNrX2w0ZShkLCBubDRlKSApCiAgICAgICAg
IHJldHVybiAtRVJFU1RBUlQ7Ci0gICAgZWxzZSBpZiAoIHVubGlrZWx5KCFVUERBVEVfRU5UUlko
bDQsIHBsNGUsIG9sNGUsIG5sNGUsIHBmbiwgdmNwdSwKKyAgICBlbHNlIGlmICggdW5saWtlbHko
IVVQREFURV9FTlRSWShsNCwgcGw0ZSwgb2w0ZSwgbmw0ZSwgbWZuLCB2Y3B1LAogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNlcnZlX2FkKSkgKQogICAgIHsKICAgICAg
ICAgcmV0dXJuIC1FRkFVTFQ7CiAgICAgfQogCi0gICAgcHV0X3BhZ2VfZnJvbV9sNGUob2w0ZSwg
cGZuLCAwLCAxKTsKKyAgICBwdXRfcGFnZV9mcm9tX2w0ZShvbDRlLCBtZm5feChtZm4pLCAwLCAx
KTsKICAgICByZXR1cm4gcmM7CiB9CiAjZW5kaWYgLyogQ09ORklHX1BWICovCkBAIC0zMDgzLDcg
KzMwODMsNyBAQCBpbnQgbmV3X2d1ZXN0X2NyMyhtZm5fdCBtZm4pCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgIGw0ZV9mcm9tX21mbihtZm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAoX1BBR0VfUFJFU0VOVCB8IF9QQUdFX1JXIHwKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBfUEFHRV9VU0VSIHwgX1BBR0VfQUNDRVNTRUQpKSwKLSAg
ICAgICAgICAgICAgICAgICAgICAgICAgbWZuX3goZ3RfbWZuKSwgMCwgY3Vycik7CisgICAgICAg
ICAgICAgICAgICAgICAgICAgIGd0X21mbiwgMCwgY3Vycik7CiAgICAgICAgIHVubWFwX2RvbWFp
bl9wYWdlKHBsNGUpOwogICAgICAgICBzd2l0Y2ggKCByYyApCiAgICAgICAgIHsKQEAgLTM3NTIs
MTIgKzM3NTIsMTIgQEAgbG9uZyBkb19tbXVfdXBkYXRlKAogewogICAgIHN0cnVjdCBtbXVfdXBk
YXRlIHJlcTsKICAgICB2b2lkICp2YSA9IE5VTEw7Ci0gICAgdW5zaWduZWQgbG9uZyBncGZuLCBn
bWZuLCBtZm47CisgICAgdW5zaWduZWQgbG9uZyBncGZuLCBnbWZuOwogICAgIHN0cnVjdCBwYWdl
X2luZm8gKnBhZ2U7CiAgICAgdW5zaWduZWQgaW50IGNtZCwgaSA9IDAsIGRvbmUgPSAwLCBwdF9k
b207CiAgICAgc3RydWN0IHZjcHUgKmN1cnIgPSBjdXJyZW50LCAqdiA9IGN1cnI7CiAgICAgc3Ry
dWN0IGRvbWFpbiAqZCA9IHYtPmRvbWFpbiwgKnB0X293bmVyID0gZCwgKnBnX293bmVyOwotICAg
IG1mbl90IG1hcF9tZm4gPSBJTlZBTElEX01GTjsKKyAgICBtZm5fdCBtYXBfbWZuID0gSU5WQUxJ
RF9NRk4sIG1mbjsKICAgICBib29sIHN5bmNfZ3Vlc3QgPSBmYWxzZTsKICAgICB1aW50MzJfdCB4
c21fbmVlZGVkID0gMDsKICAgICB1aW50MzJfdCB4c21fY2hlY2tlZCA9IDA7CkBAIC0zODgzLDE0
ICszODgzLDE0IEBAIGxvbmcgZG9fbW11X3VwZGF0ZSgKICAgICAgICAgICAgICAgICBicmVhazsK
ICAgICAgICAgICAgIH0KIAotICAgICAgICAgICAgbWZuID0gbWZuX3gocGFnZV90b19tZm4ocGFn
ZSkpOworICAgICAgICAgICAgbWZuID0gcGFnZV90b19tZm4ocGFnZSk7CiAKLSAgICAgICAgICAg
IGlmICggIW1mbl9lcShfbWZuKG1mbiksIG1hcF9tZm4pICkKKyAgICAgICAgICAgIGlmICggIW1m
bl9lcShtZm4sIG1hcF9tZm4pICkKICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICBpZiAo
IHZhICkKICAgICAgICAgICAgICAgICAgICAgdW5tYXBfZG9tYWluX3BhZ2UodmEpOwotICAgICAg
ICAgICAgICAgIHZhID0gbWFwX2RvbWFpbl9wYWdlKF9tZm4obWZuKSk7Ci0gICAgICAgICAgICAg
ICAgbWFwX21mbiA9IF9tZm4obWZuKTsKKyAgICAgICAgICAgICAgICB2YSA9IG1hcF9kb21haW5f
cGFnZShtZm4pOworICAgICAgICAgICAgICAgIG1hcF9tZm4gPSBtZm47CiAgICAgICAgICAgICB9
CiAgICAgICAgICAgICB2YSA9IF9wKCgodW5zaWduZWQgbG9uZyl2YSAmIFBBR0VfTUFTSykgKyAo
cmVxLnB0ciAmIH5QQUdFX01BU0spKTsKIApAQCAtMzkyNiw3ICszOTI2LDggQEAgbG9uZyBkb19t
bXVfdXBkYXRlKAogICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAg
ICBib29sIGxvY2FsX2luX3VzZSA9IGZhbHNlOwogCi0gICAgICAgICAgICAgICAgICAgICAgICBp
ZiAoIHBhZ2V0YWJsZV9nZXRfcGZuKGN1cnItPmFyY2guZ3Vlc3RfdGFibGUpID09IG1mbiApCisg
ICAgICAgICAgICAgICAgICAgICAgICBpZiAoIG1mbl9lcShwYWdldGFibGVfZ2V0X21mbihjdXJy
LT5hcmNoLmd1ZXN0X3RhYmxlKSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IG1mbikgKQogICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIGxvY2FsX2luX3VzZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
Z2V0X2NwdV9pbmZvKCktPnJvb3RfcGd0X2NoYW5nZWQgPSB0cnVlOwpAQCAtMzkzOSwxNSArMzk0
MCwxNSBAQCBsb25nIGRvX21tdV91cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8K
ICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggKHBhZ2UtPnUuaW51c2UudHlwZV9pbmZvICYg
UEdUX2NvdW50X21hc2spID4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKDEgKyAhIShw
YWdlLT51LmludXNlLnR5cGVfaW5mbyAmIFBHVF9waW5uZWQpICsKLSAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIChwYWdldGFibGVfZ2V0X3BmbihjdXJyLT5hcmNoLmd1ZXN0X3RhYmxlX3Vz
ZXIpID09Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWZuKSArIGxvY2FsX2luX3Vz
ZSkgKQorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG1mbl9lcShwYWdldGFibGVfZ2V0
X21mbihjdXJyLT5hcmNoLmd1ZXN0X3RhYmxlX3VzZXIpLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBtZm4pKSArIGxvY2FsX2luX3VzZSkgKQogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIHN5bmNfZ3Vlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICB9CiAg
ICAgICAgICAgICAgICAgICAgIGJyZWFrOwogCiAgICAgICAgICAgICAgICAgY2FzZSBQR1Rfd3Jp
dGFibGVfcGFnZToKICAgICAgICAgICAgICAgICAgICAgcGVyZmNfaW5jcih3cml0YWJsZV9tbXVf
dXBkYXRlcyk7Ci0gICAgICAgICAgICAgICAgICAgIGlmICggcGFnaW5nX3dyaXRlX2d1ZXN0X2Vu
dHJ5KHYsIHZhLCByZXEudmFsLCBfbWZuKG1mbikpICkKKyAgICAgICAgICAgICAgICAgICAgaWYg
KCBwYWdpbmdfd3JpdGVfZ3Vlc3RfZW50cnkodiwgdmEsIHJlcS52YWwsIG1mbikgKQogICAgICAg
ICAgICAgICAgICAgICAgICAgcmMgPSAwOwogICAgICAgICAgICAgICAgICAgICBicmVhazsKICAg
ICAgICAgICAgICAgICB9CkBAIC0zOTU4LDcgKzM5NTksNyBAQCBsb25nIGRvX21tdV91cGRhdGUo
CiAgICAgICAgICAgICBlbHNlIGlmICggZ2V0X3BhZ2VfdHlwZShwYWdlLCBQR1Rfd3JpdGFibGVf
cGFnZSkgKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIHBlcmZjX2luY3Iod3JpdGFi
bGVfbW11X3VwZGF0ZXMpOwotICAgICAgICAgICAgICAgIGlmICggcGFnaW5nX3dyaXRlX2d1ZXN0
X2VudHJ5KHYsIHZhLCByZXEudmFsLCBfbWZuKG1mbikpICkKKyAgICAgICAgICAgICAgICBpZiAo
IHBhZ2luZ193cml0ZV9ndWVzdF9lbnRyeSh2LCB2YSwgcmVxLnZhbCwgbWZuKSApCiAgICAgICAg
ICAgICAgICAgICAgIHJjID0gMDsKICAgICAgICAgICAgICAgICBwdXRfcGFnZV90eXBlKHBhZ2Up
OwogICAgICAgICAgICAgfQpAQCAtMzk4MCw3ICszOTgxLDcgQEAgbG9uZyBkb19tbXVfdXBkYXRl
KAogICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgfQogCi0gICAgICAgICAgICBt
Zm4gPSByZXEucHRyID4+IFBBR0VfU0hJRlQ7CisgICAgICAgICAgICBtZm4gPSBtYWRkcl90b19t
Zm4ocmVxLnB0cik7CiAgICAgICAgICAgICBncGZuID0gcmVxLnZhbDsKIAogICAgICAgICAgICAg
eHNtX25lZWRlZCB8PSBYU01fTU1VX01BQ0hQSFlTX1VQREFURTsKQEAgLTM5OTIsNyArMzk5Myw3
IEBAIGxvbmcgZG9fbW11X3VwZGF0ZSgKICAgICAgICAgICAgICAgICB4c21fY2hlY2tlZCA9IHhz
bV9uZWVkZWQ7CiAgICAgICAgICAgICB9CiAKLSAgICAgICAgICAgIHBhZ2UgPSBnZXRfcGFnZV9m
cm9tX21mbihfbWZuKG1mbiksIHBnX293bmVyKTsKKyAgICAgICAgICAgIHBhZ2UgPSBnZXRfcGFn
ZV9mcm9tX21mbihtZm4sIHBnX293bmVyKTsKICAgICAgICAgICAgIGlmICggdW5saWtlbHkoIXBh
Z2UpICkKICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICBnZHByaW50ayhYRU5MT0dfV0FS
TklORywKQEAgLTQwMDEsNyArNDAwMiw3IEBAIGxvbmcgZG9fbW11X3VwZGF0ZSgKICAgICAgICAg
ICAgICAgICBicmVhazsKICAgICAgICAgICAgIH0KIAotICAgICAgICAgICAgc2V0X2dwZm5fZnJv
bV9tZm4obWZuLCBncGZuKTsKKyAgICAgICAgICAgIHNldF9ncGZuX2Zyb21fbWZuKG1mbl94KG1m
biksIGdwZm4pOwogICAgICAgICAgICAgcGFnaW5nX21hcmtfcGZuX2RpcnR5KHBnX293bmVyLCBf
cGZuKGdwZm4pKTsKIAogICAgICAgICAgICAgcHV0X3BhZ2UocGFnZSk7CkBAIC00MjU3LDggKzQy
NTgsNyBAQCBzdGF0aWMgaW50IF9fZG9fdXBkYXRlX3ZhX21hcHBpbmcoCiAgICAgICAgIGdvdG8g
b3V0OwogICAgIH0KIAotICAgIHJjID0gbW9kX2wxX2VudHJ5KHBsMWUsIHZhbCwgbWZuX3goZ2wx
bWZuKSwgTU1VX05PUk1BTF9QVF9VUERBVEUsIHYsCi0gICAgICAgICAgICAgICAgICAgICAgcGdf
b3duZXIpOworICAgIHJjID0gbW9kX2wxX2VudHJ5KHBsMWUsIHZhbCwgZ2wxbWZuLCBNTVVfTk9S
TUFMX1BUX1VQREFURSwgdiwgcGdfb3duZXIpOwogCiAgICAgcGFnZV91bmxvY2soZ2wxcGcpOwog
ICAgIHB1dF9wYWdlKGdsMXBnKTsKZGlmZiAtLWdpdCBhL3hlbi9hcmNoL3g4Ni9wdi9ncmFudF90
YWJsZS5jIGIveGVuL2FyY2gveDg2L3B2L2dyYW50X3RhYmxlLmMKaW5kZXggNTE4MDMzNGY0Mi4u
MDMyNTYxOGM5OCAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L3B2L2dyYW50X3RhYmxlLmMKKysr
IGIveGVuL2FyY2gveDg2L3B2L2dyYW50X3RhYmxlLmMKQEAgLTEwOCw3ICsxMDgsNyBAQCBpbnQg
Y3JlYXRlX2dyYW50X3B2X21hcHBpbmcodWludDY0X3QgYWRkciwgbWZuX3QgZnJhbWUsCiAgICAg
ICAgIGdvdG8gb3V0X3VubG9jazsKIAogICAgIG9sMWUgPSAqcGwxZTsKLSAgICBpZiAoIFVQREFU
RV9FTlRSWShsMSwgcGwxZSwgb2wxZSwgbmwxZSwgbWZuX3goZ2wxbWZuKSwgY3VyciwgMCkgKQor
ICAgIGlmICggVVBEQVRFX0VOVFJZKGwxLCBwbDFlLCBvbDFlLCBubDFlLCBnbDFtZm4sIGN1cnIs
IDApICkKICAgICAgICAgcmMgPSBHTlRTVF9va2F5OwogCiAgb3V0X3VubG9jazoKQEAgLTE2NSw3
ICsxNjUsNyBAQCBzdGF0aWMgYm9vbCBzdGVhbF9saW5lYXJfYWRkcmVzcyh1bnNpZ25lZCBsb25n
IGxpbmVhciwgbDFfcGdlbnRyeV90ICpvdXQpCiAgICAgICAgIGdvdG8gb3V0X3VubG9jazsKIAog
ICAgIG9sMWUgPSAqcGwxZTsKLSAgICBva2F5ID0gVVBEQVRFX0VOVFJZKGwxLCBwbDFlLCBvbDFl
LCBsMWVfZW1wdHkoKSwgbWZuX3goZ2wxbWZuKSwgY3VyciwgMCk7CisgICAgb2theSA9IFVQREFU
RV9FTlRSWShsMSwgcGwxZSwgb2wxZSwgbDFlX2VtcHR5KCksIGdsMW1mbiwgY3VyciwgMCk7CiAK
ICAgICBpZiAoIG9rYXkgKQogICAgICAgICAqb3V0ID0gb2wxZTsKQEAgLTI5Myw3ICsyOTMsNyBA
QCBpbnQgcmVwbGFjZV9ncmFudF9wdl9tYXBwaW5nKHVpbnQ2NF90IGFkZHIsIG1mbl90IGZyYW1l
LAogICAgICAgICAgICAgICAgICAiUFRFIGZsYWdzICV4IGZvciAlIlBSSXg2NCIgZG9uJ3QgbWF0
Y2ggZ3JhbnQgKCV4KVxuIiwKICAgICAgICAgICAgICAgICAgbDFlX2dldF9mbGFncyhvbDFlKSwg
YWRkciwgZ3JhbnRfcHRlX2ZsYWdzKTsKIAotICAgIGlmICggVVBEQVRFX0VOVFJZKGwxLCBwbDFl
LCBvbDFlLCBubDFlLCBtZm5feChnbDFtZm4pLCBjdXJyLCAwKSApCisgICAgaWYgKCBVUERBVEVf
RU5UUlkobDEsIHBsMWUsIG9sMWUsIG5sMWUsIGdsMW1mbiwgY3VyciwgMCkgKQogICAgICAgICBy
YyA9IEdOVFNUX29rYXk7CiAKICBvdXRfdW5sb2NrOgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2
L3B2L21tLmggYi94ZW4vYXJjaC94ODYvcHYvbW0uaAppbmRleCA5NzYyMDliYTRjLi5lZjg0ZGJi
NDFjIDEwMDY0NAotLS0gYS94ZW4vYXJjaC94ODYvcHYvbW0uaAorKysgYi94ZW4vYXJjaC94ODYv
cHYvbW0uaApAQCAtMzcsNyArMzcsNyBAQCBzdGF0aWMgaW5saW5lIGwxX3BnZW50cnlfdCBndWVz
dF9nZXRfZWZmX2wxZSh1bnNpZ25lZCBsb25nIGxpbmVhcikKICAqIFJldHVybnMgZmFsc2UgZm9y
IGZhaWx1cmUgKHBvaW50ZXIgbm90IHZhbGlkKSwgdHJ1ZSBmb3Igc3VjY2Vzcy4KICAqLwogc3Rh
dGljIGlubGluZSBib29sIHVwZGF0ZV9pbnRwdGUoaW50cHRlX3QgKnAsIGludHB0ZV90IG9sZCwg
aW50cHRlX3QgbmV3LAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQg
bG9uZyBtZm4sIHN0cnVjdCB2Y3B1ICp2LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgbWZuX3QgbWZuLCBzdHJ1Y3QgdmNwdSAqdiwKICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIGJvb2wgcHJlc2VydmVfYWQpCiB7CiAgICAgYm9vbCBydiA9IHRydWU7CkBAIC00NSw3
ICs0NSw3IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCB1cGRhdGVfaW50cHRlKGludHB0ZV90ICpwLCBp
bnRwdGVfdCBvbGQsIGludHB0ZV90IG5ldywKICNpZm5kZWYgUFRFX1VQREFURV9XSVRIX0NNUFhD
SEcKICAgICBpZiAoICFwcmVzZXJ2ZV9hZCApCiAgICAgewotICAgICAgICBydiA9IHBhZ2luZ193
cml0ZV9ndWVzdF9lbnRyeSh2LCBwLCBuZXcsIF9tZm4obWZuKSk7CisgICAgICAgIHJ2ID0gcGFn
aW5nX3dyaXRlX2d1ZXN0X2VudHJ5KHYsIHAsIG5ldywgbWZuKTsKICAgICB9CiAgICAgZWxzZQog
I2VuZGlmCkBAIC01OSw3ICs1OSw3IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCB1cGRhdGVfaW50cHRl
KGludHB0ZV90ICpwLCBpbnRwdGVfdCBvbGQsIGludHB0ZV90IG5ldywKICAgICAgICAgICAgIGlm
ICggcHJlc2VydmVfYWQgKQogICAgICAgICAgICAgICAgIF9uZXcgfD0gb2xkICYgKF9QQUdFX0FD
Q0VTU0VEIHwgX1BBR0VfRElSVFkpOwogCi0gICAgICAgICAgICBydiA9IHBhZ2luZ19jbXB4Y2hn
X2d1ZXN0X2VudHJ5KHYsIHAsICZ0LCBfbmV3LCBfbWZuKG1mbikpOworICAgICAgICAgICAgcnYg
PSBwYWdpbmdfY21weGNoZ19ndWVzdF9lbnRyeSh2LCBwLCAmdCwgX25ldywgbWZuKTsKICAgICAg
ICAgICAgIGlmICggdW5saWtlbHkocnYgPT0gMCkgKQogICAgICAgICAgICAgewogICAgICAgICAg
ICAgICAgIGdkcHJpbnRrKFhFTkxPR19XQVJOSU5HLApkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2
L3B2L3JvLXBhZ2UtZmF1bHQuYyBiL3hlbi9hcmNoL3g4Ni9wdi9yby1wYWdlLWZhdWx0LmMKaW5k
ZXggZTdhNzE3OWRkYS4uOTI5MTEwNzZlZiAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2L3B2L3Jv
LXBhZ2UtZmF1bHQuYworKysgYi94ZW4vYXJjaC94ODYvcHYvcm8tcGFnZS1mYXVsdC5jCkBAIC0x
OTcsNyArMTk3LDcgQEAgc3RhdGljIGludCBwdHdyX2VtdWxhdGVkX3VwZGF0ZSh1bnNpZ25lZCBs
b25nIGFkZHIsIGludHB0ZV90ICpwX29sZCwKICAgICBlbHNlCiAgICAgewogICAgICAgICBvbDFl
ID0gKnBsMWU7Ci0gICAgICAgIGlmICggIVVQREFURV9FTlRSWShsMSwgcGwxZSwgb2wxZSwgbmwx
ZSwgbWZuX3gobWZuKSwgdiwgMCkgKQorICAgICAgICBpZiAoICFVUERBVEVfRU5UUlkobDEsIHBs
MWUsIG9sMWUsIG5sMWUsIG1mbiwgdiwgMCkgKQogICAgICAgICAgICAgQlVHKCk7CiAgICAgfQog
Ci0tIAoyLjExLjAKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9y
ZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 58FAAB804E
	for <lists+xen-devel@lfdr.de>; Thu, 19 Sep 2019 19:44:41 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iB0RL-0005VM-Sp; Thu, 19 Sep 2019 17:41:59 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=vwgP=XO=citrix.com=anthony.perard@srs-us1.protection.inumbo.net>)
 id 1iB0RK-0005Tj-7j
 for xen-devel@lists.xenproject.org; Thu, 19 Sep 2019 17:41:58 +0000
X-Inumbo-ID: b745ac18-db04-11e9-978d-bc764e2007e4
Received: from esa3.hc3370-68.iphmx.com (unknown [216.71.145.155])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id b745ac18-db04-11e9-978d-bc764e2007e4;
 Thu, 19 Sep 2019 17:41:31 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1568914892;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=4ywWfZLEbmP7ZGXJPOEkF4hdVdqWKtMFSsjoXWWZH84=;
 b=HYWPnEBv3NgJmMXIp49/efUVtXcg514R/xGUnVgUTtkBDR8krzNu0lvn
 TgbiL8PXeuaKF9IlZLrIG7wv3f7K9p+hc2jdh7RhBUTVCRz0uOA+JwIdI
 9RJdL2n0GAE7KgQIMJEBbrk7cw5EDq2EjUfVSsU0jQQXxWORGzWqYCebm E=;
Authentication-Results: esa3.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=anthony.perard@citrix.com;
 spf=Pass smtp.mailfrom=anthony.perard@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa3.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 anthony.perard@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa3.hc3370-68.iphmx.com: domain of
 anthony.perard@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83 ~all"
Received-SPF: None (esa3.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa3.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: TQoAhTj7QihMrcMTYpSFJBeFPDabUrqTeRaolv1QofUh5XwMyqQZbzbgn5SP/C1pHQAe5daXbg
 89W+TFJ/idwIrLhbknySvhrRWyDC091NS4atauzhNuma2+34AAo3wyYxqil4XtXJ3PqT9RyHvS
 w5pRtMHBVTPLcfIJlYpM+1tzpLtny6bNiNIE5p8u97tIEXb4OMOWN6zveqmO9gzFUXqEW/GhVO
 Sz2Wk+fZCVIXG0eZsfyd4d4f2jdh5QvtFdPz2RK/T4S8NcRWLr6c/8DndrZH/DrE2VrO7dz8B/
 V+Q=
X-SBRS: 2.7
X-MesageID: 5806237
X-Ironport-Server: esa3.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.64,524,1559534400"; 
   d="scan'208";a="5806237"
From: Anthony PERARD <anthony.perard@citrix.com>
To: <xen-devel@lists.xenproject.org>
Date: Thu, 19 Sep 2019 18:16:48 +0100
Message-ID: <20190919171656.899649-29-anthony.perard@citrix.com>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190919171656.899649-1-anthony.perard@citrix.com>
References: <20190919171656.899649-1-anthony.perard@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v2 28/35] libxl_pci: Use ev_qmp in do_pci_add
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>, Ian
 Jackson <ian.jackson@eu.citrix.com>, Wei Liu <wl@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhpcyBwYXRjaCBhbHNvIHJlcGxhY2VzIHRoZSB1c2Ugb2YKbGlieGxfX3dhaXRfZm9yX2Rldmlj
ZV9tb2RlbF9kZXByZWNhdGVkKCkgYnkgaXRzIGVxdWl2YWxlbnQKd2l0aG91dCB0aGUgbmVlZCBm
b3IgYSB0aHJlYWQuCgpTaWduZWQtb2ZmLWJ5OiBBbnRob255IFBFUkFSRCA8YW50aG9ueS5wZXJh
cmRAY2l0cml4LmNvbT4KQWNrZWQtYnk6IElhbiBKYWNrc29uIDxpYW4uamFja3NvbkBldS5jaXRy
aXguY29tPgotLS0KIHRvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmggfCAgIDEgLQogdG9vbHMv
bGlieGwvbGlieGxfcGNpLmMgICAgICB8IDI4OCArKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKy0tLQogdG9vbHMvbGlieGwvbGlieGxfcW1wLmMgICAgICB8ICA5NiAtLS0tLS0tLS0tLS0K
IDMgZmlsZXMgY2hhbmdlZCwgMjY1IGluc2VydGlvbnMoKyksIDEyMCBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5oIGIvdG9vbHMvbGlieGwvbGli
eGxfaW50ZXJuYWwuaAppbmRleCAxOGM2NjVkM2RiZTIuLmQ2MGI5YzQxNmFiZiAxMDA2NDQKLS0t
IGEvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaAorKysgYi90b29scy9saWJ4bC9saWJ4bF9p
bnRlcm5hbC5oCkBAIC0xOTgyLDcgKzE5ODIsNiBAQCB0eXBlZGVmIHN0cnVjdCBsaWJ4bF9fcW1w
X2hhbmRsZXIgbGlieGxfX3FtcF9oYW5kbGVyOwogICovCiBfaGlkZGVuIGxpYnhsX19xbXBfaGFu
ZGxlciAqbGlieGxfX3FtcF9pbml0aWFsaXplKGxpYnhsX19nYyAqZ2MsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90IGRvbWlkKTsKLV9o
aWRkZW4gaW50IGxpYnhsX19xbXBfcGNpX2FkZChsaWJ4bF9fZ2MgKmdjLCBpbnQgZCwgbGlieGxf
ZGV2aWNlX3BjaSAqcGNpZGV2KTsKIF9oaWRkZW4gaW50IGxpYnhsX19xbXBfcGNpX2RlbChsaWJ4
bF9fZ2MgKmdjLCBpbnQgZG9taWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGli
eGxfZGV2aWNlX3BjaSAqcGNpZGV2KTsKIC8qIFJlc3VtZSBodm0gZG9tYWluICovCmRpZmYgLS1n
aXQgYS90b29scy9saWJ4bC9saWJ4bF9wY2kuYyBiL3Rvb2xzL2xpYnhsL2xpYnhsX3BjaS5jCmlu
ZGV4IDUwM2RiNmMyNjA0My4uMzQ3N2YzYWJhNjA1IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9s
aWJ4bF9wY2kuYworKysgYi90b29scy9saWJ4bC9saWJ4bF9wY2kuYwpAQCAtMjMsNiArMjMsNyBA
QAogI2RlZmluZSBQQ0lfQkRGX1ZERVZGTiAgICAgICAgICIlMDR4OiUwMng6JTAyeC4lMDF4QCUw
MngiCiAjZGVmaW5lIFBDSV9PUFRJT05TICAgICAgICAgICAgIm1zaXRyYW5zbGF0ZT0lZCxwb3dl
cl9tZ210PSVkIgogI2RlZmluZSBQQ0lfQkRGX1hTUEFUSCAgICAgICAgICIlMDR4LSUwMngtJTAy
eC0lMDF4IgorI2RlZmluZSBQQ0lfUFRfUURFVl9JRCAgICAgICAgICJwY2ktcHQtJTAyeF8lMDJ4
LiUwMXgiCiAKIHN0YXRpYyB1bnNpZ25lZCBpbnQgcGNpZGV2X2VuY29kZV9iZGYobGlieGxfZGV2
aWNlX3BjaSAqcGNpZGV2KQogewpAQCAtOTkxLDMzICs5OTIsNDAgQEAgdHlwZWRlZiBzdHJ1Y3Qg
cGNpX2FkZF9zdGF0ZSB7CiAgICAgdm9pZCAoKmNhbGxiYWNrKShsaWJ4bF9fZWdjICosIHN0cnVj
dCBwY2lfYWRkX3N0YXRlICosIGludCByYyk7CiAKICAgICAvKiBwcml2YXRlIHRvIGRvX3BjaV9h
ZGQgKi8KKyAgICBsaWJ4bF9feHN3YWl0X3N0YXRlIHhzd2FpdDsKKyAgICBsaWJ4bF9fZXZfcW1w
IHFtcDsKKyAgICBsaWJ4bF9fZXZfdGltZSB0aW1lb3V0OwogICAgIGxpYnhsX2RldmljZV9wY2kg
KnBjaWRldjsKICAgICBpbnQgcGNpX2RvbWlkOwogfSBwY2lfYWRkX3N0YXRlOwogCitzdGF0aWMg
dm9pZCBwY2lfYWRkX3FlbXVfdHJhZF93YXRjaF9zdGF0ZV9jYihsaWJ4bF9fZWdjICplZ2MsCisg
ICAgbGlieGxfX3hzd2FpdF9zdGF0ZSAqeHN3YSwgaW50IHJjLCBjb25zdCBjaGFyICpzdGF0ZSk7
CitzdGF0aWMgdm9pZCBwY2lfYWRkX3FtcF9kZXZpY2VfYWRkKGxpYnhsX19lZ2MgKiwgcGNpX2Fk
ZF9zdGF0ZSAqKTsKK3N0YXRpYyB2b2lkIHBjaV9hZGRfcW1wX2RldmljZV9hZGRfY2IobGlieGxf
X2VnYyAqLAorICAgIGxpYnhsX19ldl9xbXAgKiwgY29uc3QgbGlieGxfX2pzb25fb2JqZWN0ICos
IGludCByYyk7CitzdGF0aWMgdm9pZCBwY2lfYWRkX3FtcF9xdWVyeV9wY2lfY2IobGlieGxfX2Vn
YyAqLAorICAgIGxpYnhsX19ldl9xbXAgKiwgY29uc3QgbGlieGxfX2pzb25fb2JqZWN0ICosIGlu
dCByYyk7CitzdGF0aWMgdm9pZCBwY2lfYWRkX3RpbWVvdXQobGlieGxfX2VnYyAqZWdjLCBsaWJ4
bF9fZXZfdGltZSAqZXYsCisgICAgY29uc3Qgc3RydWN0IHRpbWV2YWwgKnJlcXVlc3RlZF9hYnMs
IGludCByYyk7CitzdGF0aWMgdm9pZCBwY2lfYWRkX2RtX2RvbmUobGlieGxfX2VnYyAqLAorICAg
IHBjaV9hZGRfc3RhdGUgKiwgaW50IHJjKTsKKwogc3RhdGljIHZvaWQgZG9fcGNpX2FkZChsaWJ4
bF9fZWdjICplZ2MsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpYnhsX2RvbWlkIGRvbWlkLAog
ICAgICAgICAgICAgICAgICAgICAgICBsaWJ4bF9kZXZpY2VfcGNpICpwY2lkZXYsCiAgICAgICAg
ICAgICAgICAgICAgICAgIHBjaV9hZGRfc3RhdGUgKnBhcykKIHsKICAgICBTVEFURV9BT19HQyhw
YXMtPmFvZGV2LT5hbyk7Ci0gICAgbGlieGxfY3R4ICpjdHggPSBsaWJ4bF9fZ2Nfb3duZXIoZ2Mp
OwogICAgIGxpYnhsX2RvbWFpbl90eXBlIHR5cGUgPSBsaWJ4bF9fZG9tYWluX3R5cGUoZ2MsIGRv
bWlkKTsKLSAgICBjaGFyICpzeXNmc19wYXRoOwotICAgIEZJTEUgKmY7Ci0gICAgdW5zaWduZWQg
bG9uZyBsb25nIHN0YXJ0LCBlbmQsIGZsYWdzLCBzaXplOwotICAgIGludCBpcnEsIGksIHJjLCBo
dm0gPSAwOwotICAgIHVpbnQzMl90IGZsYWcgPSBYRU5fRE9NQ1RMX0RFVl9SRE1fUkVMQVhFRDsK
LSAgICB1aW50MzJfdCBkb21haW5pZCA9IGRvbWlkOwotICAgIGJvb2wgaXNzdHViZG9tID0gbGli
eGxfaXNfc3R1YmRvbShjdHgsIGRvbWlkLCAmZG9tYWluaWQpOwotICAgIGludCByOwotCi0gICAg
LyogQ29udmVuaWVuY2UgYWxpYXNlcyAqLwotICAgIGJvb2wgc3RhcnRpbmcgPSBwYXMtPnN0YXJ0
aW5nOworICAgIGludCByYzsKIAogICAgIC8qIGluaXQgcGNpX2FkZF9zdGF0ZSAqLworICAgIGxp
YnhsX194c3dhaXRfaW5pdCgmcGFzLT54c3dhaXQpOworICAgIGxpYnhsX19ldl9xbXBfaW5pdCgm
cGFzLT5xbXApOwogICAgIHBhcy0+cGNpZGV2ID0gcGNpZGV2OwogICAgIHBhcy0+cGNpX2RvbWlk
ID0gZG9taWQ7CisgICAgbGlieGxfX2V2X3RpbWVfaW5pdCgmcGFzLT50aW1lb3V0KTsKIAogICAg
IGlmICh0eXBlID09IExJQlhMX0RPTUFJTl9UWVBFX0lOVkFMSUQpIHsKICAgICAgICAgcmMgPSBF
UlJPUl9GQUlMOwpAQCAtMTAyNSwyNiArMTAzMywyNTkgQEAgc3RhdGljIHZvaWQgZG9fcGNpX2Fk
ZChsaWJ4bF9fZWdjICplZ2MsCiAgICAgfQogCiAgICAgaWYgKHR5cGUgPT0gTElCWExfRE9NQUlO
X1RZUEVfSFZNKSB7Ci0gICAgICAgIGh2bSA9IDE7CiAgICAgICAgIHN3aXRjaCAobGlieGxfX2Rl
dmljZV9tb2RlbF92ZXJzaW9uX3J1bm5pbmcoZ2MsIGRvbWlkKSkgewogICAgICAgICAgICAgY2Fz
ZSBMSUJYTF9ERVZJQ0VfTU9ERUxfVkVSU0lPTl9RRU1VX1hFTl9UUkFESVRJT05BTDoKLSAgICAg
ICAgICAgICAgICBpZiAobGlieGxfX3dhaXRfZm9yX2RldmljZV9tb2RlbF9kZXByZWNhdGVkKGdj
LCBkb21pZCwKLSAgICAgICAgICAgICAgICAgICAgICAgICJydW5uaW5nIiwgTlVMTCwgTlVMTCwg
TlVMTCkgPCAwKSB7Ci0gICAgICAgICAgICAgICAgICAgIHJjID0gRVJST1JfRkFJTDsKLSAgICAg
ICAgICAgICAgICAgICAgZ290byBvdXQ7Ci0gICAgICAgICAgICAgICAgfQotICAgICAgICAgICAg
ICAgIHJjID0gcWVtdV9wY2lfYWRkX3hlbnN0b3JlKGdjLCBkb21pZCwgcGNpZGV2KTsKLSAgICAg
ICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgICAgICBwYXMtPnhzd2FpdC5hbyA9IGFvOwor
ICAgICAgICAgICAgICAgIHBhcy0+eHN3YWl0LndoYXQgPSAiRGV2aWNlIE1vZGVsIjsKKyAgICAg
ICAgICAgICAgICBwYXMtPnhzd2FpdC5wYXRoID0gREVWSUNFX01PREVMX1hTX1BBVEgoZ2MsCisg
ICAgICAgICAgICAgICAgICAgIGxpYnhsX2dldF9zdHViZG9tX2lkKENUWCwgZG9taWQpLCBkb21p
ZCwgIi9zdGF0ZSIpOworICAgICAgICAgICAgICAgIHBhcy0+eHN3YWl0LnRpbWVvdXRfbXMgPSBM
SUJYTF9ERVZJQ0VfTU9ERUxfU1RBUlRfVElNRU9VVCAqIDEwMDA7CisgICAgICAgICAgICAgICAg
cGFzLT54c3dhaXQuY2FsbGJhY2sgPSBwY2lfYWRkX3FlbXVfdHJhZF93YXRjaF9zdGF0ZV9jYjsK
KyAgICAgICAgICAgICAgICByYyA9IGxpYnhsX194c3dhaXRfc3RhcnQoZ2MsICZwYXMtPnhzd2Fp
dCk7CisgICAgICAgICAgICAgICAgaWYgKHJjKSBnb3RvIG91dDsKKyAgICAgICAgICAgICAgICBy
ZXR1cm47CiAgICAgICAgICAgICBjYXNlIExJQlhMX0RFVklDRV9NT0RFTF9WRVJTSU9OX1FFTVVf
WEVOOgotICAgICAgICAgICAgICAgIHJjID0gbGlieGxfX3FtcF9wY2lfYWRkKGdjLCBkb21pZCwg
cGNpZGV2KTsKLSAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgICAgICBwY2lfYWRk
X3FtcF9kZXZpY2VfYWRkKGVnYywgcGFzKTsgLyogbXVzdCBiZSBsYXN0ICovCisgICAgICAgICAg
ICAgICAgcmV0dXJuOwogICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICByYyA9
IEVSUk9SX0lOVkFMOworICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICB9Ci0gICAgICAg
IGlmICggcmMgKQorICAgIH0KKworICAgIHJjID0gMDsKKworb3V0OgorICAgIHBjaV9hZGRfZG1f
ZG9uZShlZ2MsIHBhcywgcmMpOyAvKiBtdXN0IGJlIGxhc3QgKi8KK30KKworc3RhdGljIHZvaWQg
cGNpX2FkZF9xZW11X3RyYWRfd2F0Y2hfc3RhdGVfY2IobGlieGxfX2VnYyAqZWdjLAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfX3hzd2FpdF9zdGF0
ZSAqeHN3YSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlu
dCByYywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0
IGNoYXIgKnN0YXRlKQoreworICAgIHBjaV9hZGRfc3RhdGUgKnBhcyA9IENPTlRBSU5FUl9PRih4
c3dhLCAqcGFzLCB4c3dhaXQpOworICAgIFNUQVRFX0FPX0dDKHBhcy0+YW9kZXYtPmFvKTsKKwor
ICAgIC8qIENvbnZlbmllbmNlIGFsaWFzZXMgKi8KKyAgICBsaWJ4bF9kb21pZCBkb21pZCA9IHBh
cy0+ZG9taWQ7CisgICAgbGlieGxfZGV2aWNlX3BjaSAqcGNpZGV2ID0gcGFzLT5wY2lkZXY7CisK
KyAgICBpZiAocmMpIHsKKyAgICAgICAgaWYgKHJjID09IEVSUk9SX1RJTUVET1VUKSB7CisgICAg
ICAgICAgICBMT0dEKEVSUk9SLCBkb21pZCwgIiVzIG5vdCByZWFkeSIsIHhzd2EtPndoYXQpOwor
ICAgICAgICB9CisgICAgICAgIGdvdG8gb3V0OworICAgIH0KKworICAgIGlmICghc3RhdGUpCisg
ICAgICAgIHJldHVybjsKKyAgICBpZiAoc3RyY21wKHN0YXRlLCAicnVubmluZyIpKQorICAgICAg
ICByZXR1cm47CisKKyAgICByYyA9IHFlbXVfcGNpX2FkZF94ZW5zdG9yZShnYywgZG9taWQsIHBj
aWRldik7CitvdXQ6CisgICAgbGlieGxfX3hzd2FpdF9zdG9wKGdjLCB4c3dhKTsKKyAgICBwY2lf
YWRkX2RtX2RvbmUoZWdjLCBwYXMsIHJjKTsgLyogbXVzdCBiZSBsYXN0ICovCit9CisKK3N0YXRp
YyB2b2lkIHBjaV9hZGRfcW1wX2RldmljZV9hZGQobGlieGxfX2VnYyAqZWdjLCBwY2lfYWRkX3N0
YXRlICpwYXMpCit7CisgICAgU1RBVEVfQU9fR0MocGFzLT5hb2Rldi0+YW8pOworICAgIGxpYnhs
X19qc29uX29iamVjdCAqYXJncyA9IE5VTEw7CisgICAgaW50IHJjOworCisgICAgLyogQ29udmVu
aWVuY2UgYWxpYXNlcyAqLworICAgIGxpYnhsX2RvbWlkIGRvbWlkID0gcGFzLT5kb21pZDsKKyAg
ICBsaWJ4bF9kZXZpY2VfcGNpICpwY2lkZXYgPSBwYXMtPnBjaWRldjsKKyAgICBsaWJ4bF9fZXZf
cW1wICpjb25zdCBxbXAgPSAmcGFzLT5xbXA7CisKKyAgICByYyA9IGxpYnhsX19ldl90aW1lX3Jl
Z2lzdGVyX3JlbChhbywgJnBhcy0+dGltZW91dCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBwY2lfYWRkX3RpbWVvdXQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgTElCWExfUU1QX0NNRF9USU1FT1VUICogMTAwMCk7CisgICAgaWYgKHJjKSBnb3Rv
IG91dDsKKworICAgIGxpYnhsX19xbXBfcGFyYW1fYWRkX3N0cmluZyhnYywgJmFyZ3MsICJkcml2
ZXIiLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAieGVuLXBjaS1wYXNzdGhyb3Vn
aCIpOworICAgIFFNUF9QQVJBTUVURVJTX1NQUklOVEYoJmFyZ3MsICJpZCIsIFBDSV9QVF9RREVW
X0lELAorICAgICAgICAgICAgICAgICAgICAgICAgICAgcGNpZGV2LT5idXMsIHBjaWRldi0+ZGV2
LCBwY2lkZXYtPmZ1bmMpOworICAgIFFNUF9QQVJBTUVURVJTX1NQUklOVEYoJmFyZ3MsICJob3N0
YWRkciIsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAiJTA0eDolMDJ4OiUwMnguJTAxeCIs
IHBjaWRldi0+ZG9tYWluLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgcGNpZGV2LT5idXMs
IHBjaWRldi0+ZGV2LCBwY2lkZXYtPmZ1bmMpOworICAgIGlmIChwY2lkZXYtPnZkZXZmbikgewor
ICAgICAgICBRTVBfUEFSQU1FVEVSU19TUFJJTlRGKCZhcmdzLCAiYWRkciIsICIleC4leCIsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUENJX1NMT1QocGNpZGV2LT52ZGV2Zm4pLAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBDSV9GVU5DKHBjaWRldi0+dmRldmZuKSk7
CisgICAgfQorICAgIC8qCisgICAgICogVmVyc2lvbiBvZiBRRU1VIHByaW9yIHRvIHRoZSBYU0Et
MTMxIGZpeCBkaWQgbm90IHN1cHBvcnQKKyAgICAgKiB0aGlzIHByb3BlcnR5IGFuZCB3ZXJlIGVm
ZmVjdGl2ZWx5IGFsd2F5cyBpbiBwZXJtaXNzaXZlCisgICAgICogbW9kZS4gVGhlIGZpeCBmb3Ig
WFNBLTEzMSBzd2l0Y2hlZCB0aGUgZGVmYXVsdCB0byBiZQorICAgICAqIHJlc3RyaWN0ZWQgYnkg
ZGVmYXVsdCBhbmQgYWRkZWQgdGhlIHBlcm1pc3NpdmUgcHJvcGVydHkuCisgICAgICoKKyAgICAg
KiBUaGVyZWZvcmUgaW4gb3JkZXIgdG8gc3VwcG9ydCBib3RoIG9sZCBhbmQgbmV3IFFFTVUgd2Ug
b25seQorICAgICAqIHNldCB0aGUgcGVybWlzc2l2ZSBmbGFnIGlmIGl0IGlzIHRydWUuIFVzZXJz
IG9mIG9sZGVyIFFFTVUKKyAgICAgKiBoYXZlIG5vIHJlYXNvbiB0byBzZXQgdGhlIGZsYWcgc28g
dGhpcyBpcyBvay4KKyAgICAgKi8KKyAgICBpZiAocGNpZGV2LT5wZXJtaXNzaXZlKQorICAgICAg
ICBsaWJ4bF9fcW1wX3BhcmFtX2FkZF9ib29sKGdjLCAmYXJncywgInBlcm1pc3NpdmUiLCB0cnVl
KTsKKworICAgIHFtcC0+YW8gPSBwYXMtPmFvZGV2LT5hbzsKKyAgICBxbXAtPmRvbWlkID0gZG9t
aWQ7CisgICAgcW1wLT5wYXlsb2FkX2ZkID0gLTE7CisgICAgcW1wLT5jYWxsYmFjayA9IHBjaV9h
ZGRfcW1wX2RldmljZV9hZGRfY2I7CisgICAgcmMgPSBsaWJ4bF9fZXZfcW1wX3NlbmQoZ2MsIHFt
cCwgImRldmljZV9hZGQiLCBhcmdzKTsKKyAgICBpZiAocmMpIGdvdG8gb3V0OworICAgIHJldHVy
bjsKKworb3V0OgorICAgIHBjaV9hZGRfZG1fZG9uZShlZ2MsIHBhcywgcmMpOyAvKiBtdXN0IGJl
IGxhc3QgKi8KK30KKworc3RhdGljIHZvaWQgcGNpX2FkZF9xbXBfZGV2aWNlX2FkZF9jYihsaWJ4
bF9fZWdjICplZ2MsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpYnhs
X19ldl9xbXAgKnFtcCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29u
c3QgbGlieGxfX2pzb25fb2JqZWN0ICpyZXNwb25zZSwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgaW50IHJjKQoreworICAgIEVHQ19HQzsKKyAgICBwY2lfYWRkX3N0YXRl
ICpwYXMgPSBDT05UQUlORVJfT0YocW1wLCAqcGFzLCBxbXApOworCisgICAgaWYgKHJjKSBnb3Rv
IG91dDsKKworICAgIHFtcC0+Y2FsbGJhY2sgPSBwY2lfYWRkX3FtcF9xdWVyeV9wY2lfY2I7Cisg
ICAgcmMgPSBsaWJ4bF9fZXZfcW1wX3NlbmQoZ2MsIHFtcCwgInF1ZXJ5LXBjaSIsIE5VTEwpOwor
ICAgIGlmIChyYykgZ290byBvdXQ7CisgICAgcmV0dXJuOworCitvdXQ6CisgICAgcGNpX2FkZF9k
bV9kb25lKGVnYywgcGFzLCByYyk7IC8qIG11c3QgYmUgbGFzdCAqLworfQorCitzdGF0aWMgdm9p
ZCBwY2lfYWRkX3FtcF9xdWVyeV9wY2lfY2IobGlieGxfX2VnYyAqZWdjLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIGxpYnhsX19ldl9xbXAgKnFtcCwKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWJ4bF9fanNvbl9vYmplY3QgKnJlc3Bv
bnNlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCByYykKK3sKKyAg
ICBFR0NfR0M7CisgICAgcGNpX2FkZF9zdGF0ZSAqcGFzID0gQ09OVEFJTkVSX09GKHFtcCwgKnBh
cywgcW1wKTsKKyAgICBjb25zdCBsaWJ4bF9fanNvbl9vYmplY3QgKmJ1cyA9IE5VTEw7CisgICAg
Y2hhciAqYXNrZWRfaWQ7CisgICAgaW50IGksIGo7CisgICAgY29uc3QgbGlieGxfX2pzb25fb2Jq
ZWN0ICpkZXZpY2VzID0gTlVMTDsKKyAgICBjb25zdCBsaWJ4bF9fanNvbl9vYmplY3QgKmRldmlj
ZSA9IE5VTEw7CisgICAgY29uc3QgbGlieGxfX2pzb25fb2JqZWN0ICpvID0gTlVMTDsKKyAgICBj
b25zdCBjaGFyICppZCA9IE5VTEw7CisgICAgaW50IGRldl9zbG90LCBkZXZfZnVuYzsKKworICAg
IC8qIENvbnZlbmllbmNlIGFsaWFzZXMgKi8KKyAgICBsaWJ4bF9kZXZpY2VfcGNpICpwY2lkZXYg
PSBwYXMtPnBjaWRldjsKKworICAgIGlmIChyYykgZ290byBvdXQ7CisKKyAgICAvKiBgcXVlcnkt
cGNpJyByZXR1cm5zOgorICAgICAqIFsKKyAgICAgKiAgIHsnYnVzJzogJ2ludCcsCisgICAgICog
ICAgJ2RldmljZXMnOiBbCisgICAgICogICAgICAgeydidXMnOiAnaW50JywgJ3Nsb3QnOiAnaW50
JywgJ2Z1bmN0aW9uJzogJ2ludCcsCisgICAgICogICAgICAgICdjbGFzc19pbmZvJzogJ1BjaURl
dmljZUNsYXNzJywgJ2lkJzogJ1BjaURldmljZUlkJywKKyAgICAgKiAgICAgICAgJyppcnEnOiAn
aW50JywgJ3FkZXZfaWQnOiAnc3RyJywKKyAgICAgKiAgICAgICAgJypwY2lfYnJpZGdlJzogJ1Bj
aUJyaWRnZUluZm8nLAorICAgICAqICAgICAgICAncmVnaW9ucyc6IFsnUGNpTWVtb3J5UmVnaW9u
J10KKyAgICAgKiAgICAgICB9CisgICAgICogICAgXQorICAgICAqICAgfQorICAgICAqIF0KKyAg
ICAgKiAoU2VlIHFlbXUuZ2l0L3FhcGkvIGZvciB0aGUgc3RydWN0IHRoYXQgYXJlbid0IGRldGFp
bGVkIGhlcmUpCisgICAgICovCisKKyAgICBhc2tlZF9pZCA9IEdDU1BSSU5URihQQ0lfUFRfUURF
Vl9JRCwKKyAgICAgICAgICAgICAgICAgICAgICAgICBwY2lkZXYtPmJ1cywgcGNpZGV2LT5kZXYs
IHBjaWRldi0+ZnVuYyk7CisKKyAgICBmb3IgKGkgPSAwOyAoYnVzID0gbGlieGxfX2pzb25fYXJy
YXlfZ2V0KHJlc3BvbnNlLCBpKSk7IGkrKykgeworICAgICAgICBkZXZpY2VzID0gbGlieGxfX2pz
b25fbWFwX2dldCgiZGV2aWNlcyIsIGJ1cywgSlNPTl9BUlJBWSk7CisgICAgICAgIGlmICghZGV2
aWNlcykgeworICAgICAgICAgICAgcmMgPSBFUlJPUl9RRU1VX0FQSTsKICAgICAgICAgICAgIGdv
dG8gb3V0OworICAgICAgICB9CisKKyAgICAgICAgZm9yIChqID0gMDsgKGRldmljZSA9IGxpYnhs
X19qc29uX2FycmF5X2dldChkZXZpY2VzLCBqKSk7IGorKykgeworICAgICAgICAgICAgIG8gPSBs
aWJ4bF9fanNvbl9tYXBfZ2V0KCJxZGV2X2lkIiwgZGV2aWNlLCBKU09OX1NUUklORyk7CisgICAg
ICAgICAgICAgaWYgKCFvKSB7CisgICAgICAgICAgICAgICAgIHJjID0gRVJST1JfUUVNVV9BUEk7
CisgICAgICAgICAgICAgICAgIGdvdG8gb3V0OworICAgICAgICAgICAgIH0KKyAgICAgICAgICAg
ICBpZCA9IGxpYnhsX19qc29uX29iamVjdF9nZXRfc3RyaW5nKG8pOworICAgICAgICAgICAgIGlm
ICghaWQgfHwgc3RyY21wKGFza2VkX2lkLCBpZCkpCisgICAgICAgICAgICAgICAgIGNvbnRpbnVl
OworCisgICAgICAgICAgICAgbyA9IGxpYnhsX19qc29uX21hcF9nZXQoInNsb3QiLCBkZXZpY2Us
IEpTT05fSU5URUdFUik7CisgICAgICAgICAgICAgaWYgKCFvKSB7CisgICAgICAgICAgICAgICAg
IHJjID0gRVJST1JfUUVNVV9BUEk7CisgICAgICAgICAgICAgICAgIGdvdG8gb3V0OworICAgICAg
ICAgICAgIH0KKyAgICAgICAgICAgICBkZXZfc2xvdCA9IGxpYnhsX19qc29uX29iamVjdF9nZXRf
aW50ZWdlcihvKTsKKyAgICAgICAgICAgICBvID0gbGlieGxfX2pzb25fbWFwX2dldCgiZnVuY3Rp
b24iLCBkZXZpY2UsIEpTT05fSU5URUdFUik7CisgICAgICAgICAgICAgaWYgKCFvKSB7CisgICAg
ICAgICAgICAgICAgIHJjID0gRVJST1JfUUVNVV9BUEk7CisgICAgICAgICAgICAgICAgIGdvdG8g
b3V0OworICAgICAgICAgICAgIH0KKyAgICAgICAgICAgICBkZXZfZnVuYyA9IGxpYnhsX19qc29u
X29iamVjdF9nZXRfaW50ZWdlcihvKTsKKworICAgICAgICAgICAgIHBjaWRldi0+dmRldmZuID0g
UENJX0RFVkZOKGRldl9zbG90LCBkZXZfZnVuYyk7CisKKyAgICAgICAgICAgICByYyA9IDA7Cisg
ICAgICAgICAgICAgZ290byBvdXQ7CisgICAgICAgIH0KICAgICB9CiAKKyAgICByYyA9IEVSUk9S
X0ZBSUw7CisgICAgTE9HRChFUlJPUiwgcW1wLT5kb21pZCwKKyAgICAgICAgICJQQ0kgZGV2aWNl
IGlkICclcycgd2Fzbid0IGZvdW5kIGluIFFFTVUncyAncXVlcnktcGNpJyByZXNwb25zZS4iLAor
ICAgICAgICAgYXNrZWRfaWQpOworCitvdXQ6CisgICAgaWYgKHJjID09IEVSUk9SX1FFTVVfQVBJ
KSB7CisgICAgICAgIExPR0QoRVJST1IsIHFtcC0+ZG9taWQsCisgICAgICAgICAgICAgIlVuZXhw
ZWN0ZWQgcmVzcG9uc2UgdG8gUU1QIGNtZCAncXVlcnktcGNpJywgcmVjZWl2ZWQ6XG4lcyIsCisg
ICAgICAgICAgICAgSlNPTihyZXNwb25zZSkpOworICAgIH0KKyAgICBwY2lfYWRkX2RtX2RvbmUo
ZWdjLCBwYXMsIHJjKTsgLyogbXVzdCBiZSBsYXN0ICovCit9CisKK3N0YXRpYyB2b2lkIHBjaV9h
ZGRfdGltZW91dChsaWJ4bF9fZWdjICplZ2MsIGxpYnhsX19ldl90aW1lICpldiwKKyAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJ1Y3QgdGltZXZhbCAqcmVxdWVzdGVkX2FicywK
KyAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgcmMpCit7CisgICAgcGNpX2FkZF9zdGF0
ZSAqcGFzID0gQ09OVEFJTkVSX09GKGV2LCAqcGFzLCB0aW1lb3V0KTsKKworICAgIHBjaV9hZGRf
ZG1fZG9uZShlZ2MsIHBhcywgcmMpOworfQorCitzdGF0aWMgdm9pZCBwY2lfYWRkX2RtX2RvbmUo
bGlieGxfX2VnYyAqZWdjLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBjaV9hZGRfc3Rh
dGUgKnBhcywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgcmMpCit7CisgICAgU1RB
VEVfQU9fR0MocGFzLT5hb2Rldi0+YW8pOworICAgIGxpYnhsX2N0eCAqY3R4ID0gbGlieGxfX2dj
X293bmVyKGdjKTsKKyAgICBsaWJ4bF9kb21pZCBkb21pZCA9IHBhcy0+cGNpX2RvbWlkOworICAg
IGNoYXIgKnN5c2ZzX3BhdGg7CisgICAgRklMRSAqZjsKKyAgICB1bnNpZ25lZCBsb25nIGxvbmcg
c3RhcnQsIGVuZCwgZmxhZ3MsIHNpemU7CisgICAgaW50IGlycSwgaTsKKyAgICBpbnQgcjsKKyAg
ICB1aW50MzJfdCBmbGFnID0gWEVOX0RPTUNUTF9ERVZfUkRNX1JFTEFYRUQ7CisgICAgdWludDMy
X3QgZG9tYWluaWQgPSBkb21pZDsKKyAgICBib29sIGlzc3R1YmRvbSA9IGxpYnhsX2lzX3N0dWJk
b20oY3R4LCBkb21pZCwgJmRvbWFpbmlkKTsKKworICAgIC8qIENvbnZlbmllbmNlIGFsaWFzZXMg
Ki8KKyAgICBib29sIHN0YXJ0aW5nID0gcGFzLT5zdGFydGluZzsKKyAgICBsaWJ4bF9kZXZpY2Vf
cGNpICpwY2lkZXYgPSBwYXMtPnBjaWRldjsKKyAgICBib29sIGh2bSA9IGxpYnhsX19kb21haW5f
dHlwZShnYywgZG9taWQpID09IExJQlhMX0RPTUFJTl9UWVBFX0hWTTsKKworICAgIGxpYnhsX19l
dl9xbXBfZGlzcG9zZShnYywgJnBhcy0+cW1wKTsKKworICAgIGlmIChyYykgZ290byBvdXQ7CisK
ICAgICBzeXNmc19wYXRoID0gR0NTUFJJTlRGKFNZU0ZTX1BDSV9ERVYiLyJQQ0lfQkRGIi9yZXNv
dXJjZSIsIHBjaWRldi0+ZG9tYWluLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGNpZGV2
LT5idXMsIHBjaWRldi0+ZGV2LCBwY2lkZXYtPmZ1bmMpOwogICAgIGYgPSBmb3BlbihzeXNmc19w
YXRoLCAiciIpOwpAQCAtMTE0NSw2ICsxMzg2LDcgQEAgc3RhdGljIHZvaWQgZG9fcGNpX2FkZChs
aWJ4bF9fZWdjICplZ2MsCiAgICAgZWxzZQogICAgICAgICByYyA9IDA7CiBvdXQ6CisgICAgbGli
eGxfX2V2X3RpbWVfZGVyZWdpc3RlcihnYywgJnBhcy0+dGltZW91dCk7CiAgICAgcGFzLT5jYWxs
YmFjayhlZ2MsIHBhcywgcmMpOwogfQogCmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9x
bXAuYyBiL3Rvb2xzL2xpYnhsL2xpYnhsX3FtcC5jCmluZGV4IGM3OGVmNDYzN2QwYS4uMzhiYTYz
ZDViOTIwIDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9xbXAuYworKysgYi90b29scy9s
aWJ4bC9saWJ4bF9xbXAuYwpAQCAtNzM2LDU0ICs3MzYsNiBAQCB2b2lkIGxpYnhsX19xbXBfY2xl
YW51cChsaWJ4bF9fZ2MgKmdjLCB1aW50MzJfdCBkb21pZCkKICAgICB9CiB9CiAKLXN0YXRpYyBp
bnQgcGNpX2FkZF9jYWxsYmFjayhsaWJ4bF9fcW1wX2hhbmRsZXIgKnFtcCwKLSAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBjb25zdCBsaWJ4bF9fanNvbl9vYmplY3QgKnJlc3BvbnNlLCB2b2lk
ICpvcGFxdWUpCi17Ci0gICAgbGlieGxfZGV2aWNlX3BjaSAqcGNpZGV2ID0gb3BhcXVlOwotICAg
IGNvbnN0IGxpYnhsX19qc29uX29iamVjdCAqYnVzID0gTlVMTDsKLSAgICBHQ19JTklUKHFtcC0+
Y3R4KTsKLSAgICBpbnQgaSwgaiwgcmMgPSAtMTsKLSAgICBjaGFyICphc2tlZF9pZCA9IEdDU1BS
SU5URihQQ0lfUFRfUURFVl9JRCwKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwY2lk
ZXYtPmJ1cywgcGNpZGV2LT5kZXYsIHBjaWRldi0+ZnVuYyk7Ci0KLSAgICBmb3IgKGkgPSAwOyAo
YnVzID0gbGlieGxfX2pzb25fYXJyYXlfZ2V0KHJlc3BvbnNlLCBpKSk7IGkrKykgewotICAgICAg
ICBjb25zdCBsaWJ4bF9fanNvbl9vYmplY3QgKmRldmljZXMgPSBOVUxMOwotICAgICAgICBjb25z
dCBsaWJ4bF9fanNvbl9vYmplY3QgKmRldmljZSA9IE5VTEw7Ci0gICAgICAgIGNvbnN0IGxpYnhs
X19qc29uX29iamVjdCAqbyA9IE5VTEw7Ci0gICAgICAgIGNvbnN0IGNoYXIgKmlkID0gTlVMTDsK
LQotICAgICAgICBkZXZpY2VzID0gbGlieGxfX2pzb25fbWFwX2dldCgiZGV2aWNlcyIsIGJ1cywg
SlNPTl9BUlJBWSk7Ci0KLSAgICAgICAgZm9yIChqID0gMDsgKGRldmljZSA9IGxpYnhsX19qc29u
X2FycmF5X2dldChkZXZpY2VzLCBqKSk7IGorKykgewotICAgICAgICAgICAgIG8gPSBsaWJ4bF9f
anNvbl9tYXBfZ2V0KCJxZGV2X2lkIiwgZGV2aWNlLCBKU09OX1NUUklORyk7Ci0gICAgICAgICAg
ICAgaWQgPSBsaWJ4bF9fanNvbl9vYmplY3RfZ2V0X3N0cmluZyhvKTsKLQotICAgICAgICAgICAg
IGlmIChpZCAmJiBzdHJjbXAoYXNrZWRfaWQsIGlkKSA9PSAwKSB7Ci0gICAgICAgICAgICAgICAg
IGludCBkZXZfc2xvdCwgZGV2X2Z1bmM7Ci0KLSAgICAgICAgICAgICAgICAgbyA9IGxpYnhsX19q
c29uX21hcF9nZXQoInNsb3QiLCBkZXZpY2UsIEpTT05fSU5URUdFUik7Ci0gICAgICAgICAgICAg
ICAgIGlmICghbykKLSAgICAgICAgICAgICAgICAgICAgIGdvdG8gb3V0OwotICAgICAgICAgICAg
ICAgICBkZXZfc2xvdCA9IGxpYnhsX19qc29uX29iamVjdF9nZXRfaW50ZWdlcihvKTsKLSAgICAg
ICAgICAgICAgICAgbyA9IGxpYnhsX19qc29uX21hcF9nZXQoImZ1bmN0aW9uIiwgZGV2aWNlLCBK
U09OX0lOVEVHRVIpOwotICAgICAgICAgICAgICAgICBpZiAoIW8pCi0gICAgICAgICAgICAgICAg
ICAgICBnb3RvIG91dDsKLSAgICAgICAgICAgICAgICAgZGV2X2Z1bmMgPSBsaWJ4bF9fanNvbl9v
YmplY3RfZ2V0X2ludGVnZXIobyk7Ci0KLSAgICAgICAgICAgICAgICAgcGNpZGV2LT52ZGV2Zm4g
PSBQQ0lfREVWRk4oZGV2X3Nsb3QsIGRldl9mdW5jKTsKLQotICAgICAgICAgICAgICAgICByYyA9
IDA7Ci0gICAgICAgICAgICAgICAgIGdvdG8gb3V0OwotICAgICAgICAgICAgIH0KLSAgICAgICAg
fQotICAgIH0KLQotCi1vdXQ6Ci0gICAgR0NfRlJFRTsKLSAgICByZXR1cm4gcmM7Ci19Ci0KIHN0
YXRpYyBpbnQgcGNpX2RlbF9jYWxsYmFjayhsaWJ4bF9fcW1wX2hhbmRsZXIgKnFtcCwKICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWJ4bF9fanNvbl9vYmplY3QgKnJlc3BvbnNl
LCB2b2lkICpvcGFxdWUpCiB7CkBAIC04MzMsNTQgKzc4NSw2IEBAIHN0YXRpYyBpbnQgcW1wX3J1
bl9jb21tYW5kKGxpYnhsX19nYyAqZ2MsIGludCBkb21pZCwKICAgICByZXR1cm4gcmM7CiB9CiAK
LWludCBsaWJ4bF9fcW1wX3BjaV9hZGQobGlieGxfX2djICpnYywgaW50IGRvbWlkLCBsaWJ4bF9k
ZXZpY2VfcGNpICpwY2lkZXYpCi17Ci0gICAgbGlieGxfX3FtcF9oYW5kbGVyICpxbXAgPSBOVUxM
OwotICAgIGxpYnhsX19qc29uX29iamVjdCAqYXJncyA9IE5VTEw7Ci0gICAgY2hhciAqaG9zdGFk
ZHIgPSBOVUxMOwotICAgIGludCByYyA9IDA7Ci0KLSAgICBxbXAgPSBsaWJ4bF9fcW1wX2luaXRp
YWxpemUoZ2MsIGRvbWlkKTsKLSAgICBpZiAoIXFtcCkKLSAgICAgICAgcmV0dXJuIC0xOwotCi0g
ICAgaG9zdGFkZHIgPSBHQ1NQUklOVEYoIiUwNHg6JTAyeDolMDJ4LiUwMXgiLCBwY2lkZXYtPmRv
bWFpbiwKLSAgICAgICAgICAgICAgICAgICAgICAgICBwY2lkZXYtPmJ1cywgcGNpZGV2LT5kZXYs
IHBjaWRldi0+ZnVuYyk7Ci0gICAgaWYgKCFob3N0YWRkcikKLSAgICAgICAgcmV0dXJuIC0xOwot
Ci0gICAgbGlieGxfX3FtcF9wYXJhbV9hZGRfc3RyaW5nKGdjLCAmYXJncywgImRyaXZlciIsICJ4
ZW4tcGNpLXBhc3N0aHJvdWdoIik7Ci0gICAgUU1QX1BBUkFNRVRFUlNfU1BSSU5URigmYXJncywg
ImlkIiwgUENJX1BUX1FERVZfSUQsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICBwY2lkZXYt
PmJ1cywgcGNpZGV2LT5kZXYsIHBjaWRldi0+ZnVuYyk7Ci0gICAgbGlieGxfX3FtcF9wYXJhbV9h
ZGRfc3RyaW5nKGdjLCAmYXJncywgImhvc3RhZGRyIiwgaG9zdGFkZHIpOwotICAgIGlmIChwY2lk
ZXYtPnZkZXZmbikgewotICAgICAgICBRTVBfUEFSQU1FVEVSU19TUFJJTlRGKCZhcmdzLCAiYWRk
ciIsICIleC4leCIsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUENJX1NMT1QocGNp
ZGV2LT52ZGV2Zm4pLCBQQ0lfRlVOQyhwY2lkZXYtPnZkZXZmbikpOwotICAgIH0KLSAgICAvKgot
ICAgICAqIFZlcnNpb24gb2YgUUVNVSBwcmlvciB0byB0aGUgWFNBLTEzMSBmaXggZGlkIG5vdCBz
dXBwb3J0IHRoaXMKLSAgICAgKiBwcm9wZXJ0eSBhbmQgd2VyZSBlZmZlY3RpdmVseSBhbHdheXMg
aW4gcGVybWlzc2l2ZSBtb2RlLiBUaGUKLSAgICAgKiBmaXggZm9yIFhTQS0xMzEgc3dpdGNoZWQg
dGhlIGRlZmF1bHQgdG8gYmUgcmVzdHJpY3RlZCBieQotICAgICAqIGRlZmF1bHQgYW5kIGFkZGVk
IHRoZSBwZXJtaXNzaXZlIHByb3BlcnR5LgotICAgICAqCi0gICAgICogVGhlcmVmb3JlIGluIG9y
ZGVyIHRvIHN1cHBvcnQgYm90aCBvbGQgYW5kIG5ldyBRRU1VIHdlIG9ubHkgc2V0Ci0gICAgICog
dGhlIHBlcm1pc3NpdmUgZmxhZyBpZiBpdCBpcyB0cnVlLiBVc2VycyBvZiBvbGRlciBRRU1VIGhh
dmUgbm8KLSAgICAgKiByZWFzb24gdG8gc2V0IHRoZSBmbGFnIHNvIHRoaXMgaXMgb2suCi0gICAg
ICovCi0gICAgaWYgKHBjaWRldi0+cGVybWlzc2l2ZSkKLSAgICAgICAgbGlieGxfX3FtcF9wYXJh
bV9hZGRfYm9vbChnYywgJmFyZ3MsICJwZXJtaXNzaXZlIiwgdHJ1ZSk7Ci0KLSAgICByYyA9IHFt
cF9zeW5jaHJvbm91c19zZW5kKHFtcCwgImRldmljZV9hZGQiLCBhcmdzLAotICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgTlVMTCwgTlVMTCwgcW1wLT50aW1lb3V0KTsKLSAgICBpZiAocmMg
PT0gMCkgewotICAgICAgICByYyA9IHFtcF9zeW5jaHJvbm91c19zZW5kKHFtcCwgInF1ZXJ5LXBj
aSIsIE5VTEwsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGNpX2FkZF9jYWxs
YmFjaywgcGNpZGV2LCBxbXAtPnRpbWVvdXQpOwotICAgIH0KLQotICAgIGxpYnhsX19xbXBfY2xv
c2UocW1wKTsKLSAgICByZXR1cm4gcmM7Ci19Ci0KIHN0YXRpYyBpbnQgcW1wX2RldmljZV9kZWwo
bGlieGxfX2djICpnYywgaW50IGRvbWlkLCBjaGFyICppZCkKIHsKICAgICBsaWJ4bF9fanNvbl9v
YmplY3QgKmFyZ3MgPSBOVUxMOwotLSAKQW50aG9ueSBQRVJBUkQKCgpfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhl
bi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3Jn
L21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

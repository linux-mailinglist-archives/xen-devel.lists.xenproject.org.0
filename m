Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id AB777144C4
	for <lists+xen-devel@lfdr.de>; Mon,  6 May 2019 08:59:56 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hNXYg-00023I-4I; Mon, 06 May 2019 06:57:06 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=XZcu=TG=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hNXYc-0001xq-V7
 for xen-devel@lists.xenproject.org; Mon, 06 May 2019 06:57:03 +0000
X-Inumbo-ID: 236f1a00-6fcc-11e9-843c-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 236f1a00-6fcc-11e9-843c-bc764e045a96;
 Mon, 06 May 2019 06:56:57 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 0B9ADAF1F;
 Mon,  6 May 2019 06:56:54 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon,  6 May 2019 08:56:18 +0200
Message-Id: <20190506065644.7415-20-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190506065644.7415-1-jgross@suse.com>
References: <20190506065644.7415-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH RFC V2 19/45] xen/sched: make rt scheduler vcpu
 agnostic.
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>, Meng Xu <mengxu@cis.upenn.edu>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U3dpdGNoIHJ0IHNjaGVkdWxlciBjb21wbGV0ZWx5IGZyb20gdmNwdSB0byBzY2hlZF9pdGVtIHVz
YWdlLgoKU2lnbmVkLW9mZi1ieTogSnVlcmdlbiBHcm9zcyA8amdyb3NzQHN1c2UuY29tPgotLS0K
IHhlbi9jb21tb24vc2NoZWRfcnQuYyB8IDM1NiArKysrKysrKysrKysrKysrKysrKysrKystLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDE3NCBpbnNlcnRpb25zKCsp
LCAxODIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZF9ydC5jIGIv
eGVuL2NvbW1vbi9zY2hlZF9ydC5jCmluZGV4IDE4NjFlZjhjNDEuLjczMGFhMjkyZDQgMTAwNjQ0
Ci0tLSBhL3hlbi9jb21tb24vc2NoZWRfcnQuYworKysgYi94ZW4vY29tbW9uL3NjaGVkX3J0LmMK
QEAgLTM2LDcgKzM2LDcgQEAKICAqCiAgKiBNaWdyYXRpb24gY29tcGVuc2F0aW9uIGFuZCByZXNp
c3QgbGlrZSBjcmVkaXQyIHRvIGJldHRlciB1c2UgY2FjaGU7CiAgKiBMb2NrIEhvbGRlciBQcm9i
bGVtLCB1c2luZyB5aWVsZD8KLSAqIFNlbGYgc3dpdGNoIHByb2JsZW06IFZDUFVzIG9mIHRoZSBz
YW1lIGRvbWFpbiBtYXkgcHJlZW1wdCBlYWNoIG90aGVyOworICogU2VsZiBzd2l0Y2ggcHJvYmxl
bTogSVRFTXMgb2YgdGhlIHNhbWUgZG9tYWluIG1heSBwcmVlbXB0IGVhY2ggb3RoZXI7CiAgKi8K
IAogLyoKQEAgLTQ0LDMwICs0NCwzMCBAQAogICoKICAqIFRoaXMgc2NoZWR1bGVyIGZvbGxvd3Mg
dGhlIFByZWVtcHRpdmUgR2xvYmFsIEVhcmxpZXN0IERlYWRsaW5lIEZpcnN0IChFREYpCiAgKiB0
aGVvcnkgaW4gcmVhbC10aW1lIGZpZWxkLgotICogQXQgYW55IHNjaGVkdWxpbmcgcG9pbnQsIHRo
ZSBWQ1BVIHdpdGggZWFybGllciBkZWFkbGluZSBoYXMgaGlnaGVyIHByaW9yaXR5LgotICogVGhl
IHNjaGVkdWxlciBhbHdheXMgcGlja3MgaGlnaGVzdCBwcmlvcml0eSBWQ1BVIHRvIHJ1biBvbiBh
IGZlYXNpYmxlIFBDUFUuCi0gKiBBIFBDUFUgaXMgZmVhc2libGUgaWYgdGhlIFZDUFUgY2FuIHJ1
biBvbiB0aGlzIFBDUFUgYW5kICh0aGUgUENQVSBpcyBpZGxlIG9yCi0gKiBoYXMgYSBsb3dlci1w
cmlvcml0eSBWQ1BVIHJ1bm5pbmcgb24gaXQuKQorICogQXQgYW55IHNjaGVkdWxpbmcgcG9pbnQs
IHRoZSBJVEVNIHdpdGggZWFybGllciBkZWFkbGluZSBoYXMgaGlnaGVyIHByaW9yaXR5LgorICog
VGhlIHNjaGVkdWxlciBhbHdheXMgcGlja3MgaGlnaGVzdCBwcmlvcml0eSBJVEVNIHRvIHJ1biBv
biBhIGZlYXNpYmxlIFBDUFUuCisgKiBBIFBDUFUgaXMgZmVhc2libGUgaWYgdGhlIElURU0gY2Fu
IHJ1biBvbiB0aGlzIFBDUFUgYW5kICh0aGUgUENQVSBpcyBpZGxlIG9yCisgKiBoYXMgYSBsb3dl
ci1wcmlvcml0eSBJVEVNIHJ1bm5pbmcgb24gaXQuKQogICoKLSAqIEVhY2ggVkNQVSBoYXMgYSBk
ZWRpY2F0ZWQgcGVyaW9kLCBidWRnZXQgYW5kIGEgZXh0cmF0aW1lIGZsYWcKLSAqIFRoZSBkZWFk
bGluZSBvZiBhIFZDUFUgaXMgYXQgdGhlIGVuZCBvZiBlYWNoIHBlcmlvZDsKLSAqIEEgVkNQVSBo
YXMgaXRzIGJ1ZGdldCByZXBsZW5pc2hlZCBhdCB0aGUgYmVnaW5uaW5nIG9mIGVhY2ggcGVyaW9k
OwotICogV2hpbGUgc2NoZWR1bGVkLCBhIFZDUFUgYnVybnMgaXRzIGJ1ZGdldC4KLSAqIFRoZSBW
Q1BVIG5lZWRzIHRvIGZpbmlzaCBpdHMgYnVkZ2V0IGJlZm9yZSBpdHMgZGVhZGxpbmUgaW4gZWFj
aCBwZXJpb2Q7Ci0gKiBUaGUgVkNQVSBkaXNjYXJkcyBpdHMgdW51c2VkIGJ1ZGdldCBhdCB0aGUg
ZW5kIG9mIGVhY2ggcGVyaW9kLgotICogV2hlbiBhIFZDUFUgcnVucyBvdXQgb2YgYnVkZ2V0IGlu
IGEgcGVyaW9kLCBpZiBpdHMgZXh0cmF0aW1lIGZsYWcgaXMgc2V0LAotICogdGhlIFZDUFUgaW5j
cmVhc2VzIGl0cyBwcmlvcml0eV9sZXZlbCBieSAxIGFuZCByZWZpbGxzIGl0cyBidWRnZXQ7IG90
aGVyd2lzZSwKKyAqIEVhY2ggSVRFTSBoYXMgYSBkZWRpY2F0ZWQgcGVyaW9kLCBidWRnZXQgYW5k
IGEgZXh0cmF0aW1lIGZsYWcKKyAqIFRoZSBkZWFkbGluZSBvZiBhbiBJVEVNIGlzIGF0IHRoZSBl
bmQgb2YgZWFjaCBwZXJpb2Q7CisgKiBBbiBJVEVNIGhhcyBpdHMgYnVkZ2V0IHJlcGxlbmlzaGVk
IGF0IHRoZSBiZWdpbm5pbmcgb2YgZWFjaCBwZXJpb2Q7CisgKiBXaGlsZSBzY2hlZHVsZWQsIGFu
IElURU0gYnVybnMgaXRzIGJ1ZGdldC4KKyAqIFRoZSBJVEVNIG5lZWRzIHRvIGZpbmlzaCBpdHMg
YnVkZ2V0IGJlZm9yZSBpdHMgZGVhZGxpbmUgaW4gZWFjaCBwZXJpb2Q7CisgKiBUaGUgSVRFTSBk
aXNjYXJkcyBpdHMgdW51c2VkIGJ1ZGdldCBhdCB0aGUgZW5kIG9mIGVhY2ggcGVyaW9kLgorICog
V2hlbiBhbiBJVEVNIHJ1bnMgb3V0IG9mIGJ1ZGdldCBpbiBhIHBlcmlvZCwgaWYgaXRzIGV4dHJh
dGltZSBmbGFnIGlzIHNldCwKKyAqIHRoZSBJVEVNIGluY3JlYXNlcyBpdHMgcHJpb3JpdHlfbGV2
ZWwgYnkgMSBhbmQgcmVmaWxscyBpdHMgYnVkZ2V0OyBvdGhlcndpc2UsCiAgKiBpdCBoYXMgdG8g
d2FpdCB1bnRpbCBuZXh0IHBlcmlvZC4KICAqCi0gKiBFYWNoIFZDUFUgaXMgaW1wbGVtZW50ZWQg
YXMgYSBkZWZlcmFibGUgc2VydmVyLgotICogV2hlbiBhIFZDUFUgaGFzIGEgdGFzayBydW5uaW5n
IG9uIGl0LCBpdHMgYnVkZ2V0IGlzIGNvbnRpbnVvdXNseSBidXJuZWQ7Ci0gKiBXaGVuIGEgVkNQ
VSBoYXMgbm8gdGFzayBidXQgd2l0aCBidWRnZXQgbGVmdCwgaXRzIGJ1ZGdldCBpcyBwcmVzZXJ2
ZWQuCisgKiBFYWNoIElURU0gaXMgaW1wbGVtZW50ZWQgYXMgYSBkZWZlcmFibGUgc2VydmVyLgor
ICogV2hlbiBhbiBJVEVNIGhhcyBhIHRhc2sgcnVubmluZyBvbiBpdCwgaXRzIGJ1ZGdldCBpcyBj
b250aW51b3VzbHkgYnVybmVkOworICogV2hlbiBhbiBJVEVNIGhhcyBubyB0YXNrIGJ1dCB3aXRo
IGJ1ZGdldCBsZWZ0LCBpdHMgYnVkZ2V0IGlzIHByZXNlcnZlZC4KICAqCiAgKiBRdWV1ZSBzY2hl
bWU6CiAgKiBBIGdsb2JhbCBydW5xdWV1ZSBhbmQgYSBnbG9iYWwgZGVwbGV0ZWRxdWV1ZSBmb3Ig
ZWFjaCBDUFUgcG9vbC4KLSAqIFRoZSBydW5xdWV1ZSBob2xkcyBhbGwgcnVubmFibGUgVkNQVXMg
d2l0aCBidWRnZXQsCisgKiBUaGUgcnVucXVldWUgaG9sZHMgYWxsIHJ1bm5hYmxlIElURU1zIHdp
dGggYnVkZ2V0LAogICogc29ydGVkIGJ5IHByaW9yaXR5X2xldmVsIGFuZCBkZWFkbGluZTsKLSAq
IFRoZSBkZXBsZXRlZHF1ZXVlIGhvbGRzIGFsbCBWQ1BVcyB3aXRob3V0IGJ1ZGdldCwgdW5zb3J0
ZWQ7CisgKiBUaGUgZGVwbGV0ZWRxdWV1ZSBob2xkcyBhbGwgSVRFTXMgd2l0aG91dCBidWRnZXQs
IHVuc29ydGVkOwogICoKICAqIE5vdGU6IGNwdW1hc2sgYW5kIGNwdXBvb2wgaXMgc3VwcG9ydGVk
LgogICovCkBAIC04Miw3ICs4Miw3IEBACiAgKiBpbiBzY2hlZHVsZS5jCiAgKgogICogVGhlIGZ1
bmN0aW9ucyBpbnZvbGVzIFJ1blEgYW5kIG5lZWRzIHRvIGdyYWIgbG9ja3MgYXJlOgotICogICAg
dmNwdV9pbnNlcnQsIHZjcHVfcmVtb3ZlLCBjb250ZXh0X3NhdmVkLCBydW5xX2luc2VydAorICog
ICAgaXRlbV9pbnNlcnQsIGl0ZW1fcmVtb3ZlLCBjb250ZXh0X3NhdmVkLCBydW5xX2luc2VydAog
ICovCiAKIApAQCAtOTUsNyArOTUsNyBAQAogCiAvKgogICogTWF4IHBlcmlvZDogbWF4IGRlbHRh
IG9mIHRpbWUgdHlwZSwgYmVjYXVzZSBwZXJpb2QgaXMgYWRkZWQgdG8gdGhlIHRpbWUKLSAqIGEg
dmNwdSBhY3RpdmF0ZXMsIHNvIHRoaXMgbXVzdCBub3Qgb3ZlcmZsb3cuCisgKiBhbiBpdGVtIGFj
dGl2YXRlcywgc28gdGhpcyBtdXN0IG5vdCBvdmVyZmxvdy4KICAqIE1pbiBwZXJpb2Q6IDEwIHVz
LCBjb25zaWRlcmluZyB0aGUgc2NoZWR1bGluZyBvdmVyaGVhZCAod2hlbiBwZXJpb2QgaXMKICAq
IHRvbyBsb3csIHNjaGVkdWxpbmcgaXMgaW52b2tlZCB0b28gZnJlcXVlbnRseSwgY2F1c2luZyBo
aWdoIG92ZXJoZWFkKS4KICAqLwpAQCAtMTIxLDEyICsxMjEsMTIgQEAKICAqIEZsYWdzCiAgKi8K
IC8qCi0gKiBSVERTX3NjaGVkdWxlZDogSXMgdGhpcyB2Y3B1IGVpdGhlciBydW5uaW5nIG9uLCBv
ciBjb250ZXh0LXN3aXRjaGluZyBvZmYsCisgKiBSVERTX3NjaGVkdWxlZDogSXMgdGhpcyBpdGVt
IGVpdGhlciBydW5uaW5nIG9uLCBvciBjb250ZXh0LXN3aXRjaGluZyBvZmYsCiAgKiBhIHBoeWlz
Y2FsIGNwdT8KICAqICsgQWNjZXNzZWQgb25seSB3aXRoIGdsb2JhbCBsb2NrIGhlbGQuCiAgKiAr
IFNldCB3aGVuIGNob3NlbiBhcyBuZXh0IGluIHJ0X3NjaGVkdWxlKCkuCiAgKiArIENsZWFyZWQg
YWZ0ZXIgY29udGV4dCBzd2l0Y2ggaGFzIGJlZW4gc2F2ZWQgaW4gcnRfY29udGV4dF9zYXZlZCgp
Ci0gKiArIENoZWNrZWQgaW4gdmNwdV93YWtlIHRvIHNlZSBpZiB3ZSBjYW4gYWRkIHRvIHRoZSBS
dW5xdWV1ZSwgb3IgaWYgd2Ugc2hvdWxkCisgKiArIENoZWNrZWQgaW4gaXRlbV93YWtlIHRvIHNl
ZSBpZiB3ZSBjYW4gYWRkIHRvIHRoZSBSdW5xdWV1ZSwgb3IgaWYgd2Ugc2hvdWxkCiAgKiAgIHNl
dCBSVERTX2RlbGF5ZWRfcnVucV9hZGQKICAqICsgQ2hlY2tlZCB0byBiZSBmYWxzZSBpbiBydW5x
X2luc2VydC4KICAqLwpAQCAtMTQ2LDE1ICsxNDYsMTUgQEAKIC8qCiAgKiBSVERTX2RlcGxldGVk
OiBEb2VzIHRoaXMgdmNwIHJ1biBvdXQgb2YgYnVkZ2V0PwogICogVGhpcyBmbGFnIGlzCi0gKiAr
IHNldCBpbiBidXJuX2J1ZGdldCgpIGlmIGEgdmNwdSBoYXMgemVybyBidWRnZXQgbGVmdDsKKyAq
ICsgc2V0IGluIGJ1cm5fYnVkZ2V0KCkgaWYgYW4gaXRlbSBoYXMgemVybyBidWRnZXQgbGVmdDsK
ICAqICsgY2xlYXJlZCBhbmQgY2hlY2tlZCBpbiB0aGUgcmVwZW5pc2htZW50IGhhbmRsZXIsCi0g
KiAgIGZvciB0aGUgdmNwdXMgdGhhdCBhcmUgYmVpbmcgcmVwbGVuaXNoZWQuCisgKiAgIGZvciB0
aGUgaXRlbXMgdGhhdCBhcmUgYmVpbmcgcmVwbGVuaXNoZWQuCiAgKi8KICNkZWZpbmUgX19SVERT
X2RlcGxldGVkICAgICAzCiAjZGVmaW5lIFJURFNfZGVwbGV0ZWQgKDE8PF9fUlREU19kZXBsZXRl
ZCkKIAogLyoKLSAqIFJURFNfZXh0cmF0aW1lOiBDYW4gdGhlIHZjcHUgcnVuIGluIHRoZSB0aW1l
IHRoYXQgaXMKKyAqIFJURFNfZXh0cmF0aW1lOiBDYW4gdGhlIGl0ZW0gcnVuIGluIHRoZSB0aW1l
IHRoYXQgaXMKICAqIG5vdCBwYXJ0IG9mIGFueSByZWFsLXRpbWUgcmVzZXJ2YXRpb24sIGFuZCB3
b3VsZCB0aGVyZWZvcmUKICAqIGJlIG90aGVyd2lzZSBsZWZ0IGlkbGU/CiAgKi8KQEAgLTE4Mywx
MSArMTgzLDExIEBAIHN0cnVjdCBydF9wcml2YXRlIHsKICAgICBzcGlubG9ja190IGxvY2s7ICAg
ICAgICAgICAgLyogdGhlIGdsb2JhbCBjb2Fyc2UtZ3JhaW5lZCBsb2NrICovCiAgICAgc3RydWN0
IGxpc3RfaGVhZCBzZG9tOyAgICAgIC8qIGxpc3Qgb2YgYXZhaWxhbGJlIGRvbWFpbnMsIHVzZWQg
Zm9yIGR1bXAgKi8KIAotICAgIHN0cnVjdCBsaXN0X2hlYWQgcnVucTsgICAgICAvKiBvcmRlcmVk
IGxpc3Qgb2YgcnVubmFibGUgdmNwdXMgKi8KLSAgICBzdHJ1Y3QgbGlzdF9oZWFkIGRlcGxldGVk
cTsgLyogdW5vcmRlcmVkIGxpc3Qgb2YgZGVwbGV0ZWQgdmNwdXMgKi8KKyAgICBzdHJ1Y3QgbGlz
dF9oZWFkIHJ1bnE7ICAgICAgLyogb3JkZXJlZCBsaXN0IG9mIHJ1bm5hYmxlIGl0ZW1zICovCisg
ICAgc3RydWN0IGxpc3RfaGVhZCBkZXBsZXRlZHE7IC8qIHVub3JkZXJlZCBsaXN0IG9mIGRlcGxl
dGVkIGl0ZW1zICovCiAKICAgICBzdHJ1Y3QgdGltZXIgcmVwbF90aW1lcjsgICAgLyogcmVwbGVu
aXNobWVudCB0aW1lciAqLwotICAgIHN0cnVjdCBsaXN0X2hlYWQgcmVwbHE7ICAgICAvKiBvcmRl
cmVkIGxpc3Qgb2YgdmNwdXMgdGhhdCBuZWVkIHJlcGxlbmlzaG1lbnQgKi8KKyAgICBzdHJ1Y3Qg
bGlzdF9oZWFkIHJlcGxxOyAgICAgLyogb3JkZXJlZCBsaXN0IG9mIGl0ZW1zIHRoYXQgbmVlZCBy
ZXBsZW5pc2htZW50ICovCiAKICAgICBjcHVtYXNrX3QgdGlja2xlZDsgICAgICAgICAgLyogY3B1
cyBiZWVuIHRpY2tsZWQgKi8KIH07CkBAIC0xOTksMTggKzE5OSwxOCBAQCBzdHJ1Y3QgcnRfaXRl
bSB7CiAgICAgc3RydWN0IGxpc3RfaGVhZCBxX2VsZW07ICAgICAvKiBvbiB0aGUgcnVucS9kZXBs
ZXRlZHEgbGlzdCAqLwogICAgIHN0cnVjdCBsaXN0X2hlYWQgcmVwbHFfZWxlbTsgLyogb24gdGhl
IHJlcGxlbmlzaG1lbnQgZXZlbnRzIGxpc3QgKi8KIAotICAgIC8qIFZDUFUgcGFyYW1ldGVycywg
aW4gbmFub3NlY29uZHMgKi8KKyAgICAvKiBJVEVNIHBhcmFtZXRlcnMsIGluIG5hbm9zZWNvbmRz
ICovCiAgICAgc190aW1lX3QgcGVyaW9kOwogICAgIHNfdGltZV90IGJ1ZGdldDsKIAotICAgIC8q
IFZDUFUgY3VycmVudCBpbmZvcm1hdGlvbiBpbiBuYW5vc2Vjb25kICovCisgICAgLyogSVRFTSBj
dXJyZW50IGluZm9ybWF0aW9uIGluIG5hbm9zZWNvbmQgKi8KICAgICBzX3RpbWVfdCBjdXJfYnVk
Z2V0OyAgICAgICAgIC8qIGN1cnJlbnQgYnVkZ2V0ICovCiAgICAgc190aW1lX3QgbGFzdF9zdGFy
dDsgICAgICAgICAvKiBsYXN0IHN0YXJ0IHRpbWUgKi8KICAgICBzX3RpbWVfdCBjdXJfZGVhZGxp
bmU7ICAgICAgIC8qIGN1cnJlbnQgZGVhZGxpbmUgZm9yIEVERiAqLwogCiAgICAgLyogVXAtcG9p
bnRlcnMgKi8KICAgICBzdHJ1Y3QgcnRfZG9tICpzZG9tOwotICAgIHN0cnVjdCB2Y3B1ICp2Y3B1
OworICAgIHN0cnVjdCBzY2hlZF9pdGVtICppdGVtOwogCiAgICAgdW5zaWduZWQgcHJpb3JpdHlf
bGV2ZWw7CiAKQEAgLTI2Myw3ICsyNjMsNyBAQCBzdGF0aWMgaW5saW5lIGJvb2wgaGFzX2V4dHJh
dGltZShjb25zdCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogICogYW5kIHRoZSByZXBsZW5pc2htZW50
IGV2ZW50cyBxdWV1ZS4KICAqLwogc3RhdGljIGludAotdmNwdV9vbl9xKGNvbnN0IHN0cnVjdCBy
dF9pdGVtICpzdmMpCitpdGVtX29uX3EoY29uc3Qgc3RydWN0IHJ0X2l0ZW0gKnN2YykKIHsKICAg
IHJldHVybiAhbGlzdF9lbXB0eSgmc3ZjLT5xX2VsZW0pOwogfQpAQCAtMjgxLDcgKzI4MSw3IEBA
IHJlcGxxX2VsZW0oc3RydWN0IGxpc3RfaGVhZCAqZWxlbSkKIH0KIAogc3RhdGljIGludAotdmNw
dV9vbl9yZXBscShjb25zdCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQoraXRlbV9vbl9yZXBscShjb25z
dCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogewogICAgIHJldHVybiAhbGlzdF9lbXB0eSgmc3ZjLT5y
ZXBscV9lbGVtKTsKIH0KQEAgLTI5MSw3ICsyOTEsNyBAQCB2Y3B1X29uX3JlcGxxKGNvbnN0IHN0
cnVjdCBydF9pdGVtICpzdmMpCiAgKiBPdGhlcndpc2UsIHJldHVybiB2YWx1ZSA8IDAKICAqLwog
c3RhdGljIHNfdGltZV90Ci1jb21wYXJlX3ZjcHVfcHJpb3JpdHkoY29uc3Qgc3RydWN0IHJ0X2l0
ZW0gKnYxLCBjb25zdCBzdHJ1Y3QgcnRfaXRlbSAqdjIpCitjb21wYXJlX2l0ZW1fcHJpb3JpdHko
Y29uc3Qgc3RydWN0IHJ0X2l0ZW0gKnYxLCBjb25zdCBzdHJ1Y3QgcnRfaXRlbSAqdjIpCiB7CiAg
ICAgaW50IHByaW8gPSB2Mi0+cHJpb3JpdHlfbGV2ZWwgLSB2MS0+cHJpb3JpdHlfbGV2ZWw7CiAK
QEAgLTMwMiwxNSArMzAyLDE1IEBAIGNvbXBhcmVfdmNwdV9wcmlvcml0eShjb25zdCBzdHJ1Y3Qg
cnRfaXRlbSAqdjEsIGNvbnN0IHN0cnVjdCBydF9pdGVtICp2MikKIH0KIAogLyoKLSAqIERlYnVn
IHJlbGF0ZWQgY29kZSwgZHVtcCB2Y3B1L2NwdSBpbmZvcm1hdGlvbgorICogRGVidWcgcmVsYXRl
ZCBjb2RlLCBkdW1wIGl0ZW0vY3B1IGluZm9ybWF0aW9uCiAgKi8KIHN0YXRpYyB2b2lkCi1ydF9k
dW1wX3ZjcHUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBjb25zdCBzdHJ1Y3QgcnRfaXRl
bSAqc3ZjKQorcnRfZHVtcF9pdGVtKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgY29uc3Qg
c3RydWN0IHJ0X2l0ZW0gKnN2YykKIHsKICAgICBjcHVtYXNrX3QgKmNwdXBvb2xfbWFzaywgKm1h
c2s7CiAKICAgICBBU1NFUlQoc3ZjICE9IE5VTEwpOwotICAgIC8qIGlkbGUgdmNwdSAqLworICAg
IC8qIGlkbGUgaXRlbSAqLwogICAgIGlmKCBzdmMtPnNkb20gPT0gTlVMTCApCiAgICAgewogICAg
ICAgICBwcmludGsoIlxuIik7CkBAIC0zMjEsMjAgKzMyMSwyMCBAQCBydF9kdW1wX3ZjcHUoY29u
c3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBjb25zdCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogICAg
ICAqIFdlIGNhbid0IGp1c3QgdXNlICdjcHVtYXNrX3NjcmF0Y2gnIGJlY2F1c2UgdGhlIGR1bXBp
bmcgY2FuCiAgICAgICogaGFwcGVuIGZyb20gYSBwQ1BVIG91dHNpZGUgb2YgdGhpcyBzY2hlZHVs
ZXIncyBjcHVwb29sLCBhbmQKICAgICAgKiBoZW5jZSBpdCdzIG5vdCByaWdodCB0byB1c2UgaXRz
IHBDUFUncyBzY3JhdGNoIG1hc2suCi0gICAgICogT24gdGhlIG90aGVyIGhhbmQsIGl0IGlzIHNh
ZmUgdG8gdXNlIHN2Yy0+dmNwdS0+cHJvY2Vzc29yJ3MKKyAgICAgKiBPbiB0aGUgb3RoZXIgaGFu
ZCwgaXQgaXMgc2FmZSB0byB1c2Ugc2NoZWRfaXRlbV9jcHUoc3ZjLT5pdGVtKSdzCiAgICAgICog
b3duIHNjcmF0Y2ggc3BhY2UsIHNpbmNlIHdlIGhvbGQgdGhlIHJ1bnF1ZXVlIGxvY2suCiAgICAg
ICovCi0gICAgbWFzayA9IGNwdW1hc2tfc2NyYXRjaF9jcHUoc3ZjLT52Y3B1LT5wcm9jZXNzb3Ip
OworICAgIG1hc2sgPSBjcHVtYXNrX3NjcmF0Y2hfY3B1KHNjaGVkX2l0ZW1fY3B1KHN2Yy0+aXRl
bSkpOwogCi0gICAgY3B1cG9vbF9tYXNrID0gY3B1cG9vbF9kb21haW5fY3B1bWFzayhzdmMtPnZj
cHUtPmRvbWFpbik7Ci0gICAgY3B1bWFza19hbmQobWFzaywgY3B1cG9vbF9tYXNrLCBzdmMtPnZj
cHUtPnNjaGVkX2l0ZW0tPmNwdV9oYXJkX2FmZmluaXR5KTsKKyAgICBjcHVwb29sX21hc2sgPSBj
cHVwb29sX2RvbWFpbl9jcHVtYXNrKHN2Yy0+aXRlbS0+ZG9tYWluKTsKKyAgICBjcHVtYXNrX2Fu
ZChtYXNrLCBjcHVwb29sX21hc2ssIHN2Yy0+aXRlbS0+Y3B1X2hhcmRfYWZmaW5pdHkpOwogICAg
IHByaW50aygiWyU1ZC4lLTJ1XSBjcHUgJXUsICglIlBSSV9zdGltZSIsICUiUFJJX3N0aW1lIiks
IgogICAgICAgICAgICAiIGN1cl9iPSUiUFJJX3N0aW1lIiBjdXJfZD0lIlBSSV9zdGltZSIgbGFz
dF9zdGFydD0lIlBSSV9zdGltZSJcbiIKICAgICAgICAgICAgIiBcdFx0IHByaW9yaXR5X2xldmVs
PSVkIGhhc19leHRyYXRpbWU9JWRcbiIKICAgICAgICAgICAgIiBcdFx0IG9uUT0lZCBydW5uYWJs
ZT0lZCBmbGFncz0leCBlZmZlY3RpdmUgaGFyZF9hZmZpbml0eT0lKnBibFxuIiwKLSAgICAgICAg
ICAgIHN2Yy0+dmNwdS0+ZG9tYWluLT5kb21haW5faWQsCi0gICAgICAgICAgICBzdmMtPnZjcHUt
PnZjcHVfaWQsCi0gICAgICAgICAgICBzdmMtPnZjcHUtPnByb2Nlc3NvciwKKyAgICAgICAgICAg
IHN2Yy0+aXRlbS0+ZG9tYWluLT5kb21haW5faWQsCisgICAgICAgICAgICBzdmMtPml0ZW0tPml0
ZW1faWQsCisgICAgICAgICAgICBzY2hlZF9pdGVtX2NwdShzdmMtPml0ZW0pLAogICAgICAgICAg
ICAgc3ZjLT5wZXJpb2QsCiAgICAgICAgICAgICBzdmMtPmJ1ZGdldCwKICAgICAgICAgICAgIHN2
Yy0+Y3VyX2J1ZGdldCwKQEAgLTM0Miw4ICszNDIsOCBAQCBydF9kdW1wX3ZjcHUoY29uc3Qgc3Ry
dWN0IHNjaGVkdWxlciAqb3BzLCBjb25zdCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogICAgICAgICAg
ICAgc3ZjLT5sYXN0X3N0YXJ0LAogICAgICAgICAgICAgc3ZjLT5wcmlvcml0eV9sZXZlbCwKICAg
ICAgICAgICAgIGhhc19leHRyYXRpbWUoc3ZjKSwKLSAgICAgICAgICAgIHZjcHVfb25fcShzdmMp
LAotICAgICAgICAgICAgdmNwdV9ydW5uYWJsZShzdmMtPnZjcHUpLAorICAgICAgICAgICAgaXRl
bV9vbl9xKHN2YyksCisgICAgICAgICAgICBpdGVtX3J1bm5hYmxlKHN2Yy0+aXRlbSksCiAgICAg
ICAgICAgICBzdmMtPmZsYWdzLAogICAgICAgICAgICAgbnJfY3B1X2lkcywgY3B1bWFza19iaXRz
KG1hc2spKTsKIH0KQEAgLTM1NywxMSArMzU3LDExIEBAIHJ0X2R1bXBfcGNwdShjb25zdCBzdHJ1
Y3Qgc2NoZWR1bGVyICpvcHMsIGludCBjcHUpCiAKICAgICBzcGluX2xvY2tfaXJxc2F2ZSgmcHJ2
LT5sb2NrLCBmbGFncyk7CiAgICAgcHJpbnRrKCJDUFVbJTAyZF1cbiIsIGNwdSk7Ci0gICAgLyog
Y3VycmVudCBWQ1BVIChub3RoaW5nIHRvIHNheSBpZiB0aGF0J3MgdGhlIGlkbGUgdmNwdSkuICov
CisgICAgLyogY3VycmVudCBJVEVNIChub3RoaW5nIHRvIHNheSBpZiB0aGF0J3MgdGhlIGlkbGUg
aXRlbSkuICovCiAgICAgc3ZjID0gcnRfaXRlbShjdXJyX29uX2NwdShjcHUpKTsKLSAgICBpZiAo
IHN2YyAmJiAhaXNfaWRsZV92Y3B1KHN2Yy0+dmNwdSkgKQorICAgIGlmICggc3ZjICYmICFpc19p
ZGxlX2l0ZW0oc3ZjLT5pdGVtKSApCiAgICAgewotICAgICAgICBydF9kdW1wX3ZjcHUob3BzLCBz
dmMpOworICAgICAgICBydF9kdW1wX2l0ZW0ob3BzLCBzdmMpOwogICAgIH0KICAgICBzcGluX3Vu
bG9ja19pcnFyZXN0b3JlKCZwcnYtPmxvY2ssIGZsYWdzKTsKIH0KQEAgLTM4OCwzNSArMzg4LDM1
IEBAIHJ0X2R1bXAoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzKQogICAgIGxpc3RfZm9yX2Vh
Y2ggKCBpdGVyLCBydW5xICkKICAgICB7CiAgICAgICAgIHN2YyA9IHFfZWxlbShpdGVyKTsKLSAg
ICAgICAgcnRfZHVtcF92Y3B1KG9wcywgc3ZjKTsKKyAgICAgICAgcnRfZHVtcF9pdGVtKG9wcywg
c3ZjKTsKICAgICB9CiAKICAgICBwcmludGsoIkdsb2JhbCBEZXBsZXRlZFF1ZXVlIGluZm86XG4i
KTsKICAgICBsaXN0X2Zvcl9lYWNoICggaXRlciwgZGVwbGV0ZWRxICkKICAgICB7CiAgICAgICAg
IHN2YyA9IHFfZWxlbShpdGVyKTsKLSAgICAgICAgcnRfZHVtcF92Y3B1KG9wcywgc3ZjKTsKKyAg
ICAgICAgcnRfZHVtcF9pdGVtKG9wcywgc3ZjKTsKICAgICB9CiAKICAgICBwcmludGsoIkdsb2Jh
bCBSZXBsZW5pc2htZW50IEV2ZW50cyBpbmZvOlxuIik7CiAgICAgbGlzdF9mb3JfZWFjaCAoIGl0
ZXIsIHJlcGxxICkKICAgICB7CiAgICAgICAgIHN2YyA9IHJlcGxxX2VsZW0oaXRlcik7Ci0gICAg
ICAgIHJ0X2R1bXBfdmNwdShvcHMsIHN2Yyk7CisgICAgICAgIHJ0X2R1bXBfaXRlbShvcHMsIHN2
Yyk7CiAgICAgfQogCiAgICAgcHJpbnRrKCJEb21haW4gaW5mbzpcbiIpOwogICAgIGxpc3RfZm9y
X2VhY2ggKCBpdGVyLCAmcHJ2LT5zZG9tICkKICAgICB7Ci0gICAgICAgIHN0cnVjdCB2Y3B1ICp2
OworICAgICAgICBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbTsKIAogICAgICAgICBzZG9tID0gbGlz
dF9lbnRyeShpdGVyLCBzdHJ1Y3QgcnRfZG9tLCBzZG9tX2VsZW0pOwogICAgICAgICBwcmludGso
Ilx0ZG9tYWluOiAlZFxuIiwgc2RvbS0+ZG9tLT5kb21haW5faWQpOwogCi0gICAgICAgIGZvcl9l
YWNoX3ZjcHUgKCBzZG9tLT5kb20sIHYgKQorICAgICAgICBmb3JfZWFjaF9zY2hlZF9pdGVtICgg
c2RvbS0+ZG9tLCBpdGVtICkKICAgICAgICAgewotICAgICAgICAgICAgc3ZjID0gcnRfaXRlbSh2
LT5zY2hlZF9pdGVtKTsKLSAgICAgICAgICAgIHJ0X2R1bXBfdmNwdShvcHMsIHN2Yyk7CisgICAg
ICAgICAgICBzdmMgPSBydF9pdGVtKGl0ZW0pOworICAgICAgICAgICAgcnRfZHVtcF9pdGVtKG9w
cywgc3ZjKTsKICAgICAgICAgfQogICAgIH0KIApAQCAtNDU4LDEyICs0NTgsMTIgQEAgcnRfdXBk
YXRlX2RlYWRsaW5lKHNfdGltZV90IG5vdywgc3RydWN0IHJ0X2l0ZW0gKnN2YykKICAgICAvKiBU
UkFDRSAqLwogICAgIHsKICAgICAgICAgc3RydWN0IF9fcGFja2VkIHsKLSAgICAgICAgICAgIHVu
c2lnbmVkIHZjcHU6MTYsIGRvbToxNjsKKyAgICAgICAgICAgIHVuc2lnbmVkIGl0ZW06MTYsIGRv
bToxNjsKICAgICAgICAgICAgIHVuc2lnbmVkIHByaW9yaXR5X2xldmVsOwogICAgICAgICAgICAg
dWludDY0X3QgY3VyX2RlYWRsaW5lLCBjdXJfYnVkZ2V0OwogICAgICAgICB9IGQ7Ci0gICAgICAg
IGQuZG9tID0gc3ZjLT52Y3B1LT5kb21haW4tPmRvbWFpbl9pZDsKLSAgICAgICAgZC52Y3B1ID0g
c3ZjLT52Y3B1LT52Y3B1X2lkOworICAgICAgICBkLmRvbSA9IHN2Yy0+aXRlbS0+ZG9tYWluLT5k
b21haW5faWQ7CisgICAgICAgIGQuaXRlbSA9IHN2Yy0+aXRlbS0+aXRlbV9pZDsKICAgICAgICAg
ZC5wcmlvcml0eV9sZXZlbCA9IHN2Yy0+cHJpb3JpdHlfbGV2ZWw7CiAgICAgICAgIGQuY3VyX2Rl
YWRsaW5lID0gKHVpbnQ2NF90KSBzdmMtPmN1cl9kZWFkbGluZTsKICAgICAgICAgZC5jdXJfYnVk
Z2V0ID0gKHVpbnQ2NF90KSBzdmMtPmN1cl9idWRnZXQ7CkBAIC00NzYsMTUgKzQ3NiwxNSBAQCBy
dF91cGRhdGVfZGVhZGxpbmUoc190aW1lX3Qgbm93LCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogfQog
CiAvKgotICogSGVscGVycyBmb3IgcmVtb3ZpbmcgYW5kIGluc2VydGluZyBhIHZjcHUgaW4gYSBx
dWV1ZQotICogdGhhdCBpcyBiZWluZyBrZXB0IG9yZGVyZWQgYnkgdGhlIHZjcHVzJyBkZWFkbGlu
ZXMgKGFzIEVERgorICogSGVscGVycyBmb3IgcmVtb3ZpbmcgYW5kIGluc2VydGluZyBhbiBpdGVt
IGluIGEgcXVldWUKKyAqIHRoYXQgaXMgYmVpbmcga2VwdCBvcmRlcmVkIGJ5IHRoZSBpdGVtcycg
ZGVhZGxpbmVzIChhcyBFREYKICAqIG1hbmRhdGVzKS4KICAqCi0gKiBGb3IgY2FsbGVycycgY29u
dmVuaWVuY2UsIHRoZSB2Y3B1IHJlbW92aW5nIGhlbHBlciByZXR1cm5zCi0gKiB0cnVlIGlmIHRo
ZSB2Y3B1IHJlbW92ZWQgd2FzIHRoZSBvbmUgYXQgdGhlIGZyb250IG9mIHRoZQorICogRm9yIGNh
bGxlcnMnIGNvbnZlbmllbmNlLCB0aGUgaXRlbSByZW1vdmluZyBoZWxwZXIgcmV0dXJucworICog
dHJ1ZSBpZiB0aGUgaXRlbSByZW1vdmVkIHdhcyB0aGUgb25lIGF0IHRoZSBmcm9udCBvZiB0aGUK
ICAqIHF1ZXVlOyBzaW1pbGFybHksIHRoZSBpbnNlcnRpbmcgaGVscGVyIHJldHVybnMgdHJ1ZSBp
ZiB0aGUKICAqIGluc2VydGVkIGVuZGVkIGF0IHRoZSBmcm9udCBvZiB0aGUgcXVldWUgKGkuZS4s
IGluIGJvdGgKLSAqIGNhc2VzLCBpZiB0aGUgdmNwdSB3aXRoIHRoZSBlYXJsaWVzdCBkZWFkbGlu
ZSBpcyB3aGF0IHdlCisgKiBjYXNlcywgaWYgdGhlIGl0ZW0gd2l0aCB0aGUgZWFybGllc3QgZGVh
ZGxpbmUgaXMgd2hhdCB3ZQogICogYXJlIGRlYWxpbmcgd2l0aCkuCiAgKi8KIHN0YXRpYyBpbmxp
bmUgYm9vbApAQCAtNTEwLDcgKzUxMCw3IEBAIGRlYWRsaW5lX3F1ZXVlX2luc2VydChzdHJ1Y3Qg
cnRfaXRlbSAqICgqcWVsZW0pKHN0cnVjdCBsaXN0X2hlYWQgKiksCiAgICAgbGlzdF9mb3JfZWFj
aCAoIGl0ZXIsIHF1ZXVlICkKICAgICB7CiAgICAgICAgIHN0cnVjdCBydF9pdGVtICogaXRlcl9z
dmMgPSAoKnFlbGVtKShpdGVyKTsKLSAgICAgICAgaWYgKCBjb21wYXJlX3ZjcHVfcHJpb3JpdHko
c3ZjLCBpdGVyX3N2YykgPiAwICkKKyAgICAgICAgaWYgKCBjb21wYXJlX2l0ZW1fcHJpb3JpdHko
c3ZjLCBpdGVyX3N2YykgPiAwICkKICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBwb3MrKzsK
ICAgICB9CkBAIC01MjUsNyArNTI1LDcgQEAgZGVhZGxpbmVfcXVldWVfaW5zZXJ0KHN0cnVjdCBy
dF9pdGVtICogKCpxZWxlbSkoc3RydWN0IGxpc3RfaGVhZCAqKSwKIHN0YXRpYyBpbmxpbmUgdm9p
ZAogcV9yZW1vdmUoc3RydWN0IHJ0X2l0ZW0gKnN2YykKIHsKLSAgICBBU1NFUlQoIHZjcHVfb25f
cShzdmMpICk7CisgICAgQVNTRVJUKCBpdGVtX29uX3Eoc3ZjKSApOwogICAgIGxpc3RfZGVsX2lu
aXQoJnN2Yy0+cV9lbGVtKTsKIH0KIApAQCAtNTM1LDE0ICs1MzUsMTQgQEAgcmVwbHFfcmVtb3Zl
KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHJ0X2l0ZW0gKnN2YykKICAgICBz
dHJ1Y3QgcnRfcHJpdmF0ZSAqcHJ2ID0gcnRfcHJpdihvcHMpOwogICAgIHN0cnVjdCBsaXN0X2hl
YWQgKnJlcGxxID0gcnRfcmVwbHEob3BzKTsKIAotICAgIEFTU0VSVCggdmNwdV9vbl9yZXBscShz
dmMpICk7CisgICAgQVNTRVJUKCBpdGVtX29uX3JlcGxxKHN2YykgKTsKIAogICAgIGlmICggZGVh
ZGxpbmVfcXVldWVfcmVtb3ZlKHJlcGxxLCAmc3ZjLT5yZXBscV9lbGVtKSApCiAgICAgewogICAg
ICAgICAvKgogICAgICAgICAgKiBUaGUgcmVwbGVuaXNobWVudCB0aW1lciBuZWVkcyB0byBiZSBz
ZXQgdG8gZmlyZSB3aGVuIGEKLSAgICAgICAgICogcmVwbGVuaXNobWVudCBmb3IgdGhlIHZjcHUg
YXQgdGhlIGZyb250IG9mIHRoZSByZXBsZW5pc2htZW50Ci0gICAgICAgICAqIHF1ZXVlIGlzIGR1
ZS4gSWYgaXQgaXMgc3VjaCB2Y3B1IHRoYXQgd2UganVzdCByZW1vdmVkLCB3ZSBtYXkKKyAgICAg
ICAgICogcmVwbGVuaXNobWVudCBmb3IgdGhlIGl0ZW0gYXQgdGhlIGZyb250IG9mIHRoZSByZXBs
ZW5pc2htZW50CisgICAgICAgICAqIHF1ZXVlIGlzIGR1ZS4gSWYgaXQgaXMgc3VjaCBpdGVtIHRo
YXQgd2UganVzdCByZW1vdmVkLCB3ZSBtYXkKICAgICAgICAgICogbmVlZCB0byByZXByb2dyYW0g
dGhlIHRpbWVyLgogICAgICAgICAgKi8KICAgICAgICAgaWYgKCAhbGlzdF9lbXB0eShyZXBscSkg
KQpAQCAtNTU3LDcgKzU1Nyw3IEBAIHJlcGxxX3JlbW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVy
ICpvcHMsIHN0cnVjdCBydF9pdGVtICpzdmMpCiAKIC8qCiAgKiBJbnNlcnQgc3ZjIHdpdGggYnVk
Z2V0IGluIFJ1blEgYWNjb3JkaW5nIHRvIEVERjoKLSAqIHZjcHVzIHdpdGggc21hbGxlciBkZWFk
bGluZXMgZ28gZmlyc3QuCisgKiBpdGVtcyB3aXRoIHNtYWxsZXIgZGVhZGxpbmVzIGdvIGZpcnN0
LgogICogSW5zZXJ0IHN2YyB3aXRob3V0IGJ1ZGdldCBpbiBEZXBsZXRlZFEgdW5zb3J0ZWQ7CiAg
Ki8KIHN0YXRpYyB2b2lkCkBAIC01NjcsOCArNTY3LDggQEAgcnVucV9pbnNlcnQoY29uc3Qgc3Ry
dWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogICAgIHN0cnVjdCBsaXN0
X2hlYWQgKnJ1bnEgPSBydF9ydW5xKG9wcyk7CiAKICAgICBBU1NFUlQoIHNwaW5faXNfbG9ja2Vk
KCZwcnYtPmxvY2spICk7Ci0gICAgQVNTRVJUKCAhdmNwdV9vbl9xKHN2YykgKTsKLSAgICBBU1NF
UlQoIHZjcHVfb25fcmVwbHEoc3ZjKSApOworICAgIEFTU0VSVCggIWl0ZW1fb25fcShzdmMpICk7
CisgICAgQVNTRVJUKCBpdGVtX29uX3JlcGxxKHN2YykgKTsKIAogICAgIC8qIGFkZCBzdmMgdG8g
cnVucSBpZiBzdmMgc3RpbGwgaGFzIGJ1ZGdldCBvciBpdHMgZXh0cmF0aW1lIGlzIHNldCAqLwog
ICAgIGlmICggc3ZjLT5jdXJfYnVkZ2V0ID4gMCB8fApAQCAtNTg0LDcgKzU4NCw3IEBAIHJlcGxx
X2luc2VydChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBydF9pdGVtICpzdmMp
CiAgICAgc3RydWN0IGxpc3RfaGVhZCAqcmVwbHEgPSBydF9yZXBscShvcHMpOwogICAgIHN0cnVj
dCBydF9wcml2YXRlICpwcnYgPSBydF9wcml2KG9wcyk7CiAKLSAgICBBU1NFUlQoICF2Y3B1X29u
X3JlcGxxKHN2YykgKTsKKyAgICBBU1NFUlQoICFpdGVtX29uX3JlcGxxKHN2YykgKTsKIAogICAg
IC8qCiAgICAgICogVGhlIHRpbWVyIG1heSBiZSByZS1wcm9ncmFtbWVkIGlmIHN2YyBpcyBpbnNl
cnRlZApAQCAtNjA3LDEyICs2MDcsMTIgQEAgcmVwbHFfcmVpbnNlcnQoY29uc3Qgc3RydWN0IHNj
aGVkdWxlciAqb3BzLCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogICAgIHN0cnVjdCBydF9pdGVtICpy
ZWFybV9zdmMgPSBzdmM7CiAgICAgYm9vbF90IHJlYXJtID0gMDsKIAotICAgIEFTU0VSVCggdmNw
dV9vbl9yZXBscShzdmMpICk7CisgICAgQVNTRVJUKCBpdGVtX29uX3JlcGxxKHN2YykgKTsKIAog
ICAgIC8qCiAgICAgICogSWYgc3ZjIHdhcyBhdCB0aGUgZnJvbnQgb2YgdGhlIHJlcGxlbmlzaG1l
bnQgcXVldWUsIHdlIGNlcnRhaW5seQogICAgICAqIG5lZWQgdG8gcmUtcHJvZ3JhbSB0aGUgdGlt
ZXIsIGFuZCB3ZSB3YW50IHRvIHVzZSB0aGUgZGVhZGxpbmUgb2YKLSAgICAgKiB0aGUgdmNwdSB3
aGljaCBpcyBub3cgYXQgdGhlIGZyb250IG9mIHRoZSBxdWV1ZSAod2hpY2ggbWF5IHN0aWxsCisg
ICAgICogdGhlIGl0ZW0gd2hpY2ggaXMgbm93IGF0IHRoZSBmcm9udCBvZiB0aGUgcXVldWUgKHdo
aWNoIG1heSBzdGlsbAogICAgICAqIGJlIHN2YyBvciBub3QpLgogICAgICAqCiAgICAgICogV2Ug
bWF5IGFsc28gbmVlZCB0byByZS1wcm9ncmFtLCBpZiBzdmMgaGFzIGJlZW4gcHV0IGF0IHRoZSBm
cm9udApAQCAtNjMyLDI0ICs2MzIsMjMgQEAgcmVwbHFfcmVpbnNlcnQoY29uc3Qgc3RydWN0IHNj
aGVkdWxlciAqb3BzLCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjKQogfQogCiAvKgotICogUGljayBhIHZh
bGlkIHJlc291cmNlIGZvciB0aGUgdmNwdSB2YwotICogVmFsaWQgcmVzb3VyY2Ugb2YgYSB2Y3B1
IGlzIGludGVzZWN0aW9uIG9mIHZjcHUncyBhZmZpbml0eQorICogUGljayBhIHZhbGlkIHJlc291
cmNlIGZvciB0aGUgaXRlbSB2YworICogVmFsaWQgcmVzb3VyY2Ugb2YgYW4gaXRlbSBpcyBpbnRl
c2VjdGlvbiBvZiBpdGVtJ3MgYWZmaW5pdHkKICAqIGFuZCBhdmFpbGFibGUgcmVzb3VyY2VzCiAg
Ki8KIHN0YXRpYyBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKgogcnRfcmVzX3BpY2soY29uc3Qgc3Ry
dWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSkKIHsKLSAgICBzdHJ1
Y3QgdmNwdSAqdmMgPSBpdGVtLT52Y3B1OwogICAgIGNwdW1hc2tfdCBjcHVzOwogICAgIGNwdW1h
c2tfdCAqb25saW5lOwogICAgIGludCBjcHU7CiAKLSAgICBvbmxpbmUgPSBjcHVwb29sX2RvbWFp
bl9jcHVtYXNrKHZjLT5kb21haW4pOworICAgIG9ubGluZSA9IGNwdXBvb2xfZG9tYWluX2NwdW1h
c2soaXRlbS0+ZG9tYWluKTsKICAgICBjcHVtYXNrX2FuZCgmY3B1cywgb25saW5lLCBpdGVtLT5j
cHVfaGFyZF9hZmZpbml0eSk7CiAKLSAgICBjcHUgPSBjcHVtYXNrX3Rlc3RfY3B1KHZjLT5wcm9j
ZXNzb3IsICZjcHVzKQotICAgICAgICAgICAgPyB2Yy0+cHJvY2Vzc29yCi0gICAgICAgICAgICA6
IGNwdW1hc2tfY3ljbGUodmMtPnByb2Nlc3NvciwgJmNwdXMpOworICAgIGNwdSA9IGNwdW1hc2tf
dGVzdF9jcHUoc2NoZWRfaXRlbV9jcHUoaXRlbSksICZjcHVzKQorICAgICAgICAgICAgPyBzY2hl
ZF9pdGVtX2NwdShpdGVtKQorICAgICAgICAgICAgOiBjcHVtYXNrX2N5Y2xlKHNjaGVkX2l0ZW1f
Y3B1KGl0ZW0pLCAmY3B1cyk7CiAgICAgQVNTRVJUKCAhY3B1bWFza19lbXB0eSgmY3B1cykgJiYg
Y3B1bWFza190ZXN0X2NwdShjcHUsICZjcHVzKSApOwogCiAgICAgcmV0dXJuIHBlcl9jcHUoc2No
ZWRfcmVzLCBjcHUpOwpAQCAtNzM3LDcgKzczNiw3IEBAIHJ0X3N3aXRjaF9zY2hlZChzdHJ1Y3Qg
c2NoZWR1bGVyICpuZXdfb3BzLCB1bnNpZ25lZCBpbnQgY3B1LAogICAgIHN0cnVjdCBydF9wcml2
YXRlICpwcnYgPSBydF9wcml2KG5ld19vcHMpOwogICAgIHN0cnVjdCBydF9pdGVtICpzdmMgPSB2
ZGF0YTsKIAotICAgIEFTU0VSVCghcGRhdGEgJiYgc3ZjICYmIGlzX2lkbGVfdmNwdShzdmMtPnZj
cHUpKTsKKyAgICBBU1NFUlQoIXBkYXRhICYmIHN2YyAmJiBpc19pZGxlX2l0ZW0oc3ZjLT5pdGVt
KSk7CiAKICAgICAvKgogICAgICAqIFdlIGFyZSBob2xkaW5nIHRoZSBydW5xdWV1ZSBsb2NrIGFs
cmVhZHkgKGl0J3MgYmVlbiB0YWtlbiBpbgpAQCAtNzYxLDcgKzc2MCw3IEBAIHJ0X3N3aXRjaF9z
Y2hlZChzdHJ1Y3Qgc2NoZWR1bGVyICpuZXdfb3BzLCB1bnNpZ25lZCBpbnQgY3B1LAogICAgICAg
ICBkcHJpbnRrKFhFTkxPR19ERUJVRywgIlJURFM6IHRpbWVyIGluaXRpYWxpemVkIG9uIGNwdSAl
dVxuIiwgY3B1KTsKICAgICB9CiAKLSAgICBpZGxlX3ZjcHVbY3B1XS0+c2NoZWRfaXRlbS0+cHJp
diA9IHZkYXRhOworICAgIHNjaGVkX2lkbGVfaXRlbShjcHUpLT5wcml2ID0gdmRhdGE7CiAgICAg
cGVyX2NwdShzY2hlZHVsZXIsIGNwdSkgPSBuZXdfb3BzOwogICAgIHBlcl9jcHUoc2NoZWRfcmVz
LCBjcHUpLT5zY2hlZF9wcml2ID0gTlVMTDsgLyogbm8gcGRhdGEgKi8KIApAQCAtODQ5LDEwICs4
NDgsOSBAQCBydF9mcmVlX2RvbWRhdGEoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCB2b2lk
ICpkYXRhKQogc3RhdGljIHZvaWQgKgogcnRfYWxsb2NfdmRhdGEoY29uc3Qgc3RydWN0IHNjaGVk
dWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSwgdm9pZCAqZGQpCiB7Ci0gICAgc3Ry
dWN0IHZjcHUgKnZjID0gaXRlbS0+dmNwdTsKICAgICBzdHJ1Y3QgcnRfaXRlbSAqc3ZjOwogCi0g
ICAgLyogQWxsb2NhdGUgcGVyLVZDUFUgaW5mbyAqLworICAgIC8qIEFsbG9jYXRlIHBlci1JVEVN
IGluZm8gKi8KICAgICBzdmMgPSB4emFsbG9jKHN0cnVjdCBydF9pdGVtKTsKICAgICBpZiAoIHN2
YyA9PSBOVUxMICkKICAgICAgICAgcmV0dXJuIE5VTEw7CkBAIC04NjEsMTMgKzg1OSwxMyBAQCBy
dF9hbGxvY192ZGF0YShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hlZF9p
dGVtICppdGVtLCB2b2lkICpkZCkKICAgICBJTklUX0xJU1RfSEVBRCgmc3ZjLT5yZXBscV9lbGVt
KTsKICAgICBzdmMtPmZsYWdzID0gMFU7CiAgICAgc3ZjLT5zZG9tID0gZGQ7Ci0gICAgc3ZjLT52
Y3B1ID0gdmM7CisgICAgc3ZjLT5pdGVtID0gaXRlbTsKICAgICBzdmMtPmxhc3Rfc3RhcnQgPSAw
OwogCiAgICAgX19zZXRfYml0KF9fUlREU19leHRyYXRpbWUsICZzdmMtPmZsYWdzKTsKICAgICBz
dmMtPnByaW9yaXR5X2xldmVsID0gMDsKICAgICBzdmMtPnBlcmlvZCA9IFJURFNfREVGQVVMVF9Q
RVJJT0Q7Ci0gICAgaWYgKCAhaXNfaWRsZV92Y3B1KHZjKSApCisgICAgaWYgKCAhaXNfaWRsZV9p
dGVtKGl0ZW0pICkKICAgICAgICAgc3ZjLT5idWRnZXQgPSBSVERTX0RFRkFVTFRfQlVER0VUOwog
CiAgICAgU0NIRURfU1RBVF9DUkFOSyhpdGVtX2FsbG9jKTsKQEAgLTg4NywyMiArODg1LDIwIEBA
IHJ0X2ZyZWVfdmRhdGEoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCB2b2lkICpwcml2KQog
ICogSXQgaXMgY2FsbGVkIGluIHNjaGVkX21vdmVfZG9tYWluKCkgYW5kIHNjaGVkX2luaXRfdmNw
dQogICogaW4gc2NoZWR1bGUuYy4KICAqIFdoZW4gbW92ZSBhIGRvbWFpbiB0byBhIG5ldyBjcHVw
b29sLgotICogSXQgaW5zZXJ0cyB2Y3B1cyBvZiBtb3ZpbmcgZG9tYWluIHRvIHRoZSBzY2hlZHVs
ZXIncyBSdW5RIGluCisgKiBJdCBpbnNlcnRzIGl0ZW1zIG9mIG1vdmluZyBkb21haW4gdG8gdGhl
IHNjaGVkdWxlcidzIFJ1blEgaW4KICAqIGRlc3QuIGNwdXBvb2wuCiAgKi8KIHN0YXRpYyB2b2lk
CiBydF9pdGVtX2luc2VydChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hl
ZF9pdGVtICppdGVtKQogewotICAgIHN0cnVjdCB2Y3B1ICp2YyA9IGl0ZW0tPnZjcHU7CiAgICAg
c3RydWN0IHJ0X2l0ZW0gKnN2YyA9IHJ0X2l0ZW0oaXRlbSk7CiAgICAgc190aW1lX3Qgbm93Owog
ICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAKLSAgICBCVUdfT04oIGlzX2lkbGVfdmNwdSh2YykgKTsK
KyAgICBCVUdfT04oIGlzX2lkbGVfaXRlbShpdGVtKSApOwogCi0gICAgLyogVGhpcyBpcyBzYWZl
IGJlY2F1c2UgdmMgaXNuJ3QgeWV0IGJlaW5nIHNjaGVkdWxlZCAqLwotICAgIGl0ZW0tPnJlcyA9
IHJ0X3Jlc19waWNrKG9wcywgaXRlbSk7Ci0gICAgdmMtPnByb2Nlc3NvciA9IGl0ZW0tPnJlcy0+
cHJvY2Vzc29yOworICAgIC8qIFRoaXMgaXMgc2FmZSBiZWNhdXNlIGl0ZW0gaXNuJ3QgeWV0IGJl
aW5nIHNjaGVkdWxlZCAqLworICAgIHNjaGVkX3NldF9yZXMoaXRlbSwgcnRfcmVzX3BpY2sob3Bz
LCBpdGVtKSk7CiAKICAgICBsb2NrID0gaXRlbV9zY2hlZHVsZV9sb2NrX2lycShpdGVtKTsKIApA
QCAtOTEwLDcgKzkwNiw3IEBAIHJ0X2l0ZW1faW5zZXJ0KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIg
Km9wcywgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0pCiAgICAgaWYgKCBub3cgPj0gc3ZjLT5jdXJf
ZGVhZGxpbmUgKQogICAgICAgICBydF91cGRhdGVfZGVhZGxpbmUobm93LCBzdmMpOwogCi0gICAg
aWYgKCAhdmNwdV9vbl9xKHN2YykgJiYgdmNwdV9ydW5uYWJsZSh2YykgKQorICAgIGlmICggIWl0
ZW1fb25fcShzdmMpICYmIGl0ZW1fcnVubmFibGUoaXRlbSkgKQogICAgIHsKICAgICAgICAgcmVw
bHFfaW5zZXJ0KG9wcywgc3ZjKTsKIApAQCAtOTM3LDEwICs5MzMsMTAgQEAgcnRfaXRlbV9yZW1v
dmUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSkK
ICAgICBCVUdfT04oIHNkb20gPT0gTlVMTCApOwogCiAgICAgbG9jayA9IGl0ZW1fc2NoZWR1bGVf
bG9ja19pcnEoaXRlbSk7Ci0gICAgaWYgKCB2Y3B1X29uX3Eoc3ZjKSApCisgICAgaWYgKCBpdGVt
X29uX3Eoc3ZjKSApCiAgICAgICAgIHFfcmVtb3ZlKHN2Yyk7CiAKLSAgICBpZiAoIHZjcHVfb25f
cmVwbHEoc3ZjKSApCisgICAgaWYgKCBpdGVtX29uX3JlcGxxKHN2YykgKQogICAgICAgICByZXBs
cV9yZW1vdmUob3BzLHN2Yyk7CiAKICAgICBpdGVtX3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywg
aXRlbSk7CkBAIC05NTQsOCArOTUwLDggQEAgYnVybl9idWRnZXQoY29uc3Qgc3RydWN0IHNjaGVk
dWxlciAqb3BzLCBzdHJ1Y3QgcnRfaXRlbSAqc3ZjLCBzX3RpbWVfdCBub3cpCiB7CiAgICAgc190
aW1lX3QgZGVsdGE7CiAKLSAgICAvKiBkb24ndCBidXJuIGJ1ZGdldCBmb3IgaWRsZSBWQ1BVICov
Ci0gICAgaWYgKCBpc19pZGxlX3ZjcHUoc3ZjLT52Y3B1KSApCisgICAgLyogZG9uJ3QgYnVybiBi
dWRnZXQgZm9yIGlkbGUgSVRFTSAqLworICAgIGlmICggaXNfaWRsZV9pdGVtKHN2Yy0+aXRlbSkg
KQogICAgICAgICByZXR1cm47CiAKICAgICAvKiBidXJuIGF0IG5hbm9zZWNvbmRzIGxldmVsICov
CkBAIC05OTIsMTQgKzk4OCwxNCBAQCBidXJuX2J1ZGdldChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVy
ICpvcHMsIHN0cnVjdCBydF9pdGVtICpzdmMsIHNfdGltZV90IG5vdykKICAgICAvKiBUUkFDRSAq
LwogICAgIHsKICAgICAgICAgc3RydWN0IF9fcGFja2VkIHsKLSAgICAgICAgICAgIHVuc2lnbmVk
IHZjcHU6MTYsIGRvbToxNjsKKyAgICAgICAgICAgIHVuc2lnbmVkIGl0ZW06MTYsIGRvbToxNjsK
ICAgICAgICAgICAgIHVpbnQ2NF90IGN1cl9idWRnZXQ7CiAgICAgICAgICAgICBpbnQgZGVsdGE7
CiAgICAgICAgICAgICB1bnNpZ25lZCBwcmlvcml0eV9sZXZlbDsKICAgICAgICAgICAgIGJvb2wg
aGFzX2V4dHJhdGltZTsKICAgICAgICAgfSBkOwotICAgICAgICBkLmRvbSA9IHN2Yy0+dmNwdS0+
ZG9tYWluLT5kb21haW5faWQ7Ci0gICAgICAgIGQudmNwdSA9IHN2Yy0+dmNwdS0+dmNwdV9pZDsK
KyAgICAgICAgZC5kb20gPSBzdmMtPml0ZW0tPmRvbWFpbi0+ZG9tYWluX2lkOworICAgICAgICBk
Lml0ZW0gPSBzdmMtPml0ZW0tPml0ZW1faWQ7CiAgICAgICAgIGQuY3VyX2J1ZGdldCA9ICh1aW50
NjRfdCkgc3ZjLT5jdXJfYnVkZ2V0OwogICAgICAgICBkLmRlbHRhID0gZGVsdGE7CiAgICAgICAg
IGQucHJpb3JpdHlfbGV2ZWwgPSBzdmMtPnByaW9yaXR5X2xldmVsOwpAQCAtMTAyOSw5ICsxMDI1
LDggQEAgcnVucV9waWNrKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgY29uc3QgY3B1bWFz
a190ICptYXNrKQogICAgICAgICBpdGVyX3N2YyA9IHFfZWxlbShpdGVyKTsKIAogICAgICAgICAv
KiBtYXNrIGNwdV9oYXJkX2FmZmluaXR5ICYgY3B1cG9vbCAmIG1hc2sgKi8KLSAgICAgICAgb25s
aW5lID0gY3B1cG9vbF9kb21haW5fY3B1bWFzayhpdGVyX3N2Yy0+dmNwdS0+ZG9tYWluKTsKLSAg
ICAgICAgY3B1bWFza19hbmQoJmNwdV9jb21tb24sIG9ubGluZSwKLSAgICAgICAgICAgICAgICAg
ICAgaXRlcl9zdmMtPnZjcHUtPnNjaGVkX2l0ZW0tPmNwdV9oYXJkX2FmZmluaXR5KTsKKyAgICAg
ICAgb25saW5lID0gY3B1cG9vbF9kb21haW5fY3B1bWFzayhpdGVyX3N2Yy0+aXRlbS0+ZG9tYWlu
KTsKKyAgICAgICAgY3B1bWFza19hbmQoJmNwdV9jb21tb24sIG9ubGluZSwgaXRlcl9zdmMtPml0
ZW0tPmNwdV9oYXJkX2FmZmluaXR5KTsKICAgICAgICAgY3B1bWFza19hbmQoJmNwdV9jb21tb24s
IG1hc2ssICZjcHVfY29tbW9uKTsKICAgICAgICAgaWYgKCBjcHVtYXNrX2VtcHR5KCZjcHVfY29t
bW9uKSApCiAgICAgICAgICAgICBjb250aW51ZTsKQEAgLTEwNDcsMTEgKzEwNDIsMTEgQEAgcnVu
cV9waWNrKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgY29uc3QgY3B1bWFza190ICptYXNr
KQogICAgICAgICBpZiggc3ZjICE9IE5VTEwgKQogICAgICAgICB7CiAgICAgICAgICAgICBzdHJ1
Y3QgX19wYWNrZWQgewotICAgICAgICAgICAgICAgIHVuc2lnbmVkIHZjcHU6MTYsIGRvbToxNjsK
KyAgICAgICAgICAgICAgICB1bnNpZ25lZCBpdGVtOjE2LCBkb206MTY7CiAgICAgICAgICAgICAg
ICAgdWludDY0X3QgY3VyX2RlYWRsaW5lLCBjdXJfYnVkZ2V0OwogICAgICAgICAgICAgfSBkOwot
ICAgICAgICAgICAgZC5kb20gPSBzdmMtPnZjcHUtPmRvbWFpbi0+ZG9tYWluX2lkOwotICAgICAg
ICAgICAgZC52Y3B1ID0gc3ZjLT52Y3B1LT52Y3B1X2lkOworICAgICAgICAgICAgZC5kb20gPSBz
dmMtPml0ZW0tPmRvbWFpbi0+ZG9tYWluX2lkOworICAgICAgICAgICAgZC5pdGVtID0gc3ZjLT5p
dGVtLT5pdGVtX2lkOwogICAgICAgICAgICAgZC5jdXJfZGVhZGxpbmUgPSAodWludDY0X3QpIHN2
Yy0+Y3VyX2RlYWRsaW5lOwogICAgICAgICAgICAgZC5jdXJfYnVkZ2V0ID0gKHVpbnQ2NF90KSBz
dmMtPmN1cl9idWRnZXQ7CiAgICAgICAgICAgICB0cmFjZV92YXIoVFJDX1JURFNfUlVOUV9QSUNL
LCAxLApAQCAtMTA3NSw2ICsxMDcwLDcgQEAgcnRfc2NoZWR1bGUoY29uc3Qgc3RydWN0IHNjaGVk
dWxlciAqb3BzLCBzX3RpbWVfdCBub3csIGJvb2xfdCB0YXNrbGV0X3dvcmtfc2NoZWQKICAgICBz
dHJ1Y3QgcnRfaXRlbSAqY29uc3Qgc2N1cnIgPSBydF9pdGVtKGN1cnJlbnQtPnNjaGVkX2l0ZW0p
OwogICAgIHN0cnVjdCBydF9pdGVtICpzbmV4dCA9IE5VTEw7CiAgICAgc3RydWN0IHRhc2tfc2xp
Y2UgcmV0ID0geyAubWlncmF0ZWQgPSAwIH07CisgICAgc3RydWN0IHNjaGVkX2l0ZW0gKmN1cnJp
dGVtID0gY3VycmVudC0+c2NoZWRfaXRlbTsKIAogICAgIC8qIFRSQUNFICovCiAgICAgewpAQCAt
MTA4NCw3ICsxMDgwLDcgQEAgcnRfc2NoZWR1bGUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3Bz
LCBzX3RpbWVfdCBub3csIGJvb2xfdCB0YXNrbGV0X3dvcmtfc2NoZWQKICAgICAgICAgZC5jcHUg
PSBjcHU7CiAgICAgICAgIGQudGFza2xldCA9IHRhc2tsZXRfd29ya19zY2hlZHVsZWQ7CiAgICAg
ICAgIGQudGlja2xlZCA9IGNwdW1hc2tfdGVzdF9jcHUoY3B1LCAmcHJ2LT50aWNrbGVkKTsKLSAg
ICAgICAgZC5pZGxlID0gaXNfaWRsZV92Y3B1KGN1cnJlbnQpOworICAgICAgICBkLmlkbGUgPSBp
c19pZGxlX2l0ZW0oY3Vycml0ZW0pOwogICAgICAgICB0cmFjZV92YXIoVFJDX1JURFNfU0NIRURV
TEUsIDEsCiAgICAgICAgICAgICAgICAgICBzaXplb2YoZCksCiAgICAgICAgICAgICAgICAgICAo
dW5zaWduZWQgY2hhciAqKSZkKTsKQEAgLTEwOTMsNzIgKzEwODksNzAgQEAgcnRfc2NoZWR1bGUo
Y29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzX3RpbWVfdCBub3csIGJvb2xfdCB0YXNrbGV0
X3dvcmtfc2NoZWQKICAgICAvKiBjbGVhciB0aWNrZWQgYml0IG5vdyB0aGF0IHdlJ3ZlIGJlZW4g
c2NoZWR1bGVkICovCiAgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1LCAmcHJ2LT50aWNrbGVkKTsK
IAotICAgIC8qIGJ1cm5fYnVkZ2V0IHdvdWxkIHJldHVybiBmb3IgSURMRSBWQ1BVICovCisgICAg
LyogYnVybl9idWRnZXQgd291bGQgcmV0dXJuIGZvciBJRExFIElURU0gKi8KICAgICBidXJuX2J1
ZGdldChvcHMsIHNjdXJyLCBub3cpOwogCiAgICAgaWYgKCB0YXNrbGV0X3dvcmtfc2NoZWR1bGVk
ICkKICAgICB7CiAgICAgICAgIHRyYWNlX3ZhcihUUkNfUlREU19TQ0hFRF9UQVNLTEVULCAxLCAw
LCAgTlVMTCk7Ci0gICAgICAgIHNuZXh0ID0gcnRfaXRlbShpZGxlX3ZjcHVbY3B1XS0+c2NoZWRf
aXRlbSk7CisgICAgICAgIHNuZXh0ID0gcnRfaXRlbShzY2hlZF9pZGxlX2l0ZW0oY3B1KSk7CiAg
ICAgfQogICAgIGVsc2UKICAgICB7CiAgICAgICAgIHNuZXh0ID0gcnVucV9waWNrKG9wcywgY3B1
bWFza19vZihjcHUpKTsKICAgICAgICAgaWYgKCBzbmV4dCA9PSBOVUxMICkKLSAgICAgICAgICAg
IHNuZXh0ID0gcnRfaXRlbShpZGxlX3ZjcHVbY3B1XS0+c2NoZWRfaXRlbSk7CisgICAgICAgICAg
ICBzbmV4dCA9IHJ0X2l0ZW0oc2NoZWRfaWRsZV9pdGVtKGNwdSkpOwogCiAgICAgICAgIC8qIGlm
IHNjdXJyIGhhcyBoaWdoZXIgcHJpb3JpdHkgYW5kIGJ1ZGdldCwgc3RpbGwgcGljayBzY3VyciAq
LwotICAgICAgICBpZiAoICFpc19pZGxlX3ZjcHUoY3VycmVudCkgJiYKLSAgICAgICAgICAgICB2
Y3B1X3J1bm5hYmxlKGN1cnJlbnQpICYmCisgICAgICAgIGlmICggIWlzX2lkbGVfaXRlbShjdXJy
aXRlbSkgJiYKKyAgICAgICAgICAgICBpdGVtX3J1bm5hYmxlKGN1cnJpdGVtKSAmJgogICAgICAg
ICAgICAgIHNjdXJyLT5jdXJfYnVkZ2V0ID4gMCAmJgotICAgICAgICAgICAgICggaXNfaWRsZV92
Y3B1KHNuZXh0LT52Y3B1KSB8fAotICAgICAgICAgICAgICAgY29tcGFyZV92Y3B1X3ByaW9yaXR5
KHNjdXJyLCBzbmV4dCkgPiAwICkgKQorICAgICAgICAgICAgICggaXNfaWRsZV9pdGVtKHNuZXh0
LT5pdGVtKSB8fAorICAgICAgICAgICAgICAgY29tcGFyZV9pdGVtX3ByaW9yaXR5KHNjdXJyLCBz
bmV4dCkgPiAwICkgKQogICAgICAgICAgICAgc25leHQgPSBzY3VycjsKICAgICB9CiAKICAgICBp
ZiAoIHNuZXh0ICE9IHNjdXJyICYmCi0gICAgICAgICAhaXNfaWRsZV92Y3B1KGN1cnJlbnQpICYm
Ci0gICAgICAgICB2Y3B1X3J1bm5hYmxlKGN1cnJlbnQpICkKKyAgICAgICAgICFpc19pZGxlX2l0
ZW0oY3Vycml0ZW0pICYmCisgICAgICAgICBpdGVtX3J1bm5hYmxlKGN1cnJpdGVtKSApCiAgICAg
ICAgIF9fc2V0X2JpdChfX1JURFNfZGVsYXllZF9ydW5xX2FkZCwgJnNjdXJyLT5mbGFncyk7CiAK
ICAgICBzbmV4dC0+bGFzdF9zdGFydCA9IG5vdzsKLSAgICByZXQudGltZSA9ICAtMTsgLyogaWYg
YW4gaWRsZSB2Y3B1IGlzIHBpY2tlZCAqLwotICAgIGlmICggIWlzX2lkbGVfdmNwdShzbmV4dC0+
dmNwdSkgKQorICAgIHJldC50aW1lID0gIC0xOyAvKiBpZiBhbiBpZGxlIGl0ZW0gaXMgcGlja2Vk
ICovCisgICAgaWYgKCAhaXNfaWRsZV9pdGVtKHNuZXh0LT5pdGVtKSApCiAgICAgewogICAgICAg
ICBpZiAoIHNuZXh0ICE9IHNjdXJyICkKICAgICAgICAgewogICAgICAgICAgICAgcV9yZW1vdmUo
c25leHQpOwogICAgICAgICAgICAgX19zZXRfYml0KF9fUlREU19zY2hlZHVsZWQsICZzbmV4dC0+
ZmxhZ3MpOwogICAgICAgICB9Ci0gICAgICAgIGlmICggc25leHQtPnZjcHUtPnByb2Nlc3NvciAh
PSBjcHUgKQorICAgICAgICBpZiAoIHNjaGVkX2l0ZW1fY3B1KHNuZXh0LT5pdGVtKSAhPSBjcHUg
KQogICAgICAgICB7Ci0gICAgICAgICAgICBzbmV4dC0+dmNwdS0+cHJvY2Vzc29yID0gY3B1Owot
ICAgICAgICAgICAgc25leHQtPnZjcHUtPnNjaGVkX2l0ZW0tPnJlcyA9IHBlcl9jcHUoc2NoZWRf
cmVzLCBjcHUpOworICAgICAgICAgICAgc2NoZWRfc2V0X3JlcyhzbmV4dC0+aXRlbSwgcGVyX2Nw
dShzY2hlZF9yZXMsIGNwdSkpOwogICAgICAgICAgICAgcmV0Lm1pZ3JhdGVkID0gMTsKICAgICAg
ICAgfQogICAgICAgICByZXQudGltZSA9IHNuZXh0LT5jdXJfYnVkZ2V0OyAvKiBpbnZva2UgdGhl
IHNjaGVkdWxlciBuZXh0IHRpbWUgKi8KICAgICB9Ci0gICAgcmV0LnRhc2sgPSBzbmV4dC0+dmNw
dS0+c2NoZWRfaXRlbTsKKyAgICByZXQudGFzayA9IHNuZXh0LT5pdGVtOwogCiAgICAgcmV0dXJu
IHJldDsKIH0KIAogLyoKLSAqIFJlbW92ZSBWQ1BVIGZyb20gUnVuUQorICogUmVtb3ZlIElURU0g
ZnJvbSBSdW5RCiAgKiBUaGUgbG9jayBpcyBhbHJlYWR5IGdyYWJiZWQgaW4gc2NoZWR1bGUuYywg
bm8gbmVlZCB0byBsb2NrIGhlcmUKICAqLwogc3RhdGljIHZvaWQKIHJ0X2l0ZW1fc2xlZXAoY29u
c3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfaXRlbSAqaXRlbSkKIHsKLSAg
ICBzdHJ1Y3QgdmNwdSAqdmMgPSBpdGVtLT52Y3B1OwogICAgIHN0cnVjdCBydF9pdGVtICogY29u
c3Qgc3ZjID0gcnRfaXRlbShpdGVtKTsKIAotICAgIEJVR19PTiggaXNfaWRsZV92Y3B1KHZjKSAp
OworICAgIEJVR19PTiggaXNfaWRsZV9pdGVtKGl0ZW0pICk7CiAgICAgU0NIRURfU1RBVF9DUkFO
SyhpdGVtX3NsZWVwKTsKIAotICAgIGlmICggY3Vycl9vbl9jcHUodmMtPnByb2Nlc3NvcikgPT0g
aXRlbSApCi0gICAgICAgIGNwdV9yYWlzZV9zb2Z0aXJxKHZjLT5wcm9jZXNzb3IsIFNDSEVEVUxF
X1NPRlRJUlEpOwotICAgIGVsc2UgaWYgKCB2Y3B1X29uX3Eoc3ZjKSApCisgICAgaWYgKCBjdXJy
X29uX2NwdShzY2hlZF9pdGVtX2NwdShpdGVtKSkgPT0gaXRlbSApCisgICAgICAgIGNwdV9yYWlz
ZV9zb2Z0aXJxKHNjaGVkX2l0ZW1fY3B1KGl0ZW0pLCBTQ0hFRFVMRV9TT0ZUSVJRKTsKKyAgICBl
bHNlIGlmICggaXRlbV9vbl9xKHN2YykgKQogICAgIHsKICAgICAgICAgcV9yZW1vdmUoc3ZjKTsK
ICAgICAgICAgcmVwbHFfcmVtb3ZlKG9wcywgc3ZjKTsKQEAgLTExNjgsMjAgKzExNjIsMjAgQEAg
cnRfaXRlbV9zbGVlcChjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hlZF9p
dGVtICppdGVtKQogfQogCiAvKgotICogUGljayBhIGNwdSB3aGVyZSB0byBydW4gYSB2Y3B1LAot
ICogcG9zc2libHkga2lja2luZyBvdXQgdGhlIHZjcHUgcnVubmluZyB0aGVyZQorICogUGljayBh
IGNwdSB3aGVyZSB0byBydW4gYW4gaXRlbSwKKyAqIHBvc3NpYmx5IGtpY2tpbmcgb3V0IHRoZSBp
dGVtIHJ1bm5pbmcgdGhlcmUKICAqIENhbGxlZCBieSB3YWtlKCkgYW5kIGNvbnRleHRfc2F2ZWQo
KQogICogV2UgaGF2ZSBhIHJ1bm5pbmcgY2FuZGlkYXRlIGhlcmUsIHRoZSBraWNrIGxvZ2ljIGlz
OgogICogQW1vbmcgYWxsIHRoZSBjcHVzIHRoYXQgYXJlIHdpdGhpbiB0aGUgY3B1IGFmZmluaXR5
CiAgKiAxKSBpZiB0aGVyZSBhcmUgYW55IGlkbGUgQ1BVcywga2ljayBvbmUuCiAgICAgICBGb3Ig
Y2FjaGUgYmVuZWZpdCwgd2UgY2hlY2sgbmV3LT5jcHUgYXMgZmlyc3QKICAqIDIpIG5vdyBhbGwg
cGNwdXMgYXJlIGJ1c3k7Ci0gKiAgICBhbW9uZyBhbGwgdGhlIHJ1bm5pbmcgdmNwdXMsIHBpY2sg
bG93ZXN0IHByaW9yaXR5IG9uZQorICogICAgYW1vbmcgYWxsIHRoZSBydW5uaW5nIGl0ZW1zLCBw
aWNrIGxvd2VzdCBwcmlvcml0eSBvbmUKICAqICAgIGlmIHNuZXh0IGhhcyBoaWdoZXIgcHJpb3Jp
dHksIGtpY2sgaXQuCiAgKgogICogVE9ETzoKLSAqIDEpIHdoYXQgaWYgdGhlc2UgdHdvIHZjcHVz
IGJlbG9uZ3MgdG8gdGhlIHNhbWUgZG9tYWluPwotICogICAgcmVwbGFjZSBhIHZjcHUgYmVsb25n
aW5nIHRvIHRoZSBzYW1lIGRvbWFpbiBpbnRyb2R1Y2VzIG1vcmUgb3ZlcmhlYWQKKyAqIDEpIHdo
YXQgaWYgdGhlc2UgdHdvIGl0ZW1zIGJlbG9uZ3MgdG8gdGhlIHNhbWUgZG9tYWluPworICogICAg
cmVwbGFjZSBhbiBpdGVtIGJlbG9uZ2luZyB0byB0aGUgc2FtZSBkb21haW4gaW50cm9kdWNlcyBt
b3JlIG92ZXJoZWFkCiAgKgogICogbG9jayBpcyBncmFiYmVkIGJlZm9yZSBjYWxsaW5nIHRoaXMg
ZnVuY3Rpb24KICAqLwpAQCAtMTE4OSwxOCArMTE4MywxOCBAQCBzdGF0aWMgdm9pZAogcnVucV90
aWNrbGUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3QgcnRfaXRlbSAqbmV3KQog
ewogICAgIHN0cnVjdCBydF9wcml2YXRlICpwcnYgPSBydF9wcml2KG9wcyk7Ci0gICAgc3RydWN0
IHJ0X2l0ZW0gKmxhdGVzdF9kZWFkbGluZV92Y3B1ID0gTlVMTDsgLyogbG93ZXN0IHByaW9yaXR5
ICovCisgICAgc3RydWN0IHJ0X2l0ZW0gKmxhdGVzdF9kZWFkbGluZV9pdGVtID0gTlVMTDsgLyog
bG93ZXN0IHByaW9yaXR5ICovCiAgICAgc3RydWN0IHJ0X2l0ZW0gKml0ZXJfc3ZjOwotICAgIHN0
cnVjdCB2Y3B1ICppdGVyX3ZjOworICAgIHN0cnVjdCBzY2hlZF9pdGVtICppdGVyX2l0ZW07CiAg
ICAgaW50IGNwdSA9IDAsIGNwdV90b190aWNrbGUgPSAwOwogICAgIGNwdW1hc2tfdCBub3RfdGlj
a2xlZDsKICAgICBjcHVtYXNrX3QgKm9ubGluZTsKIAotICAgIGlmICggbmV3ID09IE5VTEwgfHwg
aXNfaWRsZV92Y3B1KG5ldy0+dmNwdSkgKQorICAgIGlmICggbmV3ID09IE5VTEwgfHwgaXNfaWRs
ZV9pdGVtKG5ldy0+aXRlbSkgKQogICAgICAgICByZXR1cm47CiAKLSAgICBvbmxpbmUgPSBjcHVw
b29sX2RvbWFpbl9jcHVtYXNrKG5ldy0+dmNwdS0+ZG9tYWluKTsKLSAgICBjcHVtYXNrX2FuZCgm
bm90X3RpY2tsZWQsIG9ubGluZSwgbmV3LT52Y3B1LT5zY2hlZF9pdGVtLT5jcHVfaGFyZF9hZmZp
bml0eSk7CisgICAgb25saW5lID0gY3B1cG9vbF9kb21haW5fY3B1bWFzayhuZXctPml0ZW0tPmRv
bWFpbik7CisgICAgY3B1bWFza19hbmQoJm5vdF90aWNrbGVkLCBvbmxpbmUsIG5ldy0+aXRlbS0+
Y3B1X2hhcmRfYWZmaW5pdHkpOwogICAgIGNwdW1hc2tfYW5kbm90KCZub3RfdGlja2xlZCwgJm5v
dF90aWNrbGVkLCAmcHJ2LT50aWNrbGVkKTsKIAogICAgIC8qCkBAIC0xMjA4LDMxICsxMjAyLDMx
IEBAIHJ1bnFfdGlja2xlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHJ0X2l0
ZW0gKm5ldykKICAgICAgKiAgICBGb3IgY2FjaGUgYmVuZWZpdCx3ZSBmaXJzdCBzZWFyY2ggbmV3
LT5jcHUuCiAgICAgICogICAgVGhlIHNhbWUgbG9vcCBhbHNvIGZpbmQgdGhlIG9uZSB3aXRoIGxv
d2VzdCBwcmlvcml0eS4KICAgICAgKi8KLSAgICBjcHUgPSBjcHVtYXNrX3Rlc3Rfb3JfY3ljbGUo
bmV3LT52Y3B1LT5wcm9jZXNzb3IsICZub3RfdGlja2xlZCk7CisgICAgY3B1ID0gY3B1bWFza190
ZXN0X29yX2N5Y2xlKHNjaGVkX2l0ZW1fY3B1KG5ldy0+aXRlbSksICZub3RfdGlja2xlZCk7CiAg
ICAgd2hpbGUgKCBjcHUhPSBucl9jcHVfaWRzICkKICAgICB7Ci0gICAgICAgIGl0ZXJfdmMgPSBj
dXJyX29uX2NwdShjcHUpLT52Y3B1OwotICAgICAgICBpZiAoIGlzX2lkbGVfdmNwdShpdGVyX3Zj
KSApCisgICAgICAgIGl0ZXJfaXRlbSA9IGN1cnJfb25fY3B1KGNwdSk7CisgICAgICAgIGlmICgg
aXNfaWRsZV9pdGVtKGl0ZXJfaXRlbSkgKQogICAgICAgICB7CiAgICAgICAgICAgICBTQ0hFRF9T
VEFUX0NSQU5LKHRpY2tsZWRfaWRsZV9jcHUpOwogICAgICAgICAgICAgY3B1X3RvX3RpY2tsZSA9
IGNwdTsKICAgICAgICAgICAgIGdvdG8gb3V0OwogICAgICAgICB9Ci0gICAgICAgIGl0ZXJfc3Zj
ID0gcnRfaXRlbShpdGVyX3ZjLT5zY2hlZF9pdGVtKTsKLSAgICAgICAgaWYgKCBsYXRlc3RfZGVh
ZGxpbmVfdmNwdSA9PSBOVUxMIHx8Ci0gICAgICAgICAgICAgY29tcGFyZV92Y3B1X3ByaW9yaXR5
KGl0ZXJfc3ZjLCBsYXRlc3RfZGVhZGxpbmVfdmNwdSkgPCAwICkKLSAgICAgICAgICAgIGxhdGVz
dF9kZWFkbGluZV92Y3B1ID0gaXRlcl9zdmM7CisgICAgICAgIGl0ZXJfc3ZjID0gcnRfaXRlbShp
dGVyX2l0ZW0pOworICAgICAgICBpZiAoIGxhdGVzdF9kZWFkbGluZV9pdGVtID09IE5VTEwgfHwK
KyAgICAgICAgICAgICBjb21wYXJlX2l0ZW1fcHJpb3JpdHkoaXRlcl9zdmMsIGxhdGVzdF9kZWFk
bGluZV9pdGVtKSA8IDAgKQorICAgICAgICAgICAgbGF0ZXN0X2RlYWRsaW5lX2l0ZW0gPSBpdGVy
X3N2YzsKIAogICAgICAgICBjcHVtYXNrX2NsZWFyX2NwdShjcHUsICZub3RfdGlja2xlZCk7CiAg
ICAgICAgIGNwdSA9IGNwdW1hc2tfY3ljbGUoY3B1LCAmbm90X3RpY2tsZWQpOwogICAgIH0KIAot
ICAgIC8qIDIpIGNhbmRpY2F0ZSBoYXMgaGlnaGVyIHByaW9yaXR5LCBraWNrIG91dCBsb3dlc3Qg
cHJpb3JpdHkgdmNwdSAqLwotICAgIGlmICggbGF0ZXN0X2RlYWRsaW5lX3ZjcHUgIT0gTlVMTCAm
JgotICAgICAgICAgY29tcGFyZV92Y3B1X3ByaW9yaXR5KGxhdGVzdF9kZWFkbGluZV92Y3B1LCBu
ZXcpIDwgMCApCisgICAgLyogMikgY2FuZGljYXRlIGhhcyBoaWdoZXIgcHJpb3JpdHksIGtpY2sg
b3V0IGxvd2VzdCBwcmlvcml0eSBpdGVtICovCisgICAgaWYgKCBsYXRlc3RfZGVhZGxpbmVfaXRl
bSAhPSBOVUxMICYmCisgICAgICAgICBjb21wYXJlX2l0ZW1fcHJpb3JpdHkobGF0ZXN0X2RlYWRs
aW5lX2l0ZW0sIG5ldykgPCAwICkKICAgICB7CiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodGlj
a2xlZF9idXN5X2NwdSk7Ci0gICAgICAgIGNwdV90b190aWNrbGUgPSBsYXRlc3RfZGVhZGxpbmVf
dmNwdS0+dmNwdS0+cHJvY2Vzc29yOworICAgICAgICBjcHVfdG9fdGlja2xlID0gc2NoZWRfaXRl
bV9jcHUobGF0ZXN0X2RlYWRsaW5lX2l0ZW0tPml0ZW0pOwogICAgICAgICBnb3RvIG91dDsKICAg
ICB9CiAKQEAgLTEyNTgsMzUgKzEyNTIsMzQgQEAgcnVucV90aWNrbGUoY29uc3Qgc3RydWN0IHNj
aGVkdWxlciAqb3BzLCBzdHJ1Y3QgcnRfaXRlbSAqbmV3KQogfQogCiAvKgotICogU2hvdWxkIGFs
d2F5cyB3YWtlIHVwIHJ1bm5hYmxlIHZjcHUsIHB1dCBpdCBiYWNrIHRvIFJ1blEuCisgKiBTaG91
bGQgYWx3YXlzIHdha2UgdXAgcnVubmFibGUgaXRlbSwgcHV0IGl0IGJhY2sgdG8gUnVuUS4KICAq
IENoZWNrIHByaW9yaXR5IHRvIHJhaXNlIGludGVycnVwdAogICogVGhlIGxvY2sgaXMgYWxyZWFk
eSBncmFiYmVkIGluIHNjaGVkdWxlLmMsIG5vIG5lZWQgdG8gbG9jayBoZXJlCi0gKiBUT0RPOiB3
aGF0IGlmIHRoZXNlIHR3byB2Y3B1cyBiZWxvbmdzIHRvIHRoZSBzYW1lIGRvbWFpbj8KKyAqIFRP
RE86IHdoYXQgaWYgdGhlc2UgdHdvIGl0ZW1zIGJlbG9uZ3MgdG8gdGhlIHNhbWUgZG9tYWluPwog
ICovCiBzdGF0aWMgdm9pZAogcnRfaXRlbV93YWtlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9w
cywgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0pCiB7Ci0gICAgc3RydWN0IHZjcHUgKnZjID0gaXRl
bS0+dmNwdTsKICAgICBzdHJ1Y3QgcnRfaXRlbSAqIGNvbnN0IHN2YyA9IHJ0X2l0ZW0oaXRlbSk7
CiAgICAgc190aW1lX3Qgbm93OwogICAgIGJvb2xfdCBtaXNzZWQ7CiAKLSAgICBCVUdfT04oIGlz
X2lkbGVfdmNwdSh2YykgKTsKKyAgICBCVUdfT04oIGlzX2lkbGVfaXRlbShpdGVtKSApOwogCi0g
ICAgaWYgKCB1bmxpa2VseShjdXJyX29uX2NwdSh2Yy0+cHJvY2Vzc29yKSA9PSBpdGVtKSApCisg
ICAgaWYgKCB1bmxpa2VseShjdXJyX29uX2NwdShzY2hlZF9pdGVtX2NwdShpdGVtKSkgPT0gaXRl
bSkgKQogICAgIHsKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyhpdGVtX3dha2VfcnVubmluZyk7
CiAgICAgICAgIHJldHVybjsKICAgICB9CiAKICAgICAvKiBvbiBSdW5RL0RlcGxldGVkUSwganVz
dCB1cGRhdGUgaW5mbyBpcyBvayAqLwotICAgIGlmICggdW5saWtlbHkodmNwdV9vbl9xKHN2Yykp
ICkKKyAgICBpZiAoIHVubGlrZWx5KGl0ZW1fb25fcShzdmMpKSApCiAgICAgewogICAgICAgICBT
Q0hFRF9TVEFUX0NSQU5LKGl0ZW1fd2FrZV9vbnJ1bnEpOwogICAgICAgICByZXR1cm47CiAgICAg
fQogCi0gICAgaWYgKCBsaWtlbHkodmNwdV9ydW5uYWJsZSh2YykpICkKKyAgICBpZiAoIGxpa2Vs
eShpdGVtX3J1bm5hYmxlKGl0ZW0pKSApCiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksoaXRlbV93
YWtlX3J1bm5hYmxlKTsKICAgICBlbHNlCiAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksoaXRlbV93
YWtlX25vdF9ydW5uYWJsZSk7CkBAIC0xMzAyLDE2ICsxMjk1LDE2IEBAIHJ0X2l0ZW1fd2FrZShj
b25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hlZF9pdGVtICppdGVtKQogICAg
ICAgICBydF91cGRhdGVfZGVhZGxpbmUobm93LCBzdmMpOwogCiAgICAgLyoKLSAgICAgKiBJZiBj
b250ZXh0IGhhc24ndCBiZWVuIHNhdmVkIGZvciB0aGlzIHZjcHUgeWV0LCB3ZSBjYW4ndCBwdXQg
aXQgb24KKyAgICAgKiBJZiBjb250ZXh0IGhhc24ndCBiZWVuIHNhdmVkIGZvciB0aGlzIGl0ZW0g
eWV0LCB3ZSBjYW4ndCBwdXQgaXQgb24KICAgICAgKiB0aGUgcnVuLXF1ZXVlL2RlcGxldGVkLXF1
ZXVlLiBJbnN0ZWFkLCB3ZSBzZXQgdGhlIGFwcHJvcHJpYXRlIGZsYWcsCi0gICAgICogdGhlIHZj
cHUgd2lsbCBiZSBwdXQgYmFjayBvbiBxdWV1ZSBhZnRlciB0aGUgY29udGV4dCBoYXMgYmVlbiBz
YXZlZAorICAgICAqIHRoZSBpdGVtIHdpbGwgYmUgcHV0IGJhY2sgb24gcXVldWUgYWZ0ZXIgdGhl
IGNvbnRleHQgaGFzIGJlZW4gc2F2ZWQKICAgICAgKiAoaW4gcnRfY29udGV4dF9zYXZlKCkpLgog
ICAgICAqLwogICAgIGlmICggdW5saWtlbHkoc3ZjLT5mbGFncyAmIFJURFNfc2NoZWR1bGVkKSAp
CiAgICAgewogICAgICAgICBfX3NldF9iaXQoX19SVERTX2RlbGF5ZWRfcnVucV9hZGQsICZzdmMt
PmZsYWdzKTsKICAgICAgICAgLyoKLSAgICAgICAgICogVGhlIHZjcHUgaXMgd2FraW5nIHVwIGFs
cmVhZHksIGFuZCB3ZSBkaWRuJ3QgZXZlbiBoYWQgdGhlIHRpbWUgdG8KKyAgICAgICAgICogVGhl
IGl0ZW0gaXMgd2FraW5nIHVwIGFscmVhZHksIGFuZCB3ZSBkaWRuJ3QgZXZlbiBoYWQgdGhlIHRp
bWUgdG8KICAgICAgICAgICogcmVtb3ZlIGl0cyBuZXh0IHJlcGxlbmlzaG1lbnQgZXZlbnQgZnJv
bSB0aGUgcmVwbGVuaXNobWVudCBxdWV1ZQogICAgICAgICAgKiB3aGVuIGl0IGJsb2NrZWQhIE5v
IGJpZyBkZWFsLiBJZiB3ZSBkaWQgbm90IG1pc3MgdGhlIGRlYWRsaW5lIGluCiAgICAgICAgICAq
IHRoZSBtZWFudGltZSwgbGV0J3MganVzdCBsZWF2ZSBpdCB0aGVyZS4gSWYgd2UgZGlkLCBsZXQn
cyByZW1vdmUgaXQKQEAgLTEzMzIsMjIgKzEzMjUsMjEgQEAgcnRfaXRlbV93YWtlKGNvbnN0IHN0
cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0pCiAKIC8qCiAgKiBz
Y3VyciBoYXMgZmluaXNoZWQgY29udGV4dCBzd2l0Y2gsIGluc2VydCBpdCBiYWNrIHRvIHRoZSBS
dW5RLAotICogYW5kIHRoZW4gcGljayB0aGUgaGlnaGVzdCBwcmlvcml0eSB2Y3B1IGZyb20gcnVu
cSB0byBydW4KKyAqIGFuZCB0aGVuIHBpY2sgdGhlIGhpZ2hlc3QgcHJpb3JpdHkgaXRlbSBmcm9t
IHJ1bnEgdG8gcnVuCiAgKi8KIHN0YXRpYyB2b2lkCiBydF9jb250ZXh0X3NhdmVkKGNvbnN0IHN0
cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX2l0ZW0gKml0ZW0pCiB7Ci0gICAgc3Ry
dWN0IHZjcHUgKnZjID0gaXRlbS0+dmNwdTsKICAgICBzdHJ1Y3QgcnRfaXRlbSAqc3ZjID0gcnRf
aXRlbShpdGVtKTsKICAgICBzcGlubG9ja190ICpsb2NrID0gaXRlbV9zY2hlZHVsZV9sb2NrX2ly
cShpdGVtKTsKIAogICAgIF9fY2xlYXJfYml0KF9fUlREU19zY2hlZHVsZWQsICZzdmMtPmZsYWdz
KTsKLSAgICAvKiBub3QgaW5zZXJ0IGlkbGUgdmNwdSB0byBydW5xICovCi0gICAgaWYgKCBpc19p
ZGxlX3ZjcHUodmMpICkKKyAgICAvKiBub3QgaW5zZXJ0IGlkbGUgaXRlbSB0byBydW5xICovCisg
ICAgaWYgKCBpc19pZGxlX2l0ZW0oaXRlbSkgKQogICAgICAgICBnb3RvIG91dDsKIAogICAgIGlm
ICggX190ZXN0X2FuZF9jbGVhcl9iaXQoX19SVERTX2RlbGF5ZWRfcnVucV9hZGQsICZzdmMtPmZs
YWdzKSAmJgotICAgICAgICAgbGlrZWx5KHZjcHVfcnVubmFibGUodmMpKSApCisgICAgICAgICBs
aWtlbHkoaXRlbV9ydW5uYWJsZShpdGVtKSkgKQogICAgIHsKICAgICAgICAgcnVucV9pbnNlcnQo
b3BzLCBzdmMpOwogICAgICAgICBydW5xX3RpY2tsZShvcHMsIHN2Yyk7CkBAIC0xMzYwLDcgKzEz
NTIsNyBAQCBvdXQ6CiB9CiAKIC8qCi0gKiBzZXQvZ2V0IGVhY2ggdmNwdSBpbmZvIG9mIGVhY2gg
ZG9tYWluCisgKiBzZXQvZ2V0IGVhY2ggaXRlbSBpbmZvIG9mIGVhY2ggZG9tYWluCiAgKi8KIHN0
YXRpYyBpbnQKIHJ0X2RvbV9jbnRsKApAQCAtMTM3MCw3ICsxMzYyLDcgQEAgcnRfZG9tX2NudGwo
CiB7CiAgICAgc3RydWN0IHJ0X3ByaXZhdGUgKnBydiA9IHJ0X3ByaXYob3BzKTsKICAgICBzdHJ1
Y3QgcnRfaXRlbSAqc3ZjOwotICAgIHN0cnVjdCB2Y3B1ICp2OworICAgIHN0cnVjdCBzY2hlZF9p
dGVtICppdGVtOwogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAgICAgaW50IHJjID0gMDsKICAg
ICBzdHJ1Y3QgeGVuX2RvbWN0bF9zY2hlZHBhcmFtX3ZjcHUgbG9jYWxfc2NoZWQ7CkBAIC0xMzkx
LDkgKzEzODMsOSBAQCBydF9kb21fY250bCgKICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICB9
CiAgICAgICAgIHNwaW5fbG9ja19pcnFzYXZlKCZwcnYtPmxvY2ssIGZsYWdzKTsKLSAgICAgICAg
Zm9yX2VhY2hfdmNwdSAoIGQsIHYgKQorICAgICAgICBmb3JfZWFjaF9zY2hlZF9pdGVtICggZCwg
aXRlbSApCiAgICAgICAgIHsKLSAgICAgICAgICAgIHN2YyA9IHJ0X2l0ZW0odi0+c2NoZWRfaXRl
bSk7CisgICAgICAgICAgICBzdmMgPSBydF9pdGVtKGl0ZW0pOwogICAgICAgICAgICAgc3ZjLT5w
ZXJpb2QgPSBNSUNST1NFQ1Mob3AtPnUucnRkcy5wZXJpb2QpOyAvKiB0cmFuc2ZlciB0byBuYW5v
c2VjICovCiAgICAgICAgICAgICBzdmMtPmJ1ZGdldCA9IE1JQ1JPU0VDUyhvcC0+dS5ydGRzLmJ1
ZGdldCk7CiAgICAgICAgIH0KQEAgLTE0NjEsNyArMTQ1Myw3IEBAIHJ0X2RvbV9jbnRsKAogICAg
ICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICB9CiAgICAgICAgIGlmICggIXJjICkKLSAgICAg
ICAgICAgIC8qIG5vdGlmeSB1cHBlciBjYWxsZXIgaG93IG1hbnkgdmNwdXMgaGF2ZSBiZWVuIHBy
b2Nlc3NlZC4gKi8KKyAgICAgICAgICAgIC8qIG5vdGlmeSB1cHBlciBjYWxsZXIgaG93IG1hbnkg
aXRlbXMgaGF2ZSBiZWVuIHByb2Nlc3NlZC4gKi8KICAgICAgICAgICAgIG9wLT51LnYubnJfdmNw
dXMgPSBpbmRleDsKICAgICAgICAgYnJlYWs7CiAgICAgfQpAQCAtMTQ3MCw3ICsxNDYyLDcgQEAg
cnRfZG9tX2NudGwoCiB9CiAKIC8qCi0gKiBUaGUgcmVwbGVuaXNobWVudCB0aW1lciBoYW5kbGVy
IHBpY2tzIHZjcHVzCisgKiBUaGUgcmVwbGVuaXNobWVudCB0aW1lciBoYW5kbGVyIHBpY2tzIGl0
ZW1zCiAgKiBmcm9tIHRoZSByZXBscSBhbmQgZG9lcyB0aGUgYWN0dWFsIHJlcGxlbmlzaG1lbnQu
CiAgKi8KIHN0YXRpYyB2b2lkIHJlcGxfdGltZXJfaGFuZGxlcih2b2lkICpkYXRhKXsKQEAgLTE0
ODgsNyArMTQ4MCw3IEBAIHN0YXRpYyB2b2lkIHJlcGxfdGltZXJfaGFuZGxlcih2b2lkICpkYXRh
KXsKICAgICBub3cgPSBOT1coKTsKIAogICAgIC8qCi0gICAgICogRG8gdGhlIHJlcGxlbmlzaG1l
bnQgYW5kIG1vdmUgcmVwbGVuaXNoZWQgdmNwdXMKKyAgICAgKiBEbyB0aGUgcmVwbGVuaXNobWVu
dCBhbmQgbW92ZSByZXBsZW5pc2hlZCBpdGVtcwogICAgICAqIHRvIHRoZSB0ZW1wb3JhcnkgbGlz
dCB0byB0aWNrbGUuCiAgICAgICogSWYgc3ZjIGlzIG9uIHJ1biBxdWV1ZSwgd2UgbmVlZCB0byBw
dXQgaXQgYXQKICAgICAgKiB0aGUgY29ycmVjdCBwbGFjZSBzaW5jZSBpdHMgZGVhZGxpbmUgY2hh
bmdlcy4KQEAgLTE1MDQsNyArMTQ5Niw3IEBAIHN0YXRpYyB2b2lkIHJlcGxfdGltZXJfaGFuZGxl
cih2b2lkICpkYXRhKXsKICAgICAgICAgcnRfdXBkYXRlX2RlYWRsaW5lKG5vdywgc3ZjKTsKICAg
ICAgICAgbGlzdF9hZGQoJnN2Yy0+cmVwbHFfZWxlbSwgJnRtcF9yZXBscSk7CiAKLSAgICAgICAg
aWYgKCB2Y3B1X29uX3Eoc3ZjKSApCisgICAgICAgIGlmICggaXRlbV9vbl9xKHN2YykgKQogICAg
ICAgICB7CiAgICAgICAgICAgICBxX3JlbW92ZShzdmMpOwogICAgICAgICAgICAgcnVucV9pbnNl
cnQob3BzLCBzdmMpOwpAQCAtMTUxMiwyNiArMTUwNCwyNiBAQCBzdGF0aWMgdm9pZCByZXBsX3Rp
bWVyX2hhbmRsZXIodm9pZCAqZGF0YSl7CiAgICAgfQogCiAgICAgLyoKLSAgICAgKiBJdGVyYXRl
IHRocm91Z2ggdGhlIGxpc3Qgb2YgdXBkYXRlZCB2Y3B1cy4KLSAgICAgKiBJZiBhbiB1cGRhdGVk
IHZjcHUgaXMgcnVubmluZywgdGlja2xlIHRoZSBoZWFkIG9mIHRoZQorICAgICAqIEl0ZXJhdGUg
dGhyb3VnaCB0aGUgbGlzdCBvZiB1cGRhdGVkIGl0ZW1zLgorICAgICAqIElmIGFuIHVwZGF0ZWQg
aXRlbSBpcyBydW5uaW5nLCB0aWNrbGUgdGhlIGhlYWQgb2YgdGhlCiAgICAgICogcnVucXVldWUg
aWYgaXQgaGFzIGEgaGlnaGVyIHByaW9yaXR5LgotICAgICAqIElmIGFuIHVwZGF0ZWQgdmNwdSB3
YXMgZGVwbGV0ZWQgYW5kIG9uIHRoZSBydW5xdWV1ZSwgdGlja2xlIGl0LgotICAgICAqIEZpbmFs
bHksIHJlaW5zZXJ0IHRoZSB2Y3B1cyBiYWNrIHRvIHJlcGxlbmlzaGVtZW50IGV2ZW50cyBsaXN0
LgorICAgICAqIElmIGFuIHVwZGF0ZWQgaXRlbSB3YXMgZGVwbGV0ZWQgYW5kIG9uIHRoZSBydW5x
dWV1ZSwgdGlja2xlIGl0LgorICAgICAqIEZpbmFsbHksIHJlaW5zZXJ0IHRoZSBpdGVtcyBiYWNr
IHRvIHJlcGxlbmlzaGVtZW50IGV2ZW50cyBsaXN0LgogICAgICAqLwogICAgIGxpc3RfZm9yX2Vh
Y2hfc2FmZSAoIGl0ZXIsIHRtcCwgJnRtcF9yZXBscSApCiAgICAgewogICAgICAgICBzdmMgPSBy
ZXBscV9lbGVtKGl0ZXIpOwogCi0gICAgICAgIGlmICggY3Vycl9vbl9jcHUoc3ZjLT52Y3B1LT5w
cm9jZXNzb3IpID09IHN2Yy0+dmNwdS0+c2NoZWRfaXRlbSAmJgorICAgICAgICBpZiAoIGN1cnJf
b25fY3B1KHNjaGVkX2l0ZW1fY3B1KHN2Yy0+aXRlbSkpID09IHN2Yy0+aXRlbSAmJgogICAgICAg
ICAgICAgICFsaXN0X2VtcHR5KHJ1bnEpICkKICAgICAgICAgewogICAgICAgICAgICAgc3RydWN0
IHJ0X2l0ZW0gKm5leHRfb25fcnVucSA9IHFfZWxlbShydW5xLT5uZXh0KTsKIAotICAgICAgICAg
ICAgaWYgKCBjb21wYXJlX3ZjcHVfcHJpb3JpdHkoc3ZjLCBuZXh0X29uX3J1bnEpIDwgMCApCisg
ICAgICAgICAgICBpZiAoIGNvbXBhcmVfaXRlbV9wcmlvcml0eShzdmMsIG5leHRfb25fcnVucSkg
PCAwICkKICAgICAgICAgICAgICAgICBydW5xX3RpY2tsZShvcHMsIG5leHRfb25fcnVucSk7CiAg
ICAgICAgIH0KICAgICAgICAgZWxzZSBpZiAoIF9fdGVzdF9hbmRfY2xlYXJfYml0KF9fUlREU19k
ZXBsZXRlZCwgJnN2Yy0+ZmxhZ3MpICYmCi0gICAgICAgICAgICAgICAgICB2Y3B1X29uX3Eoc3Zj
KSApCisgICAgICAgICAgICAgICAgICBpdGVtX29uX3Eoc3ZjKSApCiAgICAgICAgICAgICBydW5x
X3RpY2tsZShvcHMsIHN2Yyk7CiAKICAgICAgICAgbGlzdF9kZWwoJnN2Yy0+cmVwbHFfZWxlbSk7
CkBAIC0xNTM5LDcgKzE1MzEsNyBAQCBzdGF0aWMgdm9pZCByZXBsX3RpbWVyX2hhbmRsZXIodm9p
ZCAqZGF0YSl7CiAgICAgfQogCiAgICAgLyoKLSAgICAgKiBJZiB0aGVyZSBhcmUgdmNwdXMgbGVm
dCBpbiB0aGUgcmVwbGVuaXNobWVudCBldmVudCBsaXN0LAorICAgICAqIElmIHRoZXJlIGFyZSBp
dGVtcyBsZWZ0IGluIHRoZSByZXBsZW5pc2htZW50IGV2ZW50IGxpc3QsCiAgICAgICogc2V0IHRo
ZSBuZXh0IHJlcGxlbmlzaG1lbnQgdG8gaGFwcGVuIGF0IHRoZSBkZWFkbGluZSBvZgogICAgICAq
IHRoZSBvbmUgaW4gdGhlIGZyb250LgogICAgICAqLwotLSAKMi4xNi40CgoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlz
dApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

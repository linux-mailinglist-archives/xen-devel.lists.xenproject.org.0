Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 45E882C49A
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:40:06 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZSf-00017H-AM; Tue, 28 May 2019 10:36:05 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZSe-00016c-5e
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:36:04 +0000
X-Inumbo-ID: 04cb3dfc-8134-11e9-8980-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 04cb3dfc-8134-11e9-8980-bc764e045a96;
 Tue, 28 May 2019 10:33:23 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id EA94FB03A;
 Tue, 28 May 2019 10:33:21 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:32:33 +0200
Message-Id: <20190528103313.1343-21-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 20/60] xen/sched: make null scheduler vcpu
 agnostic.
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U3dpdGNoIG51bGwgc2NoZWR1bGVyIGNvbXBsZXRlbHkgZnJvbSB2Y3B1IHRvIHNjaGVkX3VuaXQg
dXNhZ2UuCgpTaWduZWQtb2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+Ci0t
LQogeGVuL2NvbW1vbi9zY2hlZF9udWxsLmMgfCAzMDQgKysrKysrKysrKysrKysrKysrKysrKysr
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTQ5IGluc2VydGlvbnMo
KyksIDE1NSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL3NjaGVkX251bGwu
YyBiL3hlbi9jb21tb24vc2NoZWRfbnVsbC5jCmluZGV4IGU0OTBiNzkxYjguLjUzYTIwZDczYWEg
MTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWRfbnVsbC5jCisrKyBiL3hlbi9jb21tb24vc2No
ZWRfbnVsbC5jCkBAIC0xOCwxMCArMTgsMTAgQEAKIAogLyoKICAqIFRoZSAnbnVsbCcgc2NoZWR1
bGVyIGFsd2F5cyBjaG9vc2UgdG8gcnVuLCBvbiBlYWNoIHBDUFUsIGVpdGhlciBub3RoaW5nCi0g
KiAoaS5lLiwgdGhlIHBDUFUgc3RheXMgaWRsZSkgb3IgYWx3YXlzIHRoZSBzYW1lIHZDUFUuCisg
KiAoaS5lLiwgdGhlIHBDUFUgc3RheXMgaWRsZSkgb3IgYWx3YXlzIHRoZSBzYW1lIEl0ZW0uCiAg
KgogICogSXQgaXMgYWltZWQgYXQgc3VwcG9ydGluZyBzdGF0aWMgc2NlbmFyaW9zLCB3aGVyZSB0
aGVyZSBhbHdheXMgYXJlCi0gKiBsZXNzIHZDUFVzIHRoYW4gcENQVXMgKGFuZCB0aGUgdkNQVXMg
ZG9uJ3QgbmVlZCB0byBtb3ZlIGFtb25nIHBDUFVzCisgKiBsZXNzIEl0ZW1zIHRoYW4gcENQVXMg
KGFuZCB0aGUgSXRlbXMgZG9uJ3QgbmVlZCB0byBtb3ZlIGFtb25nIHBDUFVzCiAgKiBmb3IgYW55
IHJlYXNvbikgd2l0aCB0aGUgbGVhc3QgcG9zc2libGUgb3ZlcmhlYWQuCiAgKgogICogVHlwaWNh
bCB1c2VjYXNlIGFyZSBlbWJlZGRlZCBhcHBsaWNhdGlvbnMsIGJ1dCBhbHNvIEhQQywgZXNwZWNp
YWxseQpAQCAtMzgsOCArMzgsOCBAQAogICogbnVsbCB0cmFjaW5nIGV2ZW50cy4gQ2hlY2sgaW5j
bHVkZS9wdWJsaWMvdHJhY2UuaCBmb3IgbW9yZSBkZXRhaWxzLgogICovCiAjZGVmaW5lIFRSQ19T
TlVMTF9QSUNLRURfQ1BVICAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDEpCi0jZGVmaW5l
IFRSQ19TTlVMTF9WQ1BVX0FTU0lHTiAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDIpCi0j
ZGVmaW5lIFRSQ19TTlVMTF9WQ1BVX0RFQVNTSUdOIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEws
IDMpCisjZGVmaW5lIFRSQ19TTlVMTF9VTklUX0FTU0lHTiAgIFRSQ19TQ0hFRF9DTEFTU19FVlQo
U05VTEwsIDIpCisjZGVmaW5lIFRSQ19TTlVMTF9VTklUX0RFQVNTSUdOIFRSQ19TQ0hFRF9DTEFT
U19FVlQoU05VTEwsIDMpCiAjZGVmaW5lIFRSQ19TTlVMTF9NSUdSQVRFICAgICAgIFRSQ19TQ0hF
RF9DTEFTU19FVlQoU05VTEwsIDQpCiAjZGVmaW5lIFRSQ19TTlVMTF9TQ0hFRFVMRSAgICAgIFRS
Q19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDUpCiAjZGVmaW5lIFRSQ19TTlVMTF9UQVNLTEVUICAg
ICAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoU05VTEwsIDYpCkBAIC00OCwxMyArNDgsMTMgQEAKICAq
IExvY2tpbmc6CiAgKiAtIFNjaGVkdWxlci1sb2NrIChhLmsuYS4gcnVucXVldWUgbG9jayk6CiAg
KiAgKyBpcyBwZXItcENQVTsKLSAqICArIHNlcmlhbGl6ZXMgYXNzaWdubWVudCBhbmQgZGVhc3Np
Z25tZW50IG9mIHZDUFVzIHRvIGEgcENQVS4KKyAqICArIHNlcmlhbGl6ZXMgYXNzaWdubWVudCBh
bmQgZGVhc3NpZ25tZW50IG9mIEl0ZW1zIHRvIGEgcENQVS4KICAqIC0gUHJpdmF0ZSBkYXRhIGxv
Y2sgKGEuay5hLiBwcml2YXRlIHNjaGVkdWxlciBsb2NrKToKICAqICArIGlzIHNjaGVkdWxlci13
aWRlOwogICogICsgc2VyaWFsaXplcyBhY2Nlc3NlcyB0byB0aGUgbGlzdCBvZiBkb21haW5zIGlu
IHRoaXMgc2NoZWR1bGVyLgogICogLSBXYWl0cXVldWUgbG9jazoKICAqICArIGlzIHNjaGVkdWxl
ci13aWRlOwotICogICsgc2VyaWFsaXplIGFjY2Vzc2VzIHRvIHRoZSBsaXN0IG9mIHZDUFVzIHdh
aXRpbmcgdG8gYmUgYXNzaWduZWQKKyAqICArIHNlcmlhbGl6ZSBhY2Nlc3NlcyB0byB0aGUgbGlz
dCBvZiBJdGVtcyB3YWl0aW5nIHRvIGJlIGFzc2lnbmVkCiAgKiAgICB0byBwQ1BVcy4KICAqCiAg
KiBPcmRlcmluZyBpczogcHJpdmF0ZSBsb2NrLCBydW5xdWV1ZSBsb2NrLCB3YWl0cXVldWUgbG9j
ay4gT3IsIE9UT0gsCkBAIC03OCwyNSArNzgsMjUgQEAKIHN0cnVjdCBudWxsX3ByaXZhdGUgewog
ICAgIHNwaW5sb2NrX3QgbG9jazsgICAgICAgIC8qIHNjaGVkdWxlciBsb2NrOyBuZXN0cyBpbnNp
ZGUgY3B1cG9vbF9sb2NrICovCiAgICAgc3RydWN0IGxpc3RfaGVhZCBuZG9tOyAgLyogRG9tYWlu
cyBvZiB0aGlzIHNjaGVkdWxlciAgICAgICAgICAgICAgICAgKi8KLSAgICBzdHJ1Y3QgbGlzdF9o
ZWFkIHdhaXRxOyAvKiB2Q1BVcyBub3QgYXNzaWduZWQgdG8gYW55IHBDUFUgICAgICAgICAgICAq
LworICAgIHN0cnVjdCBsaXN0X2hlYWQgd2FpdHE7IC8qIEl0ZW1zIG5vdCBhc3NpZ25lZCB0byBh
bnkgcENQVSAgICAgICAgICAgICovCiAgICAgc3BpbmxvY2tfdCB3YWl0cV9sb2NrOyAgLyogc2Vy
aWFsaXplcyB3YWl0cTsgbmVzdHMgaW5zaWRlIHJ1bnEgbG9ja3MgKi8KLSAgICBjcHVtYXNrX3Qg
Y3B1c19mcmVlOyAgICAvKiBDUFVzIHdpdGhvdXQgYSB2Q1BVIGFzc29jaWF0ZWQgdG8gdGhlbSAg
ICAqLworICAgIGNwdW1hc2tfdCBjcHVzX2ZyZWU7ICAgIC8qIENQVXMgd2l0aG91dCBhIEl0ZW0g
YXNzb2NpYXRlZCB0byB0aGVtICAgICovCiB9OwogCiAvKgogICogUGh5c2ljYWwgQ1BVCiAgKi8K
IHN0cnVjdCBudWxsX3BjcHUgewotICAgIHN0cnVjdCB2Y3B1ICp2Y3B1OworICAgIHN0cnVjdCBz
Y2hlZF91bml0ICp1bml0OwogfTsKIERFRklORV9QRVJfQ1BVKHN0cnVjdCBudWxsX3BjcHUsIG5w
Yyk7CiAKIC8qCi0gKiBWaXJ0dWFsIENQVQorICogU2NoZWR1bGUgSXRlbQogICovCiBzdHJ1Y3Qg
bnVsbF91bml0IHsKICAgICBzdHJ1Y3QgbGlzdF9oZWFkIHdhaXRxX2VsZW07Ci0gICAgc3RydWN0
IHZjcHUgKnZjcHU7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiB9OwogCiAvKgpAQCAt
MTIwLDEzICsxMjAsMTMgQEAgc3RhdGljIGlubGluZSBzdHJ1Y3QgbnVsbF91bml0ICpudWxsX3Vu
aXQoY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAgICAgcmV0dXJuIHVuaXQtPnByaXY7
CiB9CiAKLXN0YXRpYyBpbmxpbmUgYm9vbCB2Y3B1X2NoZWNrX2FmZmluaXR5KHN0cnVjdCB2Y3B1
ICp2LCB1bnNpZ25lZCBpbnQgY3B1LAorc3RhdGljIGlubGluZSBib29sIHVuaXRfY2hlY2tfYWZm
aW5pdHkoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgY3B1LAogICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGJhbGFuY2Vfc3RlcCkKIHsKLSAgICBhZmZpbml0
eV9iYWxhbmNlX2NwdW1hc2sodi0+c2NoZWRfdW5pdCwgYmFsYW5jZV9zdGVwLAotICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBjcHVtYXNrX3NjcmF0Y2hfY3B1KGNwdSkpOworICAgIGFmZmlu
aXR5X2JhbGFuY2VfY3B1bWFzayh1bml0LCBiYWxhbmNlX3N0ZXAsIGNwdW1hc2tfc2NyYXRjaF9j
cHUoY3B1KSk7CiAgICAgY3B1bWFza19hbmQoY3B1bWFza19zY3JhdGNoX2NwdShjcHUpLCBjcHVt
YXNrX3NjcmF0Y2hfY3B1KGNwdSksCi0gICAgICAgICAgICAgICAgY3B1cG9vbF9kb21haW5fY3B1
bWFzayh2LT5kb21haW4pKTsKKyAgICAgICAgICAgICAgICBjcHVwb29sX2RvbWFpbl9jcHVtYXNr
KHVuaXQtPmRvbWFpbikpOwogCiAgICAgcmV0dXJuIGNwdW1hc2tfdGVzdF9jcHUoY3B1LCBjcHVt
YXNrX3NjcmF0Y2hfY3B1KGNwdSkpOwogfQpAQCAtMTYxLDkgKzE2MSw5IEBAIHN0YXRpYyB2b2lk
IG51bGxfZGVpbml0KHN0cnVjdCBzY2hlZHVsZXIgKm9wcykKIAogc3RhdGljIHZvaWQgaW5pdF9w
ZGF0YShzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHVuc2lnbmVkIGludCBjcHUpCiB7Ci0gICAg
LyogTWFyayB0aGUgcENQVSBhcyBmcmVlLCBhbmQgd2l0aCBubyB2Q1BVIGFzc2lnbmVkICovCisg
ICAgLyogTWFyayB0aGUgcENQVSBhcyBmcmVlLCBhbmQgd2l0aCBubyB1bml0IGFzc2lnbmVkICov
CiAgICAgY3B1bWFza19zZXRfY3B1KGNwdSwgJnBydi0+Y3B1c19mcmVlKTsKLSAgICBwZXJfY3B1
KG5wYywgY3B1KS52Y3B1ID0gTlVMTDsKKyAgICBwZXJfY3B1KG5wYywgY3B1KS51bml0ID0gTlVM
TDsKIH0KIAogc3RhdGljIHZvaWQgbnVsbF9pbml0X3BkYXRhKGNvbnN0IHN0cnVjdCBzY2hlZHVs
ZXIgKm9wcywgdm9pZCAqcGRhdGEsIGludCBjcHUpCkBAIC0xOTEsMTMgKzE5MSwxMiBAQCBzdGF0
aWMgdm9pZCBudWxsX2RlaW5pdF9wZGF0YShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHZv
aWQgKnBjcHUsIGludCBjcHUpCiAgICAgQVNTRVJUKCFwY3B1KTsKIAogICAgIGNwdW1hc2tfY2xl
YXJfY3B1KGNwdSwgJnBydi0+Y3B1c19mcmVlKTsKLSAgICBwZXJfY3B1KG5wYywgY3B1KS52Y3B1
ID0gTlVMTDsKKyAgICBwZXJfY3B1KG5wYywgY3B1KS51bml0ID0gTlVMTDsKIH0KIAogc3RhdGlj
IHZvaWQgKm51bGxfYWxsb2NfdmRhdGEoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsIHZvaWQg
KmRkKQogewotICAgIHN0cnVjdCB2Y3B1ICp2ID0gdW5pdC0+dmNwdTsKICAgICBzdHJ1Y3QgbnVs
bF91bml0ICpudmM7CiAKICAgICBudmMgPSB4emFsbG9jKHN0cnVjdCBudWxsX3VuaXQpOwpAQCAt
MjA1LDcgKzIwNCw3IEBAIHN0YXRpYyB2b2lkICpudWxsX2FsbG9jX3ZkYXRhKGNvbnN0IHN0cnVj
dCBzY2hlZHVsZXIgKm9wcywKICAgICAgICAgcmV0dXJuIE5VTEw7CiAKICAgICBJTklUX0xJU1Rf
SEVBRCgmbnZjLT53YWl0cV9lbGVtKTsKLSAgICBudmMtPnZjcHUgPSB2OworICAgIG52Yy0+dW5p
dCA9IHVuaXQ7CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfYWxsb2MpOwogCkBAIC0yNTcs
MTUgKzI1NiwxNSBAQCBzdGF0aWMgdm9pZCBudWxsX2ZyZWVfZG9tZGF0YShjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMsIHZvaWQgKmRhdGEpCiB9CiAKIC8qCi0gKiB2Q1BVIHRvIHBDUFUgYXNz
aWdubWVudCBhbmQgcGxhY2VtZW50LiBUaGlzIF9vbmx5XyBoYXBwZW5zOgorICogdW5pdCB0byBw
Q1BVIGFzc2lnbm1lbnQgYW5kIHBsYWNlbWVudC4gVGhpcyBfb25seV8gaGFwcGVuczoKICAqICAt
IG9uIGluc2VydCwKICAqICAtIG9uIG1pZ3JhdGUuCiAgKgotICogSW5zZXJ0IG9jY3VycyB3aGVu
IGEgdkNQVSBqb2lucyB0aGlzIHNjaGVkdWxlciBmb3IgdGhlIGZpcnN0IHRpbWUKKyAqIEluc2Vy
dCBvY2N1cnMgd2hlbiBhIHVuaXQgam9pbnMgdGhpcyBzY2hlZHVsZXIgZm9yIHRoZSBmaXJzdCB0
aW1lCiAgKiAoZS5nLiwgd2hlbiB0aGUgZG9tYWluIGl0J3MgcGFydCBvZiBpcyBtb3ZlZCB0byB0
aGUgc2NoZWR1bGVyJ3MKICAqIGNwdXBvb2wpLgogICoKLSAqIE1pZ3JhdGlvbiBtYXkgYmUgbmVj
ZXNzYXJ5IGlmIGEgcENQVSAod2l0aCBhIHZDUFUgYXNzaWduZWQgdG8gaXQpCisgKiBNaWdyYXRp
b24gbWF5IGJlIG5lY2Vzc2FyeSBpZiBhIHBDUFUgKHdpdGggYSB1bml0IGFzc2lnbmVkIHRvIGl0
KQogICogaXMgcmVtb3ZlZCBmcm9tIHRoZSBzY2hlZHVsZXIncyBjcHVwb29sLgogICoKICAqIFNv
IHRoaXMgaXMgbm90IHBhcnQgb2YgYW55IGhvdCBwYXRoLgpAQCAtMjc0LDkgKzI3Myw4IEBAIHN0
YXRpYyBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKgogcGlja19yZXMoc3RydWN0IG51bGxfcHJpdmF0
ZSAqcHJ2LCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIHsKICAgICB1bnNpZ25lZCBpbnQgYnM7
Ci0gICAgc3RydWN0IHZjcHUgKnYgPSB1bml0LT52Y3B1OwotICAgIHVuc2lnbmVkIGludCBjcHUg
PSB2LT5wcm9jZXNzb3IsIG5ld19jcHU7Ci0gICAgY3B1bWFza190ICpjcHVzID0gY3B1cG9vbF9k
b21haW5fY3B1bWFzayh2LT5kb21haW4pOworICAgIHVuc2lnbmVkIGludCBjcHUgPSBzY2hlZF91
bml0X2NwdSh1bml0KSwgbmV3X2NwdTsKKyAgICBjcHVtYXNrX3QgKmNwdXMgPSBjcHVwb29sX2Rv
bWFpbl9jcHVtYXNrKHVuaXQtPmRvbWFpbik7CiAKICAgICBBU1NFUlQoc3Bpbl9pc19sb2NrZWQo
Z2V0X3NjaGVkX3JlcyhjcHUpLT5zY2hlZHVsZV9sb2NrKSk7CiAKQEAgLTI5MSwxMSArMjg5LDEy
IEBAIHBpY2tfcmVzKHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiwgc3RydWN0IHNjaGVkX3VuaXQg
KnVuaXQpCiAgICAgICAgIC8qCiAgICAgICAgICAqIElmIG91ciBwcm9jZXNzb3IgaXMgZnJlZSwg
b3Igd2UgYXJlIGFzc2lnbmVkIHRvIGl0LCBhbmQgaXQgaXMgYWxzbwogICAgICAgICAgKiBzdGls
bCB2YWxpZCBhbmQgcGFydCBvZiBvdXIgYWZmaW5pdHksIGp1c3QgZ28gZm9yIGl0LgotICAgICAg
ICAgKiAoTm90ZSB0aGF0IHdlIG1heSBjYWxsIHZjcHVfY2hlY2tfYWZmaW5pdHkoKSwgYnV0IHdl
IGRlbGliZXJhdGVseQorICAgICAgICAgKiAoTm90ZSB0aGF0IHdlIG1heSBjYWxsIHVuaXRfY2hl
Y2tfYWZmaW5pdHkoKSwgYnV0IHdlIGRlbGliZXJhdGVseQogICAgICAgICAgKiBkb24ndCwgc28g
d2UgZ2V0IHRvIGtlZXAgaW4gdGhlIHNjcmF0Y2ggY3B1bWFzayB3aGF0IHdlIGhhdmUganVzdAog
ICAgICAgICAgKiBwdXQgaW4gaXQuKQogICAgICAgICAgKi8KLSAgICAgICAgaWYgKCBsaWtlbHko
KHBlcl9jcHUobnBjLCBjcHUpLnZjcHUgPT0gTlVMTCB8fCBwZXJfY3B1KG5wYywgY3B1KS52Y3B1
ID09IHYpCisgICAgICAgIGlmICggbGlrZWx5KChwZXJfY3B1KG5wYywgY3B1KS51bml0ID09IE5V
TEwgfHwKKyAgICAgICAgICAgICAgICAgICAgIHBlcl9jcHUobnBjLCBjcHUpLnVuaXQgPT0gdW5p
dCkKICAgICAgICAgICAgICAgICAgICAgJiYgY3B1bWFza190ZXN0X2NwdShjcHUsIGNwdW1hc2tf
c2NyYXRjaF9jcHUoY3B1KSkpICkKICAgICAgICAgewogICAgICAgICAgICAgbmV3X2NwdSA9IGNw
dTsKQEAgLTMxMywxMyArMzEyLDEzIEBAIHBpY2tfcmVzKHN0cnVjdCBudWxsX3ByaXZhdGUgKnBy
diwgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAKICAgICAvKgogICAgICAqIElmIHdlIGRpZG4n
dCBmaW5kIGFueSBmcmVlIHBDUFUsIGp1c3QgcGljayBhbnkgdmFsaWQgcGNwdSwgZXZlbiBpZgot
ICAgICAqIGl0IGhhcyBhbm90aGVyIHZDUFUgYXNzaWduZWQuIFRoaXMgd2lsbCBoYXBwZW4gZHVy
aW5nIHNodXRkb3duIGFuZAorICAgICAqIGl0IGhhcyBhbm90aGVyIEl0ZW0gYXNzaWduZWQuIFRo
aXMgd2lsbCBoYXBwZW4gZHVyaW5nIHNodXRkb3duIGFuZAogICAgICAqIHN1c3BlbmQvcmVzdW1l
LCBidXQgaXQgbWF5IGFsc28gaGFwcGVuIGR1cmluZyAibm9ybWFsIG9wZXJhdGlvbiIsIGlmCiAg
ICAgICogYWxsIHRoZSBwQ1BVcyBhcmUgYnVzeS4KICAgICAgKgogICAgICAqIEluIGZhY3QsIHRo
ZXJlIG11c3QgYWx3YXlzIGJlIHNvbWV0aGluZyBzYW5lIGluIHYtPnByb2Nlc3Nvciwgb3IKICAg
ICAgKiB1bml0X3NjaGVkdWxlX2xvY2soKSBhbmQgZnJpZW5kcyB3b24ndCB3b3JrLiBUaGlzIGlz
IG5vdCBhIHByb2JsZW0sCi0gICAgICogYXMgd2Ugd2lsbCBhY3R1YWxseSBhc3NpZ24gdGhlIHZD
UFUgdG8gdGhlIHBDUFUgd2UgcmV0dXJuIGZyb20gaGVyZSwKKyAgICAgKiBhcyB3ZSB3aWxsIGFj
dHVhbGx5IGFzc2lnbiB0aGUgSXRlbSB0byB0aGUgcENQVSB3ZSByZXR1cm4gZnJvbSBoZXJlLAog
ICAgICAqIG9ubHkgaWYgdGhlIHBDUFUgaXMgZnJlZS4KICAgICAgKi8KICAgICBjcHVtYXNrX2Fu
ZChjcHVtYXNrX3NjcmF0Y2hfY3B1KGNwdSksIGNwdXMsIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5
KTsKQEAgLTMyOSwxMSArMzI4LDExIEBAIHBpY2tfcmVzKHN0cnVjdCBudWxsX3ByaXZhdGUgKnBy
diwgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAgICAgaWYgKCB1bmxpa2VseSh0Yl9pbml0X2Rv
bmUpICkKICAgICB7CiAgICAgICAgIHN0cnVjdCB7Ci0gICAgICAgICAgICB1aW50MTZfdCB2Y3B1
LCBkb207CisgICAgICAgICAgICB1aW50MTZfdCB1bml0LCBkb207CiAgICAgICAgICAgICB1aW50
MzJfdCBuZXdfY3B1OwogICAgICAgICB9IGQ7Ci0gICAgICAgIGQuZG9tID0gdi0+ZG9tYWluLT5k
b21haW5faWQ7Ci0gICAgICAgIGQudmNwdSA9IHYtPnZjcHVfaWQ7CisgICAgICAgIGQuZG9tID0g
dW5pdC0+ZG9tYWluLT5kb21haW5faWQ7CisgICAgICAgIGQudW5pdCA9IHVuaXQtPnVuaXRfaWQ7
CiAgICAgICAgIGQubmV3X2NwdSA9IG5ld19jcHU7CiAgICAgICAgIF9fdHJhY2VfdmFyKFRSQ19T
TlVMTF9QSUNLRURfQ1BVLCAxLCBzaXplb2YoZCksICZkKTsKICAgICB9CkBAIC0zNDEsNDcgKzM0
MCw0NyBAQCBwaWNrX3JlcyhzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHN0cnVjdCBzY2hlZF91
bml0ICp1bml0KQogICAgIHJldHVybiBnZXRfc2NoZWRfcmVzKG5ld19jcHUpOwogfQogCi1zdGF0
aWMgdm9pZCB2Y3B1X2Fzc2lnbihzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHN0cnVjdCB2Y3B1
ICp2LAorc3RhdGljIHZvaWQgdW5pdF9hc3NpZ24oc3RydWN0IG51bGxfcHJpdmF0ZSAqcHJ2LCBz
dHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVk
IGludCBjcHUpCiB7Ci0gICAgcGVyX2NwdShucGMsIGNwdSkudmNwdSA9IHY7Ci0gICAgdi0+cHJv
Y2Vzc29yID0gY3B1OwotICAgIHYtPnNjaGVkX3VuaXQtPnJlcyA9IGdldF9zY2hlZF9yZXMoY3B1
KTsKKyAgICBwZXJfY3B1KG5wYywgY3B1KS51bml0ID0gdW5pdDsKKyAgICBzY2hlZF9zZXRfcmVz
KHVuaXQsIGdldF9zY2hlZF9yZXMoY3B1KSk7CiAgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1LCAm
cHJ2LT5jcHVzX2ZyZWUpOwogCi0gICAgZHByaW50ayhYRU5MT0dfR19JTkZPLCAiJWQgPC0tICVw
dlxuIiwgY3B1LCB2KTsKKyAgICBkcHJpbnRrKFhFTkxPR19HX0lORk8sICIlZCA8LS0gJXBkdiVk
XG4iLCBjcHUsIHVuaXQtPmRvbWFpbiwgdW5pdC0+dW5pdF9pZCk7CiAKICAgICBpZiAoIHVubGlr
ZWx5KHRiX2luaXRfZG9uZSkgKQogICAgIHsKICAgICAgICAgc3RydWN0IHsKLSAgICAgICAgICAg
IHVpbnQxNl90IHZjcHUsIGRvbTsKKyAgICAgICAgICAgIHVpbnQxNl90IHVuaXQsIGRvbTsKICAg
ICAgICAgICAgIHVpbnQzMl90IGNwdTsKICAgICAgICAgfSBkOwotICAgICAgICBkLmRvbSA9IHYt
PmRvbWFpbi0+ZG9tYWluX2lkOwotICAgICAgICBkLnZjcHUgPSB2LT52Y3B1X2lkOworICAgICAg
ICBkLmRvbSA9IHVuaXQtPmRvbWFpbi0+ZG9tYWluX2lkOworICAgICAgICBkLnVuaXQgPSB1bml0
LT51bml0X2lkOwogICAgICAgICBkLmNwdSA9IGNwdTsKLSAgICAgICAgX190cmFjZV92YXIoVFJD
X1NOVUxMX1ZDUFVfQVNTSUdOLCAxLCBzaXplb2YoZCksICZkKTsKKyAgICAgICAgX190cmFjZV92
YXIoVFJDX1NOVUxMX1VOSVRfQVNTSUdOLCAxLCBzaXplb2YoZCksICZkKTsKICAgICB9CiB9CiAK
LXN0YXRpYyB2b2lkIHZjcHVfZGVhc3NpZ24oc3RydWN0IG51bGxfcHJpdmF0ZSAqcHJ2LCBzdHJ1
Y3QgdmNwdSAqdiwKK3N0YXRpYyB2b2lkIHVuaXRfZGVhc3NpZ24oc3RydWN0IG51bGxfcHJpdmF0
ZSAqcHJ2LCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgdW5zaWduZWQgaW50IGNwdSkKIHsKLSAgICBwZXJfY3B1KG5wYywgY3B1KS52Y3B1ID0gTlVM
TDsKKyAgICBwZXJfY3B1KG5wYywgY3B1KS51bml0ID0gTlVMTDsKICAgICBjcHVtYXNrX3NldF9j
cHUoY3B1LCAmcHJ2LT5jcHVzX2ZyZWUpOwogCi0gICAgZHByaW50ayhYRU5MT0dfR19JTkZPLCAi
JWQgPC0tIE5VTEwgKCVwdilcbiIsIGNwdSwgdik7CisgICAgZHByaW50ayhYRU5MT0dfR19JTkZP
LCAiJWQgPC0tIE5VTEwgKCVwZHYlZClcbiIsIGNwdSwgdW5pdC0+ZG9tYWluLAorICAgICAgICAg
ICAgdW5pdC0+dW5pdF9pZCk7CiAKICAgICBpZiAoIHVubGlrZWx5KHRiX2luaXRfZG9uZSkgKQog
ICAgIHsKICAgICAgICAgc3RydWN0IHsKLSAgICAgICAgICAgIHVpbnQxNl90IHZjcHUsIGRvbTsK
KyAgICAgICAgICAgIHVpbnQxNl90IHVuaXQsIGRvbTsKICAgICAgICAgICAgIHVpbnQzMl90IGNw
dTsKICAgICAgICAgfSBkOwotICAgICAgICBkLmRvbSA9IHYtPmRvbWFpbi0+ZG9tYWluX2lkOwot
ICAgICAgICBkLnZjcHUgPSB2LT52Y3B1X2lkOworICAgICAgICBkLmRvbSA9IHVuaXQtPmRvbWFp
bi0+ZG9tYWluX2lkOworICAgICAgICBkLnVuaXQgPSB1bml0LT51bml0X2lkOwogICAgICAgICBk
LmNwdSA9IGNwdTsKLSAgICAgICAgX190cmFjZV92YXIoVFJDX1NOVUxMX1ZDUFVfREVBU1NJR04s
IDEsIHNpemVvZihkKSwgJmQpOworICAgICAgICBfX3RyYWNlX3ZhcihUUkNfU05VTExfVU5JVF9E
RUFTU0lHTiwgMSwgc2l6ZW9mKGQpLCAmZCk7CiAgICAgfQogfQogCkBAIC0zOTQsOSArMzkzLDkg
QEAgc3RhdGljIHNwaW5sb2NrX3QgKm51bGxfc3dpdGNoX3NjaGVkKHN0cnVjdCBzY2hlZHVsZXIg
Km5ld19vcHMsCiAgICAgc3RydWN0IG51bGxfcHJpdmF0ZSAqcHJ2ID0gbnVsbF9wcml2KG5ld19v
cHMpOwogICAgIHN0cnVjdCBudWxsX3VuaXQgKm52YyA9IHZkYXRhOwogCi0gICAgQVNTRVJUKG52
YyAmJiBpc19pZGxlX3ZjcHUobnZjLT52Y3B1KSk7CisgICAgQVNTRVJUKG52YyAmJiBpc19pZGxl
X3VuaXQobnZjLT51bml0KSk7CiAKLSAgICBpZGxlX3ZjcHVbY3B1XS0+c2NoZWRfdW5pdC0+cHJp
diA9IHZkYXRhOworICAgIHNjaGVkX2lkbGVfdW5pdChjcHUpLT5wcml2ID0gdmRhdGE7CiAKICAg
ICAvKgogICAgICAqIFdlIGFyZSBob2xkaW5nIHRoZSBydW5xdWV1ZSBsb2NrIGFscmVhZHkgKGl0
J3MgYmVlbiB0YWtlbiBpbgpAQCAtNDEzLDM1ICs0MTIsMzQgQEAgc3RhdGljIHNwaW5sb2NrX3Qg
Km51bGxfc3dpdGNoX3NjaGVkKHN0cnVjdCBzY2hlZHVsZXIgKm5ld19vcHMsCiBzdGF0aWMgdm9p
ZCBudWxsX3VuaXRfaW5zZXJ0KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAgc3Ry
dWN0IHZjcHUgKnYgPSB1bml0LT52Y3B1OwogICAgIHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiA9
IG51bGxfcHJpdihvcHMpOwogICAgIHN0cnVjdCBudWxsX3VuaXQgKm52YyA9IG51bGxfdW5pdCh1
bml0KTsKICAgICB1bnNpZ25lZCBpbnQgY3B1OwogICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAKLSAg
ICBBU1NFUlQoIWlzX2lkbGVfdmNwdSh2KSk7CisgICAgQVNTRVJUKCFpc19pZGxlX3VuaXQodW5p
dCkpOwogCiAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5pdCk7CiAgcmV0cnk6
CiAKLSAgICB1bml0LT5yZXMgPSBwaWNrX3JlcyhwcnYsIHVuaXQpOwotICAgIGNwdSA9IHYtPnBy
b2Nlc3NvciA9IHVuaXQtPnJlcy0+cHJvY2Vzc29yOworICAgIHNjaGVkX3NldF9yZXModW5pdCwg
cGlja19yZXMocHJ2LCB1bml0KSk7CisgICAgY3B1ID0gc2NoZWRfdW5pdF9jcHUodW5pdCk7CiAK
ICAgICBzcGluX3VubG9jayhsb2NrKTsKIAogICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2so
dW5pdCk7CiAKICAgICBjcHVtYXNrX2FuZChjcHVtYXNrX3NjcmF0Y2hfY3B1KGNwdSksIHVuaXQt
PmNwdV9oYXJkX2FmZmluaXR5LAotICAgICAgICAgICAgICAgIGNwdXBvb2xfZG9tYWluX2NwdW1h
c2sodi0+ZG9tYWluKSk7CisgICAgICAgICAgICAgICAgY3B1cG9vbF9kb21haW5fY3B1bWFzayh1
bml0LT5kb21haW4pKTsKIAotICAgIC8qIElmIHRoZSBwQ1BVIGlzIGZyZWUsIHdlIGFzc2lnbiB2
IHRvIGl0ICovCi0gICAgaWYgKCBsaWtlbHkocGVyX2NwdShucGMsIGNwdSkudmNwdSA9PSBOVUxM
KSApCisgICAgLyogSWYgdGhlIHBDUFUgaXMgZnJlZSwgd2UgYXNzaWduIHVuaXQgdG8gaXQgKi8K
KyAgICBpZiAoIGxpa2VseShwZXJfY3B1KG5wYywgY3B1KS51bml0ID09IE5VTEwpICkKICAgICB7
CiAgICAgICAgIC8qCiAgICAgICAgICAqIEluc2VydCBpcyBmb2xsb3dlZCBieSB2Y3B1X3dha2Uo
KSwgc28gdGhlcmUncyBubyBuZWVkIHRvIHBva2UKICAgICAgICAgICogdGhlIHBjcHUgd2l0aCB0
aGUgU0NIRURVTEVfU09GVElSUSwgYXMgd2FrZSB3aWxsIGRvIHRoYXQuCiAgICAgICAgICAqLwot
ICAgICAgICB2Y3B1X2Fzc2lnbihwcnYsIHYsIGNwdSk7CisgICAgICAgIHVuaXRfYXNzaWduKHBy
diwgdW5pdCwgY3B1KTsKICAgICB9CiAgICAgZWxzZSBpZiAoIGNwdW1hc2tfaW50ZXJzZWN0cygm
cHJ2LT5jcHVzX2ZyZWUsIGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSkgKQogICAgIHsKQEAgLTQ2
MCw3ICs0NTgsOCBAQCBzdGF0aWMgdm9pZCBudWxsX3VuaXRfaW5zZXJ0KGNvbnN0IHN0cnVjdCBz
Y2hlZHVsZXIgKm9wcywKICAgICAgICAgICovCiAgICAgICAgIHNwaW5fbG9jaygmcHJ2LT53YWl0
cV9sb2NrKTsKICAgICAgICAgbGlzdF9hZGRfdGFpbCgmbnZjLT53YWl0cV9lbGVtLCAmcHJ2LT53
YWl0cSk7Ci0gICAgICAgIGRwcmludGsoWEVOTE9HX0dfV0FSTklORywgIldBUk5JTkc6ICVwdiBu
b3QgYXNzaWduZWQgdG8gYW55IENQVSFcbiIsIHYpOworICAgICAgICBkcHJpbnRrKFhFTkxPR19H
X1dBUk5JTkcsICJXQVJOSU5HOiAlcGR2JWQgbm90IGFzc2lnbmVkIHRvIGFueSBDUFUhXG4iLAor
ICAgICAgICAgICAgICAgIHVuaXQtPmRvbWFpbiwgdW5pdC0+dW5pdF9pZCk7CiAgICAgICAgIHNw
aW5fdW5sb2NrKCZwcnYtPndhaXRxX2xvY2spOwogICAgIH0KICAgICBzcGluX3VubG9ja19pcnEo
bG9jayk7CkBAIC00NjgsMzUgKzQ2NywzNCBAQCBzdGF0aWMgdm9pZCBudWxsX3VuaXRfaW5zZXJ0
KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRf
aW5zZXJ0KTsKIH0KIAotc3RhdGljIHZvaWQgX3ZjcHVfcmVtb3ZlKHN0cnVjdCBudWxsX3ByaXZh
dGUgKnBydiwgc3RydWN0IHZjcHUgKnYpCitzdGF0aWMgdm9pZCBfdW5pdF9yZW1vdmUoc3RydWN0
IG51bGxfcHJpdmF0ZSAqcHJ2LCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIHsKICAgICB1bnNp
Z25lZCBpbnQgYnM7Ci0gICAgdW5zaWduZWQgaW50IGNwdSA9IHYtPnByb2Nlc3NvcjsKKyAgICB1
bnNpZ25lZCBpbnQgY3B1ID0gc2NoZWRfdW5pdF9jcHUodW5pdCk7CiAgICAgc3RydWN0IG51bGxf
dW5pdCAqd3ZjOwogCi0gICAgQVNTRVJUKGxpc3RfZW1wdHkoJm51bGxfdW5pdCh2LT5zY2hlZF91
bml0KS0+d2FpdHFfZWxlbSkpOworICAgIEFTU0VSVChsaXN0X2VtcHR5KCZudWxsX3VuaXQodW5p
dCktPndhaXRxX2VsZW0pKTsKIAotICAgIHZjcHVfZGVhc3NpZ24ocHJ2LCB2LCBjcHUpOworICAg
IHVuaXRfZGVhc3NpZ24ocHJ2LCB1bml0LCBjcHUpOwogCiAgICAgc3Bpbl9sb2NrKCZwcnYtPndh
aXRxX2xvY2spOwogCiAgICAgLyoKLSAgICAgKiBJZiB2IGlzIGFzc2lnbmVkIHRvIGEgcENQVSwg
bGV0J3Mgc2VlIGlmIHRoZXJlIGlzIHNvbWVvbmUgd2FpdGluZywKLSAgICAgKiBzdWl0YWJsZSB0
byBiZSBhc3NpZ25lZCB0byBpdCAocHJpb3JpdGl6aW5nIHZjcHVzIHRoYXQgaGF2ZQorICAgICAq
IElmIHVuaXQgaXMgYXNzaWduZWQgdG8gYSBwQ1BVLCBsZXQncyBzZWUgaWYgdGhlcmUgaXMgc29t
ZW9uZSB3YWl0aW5nLAorICAgICAqIHN1aXRhYmxlIHRvIGJlIGFzc2lnbmVkIHRvIGl0IChwcmlv
cml0aXppbmcgdW5pdHMgdGhhdCBoYXZlCiAgICAgICogc29mdC1hZmZpbml0eSB3aXRoIGNwdSku
CiAgICAgICovCiAgICAgZm9yX2VhY2hfYWZmaW5pdHlfYmFsYW5jZV9zdGVwKCBicyApCiAgICAg
ewogICAgICAgICBsaXN0X2Zvcl9lYWNoX2VudHJ5KCB3dmMsICZwcnYtPndhaXRxLCB3YWl0cV9l
bGVtICkKICAgICAgICAgewotICAgICAgICAgICAgaWYgKCBicyA9PSBCQUxBTkNFX1NPRlRfQUZG
SU5JVFkgJiYKLSAgICAgICAgICAgICAgICAgIWhhc19zb2Z0X2FmZmluaXR5KHd2Yy0+dmNwdS0+
c2NoZWRfdW5pdCkgKQorICAgICAgICAgICAgaWYgKCBicyA9PSBCQUxBTkNFX1NPRlRfQUZGSU5J
VFkgJiYgIWhhc19zb2Z0X2FmZmluaXR5KHd2Yy0+dW5pdCkgKQogICAgICAgICAgICAgICAgIGNv
bnRpbnVlOwogCi0gICAgICAgICAgICBpZiAoIHZjcHVfY2hlY2tfYWZmaW5pdHkod3ZjLT52Y3B1
LCBjcHUsIGJzKSApCisgICAgICAgICAgICBpZiAoIHVuaXRfY2hlY2tfYWZmaW5pdHkod3ZjLT51
bml0LCBjcHUsIGJzKSApCiAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgbGlzdF9kZWxf
aW5pdCgmd3ZjLT53YWl0cV9lbGVtKTsKLSAgICAgICAgICAgICAgICB2Y3B1X2Fzc2lnbihwcnYs
IHd2Yy0+dmNwdSwgY3B1KTsKKyAgICAgICAgICAgICAgICB1bml0X2Fzc2lnbihwcnYsIHd2Yy0+
dW5pdCwgY3B1KTsKICAgICAgICAgICAgICAgICBjcHVfcmFpc2Vfc29mdGlycShjcHUsIFNDSEVE
VUxFX1NPRlRJUlEpOwogICAgICAgICAgICAgICAgIHNwaW5fdW5sb2NrKCZwcnYtPndhaXRxX2xv
Y2spOwogICAgICAgICAgICAgICAgIHJldHVybjsKQEAgLTUwOSwxNiArNTA3LDE1IEBAIHN0YXRp
YyB2b2lkIF92Y3B1X3JlbW92ZShzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYsIHN0cnVjdCB2Y3B1
ICp2KQogc3RhdGljIHZvaWQgbnVsbF91bml0X3JlbW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVy
ICpvcHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICp1
bml0KQogewotICAgIHN0cnVjdCB2Y3B1ICp2ID0gdW5pdC0+dmNwdTsKICAgICBzdHJ1Y3QgbnVs
bF9wcml2YXRlICpwcnYgPSBudWxsX3ByaXYob3BzKTsKICAgICBzdHJ1Y3QgbnVsbF91bml0ICpu
dmMgPSBudWxsX3VuaXQodW5pdCk7CiAgICAgc3BpbmxvY2tfdCAqbG9jazsKIAotICAgIEFTU0VS
VCghaXNfaWRsZV92Y3B1KHYpKTsKKyAgICBBU1NFUlQoIWlzX2lkbGVfdW5pdCh1bml0KSk7CiAK
ICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2NrX2lycSh1bml0KTsKIAotICAgIC8qIElmIHYg
aXMgaW4gd2FpdHF1ZXVlLCBqdXN0IGdldCBpdCBvdXQgb2YgdGhlcmUgYW5kIGJhaWwgKi8KKyAg
ICAvKiBJZiB1bml0IGlzIGluIHdhaXRxdWV1ZSwganVzdCBnZXQgaXQgb3V0IG9mIHRoZXJlIGFu
ZCBiYWlsICovCiAgICAgaWYgKCB1bmxpa2VseSghbGlzdF9lbXB0eSgmbnZjLT53YWl0cV9lbGVt
KSkgKQogICAgIHsKICAgICAgICAgc3Bpbl9sb2NrKCZwcnYtPndhaXRxX2xvY2spOwpAQCAtNTI4
LDEwICs1MjUsMTAgQEAgc3RhdGljIHZvaWQgbnVsbF91bml0X3JlbW92ZShjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMsCiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0KIAotICAgIEFTU0VSVChw
ZXJfY3B1KG5wYywgdi0+cHJvY2Vzc29yKS52Y3B1ID09IHYpOwotICAgIEFTU0VSVCghY3B1bWFz
a190ZXN0X2NwdSh2LT5wcm9jZXNzb3IsICZwcnYtPmNwdXNfZnJlZSkpOworICAgIEFTU0VSVChw
ZXJfY3B1KG5wYywgc2NoZWRfdW5pdF9jcHUodW5pdCkpLnVuaXQgPT0gdW5pdCk7CisgICAgQVNT
RVJUKCFjcHVtYXNrX3Rlc3RfY3B1KHNjaGVkX3VuaXRfY3B1KHVuaXQpLCAmcHJ2LT5jcHVzX2Zy
ZWUpKTsKIAotICAgIF92Y3B1X3JlbW92ZShwcnYsIHYpOworICAgIF91bml0X3JlbW92ZShwcnYs
IHVuaXQpOwogCiAgb3V0OgogICAgIHVuaXRfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCB1bml0
KTsKQEAgLTU0MiwxMSArNTM5LDkgQEAgc3RhdGljIHZvaWQgbnVsbF91bml0X3JlbW92ZShjb25z
dCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiBzdGF0aWMgdm9pZCBudWxsX3VuaXRfd2FrZShjb25z
dCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJ1
Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqdiA9IHVuaXQtPnZjcHU7
CisgICAgQVNTRVJUKCFpc19pZGxlX3VuaXQodW5pdCkpOwogCi0gICAgQVNTRVJUKCFpc19pZGxl
X3ZjcHUodikpOwotCi0gICAgaWYgKCB1bmxpa2VseShjdXJyX29uX2NwdSh2LT5wcm9jZXNzb3Ip
ID09IHVuaXQpICkKKyAgICBpZiAoIHVubGlrZWx5KGN1cnJfb25fY3B1KHNjaGVkX3VuaXRfY3B1
KHVuaXQpKSA9PSB1bml0KSApCiAgICAgewogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRf
d2FrZV9ydW5uaW5nKTsKICAgICAgICAgcmV0dXJuOwpAQCAtNTU5LDI1ICs1NTQsMjMgQEAgc3Rh
dGljIHZvaWQgbnVsbF91bml0X3dha2UoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAg
ICAgICByZXR1cm47CiAgICAgfQogCi0gICAgaWYgKCBsaWtlbHkodmNwdV9ydW5uYWJsZSh2KSkg
KQorICAgIGlmICggbGlrZWx5KHVuaXRfcnVubmFibGUodW5pdCkpICkKICAgICAgICAgU0NIRURf
U1RBVF9DUkFOSyh1bml0X3dha2VfcnVubmFibGUpOwogICAgIGVsc2UKICAgICAgICAgU0NIRURf
U1RBVF9DUkFOSyh1bml0X3dha2Vfbm90X3J1bm5hYmxlKTsKIAotICAgIC8qIE5vdGUgdGhhdCB3
ZSBnZXQgaGVyZSBvbmx5IGZvciB2Q1BVcyBhc3NpZ25lZCB0byBhIHBDUFUgKi8KLSAgICBjcHVf
cmFpc2Vfc29mdGlycSh2LT5wcm9jZXNzb3IsIFNDSEVEVUxFX1NPRlRJUlEpOworICAgIC8qIE5v
dGUgdGhhdCB3ZSBnZXQgaGVyZSBvbmx5IGZvciB1bml0cyBhc3NpZ25lZCB0byBhIHBDUFUgKi8K
KyAgICBjcHVfcmFpc2Vfc29mdGlycShzY2hlZF91bml0X2NwdSh1bml0KSwgU0NIRURVTEVfU09G
VElSUSk7CiB9CiAKIHN0YXRpYyB2b2lkIG51bGxfdW5pdF9zbGVlcChjb25zdCBzdHJ1Y3Qgc2No
ZWR1bGVyICpvcHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX3Vu
aXQgKnVuaXQpCiB7Ci0gICAgc3RydWN0IHZjcHUgKnYgPSB1bml0LT52Y3B1OwotCi0gICAgQVNT
RVJUKCFpc19pZGxlX3ZjcHUodikpOworICAgIEFTU0VSVCghaXNfaWRsZV91bml0KHVuaXQpKTsK
IAotICAgIC8qIElmIHYgaXMgbm90IGFzc2lnbmVkIHRvIGEgcENQVSwgb3IgaXMgbm90IHJ1bm5p
bmcsIG5vIG5lZWQgdG8gYm90aGVyICovCi0gICAgaWYgKCBjdXJyX29uX2NwdSh2LT5wcm9jZXNz
b3IpID09IHVuaXQgKQotICAgICAgICBjcHVfcmFpc2Vfc29mdGlycSh2LT5wcm9jZXNzb3IsIFND
SEVEVUxFX1NPRlRJUlEpOworICAgIC8qIElmIHVuaXQgaXNuJ3QgYXNzaWduZWQgdG8gYSBwQ1BV
LCBvciBpc24ndCBydW5uaW5nLCBubyBuZWVkIHRvIGJvdGhlciAqLworICAgIGlmICggY3Vycl9v
bl9jcHUoc2NoZWRfdW5pdF9jcHUodW5pdCkpID09IHVuaXQgKQorICAgICAgICBjcHVfcmFpc2Vf
c29mdGlycShzY2hlZF91bml0X2NwdSh1bml0KSwgU0NIRURVTEVfU09GVElSUSk7CiAKICAgICBT
Q0hFRF9TVEFUX0NSQU5LKHVuaXRfc2xlZXApOwogfQpAQCAtNTg1LDM3ICs1NzgsMzYgQEAgc3Rh
dGljIHZvaWQgbnVsbF91bml0X3NsZWVwKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKIHN0
YXRpYyBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKgogbnVsbF9yZXNfcGljayhjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMsIHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQogewotICAgIEFTU0VSVCgh
aXNfaWRsZV92Y3B1KHVuaXQtPnZjcHUpKTsKKyAgICBBU1NFUlQoIWlzX2lkbGVfdW5pdCh1bml0
KSk7CiAgICAgcmV0dXJuIHBpY2tfcmVzKG51bGxfcHJpdihvcHMpLCB1bml0KTsKIH0KIAogc3Rh
dGljIHZvaWQgbnVsbF91bml0X21pZ3JhdGUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAog
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsIHVu
c2lnbmVkIGludCBuZXdfY3B1KQogewotICAgIHN0cnVjdCB2Y3B1ICp2ID0gdW5pdC0+dmNwdTsK
ICAgICBzdHJ1Y3QgbnVsbF9wcml2YXRlICpwcnYgPSBudWxsX3ByaXYob3BzKTsKICAgICBzdHJ1
Y3QgbnVsbF91bml0ICpudmMgPSBudWxsX3VuaXQodW5pdCk7CiAKLSAgICBBU1NFUlQoIWlzX2lk
bGVfdmNwdSh2KSk7CisgICAgQVNTRVJUKCFpc19pZGxlX3VuaXQodW5pdCkpOwogCi0gICAgaWYg
KCB2LT5wcm9jZXNzb3IgPT0gbmV3X2NwdSApCisgICAgaWYgKCBzY2hlZF91bml0X2NwdSh1bml0
KSA9PSBuZXdfY3B1ICkKICAgICAgICAgcmV0dXJuOwogCiAgICAgaWYgKCB1bmxpa2VseSh0Yl9p
bml0X2RvbmUpICkKICAgICB7CiAgICAgICAgIHN0cnVjdCB7Ci0gICAgICAgICAgICB1aW50MTZf
dCB2Y3B1LCBkb207CisgICAgICAgICAgICB1aW50MTZfdCB1bml0LCBkb207CiAgICAgICAgICAg
ICB1aW50MTZfdCBjcHUsIG5ld19jcHU7CiAgICAgICAgIH0gZDsKLSAgICAgICAgZC5kb20gPSB2
LT5kb21haW4tPmRvbWFpbl9pZDsKLSAgICAgICAgZC52Y3B1ID0gdi0+dmNwdV9pZDsKLSAgICAg
ICAgZC5jcHUgPSB2LT5wcm9jZXNzb3I7CisgICAgICAgIGQuZG9tID0gdW5pdC0+ZG9tYWluLT5k
b21haW5faWQ7CisgICAgICAgIGQudW5pdCA9IHVuaXQtPnVuaXRfaWQ7CisgICAgICAgIGQuY3B1
ID0gc2NoZWRfdW5pdF9jcHUodW5pdCk7CiAgICAgICAgIGQubmV3X2NwdSA9IG5ld19jcHU7CiAg
ICAgICAgIF9fdHJhY2VfdmFyKFRSQ19TTlVMTF9NSUdSQVRFLCAxLCBzaXplb2YoZCksICZkKTsK
ICAgICB9CiAKICAgICAvKgotICAgICAqIHYgaXMgZWl0aGVyIGFzc2lnbmVkIHRvIGEgcENQVSwg
b3IgaW4gdGhlIHdhaXRxdWV1ZS4KKyAgICAgKiB1bml0IGlzIGVpdGhlciBhc3NpZ25lZCB0byBh
IHBDUFUsIG9yIGluIHRoZSB3YWl0cXVldWUuCiAgICAgICoKICAgICAgKiBJbiB0aGUgZm9ybWVy
IGNhc2UsIHRoZSBwQ1BVIHRvIHdoaWNoIGl0IHdhcyBhc3NpZ25lZCB3b3VsZAogICAgICAqIGJl
Y29tZSBmcmVlLCBhbmQgd2UsIHRoZXJlZm9yZSwgc2hvdWxkIGNoZWNrIHdoZXRoZXIgdGhlcmUg
aXMKQEAgLTYyNSw3ICs2MTcsNyBAQCBzdGF0aWMgdm9pZCBudWxsX3VuaXRfbWlncmF0ZShjb25z
dCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsCiAgICAgICovCiAgICAgaWYgKCBsaWtlbHkobGlzdF9l
bXB0eSgmbnZjLT53YWl0cV9lbGVtKSkgKQogICAgIHsKLSAgICAgICAgX3ZjcHVfcmVtb3ZlKHBy
diwgdik7CisgICAgICAgIF91bml0X3JlbW92ZShwcnYsIHVuaXQpOwogICAgICAgICBTQ0hFRF9T
VEFUX0NSQU5LKG1pZ3JhdGVfcnVubmluZyk7CiAgICAgfQogICAgIGVsc2UKQEAgLTYzNCwzMiAr
NjI2LDM0IEBAIHN0YXRpYyB2b2lkIG51bGxfdW5pdF9taWdyYXRlKGNvbnN0IHN0cnVjdCBzY2hl
ZHVsZXIgKm9wcywKICAgICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3JhdGVkKTsKIAogICAgIC8qCi0g
ICAgICogTGV0J3Mgbm93IGNvbnNpZGVyIG5ld19jcHUsIHdoaWNoIGlzIHdoZXJlIHYgaXMgYmVp
bmcgc2VudC4gSXQgY2FuIGJlCi0gICAgICogZWl0aGVyIGZyZWUsIG9yIGhhdmUgYSB2Q1BVIGFs
cmVhZHkgYXNzaWduZWQgdG8gaXQuCisgICAgICogTGV0J3Mgbm93IGNvbnNpZGVyIG5ld19jcHUs
IHdoaWNoIGlzIHdoZXJlIHVuaXQgaXMgYmVpbmcgc2VudC4gSXQgY2FuIGJlCisgICAgICogZWl0
aGVyIGZyZWUsIG9yIGhhdmUgYSB1bml0IGFscmVhZHkgYXNzaWduZWQgdG8gaXQuCiAgICAgICoK
LSAgICAgKiBJbiB0aGUgZm9ybWVyIGNhc2UsIHdlIHNob3VsZCBhc3NpZ24gdiB0byBpdCwgYW5k
IHRyeSB0byBnZXQgaXQgdG8gcnVuLAorICAgICAqIEluIHRoZSBmb3JtZXIgY2FzZSB3ZSBzaG91
bGQgYXNzaWduIHVuaXQgdG8gaXQsIGFuZCB0cnkgdG8gZ2V0IGl0IHRvIHJ1biwKICAgICAgKiBp
ZiBwb3NzaWJsZSwgYWNjb3JkaW5nIHRvIGFmZmluaXR5LgogICAgICAqCi0gICAgICogSW4gbGF0
dGVyLCBhbGwgd2UgY2FuIGRvIGlzIHRvIHBhcmsgdiBpbiB0aGUgd2FpdHF1ZXVlLgorICAgICAq
IEluIGxhdHRlciwgYWxsIHdlIGNhbiBkbyBpcyB0byBwYXJrIHVuaXQgaW4gdGhlIHdhaXRxdWV1
ZS4KICAgICAgKi8KLSAgICBpZiAoIHBlcl9jcHUobnBjLCBuZXdfY3B1KS52Y3B1ID09IE5VTEwg
JiYKLSAgICAgICAgIHZjcHVfY2hlY2tfYWZmaW5pdHkodiwgbmV3X2NwdSwgQkFMQU5DRV9IQVJE
X0FGRklOSVRZKSApCisgICAgaWYgKCBwZXJfY3B1KG5wYywgbmV3X2NwdSkudW5pdCA9PSBOVUxM
ICYmCisgICAgICAgICB1bml0X2NoZWNrX2FmZmluaXR5KHVuaXQsIG5ld19jcHUsIEJBTEFOQ0Vf
SEFSRF9BRkZJTklUWSkgKQogICAgIHsKLSAgICAgICAgLyogdiBtaWdodCBoYXZlIGJlZW4gaW4g
dGhlIHdhaXRxdWV1ZSwgc28gcmVtb3ZlIGl0ICovCisgICAgICAgIC8qIHVuaXQgbWlnaHQgaGF2
ZSBiZWVuIGluIHRoZSB3YWl0cXVldWUsIHNvIHJlbW92ZSBpdCAqLwogICAgICAgICBzcGluX2xv
Y2soJnBydi0+d2FpdHFfbG9jayk7CiAgICAgICAgIGxpc3RfZGVsX2luaXQoJm52Yy0+d2FpdHFf
ZWxlbSk7CiAgICAgICAgIHNwaW5fdW5sb2NrKCZwcnYtPndhaXRxX2xvY2spOwogCi0gICAgICAg
IHZjcHVfYXNzaWduKHBydiwgdiwgbmV3X2NwdSk7CisgICAgICAgIHVuaXRfYXNzaWduKHBydiwg
dW5pdCwgbmV3X2NwdSk7CiAgICAgfQogICAgIGVsc2UKICAgICB7Ci0gICAgICAgIC8qIFB1dCB2
IGluIHRoZSB3YWl0cXVldWUsIGlmIGl0IHdhc24ndCB0aGVyZSBhbHJlYWR5ICovCisgICAgICAg
IC8qIFB1dCB1bml0IGluIHRoZSB3YWl0cXVldWUsIGlmIGl0IHdhc24ndCB0aGVyZSBhbHJlYWR5
ICovCiAgICAgICAgIHNwaW5fbG9jaygmcHJ2LT53YWl0cV9sb2NrKTsKICAgICAgICAgaWYgKCBs
aXN0X2VtcHR5KCZudmMtPndhaXRxX2VsZW0pICkKICAgICAgICAgewogICAgICAgICAgICAgbGlz
dF9hZGRfdGFpbCgmbnZjLT53YWl0cV9lbGVtLCAmcHJ2LT53YWl0cSk7Ci0gICAgICAgICAgICBk
cHJpbnRrKFhFTkxPR19HX1dBUk5JTkcsICJXQVJOSU5HOiAlcHYgbm90IGFzc2lnbmVkIHRvIGFu
eSBDUFUhXG4iLCB2KTsKKyAgICAgICAgICAgIGRwcmludGsoWEVOTE9HX0dfV0FSTklORywKKyAg
ICAgICAgICAgICAgICAgICAgIldBUk5JTkc6ICVwZHYlZCBub3QgYXNzaWduZWQgdG8gYW55IENQ
VSFcbiIsIHVuaXQtPmRvbWFpbiwKKyAgICAgICAgICAgICAgICAgICAgdW5pdC0+dW5pdF9pZCk7
CiAgICAgICAgIH0KICAgICAgICAgc3Bpbl91bmxvY2soJnBydi0+d2FpdHFfbG9jayk7CiAgICAg
fQpAQCAtNjcyLDM1ICs2NjYsMzQgQEAgc3RhdGljIHZvaWQgbnVsbF91bml0X21pZ3JhdGUoY29u
c3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAgICAqIGF0IGxlYXN0LiBJbiBjYXNlIG9mIHN1
c3BlbmQsIGFueSB0ZW1wb3JhcnkgaW5jb25zaXN0ZW5jeSBjYXVzZWQKICAgICAgKiBieSB0aGlz
LCB3aWxsIGJlIGZpeGVkLXVwIGR1cmluZyByZXN1bWUuCiAgICAgICovCi0gICAgdi0+cHJvY2Vz
c29yID0gbmV3X2NwdTsKLSAgICB1bml0LT5yZXMgPSBnZXRfc2NoZWRfcmVzKG5ld19jcHUpOwor
ICAgIHNjaGVkX3NldF9yZXModW5pdCwgZ2V0X3NjaGVkX3JlcyhuZXdfY3B1KSk7CiB9CiAKICNp
Zm5kZWYgTkRFQlVHCi1zdGF0aWMgaW5saW5lIHZvaWQgbnVsbF92Y3B1X2NoZWNrKHN0cnVjdCB2
Y3B1ICp2KQorc3RhdGljIGlubGluZSB2b2lkIG51bGxfdW5pdF9jaGVjayhzdHJ1Y3Qgc2NoZWRf
dW5pdCAqdW5pdCkKIHsKLSAgICBzdHJ1Y3QgbnVsbF91bml0ICogY29uc3QgbnZjID0gbnVsbF91
bml0KHYtPnNjaGVkX3VuaXQpOwotICAgIHN0cnVjdCBudWxsX2RvbSAqIGNvbnN0IG5kb20gPSB2
LT5kb21haW4tPnNjaGVkX3ByaXY7CisgICAgc3RydWN0IG51bGxfdW5pdCAqIGNvbnN0IG52YyA9
IG51bGxfdW5pdCh1bml0KTsKKyAgICBzdHJ1Y3QgbnVsbF9kb20gKiBjb25zdCBuZG9tID0gdW5p
dC0+ZG9tYWluLT5zY2hlZF9wcml2OwogCi0gICAgQlVHX09OKG52Yy0+dmNwdSAhPSB2KTsKKyAg
ICBCVUdfT04obnZjLT51bml0ICE9IHVuaXQpOwogCiAgICAgaWYgKCBuZG9tICkKLSAgICAgICAg
QlVHX09OKGlzX2lkbGVfdmNwdSh2KSk7CisgICAgICAgIEJVR19PTihpc19pZGxlX3VuaXQodW5p
dCkpOwogICAgIGVsc2UKLSAgICAgICAgQlVHX09OKCFpc19pZGxlX3ZjcHUodikpOworICAgICAg
ICBCVUdfT04oIWlzX2lkbGVfdW5pdCh1bml0KSk7CiAKICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVu
aXRfY2hlY2spOwogfQotI2RlZmluZSBOVUxMX1ZDUFVfQ0hFQ0sodikgIChudWxsX3ZjcHVfY2hl
Y2sodikpCisjZGVmaW5lIE5VTExfVU5JVF9DSEVDSyh1bml0KSAgKG51bGxfdW5pdF9jaGVjayh1
bml0KSkKICNlbHNlCi0jZGVmaW5lIE5VTExfVkNQVV9DSEVDSyh2KQorI2RlZmluZSBOVUxMX1VO
SVRfQ0hFQ0sodW5pdCkKICNlbmRpZgogCiAKIC8qCiAgKiBUaGUgbW9zdCBzaW1wbGUgc2NoZWR1
bGluZyBmdW5jdGlvbiBvZiBhbGwgdGltZXMhIFdlIGVpdGhlciByZXR1cm46Ci0gKiAgLSB0aGUg
dkNQVSBhc3NpZ25lZCB0byB0aGUgcENQVSwgaWYgdGhlcmUncyBvbmUgYW5kIGl0IGNhbiBydW47
Ci0gKiAgLSB0aGUgaWRsZSB2Q1BVLCBvdGhlcndpc2UuCisgKiAgLSB0aGUgdW5pdCBhc3NpZ25l
ZCB0byB0aGUgcENQVSwgaWYgdGhlcmUncyBvbmUgYW5kIGl0IGNhbiBydW47CisgKiAgLSB0aGUg
aWRsZSB1bml0LCBvdGhlcndpc2UuCiAgKi8KIHN0YXRpYyBzdHJ1Y3QgdGFza19zbGljZSBudWxs
X3NjaGVkdWxlKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHNfdGltZV90IG5vdywKQEAgLTcxMywyNCArNzA2LDI0IEBA
IHN0YXRpYyBzdHJ1Y3QgdGFza19zbGljZSBudWxsX3NjaGVkdWxlKGNvbnN0IHN0cnVjdCBzY2hl
ZHVsZXIgKm9wcywKICAgICBzdHJ1Y3QgdGFza19zbGljZSByZXQ7CiAKICAgICBTQ0hFRF9TVEFU
X0NSQU5LKHNjaGVkdWxlKTsKLSAgICBOVUxMX1ZDUFVfQ0hFQ0soY3VycmVudCk7CisgICAgTlVM
TF9VTklUX0NIRUNLKGN1cnJlbnQtPnNjaGVkX3VuaXQpOwogCiAgICAgaWYgKCB1bmxpa2VseSh0
Yl9pbml0X2RvbmUpICkKICAgICB7CiAgICAgICAgIHN0cnVjdCB7CiAgICAgICAgICAgICB1aW50
MTZfdCB0YXNrbGV0LCBjcHU7Ci0gICAgICAgICAgICBpbnQxNl90IHZjcHUsIGRvbTsKKyAgICAg
ICAgICAgIGludDE2X3QgdW5pdCwgZG9tOwogICAgICAgICB9IGQ7CiAgICAgICAgIGQuY3B1ID0g
Y3B1OwogICAgICAgICBkLnRhc2tsZXQgPSB0YXNrbGV0X3dvcmtfc2NoZWR1bGVkOwotICAgICAg
ICBpZiAoIHBlcl9jcHUobnBjLCBjcHUpLnZjcHUgPT0gTlVMTCApCisgICAgICAgIGlmICggcGVy
X2NwdShucGMsIGNwdSkudW5pdCA9PSBOVUxMICkKICAgICAgICAgewotICAgICAgICAgICAgZC52
Y3B1ID0gZC5kb20gPSAtMTsKKyAgICAgICAgICAgIGQudW5pdCA9IGQuZG9tID0gLTE7CiAgICAg
ICAgIH0KICAgICAgICAgZWxzZQogICAgICAgICB7Ci0gICAgICAgICAgICBkLnZjcHUgPSBwZXJf
Y3B1KG5wYywgY3B1KS52Y3B1LT52Y3B1X2lkOwotICAgICAgICAgICAgZC5kb20gPSBwZXJfY3B1
KG5wYywgY3B1KS52Y3B1LT5kb21haW4tPmRvbWFpbl9pZDsKKyAgICAgICAgICAgIGQudW5pdCA9
IHBlcl9jcHUobnBjLCBjcHUpLnVuaXQtPnVuaXRfaWQ7CisgICAgICAgICAgICBkLmRvbSA9IHBl
cl9jcHUobnBjLCBjcHUpLnVuaXQtPmRvbWFpbi0+ZG9tYWluX2lkOwogICAgICAgICB9CiAgICAg
ICAgIF9fdHJhY2VfdmFyKFRSQ19TTlVMTF9TQ0hFRFVMRSwgMSwgc2l6ZW9mKGQpLCAmZCk7CiAg
ICAgfQpAQCAtNzM4LDE2ICs3MzEsMTYgQEAgc3RhdGljIHN0cnVjdCB0YXNrX3NsaWNlIG51bGxf
c2NoZWR1bGUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLAogICAgIGlmICggdGFza2xldF93
b3JrX3NjaGVkdWxlZCApCiAgICAgewogICAgICAgICB0cmFjZV92YXIoVFJDX1NOVUxMX1RBU0tM
RVQsIDEsIDAsIE5VTEwpOwotICAgICAgICByZXQudGFzayA9IGlkbGVfdmNwdVtjcHVdLT5zY2hl
ZF91bml0OworICAgICAgICByZXQudGFzayA9IHNjaGVkX2lkbGVfdW5pdChjcHUpOwogICAgIH0K
ICAgICBlbHNlCi0gICAgICAgIHJldC50YXNrID0gcGVyX2NwdShucGMsIGNwdSkudmNwdS0+c2No
ZWRfdW5pdDsKKyAgICAgICAgcmV0LnRhc2sgPSBwZXJfY3B1KG5wYywgY3B1KS51bml0OwogICAg
IHJldC5taWdyYXRlZCA9IDA7CiAgICAgcmV0LnRpbWUgPSAtMTsKIAogICAgIC8qCiAgICAgICog
V2UgbWF5IGJlIG5ldyBpbiB0aGUgY3B1cG9vbCwgb3IganVzdCBjb21pbmcgYmFjayBvbmxpbmUu
IEluIHdoaWNoCi0gICAgICogY2FzZSwgdGhlcmUgbWF5IGJlIHZDUFVzIGluIHRoZSB3YWl0cXVl
dWUgdGhhdCB3ZSBjYW4gYXNzaWduIHRvIHVzCisgICAgICogY2FzZSwgdGhlcmUgbWF5IGJlIHVu
aXRzIGluIHRoZSB3YWl0cXVldWUgdGhhdCB3ZSBjYW4gYXNzaWduIHRvIHVzCiAgICAgICogYW5k
IHJ1bi4KICAgICAgKi8KICAgICBpZiAoIHVubGlrZWx5KHJldC50YXNrID09IE5VTEwpICkKQEAg
LTc1OCwxMCArNzUxLDEwIEBAIHN0YXRpYyBzdHJ1Y3QgdGFza19zbGljZSBudWxsX3NjaGVkdWxl
KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAgICAgICAgICAgIGdvdG8gdW5sb2NrOwog
CiAgICAgICAgIC8qCi0gICAgICAgICAqIFdlIHNjYW4gdGhlIHdhaXRxdWV1ZSB0d2ljZSwgZm9y
IHByaW9yaXRpemluZyB2Y3B1cyB0aGF0IGhhdmUKKyAgICAgICAgICogV2Ugc2NhbiB0aGUgd2Fp
dHF1ZXVlIHR3aWNlLCBmb3IgcHJpb3JpdGl6aW5nIHVuaXRzIHRoYXQgaGF2ZQogICAgICAgICAg
KiBzb2Z0LWFmZmluaXR5IHdpdGggY3B1LiBUaGlzIG1heSBsb29rIGxpa2Ugc29tZXRoaW5nIGV4
cGVuc2l2ZSB0bwotICAgICAgICAgKiBkbyBoZXJlIGluIG51bGxfc2NoZWR1bGUoKSwgYnV0IGl0
J3MgYWN0dWFsbHkgZmluZSwgYmVjZXVzZSB3ZSBkbwotICAgICAgICAgKiBpdCBvbmx5IGluIGNh
c2VzIHdoZXJlIGEgcGNwdSBoYXMgbm8gdmNwdSBhc3NvY2lhdGVkIChlLmcuLCBhcworICAgICAg
ICAgKiBkbyBoZXJlIGluIG51bGxfc2NoZWR1bGUoKSwgYnV0IGl0J3MgYWN0dWFsbHkgZmluZSwg
YmVjYXVzZSB3ZSBkbworICAgICAgICAgKiBpdCBvbmx5IGluIGNhc2VzIHdoZXJlIGEgcGNwdSBo
YXMgbm8gdW5pdCBhc3NvY2lhdGVkIChlLmcuLCBhcwogICAgICAgICAgKiBzYWlkIGFib3ZlLCB0
aGUgY3B1IGhhcyBqdXN0IGpvaW5lZCBhIGNwdXBvb2wpLgogICAgICAgICAgKi8KICAgICAgICAg
Zm9yX2VhY2hfYWZmaW5pdHlfYmFsYW5jZV9zdGVwKCBicyApCkBAIC03NjksMTQgKzc2MiwxNCBA
QCBzdGF0aWMgc3RydWN0IHRhc2tfc2xpY2UgbnVsbF9zY2hlZHVsZShjb25zdCBzdHJ1Y3Qgc2No
ZWR1bGVyICpvcHMsCiAgICAgICAgICAgICBsaXN0X2Zvcl9lYWNoX2VudHJ5KCB3dmMsICZwcnYt
PndhaXRxLCB3YWl0cV9lbGVtICkKICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICBpZiAo
IGJzID09IEJBTEFOQ0VfU09GVF9BRkZJTklUWSAmJgotICAgICAgICAgICAgICAgICAgICAgIWhh
c19zb2Z0X2FmZmluaXR5KHd2Yy0+dmNwdS0+c2NoZWRfdW5pdCkgKQorICAgICAgICAgICAgICAg
ICAgICAgIWhhc19zb2Z0X2FmZmluaXR5KHd2Yy0+dW5pdCkgKQogICAgICAgICAgICAgICAgICAg
ICBjb250aW51ZTsKIAotICAgICAgICAgICAgICAgIGlmICggdmNwdV9jaGVja19hZmZpbml0eSh3
dmMtPnZjcHUsIGNwdSwgYnMpICkKKyAgICAgICAgICAgICAgICBpZiAoIHVuaXRfY2hlY2tfYWZm
aW5pdHkod3ZjLT51bml0LCBjcHUsIGJzKSApCiAgICAgICAgICAgICAgICAgewotICAgICAgICAg
ICAgICAgICAgICB2Y3B1X2Fzc2lnbihwcnYsIHd2Yy0+dmNwdSwgY3B1KTsKKyAgICAgICAgICAg
ICAgICAgICAgdW5pdF9hc3NpZ24ocHJ2LCB3dmMtPnVuaXQsIGNwdSk7CiAgICAgICAgICAgICAg
ICAgICAgIGxpc3RfZGVsX2luaXQoJnd2Yy0+d2FpdHFfZWxlbSk7Ci0gICAgICAgICAgICAgICAg
ICAgIHJldC50YXNrID0gd3ZjLT52Y3B1LT5zY2hlZF91bml0OworICAgICAgICAgICAgICAgICAg
ICByZXQudGFzayA9IHd2Yy0+dW5pdDsKICAgICAgICAgICAgICAgICAgICAgZ290byB1bmxvY2s7
CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQpAQCAtNzg2LDE3ICs3NzksMTcgQEAg
c3RhdGljIHN0cnVjdCB0YXNrX3NsaWNlIG51bGxfc2NoZWR1bGUoY29uc3Qgc3RydWN0IHNjaGVk
dWxlciAqb3BzLAogICAgIH0KIAogICAgIGlmICggdW5saWtlbHkocmV0LnRhc2sgPT0gTlVMTCB8
fCAhdW5pdF9ydW5uYWJsZShyZXQudGFzaykpICkKLSAgICAgICAgcmV0LnRhc2sgPSBpZGxlX3Zj
cHVbY3B1XS0+c2NoZWRfdW5pdDsKKyAgICAgICAgcmV0LnRhc2sgPSBzY2hlZF9pZGxlX3VuaXQo
Y3B1KTsKIAotICAgIE5VTExfVkNQVV9DSEVDSyhyZXQudGFzay0+dmNwdSk7CisgICAgTlVMTF9V
TklUX0NIRUNLKHJldC50YXNrKTsKICAgICByZXR1cm4gcmV0OwogfQogCi1zdGF0aWMgaW5saW5l
IHZvaWQgZHVtcF92Y3B1KHN0cnVjdCBudWxsX3ByaXZhdGUgKnBydiwgc3RydWN0IG51bGxfdW5p
dCAqbnZjKQorc3RhdGljIGlubGluZSB2b2lkIGR1bXBfdW5pdChzdHJ1Y3QgbnVsbF9wcml2YXRl
ICpwcnYsIHN0cnVjdCBudWxsX3VuaXQgKm52YykKIHsKLSAgICBwcmludGsoIlslaS4laV0gcGNw
dT0lZCIsIG52Yy0+dmNwdS0+ZG9tYWluLT5kb21haW5faWQsCi0gICAgICAgICAgICBudmMtPnZj
cHUtPnZjcHVfaWQsIGxpc3RfZW1wdHkoJm52Yy0+d2FpdHFfZWxlbSkgPwotICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBudmMtPnZjcHUtPnByb2Nlc3NvciA6IC0xKTsKKyAgICBwcmlu
dGsoIlslaS4laV0gcGNwdT0lZCIsIG52Yy0+dW5pdC0+ZG9tYWluLT5kb21haW5faWQsCisgICAg
ICAgICAgICBudmMtPnVuaXQtPnVuaXRfaWQsIGxpc3RfZW1wdHkoJm52Yy0+d2FpdHFfZWxlbSkg
PworICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2hlZF91bml0X2NwdShudmMtPnVu
aXQpIDogLTEpOwogfQogCiBzdGF0aWMgdm9pZCBudWxsX2R1bXBfcGNwdShjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpvcHMsIGludCBjcHUpCkBAIC04MTIsMTYgKzgwNSwxNyBAQCBzdGF0aWMgdm9p
ZCBudWxsX2R1bXBfcGNwdShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIGludCBjcHUpCiAg
ICAgICAgICAgIGNwdSwKICAgICAgICAgICAgbnJfY3B1X2lkcywgY3B1bWFza19iaXRzKHBlcl9j
cHUoY3B1X3NpYmxpbmdfbWFzaywgY3B1KSksCiAgICAgICAgICAgIG5yX2NwdV9pZHMsIGNwdW1h
c2tfYml0cyhwZXJfY3B1KGNwdV9jb3JlX21hc2ssIGNwdSkpKTsKLSAgICBpZiAoIHBlcl9jcHUo
bnBjLCBjcHUpLnZjcHUgIT0gTlVMTCApCi0gICAgICAgIHByaW50aygiLCB2Y3B1PSVwdiIsIHBl
cl9jcHUobnBjLCBjcHUpLnZjcHUpOworICAgIGlmICggcGVyX2NwdShucGMsIGNwdSkudW5pdCAh
PSBOVUxMICkKKyAgICAgICAgcHJpbnRrKCIsIHVuaXQ9JXBkdiVkIiwgcGVyX2NwdShucGMsIGNw
dSkudW5pdC0+ZG9tYWluLAorICAgICAgICAgICAgICAgcGVyX2NwdShucGMsIGNwdSkudW5pdC0+
dW5pdF9pZCk7CiAgICAgcHJpbnRrKCJcbiIpOwogCi0gICAgLyogY3VycmVudCBWQ1BVIChub3Ro
aW5nIHRvIHNheSBpZiB0aGF0J3MgdGhlIGlkbGUgdmNwdSkgKi8KKyAgICAvKiBjdXJyZW50IHVu
aXQgKG5vdGhpbmcgdG8gc2F5IGlmIHRoYXQncyB0aGUgaWRsZSB1bml0KSAqLwogICAgIG52YyA9
IG51bGxfdW5pdChjdXJyX29uX2NwdShjcHUpKTsKLSAgICBpZiAoIG52YyAmJiAhaXNfaWRsZV92
Y3B1KG52Yy0+dmNwdSkgKQorICAgIGlmICggbnZjICYmICFpc19pZGxlX3VuaXQobnZjLT51bml0
KSApCiAgICAgewogICAgICAgICBwcmludGsoIlx0cnVuOiAiKTsKLSAgICAgICAgZHVtcF92Y3B1
KHBydiwgbnZjKTsKKyAgICAgICAgZHVtcF91bml0KHBydiwgbnZjKTsKICAgICAgICAgcHJpbnRr
KCJcbiIpOwogICAgIH0KIApAQCAtODQ0LDIzICs4MzgsMjMgQEAgc3RhdGljIHZvaWQgbnVsbF9k
dW1wKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcykKICAgICBsaXN0X2Zvcl9lYWNoKCBpdGVy
LCAmcHJ2LT5uZG9tICkKICAgICB7CiAgICAgICAgIHN0cnVjdCBudWxsX2RvbSAqbmRvbTsKLSAg
ICAgICAgc3RydWN0IHZjcHUgKnY7CisgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0Owog
CiAgICAgICAgIG5kb20gPSBsaXN0X2VudHJ5KGl0ZXIsIHN0cnVjdCBudWxsX2RvbSwgbmRvbV9l
bGVtKTsKIAogICAgICAgICBwcmludGsoIlx0RG9tYWluOiAlZFxuIiwgbmRvbS0+ZG9tLT5kb21h
aW5faWQpOwotICAgICAgICBmb3JfZWFjaF92Y3B1KCBuZG9tLT5kb20sIHYgKQorICAgICAgICBm
b3JfZWFjaF9zY2hlZF91bml0KCBuZG9tLT5kb20sIHVuaXQgKQogICAgICAgICB7Ci0gICAgICAg
ICAgICBzdHJ1Y3QgbnVsbF91bml0ICogY29uc3QgbnZjID0gbnVsbF91bml0KHYtPnNjaGVkX3Vu
aXQpOworICAgICAgICAgICAgc3RydWN0IG51bGxfdW5pdCAqIGNvbnN0IG52YyA9IG51bGxfdW5p
dCh1bml0KTsKICAgICAgICAgICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAKLSAgICAgICAgICAgIGxv
Y2sgPSB1bml0X3NjaGVkdWxlX2xvY2sobnZjLT52Y3B1LT5zY2hlZF91bml0KTsKKyAgICAgICAg
ICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2sodW5pdCk7CiAKICAgICAgICAgICAgIHByaW50
aygiXHQlM2Q6ICIsICsrbG9vcCk7Ci0gICAgICAgICAgICBkdW1wX3ZjcHUocHJ2LCBudmMpOwor
ICAgICAgICAgICAgZHVtcF91bml0KHBydiwgbnZjKTsKICAgICAgICAgICAgIHByaW50aygiXG4i
KTsKIAotICAgICAgICAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2sobG9jaywgbnZjLT52Y3B1LT5z
Y2hlZF91bml0KTsKKyAgICAgICAgICAgIHVuaXRfc2NoZWR1bGVfdW5sb2NrKGxvY2ssIHVuaXQp
OwogICAgICAgICB9CiAgICAgfQogCkBAIC04NzUsNyArODY5LDcgQEAgc3RhdGljIHZvaWQgbnVs
bF9kdW1wKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcykKICAgICAgICAgICAgIHByaW50aygi
LCAiKTsKICAgICAgICAgaWYgKCBsb29wICUgMjQgPT0gMCApCiAgICAgICAgICAgICBwcmludGso
IlxuXHQiKTsKLSAgICAgICAgcHJpbnRrKCIlcHYiLCBudmMtPnZjcHUpOworICAgICAgICBwcmlu
dGsoIiVwZHYlZCIsIG52Yy0+dW5pdC0+ZG9tYWluLCBudmMtPnVuaXQtPnVuaXRfaWQpOwogICAg
IH0KICAgICBwcmludGsoIlxuIik7CiAgICAgc3Bpbl91bmxvY2soJnBydi0+d2FpdHFfbG9jayk7
Ci0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9y
ZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

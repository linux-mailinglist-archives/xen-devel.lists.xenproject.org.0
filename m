Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id B1ED81736F0
	for <lists+xen-devel@lfdr.de>; Fri, 28 Feb 2020 13:13:41 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1j7eUn-0007cz-Rt; Fri, 28 Feb 2020 12:11:57 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=F9pE=4Q=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1j7eUm-0007cr-Ol
 for xen-devel@lists.xenproject.org; Fri, 28 Feb 2020 12:11:56 +0000
X-Inumbo-ID: 8233ecc6-5a23-11ea-9911-12813bfff9fa
Received: from mx2.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 8233ecc6-5a23-11ea-9911-12813bfff9fa;
 Fri, 28 Feb 2020 12:11:54 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id D10F6AECE;
 Fri, 28 Feb 2020 12:11:53 +0000 (UTC)
From: Jan Beulich <jbeulich@suse.com>
To: "xen-devel@lists.xenproject.org" <xen-devel@lists.xenproject.org>
References: <2d3ced57-7d53-bb90-ccf6-e521e6eeb556@suse.com>
Message-ID: <d2833654-fc51-555e-1c38-bda283baf27f@suse.com>
Date: Fri, 28 Feb 2020 13:12:03 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:68.0) Gecko/20100101
 Thunderbird/68.5.0
MIME-Version: 1.0
In-Reply-To: <2d3ced57-7d53-bb90-ccf6-e521e6eeb556@suse.com>
Content-Language: en-US
Subject: [Xen-devel] [PATCH v2 2/2] AMD/IOMMU: without XT,
 x2APIC needs to be forced into physical mode
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Kevin Tian <kevin.tian@intel.com>, Wei Liu <wl@xen.org>,
 =?UTF-8?Q?Roger_Pau_Monn=c3=a9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VGhlIHdpZGVyIGNsdXN0ZXIgbW9kZSBBUElDIElEcyBhcmVuJ3QgZ2VuZXJhbGx5IHJlcHJlc2Vu
dGFibGUuIENvbnZlcnQKdGhlIGlvbW11X2ludHJlbWFwIHZhcmlhYmxlIGludG8gYSB0cmlzdGF0
ZSwgYWxsb3dpbmcgdGhlIEFNRCBJT01NVQpkcml2ZXIgdG8gc2lnbmFsIHRoaXMgc3BlY2lhbCBy
ZXN0cmljdGlvbiB0byB0aGUgYXBpY194MmFwaWNfcHJvYmUoKS4KKE5vdGU6IGFzc2lnbm1lbnRz
IHRvIHRoZSB2YXJpYWJsZSBnZXQgYWRqdXN0ZWQsIHdoaWxlIGV4aXN0aW5nCmNvbnN1bWVycyAt
IGFsbCBhc3N1bWluZyBhIGJvb2xlYW4gcHJvcGVydHkgLSBhcmUgbGVmdCBhbG9uZS4pCgpTaWdu
ZWQtb2ZmLWJ5OiBKYW4gQmV1bGljaCA8amJldWxpY2hAc3VzZS5jb20+Ci0tLQp2MjogTmV3LgoK
LS0tIGEveGVuL2FyY2gveDg2L2dlbmFwaWMveDJhcGljLmMKKysrIGIveGVuL2FyY2gveDg2L2dl
bmFwaWMveDJhcGljLmMKQEAgLTIzNiwxMiArMjM2LDIxIEBAIGNvbnN0IHN0cnVjdCBnZW5hcGlj
ICpfX2luaXQgYXBpY194MmFwaWMKICAgICAgICAgeDJhcGljX3BoeXMgPSAhaW9tbXVfaW50cmVt
YXAgfHwKICAgICAgICAgICAgICAgICAgICAgICAoYWNwaV9nYmxfRkFEVC5mbGFncyAmIEFDUElf
RkFEVF9BUElDX1BIWVNJQ0FMKTsKICAgICB9Ci0gICAgZWxzZSBpZiAoICF4MmFwaWNfcGh5cyAm
JiAhaW9tbXVfaW50cmVtYXAgKQotICAgIHsKLSAgICAgICAgcHJpbnRrKCJXQVJOSU5HOiB4MkFQ
SUMgY2x1c3RlciBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQgd2l0aG91dCBpbnRlcnJ1cHQgcmVtYXBw
aW5nXG4iCi0gICAgICAgICAgICAgICAieDJBUElDOiBmb3JjaW5nIHBoeXMgbW9kZVxuIik7Ci0g
ICAgICAgIHgyYXBpY19waHlzID0gdHJ1ZTsKLSAgICB9CisgICAgZWxzZSBpZiAoICF4MmFwaWNf
cGh5cyApCisgICAgICAgIHN3aXRjaCAoIGlvbW11X2ludHJlbWFwICkKKyAgICAgICAgeworICAg
ICAgICBjYXNlIGlvbW11X2ludHJlbWFwX29mZjoKKyAgICAgICAgY2FzZSBpb21tdV9pbnRyZW1h
cF9yZXN0cmljdGVkOgorICAgICAgICAgICAgcHJpbnRrKCJXQVJOSU5HOiB4MkFQSUMgY2x1c3Rl
ciBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQgJXMgaW50ZXJydXB0IHJlbWFwcGluZ1xuIgorICAgICAg
ICAgICAgICAgICAgICJ4MkFQSUM6IGZvcmNpbmcgcGh5cyBtb2RlXG4iLAorICAgICAgICAgICAg
ICAgICAgIGlvbW11X2ludHJlbWFwID09IGlvbW11X2ludHJlbWFwX29mZiA/ICJ3aXRob3V0Igor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6
ICJ3aXRoIHJlc3RyaWN0ZWQiKTsKKyAgICAgICAgICAgIHgyYXBpY19waHlzID0gdHJ1ZTsKKyAg
ICAgICAgICAgIGJyZWFrOworCisgICAgICAgIGNhc2UgaW9tbXVfaW50cmVtYXBfZnVsbDoKKyAg
ICAgICAgICAgIGJyZWFrOworICAgICAgICB9CiAKICAgICBpZiAoIHgyYXBpY19waHlzICkKICAg
ICAgICAgcmV0dXJuICZhcGljX3gyYXBpY19waHlzOwotLS0gYS94ZW4vZHJpdmVycy9wYXNzdGhy
b3VnaC9hbWQvaW9tbXVfaW5pdC5jCisrKyBiL3hlbi9kcml2ZXJzL3Bhc3N0aHJvdWdoL2FtZC9p
b21tdV9pbml0LmMKQEAgLTExMzksNyArMTEzOSw3IEBAIHN0YXRpYyB2b2lkIF9faW5pdCBhbWRf
aW9tbXVfaW5pdF9jbGVhbnUKIAogICAgIGlvbW11X2VuYWJsZWQgPSAwOwogICAgIGlvbW11X2h3
ZG9tX3Bhc3N0aHJvdWdoID0gZmFsc2U7Ci0gICAgaW9tbXVfaW50cmVtYXAgPSAwOworICAgIGlv
bW11X2ludHJlbWFwID0gaW9tbXVfaW50cmVtYXBfb2ZmOwogICAgIGlvbW11djJfZW5hYmxlZCA9
IDA7CiB9CiAKQEAgLTE0MTMsNiArMTQxMyw5IEBAIGludCBfX2luaXQgYW1kX2lvbW11X3ByZXBh
cmUoYm9vbCB4dCkKICAgICAgICAgaW9tbXUtPmN0cmwuaW50X2NhcF94dF9lbiA9IHh0ICYmIGhh
c194dDsKICAgICB9CiAKKyAgICBpZiAoIGlvbW11X2ludHJlbWFwICYmICFoYXNfeHQgKQorICAg
ICAgICBpb21tdV9pbnRyZW1hcCA9IGlvbW11X2ludHJlbWFwX3Jlc3RyaWN0ZWQ7CisKICAgICBy
YyA9IGFtZF9pb21tdV91cGRhdGVfaXZyc19tYXBwaW5nX2FjcGkoKTsKIAogIGVycm9yX291dDoK
LS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvYW1kL3BjaV9hbWRfaW9tbXUuYworKysgYi94
ZW4vZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvcGNpX2FtZF9pb21tdS5jCkBAIC0xNTcsNyArMTU3
LDcgQEAgaW50IF9faW5pdCBhY3BpX2l2cnNfaW5pdCh2b2lkKQogCiAgICAgaWYgKCAoYW1kX2lv
bW11X2RldGVjdF9hY3BpKCkgIT0wKSB8fCAoaW9tbXVfZm91bmQoKSA9PSAwKSApCiAgICAgewot
ICAgICAgICBpb21tdV9pbnRyZW1hcCA9IDA7CisgICAgICAgIGlvbW11X2ludHJlbWFwID0gaW9t
bXVfaW50cmVtYXBfb2ZmOwogICAgICAgICByZXR1cm4gLUVOT0RFVjsKICAgICB9CiAKLS0tIGEv
eGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvaW9tbXUuYworKysgYi94ZW4vZHJpdmVycy9wYXNzdGhy
b3VnaC9pb21tdS5jCkBAIC0zNSw3ICszNSw3IEBAIGJvb2wgX19yZWFkX21vc3RseSBpb21tdV9x
dWFyYW50aW5lID0gdHIKIGJvb2xfdCBfX3JlYWRfbW9zdGx5IGlvbW11X2lnZnggPSAxOwogYm9v
bF90IF9fcmVhZF9tb3N0bHkgaW9tbXVfc25vb3AgPSAxOwogYm9vbF90IF9fcmVhZF9tb3N0bHkg
aW9tbXVfcWludmFsID0gMTsKLWJvb2xfdCBfX3JlYWRfbW9zdGx5IGlvbW11X2ludHJlbWFwID0g
MTsKK2VudW0gaW9tbXVfaW50cmVtYXAgX19yZWFkX21vc3RseSBpb21tdV9pbnRyZW1hcCA9IGlv
bW11X2ludHJlbWFwX2Z1bGw7CiBib29sX3QgX19yZWFkX21vc3RseSBpb21tdV9jcmFzaF9kaXNh
YmxlOwogCiBzdGF0aWMgYm9vbCBfX2h3ZG9tX2luaXRkYXRhIGlvbW11X2h3ZG9tX25vbmU7CkBA
IC05MSw3ICs5MSw3IEBAIHN0YXRpYyBpbnQgX19pbml0IHBhcnNlX2lvbW11X3BhcmFtKGNvbnMK
ICAgICAgICAgZWxzZSBpZiAoICh2YWwgPSBwYXJzZV9ib29sZWFuKCJxaW52YWwiLCBzLCBzcykp
ID49IDAgKQogICAgICAgICAgICAgaW9tbXVfcWludmFsID0gdmFsOwogICAgICAgICBlbHNlIGlm
ICggKHZhbCA9IHBhcnNlX2Jvb2xlYW4oImludHJlbWFwIiwgcywgc3MpKSA+PSAwICkKLSAgICAg
ICAgICAgIGlvbW11X2ludHJlbWFwID0gdmFsOworICAgICAgICAgICAgaW9tbXVfaW50cmVtYXAg
PSB2YWwgPyBpb21tdV9pbnRyZW1hcF9mdWxsIDogaW9tbXVfaW50cmVtYXBfb2ZmOwogICAgICAg
ICBlbHNlIGlmICggKHZhbCA9IHBhcnNlX2Jvb2xlYW4oImludHBvc3QiLCBzLCBzcykpID49IDAg
KQogICAgICAgICAgICAgaW9tbXVfaW50cG9zdCA9IHZhbDsKICNpZmRlZiBDT05GSUdfS0VYRUMK
QEAgLTQ3NSw3ICs0NzUsNyBAQCBpbnQgX19pbml0IGlvbW11X3NldHVwKHZvaWQpCiAgICAgICAg
IGlvbW11X2VuYWJsZWQgPSAocmMgPT0gMCk7CiAgICAgfQogICAgIGlmICggIWlvbW11X2VuYWJs
ZWQgKQotICAgICAgICBpb21tdV9pbnRyZW1hcCA9IDA7CisgICAgICAgIGlvbW11X2ludHJlbWFw
ID0gaW9tbXVfaW50cmVtYXBfb2ZmOwogCiAgICAgaWYgKCAoZm9yY2VfaW9tbXUgJiYgIWlvbW11
X2VuYWJsZWQpIHx8CiAgICAgICAgICAoZm9yY2VfaW50cmVtYXAgJiYgIWlvbW11X2ludHJlbWFw
KSApCkBAIC01NTcsNyArNTU3LDggQEAgdm9pZCBpb21tdV9jcmFzaF9zaHV0ZG93bih2b2lkKQog
CiAgICAgaWYgKCBpb21tdV9lbmFibGVkICkKICAgICAgICAgaW9tbXVfZ2V0X29wcygpLT5jcmFz
aF9zaHV0ZG93bigpOwotICAgIGlvbW11X2VuYWJsZWQgPSBpb21tdV9pbnRyZW1hcCA9IGlvbW11
X2ludHBvc3QgPSAwOworICAgIGlvbW11X2VuYWJsZWQgPSBpb21tdV9pbnRwb3N0ID0gMDsKKyAg
ICBpb21tdV9pbnRyZW1hcCA9IGlvbW11X2ludHJlbWFwX29mZjsKIH0KIAogaW50IGlvbW11X2dl
dF9yZXNlcnZlZF9kZXZpY2VfbWVtb3J5KGlvbW11X2dyZG1fdCAqZnVuYywgdm9pZCAqY3R4dCkK
LS0tIGEveGVuL2RyaXZlcnMvcGFzc3Rocm91Z2gvdnRkL2lvbW11LmMKKysrIGIveGVuL2RyaXZl
cnMvcGFzc3Rocm91Z2gvdnRkL2lvbW11LmMKQEAgLTIxNzcsNyArMjE3Nyw3IEBAIHN0YXRpYyBp
bnQgX19tdXN0X2NoZWNrIGluaXRfdnRkX2h3KHZvaWQKICAgICAgICAgewogICAgICAgICAgICAg
aWYgKCBpb2FwaWNfdG9faW9tbXUoSU9fQVBJQ19JRChhcGljKSkgPT0gTlVMTCApCiAgICAgICAg
ICAgICB7Ci0gICAgICAgICAgICAgICAgaW9tbXVfaW50cmVtYXAgPSAwOworICAgICAgICAgICAg
ICAgIGlvbW11X2ludHJlbWFwID0gaW9tbXVfaW50cmVtYXBfb2ZmOwogICAgICAgICAgICAgICAg
IGRwcmludGsoWEVOTE9HX0VSUiBWVERQUkVGSVgsCiAgICAgICAgICAgICAgICAgICAgICJpb2Fw
aWNfdG9faW9tbXU6IGlvYXBpYyAlI3ggKGlkOiAlI3gpIGlzIE5VTEwhICIKICAgICAgICAgICAg
ICAgICAgICAgIldpbGwgbm90IHRyeSB0byBlbmFibGUgSW50ZXJydXB0IFJlbWFwcGluZy5cbiIs
CkBAIC0yMTkzLDcgKzIxOTMsNyBAQCBzdGF0aWMgaW50IF9fbXVzdF9jaGVjayBpbml0X3Z0ZF9o
dyh2b2lkCiAgICAgICAgICAgICBpb21tdSA9IGRyaGQtPmlvbW11OwogICAgICAgICAgICAgaWYg
KCBlbmFibGVfaW50cmVtYXAoaW9tbXUsIDApICE9IDAgKQogICAgICAgICAgICAgewotICAgICAg
ICAgICAgICAgIGlvbW11X2ludHJlbWFwID0gMDsKKyAgICAgICAgICAgICAgICBpb21tdV9pbnRy
ZW1hcCA9IGlvbW11X2ludHJlbWFwX29mZjsKICAgICAgICAgICAgICAgICBkcHJpbnRrKFhFTkxP
R19XQVJOSU5HIFZURFBSRUZJWCwKICAgICAgICAgICAgICAgICAgICAgICAgICJJbnRlcnJ1cHQg
UmVtYXBwaW5nIG5vdCBlbmFibGVkXG4iKTsKIApAQCAtMjI5NSw3ICsyMjk1LDcgQEAgc3RhdGlj
IGludCBfX2luaXQgdnRkX3NldHVwKHZvaWQpCiAgICAgICAgICAgICBpb21tdV9xaW52YWwgPSAw
OwogCiAgICAgICAgIGlmICggaW9tbXVfaW50cmVtYXAgJiYgIWVjYXBfaW50cl9yZW1hcChpb21t
dS0+ZWNhcCkgKQotICAgICAgICAgICAgaW9tbXVfaW50cmVtYXAgPSAwOworICAgICAgICAgICAg
aW9tbXVfaW50cmVtYXAgPSBpb21tdV9pbnRyZW1hcF9vZmY7CiAKICAgICAgICAgLyoKICAgICAg
ICAgICogV2UgY2Fubm90IHVzZSBwb3N0ZWQgaW50ZXJydXB0IGlmIFg4Nl9GRUFUVVJFX0NYMTYg
aXMKQEAgLTIzMjAsNyArMjMyMCw3IEBAIHN0YXRpYyBpbnQgX19pbml0IHZ0ZF9zZXR1cCh2b2lk
KQogCiAgICAgaWYgKCAhaW9tbXVfcWludmFsICYmIGlvbW11X2ludHJlbWFwICkKICAgICB7Ci0g
ICAgICAgIGlvbW11X2ludHJlbWFwID0gMDsKKyAgICAgICAgaW9tbXVfaW50cmVtYXAgPSBpb21t
dV9pbnRyZW1hcF9vZmY7CiAgICAgICAgIGRwcmludGsoWEVOTE9HX1dBUk5JTkcgVlREUFJFRklY
LCAiSW50ZXJydXB0IFJlbWFwcGluZyBkaXNhYmxlZCAiCiAgICAgICAgICAgICAic2luY2UgUXVl
dWVkIEludmFsaWRhdGlvbiBpc24ndCBzdXBwb3J0ZWQgb3IgZW5hYmxlZC5cbiIpOwogICAgIH0K
QEAgLTIzNDcsNyArMjM0Nyw3IEBAIHN0YXRpYyBpbnQgX19pbml0IHZ0ZF9zZXR1cCh2b2lkKQog
ICAgIGlvbW11X3Nub29wID0gMDsKICAgICBpb21tdV9od2RvbV9wYXNzdGhyb3VnaCA9IGZhbHNl
OwogICAgIGlvbW11X3FpbnZhbCA9IDA7Ci0gICAgaW9tbXVfaW50cmVtYXAgPSAwOworICAgIGlv
bW11X2ludHJlbWFwID0gaW9tbXVfaW50cmVtYXBfb2ZmOwogICAgIGlvbW11X2ludHBvc3QgPSAw
OwogICAgIHJldHVybiByZXQ7CiB9Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9pb21tdS5oCisrKyBi
L3hlbi9pbmNsdWRlL3hlbi9pb21tdS5oCkBAIC01NCw3ICs1NCwxOCBAQCBzdGF0aWMgaW5saW5l
IGJvb2xfdCBkZm5fZXEoZGZuX3QgeCwgZGZuCiAKIGV4dGVybiBib29sX3QgaW9tbXVfZW5hYmxl
LCBpb21tdV9lbmFibGVkOwogZXh0ZXJuIGJvb2wgZm9yY2VfaW9tbXUsIGlvbW11X3F1YXJhbnRp
bmUsIGlvbW11X3ZlcmJvc2UsIGlvbW11X2lnZng7Ci1leHRlcm4gYm9vbF90IGlvbW11X3Nub29w
LCBpb21tdV9xaW52YWwsIGlvbW11X2ludHJlbWFwLCBpb21tdV9pbnRwb3N0OworZXh0ZXJuIGJv
b2xfdCBpb21tdV9zbm9vcCwgaW9tbXVfcWludmFsLCBpb21tdV9pbnRwb3N0OworZXh0ZXJuIGVu
dW0gX19wYWNrZWQgaW9tbXVfaW50cmVtYXAgeworICAgLyoKKyAgICAqIEluIG9yZGVyIHRvIGFs
bG93IHRyYWRpdGlvbmFsIGJvb2xlYW4gdXNlcyBvZiB0aGUgaW9tbXVfaW50cmVtYXAKKyAgICAq
IHZhcmlhYmxlLCB0aGUgIm9mZiIgdmFsdWUgaGFzIHRvIGNvbWUgZmlyc3QgKHlpZWxkaW5nIGEg
dmFsdWUgb2YgemVybykuCisgICAgKi8KKyAgIGlvbW11X2ludHJlbWFwX29mZiwKKyNpZmRlZiBD
T05GSUdfWDg2CisgICBpb21tdV9pbnRyZW1hcF9yZXN0cmljdGVkLAorI2VuZGlmCisgICBpb21t
dV9pbnRyZW1hcF9mdWxsLAorfSBpb21tdV9pbnRyZW1hcDsKIAogI2lmIGRlZmluZWQoQ09ORklH
X0lPTU1VX0ZPUkNFX1BUX1NIQVJFKQogI2RlZmluZSBpb21tdV9oYXBfcHRfc2hhcmUgdHJ1ZQoK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZl
bCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlz
dHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

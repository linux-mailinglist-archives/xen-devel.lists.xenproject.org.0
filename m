Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 3C83EC1AF6
	for <lists+xen-devel@lfdr.de>; Mon, 30 Sep 2019 07:25:01 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iEo8V-0002JK-Vn; Mon, 30 Sep 2019 05:22:15 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=hbFO=XZ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iEo8U-0002Hl-Au
 for xen-devel@lists.xenproject.org; Mon, 30 Sep 2019 05:22:14 +0000
X-Inumbo-ID: 302ab0ac-e342-11e9-8628-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 302ab0ac-e342-11e9-8628-bc764e2007e4;
 Mon, 30 Sep 2019 05:21:43 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id BDD98B07B;
 Mon, 30 Sep 2019 05:21:40 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 30 Sep 2019 07:21:23 +0200
Message-Id: <20190930052135.11257-8-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190930052135.11257-1-jgross@suse.com>
References: <20190930052135.11257-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v5 07/19] xen/sched: add fall back to idle vcpu
 when scheduling unit
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>,
 Dario Faggioli <dfaggioli@suse.com>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiBzY2hlZHVsaW5nIGFuIHVuaXQgd2l0aCBtdWx0aXBsZSB2Y3B1cyB0aGVyZSBpcyBubyBn
dWFyYW50ZWUgYWxsCnZjcHVzIGFyZSBhdmFpbGFibGUgKGUuZy4gYWJvdmUgbWF4dmNwdXMgb3Ig
dmNwdSBvZmZsaW5lKS4gRmFsbCBiYWNrIHRvCmlkbGUgdmNwdSBvZiB0aGUgY3VycmVudCBjcHUg
aW4gdGhhdCBjYXNlLiBUaGlzIHJlcXVpcmVzIHRvIHN0b3JlIHRoZQpjb3JyZWN0IHNjaGVkdWxl
X3VuaXQgcG9pbnRlciBpbiB0aGUgaWRsZSB2Y3B1IGFzIGxvbmcgYXMgaXQgdXNlZCBhcwpmYWxs
YmFjayB2Y3B1LgoKSW4gb3JkZXIgdG8gbW9kaWZ5IHRoZSBydW5zdGF0ZXMgb2YgdGhlIGNvcnJl
Y3QgdmNwdXMgd2hlbiBzd2l0Y2hpbmcKc2NoZWR1bGUgdW5pdHMgbWVyZ2Ugc2NoZWRfdW5pdF9y
dW5zdGF0ZV9jaGFuZ2UoKSBpbnRvCnNjaGVkX3N3aXRjaF91bml0cygpIGFuZCBsb29wIG92ZXIg
dGhlIGFmZmVjdGVkIHBoeXNpY2FsIGNwdXMgaW5zdGVhZApvZiB0aGUgdW5pdCdzIHZjcHVzLiBU
aGlzIGluIHR1cm4gcmVxdWlyZXMgYW4gYWNjZXNzIGZ1bmN0aW9uIHRvIHRoZQpjdXJyZW50IHZh
cmlhYmxlIG9mIG90aGVyIGNwdXMuCgpUb2RheSBjb250ZXh0X3NhdmVkKCkgaXMgY2FsbGVkIGlu
IGNhc2UgcHJldmlvdXMgYW5kIG5leHQgdmNwdXMgZGlmZmVyCndoZW4gZG9pbmcgYSBjb250ZXh0
IHN3aXRjaC4gV2l0aCBhbiBpZGxlIHZjcHUgYmVpbmcgY2FwYWJsZSB0byBiZSBhCnN1YnN0aXR1
dGUgZm9yIGFuIG9mZmxpbmUgdmNwdSB0aGlzIGlzIHByb2JsZW1hdGljIHdoZW4gc3dpdGNoaW5n
IHRvCmFuIGlkbGUgc2NoZWR1bGluZyB1bml0LiBBbiBpZGxlIHByZXZpb3VzIHZjcHUgbGVhdmVz
IHVzIGluIGRvdWJ0IHdoaWNoCnNjaGVkdWxlIHVuaXQgd2FzIGFjdGl2ZSBwcmV2aW91c2x5LCBz
byBzYXZlIHRoZSBwcmV2aW91cyB1bml0IHBvaW50ZXIKaW4gdGhlIHBlci1zY2hlZHVsZSByZXNv
dXJjZSBhcmVhLiBJZiBpdCBpcyBOVUxMIHRoZSB1bml0IGhhcyBub3QKY2hhbmdlZCBhbmQgd2Ug
ZG9uJ3QgaGF2ZSB0byBzZXQgdGhlIHByZXZpb3VzIHVuaXQgdG8gYmUgbm90IHJ1bm5pbmcuCgpX
aGVuIHJ1bm5pbmcgYW4gaWRsZSB2Y3B1IGluIGEgbm9uLWlkbGUgc2NoZWR1bGluZyB1bml0IHVz
ZSBhIHNwZWNpZmljCmd1ZXN0IGlkbGUgbG9vcCBub3QgcGVyZm9ybWluZyBhbnkgbm9uLXNvZnRp
cnEgdGFza2xldHMgYW5kCmxpdmVwYXRjaGluZyBpbiBvcmRlciB0byBhdm9pZCBwb3B1bGF0aW5n
IHRoZSBjcHUgY2FjaGVzIHdpdGggbWVtb3J5CnVzZWQgYnkgb3RoZXIgZG9tYWlucyAoYXMgZmFy
IGFzIHBvc3NpYmxlKS4gU29mdGlycXMgYXJlIGNvbnNpZGVyZWQgdG8KYmUgc2F2ZS4KCkluIG9y
ZGVyIHRvIGF2b2lkIGxpdmVwYXRjaGluZyB3aGVuIGdvaW5nIHRvIGd1ZXN0IGlkbGUgYW5vdGhl
cgp2YXJpYW50IG9mIHJlc2V0X3N0YWNrX2FuZF9qdW1wKCkgbm90IGNhbGxpbmcgY2hlY2tfZm9y
X2xpdmVwYXRjaF93b3JrCmlzIG5lZWRlZC4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3Mg
PGpncm9zc0BzdXNlLmNvbT4KQWNrZWQtYnk6IEp1bGllbiBHcmFsbCA8anVsaWVuLmdyYWxsQGFy
bS5jb20+ClJldmlld2VkLWJ5OiBEYXJpbyBGYWdnaW9saSA8ZGZhZ2dpb2xpQHN1c2UuY29tPgot
LS0KUkZDIFYyOgotIG5ldyBwYXRjaCAoQW5kcmV3IENvb3BlcikKClYxOgotIHVzZSB1cmdlbnRf
Y291bnQgdG8gc2VsZWN0IGNvcnJlY3QgaWRsZSByb3V0aW5lIChKYW4gQmV1bGljaCkKClYyOgot
IHNldCB2Y3B1LT5pc19ydW5uaW5nIGluIGNvbnRleHRfc2F2ZWQoKQotIGludHJvZHVjZSByZXNl
dF9zdGFja19hbmRfanVtcF9ub2xwKCkgKEphbiBCZXVsaWNoKQotIHJlYWRkIHNjcnViYmluZyAo
SmFuIEJldWxpY2gsIEFuZHJldyBDb29wZXIpCi0gZ2V0X2NwdV9jdXJyZW50KCkgX05PVF8gbW92
ZWQgdG8gaW5jbHVkZS9hc20teDg2L2N1cnJlbnQuaCBhcyB0aGUKICBuZWVkZWQgcmVmZXJlbmNl
IG9mIHN0YWNrX2Jhc2VbXSByZXN1bHRzIGluIGEgI2luY2x1ZGUgaGVsbAoKVjM6Ci0gc3BsaXQg
Y29udGV4dF9zYXZlZCgpIGludG8gdW5pdF9jb250ZXh0X3NhdmVkKCkgYW5kIHZjcHVfY29udGV4
dF9zYXZlZCgpCgpWNDoKLSByZW5hbWUgc2QgLT4gc3IgKEphbiBCZXVsaWNoKQotIHVzZSB1bnNp
Z25lZCBpbnQgZm9yIGNwdSAoSmFuIEJldWxpY2gpCi0gYWRkIGNvbW1lbnQgaW4gc2NoZWRfY29u
dGV4dF9zd2l0Y2goKSAoSmFuIEJldWxpY2gpCi0gYWRkIGNvbW1lbnQgYmVmb3JlIGRlZmluaXRp
b24gb2YgZ2V0X2NwdV9jdXJyZW50KCkgKEphbiBCZXVsaWNoKQoKVjU6Ci0gYWRkIGNvbW1lbnQg
KERhcmlvIEZhZ2dpb2xpKQotLS0KIHhlbi9hcmNoL3g4Ni9kb21haW4uYyAgICAgICAgIHwgIDIz
ICsrKysrCiB4ZW4vY29tbW9uL3NjaGVkdWxlLmMgICAgICAgICB8IDE5NSArKysrKysrKysrKysr
KysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0KIHhlbi9pbmNsdWRlL2FzbS1hcm0vY3VycmVu
dC5oIHwgICAxICsKIHhlbi9pbmNsdWRlL2FzbS14ODYvY3VycmVudC5oIHwgIDE5ICsrKy0KIHhl
bi9pbmNsdWRlL2FzbS14ODYvc21wLmggICAgIHwgICA3ICsrCiB4ZW4vaW5jbHVkZS94ZW4vc2No
ZWQtaWYuaCAgICB8ICAgNCArLQogeGVuL2luY2x1ZGUveGVuL3NjaGVkLmggICAgICAgfCAgIDEg
KwogNyBmaWxlcyBjaGFuZ2VkLCAxODcgaW5zZXJ0aW9ucygrKSwgNjMgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2RvbWFpbi5jIGIveGVuL2FyY2gveDg2L2RvbWFpbi5j
CmluZGV4IDI3Zjk5ZDNiY2MuLmM4ZDdmNDkxZWEgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9k
b21haW4uYworKysgYi94ZW4vYXJjaC94ODYvZG9tYWluLmMKQEAgLTE1OSw2ICsxNTksMjUgQEAg
c3RhdGljIHZvaWQgaWRsZV9sb29wKHZvaWQpCiAgICAgfQogfQogCisvKgorICogSWRsZSBsb29w
IGZvciBzaWJsaW5ncyBpbiBhY3RpdmUgc2NoZWR1bGUgdW5pdHMuCisgKiBXZSBkb24ndCBkbyBh
bnkgc3RhbmRhcmQgaWRsZSB3b3JrIGxpa2UgdGFza2xldHMgb3IgbGl2ZXBhdGNoaW5nLgorICov
CitzdGF0aWMgdm9pZCBndWVzdF9pZGxlX2xvb3Aodm9pZCkKK3sKKyAgICB1bnNpZ25lZCBpbnQg
Y3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOworCisgICAgZm9yICggOyA7ICkKKyAgICB7CisgICAg
ICAgIEFTU0VSVCghY3B1X2lzX29mZmxpbmUoY3B1KSk7CisKKyAgICAgICAgaWYgKCAhc29mdGly
cV9wZW5kaW5nKGNwdSkgJiYgIXNjcnViX2ZyZWVfcGFnZXMoKSAmJgorICAgICAgICAgICAgICFz
b2Z0aXJxX3BlbmRpbmcoY3B1KSkKKyAgICAgICAgICAgIHNjaGVkX2d1ZXN0X2lkbGUocG1faWRs
ZSwgY3B1KTsKKyAgICAgICAgZG9fc29mdGlycSgpOworICAgIH0KK30KKwogdm9pZCBzdGFydHVw
X2NwdV9pZGxlX2xvb3Aodm9pZCkKIHsKICAgICBzdHJ1Y3QgdmNwdSAqdiA9IGN1cnJlbnQ7CkBA
IC0xNzIsNiArMTkxLDEwIEBAIHZvaWQgc3RhcnR1cF9jcHVfaWRsZV9sb29wKHZvaWQpCiAKIHN0
YXRpYyB2b2lkIG5vcmV0dXJuIGNvbnRpbnVlX2lkbGVfZG9tYWluKHN0cnVjdCB2Y3B1ICp2KQog
eworICAgIC8qIElkbGUgdmNwdXMgbWlnaHQgYmUgYXR0YWNoZWQgdG8gbm9uLWlkbGUgdW5pdHMh
ICovCisgICAgaWYgKCAhaXNfaWRsZV9kb21haW4odi0+c2NoZWRfdW5pdC0+ZG9tYWluKSApCisg
ICAgICAgIHJlc2V0X3N0YWNrX2FuZF9qdW1wX25vbHAoZ3Vlc3RfaWRsZV9sb29wKTsKKwogICAg
IHJlc2V0X3N0YWNrX2FuZF9qdW1wKGlkbGVfbG9vcCk7CiB9CiAKZGlmZiAtLWdpdCBhL3hlbi9j
b21tb24vc2NoZWR1bGUuYyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwppbmRleCBjOGUyOTk5NDA3
Li5iNGM0YjA0ZWJlIDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMKKysrIGIveGVu
L2NvbW1vbi9zY2hlZHVsZS5jCkBAIC0xNDUsMTAgKzE0NSwyMSBAQCBzdGF0aWMgc3RydWN0IHNj
aGVkdWxlciBzY2hlZF9pZGxlX29wcyA9IHsKICAgICAuc3dpdGNoX3NjaGVkICAgPSBzY2hlZF9p
ZGxlX3N3aXRjaF9zY2hlZCwKIH07CiAKK3N0YXRpYyBpbmxpbmUgc3RydWN0IHZjcHUgKnVuaXQy
dmNwdV9jcHUoY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBjcHUpCit7CisgICAgdW5zaWdu
ZWQgaW50IGlkeCA9IHVuaXQtPnVuaXRfaWQgKyBwZXJfY3B1KHNjaGVkX3Jlc19pZHgsIGNwdSk7
CisgICAgY29uc3Qgc3RydWN0IGRvbWFpbiAqZCA9IHVuaXQtPmRvbWFpbjsKKworICAgIHJldHVy
biAoaWR4IDwgZC0+bWF4X3ZjcHVzKSA/IGQtPnZjcHVbaWR4XSA6IE5VTEw7Cit9CisKIHN0YXRp
YyBpbmxpbmUgc3RydWN0IHZjcHUgKnNjaGVkX3VuaXQydmNwdV9jcHUoY29uc3Qgc3RydWN0IHNj
aGVkX3VuaXQgKnVuaXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHVuc2lnbmVkIGludCBjcHUpCiB7Ci0gICAgcmV0dXJuIHVuaXQtPmRvbWFpbi0+dmNw
dVt1bml0LT51bml0X2lkICsgcGVyX2NwdShzY2hlZF9yZXNfaWR4LCBjcHUpXTsKKyAgICBzdHJ1
Y3QgdmNwdSAqdiA9IHVuaXQydmNwdV9jcHUodW5pdCwgY3B1KTsKKworICAgIHJldHVybiAodiAm
JiB2LT5uZXdfc3RhdGUgPT0gUlVOU1RBVEVfcnVubmluZykgPyB2IDogaWRsZV92Y3B1W2NwdV07
CiB9CiAKIHN0YXRpYyBpbmxpbmUgc3RydWN0IHNjaGVkdWxlciAqZG9tX3NjaGVkdWxlcihjb25z
dCBzdHJ1Y3QgZG9tYWluICpkKQpAQCAtMjY4LDggKzI3OSwxMSBAQCBzdGF0aWMgaW5saW5lIHZv
aWQgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UoCiAKICAgICB0cmFjZV9ydW5zdGF0ZV9jaGFuZ2Uodiwg
bmV3X3N0YXRlKTsKIAotICAgIHVuaXQtPnJ1bnN0YXRlX2NudFt2LT5ydW5zdGF0ZS5zdGF0ZV0t
LTsKLSAgICB1bml0LT5ydW5zdGF0ZV9jbnRbbmV3X3N0YXRlXSsrOworICAgIGlmICggIWlzX2lk
bGVfdmNwdSh2KSApCisgICAgeworICAgICAgICB1bml0LT5ydW5zdGF0ZV9jbnRbdi0+cnVuc3Rh
dGUuc3RhdGVdLS07CisgICAgICAgIHVuaXQtPnJ1bnN0YXRlX2NudFtuZXdfc3RhdGVdKys7Cisg
ICAgfQogCiAgICAgZGVsdGEgPSBuZXdfZW50cnlfdGltZSAtIHYtPnJ1bnN0YXRlLnN0YXRlX2Vu
dHJ5X3RpbWU7CiAgICAgaWYgKCBkZWx0YSA+IDAgKQpAQCAtMjgxLDIxICsyOTUsMTggQEAgc3Rh
dGljIGlubGluZSB2b2lkIHZjcHVfcnVuc3RhdGVfY2hhbmdlKAogICAgIHYtPnJ1bnN0YXRlLnN0
YXRlID0gbmV3X3N0YXRlOwogfQogCi1zdGF0aWMgaW5saW5lIHZvaWQgc2NoZWRfdW5pdF9ydW5z
dGF0ZV9jaGFuZ2Uoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCi0gICAgYm9vbCBydW5uaW5nLCBz
X3RpbWVfdCBuZXdfZW50cnlfdGltZSkKK3ZvaWQgc2NoZWRfZ3Vlc3RfaWRsZSh2b2lkICgqaWRs
ZSkgKHZvaWQpLCB1bnNpZ25lZCBpbnQgY3B1KQogewotICAgIHN0cnVjdCB2Y3B1ICp2OwotCi0g
ICAgZm9yX2VhY2hfc2NoZWRfdW5pdF92Y3B1ICggdW5pdCwgdiApCi0gICAgewotICAgICAgICBp
ZiAoIHJ1bm5pbmcgKQotICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2Uodiwgdi0+bmV3
X3N0YXRlLCBuZXdfZW50cnlfdGltZSk7Ci0gICAgICAgIGVsc2UKLSAgICAgICAgICAgIHZjcHVf
cnVuc3RhdGVfY2hhbmdlKHYsCi0gICAgICAgICAgICAgICAgKCh2LT5wYXVzZV9mbGFncyAmIFZQ
Rl9ibG9ja2VkKSA/IFJVTlNUQVRFX2Jsb2NrZWQgOgotICAgICAgICAgICAgICAgICAodmNwdV9y
dW5uYWJsZSh2KSA/IFJVTlNUQVRFX3J1bm5hYmxlIDogUlVOU1RBVEVfb2ZmbGluZSkpLAotICAg
ICAgICAgICAgICAgIG5ld19lbnRyeV90aW1lKTsKLSAgICB9CisgICAgLyoKKyAgICAgKiBBbm90
aGVyIHZjcHUgb2YgdGhlIHVuaXQgaXMgYWN0aXZlIGluIGd1ZXN0IGNvbnRleHQgd2hpbGUgdGhp
cyBvbmUgaXMKKyAgICAgKiBpZGxlLiBJbiBjYXNlIG9mIGEgc2NoZWR1bGluZyBldmVudCB3ZSBk
b24ndCB3YW50IHRvIGhhdmUgaGlnaCBsYXRlbmNpZXMKKyAgICAgKiBkdWUgdG8gYSBjcHUgbmVl
ZGluZyB0byB3YWtlIHVwIGZyb20gZGVlcCBDIHN0YXRlIGZvciBqb2luaW5nIHRoZQorICAgICAq
IHJlbmRlenZvdXMsIHNvIGF2b2lkIHRob3NlIGRlZXAgQyBzdGF0ZXMgYnkgaW5jcmVtZW50aW5n
IHRoZSB1cmdlbnQKKyAgICAgKiBjb3VudCBvZiB0aGUgY3B1LgorICAgICAqLworICAgIGF0b21p
Y19pbmMoJnBlcl9jcHUoc2NoZWRfdXJnZW50X2NvdW50LCBjcHUpKTsKKyAgICBpZGxlKCk7Cisg
ICAgYXRvbWljX2RlYygmcGVyX2NwdShzY2hlZF91cmdlbnRfY291bnQsIGNwdSkpOwogfQogCiB2
b2lkIHZjcHVfcnVuc3RhdGVfZ2V0KHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QgdmNwdV9ydW5zdGF0
ZV9pbmZvICpydW5zdGF0ZSkKQEAgLTU0NSw2ICs1NTYsNyBAQCBpbnQgc2NoZWRfaW5pdF92Y3B1
KHN0cnVjdCB2Y3B1ICp2KQogICAgIGlmICggaXNfaWRsZV9kb21haW4oZCkgKQogICAgIHsKICAg
ICAgICAgZ2V0X3NjaGVkX3Jlcyh2LT5wcm9jZXNzb3IpLT5jdXJyID0gdW5pdDsKKyAgICAgICAg
Z2V0X3NjaGVkX3Jlcyh2LT5wcm9jZXNzb3IpLT5zY2hlZF91bml0X2lkbGUgPSB1bml0OwogICAg
ICAgICB2LT5pc19ydW5uaW5nID0gMTsKICAgICAgICAgdW5pdC0+aXNfcnVubmluZyA9IHRydWU7
CiAgICAgICAgIHVuaXQtPnN0YXRlX2VudHJ5X3RpbWUgPSBOT1coKTsKQEAgLTg3Nyw3ICs4ODks
NyBAQCBzdGF0aWMgdm9pZCBzY2hlZF91bml0X21vdmVfbG9ja2VkKHN0cnVjdCBzY2hlZF91bml0
ICp1bml0LAogICoKICAqIHNjaGVkX3VuaXRfbWlncmF0ZV9maW5pc2goKSB3aWxsIGRvIHRoZSB3
b3JrIG5vdyBpZiBpdCBjYW4sIG9yIHNpbXBseQogICogcmV0dXJuIGlmIGl0IGNhbid0IChiZWNh
dXNlIHVuaXQgaXMgc3RpbGwgcnVubmluZyk7IGluIHRoYXQgY2FzZQotICogc2NoZWRfdW5pdF9t
aWdyYXRlX2ZpbmlzaCgpIHdpbGwgYmUgY2FsbGVkIGJ5IGNvbnRleHRfc2F2ZWQoKS4KKyAqIHNj
aGVkX3VuaXRfbWlncmF0ZV9maW5pc2goKSB3aWxsIGJlIGNhbGxlZCBieSB1bml0X2NvbnRleHRf
c2F2ZWQoKS4KICAqLwogc3RhdGljIHZvaWQgc2NoZWRfdW5pdF9taWdyYXRlX3N0YXJ0KHN0cnVj
dCBzY2hlZF91bml0ICp1bml0KQogewpAQCAtOTAwLDcgKzkxMiw3IEBAIHN0YXRpYyB2b2lkIHNj
aGVkX3VuaXRfbWlncmF0ZV9maW5pc2goc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAKICAgICAv
KgogICAgICAqIElmIHRoZSB1bml0IGlzIGN1cnJlbnRseSBydW5uaW5nLCB0aGlzIHdpbGwgYmUg
aGFuZGxlZCBieQotICAgICAqIGNvbnRleHRfc2F2ZWQoKTsgYW5kIGluIGFueSBjYXNlLCBpZiB0
aGUgYml0IGlzIGNsZWFyZWQsIHRoZW4KKyAgICAgKiB1bml0X2NvbnRleHRfc2F2ZWQoKTsgYW5k
IGluIGFueSBjYXNlLCBpZiB0aGUgYml0IGlzIGNsZWFyZWQsIHRoZW4KICAgICAgKiBzb21lb25l
IGVsc2UgaGFzIGFscmVhZHkgZG9uZSB0aGUgd29yayBzbyB3ZSBkb24ndCBuZWVkIHRvLgogICAg
ICAqLwogICAgIGlmICggdW5pdC0+aXNfcnVubmluZyApCkBAIC0xNzg1LDMzICsxNzk3LDY2IEBA
IHN0YXRpYyB2b2lkIHNjaGVkX3N3aXRjaF91bml0cyhzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNy
LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICpuZXh0
LCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqcHJldiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBzX3RpbWVfdCBub3cpCiB7Ci0gICAgc3ItPmN1cnIgPSBuZXh0OwotCi0gICAgVFJBQ0VfM0Qo
VFJDX1NDSEVEX1NXSVRDSF9JTkZQUkVWLCBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+
dW5pdF9pZCwKLSAgICAgICAgICAgICBub3cgLSBwcmV2LT5zdGF0ZV9lbnRyeV90aW1lKTsKLSAg
ICBUUkFDRV80RChUUkNfU0NIRURfU1dJVENIX0lORk5FWFQsIG5leHQtPmRvbWFpbi0+ZG9tYWlu
X2lkLCBuZXh0LT51bml0X2lkLAotICAgICAgICAgICAgIChuZXh0LT52Y3B1X2xpc3QtPnJ1bnN0
YXRlLnN0YXRlID09IFJVTlNUQVRFX3J1bm5hYmxlKSA/Ci0gICAgICAgICAgICAgKG5vdyAtIG5l
eHQtPnN0YXRlX2VudHJ5X3RpbWUpIDogMCwgcHJldi0+bmV4dF90aW1lKTsKKyAgICB1bnNpZ25l
ZCBpbnQgY3B1OwogCiAgICAgQVNTRVJUKHVuaXRfcnVubmluZyhwcmV2KSk7CiAKLSAgICBUUkFD
RV80RChUUkNfU0NIRURfU1dJVENILCBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5p
dF9pZCwKLSAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9p
ZCk7CisgICAgaWYgKCBwcmV2ICE9IG5leHQgKQorICAgIHsKKyAgICAgICAgc3ItPmN1cnIgPSBu
ZXh0OworICAgICAgICBzci0+cHJldiA9IHByZXY7CiAKLSAgICBzY2hlZF91bml0X3J1bnN0YXRl
X2NoYW5nZShwcmV2LCBmYWxzZSwgbm93KTsKKyAgICAgICAgVFJBQ0VfM0QoVFJDX1NDSEVEX1NX
SVRDSF9JTkZQUkVWLCBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwKKyAgICAgICAgICAgICAgICAg
cHJldi0+dW5pdF9pZCwgbm93IC0gcHJldi0+c3RhdGVfZW50cnlfdGltZSk7CisgICAgICAgIFRS
QUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GTkVYVCwgbmV4dC0+ZG9tYWluLT5kb21haW5faWQs
CisgICAgICAgICAgICAgICAgIG5leHQtPnVuaXRfaWQsCisgICAgICAgICAgICAgICAgIChuZXh0
LT52Y3B1X2xpc3QtPnJ1bnN0YXRlLnN0YXRlID09IFJVTlNUQVRFX3J1bm5hYmxlKSA/CisgICAg
ICAgICAgICAgICAgIChub3cgLSBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lKSA6IDAsIHByZXYtPm5l
eHRfdGltZSk7CisgICAgICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0gsIHByZXYtPmRvbWFp
bi0+ZG9tYWluX2lkLCBwcmV2LT51bml0X2lkLAorICAgICAgICAgICAgICAgICBuZXh0LT5kb21h
aW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCk7CiAKLSAgICBBU1NFUlQoIXVuaXRfcnVubmlu
ZyhuZXh0KSk7Ci0gICAgc2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2UobmV4dCwgdHJ1ZSwgbm93
KTsKKyAgICAgICAgQVNTRVJUKCF1bml0X3J1bm5pbmcobmV4dCkpOwogCi0gICAgLyoKLSAgICAg
KiBOQi4gRG9uJ3QgYWRkIGFueSB0cmFjZSByZWNvcmRzIGZyb20gaGVyZSB1bnRpbCB0aGUgYWN0
dWFsIGNvbnRleHQKLSAgICAgKiBzd2l0Y2gsIGVsc2UgbG9zdF9yZWNvcmRzIHJlc3VtZSB3aWxs
IG5vdCB3b3JrIHByb3Blcmx5LgotICAgICAqLworICAgICAgICAvKgorICAgICAgICAgKiBOQi4g
RG9uJ3QgYWRkIGFueSB0cmFjZSByZWNvcmRzIGZyb20gaGVyZSB1bnRpbCB0aGUgYWN0dWFsIGNv
bnRleHQKKyAgICAgICAgICogc3dpdGNoLCBlbHNlIGxvc3RfcmVjb3JkcyByZXN1bWUgd2lsbCBu
b3Qgd29yayBwcm9wZXJseS4KKyAgICAgICAgICovCisKKyAgICAgICAgQVNTRVJUKCFuZXh0LT5p
c19ydW5uaW5nKTsKKyAgICAgICAgbmV4dC0+aXNfcnVubmluZyA9IHRydWU7CisgICAgICAgIG5l
eHQtPnN0YXRlX2VudHJ5X3RpbWUgPSBub3c7CisKKyAgICAgICAgaWYgKCBpc19pZGxlX3VuaXQo
cHJldikgKQorICAgICAgICB7CisgICAgICAgICAgICBwcmV2LT5ydW5zdGF0ZV9jbnRbUlVOU1RB
VEVfcnVubmluZ10gPSAwOworICAgICAgICAgICAgcHJldi0+cnVuc3RhdGVfY250W1JVTlNUQVRF
X3J1bm5hYmxlXSA9IHNjaGVkX2dyYW51bGFyaXR5OworICAgICAgICB9CisgICAgICAgIGlmICgg
aXNfaWRsZV91bml0KG5leHQpICkKKyAgICAgICAgeworICAgICAgICAgICAgbmV4dC0+cnVuc3Rh
dGVfY250W1JVTlNUQVRFX3J1bm5pbmddID0gc2NoZWRfZ3JhbnVsYXJpdHk7CisgICAgICAgICAg
ICBuZXh0LT5ydW5zdGF0ZV9jbnRbUlVOU1RBVEVfcnVubmFibGVdID0gMDsKKyAgICAgICAgfQor
ICAgIH0KKworICAgIGZvcl9lYWNoX2NwdSAoIGNwdSwgc3ItPmNwdXMgKQorICAgIHsKKyAgICAg
ICAgc3RydWN0IHZjcHUgKnZwcmV2ID0gZ2V0X2NwdV9jdXJyZW50KGNwdSk7CisgICAgICAgIHN0
cnVjdCB2Y3B1ICp2bmV4dCA9IHNjaGVkX3VuaXQydmNwdV9jcHUobmV4dCwgY3B1KTsKKworICAg
ICAgICBpZiAoIHZwcmV2ICE9IHZuZXh0IHx8IHZwcmV2LT5ydW5zdGF0ZS5zdGF0ZSAhPSB2bmV4
dC0+bmV3X3N0YXRlICkKKyAgICAgICAgeworICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFu
Z2UodnByZXYsCisgICAgICAgICAgICAgICAgKCh2cHJldi0+cGF1c2VfZmxhZ3MgJiBWUEZfYmxv
Y2tlZCkgPyBSVU5TVEFURV9ibG9ja2VkIDoKKyAgICAgICAgICAgICAgICAgKHZjcHVfcnVubmFi
bGUodnByZXYpID8gUlVOU1RBVEVfcnVubmFibGUgOiBSVU5TVEFURV9vZmZsaW5lKSksCisgICAg
ICAgICAgICAgICAgbm93KTsKKyAgICAgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdlKHZuZXh0
LCB2bmV4dC0+bmV3X3N0YXRlLCBub3cpOworICAgICAgICB9CiAKLSAgICBBU1NFUlQoIW5leHQt
PmlzX3J1bm5pbmcpOwotICAgIG5leHQtPnZjcHVfbGlzdC0+aXNfcnVubmluZyA9IDE7Ci0gICAg
bmV4dC0+aXNfcnVubmluZyA9IHRydWU7Ci0gICAgbmV4dC0+c3RhdGVfZW50cnlfdGltZSA9IG5v
dzsKKyAgICAgICAgdm5leHQtPmlzX3J1bm5pbmcgPSAxOworCisgICAgICAgIGlmICggaXNfaWRs
ZV92Y3B1KHZuZXh0KSApCisgICAgICAgICAgICB2bmV4dC0+c2NoZWRfdW5pdCA9IG5leHQ7Cisg
ICAgfQogfQogCiBzdGF0aWMgYm9vbCBzY2hlZF90YXNrbGV0X2NoZWNrX2NwdSh1bnNpZ25lZCBp
bnQgY3B1KQpAQCAtMTg2NywyOSArMTkxMiwzOSBAQCBzdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQg
KmRvX3NjaGVkdWxlKHN0cnVjdCBzY2hlZF91bml0ICpwcmV2LCBzX3RpbWVfdCBub3csCiAgICAg
aWYgKCBwcmV2LT5uZXh0X3RpbWUgPj0gMCApIC8qIC12ZSBtZWFucyBubyBsaW1pdCAqLwogICAg
ICAgICBzZXRfdGltZXIoJnNyLT5zX3RpbWVyLCBub3cgKyBwcmV2LT5uZXh0X3RpbWUpOwogCi0g
ICAgaWYgKCBsaWtlbHkocHJldiAhPSBuZXh0KSApCi0gICAgICAgIHNjaGVkX3N3aXRjaF91bml0
cyhzciwgbmV4dCwgcHJldiwgbm93KTsKKyAgICBzY2hlZF9zd2l0Y2hfdW5pdHMoc3IsIG5leHQs
IHByZXYsIG5vdyk7CiAKICAgICByZXR1cm4gbmV4dDsKIH0KIAotc3RhdGljIHZvaWQgY29udGV4
dF9zYXZlZChzdHJ1Y3QgdmNwdSAqcHJldikKK3N0YXRpYyB2b2lkIHZjcHVfY29udGV4dF9zYXZl
ZChzdHJ1Y3QgdmNwdSAqdnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCkKIHsKLSAgICBzdHJ1Y3Qg
c2NoZWRfdW5pdCAqdW5pdCA9IHByZXYtPnNjaGVkX3VuaXQ7Ci0KICAgICAvKiBDbGVhciBydW5u
aW5nIGZsYWcgL2FmdGVyLyB3cml0aW5nIGNvbnRleHQgdG8gbWVtb3J5LiAqLwogICAgIHNtcF93
bWIoKTsKIAotICAgIHByZXYtPmlzX3J1bm5pbmcgPSAwOworICAgIGlmICggdnByZXYgIT0gdm5l
eHQgKQorICAgICAgICB2cHJldi0+aXNfcnVubmluZyA9IDA7Cit9CisKK3N0YXRpYyB2b2lkIHVu
aXRfY29udGV4dF9zYXZlZChzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyKQoreworICAgIHN0cnVj
dCBzY2hlZF91bml0ICp1bml0ID0gc3ItPnByZXY7CisKKyAgICBpZiAoICF1bml0ICkKKyAgICAg
ICAgcmV0dXJuOworCiAgICAgdW5pdC0+aXNfcnVubmluZyA9IGZhbHNlOwogICAgIHVuaXQtPnN0
YXRlX2VudHJ5X3RpbWUgPSBOT1coKTsKKyAgICBzci0+cHJldiA9IE5VTEw7CiAKICAgICAvKiBD
aGVjayBmb3IgbWlncmF0aW9uIHJlcXVlc3QgL2FmdGVyLyBjbGVhcmluZyBydW5uaW5nIGZsYWcu
ICovCiAgICAgc21wX21iKCk7CiAKLSAgICBzY2hlZF9jb250ZXh0X3NhdmVkKHZjcHVfc2NoZWR1
bGVyKHByZXYpLCB1bml0KTsKKyAgICBzY2hlZF9jb250ZXh0X3NhdmVkKHVuaXRfc2NoZWR1bGVy
KHVuaXQpLCB1bml0KTsKIAotICAgIHNjaGVkX3VuaXRfbWlncmF0ZV9maW5pc2godW5pdCk7Cisg
ICAgLyogSWRsZSBuZXZlciBtaWdyYXRlcyBhbmQgaWRsZSB2Y3B1cyBtaWdodCBiZWxvbmcgdG8g
b3RoZXIgdW5pdHMuICovCisgICAgaWYgKCAhaXNfaWRsZV91bml0KHVuaXQpICkKKyAgICAgICAg
c2NoZWRfdW5pdF9taWdyYXRlX2ZpbmlzaCh1bml0KTsKIH0KIAogLyoKQEAgLTE4OTksMzUgKzE5
NTQsNDQgQEAgc3RhdGljIHZvaWQgY29udGV4dF9zYXZlZChzdHJ1Y3QgdmNwdSAqcHJldikKICAq
IFRoZSBjb3VudGVyIHdpbGwgYmUgMCBpbiBjYXNlIG5vIHJlbmRlenZvdXMgaXMgbmVlZGVkLiBG
b3IgdGhlIHJlbmRlenZvdXMKICAqIGNhc2UgaXQgaXMgaW5pdGlhbGlzZWQgdG8gdGhlIG51bWJl
ciBvZiBjcHVzIHRvIHJlbmRlenZvdXMgcGx1cyAxLiBFYWNoCiAgKiBtZW1iZXIgZW50ZXJpbmcg
ZGVjcmVtZW50cyB0aGUgY291bnRlci4gVGhlIGxhc3Qgb25lIHdpbGwgZGVjcmVtZW50IGl0IHRv
Ci0gKiAxIGFuZCBwZXJmb3JtIHRoZSBmaW5hbCBuZWVkZWQgYWN0aW9uIGluIHRoYXQgY2FzZSAo
Y2FsbCBvZiBjb250ZXh0X3NhdmVkKCkKLSAqIGlmIHZjcHUgd2FzIHN3aXRjaGVkKSwgYW5kIHRo
ZW4gc2V0IHRoZSBjb3VudGVyIHRvIHplcm8uIFRoZSBvdGhlciBtZW1iZXJzCisgKiAxIGFuZCBw
ZXJmb3JtIHRoZSBmaW5hbCBuZWVkZWQgYWN0aW9uIGluIHRoYXQgY2FzZSAoY2FsbCBvZgorICog
dW5pdF9jb250ZXh0X3NhdmVkKCkpLCBhbmQgdGhlbiBzZXQgdGhlIGNvdW50ZXIgdG8gemVyby4g
VGhlIG90aGVyIG1lbWJlcnMKICAqIHdpbGwgd2FpdCB1bnRpbCB0aGUgY291bnRlciBiZWNvbWVz
IHplcm8gdW50aWwgdGhleSBwcm9jZWVkLgogICovCiB2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNo
ZWQoc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQpCiB7CiAgICAgc3RydWN0
IHNjaGVkX3VuaXQgKm5leHQgPSB2bmV4dC0+c2NoZWRfdW5pdDsKKyAgICBzdHJ1Y3Qgc2NoZWRf
cmVzb3VyY2UgKnNyID0gZ2V0X3NjaGVkX3JlcyhzbXBfcHJvY2Vzc29yX2lkKCkpOwogCiAgICAg
aWYgKCBhdG9taWNfcmVhZCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250KSApCiAgICAgewogICAg
ICAgICBpbnQgY250ID0gYXRvbWljX2RlY19yZXR1cm4oJm5leHQtPnJlbmRlenZvdXNfb3V0X2Nu
dCk7CiAKLSAgICAgICAgLyogQ2FsbCBjb250ZXh0X3NhdmVkKCkgYmVmb3JlIHJlbGVhc2luZyBv
dGhlciB3YWl0ZXJzLiAqLworICAgICAgICB2Y3B1X2NvbnRleHRfc2F2ZWQodnByZXYsIHZuZXh0
KTsKKworICAgICAgICAvKiBDYWxsIHVuaXRfY29udGV4dF9zYXZlZCgpIGJlZm9yZSByZWxlYXNp
bmcgb3RoZXIgd2FpdGVycy4gKi8KICAgICAgICAgaWYgKCBjbnQgPT0gMSApCiAgICAgICAgIHsK
LSAgICAgICAgICAgIGlmICggdnByZXYgIT0gdm5leHQgKQotICAgICAgICAgICAgICAgIGNvbnRl
eHRfc2F2ZWQodnByZXYpOworICAgICAgICAgICAgdW5pdF9jb250ZXh0X3NhdmVkKHNyKTsKICAg
ICAgICAgICAgIGF0b21pY19zZXQoJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCwgMCk7CiAgICAg
ICAgIH0KICAgICAgICAgZWxzZQogICAgICAgICAgICAgd2hpbGUgKCBhdG9taWNfcmVhZCgmbmV4
dC0+cmVuZGV6dm91c19vdXRfY250KSApCiAgICAgICAgICAgICAgICAgY3B1X3JlbGF4KCk7CiAg
ICAgfQotICAgIGVsc2UgaWYgKCB2cHJldiAhPSB2bmV4dCAmJiBzY2hlZF9ncmFudWxhcml0eSA9
PSAxICkKLSAgICAgICAgY29udGV4dF9zYXZlZCh2cHJldik7CisgICAgZWxzZQorICAgIHsKKyAg
ICAgICAgdmNwdV9jb250ZXh0X3NhdmVkKHZwcmV2LCB2bmV4dCk7CisgICAgICAgIGlmICggc2No
ZWRfZ3JhbnVsYXJpdHkgPT0gMSApCisgICAgICAgICAgICB1bml0X2NvbnRleHRfc2F2ZWQoc3Ip
OworICAgIH0KKworICAgIGlmICggaXNfaWRsZV92Y3B1KHZwcmV2KSAmJiB2cHJldiAhPSB2bmV4
dCApCisgICAgICAgIHZwcmV2LT5zY2hlZF91bml0ID0gc3ItPnNjaGVkX3VuaXRfaWRsZTsKIH0K
IAogc3RhdGljIHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnZwcmV2LCBz
dHJ1Y3QgdmNwdSAqdm5leHQsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzX3Rp
bWVfdCBub3cpCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib29sIHJlc2V0X2lk
bGVfdW5pdCwgc190aW1lX3Qgbm93KQogewogICAgIGlmICggdW5saWtlbHkodnByZXYgPT0gdm5l
eHQpICkKICAgICB7CkBAIC0xOTM2LDYgKzIwMDAsMTcgQEAgc3RhdGljIHZvaWQgc2NoZWRfY29u
dGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQsCiAgICAg
ICAgICAgICAgICAgIG5vdyAtIHZwcmV2LT5ydW5zdGF0ZS5zdGF0ZV9lbnRyeV90aW1lLAogICAg
ICAgICAgICAgICAgICB2cHJldi0+c2NoZWRfdW5pdC0+bmV4dF90aW1lKTsKICAgICAgICAgc2No
ZWRfY29udGV4dF9zd2l0Y2hlZCh2cHJldiwgdm5leHQpOworCisgICAgICAgIC8qCisgICAgICAg
ICAqIFdlIGFyZSBzd2l0Y2hpbmcgZnJvbSBhIG5vbi1pZGxlIHRvIGFuIGlkbGUgdW5pdC4KKyAg
ICAgICAgICogQSB2Y3B1IG9mIHRoZSBpZGxlIHVuaXQgbWlnaHQgaGF2ZSBiZWVuIHJ1bm5pbmcg
YmVmb3JlIGR1ZSB0bworICAgICAgICAgKiB0aGUgZ3Vlc3QgdmNwdSBiZWluZyBibG9ja2VkLiBX
ZSBtdXN0IGFkanVzdCB0aGUgdW5pdCBvZiB0aGUgaWRsZQorICAgICAgICAgKiB2Y3B1IHdoaWNo
IG1pZ2h0IGhhdmUgYmVlbiBzZXQgdG8gdGhlIGd1ZXN0J3Mgb25lLgorICAgICAgICAgKi8KKyAg
ICAgICAgaWYgKCByZXNldF9pZGxlX3VuaXQgKQorICAgICAgICAgICAgdm5leHQtPnNjaGVkX3Vu
aXQgPQorICAgICAgICAgICAgICAgIGdldF9zY2hlZF9yZXMoc21wX3Byb2Nlc3Nvcl9pZCgpKS0+
c2NoZWRfdW5pdF9pZGxlOworCiAgICAgICAgIHRyYWNlX2NvbnRpbnVlX3J1bm5pbmcodm5leHQp
OwogICAgICAgICByZXR1cm4gY29udGludWVfcnVubmluZyh2cHJldik7CiAgICAgfQpAQCAtMTk5
NCw3ICsyMDY5LDcgQEAgc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF93YWl0X3JlbmRl
enZvdXNfaW4oc3RydWN0IHNjaGVkX3VuaXQgKnByZXYsCiAgICAgICAgICAgICBwY3B1X3NjaGVk
dWxlX3VubG9ja19pcnEoKmxvY2ssIGNwdSk7CiAKICAgICAgICAgICAgIHJhaXNlX3NvZnRpcnEo
U0NIRURfU0xBVkVfU09GVElSUSk7Ci0gICAgICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2
cHJldiwgdnByZXYsIG5vdyk7CisgICAgICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJl
diwgdnByZXYsIGZhbHNlLCBub3cpOwogCiAgICAgICAgICAgICByZXR1cm4gTlVMTDsgICAgICAg
ICAvKiBBUk0gb25seS4gKi8KICAgICAgICAgfQpAQCAtMjAzNyw3ICsyMTEyLDggQEAgc3RhdGlj
IHZvaWQgc2NoZWRfc2xhdmUodm9pZCkKIAogICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShs
b2NrLCBjcHUpOwogCi0gICAgc2NoZWRfY29udGV4dF9zd2l0Y2godnByZXYsIHNjaGVkX3VuaXQy
dmNwdV9jcHUobmV4dCwgY3B1KSwgbm93KTsKKyAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJl
diwgc2NoZWRfdW5pdDJ2Y3B1X2NwdShuZXh0LCBjcHUpLAorICAgICAgICAgICAgICAgICAgICAg
ICAgIGlzX2lkbGVfdW5pdChuZXh0KSAmJiAhaXNfaWRsZV91bml0KHByZXYpLCBub3cpOwogfQog
CiAvKgpAQCAtMjA5OSw3ICsyMTc1LDggQEAgc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKICAg
ICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKIAogICAgIHZuZXh0ID0gc2No
ZWRfdW5pdDJ2Y3B1X2NwdShuZXh0LCBjcHUpOwotICAgIHNjaGVkX2NvbnRleHRfc3dpdGNoKHZw
cmV2LCB2bmV4dCwgbm93KTsKKyAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgdm5leHQs
CisgICAgICAgICAgICAgICAgICAgICAgICAgIWlzX2lkbGVfdW5pdChwcmV2KSAmJiBpc19pZGxl
X3VuaXQobmV4dCksIG5vdyk7CiB9CiAKIC8qIFRoZSBzY2hlZHVsZXIgdGltZXI6IGZvcmNlIGEg
cnVuIHRocm91Z2ggdGhlIHNjaGVkdWxlciAqLwpAQCAtMjE3MCw2ICsyMjQ3LDcgQEAgc3RhdGlj
IGludCBjcHVfc2NoZWR1bGVfdXAodW5zaWduZWQgaW50IGNwdSkKICAgICAgKi8KIAogICAgIHNy
LT5jdXJyID0gaWRsZV92Y3B1W2NwdV0tPnNjaGVkX3VuaXQ7CisgICAgc3ItPnNjaGVkX3VuaXRf
aWRsZSA9IGlkbGVfdmNwdVtjcHVdLT5zY2hlZF91bml0OwogCiAgICAgc3ItPnNjaGVkX3ByaXYg
PSBOVUxMOwogCkBAIC0yMzM5LDYgKzI0MTcsNyBAQCB2b2lkIF9faW5pdCBzY2hlZHVsZXJfaW5p
dCh2b2lkKQogICAgIGlmICggdmNwdV9jcmVhdGUoaWRsZV9kb21haW4sIDApID09IE5VTEwgKQog
ICAgICAgICBCVUcoKTsKICAgICBnZXRfc2NoZWRfcmVzKDApLT5jdXJyID0gaWRsZV92Y3B1WzBd
LT5zY2hlZF91bml0OworICAgIGdldF9zY2hlZF9yZXMoMCktPnNjaGVkX3VuaXRfaWRsZSA9IGlk
bGVfdmNwdVswXS0+c2NoZWRfdW5pdDsKIH0KIAogLyoKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRl
L2FzbS1hcm0vY3VycmVudC5oIGIveGVuL2luY2x1ZGUvYXNtLWFybS9jdXJyZW50LmgKaW5kZXgg
MTY1M2U4OWQzMC4uODhiZWI0NjQ1YSAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUvYXNtLWFybS9j
dXJyZW50LmgKKysrIGIveGVuL2luY2x1ZGUvYXNtLWFybS9jdXJyZW50LmgKQEAgLTE4LDYgKzE4
LDcgQEAgREVDTEFSRV9QRVJfQ1BVKHN0cnVjdCB2Y3B1ICosIGN1cnJfdmNwdSk7CiAKICNkZWZp
bmUgY3VycmVudCAgICAgICAgICAgICh0aGlzX2NwdShjdXJyX3ZjcHUpKQogI2RlZmluZSBzZXRf
Y3VycmVudCh2Y3B1KSAgZG8geyBjdXJyZW50ID0gKHZjcHUpOyB9IHdoaWxlICgwKQorI2RlZmlu
ZSBnZXRfY3B1X2N1cnJlbnQoY3B1KSAgKHBlcl9jcHUoY3Vycl92Y3B1LCBjcHUpKQogCiAvKiBQ
ZXItVkNQVSBzdGF0ZSB0aGF0IGxpdmVzIGF0IHRoZSB0b3Agb2YgdGhlIHN0YWNrICovCiBzdHJ1
Y3QgY3B1X2luZm8gewpkaWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9jdXJyZW50Lmgg
Yi94ZW4vaW5jbHVkZS9hc20teDg2L2N1cnJlbnQuaAppbmRleCBmMzUwOGMzYzA4Li4wYjQ3NDg1
MzM3IDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2N1cnJlbnQuaAorKysgYi94ZW4v
aW5jbHVkZS9hc20teDg2L2N1cnJlbnQuaApAQCAtNzcsNiArNzcsMTEgQEAgc3RydWN0IGNwdV9p
bmZvIHsKICAgICAvKiBnZXRfc3RhY2tfYm90dG9tKCkgbXVzdCBiZSAxNi1ieXRlIGFsaWduZWQg
Ki8KIH07CiAKK3N0YXRpYyBpbmxpbmUgc3RydWN0IGNwdV9pbmZvICpnZXRfY3B1X2luZm9fZnJv
bV9zdGFjayh1bnNpZ25lZCBsb25nIHNwKQoreworICAgIHJldHVybiAoc3RydWN0IGNwdV9pbmZv
ICopKChzcCB8IChTVEFDS19TSVpFIC0gMSkpICsgMSkgLSAxOworfQorCiBzdGF0aWMgaW5saW5l
IHN0cnVjdCBjcHVfaW5mbyAqZ2V0X2NwdV9pbmZvKHZvaWQpCiB7CiAjaWZkZWYgX19jbGFuZ19f
CkBAIC04Nyw3ICs5Miw3IEBAIHN0YXRpYyBpbmxpbmUgc3RydWN0IGNwdV9pbmZvICpnZXRfY3B1
X2luZm8odm9pZCkKICAgICByZWdpc3RlciB1bnNpZ25lZCBsb25nIHNwIGFzbSgicnNwIik7CiAj
ZW5kaWYKIAotICAgIHJldHVybiAoc3RydWN0IGNwdV9pbmZvICopKChzcCB8IChTVEFDS19TSVpF
IC0gMSkpICsgMSkgLSAxOworICAgIHJldHVybiBnZXRfY3B1X2luZm9fZnJvbV9zdGFjayhzcCk7
CiB9CiAKICNkZWZpbmUgZ2V0X2N1cnJlbnQoKSAgICAgICAgIChnZXRfY3B1X2luZm8oKS0+Y3Vy
cmVudF92Y3B1KQpAQCAtMTI0LDE2ICsxMjksMjIgQEAgdW5zaWduZWQgbG9uZyBnZXRfc3RhY2tf
ZHVtcF9ib3R0b20gKHVuc2lnbmVkIGxvbmcgc3ApOwogIyBkZWZpbmUgQ0hFQ0tfRk9SX0xJVkVQ
QVRDSF9XT1JLICIiCiAjZW5kaWYKIAotI2RlZmluZSByZXNldF9zdGFja19hbmRfanVtcChfX2Zu
KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAorI2RlZmluZSBzd2l0Y2hf
c3RhY2tfYW5kX2p1bXAoZm4sIGluc3RyKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
XAogICAgICh7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgXAogICAgICAgICBfX2FzbV9fIF9fdm9sYXRpbGVfXyAoICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICAgICAgIm1vdiAl
MCwlJSJfX09QInNwOyIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAot
ICAgICAgICAgICAgQ0hFQ0tfRk9SX0xJVkVQQVRDSF9XT1JLICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBcCisgICAgICAgICAgICBpbnN0ciAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgICAgICAgImptcCAl
YzEiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCi0g
ICAgICAgICAgICA6IDogInIiIChndWVzdF9jcHVfdXNlcl9yZWdzKCkpLCAiaSIgKF9fZm4pIDog
Im1lbW9yeSIgKTsgICBcCisgICAgICAgICAgICA6IDogInIiIChndWVzdF9jcHVfdXNlcl9yZWdz
KCkpLCAiaSIgKGZuKSA6ICJtZW1vcnkiICk7ICAgICBcCiAgICAgICAgIHVucmVhY2hhYmxlKCk7
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAg
fSkKIAorI2RlZmluZSByZXNldF9zdGFja19hbmRfanVtcChmbikgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgXAorICAgIHN3aXRjaF9zdGFja19hbmRfanVtcChmbiwgQ0hF
Q0tfRk9SX0xJVkVQQVRDSF9XT1JLKQorCisjZGVmaW5lIHJlc2V0X3N0YWNrX2FuZF9qdW1wX25v
bHAoZm4pICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCisgICAgc3dpdGNoX3N0
YWNrX2FuZF9qdW1wKGZuLCAiIikKKwogLyoKICAqIFdoaWNoIFZDUFUncyBzdGF0ZSBpcyBjdXJy
ZW50bHkgcnVubmluZyBvbiBlYWNoIENQVT8KICAqIFRoaXMgaXMgbm90IG5lY2VzYXNyaWx5IHRo
ZSBzYW1lIGFzICdjdXJyZW50JyBhcyBhIENQVSBtYXkgYmUKZGlmZiAtLWdpdCBhL3hlbi9pbmNs
dWRlL2FzbS14ODYvc21wLmggYi94ZW4vaW5jbHVkZS9hc20teDg2L3NtcC5oCmluZGV4IDYxNDQ2
ZDBlZmQuLmRiZWVkMmZkNDEgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvc21wLmgK
KysrIGIveGVuL2luY2x1ZGUvYXNtLXg4Ni9zbXAuaApAQCAtNzcsNiArNzcsMTMgQEAgdm9pZCBz
ZXRfbnJfc29ja2V0cyh2b2lkKTsKIC8qIFJlcHJlc2VudGluZyBIVCBhbmQgY29yZSBzaWJsaW5n
cyBpbiBlYWNoIHNvY2tldC4gKi8KIGV4dGVybiBjcHVtYXNrX3QgKipzb2NrZXRfY3B1bWFzazsK
IAorLyoKKyAqIFRvIGJlIHVzZWQgb25seSB3aGlsZSBubyBjb250ZXh0IHN3aXRjaCBjYW4gb2Nj
dXIgb24gdGhlIGNwdSwgaS5lLgorICogYnkgY2VydGFpbiBzY2hlZHVsaW5nIGNvZGUgb25seS4K
KyAqLworI2RlZmluZSBnZXRfY3B1X2N1cnJlbnQoY3B1KSBcCisgICAgKGdldF9jcHVfaW5mb19m
cm9tX3N0YWNrKCh1bnNpZ25lZCBsb25nKXN0YWNrX2Jhc2VbY3B1XSktPmN1cnJlbnRfdmNwdSkK
KwogI2VuZGlmIC8qICFfX0FTU0VNQkxZX18gKi8KIAogI2VuZGlmCmRpZmYgLS1naXQgYS94ZW4v
aW5jbHVkZS94ZW4vc2NoZWQtaWYuaCBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCmluZGV4
IDFiMjk2YjE1MGYuLjQxYTEwODNhMDggMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9zY2hl
ZC1pZi5oCisrKyBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCkBAIC0zOSw2ICszOSw4IEBA
IHN0cnVjdCBzY2hlZF9yZXNvdXJjZSB7CiAgICAgc3BpbmxvY2tfdCAgICAgICAgICpzY2hlZHVs
ZV9sb2NrLAogICAgICAgICAgICAgICAgICAgICAgICBfbG9jazsKICAgICBzdHJ1Y3Qgc2NoZWRf
dW5pdCAgKmN1cnI7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgICpzY2hlZF91bml0X2lkbGU7Cisg
ICAgc3RydWN0IHNjaGVkX3VuaXQgICpwcmV2OwogICAgIHZvaWQgICAgICAgICAgICAgICAqc2No
ZWRfcHJpdjsKICAgICBzdHJ1Y3QgdGltZXIgICAgICAgIHNfdGltZXI7ICAgICAgICAvKiBzY2hl
ZHVsaW5nIHRpbWVyICAgICAgICAgICAgICAgICovCiAKQEAgLTE5NCw3ICsxOTYsNyBAQCBzdGF0
aWMgaW5saW5lIHZvaWQgc2NoZWRfY2xlYXJfcGF1c2VfZmxhZ3NfYXRvbWljKHN0cnVjdCBzY2hl
ZF91bml0ICp1bml0LAogCiBzdGF0aWMgaW5saW5lIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9p
ZGxlX3VuaXQodW5zaWduZWQgaW50IGNwdSkKIHsKLSAgICByZXR1cm4gaWRsZV92Y3B1W2NwdV0t
PnNjaGVkX3VuaXQ7CisgICAgcmV0dXJuIGdldF9zY2hlZF9yZXMoY3B1KS0+c2NoZWRfdW5pdF9p
ZGxlOwogfQogCiBzdGF0aWMgaW5saW5lIHVuc2lnbmVkIGludCBzY2hlZF9nZXRfcmVzb3VyY2Vf
Y3B1KHVuc2lnbmVkIGludCBjcHUpCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQu
aCBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oCmluZGV4IDEyZjAwY2Q3OGQuLmNlNDMyOWRiNzIg
MTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oCisrKyBiL3hlbi9pbmNsdWRlL3hl
bi9zY2hlZC5oCkBAIC05MjksNiArOTI5LDcgQEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHko
c3RydWN0IGRvbWFpbiAqZCk7CiAKIHZvaWQgdmNwdV9ydW5zdGF0ZV9nZXQoc3RydWN0IHZjcHUg
KnYsIHN0cnVjdCB2Y3B1X3J1bnN0YXRlX2luZm8gKnJ1bnN0YXRlKTsKIHVpbnQ2NF90IGdldF9j
cHVfaWRsZV90aW1lKHVuc2lnbmVkIGludCBjcHUpOwordm9pZCBzY2hlZF9ndWVzdF9pZGxlKHZv
aWQgKCppZGxlKSAodm9pZCksIHVuc2lnbmVkIGludCBjcHUpOwogCiAvKgogICogVXNlZCBieSBp
ZGxlIGxvb3AgdG8gZGVjaWRlIHdoZXRoZXIgdGhlcmUgaXMgd29yayB0byBkbzoKLS0gCjIuMTYu
NAoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1k
ZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8v
bGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

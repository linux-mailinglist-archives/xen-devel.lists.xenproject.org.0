Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id D82BB105A05
	for <lists+xen-devel@lfdr.de>; Thu, 21 Nov 2019 19:54:43 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iXrY5-0007Hc-UC; Thu, 21 Nov 2019 18:51:25 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=4y/P=ZN=gmail.com=wei.liu.xen@srs-us1.protection.inumbo.net>)
 id 1iXrY4-0007Gy-HE
 for xen-devel@lists.xenproject.org; Thu, 21 Nov 2019 18:51:24 +0000
X-Inumbo-ID: db58437e-0c8f-11ea-adbe-bc764e2007e4
Received: from mail-wr1-x442.google.com (unknown [2a00:1450:4864:20::442])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id db58437e-0c8f-11ea-adbe-bc764e2007e4;
 Thu, 21 Nov 2019 18:50:59 +0000 (UTC)
Received: by mail-wr1-x442.google.com with SMTP id s5so5768410wrw.2
 for <xen-devel@lists.xenproject.org>; Thu, 21 Nov 2019 10:50:59 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=sender:from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=jmehIbWhQZXdoUxqvv2nAE9/O4n7ZGXTOOruyuVNHSs=;
 b=IkngiqlTkjNea7bGBPVnXACVbqM6xI4KEZgbGHD6t9H9M9yHG+zPD3jIN1fOEB1OgZ
 qRd3YBh4k0lSJvA+1t1IXQ19sxrAUgkxs9QU4ad4CipzpvCUpkd4/QjqIb3jtMHcrVkI
 Q2KlV3NvpdBVKtLnFwrTipM3FUpYQjtUixLFbspIcsLssNTfgXGgm3Ev5msgCgiGFvdF
 xrZiiTgsc1vrysTKaQfrXBu0VQ0nPO4zmH02W0a1XHgX/LUpDUzKDUTTbG+PDSNNsDc+
 MTLTjoiKTTbJf1tKpuXjmf92usCZaAEMqFYnwYalBZJJcv4wq3rWz3sd8oYWfyPsmxjc
 +q7Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:sender:from:to:cc:subject:date:message-id
 :in-reply-to:references:mime-version:content-transfer-encoding;
 bh=jmehIbWhQZXdoUxqvv2nAE9/O4n7ZGXTOOruyuVNHSs=;
 b=ESgvjMjaxbLflewmdLzKdjZdbFQSDn8T5wbBByq00lqpo67C2bWmRsGvz/QEiF/kxu
 DmiBgBvMhbHInl9W4RROHQfAQnXM3XdTEO53b/cU75kqo+kdUYv3FIR9uABgLVX4gZdk
 IU+6w1+3UNEGMsqYjJy5Lhdvv9Tt7uoUdrsx+fvOsXql3rN/ZjsKtCOn6TeyOi0AGNaF
 pV0liQVvxB1KofbuogtJ30JectwJUphzpRdPquIyfb2mSY7WJQHLAdE+7c4hCfixi9YC
 JMEfL+L/NyYJF4OwlQ2g/fUlHBmGM86zvcO3r651SALZ5uTkzPCLigsxzsNzfb+uISmW
 wlgQ==
X-Gm-Message-State: APjAAAXZ8ex9l1D7pK21QnjvI+j9mhLkXCW/UpqE/Zb2ILF2qTfybkL9
 QXCBIo0XWKMugpyJudZCq/JptQGa709uXw==
X-Google-Smtp-Source: APXvYqy2zlru4pM8V+dttgjt7cGZa47POMDpLNWukAwn3g5e+CeRyvXcn5iZQ1t0HdIlg/zz8b+Law==
X-Received: by 2002:adf:db51:: with SMTP id f17mr12500221wrj.85.1574362258219; 
 Thu, 21 Nov 2019 10:50:58 -0800 (PST)
Received: from debian.mshome.net (74.162.147.147.dyn.plus.net.
 [147.147.162.74])
 by smtp.gmail.com with ESMTPSA id f24sm535776wmb.37.2019.11.21.10.50.57
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Thu, 21 Nov 2019 10:50:57 -0800 (PST)
From: Wei Liu <wl@xen.org>
X-Google-Original-From: Wei Liu <liuwe@microsoft.com>
To: Xen Development List <xen-devel@lists.xenproject.org>
Date: Thu, 21 Nov 2019 18:50:47 +0000
Message-Id: <20191121185049.16666-7-liuwe@microsoft.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20191121185049.16666-1-liuwe@microsoft.com>
References: <20191121185049.16666-1-liuwe@microsoft.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v4 6/8] x86: switch xen guest implementation to
 use hypervisor framework
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Wei Liu <liuwe@microsoft.com>, Wei Liu <wl@xen.org>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Michael Kelley <mikelley@microsoft.com>, Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U2lnbmVkLW9mZi1ieTogV2VpIExpdSA8bGl1d2VAbWljcm9zb2Z0LmNvbT4KLS0tCkNoYW5nZXMg
aW4gdjQ6CjEuIHhlbl9wcm9iZSByZXR1cm5zIGFkZHJlc3Mgb2Ygb3BzIGRpcmVjdGx5LgoyLiBB
ZGQgX19pbml0IHRvIGh5cGVydmlzb3Jfc2V0dXAuCjMuIERyb3AgUGF1bCdzIHJldmlldyB0YWcu
Ci0tLQogeGVuL2FyY2gveDg2L2d1ZXN0L2h5cGVydmlzb3IuYyAgIHwgMzIgKysrKysrKysrKysr
KysrKysrKystCiB4ZW4vYXJjaC94ODYvZ3Vlc3QveGVuL3B2aC1ib290LmMgfCAgMiArLQogeGVu
L2FyY2gveDg2L2d1ZXN0L3hlbi94ZW4uYyAgICAgIHwgNDcgKysrKysrKysrKysrKysrKysrLS0t
LS0tLS0tLS0tLQogeGVuL2FyY2gveDg2L3NldHVwLmMgICAgICAgICAgICAgIHwgIDIgKy0KIHhl
bi9pbmNsdWRlL2FzbS14ODYvZ3Vlc3QveGVuLmggICB8ICA1ICsrLS0KIDUgZmlsZXMgY2hhbmdl
ZCwgNjQgaW5zZXJ0aW9ucygrKSwgMjQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVuL2Fy
Y2gveDg2L2d1ZXN0L2h5cGVydmlzb3IuYyBiL3hlbi9hcmNoL3g4Ni9ndWVzdC9oeXBlcnZpc29y
LmMKaW5kZXggMTAzZmViYTVkOC4uYTA2N2NhY2VjYiAxMDA2NDQKLS0tIGEveGVuL2FyY2gveDg2
L2d1ZXN0L2h5cGVydmlzb3IuYworKysgYi94ZW4vYXJjaC94ODYvZ3Vlc3QvaHlwZXJ2aXNvci5j
CkBAIC0xOSwxOCArMTksNDggQEAKICAqIENvcHlyaWdodCAoYykgMjAxOSBNaWNyb3NvZnQuCiAg
Ki8KIAorI2luY2x1ZGUgPHhlbi9pbml0Lmg+CiAjaW5jbHVkZSA8eGVuL3R5cGVzLmg+CiAKICNp
bmNsdWRlIDxhc20vY2FjaGUuaD4KLSNpbmNsdWRlIDxhc20vZ3Vlc3QvaHlwZXJ2aXNvci5oPgor
I2luY2x1ZGUgPGFzbS9ndWVzdC5oPgogCiBzdGF0aWMgY29uc3Qgc3RydWN0IGh5cGVydmlzb3Jf
b3BzIF9fcmVhZF9tb3N0bHkgKmhvcHM7CiAKIGNvbnN0IHN0cnVjdCBoeXBlcnZpc29yX29wcyAq
aHlwZXJ2aXNvcl9wcm9iZSh2b2lkKQogeworICAgIGlmICggaG9wcyApCisgICAgICAgIGdvdG8g
b3V0OworCisgICAgaWYgKCAhY3B1X2hhc19oeXBlcnZpc29yICkKKyAgICAgICAgZ290byBvdXQ7
CisKKyAgICBob3BzID0geGVuX3Byb2JlKCk7CisgICAgaWYgKCBob3BzICkKKyAgICAgICAgZ290
byBvdXQ7CisKKyBvdXQ6CiAgICAgcmV0dXJuIGhvcHM7CiB9CiAKK3ZvaWQgX19pbml0IGh5cGVy
dmlzb3Jfc2V0dXAodm9pZCkKK3sKKyAgICBpZiAoIGhvcHMgJiYgaG9wcy0+c2V0dXAgKQorICAg
ICAgICBob3BzLT5zZXR1cCgpOworfQorCit2b2lkIGh5cGVydmlzb3JfYXBfc2V0dXAodm9pZCkK
K3sKKyAgICBpZiAoIGhvcHMgJiYgaG9wcy0+YXBfc2V0dXAgKQorICAgICAgICBob3BzLT5hcF9z
ZXR1cCgpOworfQorCit2b2lkIGh5cGVydmlzb3JfcmVzdW1lKHZvaWQpCit7CisgICAgaWYgKCBo
b3BzICYmIGhvcHMtPnJlc3VtZSApCisgICAgICAgIGhvcHMtPnJlc3VtZSgpOworfQorCiAvKgog
ICogTG9jYWwgdmFyaWFibGVzOgogICogbW9kZTogQwpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2
L2d1ZXN0L3hlbi9wdmgtYm9vdC5jIGIveGVuL2FyY2gveDg2L2d1ZXN0L3hlbi9wdmgtYm9vdC5j
CmluZGV4IGNhOGUxNTZmN2QuLjQ5ODYyNWVhZTAgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9n
dWVzdC94ZW4vcHZoLWJvb3QuYworKysgYi94ZW4vYXJjaC94ODYvZ3Vlc3QveGVuL3B2aC1ib290
LmMKQEAgLTEwMyw3ICsxMDMsNyBAQCB2b2lkIF9faW5pdCBwdmhfaW5pdChtdWx0aWJvb3RfaW5m
b190ICoqbWJpLCBtb2R1bGVfdCAqKm1vZCkKIHsKICAgICBjb252ZXJ0X3B2aF9pbmZvKG1iaSwg
bW9kKTsKIAotICAgIHByb2JlX2h5cGVydmlzb3IoKTsKKyAgICBoeXBlcnZpc29yX3Byb2JlKCk7
CiAgICAgQVNTRVJUKHhlbl9ndWVzdCk7CiAKICAgICBnZXRfbWVtb3J5X21hcCgpOwpkaWZmIC0t
Z2l0IGEveGVuL2FyY2gveDg2L2d1ZXN0L3hlbi94ZW4uYyBiL3hlbi9hcmNoL3g4Ni9ndWVzdC94
ZW4veGVuLmMKaW5kZXggMGY1YjUyNjdjNS4uOGNmZTA1OTg4NyAxMDA2NDQKLS0tIGEveGVuL2Fy
Y2gveDg2L2d1ZXN0L3hlbi94ZW4uYworKysgYi94ZW4vYXJjaC94ODYvZ3Vlc3QveGVuL3hlbi5j
CkBAIC02NywyMiArNjcsNiBAQCBzdGF0aWMgdm9pZCBfX2luaXQgZmluZF94ZW5fbGVhdmVzKHZv
aWQpCiAgICAgfQogfQogCi12b2lkIF9faW5pdCBwcm9iZV9oeXBlcnZpc29yKHZvaWQpCi17Ci0g
ICAgaWYgKCB4ZW5fZ3Vlc3QgfHwgIWNwdV9oYXNfaHlwZXJ2aXNvciApCi0gICAgICAgIHJldHVy
bjsKLQotICAgIGZpbmRfeGVuX2xlYXZlcygpOwotCi0gICAgaWYgKCAheGVuX2NwdWlkX2Jhc2Ug
KQotICAgICAgICByZXR1cm47Ci0KLSAgICAvKiBGaWxsIHRoZSBoeXBlcmNhbGwgcGFnZS4gKi8K
LSAgICB3cm1zcmwoY3B1aWRfZWJ4KHhlbl9jcHVpZF9iYXNlICsgMiksIF9fcGEoaHlwZXJjYWxs
X3BhZ2UpKTsKLQotICAgIHhlbl9ndWVzdCA9IHRydWU7Ci19Ci0KIHN0YXRpYyB2b2lkIG1hcF9z
aGFyZWRfaW5mbyh2b2lkKQogewogICAgIG1mbl90IG1mbjsKQEAgLTI0NSw3ICsyMjksNyBAQCBz
dGF0aWMgdm9pZCBpbml0X2V2dGNobih2b2lkKQogICAgIH0KIH0KIAotdm9pZCBfX2luaXQgaHlw
ZXJ2aXNvcl9zZXR1cCh2b2lkKQorc3RhdGljIHZvaWQgX19pbml0IHhlbl9zZXR1cCh2b2lkKQog
ewogICAgIGluaXRfbWVtbWFwKCk7CiAKQEAgLTI3Myw3ICsyNTcsNyBAQCB2b2lkIF9faW5pdCBo
eXBlcnZpc29yX3NldHVwKHZvaWQpCiAgICAgaW5pdF9ldnRjaG4oKTsKIH0KIAotdm9pZCBoeXBl
cnZpc29yX2FwX3NldHVwKHZvaWQpCitzdGF0aWMgdm9pZCB4ZW5fYXBfc2V0dXAodm9pZCkKIHsK
ICAgICBzZXRfdmNwdV9pZCgpOwogICAgIG1hcF92Y3B1aW5mbygpOwpAQCAtMzAzLDcgKzI4Nyw3
IEBAIHN0YXRpYyB2b2lkIGFwX3Jlc3VtZSh2b2lkICp1bnVzZWQpCiAgICAgaW5pdF9ldnRjaG4o
KTsKIH0KIAotdm9pZCBoeXBlcnZpc29yX3Jlc3VtZSh2b2lkKQorc3RhdGljIHZvaWQgeGVuX3Jl
c3VtZSh2b2lkKQogewogICAgIC8qIFJlc2V0IHNoYXJlZCBpbmZvIHBhZ2UuICovCiAgICAgbWFw
X3NoYXJlZF9pbmZvKCk7CkBAIC0zMjYsNiArMzEwLDMxIEBAIHZvaWQgaHlwZXJ2aXNvcl9yZXN1
bWUodm9pZCkKICAgICAgICAgcHZfY29uc29sZV9pbml0KCk7CiB9CiAKK3N0YXRpYyBjb25zdCBz
dHJ1Y3QgaHlwZXJ2aXNvcl9vcHMgeGdfb3BzID0geworICAgIC5uYW1lID0gIlhlbiIsCisgICAg
LnNldHVwID0geGVuX3NldHVwLAorICAgIC5hcF9zZXR1cCA9IHhlbl9hcF9zZXR1cCwKKyAgICAu
cmVzdW1lID0geGVuX3Jlc3VtZSwKK307CisKK2NvbnN0IHN0cnVjdCBoeXBlcnZpc29yX29wcyAq
IF9faW5pdCB4ZW5fcHJvYmUodm9pZCkKK3sKKyAgICBpZiAoIHhlbl9ndWVzdCApCisgICAgICAg
IHJldHVybiAmeGdfb3BzOworCisgICAgZmluZF94ZW5fbGVhdmVzKCk7CisKKyAgICBpZiAoICF4
ZW5fY3B1aWRfYmFzZSApCisgICAgICAgIHJldHVybiBOVUxMOworCisgICAgLyogRmlsbCB0aGUg
aHlwZXJjYWxsIHBhZ2UuICovCisgICAgd3Jtc3JsKGNwdWlkX2VieCh4ZW5fY3B1aWRfYmFzZSAr
IDIpLCBfX3BhKGh5cGVyY2FsbF9wYWdlKSk7CisKKyAgICB4ZW5fZ3Vlc3QgPSB0cnVlOworCisg
ICAgcmV0dXJuICZ4Z19vcHM7Cit9CisKIC8qCiAgKiBMb2NhbCB2YXJpYWJsZXM6CiAgKiBtb2Rl
OiBDCmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvc2V0dXAuYyBiL3hlbi9hcmNoL3g4Ni9zZXR1
cC5jCmluZGV4IDAwZWU4N2JkZTUuLjE5NjA2ZDkwOWIgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4
Ni9zZXR1cC5jCisrKyBiL3hlbi9hcmNoL3g4Ni9zZXR1cC5jCkBAIC03NjMsNyArNzYzLDcgQEAg
dm9pZCBfX2luaXQgbm9yZXR1cm4gX19zdGFydF94ZW4odW5zaWduZWQgbG9uZyBtYmlfcCkKICAg
ICAgKiBhbGxvY2luZyBhbnkgeGVuaGVhcCBzdHJ1Y3R1cmVzIHdhbnRlZCBpbiBsb3dlciBtZW1v
cnkuICovCiAgICAga2V4ZWNfZWFybHlfY2FsY3VsYXRpb25zKCk7CiAKLSAgICBwcm9iZV9oeXBl
cnZpc29yKCk7CisgICAgaHlwZXJ2aXNvcl9wcm9iZSgpOwogCiAgICAgcGFyc2VfdmlkZW9faW5m
bygpOwogCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS9hc20teDg2L2d1ZXN0L3hlbi5oIGIveGVu
L2luY2x1ZGUvYXNtLXg4Ni9ndWVzdC94ZW4uaAppbmRleCAwMWRjM2VlNmY2Li5kYjkwYjU1MGE3
IDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2L2d1ZXN0L3hlbi5oCisrKyBiL3hlbi9p
bmNsdWRlL2FzbS14ODYvZ3Vlc3QveGVuLmgKQEAgLTIzLDYgKzIzLDcgQEAKIAogI2luY2x1ZGUg
PGFzbS9lODIwLmg+CiAjaW5jbHVkZSA8YXNtL2ZpeG1hcC5oPgorI2luY2x1ZGUgPGFzbS9ndWVz
dC9oeXBlcnZpc29yLmg+CiAKICNkZWZpbmUgWEVOX3NoYXJlZF9pbmZvICgoc3RydWN0IHNoYXJl
ZF9pbmZvICopZml4X3RvX3ZpcnQoRklYX1hFTl9TSEFSRURfSU5GTykpCiAKQEAgLTMyLDcgKzMz
LDcgQEAgZXh0ZXJuIGJvb2wgeGVuX2d1ZXN0OwogZXh0ZXJuIGJvb2wgcHZfY29uc29sZTsKIGV4
dGVybiB1aW50MzJfdCB4ZW5fY3B1aWRfYmFzZTsKIAotdm9pZCBwcm9iZV9oeXBlcnZpc29yKHZv
aWQpOworY29uc3Qgc3RydWN0IGh5cGVydmlzb3Jfb3BzICp4ZW5fcHJvYmUodm9pZCk7CiBpbnQg
eGdfYWxsb2NfdW51c2VkX3BhZ2UobWZuX3QgKm1mbik7CiBpbnQgeGdfZnJlZV91bnVzZWRfcGFn
ZShtZm5fdCBtZm4pOwogCkBAIC00NCw3ICs0NSw3IEBAIERFQ0xBUkVfUEVSX0NQVShzdHJ1Y3Qg
dmNwdV9pbmZvICosIHZjcHVfaW5mbyk7CiAjZGVmaW5lIHhlbl9ndWVzdCAwCiAjZGVmaW5lIHB2
X2NvbnNvbGUgMAogCi1zdGF0aWMgaW5saW5lIHZvaWQgcHJvYmVfaHlwZXJ2aXNvcih2b2lkKSB7
fQorc3RhdGljIGlubGluZSBjb25zdCBzdHJ1Y3QgaHlwZXJ2aXNvcl9vcHMgKnhlbl9wcm9iZSh2
b2lkKSB7IHJldHVybiBOVUxMOyB9CiAKICNlbmRpZiAvKiBDT05GSUdfWEVOX0dVRVNUICovCiAj
ZW5kaWYgLyogX19YODZfR1VFU1RfWEVOX0hfXyAqLwotLSAKMi4yMC4xCgoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlz
dApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

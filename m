Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id D002058580
	for <lists+xen-devel@lfdr.de>; Thu, 27 Jun 2019 17:24:55 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hgWEc-0004LQ-U4; Thu, 27 Jun 2019 15:22:50 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=LRcK=U2=suse.com=jbeulich@srs-us1.protection.inumbo.net>)
 id 1hgWEb-0004LB-5R
 for xen-devel@lists.xenproject.org; Thu, 27 Jun 2019 15:22:49 +0000
X-Inumbo-ID: 69a89ad0-98ef-11e9-a2af-17f79dc87198
Received: from prv1-mh.provo.novell.com (unknown [137.65.248.33])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 69a89ad0-98ef-11e9-a2af-17f79dc87198;
 Thu, 27 Jun 2019 15:22:45 +0000 (UTC)
Received: from INET-PRV1-MTA by prv1-mh.provo.novell.com
 with Novell_GroupWise; Thu, 27 Jun 2019 09:22:44 -0600
Message-Id: <5D14DF43020000780023B990@prv1-mh.provo.novell.com>
X-Mailer: Novell GroupWise Internet Agent 18.1.1 
Date: Thu, 27 Jun 2019 09:22:43 -0600
From: "Jan Beulich" <JBeulich@suse.com>
To: "xen-devel" <xen-devel@lists.xenproject.org>
References: <5D024C500200007800237DD8@prv1-mh.provo.novell.com>
 <5D14DDA6020000780023B96E@prv1-mh.provo.novell.com>
In-Reply-To: <5D14DDA6020000780023B96E@prv1-mh.provo.novell.com>
Mime-Version: 1.0
Content-Disposition: inline
Subject: [Xen-devel] [PATCH v2 08/10] AMD/IOMMU: adjust setup of internal
 interrupt for x2APIC mode
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Andrew Cooper <andrew.cooper3@citrix.com>,
 Brian Woods <brian.woods@amd.com>,
 Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

SW4gb3JkZXIgdG8gYmUgYWJsZSB0byBleHByZXNzIGFsbCBwb3NzaWJsZSBkZXN0aW5hdGlvbnMg
d2UgbmVlZCB0byBtYWtlCnVzZSBvZiB0aGlzIG5vbi1NU0ktY2FwYWJpbGl0eSBiYXNlZCBtZWNo
YW5pc20uIFRoZSBuZXcgSVJRIGNvbnRyb2xsZXIKc3RydWN0dXJlIGNhbiByZS11c2UgY2VydGFp
biBNU0kgZnVuY3Rpb25zLCB0aG91Z2guCgpGb3Igbm93IGdlbmVyYWwgYW5kIFBQUiBpbnRlcnJ1
cHRzIHN0aWxsIHNoYXJlIGEgc2luZ2xlIHZlY3RvciwgSVJRLCBhbmQKaGVuY2UgaGFuZGxlci4K
ClNpZ25lZC1vZmYtYnk6IEphbiBCZXVsaWNoIDxqYmV1bGljaEBzdXNlLmNvbT4KUmV2aWV3ZWQt
Ynk6IEFuZHJldyBDb29wZXIgPGFuZHJldy5jb29wZXIzQGNpdHJpeC5jb20+CgotLS0gYS94ZW4v
ZHJpdmVycy9wYXNzdGhyb3VnaC9hbWQvaW9tbXVfaW5pdC5jCisrKyBiL3hlbi9kcml2ZXJzL3Bh
c3N0aHJvdWdoL2FtZC9pb21tdV9pbml0LmMKQEAgLTQ3Miw2ICs0NzIsNDQgQEAgc3RhdGljIGh3
X2lycV9jb250cm9sbGVyIGlvbW11X21hc2thYmxlXwogICAgIC5zZXRfYWZmaW5pdHkgPSBzZXRf
bXNpX2FmZmluaXR5LAogfTsKIAorc3RhdGljIHZvaWQgc2V0X3gyYXBpY19hZmZpbml0eShzdHJ1
Y3QgaXJxX2Rlc2MgKmRlc2MsIGNvbnN0IGNwdW1hc2tfdCAqbWFzaykKK3sKKyAgICBzdHJ1Y3Qg
YW1kX2lvbW11ICppb21tdSA9IGRlc2MtPmFjdGlvbi0+ZGV2X2lkOworICAgIHVuc2lnbmVkIGlu
dCBkZXN0ID0gc2V0X2Rlc2NfYWZmaW5pdHkoZGVzYywgbWFzayk7CisgICAgdW5pb24gYW1kX2lv
bW11X3gyYXBpY19jb250cm9sIGN0cmwgPSB7fTsKKyAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwor
CisgICAgaWYgKCBkZXN0ID09IEJBRF9BUElDSUQgKQorICAgICAgICByZXR1cm47CisKKyAgICBt
c2lfY29tcG9zZV9tc2coZGVzYy0+YXJjaC52ZWN0b3IsIE5VTEwsICZpb21tdS0+bXNpLm1zZyk7
CisgICAgaW9tbXUtPm1zaS5tc2cuZGVzdDMyID0gZGVzdDsKKworICAgIGN0cmwuZGVzdF9tb2Rl
ID0gTUFTS19FWFRSKGlvbW11LT5tc2kubXNnLmFkZHJlc3NfbG8sCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgTVNJX0FERFJfREVTVE1PREVfTUFTSyk7CisgICAgY3RybC5pbnRfdHlw
ZSA9IE1BU0tfRVhUUihpb21tdS0+bXNpLm1zZy5kYXRhLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgTVNJX0RBVEFfREVMSVZFUllfTU9ERV9NQVNLKTsKKyAgICBjdHJsLnZlY3RvciA9
IGRlc2MtPmFyY2gudmVjdG9yOworICAgIGN0cmwuZGVzdF9sbyA9IGRlc3Q7CisgICAgY3RybC5k
ZXN0X2hpID0gZGVzdCA+PiAyNDsKKworICAgIHNwaW5fbG9ja19pcnFzYXZlKCZpb21tdS0+bG9j
aywgZmxhZ3MpOworICAgIHdyaXRlcShjdHJsLnJhdywgaW9tbXUtPm1taW9fYmFzZSArIElPTU1V
X1hUX0lOVF9DVFJMX01NSU9fT0ZGU0VUKTsKKyAgICB3cml0ZXEoY3RybC5yYXcsIGlvbW11LT5t
bWlvX2Jhc2UgKyBJT01NVV9YVF9QUFJfSU5UX0NUUkxfTU1JT19PRkZTRVQpOworICAgIHNwaW5f
dW5sb2NrX2lycXJlc3RvcmUoJmlvbW11LT5sb2NrLCBmbGFncyk7Cit9CisKK3N0YXRpYyBod19p
cnFfY29udHJvbGxlciBpb21tdV94MmFwaWNfdHlwZSA9IHsKKyAgICAudHlwZW5hbWUgICAgID0g
IklPTU1VLXgyQVBJQyIsCisgICAgLnN0YXJ0dXAgICAgICA9IGlycV9zdGFydHVwX25vbmUsCisg
ICAgLnNodXRkb3duICAgICA9IGlycV9zaHV0ZG93bl9ub25lLAorICAgIC5lbmFibGUgICAgICAg
PSBpcnFfZW5hYmxlX25vbmUsCisgICAgLmRpc2FibGUgICAgICA9IGlycV9kaXNhYmxlX25vbmUs
CisgICAgLmFjayAgICAgICAgICA9IGFja19ub25tYXNrYWJsZV9tc2lfaXJxLAorICAgIC5lbmQg
ICAgICAgICAgPSBlbmRfbm9ubWFza2FibGVfbXNpX2lycSwKKyAgICAuc2V0X2FmZmluaXR5ID0g
c2V0X3gyYXBpY19hZmZpbml0eSwKK307CisKIHN0YXRpYyB2b2lkIHBhcnNlX2V2ZW50X2xvZ19l
bnRyeShzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSwgdTMyIGVudHJ5W10pCiB7CiAgICAgdTE2IGRv
bWFpbl9pZCwgZGV2aWNlX2lkLCBmbGFnczsKQEAgLTcyNiw4ICs3NjQsNiBAQCBzdGF0aWMgdm9p
ZCBpb21tdV9pbnRlcnJ1cHRfaGFuZGxlcihpbnQKIHN0YXRpYyBib29sX3QgX19pbml0IHNldF9p
b21tdV9pbnRlcnJ1cHRfaGFuZGxlcihzdHJ1Y3QgYW1kX2lvbW11ICppb21tdSkKIHsKICAgICBp
bnQgaXJxLCByZXQ7Ci0gICAgaHdfaXJxX2NvbnRyb2xsZXIgKmhhbmRsZXI7Ci0gICAgdTE2IGNv
bnRyb2w7CiAKICAgICBpcnEgPSBjcmVhdGVfaXJxKE5VTUFfTk9fTk9ERSk7CiAgICAgaWYgKCBp
cnEgPD0gMCApCkBAIC03NDcsMjAgKzc4Myw0MyBAQCBzdGF0aWMgYm9vbF90IF9faW5pdCBzZXRf
aW9tbXVfaW50ZXJydXB0CiAgICAgICAgICAgICAgICAgICAgICAgICBQQ0lfU0xPVChpb21tdS0+
YmRmKSwgUENJX0ZVTkMoaW9tbXUtPmJkZikpOwogICAgICAgICByZXR1cm4gMDsKICAgICB9Ci0g
ICAgY29udHJvbCA9IHBjaV9jb25mX3JlYWQxNihpb21tdS0+c2VnLCBQQ0lfQlVTKGlvbW11LT5i
ZGYpLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUENJX1NMT1QoaW9tbXUtPmJkZiks
IFBDSV9GVU5DKGlvbW11LT5iZGYpLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW9t
bXUtPm1zaS5tc2lfYXR0cmliLnBvcyArIFBDSV9NU0lfRkxBR1MpOwotICAgIGlvbW11LT5tc2ku
bXNpLm52ZWMgPSAxOwotICAgIGlmICggaXNfbWFza19iaXRfc3VwcG9ydChjb250cm9sKSApCi0g
ICAgewotICAgICAgICBpb21tdS0+bXNpLm1zaV9hdHRyaWIubWFza2JpdCA9IDE7Ci0gICAgICAg
IGlvbW11LT5tc2kubXNpLm1wb3MgPSBtc2lfbWFza19iaXRzX3JlZyhpb21tdS0+bXNpLm1zaV9h
dHRyaWIucG9zLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgaXNfNjRiaXRfYWRkcmVzcyhjb250cm9sKSk7Ci0gICAgICAgIGhhbmRsZXIgPSAmaW9tbXVf
bWFza2FibGVfbXNpX3R5cGU7CisKKyAgICBpZiAoIGlvbW11LT5jdHJsLmludF9jYXBfeHRfZW4g
KQorICAgIHsKKyAgICAgICAgc3RydWN0IGlycV9kZXNjICpkZXNjID0gaXJxX3RvX2Rlc2MoaXJx
KTsKKworICAgICAgICBpb21tdS0+bXNpLm1zaV9hdHRyaWIucG9zID0gTVNJX1RZUEVfSU9NTVU7
CisgICAgICAgIGlvbW11LT5tc2kubXNpX2F0dHJpYi5tYXNrYml0ID0gMDsKKyAgICAgICAgaW9t
bXUtPm1zaS5tc2lfYXR0cmliLmlzXzY0ID0gMTsKKworICAgICAgICBkZXNjLT5tc2lfZGVzYyA9
ICZpb21tdS0+bXNpOworICAgICAgICBkZXNjLT5oYW5kbGVyID0gJmlvbW11X3gyYXBpY190eXBl
OworCisgICAgICAgIHJldCA9IDA7CiAgICAgfQogICAgIGVsc2UKLSAgICAgICAgaGFuZGxlciA9
ICZpb21tdV9tc2lfdHlwZTsKLSAgICByZXQgPSBfX3NldHVwX21zaV9pcnEoaXJxX3RvX2Rlc2Mo
aXJxKSwgJmlvbW11LT5tc2ksIGhhbmRsZXIpOworICAgIHsKKyAgICAgICAgaHdfaXJxX2NvbnRy
b2xsZXIgKmhhbmRsZXI7CisgICAgICAgIHUxNiBjb250cm9sOworCisgICAgICAgIGNvbnRyb2wg
PSBwY2lfY29uZl9yZWFkMTYoaW9tbXUtPnNlZywgUENJX0JVUyhpb21tdS0+YmRmKSwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQQ0lfU0xPVChpb21tdS0+YmRmKSwgUENJX0ZV
TkMoaW9tbXUtPmJkZiksCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW9tbXUt
Pm1zaS5tc2lfYXR0cmliLnBvcyArIFBDSV9NU0lfRkxBR1MpOworCisgICAgICAgIGlvbW11LT5t
c2kubXNpLm52ZWMgPSAxOworICAgICAgICBpZiAoIGlzX21hc2tfYml0X3N1cHBvcnQoY29udHJv
bCkgKQorICAgICAgICB7CisgICAgICAgICAgICBpb21tdS0+bXNpLm1zaV9hdHRyaWIubWFza2Jp
dCA9IDE7CisgICAgICAgICAgICBpb21tdS0+bXNpLm1zaS5tcG9zID0gbXNpX21hc2tfYml0c19y
ZWcoaW9tbXUtPm1zaS5tc2lfYXR0cmliLnBvcywKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBpc182NGJpdF9hZGRyZXNzKGNvbnRyb2wpKTsKKyAg
ICAgICAgICAgIGhhbmRsZXIgPSAmaW9tbXVfbWFza2FibGVfbXNpX3R5cGU7CisgICAgICAgIH0K
KyAgICAgICAgZWxzZQorICAgICAgICAgICAgaGFuZGxlciA9ICZpb21tdV9tc2lfdHlwZTsKKwor
ICAgICAgICByZXQgPSBfX3NldHVwX21zaV9pcnEoaXJxX3RvX2Rlc2MoaXJxKSwgJmlvbW11LT5t
c2ksIGhhbmRsZXIpOworICAgIH0KKwogICAgIGlmICggIXJldCApCiAgICAgICAgIHJldCA9IHJl
cXVlc3RfaXJxKGlycSwgMCwgaW9tbXVfaW50ZXJydXB0X2hhbmRsZXIsICJhbWRfaW9tbXUiLCBp
b21tdSk7CiAgICAgaWYgKCByZXQgKQpAQCAtODM4LDggKzg5NywxOSBAQCBzdGF0aWMgdm9pZCBl
bmFibGVfaW9tbXUoc3RydWN0IGFtZF9pb21tCiAgICAgICAgIHN0cnVjdCBpcnFfZGVzYyAqZGVz
YyA9IGlycV90b19kZXNjKGlvbW11LT5tc2kuaXJxKTsKIAogICAgICAgICBzcGluX2xvY2soJmRl
c2MtPmxvY2spOwotICAgICAgICBzZXRfbXNpX2FmZmluaXR5KGRlc2MsICZjcHVfb25saW5lX21h
cCk7Ci0gICAgICAgIHNwaW5fdW5sb2NrKCZkZXNjLT5sb2NrKTsKKworICAgICAgICBpZiAoIGlv
bW11LT5jdHJsLmludF9jYXBfeHRfZW4gKQorICAgICAgICB7CisgICAgICAgICAgICBzZXRfeDJh
cGljX2FmZmluaXR5KGRlc2MsICZjcHVfb25saW5lX21hcCk7CisgICAgICAgICAgICBzcGluX3Vu
bG9jaygmZGVzYy0+bG9jayk7CisgICAgICAgIH0KKyAgICAgICAgZWxzZQorICAgICAgICB7Cisg
ICAgICAgICAgICBzZXRfbXNpX2FmZmluaXR5KGRlc2MsICZjcHVfb25saW5lX21hcCk7CisgICAg
ICAgICAgICBzcGluX3VubG9jaygmZGVzYy0+bG9jayk7CisKKyAgICAgICAgICAgIGFtZF9pb21t
dV9tc2lfZW5hYmxlKGlvbW11LCBJT01NVV9DT05UUk9MX0VOQUJMRUQpOworICAgICAgICB9CiAg
ICAgfQogCiAgICAgYW1kX2lvbW11X21zaV9lbmFibGUoaW9tbXUsIElPTU1VX0NPTlRST0xfRU5B
QkxFRCk7CkBAIC04NzksNyArOTQ5LDkgQEAgc3RhdGljIHZvaWQgZGlzYWJsZV9pb21tdShzdHJ1
Y3QgYW1kX2lvbQogICAgICAgICByZXR1cm47CiAgICAgfQogCi0gICAgYW1kX2lvbW11X21zaV9l
bmFibGUoaW9tbXUsIElPTU1VX0NPTlRST0xfRElTQUJMRUQpOworICAgIGlmICggIWlvbW11LT5j
dHJsLmludF9jYXBfeHRfZW4gKQorICAgICAgICBhbWRfaW9tbXVfbXNpX2VuYWJsZShpb21tdSwg
SU9NTVVfQ09OVFJPTF9ESVNBQkxFRCk7CisKICAgICBzZXRfaW9tbXVfY29tbWFuZF9idWZmZXJf
Y29udHJvbChpb21tdSwgSU9NTVVfQ09OVFJPTF9ESVNBQkxFRCk7CiAgICAgc2V0X2lvbW11X2V2
ZW50X2xvZ19jb250cm9sKGlvbW11LCBJT01NVV9DT05UUk9MX0RJU0FCTEVEKTsKIAotLS0gYS94
ZW4vaW5jbHVkZS9hc20teDg2L2h2bS9zdm0vYW1kLWlvbW11LWRlZnMuaAorKysgYi94ZW4vaW5j
bHVkZS9hc20teDg2L2h2bS9zdm0vYW1kLWlvbW11LWRlZnMuaApAQCAtNDE2LDYgKzQxNiwyNSBA
QCB1bmlvbiBhbWRfaW9tbXVfZXh0X2ZlYXR1cmVzIHsKICAgICB9IGZsZHM7CiB9OwogCisvKiB4
MkFQSUMgQ29udHJvbCBSZWdpc3RlcnMgKi8KKyNkZWZpbmUgSU9NTVVfWFRfSU5UX0NUUkxfTU1J
T19PRkZTRVQJCTB4MDE3MAorI2RlZmluZSBJT01NVV9YVF9QUFJfSU5UX0NUUkxfTU1JT19PRkZT
RVQJMHgwMTc4CisjZGVmaW5lIElPTU1VX1hUX0dBX0lOVF9DVFJMX01NSU9fT0ZGU0VUCTB4MDE4
MAorCit1bmlvbiBhbWRfaW9tbXVfeDJhcGljX2NvbnRyb2wgeworICAgIHVpbnQ2NF90IHJhdzsK
KyAgICBzdHJ1Y3QgeworICAgICAgICB1bnNpZ25lZCBpbnQgOjI7CisgICAgICAgIHVuc2lnbmVk
IGludCBkZXN0X21vZGU6MTsKKyAgICAgICAgdW5zaWduZWQgaW50IDo1OworICAgICAgICB1bnNp
Z25lZCBpbnQgZGVzdF9sbzoyNDsKKyAgICAgICAgdW5zaWduZWQgaW50IHZlY3Rvcjo4OworICAg
ICAgICB1bnNpZ25lZCBpbnQgaW50X3R5cGU6MTsgLyogRE0gaW4gSU9NTVUgc3BlYyAzLjA0ICov
CisgICAgICAgIHVuc2lnbmVkIGludCA6MTU7CisgICAgICAgIHVuc2lnbmVkIGludCBkZXN0X2hp
Ojg7CisgICAgfTsKK307CisKIC8qIFN0YXR1cyBSZWdpc3RlciovCiAjZGVmaW5lIElPTU1VX1NU
QVRVU19NTUlPX09GRlNFVAkJMHgyMDIwCiAjZGVmaW5lIElPTU1VX1NUQVRVU19FVkVOVF9PVkVS
RkxPV19NQVNLCTB4MDAwMDAwMDEKCgoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhl
bnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5m
by94ZW4tZGV2ZWw=

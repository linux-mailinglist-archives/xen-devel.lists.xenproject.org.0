Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id E6372C488A
	for <lists+xen-devel@lfdr.de>; Wed,  2 Oct 2019 09:31:20 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iFZ3a-0001Ym-6q; Wed, 02 Oct 2019 07:28:18 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=lglc=X3=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iFZ3Y-0001XS-MY
 for xen-devel@lists.xenproject.org; Wed, 02 Oct 2019 07:28:16 +0000
X-Inumbo-ID: 23d9a40d-e4e6-11e9-9710-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 23d9a40d-e4e6-11e9-9710-12813bfff9fa;
 Wed, 02 Oct 2019 07:27:51 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id E35C8AFC2;
 Wed,  2 Oct 2019 07:27:49 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Wed,  2 Oct 2019 09:27:32 +0200
Message-Id: <20191002072745.24919-8-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20191002072745.24919-1-jgross@suse.com>
References: <20191002072745.24919-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v6 07/20] xen/sched: add fall back to idle vcpu
 when scheduling unit
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Julien Grall <julien@xen.org>,
 Wei Liu <wl@xen.org>, Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Jan Beulich <jbeulich@suse.com>, Dario Faggioli <dfaggioli@suse.com>,
 Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlbiBzY2hlZHVsaW5nIGFuIHVuaXQgd2l0aCBtdWx0aXBsZSB2Y3B1cyB0aGVyZSBpcyBubyBn
dWFyYW50ZWUgYWxsCnZjcHVzIGFyZSBhdmFpbGFibGUgKGUuZy4gYWJvdmUgbWF4dmNwdXMgb3Ig
dmNwdSBvZmZsaW5lKS4gRmFsbCBiYWNrIHRvCmlkbGUgdmNwdSBvZiB0aGUgY3VycmVudCBjcHUg
aW4gdGhhdCBjYXNlLiBUaGlzIHJlcXVpcmVzIHRvIHN0b3JlIHRoZQpjb3JyZWN0IHNjaGVkdWxl
X3VuaXQgcG9pbnRlciBpbiB0aGUgaWRsZSB2Y3B1IGFzIGxvbmcgYXMgaXQgdXNlZCBhcwpmYWxs
YmFjayB2Y3B1LgoKSW4gb3JkZXIgdG8gbW9kaWZ5IHRoZSBydW5zdGF0ZXMgb2YgdGhlIGNvcnJl
Y3QgdmNwdXMgd2hlbiBzd2l0Y2hpbmcKc2NoZWR1bGUgdW5pdHMgbWVyZ2Ugc2NoZWRfdW5pdF9y
dW5zdGF0ZV9jaGFuZ2UoKSBpbnRvCnNjaGVkX3N3aXRjaF91bml0cygpIGFuZCBsb29wIG92ZXIg
dGhlIGFmZmVjdGVkIHBoeXNpY2FsIGNwdXMgaW5zdGVhZApvZiB0aGUgdW5pdCdzIHZjcHVzLiBU
aGlzIGluIHR1cm4gcmVxdWlyZXMgYW4gYWNjZXNzIGZ1bmN0aW9uIHRvIHRoZQpjdXJyZW50IHZh
cmlhYmxlIG9mIG90aGVyIGNwdXMuCgpUb2RheSBjb250ZXh0X3NhdmVkKCkgaXMgY2FsbGVkIGlu
IGNhc2UgcHJldmlvdXMgYW5kIG5leHQgdmNwdXMgZGlmZmVyCndoZW4gZG9pbmcgYSBjb250ZXh0
IHN3aXRjaC4gV2l0aCBhbiBpZGxlIHZjcHUgYmVpbmcgY2FwYWJsZSB0byBiZSBhCnN1YnN0aXR1
dGUgZm9yIGFuIG9mZmxpbmUgdmNwdSB0aGlzIGlzIHByb2JsZW1hdGljIHdoZW4gc3dpdGNoaW5n
IHRvCmFuIGlkbGUgc2NoZWR1bGluZyB1bml0LiBBbiBpZGxlIHByZXZpb3VzIHZjcHUgbGVhdmVz
IHVzIGluIGRvdWJ0IHdoaWNoCnNjaGVkdWxlIHVuaXQgd2FzIGFjdGl2ZSBwcmV2aW91c2x5LCBz
byBzYXZlIHRoZSBwcmV2aW91cyB1bml0IHBvaW50ZXIKaW4gdGhlIHBlci1zY2hlZHVsZSByZXNv
dXJjZSBhcmVhLiBJZiBpdCBpcyBOVUxMIHRoZSB1bml0IGhhcyBub3QKY2hhbmdlZCBhbmQgd2Ug
ZG9uJ3QgaGF2ZSB0byBzZXQgdGhlIHByZXZpb3VzIHVuaXQgdG8gYmUgbm90IHJ1bm5pbmcuCgpX
aGVuIHJ1bm5pbmcgYW4gaWRsZSB2Y3B1IGluIGEgbm9uLWlkbGUgc2NoZWR1bGluZyB1bml0IHVz
ZSBhIHNwZWNpZmljCmd1ZXN0IGlkbGUgbG9vcCBub3QgcGVyZm9ybWluZyBhbnkgbm9uLXNvZnRp
cnEgdGFza2xldHMgYW5kCmxpdmVwYXRjaGluZyBpbiBvcmRlciB0byBhdm9pZCBwb3B1bGF0aW5n
IHRoZSBjcHUgY2FjaGVzIHdpdGggbWVtb3J5CnVzZWQgYnkgb3RoZXIgZG9tYWlucyAoYXMgZmFy
IGFzIHBvc3NpYmxlKS4gU29mdGlycXMgYXJlIGNvbnNpZGVyZWQgdG8KYmUgc2F2ZS4KCkluIG9y
ZGVyIHRvIGF2b2lkIGxpdmVwYXRjaGluZyB3aGVuIGdvaW5nIHRvIGd1ZXN0IGlkbGUgYW5vdGhl
cgp2YXJpYW50IG9mIHJlc2V0X3N0YWNrX2FuZF9qdW1wKCkgbm90IGNhbGxpbmcgY2hlY2tfZm9y
X2xpdmVwYXRjaF93b3JrCmlzIG5lZWRlZC4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3Mg
PGpncm9zc0BzdXNlLmNvbT4KQWNrZWQtYnk6IEp1bGllbiBHcmFsbCA8anVsaWVuLmdyYWxsQGFy
bS5jb20+ClJldmlld2VkLWJ5OiBEYXJpbyBGYWdnaW9saSA8ZGZhZ2dpb2xpQHN1c2UuY29tPgpB
Y2tlZC1ieTogSmFuIEJldWxpY2ggPGpiZXVsaWNoQHN1c2UuY29tPgotLS0KUkZDIFYyOgotIG5l
dyBwYXRjaCAoQW5kcmV3IENvb3BlcikKClYxOgotIHVzZSB1cmdlbnRfY291bnQgdG8gc2VsZWN0
IGNvcnJlY3QgaWRsZSByb3V0aW5lIChKYW4gQmV1bGljaCkKClYyOgotIHNldCB2Y3B1LT5pc19y
dW5uaW5nIGluIGNvbnRleHRfc2F2ZWQoKQotIGludHJvZHVjZSByZXNldF9zdGFja19hbmRfanVt
cF9ub2xwKCkgKEphbiBCZXVsaWNoKQotIHJlYWRkIHNjcnViYmluZyAoSmFuIEJldWxpY2gsIEFu
ZHJldyBDb29wZXIpCi0gZ2V0X2NwdV9jdXJyZW50KCkgX05PVF8gbW92ZWQgdG8gaW5jbHVkZS9h
c20teDg2L2N1cnJlbnQuaCBhcyB0aGUKICBuZWVkZWQgcmVmZXJlbmNlIG9mIHN0YWNrX2Jhc2Vb
XSByZXN1bHRzIGluIGEgI2luY2x1ZGUgaGVsbAoKVjM6Ci0gc3BsaXQgY29udGV4dF9zYXZlZCgp
IGludG8gdW5pdF9jb250ZXh0X3NhdmVkKCkgYW5kIHZjcHVfY29udGV4dF9zYXZlZCgpCgpWNDoK
LSByZW5hbWUgc2QgLT4gc3IgKEphbiBCZXVsaWNoKQotIHVzZSB1bnNpZ25lZCBpbnQgZm9yIGNw
dSAoSmFuIEJldWxpY2gpCi0gYWRkIGNvbW1lbnQgaW4gc2NoZWRfY29udGV4dF9zd2l0Y2goKSAo
SmFuIEJldWxpY2gpCi0gYWRkIGNvbW1lbnQgYmVmb3JlIGRlZmluaXRpb24gb2YgZ2V0X2NwdV9j
dXJyZW50KCkgKEphbiBCZXVsaWNoKQoKVjU6Ci0gYWRkIGNvbW1lbnQgKERhcmlvIEZhZ2dpb2xp
KQotLS0KIHhlbi9hcmNoL3g4Ni9kb21haW4uYyAgICAgICAgIHwgIDIzICsrKysrCiB4ZW4vY29t
bW9uL3NjaGVkdWxlLmMgICAgICAgICB8IDE5NSArKysrKysrKysrKysrKysrKysrKysrKysrKysr
Ky0tLS0tLS0tLS0tLS0KIHhlbi9pbmNsdWRlL2FzbS1hcm0vY3VycmVudC5oIHwgICAxICsKIHhl
bi9pbmNsdWRlL2FzbS14ODYvY3VycmVudC5oIHwgIDE5ICsrKy0KIHhlbi9pbmNsdWRlL2FzbS14
ODYvc21wLmggICAgIHwgICA3ICsrCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQtaWYuaCAgICB8ICAg
NCArLQogeGVuL2luY2x1ZGUveGVuL3NjaGVkLmggICAgICAgfCAgIDEgKwogNyBmaWxlcyBjaGFu
Z2VkLCAxODcgaW5zZXJ0aW9ucygrKSwgNjMgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEveGVu
L2FyY2gveDg2L2RvbWFpbi5jIGIveGVuL2FyY2gveDg2L2RvbWFpbi5jCmluZGV4IDI3Zjk5ZDNi
Y2MuLmM4ZDdmNDkxZWEgMTAwNjQ0Ci0tLSBhL3hlbi9hcmNoL3g4Ni9kb21haW4uYworKysgYi94
ZW4vYXJjaC94ODYvZG9tYWluLmMKQEAgLTE1OSw2ICsxNTksMjUgQEAgc3RhdGljIHZvaWQgaWRs
ZV9sb29wKHZvaWQpCiAgICAgfQogfQogCisvKgorICogSWRsZSBsb29wIGZvciBzaWJsaW5ncyBp
biBhY3RpdmUgc2NoZWR1bGUgdW5pdHMuCisgKiBXZSBkb24ndCBkbyBhbnkgc3RhbmRhcmQgaWRs
ZSB3b3JrIGxpa2UgdGFza2xldHMgb3IgbGl2ZXBhdGNoaW5nLgorICovCitzdGF0aWMgdm9pZCBn
dWVzdF9pZGxlX2xvb3Aodm9pZCkKK3sKKyAgICB1bnNpZ25lZCBpbnQgY3B1ID0gc21wX3Byb2Nl
c3Nvcl9pZCgpOworCisgICAgZm9yICggOyA7ICkKKyAgICB7CisgICAgICAgIEFTU0VSVCghY3B1
X2lzX29mZmxpbmUoY3B1KSk7CisKKyAgICAgICAgaWYgKCAhc29mdGlycV9wZW5kaW5nKGNwdSkg
JiYgIXNjcnViX2ZyZWVfcGFnZXMoKSAmJgorICAgICAgICAgICAgICFzb2Z0aXJxX3BlbmRpbmco
Y3B1KSkKKyAgICAgICAgICAgIHNjaGVkX2d1ZXN0X2lkbGUocG1faWRsZSwgY3B1KTsKKyAgICAg
ICAgZG9fc29mdGlycSgpOworICAgIH0KK30KKwogdm9pZCBzdGFydHVwX2NwdV9pZGxlX2xvb3Ao
dm9pZCkKIHsKICAgICBzdHJ1Y3QgdmNwdSAqdiA9IGN1cnJlbnQ7CkBAIC0xNzIsNiArMTkxLDEw
IEBAIHZvaWQgc3RhcnR1cF9jcHVfaWRsZV9sb29wKHZvaWQpCiAKIHN0YXRpYyB2b2lkIG5vcmV0
dXJuIGNvbnRpbnVlX2lkbGVfZG9tYWluKHN0cnVjdCB2Y3B1ICp2KQogeworICAgIC8qIElkbGUg
dmNwdXMgbWlnaHQgYmUgYXR0YWNoZWQgdG8gbm9uLWlkbGUgdW5pdHMhICovCisgICAgaWYgKCAh
aXNfaWRsZV9kb21haW4odi0+c2NoZWRfdW5pdC0+ZG9tYWluKSApCisgICAgICAgIHJlc2V0X3N0
YWNrX2FuZF9qdW1wX25vbHAoZ3Vlc3RfaWRsZV9sb29wKTsKKwogICAgIHJlc2V0X3N0YWNrX2Fu
ZF9qdW1wKGlkbGVfbG9vcCk7CiB9CiAKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWR1bGUu
YyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwppbmRleCBjOGUyOTk5NDA3Li5iNGM0YjA0ZWJlIDEw
MDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMKKysrIGIveGVuL2NvbW1vbi9zY2hlZHVs
ZS5jCkBAIC0xNDUsMTAgKzE0NSwyMSBAQCBzdGF0aWMgc3RydWN0IHNjaGVkdWxlciBzY2hlZF9p
ZGxlX29wcyA9IHsKICAgICAuc3dpdGNoX3NjaGVkICAgPSBzY2hlZF9pZGxlX3N3aXRjaF9zY2hl
ZCwKIH07CiAKK3N0YXRpYyBpbmxpbmUgc3RydWN0IHZjcHUgKnVuaXQydmNwdV9jcHUoY29uc3Qg
c3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHVuc2lnbmVkIGludCBjcHUpCit7CisgICAgdW5zaWduZWQgaW50IGlkeCA9IHVu
aXQtPnVuaXRfaWQgKyBwZXJfY3B1KHNjaGVkX3Jlc19pZHgsIGNwdSk7CisgICAgY29uc3Qgc3Ry
dWN0IGRvbWFpbiAqZCA9IHVuaXQtPmRvbWFpbjsKKworICAgIHJldHVybiAoaWR4IDwgZC0+bWF4
X3ZjcHVzKSA/IGQtPnZjcHVbaWR4XSA6IE5VTEw7Cit9CisKIHN0YXRpYyBpbmxpbmUgc3RydWN0
IHZjcHUgKnNjaGVkX3VuaXQydmNwdV9jcHUoY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQs
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVk
IGludCBjcHUpCiB7Ci0gICAgcmV0dXJuIHVuaXQtPmRvbWFpbi0+dmNwdVt1bml0LT51bml0X2lk
ICsgcGVyX2NwdShzY2hlZF9yZXNfaWR4LCBjcHUpXTsKKyAgICBzdHJ1Y3QgdmNwdSAqdiA9IHVu
aXQydmNwdV9jcHUodW5pdCwgY3B1KTsKKworICAgIHJldHVybiAodiAmJiB2LT5uZXdfc3RhdGUg
PT0gUlVOU1RBVEVfcnVubmluZykgPyB2IDogaWRsZV92Y3B1W2NwdV07CiB9CiAKIHN0YXRpYyBp
bmxpbmUgc3RydWN0IHNjaGVkdWxlciAqZG9tX3NjaGVkdWxlcihjb25zdCBzdHJ1Y3QgZG9tYWlu
ICpkKQpAQCAtMjY4LDggKzI3OSwxMSBAQCBzdGF0aWMgaW5saW5lIHZvaWQgdmNwdV9ydW5zdGF0
ZV9jaGFuZ2UoCiAKICAgICB0cmFjZV9ydW5zdGF0ZV9jaGFuZ2UodiwgbmV3X3N0YXRlKTsKIAot
ICAgIHVuaXQtPnJ1bnN0YXRlX2NudFt2LT5ydW5zdGF0ZS5zdGF0ZV0tLTsKLSAgICB1bml0LT5y
dW5zdGF0ZV9jbnRbbmV3X3N0YXRlXSsrOworICAgIGlmICggIWlzX2lkbGVfdmNwdSh2KSApCisg
ICAgeworICAgICAgICB1bml0LT5ydW5zdGF0ZV9jbnRbdi0+cnVuc3RhdGUuc3RhdGVdLS07Cisg
ICAgICAgIHVuaXQtPnJ1bnN0YXRlX2NudFtuZXdfc3RhdGVdKys7CisgICAgfQogCiAgICAgZGVs
dGEgPSBuZXdfZW50cnlfdGltZSAtIHYtPnJ1bnN0YXRlLnN0YXRlX2VudHJ5X3RpbWU7CiAgICAg
aWYgKCBkZWx0YSA+IDAgKQpAQCAtMjgxLDIxICsyOTUsMTggQEAgc3RhdGljIGlubGluZSB2b2lk
IHZjcHVfcnVuc3RhdGVfY2hhbmdlKAogICAgIHYtPnJ1bnN0YXRlLnN0YXRlID0gbmV3X3N0YXRl
OwogfQogCi1zdGF0aWMgaW5saW5lIHZvaWQgc2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2Uoc3Ry
dWN0IHNjaGVkX3VuaXQgKnVuaXQsCi0gICAgYm9vbCBydW5uaW5nLCBzX3RpbWVfdCBuZXdfZW50
cnlfdGltZSkKK3ZvaWQgc2NoZWRfZ3Vlc3RfaWRsZSh2b2lkICgqaWRsZSkgKHZvaWQpLCB1bnNp
Z25lZCBpbnQgY3B1KQogewotICAgIHN0cnVjdCB2Y3B1ICp2OwotCi0gICAgZm9yX2VhY2hfc2No
ZWRfdW5pdF92Y3B1ICggdW5pdCwgdiApCi0gICAgewotICAgICAgICBpZiAoIHJ1bm5pbmcgKQot
ICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2Uodiwgdi0+bmV3X3N0YXRlLCBuZXdfZW50
cnlfdGltZSk7Ci0gICAgICAgIGVsc2UKLSAgICAgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdl
KHYsCi0gICAgICAgICAgICAgICAgKCh2LT5wYXVzZV9mbGFncyAmIFZQRl9ibG9ja2VkKSA/IFJV
TlNUQVRFX2Jsb2NrZWQgOgotICAgICAgICAgICAgICAgICAodmNwdV9ydW5uYWJsZSh2KSA/IFJV
TlNUQVRFX3J1bm5hYmxlIDogUlVOU1RBVEVfb2ZmbGluZSkpLAotICAgICAgICAgICAgICAgIG5l
d19lbnRyeV90aW1lKTsKLSAgICB9CisgICAgLyoKKyAgICAgKiBBbm90aGVyIHZjcHUgb2YgdGhl
IHVuaXQgaXMgYWN0aXZlIGluIGd1ZXN0IGNvbnRleHQgd2hpbGUgdGhpcyBvbmUgaXMKKyAgICAg
KiBpZGxlLiBJbiBjYXNlIG9mIGEgc2NoZWR1bGluZyBldmVudCB3ZSBkb24ndCB3YW50IHRvIGhh
dmUgaGlnaCBsYXRlbmNpZXMKKyAgICAgKiBkdWUgdG8gYSBjcHUgbmVlZGluZyB0byB3YWtlIHVw
IGZyb20gZGVlcCBDIHN0YXRlIGZvciBqb2luaW5nIHRoZQorICAgICAqIHJlbmRlenZvdXMsIHNv
IGF2b2lkIHRob3NlIGRlZXAgQyBzdGF0ZXMgYnkgaW5jcmVtZW50aW5nIHRoZSB1cmdlbnQKKyAg
ICAgKiBjb3VudCBvZiB0aGUgY3B1LgorICAgICAqLworICAgIGF0b21pY19pbmMoJnBlcl9jcHUo
c2NoZWRfdXJnZW50X2NvdW50LCBjcHUpKTsKKyAgICBpZGxlKCk7CisgICAgYXRvbWljX2RlYygm
cGVyX2NwdShzY2hlZF91cmdlbnRfY291bnQsIGNwdSkpOwogfQogCiB2b2lkIHZjcHVfcnVuc3Rh
dGVfZ2V0KHN0cnVjdCB2Y3B1ICp2LCBzdHJ1Y3QgdmNwdV9ydW5zdGF0ZV9pbmZvICpydW5zdGF0
ZSkKQEAgLTU0NSw2ICs1NTYsNyBAQCBpbnQgc2NoZWRfaW5pdF92Y3B1KHN0cnVjdCB2Y3B1ICp2
KQogICAgIGlmICggaXNfaWRsZV9kb21haW4oZCkgKQogICAgIHsKICAgICAgICAgZ2V0X3NjaGVk
X3Jlcyh2LT5wcm9jZXNzb3IpLT5jdXJyID0gdW5pdDsKKyAgICAgICAgZ2V0X3NjaGVkX3Jlcyh2
LT5wcm9jZXNzb3IpLT5zY2hlZF91bml0X2lkbGUgPSB1bml0OwogICAgICAgICB2LT5pc19ydW5u
aW5nID0gMTsKICAgICAgICAgdW5pdC0+aXNfcnVubmluZyA9IHRydWU7CiAgICAgICAgIHVuaXQt
PnN0YXRlX2VudHJ5X3RpbWUgPSBOT1coKTsKQEAgLTg3Nyw3ICs4ODksNyBAQCBzdGF0aWMgdm9p
ZCBzY2hlZF91bml0X21vdmVfbG9ja2VkKHN0cnVjdCBzY2hlZF91bml0ICp1bml0LAogICoKICAq
IHNjaGVkX3VuaXRfbWlncmF0ZV9maW5pc2goKSB3aWxsIGRvIHRoZSB3b3JrIG5vdyBpZiBpdCBj
YW4sIG9yIHNpbXBseQogICogcmV0dXJuIGlmIGl0IGNhbid0IChiZWNhdXNlIHVuaXQgaXMgc3Rp
bGwgcnVubmluZyk7IGluIHRoYXQgY2FzZQotICogc2NoZWRfdW5pdF9taWdyYXRlX2ZpbmlzaCgp
IHdpbGwgYmUgY2FsbGVkIGJ5IGNvbnRleHRfc2F2ZWQoKS4KKyAqIHNjaGVkX3VuaXRfbWlncmF0
ZV9maW5pc2goKSB3aWxsIGJlIGNhbGxlZCBieSB1bml0X2NvbnRleHRfc2F2ZWQoKS4KICAqLwog
c3RhdGljIHZvaWQgc2NoZWRfdW5pdF9taWdyYXRlX3N0YXJ0KHN0cnVjdCBzY2hlZF91bml0ICp1
bml0KQogewpAQCAtOTAwLDcgKzkxMiw3IEBAIHN0YXRpYyB2b2lkIHNjaGVkX3VuaXRfbWlncmF0
ZV9maW5pc2goc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAKICAgICAvKgogICAgICAqIElmIHRo
ZSB1bml0IGlzIGN1cnJlbnRseSBydW5uaW5nLCB0aGlzIHdpbGwgYmUgaGFuZGxlZCBieQotICAg
ICAqIGNvbnRleHRfc2F2ZWQoKTsgYW5kIGluIGFueSBjYXNlLCBpZiB0aGUgYml0IGlzIGNsZWFy
ZWQsIHRoZW4KKyAgICAgKiB1bml0X2NvbnRleHRfc2F2ZWQoKTsgYW5kIGluIGFueSBjYXNlLCBp
ZiB0aGUgYml0IGlzIGNsZWFyZWQsIHRoZW4KICAgICAgKiBzb21lb25lIGVsc2UgaGFzIGFscmVh
ZHkgZG9uZSB0aGUgd29yayBzbyB3ZSBkb24ndCBuZWVkIHRvLgogICAgICAqLwogICAgIGlmICgg
dW5pdC0+aXNfcnVubmluZyApCkBAIC0xNzg1LDMzICsxNzk3LDY2IEBAIHN0YXRpYyB2b2lkIHNj
aGVkX3N3aXRjaF91bml0cyhzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyLAogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICpuZXh0LCBzdHJ1Y3Qgc2NoZWRf
dW5pdCAqcHJldiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzX3RpbWVfdCBub3cp
CiB7Ci0gICAgc3ItPmN1cnIgPSBuZXh0OwotCi0gICAgVFJBQ0VfM0QoVFJDX1NDSEVEX1NXSVRD
SF9JTkZQUkVWLCBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKLSAgICAg
ICAgICAgICBub3cgLSBwcmV2LT5zdGF0ZV9lbnRyeV90aW1lKTsKLSAgICBUUkFDRV80RChUUkNf
U0NIRURfU1dJVENIX0lORk5FWFQsIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0LT51bml0
X2lkLAotICAgICAgICAgICAgIChuZXh0LT52Y3B1X2xpc3QtPnJ1bnN0YXRlLnN0YXRlID09IFJV
TlNUQVRFX3J1bm5hYmxlKSA/Ci0gICAgICAgICAgICAgKG5vdyAtIG5leHQtPnN0YXRlX2VudHJ5
X3RpbWUpIDogMCwgcHJldi0+bmV4dF90aW1lKTsKKyAgICB1bnNpZ25lZCBpbnQgY3B1OwogCiAg
ICAgQVNTRVJUKHVuaXRfcnVubmluZyhwcmV2KSk7CiAKLSAgICBUUkFDRV80RChUUkNfU0NIRURf
U1dJVENILCBwcmV2LT5kb21haW4tPmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKLSAgICAgICAg
ICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCk7CisgICAgaWYgKCBw
cmV2ICE9IG5leHQgKQorICAgIHsKKyAgICAgICAgc3ItPmN1cnIgPSBuZXh0OworICAgICAgICBz
ci0+cHJldiA9IHByZXY7CiAKLSAgICBzY2hlZF91bml0X3J1bnN0YXRlX2NoYW5nZShwcmV2LCBm
YWxzZSwgbm93KTsKKyAgICAgICAgVFJBQ0VfM0QoVFJDX1NDSEVEX1NXSVRDSF9JTkZQUkVWLCBw
cmV2LT5kb21haW4tPmRvbWFpbl9pZCwKKyAgICAgICAgICAgICAgICAgcHJldi0+dW5pdF9pZCwg
bm93IC0gcHJldi0+c3RhdGVfZW50cnlfdGltZSk7CisgICAgICAgIFRSQUNFXzREKFRSQ19TQ0hF
RF9TV0lUQ0hfSU5GTkVYVCwgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsCisgICAgICAgICAgICAg
ICAgIG5leHQtPnVuaXRfaWQsCisgICAgICAgICAgICAgICAgIChuZXh0LT52Y3B1X2xpc3QtPnJ1
bnN0YXRlLnN0YXRlID09IFJVTlNUQVRFX3J1bm5hYmxlKSA/CisgICAgICAgICAgICAgICAgIChu
b3cgLSBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lKSA6IDAsIHByZXYtPm5leHRfdGltZSk7CisgICAg
ICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0gsIHByZXYtPmRvbWFpbi0+ZG9tYWluX2lkLCBw
cmV2LT51bml0X2lkLAorICAgICAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwg
bmV4dC0+dW5pdF9pZCk7CiAKLSAgICBBU1NFUlQoIXVuaXRfcnVubmluZyhuZXh0KSk7Ci0gICAg
c2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2UobmV4dCwgdHJ1ZSwgbm93KTsKKyAgICAgICAgQVNT
RVJUKCF1bml0X3J1bm5pbmcobmV4dCkpOwogCi0gICAgLyoKLSAgICAgKiBOQi4gRG9uJ3QgYWRk
IGFueSB0cmFjZSByZWNvcmRzIGZyb20gaGVyZSB1bnRpbCB0aGUgYWN0dWFsIGNvbnRleHQKLSAg
ICAgKiBzd2l0Y2gsIGVsc2UgbG9zdF9yZWNvcmRzIHJlc3VtZSB3aWxsIG5vdCB3b3JrIHByb3Bl
cmx5LgotICAgICAqLworICAgICAgICAvKgorICAgICAgICAgKiBOQi4gRG9uJ3QgYWRkIGFueSB0
cmFjZSByZWNvcmRzIGZyb20gaGVyZSB1bnRpbCB0aGUgYWN0dWFsIGNvbnRleHQKKyAgICAgICAg
ICogc3dpdGNoLCBlbHNlIGxvc3RfcmVjb3JkcyByZXN1bWUgd2lsbCBub3Qgd29yayBwcm9wZXJs
eS4KKyAgICAgICAgICovCisKKyAgICAgICAgQVNTRVJUKCFuZXh0LT5pc19ydW5uaW5nKTsKKyAg
ICAgICAgbmV4dC0+aXNfcnVubmluZyA9IHRydWU7CisgICAgICAgIG5leHQtPnN0YXRlX2VudHJ5
X3RpbWUgPSBub3c7CisKKyAgICAgICAgaWYgKCBpc19pZGxlX3VuaXQocHJldikgKQorICAgICAg
ICB7CisgICAgICAgICAgICBwcmV2LT5ydW5zdGF0ZV9jbnRbUlVOU1RBVEVfcnVubmluZ10gPSAw
OworICAgICAgICAgICAgcHJldi0+cnVuc3RhdGVfY250W1JVTlNUQVRFX3J1bm5hYmxlXSA9IHNj
aGVkX2dyYW51bGFyaXR5OworICAgICAgICB9CisgICAgICAgIGlmICggaXNfaWRsZV91bml0KG5l
eHQpICkKKyAgICAgICAgeworICAgICAgICAgICAgbmV4dC0+cnVuc3RhdGVfY250W1JVTlNUQVRF
X3J1bm5pbmddID0gc2NoZWRfZ3JhbnVsYXJpdHk7CisgICAgICAgICAgICBuZXh0LT5ydW5zdGF0
ZV9jbnRbUlVOU1RBVEVfcnVubmFibGVdID0gMDsKKyAgICAgICAgfQorICAgIH0KKworICAgIGZv
cl9lYWNoX2NwdSAoIGNwdSwgc3ItPmNwdXMgKQorICAgIHsKKyAgICAgICAgc3RydWN0IHZjcHUg
KnZwcmV2ID0gZ2V0X2NwdV9jdXJyZW50KGNwdSk7CisgICAgICAgIHN0cnVjdCB2Y3B1ICp2bmV4
dCA9IHNjaGVkX3VuaXQydmNwdV9jcHUobmV4dCwgY3B1KTsKKworICAgICAgICBpZiAoIHZwcmV2
ICE9IHZuZXh0IHx8IHZwcmV2LT5ydW5zdGF0ZS5zdGF0ZSAhPSB2bmV4dC0+bmV3X3N0YXRlICkK
KyAgICAgICAgeworICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UodnByZXYsCisgICAg
ICAgICAgICAgICAgKCh2cHJldi0+cGF1c2VfZmxhZ3MgJiBWUEZfYmxvY2tlZCkgPyBSVU5TVEFU
RV9ibG9ja2VkIDoKKyAgICAgICAgICAgICAgICAgKHZjcHVfcnVubmFibGUodnByZXYpID8gUlVO
U1RBVEVfcnVubmFibGUgOiBSVU5TVEFURV9vZmZsaW5lKSksCisgICAgICAgICAgICAgICAgbm93
KTsKKyAgICAgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdlKHZuZXh0LCB2bmV4dC0+bmV3X3N0
YXRlLCBub3cpOworICAgICAgICB9CiAKLSAgICBBU1NFUlQoIW5leHQtPmlzX3J1bm5pbmcpOwot
ICAgIG5leHQtPnZjcHVfbGlzdC0+aXNfcnVubmluZyA9IDE7Ci0gICAgbmV4dC0+aXNfcnVubmlu
ZyA9IHRydWU7Ci0gICAgbmV4dC0+c3RhdGVfZW50cnlfdGltZSA9IG5vdzsKKyAgICAgICAgdm5l
eHQtPmlzX3J1bm5pbmcgPSAxOworCisgICAgICAgIGlmICggaXNfaWRsZV92Y3B1KHZuZXh0KSAp
CisgICAgICAgICAgICB2bmV4dC0+c2NoZWRfdW5pdCA9IG5leHQ7CisgICAgfQogfQogCiBzdGF0
aWMgYm9vbCBzY2hlZF90YXNrbGV0X2NoZWNrX2NwdSh1bnNpZ25lZCBpbnQgY3B1KQpAQCAtMTg2
NywyOSArMTkxMiwzOSBAQCBzdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQgKmRvX3NjaGVkdWxlKHN0
cnVjdCBzY2hlZF91bml0ICpwcmV2LCBzX3RpbWVfdCBub3csCiAgICAgaWYgKCBwcmV2LT5uZXh0
X3RpbWUgPj0gMCApIC8qIC12ZSBtZWFucyBubyBsaW1pdCAqLwogICAgICAgICBzZXRfdGltZXIo
JnNyLT5zX3RpbWVyLCBub3cgKyBwcmV2LT5uZXh0X3RpbWUpOwogCi0gICAgaWYgKCBsaWtlbHko
cHJldiAhPSBuZXh0KSApCi0gICAgICAgIHNjaGVkX3N3aXRjaF91bml0cyhzciwgbmV4dCwgcHJl
diwgbm93KTsKKyAgICBzY2hlZF9zd2l0Y2hfdW5pdHMoc3IsIG5leHQsIHByZXYsIG5vdyk7CiAK
ICAgICByZXR1cm4gbmV4dDsKIH0KIAotc3RhdGljIHZvaWQgY29udGV4dF9zYXZlZChzdHJ1Y3Qg
dmNwdSAqcHJldikKK3N0YXRpYyB2b2lkIHZjcHVfY29udGV4dF9zYXZlZChzdHJ1Y3QgdmNwdSAq
dnByZXYsIHN0cnVjdCB2Y3B1ICp2bmV4dCkKIHsKLSAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5p
dCA9IHByZXYtPnNjaGVkX3VuaXQ7Ci0KICAgICAvKiBDbGVhciBydW5uaW5nIGZsYWcgL2FmdGVy
LyB3cml0aW5nIGNvbnRleHQgdG8gbWVtb3J5LiAqLwogICAgIHNtcF93bWIoKTsKIAotICAgIHBy
ZXYtPmlzX3J1bm5pbmcgPSAwOworICAgIGlmICggdnByZXYgIT0gdm5leHQgKQorICAgICAgICB2
cHJldi0+aXNfcnVubmluZyA9IDA7Cit9CisKK3N0YXRpYyB2b2lkIHVuaXRfY29udGV4dF9zYXZl
ZChzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyKQoreworICAgIHN0cnVjdCBzY2hlZF91bml0ICp1
bml0ID0gc3ItPnByZXY7CisKKyAgICBpZiAoICF1bml0ICkKKyAgICAgICAgcmV0dXJuOworCiAg
ICAgdW5pdC0+aXNfcnVubmluZyA9IGZhbHNlOwogICAgIHVuaXQtPnN0YXRlX2VudHJ5X3RpbWUg
PSBOT1coKTsKKyAgICBzci0+cHJldiA9IE5VTEw7CiAKICAgICAvKiBDaGVjayBmb3IgbWlncmF0
aW9uIHJlcXVlc3QgL2FmdGVyLyBjbGVhcmluZyBydW5uaW5nIGZsYWcuICovCiAgICAgc21wX21i
KCk7CiAKLSAgICBzY2hlZF9jb250ZXh0X3NhdmVkKHZjcHVfc2NoZWR1bGVyKHByZXYpLCB1bml0
KTsKKyAgICBzY2hlZF9jb250ZXh0X3NhdmVkKHVuaXRfc2NoZWR1bGVyKHVuaXQpLCB1bml0KTsK
IAotICAgIHNjaGVkX3VuaXRfbWlncmF0ZV9maW5pc2godW5pdCk7CisgICAgLyogSWRsZSBuZXZl
ciBtaWdyYXRlcyBhbmQgaWRsZSB2Y3B1cyBtaWdodCBiZWxvbmcgdG8gb3RoZXIgdW5pdHMuICov
CisgICAgaWYgKCAhaXNfaWRsZV91bml0KHVuaXQpICkKKyAgICAgICAgc2NoZWRfdW5pdF9taWdy
YXRlX2ZpbmlzaCh1bml0KTsKIH0KIAogLyoKQEAgLTE4OTksMzUgKzE5NTQsNDQgQEAgc3RhdGlj
IHZvaWQgY29udGV4dF9zYXZlZChzdHJ1Y3QgdmNwdSAqcHJldikKICAqIFRoZSBjb3VudGVyIHdp
bGwgYmUgMCBpbiBjYXNlIG5vIHJlbmRlenZvdXMgaXMgbmVlZGVkLiBGb3IgdGhlIHJlbmRlenZv
dXMKICAqIGNhc2UgaXQgaXMgaW5pdGlhbGlzZWQgdG8gdGhlIG51bWJlciBvZiBjcHVzIHRvIHJl
bmRlenZvdXMgcGx1cyAxLiBFYWNoCiAgKiBtZW1iZXIgZW50ZXJpbmcgZGVjcmVtZW50cyB0aGUg
Y291bnRlci4gVGhlIGxhc3Qgb25lIHdpbGwgZGVjcmVtZW50IGl0IHRvCi0gKiAxIGFuZCBwZXJm
b3JtIHRoZSBmaW5hbCBuZWVkZWQgYWN0aW9uIGluIHRoYXQgY2FzZSAoY2FsbCBvZiBjb250ZXh0
X3NhdmVkKCkKLSAqIGlmIHZjcHUgd2FzIHN3aXRjaGVkKSwgYW5kIHRoZW4gc2V0IHRoZSBjb3Vu
dGVyIHRvIHplcm8uIFRoZSBvdGhlciBtZW1iZXJzCisgKiAxIGFuZCBwZXJmb3JtIHRoZSBmaW5h
bCBuZWVkZWQgYWN0aW9uIGluIHRoYXQgY2FzZSAoY2FsbCBvZgorICogdW5pdF9jb250ZXh0X3Nh
dmVkKCkpLCBhbmQgdGhlbiBzZXQgdGhlIGNvdW50ZXIgdG8gemVyby4gVGhlIG90aGVyIG1lbWJl
cnMKICAqIHdpbGwgd2FpdCB1bnRpbCB0aGUgY291bnRlciBiZWNvbWVzIHplcm8gdW50aWwgdGhl
eSBwcm9jZWVkLgogICovCiB2b2lkIHNjaGVkX2NvbnRleHRfc3dpdGNoZWQoc3RydWN0IHZjcHUg
KnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQpCiB7CiAgICAgc3RydWN0IHNjaGVkX3VuaXQgKm5l
eHQgPSB2bmV4dC0+c2NoZWRfdW5pdDsKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNyID0g
Z2V0X3NjaGVkX3JlcyhzbXBfcHJvY2Vzc29yX2lkKCkpOwogCiAgICAgaWYgKCBhdG9taWNfcmVh
ZCgmbmV4dC0+cmVuZGV6dm91c19vdXRfY250KSApCiAgICAgewogICAgICAgICBpbnQgY250ID0g
YXRvbWljX2RlY19yZXR1cm4oJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCk7CiAKLSAgICAgICAg
LyogQ2FsbCBjb250ZXh0X3NhdmVkKCkgYmVmb3JlIHJlbGVhc2luZyBvdGhlciB3YWl0ZXJzLiAq
LworICAgICAgICB2Y3B1X2NvbnRleHRfc2F2ZWQodnByZXYsIHZuZXh0KTsKKworICAgICAgICAv
KiBDYWxsIHVuaXRfY29udGV4dF9zYXZlZCgpIGJlZm9yZSByZWxlYXNpbmcgb3RoZXIgd2FpdGVy
cy4gKi8KICAgICAgICAgaWYgKCBjbnQgPT0gMSApCiAgICAgICAgIHsKLSAgICAgICAgICAgIGlm
ICggdnByZXYgIT0gdm5leHQgKQotICAgICAgICAgICAgICAgIGNvbnRleHRfc2F2ZWQodnByZXYp
OworICAgICAgICAgICAgdW5pdF9jb250ZXh0X3NhdmVkKHNyKTsKICAgICAgICAgICAgIGF0b21p
Y19zZXQoJm5leHQtPnJlbmRlenZvdXNfb3V0X2NudCwgMCk7CiAgICAgICAgIH0KICAgICAgICAg
ZWxzZQogICAgICAgICAgICAgd2hpbGUgKCBhdG9taWNfcmVhZCgmbmV4dC0+cmVuZGV6dm91c19v
dXRfY250KSApCiAgICAgICAgICAgICAgICAgY3B1X3JlbGF4KCk7CiAgICAgfQotICAgIGVsc2Ug
aWYgKCB2cHJldiAhPSB2bmV4dCAmJiBzY2hlZF9ncmFudWxhcml0eSA9PSAxICkKLSAgICAgICAg
Y29udGV4dF9zYXZlZCh2cHJldik7CisgICAgZWxzZQorICAgIHsKKyAgICAgICAgdmNwdV9jb250
ZXh0X3NhdmVkKHZwcmV2LCB2bmV4dCk7CisgICAgICAgIGlmICggc2NoZWRfZ3JhbnVsYXJpdHkg
PT0gMSApCisgICAgICAgICAgICB1bml0X2NvbnRleHRfc2F2ZWQoc3IpOworICAgIH0KKworICAg
IGlmICggaXNfaWRsZV92Y3B1KHZwcmV2KSAmJiB2cHJldiAhPSB2bmV4dCApCisgICAgICAgIHZw
cmV2LT5zY2hlZF91bml0ID0gc3ItPnNjaGVkX3VuaXRfaWRsZTsKIH0KIAogc3RhdGljIHZvaWQg
c2NoZWRfY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5l
eHQsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzX3RpbWVfdCBub3cpCisgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib29sIHJlc2V0X2lkbGVfdW5pdCwgc190aW1l
X3Qgbm93KQogewogICAgIGlmICggdW5saWtlbHkodnByZXYgPT0gdm5leHQpICkKICAgICB7CkBA
IC0xOTM2LDYgKzIwMDAsMTcgQEAgc3RhdGljIHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2goc3Ry
dWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNwdSAqdm5leHQsCiAgICAgICAgICAgICAgICAgIG5v
dyAtIHZwcmV2LT5ydW5zdGF0ZS5zdGF0ZV9lbnRyeV90aW1lLAogICAgICAgICAgICAgICAgICB2
cHJldi0+c2NoZWRfdW5pdC0+bmV4dF90aW1lKTsKICAgICAgICAgc2NoZWRfY29udGV4dF9zd2l0
Y2hlZCh2cHJldiwgdm5leHQpOworCisgICAgICAgIC8qCisgICAgICAgICAqIFdlIGFyZSBzd2l0
Y2hpbmcgZnJvbSBhIG5vbi1pZGxlIHRvIGFuIGlkbGUgdW5pdC4KKyAgICAgICAgICogQSB2Y3B1
IG9mIHRoZSBpZGxlIHVuaXQgbWlnaHQgaGF2ZSBiZWVuIHJ1bm5pbmcgYmVmb3JlIGR1ZSB0bwor
ICAgICAgICAgKiB0aGUgZ3Vlc3QgdmNwdSBiZWluZyBibG9ja2VkLiBXZSBtdXN0IGFkanVzdCB0
aGUgdW5pdCBvZiB0aGUgaWRsZQorICAgICAgICAgKiB2Y3B1IHdoaWNoIG1pZ2h0IGhhdmUgYmVl
biBzZXQgdG8gdGhlIGd1ZXN0J3Mgb25lLgorICAgICAgICAgKi8KKyAgICAgICAgaWYgKCByZXNl
dF9pZGxlX3VuaXQgKQorICAgICAgICAgICAgdm5leHQtPnNjaGVkX3VuaXQgPQorICAgICAgICAg
ICAgICAgIGdldF9zY2hlZF9yZXMoc21wX3Byb2Nlc3Nvcl9pZCgpKS0+c2NoZWRfdW5pdF9pZGxl
OworCiAgICAgICAgIHRyYWNlX2NvbnRpbnVlX3J1bm5pbmcodm5leHQpOwogICAgICAgICByZXR1
cm4gY29udGludWVfcnVubmluZyh2cHJldik7CiAgICAgfQpAQCAtMTk5NCw3ICsyMDY5LDcgQEAg
c3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF93YWl0X3JlbmRlenZvdXNfaW4oc3RydWN0
IHNjaGVkX3VuaXQgKnByZXYsCiAgICAgICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEo
KmxvY2ssIGNwdSk7CiAKICAgICAgICAgICAgIHJhaXNlX3NvZnRpcnEoU0NIRURfU0xBVkVfU09G
VElSUSk7Ci0gICAgICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgdnByZXYsIG5v
dyk7CisgICAgICAgICAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgdnByZXYsIGZhbHNl
LCBub3cpOwogCiAgICAgICAgICAgICByZXR1cm4gTlVMTDsgICAgICAgICAvKiBBUk0gb25seS4g
Ki8KICAgICAgICAgfQpAQCAtMjAzNyw3ICsyMTEyLDggQEAgc3RhdGljIHZvaWQgc2NoZWRfc2xh
dmUodm9pZCkKIAogICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOwogCi0g
ICAgc2NoZWRfY29udGV4dF9zd2l0Y2godnByZXYsIHNjaGVkX3VuaXQydmNwdV9jcHUobmV4dCwg
Y3B1KSwgbm93KTsKKyAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgc2NoZWRfdW5pdDJ2
Y3B1X2NwdShuZXh0LCBjcHUpLAorICAgICAgICAgICAgICAgICAgICAgICAgIGlzX2lkbGVfdW5p
dChuZXh0KSAmJiAhaXNfaWRsZV91bml0KHByZXYpLCBub3cpOwogfQogCiAvKgpAQCAtMjA5OSw3
ICsyMTc1LDggQEAgc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKICAgICBwY3B1X3NjaGVkdWxl
X3VubG9ja19pcnEobG9jaywgY3B1KTsKIAogICAgIHZuZXh0ID0gc2NoZWRfdW5pdDJ2Y3B1X2Nw
dShuZXh0LCBjcHUpOwotICAgIHNjaGVkX2NvbnRleHRfc3dpdGNoKHZwcmV2LCB2bmV4dCwgbm93
KTsKKyAgICBzY2hlZF9jb250ZXh0X3N3aXRjaCh2cHJldiwgdm5leHQsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgIWlzX2lkbGVfdW5pdChwcmV2KSAmJiBpc19pZGxlX3VuaXQobmV4dCksIG5v
dyk7CiB9CiAKIC8qIFRoZSBzY2hlZHVsZXIgdGltZXI6IGZvcmNlIGEgcnVuIHRocm91Z2ggdGhl
IHNjaGVkdWxlciAqLwpAQCAtMjE3MCw2ICsyMjQ3LDcgQEAgc3RhdGljIGludCBjcHVfc2NoZWR1
bGVfdXAodW5zaWduZWQgaW50IGNwdSkKICAgICAgKi8KIAogICAgIHNyLT5jdXJyID0gaWRsZV92
Y3B1W2NwdV0tPnNjaGVkX3VuaXQ7CisgICAgc3ItPnNjaGVkX3VuaXRfaWRsZSA9IGlkbGVfdmNw
dVtjcHVdLT5zY2hlZF91bml0OwogCiAgICAgc3ItPnNjaGVkX3ByaXYgPSBOVUxMOwogCkBAIC0y
MzM5LDYgKzI0MTcsNyBAQCB2b2lkIF9faW5pdCBzY2hlZHVsZXJfaW5pdCh2b2lkKQogICAgIGlm
ICggdmNwdV9jcmVhdGUoaWRsZV9kb21haW4sIDApID09IE5VTEwgKQogICAgICAgICBCVUcoKTsK
ICAgICBnZXRfc2NoZWRfcmVzKDApLT5jdXJyID0gaWRsZV92Y3B1WzBdLT5zY2hlZF91bml0Owor
ICAgIGdldF9zY2hlZF9yZXMoMCktPnNjaGVkX3VuaXRfaWRsZSA9IGlkbGVfdmNwdVswXS0+c2No
ZWRfdW5pdDsKIH0KIAogLyoKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL2FzbS1hcm0vY3VycmVu
dC5oIGIveGVuL2luY2x1ZGUvYXNtLWFybS9jdXJyZW50LmgKaW5kZXggMTY1M2U4OWQzMC4uODhi
ZWI0NjQ1YSAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUvYXNtLWFybS9jdXJyZW50LmgKKysrIGIv
eGVuL2luY2x1ZGUvYXNtLWFybS9jdXJyZW50LmgKQEAgLTE4LDYgKzE4LDcgQEAgREVDTEFSRV9Q
RVJfQ1BVKHN0cnVjdCB2Y3B1ICosIGN1cnJfdmNwdSk7CiAKICNkZWZpbmUgY3VycmVudCAgICAg
ICAgICAgICh0aGlzX2NwdShjdXJyX3ZjcHUpKQogI2RlZmluZSBzZXRfY3VycmVudCh2Y3B1KSAg
ZG8geyBjdXJyZW50ID0gKHZjcHUpOyB9IHdoaWxlICgwKQorI2RlZmluZSBnZXRfY3B1X2N1cnJl
bnQoY3B1KSAgKHBlcl9jcHUoY3Vycl92Y3B1LCBjcHUpKQogCiAvKiBQZXItVkNQVSBzdGF0ZSB0
aGF0IGxpdmVzIGF0IHRoZSB0b3Agb2YgdGhlIHN0YWNrICovCiBzdHJ1Y3QgY3B1X2luZm8gewpk
aWZmIC0tZ2l0IGEveGVuL2luY2x1ZGUvYXNtLXg4Ni9jdXJyZW50LmggYi94ZW4vaW5jbHVkZS9h
c20teDg2L2N1cnJlbnQuaAppbmRleCBmMzUwOGMzYzA4Li4wYjQ3NDg1MzM3IDEwMDY0NAotLS0g
YS94ZW4vaW5jbHVkZS9hc20teDg2L2N1cnJlbnQuaAorKysgYi94ZW4vaW5jbHVkZS9hc20teDg2
L2N1cnJlbnQuaApAQCAtNzcsNiArNzcsMTEgQEAgc3RydWN0IGNwdV9pbmZvIHsKICAgICAvKiBn
ZXRfc3RhY2tfYm90dG9tKCkgbXVzdCBiZSAxNi1ieXRlIGFsaWduZWQgKi8KIH07CiAKK3N0YXRp
YyBpbmxpbmUgc3RydWN0IGNwdV9pbmZvICpnZXRfY3B1X2luZm9fZnJvbV9zdGFjayh1bnNpZ25l
ZCBsb25nIHNwKQoreworICAgIHJldHVybiAoc3RydWN0IGNwdV9pbmZvICopKChzcCB8IChTVEFD
S19TSVpFIC0gMSkpICsgMSkgLSAxOworfQorCiBzdGF0aWMgaW5saW5lIHN0cnVjdCBjcHVfaW5m
byAqZ2V0X2NwdV9pbmZvKHZvaWQpCiB7CiAjaWZkZWYgX19jbGFuZ19fCkBAIC04Nyw3ICs5Miw3
IEBAIHN0YXRpYyBpbmxpbmUgc3RydWN0IGNwdV9pbmZvICpnZXRfY3B1X2luZm8odm9pZCkKICAg
ICByZWdpc3RlciB1bnNpZ25lZCBsb25nIHNwIGFzbSgicnNwIik7CiAjZW5kaWYKIAotICAgIHJl
dHVybiAoc3RydWN0IGNwdV9pbmZvICopKChzcCB8IChTVEFDS19TSVpFIC0gMSkpICsgMSkgLSAx
OworICAgIHJldHVybiBnZXRfY3B1X2luZm9fZnJvbV9zdGFjayhzcCk7CiB9CiAKICNkZWZpbmUg
Z2V0X2N1cnJlbnQoKSAgICAgICAgIChnZXRfY3B1X2luZm8oKS0+Y3VycmVudF92Y3B1KQpAQCAt
MTI0LDE2ICsxMjksMjIgQEAgdW5zaWduZWQgbG9uZyBnZXRfc3RhY2tfZHVtcF9ib3R0b20gKHVu
c2lnbmVkIGxvbmcgc3ApOwogIyBkZWZpbmUgQ0hFQ0tfRk9SX0xJVkVQQVRDSF9XT1JLICIiCiAj
ZW5kaWYKIAotI2RlZmluZSByZXNldF9zdGFja19hbmRfanVtcChfX2ZuKSAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgXAorI2RlZmluZSBzd2l0Y2hfc3RhY2tfYW5kX2p1bXAo
Zm4sIGluc3RyKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICh7ICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgXAogICAgICAgICBfX2FzbV9fIF9fdm9sYXRpbGVfXyAoICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICAgICAgIm1vdiAlMCwlJSJfX09QInNwOyIg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAotICAgICAgICAgICAgQ0hF
Q0tfRk9SX0xJVkVQQVRDSF9XT1JLICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBcCisgICAgICAgICAgICBpbnN0ciAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgICAgICAgImptcCAlYzEiICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCi0gICAgICAgICAgICA6IDog
InIiIChndWVzdF9jcHVfdXNlcl9yZWdzKCkpLCAiaSIgKF9fZm4pIDogIm1lbW9yeSIgKTsgICBc
CisgICAgICAgICAgICA6IDogInIiIChndWVzdF9jcHVfdXNlcl9yZWdzKCkpLCAiaSIgKGZuKSA6
ICJtZW1vcnkiICk7ICAgICBcCiAgICAgICAgIHVucmVhY2hhYmxlKCk7ICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgfSkKIAorI2RlZmluZSBy
ZXNldF9zdGFja19hbmRfanVtcChmbikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgXAorICAgIHN3aXRjaF9zdGFja19hbmRfanVtcChmbiwgQ0hFQ0tfRk9SX0xJVkVQQVRD
SF9XT1JLKQorCisjZGVmaW5lIHJlc2V0X3N0YWNrX2FuZF9qdW1wX25vbHAoZm4pICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBcCisgICAgc3dpdGNoX3N0YWNrX2FuZF9qdW1wKGZu
LCAiIikKKwogLyoKICAqIFdoaWNoIFZDUFUncyBzdGF0ZSBpcyBjdXJyZW50bHkgcnVubmluZyBv
biBlYWNoIENQVT8KICAqIFRoaXMgaXMgbm90IG5lY2VzYXNyaWx5IHRoZSBzYW1lIGFzICdjdXJy
ZW50JyBhcyBhIENQVSBtYXkgYmUKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL2FzbS14ODYvc21w
LmggYi94ZW4vaW5jbHVkZS9hc20teDg2L3NtcC5oCmluZGV4IDYxNDQ2ZDBlZmQuLmRiZWVkMmZk
NDEgMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL2FzbS14ODYvc21wLmgKKysrIGIveGVuL2luY2x1
ZGUvYXNtLXg4Ni9zbXAuaApAQCAtNzcsNiArNzcsMTMgQEAgdm9pZCBzZXRfbnJfc29ja2V0cyh2
b2lkKTsKIC8qIFJlcHJlc2VudGluZyBIVCBhbmQgY29yZSBzaWJsaW5ncyBpbiBlYWNoIHNvY2tl
dC4gKi8KIGV4dGVybiBjcHVtYXNrX3QgKipzb2NrZXRfY3B1bWFzazsKIAorLyoKKyAqIFRvIGJl
IHVzZWQgb25seSB3aGlsZSBubyBjb250ZXh0IHN3aXRjaCBjYW4gb2NjdXIgb24gdGhlIGNwdSwg
aS5lLgorICogYnkgY2VydGFpbiBzY2hlZHVsaW5nIGNvZGUgb25seS4KKyAqLworI2RlZmluZSBn
ZXRfY3B1X2N1cnJlbnQoY3B1KSBcCisgICAgKGdldF9jcHVfaW5mb19mcm9tX3N0YWNrKCh1bnNp
Z25lZCBsb25nKXN0YWNrX2Jhc2VbY3B1XSktPmN1cnJlbnRfdmNwdSkKKwogI2VuZGlmIC8qICFf
X0FTU0VNQkxZX18gKi8KIAogI2VuZGlmCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS94ZW4vc2No
ZWQtaWYuaCBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCmluZGV4IDFiMjk2YjE1MGYuLjQx
YTEwODNhMDggMTAwNjQ0Ci0tLSBhL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCisrKyBiL3hl
bi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oCkBAIC0zOSw2ICszOSw4IEBAIHN0cnVjdCBzY2hlZF9y
ZXNvdXJjZSB7CiAgICAgc3BpbmxvY2tfdCAgICAgICAgICpzY2hlZHVsZV9sb2NrLAogICAgICAg
ICAgICAgICAgICAgICAgICBfbG9jazsKICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAgKmN1cnI7Cisg
ICAgc3RydWN0IHNjaGVkX3VuaXQgICpzY2hlZF91bml0X2lkbGU7CisgICAgc3RydWN0IHNjaGVk
X3VuaXQgICpwcmV2OwogICAgIHZvaWQgICAgICAgICAgICAgICAqc2NoZWRfcHJpdjsKICAgICBz
dHJ1Y3QgdGltZXIgICAgICAgIHNfdGltZXI7ICAgICAgICAvKiBzY2hlZHVsaW5nIHRpbWVyICAg
ICAgICAgICAgICAgICovCiAKQEAgLTE5NCw3ICsxOTYsNyBAQCBzdGF0aWMgaW5saW5lIHZvaWQg
c2NoZWRfY2xlYXJfcGF1c2VfZmxhZ3NfYXRvbWljKHN0cnVjdCBzY2hlZF91bml0ICp1bml0LAog
CiBzdGF0aWMgaW5saW5lIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9pZGxlX3VuaXQodW5zaWdu
ZWQgaW50IGNwdSkKIHsKLSAgICByZXR1cm4gaWRsZV92Y3B1W2NwdV0tPnNjaGVkX3VuaXQ7Cisg
ICAgcmV0dXJuIGdldF9zY2hlZF9yZXMoY3B1KS0+c2NoZWRfdW5pdF9pZGxlOwogfQogCiBzdGF0
aWMgaW5saW5lIHVuc2lnbmVkIGludCBzY2hlZF9nZXRfcmVzb3VyY2VfY3B1KHVuc2lnbmVkIGlu
dCBjcHUpCmRpZmYgLS1naXQgYS94ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCBiL3hlbi9pbmNsdWRl
L3hlbi9zY2hlZC5oCmluZGV4IDEyZjAwY2Q3OGQuLmNlNDMyOWRiNzIgMTAwNjQ0Ci0tLSBhL3hl
bi9pbmNsdWRlL3hlbi9zY2hlZC5oCisrKyBiL3hlbi9pbmNsdWRlL3hlbi9zY2hlZC5oCkBAIC05
MjksNiArOTI5LDcgQEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAq
ZCk7CiAKIHZvaWQgdmNwdV9ydW5zdGF0ZV9nZXQoc3RydWN0IHZjcHUgKnYsIHN0cnVjdCB2Y3B1
X3J1bnN0YXRlX2luZm8gKnJ1bnN0YXRlKTsKIHVpbnQ2NF90IGdldF9jcHVfaWRsZV90aW1lKHVu
c2lnbmVkIGludCBjcHUpOwordm9pZCBzY2hlZF9ndWVzdF9pZGxlKHZvaWQgKCppZGxlKSAodm9p
ZCksIHVuc2lnbmVkIGludCBjcHUpOwogCiAvKgogICogVXNlZCBieSBpZGxlIGxvb3AgdG8gZGVj
aWRlIHdoZXRoZXIgdGhlcmUgaXMgd29yayB0byBkbzoKLS0gCjIuMTYuNAoKCl9fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxp
c3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVj
dC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

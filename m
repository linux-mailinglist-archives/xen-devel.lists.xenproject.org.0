Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 7C5E4B2AAF
	for <lists+xen-devel@lfdr.de>; Sat, 14 Sep 2019 10:57:09 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i93op-0000bV-Ff; Sat, 14 Sep 2019 08:54:11 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=rDpt=XJ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1i93om-0000Xr-M6
 for xen-devel@lists.xenproject.org; Sat, 14 Sep 2019 08:54:08 +0000
X-Inumbo-ID: 0fccd2da-d6cd-11e9-95c1-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 0fccd2da-d6cd-11e9-95c1-12813bfff9fa;
 Sat, 14 Sep 2019 08:53:03 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 9C48DB66C;
 Sat, 14 Sep 2019 08:53:01 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Sat, 14 Sep 2019 10:52:26 +0200
Message-Id: <20190914085251.18816-23-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190914085251.18816-1-jgross@suse.com>
References: <20190914085251.18816-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v3 22/47] xen/sched: switch schedule() from
 vcpus to sched_units
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VXNlIHNjaGVkX3VuaXRzIGluc3RlYWQgb2YgdmNwdXMgaW4gc2NoZWR1bGUoKS4gVGhpcyBpbmNs
dWRlcyB0aGUKaW50cm9kdWN0aW9uIG9mIHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hhbmdlKCkgYXMg
YSByZXBsYWNlbWVudCBvZgp2Y3B1X3J1bnN0YXRlX2NoYW5nZSgpIGluIHNjaGVkdWxlKCkuCgpT
aWduZWQtb2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+Ci0tLQpOb3RlIHRo
YXQgc2NoZWRfdW5pdF9ydW5zdGF0ZV9jaGFuZ2UoKSB3aWxsIGJlIHN1YnN1bWVkIGJ5IGFub3Ro
ZXIKcmV3b3JrIGluIGEgbGF0ZXIgcGF0Y2guCi0tLQogeGVuL2NvbW1vbi9zY2hlZHVsZS5jIHwg
NjggKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAx
IGZpbGUgY2hhbmdlZCwgMzkgaW5zZXJ0aW9ucygrKSwgMjkgZGVsZXRpb25zKC0pCgpkaWZmIC0t
Z2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCmluZGV4
IDc0NzY5ZjJmOWIuLjIyNzIxOTJkNDkgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWR1bGUu
YworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTI1MSw2ICsyNTEsMjAgQEAgc3RhdGlj
IGlubGluZSB2b2lkIHZjcHVfcnVuc3RhdGVfY2hhbmdlKAogICAgIHYtPnJ1bnN0YXRlLnN0YXRl
ID0gbmV3X3N0YXRlOwogfQogCitzdGF0aWMgaW5saW5lIHZvaWQgc2NoZWRfdW5pdF9ydW5zdGF0
ZV9jaGFuZ2Uoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAgYm9vbCBydW5uaW5nLCBzX3Rp
bWVfdCBuZXdfZW50cnlfdGltZSkKK3sKKyAgICBzdHJ1Y3QgdmNwdSAqdiA9IHVuaXQtPnZjcHVf
bGlzdDsKKworICAgIGlmICggcnVubmluZyApCisgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdl
KHYsIFJVTlNUQVRFX3J1bm5pbmcsIG5ld19lbnRyeV90aW1lKTsKKyAgICBlbHNlCisgICAgICAg
IHZjcHVfcnVuc3RhdGVfY2hhbmdlKHYsCisgICAgICAgICAgICAoKHYtPnBhdXNlX2ZsYWdzICYg
VlBGX2Jsb2NrZWQpID8gUlVOU1RBVEVfYmxvY2tlZCA6CisgICAgICAgICAgICAgKHZjcHVfcnVu
bmFibGUodikgPyBSVU5TVEFURV9ydW5uYWJsZSA6IFJVTlNUQVRFX29mZmxpbmUpKSwKKyAgICAg
ICAgICAgIG5ld19lbnRyeV90aW1lKTsKK30KKwogdm9pZCB2Y3B1X3J1bnN0YXRlX2dldChzdHJ1
Y3QgdmNwdSAqdiwgc3RydWN0IHZjcHVfcnVuc3RhdGVfaW5mbyAqcnVuc3RhdGUpCiB7CiAgICAg
c3BpbmxvY2tfdCAqbG9jayA9IGxpa2VseSh2ID09IGN1cnJlbnQpCkBAIC0xNjIzLDcgKzE2Mzcs
NyBAQCB2b2lkIHZjcHVfc2V0X3BlcmlvZGljX3RpbWVyKHN0cnVjdCB2Y3B1ICp2LCBzX3RpbWVf
dCB2YWx1ZSkKICAqLwogc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKIHsKLSAgICBzdHJ1Y3Qg
dmNwdSAgICAgICAgICAqcHJldiA9IGN1cnJlbnQsICpuZXh0ID0gTlVMTDsKKyAgICBzdHJ1Y3Qg
c2NoZWRfdW5pdCAgICAqcHJldiA9IGN1cnJlbnQtPnNjaGVkX3VuaXQsICpuZXh0ID0gTlVMTDsK
ICAgICBzX3RpbWVfdCAgICAgICAgICAgICAgbm93OwogICAgIHN0cnVjdCBzY2hlZHVsZXIgICAg
ICpzY2hlZDsKICAgICB1bnNpZ25lZCBsb25nICAgICAgICAqdGFza2xldF93b3JrID0gJnRoaXNf
Y3B1KHRhc2tsZXRfd29ya190b19kbyk7CkBAIC0xNjY3LDkgKzE2ODEsOSBAQCBzdGF0aWMgdm9p
ZCBzY2hlZHVsZSh2b2lkKQogICAgIHNjaGVkID0gdGhpc19jcHUoc2NoZWR1bGVyKTsKICAgICBu
ZXh0X3NsaWNlID0gc2NoZWQtPmRvX3NjaGVkdWxlKHNjaGVkLCBub3csIHRhc2tsZXRfd29ya19z
Y2hlZHVsZWQpOwogCi0gICAgbmV4dCA9IG5leHRfc2xpY2UudGFzay0+dmNwdV9saXN0OworICAg
IG5leHQgPSBuZXh0X3NsaWNlLnRhc2s7CiAKLSAgICBzZC0+Y3VyciA9IG5leHQtPnNjaGVkX3Vu
aXQ7CisgICAgc2QtPmN1cnIgPSBuZXh0OwogCiAgICAgaWYgKCBuZXh0X3NsaWNlLnRpbWUgPj0g
MCApIC8qIC12ZSBtZWFucyBubyBsaW1pdCAqLwogICAgICAgICBzZXRfdGltZXIoJnNkLT5zX3Rp
bWVyLCBub3cgKyBuZXh0X3NsaWNlLnRpbWUpOwpAQCAtMTY3OCw1OSArMTY5Miw1NSBAQCBzdGF0
aWMgdm9pZCBzY2hlZHVsZSh2b2lkKQogICAgIHsKICAgICAgICAgcGNwdV9zY2hlZHVsZV91bmxv
Y2tfaXJxKGxvY2ssIGNwdSk7CiAgICAgICAgIFRSQUNFXzREKFRSQ19TQ0hFRF9TV0lUQ0hfSU5G
Q09OVCwKLSAgICAgICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQtPnZj
cHVfaWQsCi0gICAgICAgICAgICAgICAgIG5vdyAtIHByZXYtPnJ1bnN0YXRlLnN0YXRlX2VudHJ5
X3RpbWUsCisgICAgICAgICAgICAgICAgIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0LT51
bml0X2lkLAorICAgICAgICAgICAgICAgICBub3cgLSBwcmV2LT5zdGF0ZV9lbnRyeV90aW1lLAog
ICAgICAgICAgICAgICAgICBuZXh0X3NsaWNlLnRpbWUpOwotICAgICAgICB0cmFjZV9jb250aW51
ZV9ydW5uaW5nKG5leHQpOwotICAgICAgICByZXR1cm4gY29udGludWVfcnVubmluZyhwcmV2KTsK
KyAgICAgICAgdHJhY2VfY29udGludWVfcnVubmluZyhuZXh0LT52Y3B1X2xpc3QpOworICAgICAg
ICByZXR1cm4gY29udGludWVfcnVubmluZyhwcmV2LT52Y3B1X2xpc3QpOwogICAgIH0KIAogICAg
IFRSQUNFXzNEKFRSQ19TQ0hFRF9TV0lUQ0hfSU5GUFJFViwKLSAgICAgICAgICAgICBwcmV2LT5k
b21haW4tPmRvbWFpbl9pZCwgcHJldi0+dmNwdV9pZCwKLSAgICAgICAgICAgICBub3cgLSBwcmV2
LT5ydW5zdGF0ZS5zdGF0ZV9lbnRyeV90aW1lKTsKKyAgICAgICAgICAgICBwcmV2LT5kb21haW4t
PmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKKyAgICAgICAgICAgICBub3cgLSBwcmV2LT5zdGF0
ZV9lbnRyeV90aW1lKTsKICAgICBUUkFDRV80RChUUkNfU0NIRURfU1dJVENIX0lORk5FWFQsCi0g
ICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQtPnZjcHVfaWQsCi0gICAg
ICAgICAgICAgKG5leHQtPnJ1bnN0YXRlLnN0YXRlID09IFJVTlNUQVRFX3J1bm5hYmxlKSA/Ci0g
ICAgICAgICAgICAgKG5vdyAtIG5leHQtPnJ1bnN0YXRlLnN0YXRlX2VudHJ5X3RpbWUpIDogMCwK
KyAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFpbl9pZCwgbmV4dC0+dW5pdF9pZCwKKyAg
ICAgICAgICAgICAobmV4dC0+dmNwdV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9y
dW5uYWJsZSkgPworICAgICAgICAgICAgIChub3cgLSBuZXh0LT5zdGF0ZV9lbnRyeV90aW1lKSA6
IDAsCiAgICAgICAgICAgICAgbmV4dF9zbGljZS50aW1lKTsKIAotICAgIEFTU0VSVChwcmV2LT5y
dW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uaW5nKTsKKyAgICBBU1NFUlQocHJldi0+dmNw
dV9saXN0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uaW5nKTsKIAogICAgIFRSQUNF
XzREKFRSQ19TQ0hFRF9TV0lUQ0gsCi0gICAgICAgICAgICAgcHJldi0+ZG9tYWluLT5kb21haW5f
aWQsIHByZXYtPnZjcHVfaWQsCi0gICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQs
IG5leHQtPnZjcHVfaWQpOworICAgICAgICAgICAgIHByZXYtPmRvbWFpbi0+ZG9tYWluX2lkLCBw
cmV2LT51bml0X2lkLAorICAgICAgICAgICAgIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0
LT51bml0X2lkKTsKIAotICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdlKAotICAgICAgICBwcmV2LAot
ICAgICAgICAoKHByZXYtPnBhdXNlX2ZsYWdzICYgVlBGX2Jsb2NrZWQpID8gUlVOU1RBVEVfYmxv
Y2tlZCA6Ci0gICAgICAgICAodmNwdV9ydW5uYWJsZShwcmV2KSA/IFJVTlNUQVRFX3J1bm5hYmxl
IDogUlVOU1RBVEVfb2ZmbGluZSkpLAotICAgICAgICBub3cpOworICAgIHNjaGVkX3VuaXRfcnVu
c3RhdGVfY2hhbmdlKHByZXYsIGZhbHNlLCBub3cpOwogCi0gICAgQVNTRVJUKG5leHQtPnJ1bnN0
YXRlLnN0YXRlICE9IFJVTlNUQVRFX3J1bm5pbmcpOwotICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdl
KG5leHQsIFJVTlNUQVRFX3J1bm5pbmcsIG5vdyk7CisgICAgQVNTRVJUKG5leHQtPnZjcHVfbGlz
dC0+cnVuc3RhdGUuc3RhdGUgIT0gUlVOU1RBVEVfcnVubmluZyk7CisgICAgc2NoZWRfdW5pdF9y
dW5zdGF0ZV9jaGFuZ2UobmV4dCwgdHJ1ZSwgbm93KTsKIAogICAgIC8qCiAgICAgICogTkIuIERv
bid0IGFkZCBhbnkgdHJhY2UgcmVjb3JkcyBmcm9tIGhlcmUgdW50aWwgdGhlIGFjdHVhbCBjb250
ZXh0CiAgICAgICogc3dpdGNoLCBlbHNlIGxvc3RfcmVjb3JkcyByZXN1bWUgd2lsbCBub3Qgd29y
ayBwcm9wZXJseS4KICAgICAgKi8KIAotICAgIEFTU0VSVCghbmV4dC0+c2NoZWRfdW5pdC0+aXNf
cnVubmluZyk7CisgICAgQVNTRVJUKCFuZXh0LT5pc19ydW5uaW5nKTsKKyAgICBuZXh0LT52Y3B1
X2xpc3QtPmlzX3J1bm5pbmcgPSAxOwogICAgIG5leHQtPmlzX3J1bm5pbmcgPSAxOwotICAgIG5l
eHQtPnNjaGVkX3VuaXQtPmlzX3J1bm5pbmcgPSAxOwotICAgIG5leHQtPnNjaGVkX3VuaXQtPnN0
YXRlX2VudHJ5X3RpbWUgPSBub3c7CisgICAgbmV4dC0+c3RhdGVfZW50cnlfdGltZSA9IG5vdzsK
IAogICAgIHBjcHVfc2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOwogCiAgICAgU0NIRURf
U1RBVF9DUkFOSyhzY2hlZF9jdHgpOwogCi0gICAgc3RvcF90aW1lcigmcHJldi0+cGVyaW9kaWNf
dGltZXIpOworICAgIHN0b3BfdGltZXIoJnByZXYtPnZjcHVfbGlzdC0+cGVyaW9kaWNfdGltZXIp
OwogCiAgICAgaWYgKCBuZXh0X3NsaWNlLm1pZ3JhdGVkICkKLSAgICAgICAgc2NoZWRfbW92ZV9p
cnFzKG5leHQpOworICAgICAgICBzY2hlZF9tb3ZlX2lycXMobmV4dC0+dmNwdV9saXN0KTsKIAot
ICAgIHZjcHVfcGVyaW9kaWNfdGltZXJfd29yayhuZXh0KTsKKyAgICB2Y3B1X3BlcmlvZGljX3Rp
bWVyX3dvcmsobmV4dC0+dmNwdV9saXN0KTsKIAotICAgIGNvbnRleHRfc3dpdGNoKHByZXYsIG5l
eHQpOworICAgIGNvbnRleHRfc3dpdGNoKHByZXYtPnZjcHVfbGlzdCwgbmV4dC0+dmNwdV9saXN0
KTsKIH0KIAogdm9pZCBjb250ZXh0X3NhdmVkKHN0cnVjdCB2Y3B1ICpwcmV2KQotLSAKMi4xNi40
CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRl
dmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9s
aXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

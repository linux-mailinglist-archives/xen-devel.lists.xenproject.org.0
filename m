Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 11020B2ABD
	for <lists+xen-devel@lfdr.de>; Sat, 14 Sep 2019 10:57:50 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i93oz-0000to-EI; Sat, 14 Sep 2019 08:54:21 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=rDpt=XJ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1i93ow-0000qM-P0
 for xen-devel@lists.xenproject.org; Sat, 14 Sep 2019 08:54:18 +0000
X-Inumbo-ID: 0e37e664-d6cd-11e9-95c1-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 0e37e664-d6cd-11e9-95c1-12813bfff9fa;
 Sat, 14 Sep 2019 08:53:02 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id DE05EB666;
 Sat, 14 Sep 2019 08:52:59 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Sat, 14 Sep 2019 10:52:20 +0200
Message-Id: <20190914085251.18816-17-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190914085251.18816-1-jgross@suse.com>
References: <20190914085251.18816-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v3 16/47] xen/sched: make credit scheduler vcpu
 agnostic.
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

U3dpdGNoIGNyZWRpdCBzY2hlZHVsZXIgY29tcGxldGVseSBmcm9tIHZjcHUgdG8gc2NoZWRfdW5p
dCB1c2FnZS4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4K
LS0tCiB4ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jIHwgNTAzICsrKysrKysrKysrKysrKysrKysr
KysrLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAyNTAgaW5zZXJ0aW9u
cygrKSwgMjUzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWRfY3Jl
ZGl0LmMgYi94ZW4vY29tbW9uL3NjaGVkX2NyZWRpdC5jCmluZGV4IGMwZjZlZjgzMWUuLjA0NGIx
ZDhhNTEgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWRfY3JlZGl0LmMKKysrIGIveGVuL2Nv
bW1vbi9zY2hlZF9jcmVkaXQuYwpAQCAtNzAsMTAgKzcwLDEwIEBACiAgKiBpbmNvbnNpc3RlbnQg
c2V0IG9mIGxvY2tzLiBUaGVyZWZvcmUgYXRvbWljLXNhZmUgYml0IG9wZXJhdGlvbnMgbXVzdAog
ICogYmUgdXNlZCBmb3IgYWNjZXNzaW5nIGl0LgogICovCi0jZGVmaW5lIENTQ0hFRF9GTEFHX1ZD
UFVfUEFSS0VEICAgIDB4MCAgLyogVkNQVSBvdmVyIGNhcHBlZCBjcmVkaXRzICovCi0jZGVmaW5l
IENTQ0hFRF9GTEFHX1ZDUFVfWUlFTEQgICAgIDB4MSAgLyogVkNQVSB5aWVsZGluZyAqLwotI2Rl
ZmluZSBDU0NIRURfRkxBR19WQ1BVX01JR1JBVElORyAweDIgIC8qIFZDUFUgbWF5IGhhdmUgbW92
ZWQgdG8gYSBuZXcgcGNwdSAqLwotI2RlZmluZSBDU0NIRURfRkxBR19WQ1BVX1BJTk5FRCAgICAw
eDQgIC8qIFZDUFUgY2FuIHJ1biBvbmx5IG9uIDEgcGNwdSAqLworI2RlZmluZSBDU0NIRURfRkxB
R19VTklUX1BBUktFRCAgICAweDAgIC8qIFVOSVQgb3ZlciBjYXBwZWQgY3JlZGl0cyAqLworI2Rl
ZmluZSBDU0NIRURfRkxBR19VTklUX1lJRUxEICAgICAweDEgIC8qIFVOSVQgeWllbGRpbmcgKi8K
KyNkZWZpbmUgQ1NDSEVEX0ZMQUdfVU5JVF9NSUdSQVRJTkcgMHgyICAvKiBVTklUIG1heSBoYXZl
IG1vdmVkIHRvIGEgbmV3IHBjcHUgKi8KKyNkZWZpbmUgQ1NDSEVEX0ZMQUdfVU5JVF9QSU5ORUQg
ICAgMHg0ICAvKiBVTklUIGNhbiBydW4gb25seSBvbiAxIHBjcHUgKi8KIAogCiAvKgpAQCAtOTEs
NyArOTEsNyBAQAogLyoKICAqIENTQ0hFRF9TVEFUUwogICoKLSAqIE1hbmFnZSB2ZXJ5IGJhc2lj
IHBlci12Q1BVIGNvdW50ZXJzIGFuZCBzdGF0cy4KKyAqIE1hbmFnZSB2ZXJ5IGJhc2ljIHBlci11
bml0IGNvdW50ZXJzIGFuZCBzdGF0cy4KICAqCiAgKiBVc2VmdWwgZm9yIGRlYnVnZ2luZyBsaXZl
IHN5c3RlbXMuIFRoZSBzdGF0cyBhcmUgZGlzcGxheWVkCiAgKiB3aXRoIHJ1bnEgZHVtcHMgKCdy
JyBvbiB0aGUgWGVuIGNvbnNvbGUpLgpAQCAtMTAwLDIzICsxMDAsMjMgQEAKIAogI2RlZmluZSBD
U0NIRURfU1RBVFMKIAotI2RlZmluZSBTQ0hFRF9WQ1BVX1NUQVRTX1JFU0VUKF9WKSAgICAgICAg
ICAgICAgICAgICAgICBcCisjZGVmaW5lIFNDSEVEX1VOSVRfU1RBVFNfUkVTRVQoX1YpICAgICAg
ICAgICAgICAgICAgICAgIFwKICAgICBkbyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgXAogICAgIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgIG1lbXNldCgmKF9WKS0+c3RhdHMsIDAsIHNp
emVvZigoX1YpLT5zdGF0cykpOyAgIFwKICAgICB9IHdoaWxlICggMCApCiAKLSNkZWZpbmUgU0NI
RURfVkNQVV9TVEFUX0NSQU5LKF9WLCBfWCkgICAgICAgKCgoX1YpLT5zdGF0cy5fWCkrKykKKyNk
ZWZpbmUgU0NIRURfVU5JVF9TVEFUX0NSQU5LKF9WLCBfWCkgICAgICAgKCgoX1YpLT5zdGF0cy5f
WCkrKykKIAotI2RlZmluZSBTQ0hFRF9WQ1BVX1NUQVRfU0VUKF9WLCBfWCwgX1kpICAgICAoKChf
ViktPnN0YXRzLl9YKSA9IChfWSkpCisjZGVmaW5lIFNDSEVEX1VOSVRfU1RBVF9TRVQoX1YsIF9Y
LCBfWSkgICAgICgoKF9WKS0+c3RhdHMuX1gpID0gKF9ZKSkKIAogI2Vsc2UgLyogIVNDSEVEX1NU
QVRTICovCiAKICN1bmRlZiBDU0NIRURfU1RBVFMKIAotI2RlZmluZSBTQ0hFRF9WQ1BVX1NUQVRT
X1JFU0VUKF9WKSAgICAgICAgIGRvIHt9IHdoaWxlICggMCApCi0jZGVmaW5lIFNDSEVEX1ZDUFVf
U1RBVF9DUkFOSyhfViwgX1gpICAgICAgZG8ge30gd2hpbGUgKCAwICkKLSNkZWZpbmUgU0NIRURf
VkNQVV9TVEFUX1NFVChfViwgX1gsIF9ZKSAgICBkbyB7fSB3aGlsZSAoIDAgKQorI2RlZmluZSBT
Q0hFRF9VTklUX1NUQVRTX1JFU0VUKF9WKSAgICAgICAgIGRvIHt9IHdoaWxlICggMCApCisjZGVm
aW5lIFNDSEVEX1VOSVRfU1RBVF9DUkFOSyhfViwgX1gpICAgICAgZG8ge30gd2hpbGUgKCAwICkK
KyNkZWZpbmUgU0NIRURfVU5JVF9TVEFUX1NFVChfViwgX1gsIF9ZKSAgICBkbyB7fSB3aGlsZSAo
IDAgKQogCiAjZW5kaWYgLyogU0NIRURfU1RBVFMgKi8KIApAQCAtMTI4LDcgKzEyOCw3IEBACiAj
ZGVmaW5lIFRSQ19DU0NIRURfU0NIRURfVEFTS0xFVCBUUkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hF
RCwgMSkKICNkZWZpbmUgVFJDX0NTQ0hFRF9BQ0NPVU5UX1NUQVJUIFRSQ19TQ0hFRF9DTEFTU19F
VlQoQ1NDSEVELCAyKQogI2RlZmluZSBUUkNfQ1NDSEVEX0FDQ09VTlRfU1RPUCAgVFJDX1NDSEVE
X0NMQVNTX0VWVChDU0NIRUQsIDMpCi0jZGVmaW5lIFRSQ19DU0NIRURfU1RPTEVOX1ZDUFUgICBU
UkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hFRCwgNCkKKyNkZWZpbmUgVFJDX0NTQ0hFRF9TVE9MRU5f
VU5JVCAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoQ1NDSEVELCA0KQogI2RlZmluZSBUUkNfQ1NDSEVE
X1BJQ0tFRF9DUFUgICAgVFJDX1NDSEVEX0NMQVNTX0VWVChDU0NIRUQsIDUpCiAjZGVmaW5lIFRS
Q19DU0NIRURfVElDS0xFICAgICAgICBUUkNfU0NIRURfQ0xBU1NfRVZUKENTQ0hFRCwgNikKICNk
ZWZpbmUgVFJDX0NTQ0hFRF9CT09TVF9TVEFSVCAgIFRSQ19TQ0hFRF9DTEFTU19FVlQoQ1NDSEVE
LCA3KQpAQCAtMTU4LDE1ICsxNTgsMTUgQEAgc3RydWN0IGNzY2hlZF9wY3B1IHsKIH07CiAKIC8q
Ci0gKiBWaXJ0dWFsIENQVQorICogVmlydHVhbCBVTklUCiAgKi8KIHN0cnVjdCBjc2NoZWRfdW5p
dCB7CiAgICAgc3RydWN0IGxpc3RfaGVhZCBydW5xX2VsZW07Ci0gICAgc3RydWN0IGxpc3RfaGVh
ZCBhY3RpdmVfdmNwdV9lbGVtOworICAgIHN0cnVjdCBsaXN0X2hlYWQgYWN0aXZlX3VuaXRfZWxl
bTsKIAogICAgIC8qIFVwLXBvaW50ZXJzICovCiAgICAgc3RydWN0IGNzY2hlZF9kb20gKnNkb207
Ci0gICAgc3RydWN0IHZjcHUgKnZjcHU7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAK
ICAgICBzX3RpbWVfdCBzdGFydF90aW1lOyAgIC8qIFdoZW4gd2Ugd2VyZSBzY2hlZHVsZWQgKHVz
ZWQgZm9yIGNyZWRpdCkgKi8KICAgICB1bnNpZ25lZCBmbGFnczsKQEAgLTE5NCwxMCArMTk0LDEw
IEBAIHN0cnVjdCBjc2NoZWRfdW5pdCB7CiAgKiBEb21haW4KICAqLwogc3RydWN0IGNzY2hlZF9k
b20gewotICAgIHN0cnVjdCBsaXN0X2hlYWQgYWN0aXZlX3ZjcHU7CisgICAgc3RydWN0IGxpc3Rf
aGVhZCBhY3RpdmVfdW5pdDsKICAgICBzdHJ1Y3QgbGlzdF9oZWFkIGFjdGl2ZV9zZG9tX2VsZW07
CiAgICAgc3RydWN0IGRvbWFpbiAqZG9tOwotICAgIHVpbnQxNl90IGFjdGl2ZV92Y3B1X2NvdW50
OworICAgIHVpbnQxNl90IGFjdGl2ZV91bml0X2NvdW50OwogICAgIHVpbnQxNl90IHdlaWdodDsK
ICAgICB1aW50MTZfdCBjYXA7CiB9OwpAQCAtMjE3LDcgKzIxNyw3IEBAIHN0cnVjdCBjc2NoZWRf
cHJpdmF0ZSB7CiAKICAgICAvKiBQZXJpb2Qgb2YgbWFzdGVyIGFuZCB0aWNrIGluIG1pbGxpc2Vj
b25kcyAqLwogICAgIHVuc2lnbmVkIGludCB0aWNrX3BlcmlvZF91cywgdGlja3NfcGVyX3RzbGlj
ZTsKLSAgICBzX3RpbWVfdCByYXRlbGltaXQsIHRzbGljZSwgdmNwdV9taWdyX2RlbGF5OworICAg
IHNfdGltZV90IHJhdGVsaW1pdCwgdHNsaWNlLCB1bml0X21pZ3JfZGVsYXk7CiAKICAgICBzdHJ1
Y3QgbGlzdF9oZWFkIGFjdGl2ZV9zZG9tOwogICAgIHVpbnQzMl90IHdlaWdodDsKQEAgLTIzMyw3
ICsyMzMsNyBAQCBzdGF0aWMgdm9pZCBjc2NoZWRfdGljayh2b2lkICpfY3B1KTsKIHN0YXRpYyB2
b2lkIGNzY2hlZF9hY2N0KHZvaWQgKmR1bW15KTsKIAogc3RhdGljIGlubGluZSBpbnQKLV9fdmNw
dV9vbl9ydW5xKHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQorX191bml0X29uX3J1bnEoc3RydWN0
IGNzY2hlZF91bml0ICpzdmMpCiB7CiAgICAgcmV0dXJuICFsaXN0X2VtcHR5KCZzdmMtPnJ1bnFf
ZWxlbSk7CiB9CkBAIC0yNDQsNyArMjQ0LDcgQEAgX19ydW5xX2VsZW0oc3RydWN0IGxpc3RfaGVh
ZCAqZWxlbSkKICAgICByZXR1cm4gbGlzdF9lbnRyeShlbGVtLCBzdHJ1Y3QgY3NjaGVkX3VuaXQs
IHJ1bnFfZWxlbSk7CiB9CiAKLS8qIElzIHRoZSBmaXJzdCBlbGVtZW50IG9mIGNwdSdzIHJ1bnEg
KGlmIGFueSkgY3B1J3MgaWRsZSB2Y3B1PyAqLworLyogSXMgdGhlIGZpcnN0IGVsZW1lbnQgb2Yg
Y3B1J3MgcnVucSAoaWYgYW55KSBjcHUncyBpZGxlIHVuaXQ/ICovCiBzdGF0aWMgaW5saW5lIGJv
b2xfdCBpc19ydW5xX2lkbGUodW5zaWduZWQgaW50IGNwdSkKIHsKICAgICAvKgpAQCAtMjUzLDcg
KzI1Myw3IEBAIHN0YXRpYyBpbmxpbmUgYm9vbF90IGlzX3J1bnFfaWRsZSh1bnNpZ25lZCBpbnQg
Y3B1KQogICAgIEFTU0VSVChzcGluX2lzX2xvY2tlZChnZXRfc2NoZWRfcmVzKGNwdSktPnNjaGVk
dWxlX2xvY2spKTsKIAogICAgIHJldHVybiBsaXN0X2VtcHR5KFJVTlEoY3B1KSkgfHwKLSAgICAg
ICAgICAgaXNfaWRsZV92Y3B1KF9fcnVucV9lbGVtKFJVTlEoY3B1KS0+bmV4dCktPnZjcHUpOwor
ICAgICAgICAgICBpc19pZGxlX3VuaXQoX19ydW5xX2VsZW0oUlVOUShjcHUpLT5uZXh0KS0+dW5p
dCk7CiB9CiAKIHN0YXRpYyBpbmxpbmUgdm9pZApAQCAtMjc1LDExICsyNzUsMTEgQEAgZGVjX25y
X3J1bm5hYmxlKHVuc2lnbmVkIGludCBjcHUpCiBzdGF0aWMgaW5saW5lIHZvaWQKIF9fcnVucV9p
bnNlcnQoc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiB7Ci0gICAgdW5zaWduZWQgaW50IGNwdSA9
IHN2Yy0+dmNwdS0+cHJvY2Vzc29yOworICAgIHVuc2lnbmVkIGludCBjcHUgPSBzY2hlZF91bml0
X2NwdShzdmMtPnVuaXQpOwogICAgIGNvbnN0IHN0cnVjdCBsaXN0X2hlYWQgKiBjb25zdCBydW5x
ID0gUlVOUShjcHUpOwogICAgIHN0cnVjdCBsaXN0X2hlYWQgKml0ZXI7CiAKLSAgICBCVUdfT04o
IF9fdmNwdV9vbl9ydW5xKHN2YykgKTsKKyAgICBCVUdfT04oIF9fdW5pdF9vbl9ydW5xKHN2Yykg
KTsKIAogICAgIGxpc3RfZm9yX2VhY2goIGl0ZXIsIHJ1bnEgKQogICAgIHsKQEAgLTI4OCwxMCAr
Mjg4LDEwIEBAIF9fcnVucV9pbnNlcnQoc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiAgICAgICAg
ICAgICBicmVhazsKICAgICB9CiAKLSAgICAvKiBJZiB0aGUgdmNwdSB5aWVsZGVkLCB0cnkgdG8g
cHV0IGl0IGJlaGluZCBvbmUgbG93ZXItcHJpb3JpdHkKLSAgICAgKiBydW5uYWJsZSB2Y3B1IGlm
IHdlIGNhbi4gIFRoZSBuZXh0IHJ1bnFfc29ydCB3aWxsIGJyaW5nIGl0IGZvcndhcmQKKyAgICAv
KiBJZiB0aGUgdW5pdCB5aWVsZGVkLCB0cnkgdG8gcHV0IGl0IGJlaGluZCBvbmUgbG93ZXItcHJp
b3JpdHkKKyAgICAgKiBydW5uYWJsZSB1bml0IGlmIHdlIGNhbi4gIFRoZSBuZXh0IHJ1bnFfc29y
dCB3aWxsIGJyaW5nIGl0IGZvcndhcmQKICAgICAgKiB3aXRoaW4gMzBtcyBpZiB0aGUgcXVldWUg
dG9vIGxvbmcuICovCi0gICAgaWYgKCB0ZXN0X2JpdChDU0NIRURfRkxBR19WQ1BVX1lJRUxELCAm
c3ZjLT5mbGFncykKKyAgICBpZiAoIHRlc3RfYml0KENTQ0hFRF9GTEFHX1VOSVRfWUlFTEQsICZz
dmMtPmZsYWdzKQogICAgICAgICAgJiYgX19ydW5xX2VsZW0oaXRlciktPnByaSA+IENTQ0hFRF9Q
UklfSURMRSApCiAgICAgewogICAgICAgICBpdGVyPWl0ZXItPm5leHQ7CkBAIC0zMDcsMjAgKzMw
NywyMCBAQCBzdGF0aWMgaW5saW5lIHZvaWQKIHJ1bnFfaW5zZXJ0KHN0cnVjdCBjc2NoZWRfdW5p
dCAqc3ZjKQogewogICAgIF9fcnVucV9pbnNlcnQoc3ZjKTsKLSAgICBpbmNfbnJfcnVubmFibGUo
c3ZjLT52Y3B1LT5wcm9jZXNzb3IpOworICAgIGluY19ucl9ydW5uYWJsZShzY2hlZF91bml0X2Nw
dShzdmMtPnVuaXQpKTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lkCiBfX3J1bnFfcmVtb3ZlKHN0
cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewotICAgIEJVR19PTiggIV9fdmNwdV9vbl9ydW5xKHN2
YykgKTsKKyAgICBCVUdfT04oICFfX3VuaXRfb25fcnVucShzdmMpICk7CiAgICAgbGlzdF9kZWxf
aW5pdCgmc3ZjLT5ydW5xX2VsZW0pOwogfQogCiBzdGF0aWMgaW5saW5lIHZvaWQKIHJ1bnFfcmVt
b3ZlKHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewotICAgIGRlY19ucl9ydW5uYWJsZShzdmMt
PnZjcHUtPnByb2Nlc3Nvcik7CisgICAgZGVjX25yX3J1bm5hYmxlKHNjaGVkX3VuaXRfY3B1KHN2
Yy0+dW5pdCkpOwogICAgIF9fcnVucV9yZW1vdmUoc3ZjKTsKIH0KIApAQCAtMzMxLDcgKzMzMSw3
IEBAIHN0YXRpYyB2b2lkIGJ1cm5fY3JlZGl0cyhzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2Yywgc190
aW1lX3Qgbm93KQogICAgIHVuc2lnbmVkIGludCBjcmVkaXRzOwogCiAgICAgLyogQXNzZXJ0IHN2
YyBpcyBjdXJyZW50ICovCi0gICAgQVNTRVJUKCBzdmMgPT0gQ1NDSEVEX1VOSVQoY3Vycl9vbl9j
cHUoc3ZjLT52Y3B1LT5wcm9jZXNzb3IpKSApOworICAgIEFTU0VSVCggc3ZjID09IENTQ0hFRF9V
TklUKGN1cnJfb25fY3B1KHNjaGVkX3VuaXRfY3B1KHN2Yy0+dW5pdCkpKSApOwogCiAgICAgaWYg
KCAoZGVsdGEgPSBub3cgLSBzdmMtPnN0YXJ0X3RpbWUpIDw9IDAgKQogICAgICAgICByZXR1cm47
CkBAIC0zNTEsOCArMzUxLDggQEAgREVGSU5FX1BFUl9DUFUodW5zaWduZWQgaW50LCBsYXN0X3Rp
Y2tsZV9jcHUpOwogCiBzdGF0aWMgaW5saW5lIHZvaWQgX19ydW5xX3RpY2tsZShzdHJ1Y3QgY3Nj
aGVkX3VuaXQgKm5ldykKIHsKLSAgICB1bnNpZ25lZCBpbnQgY3B1ID0gbmV3LT52Y3B1LT5wcm9j
ZXNzb3I7Ci0gICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSBuZXctPnZjcHUtPnNjaGVkX3Vu
aXQ7CisgICAgdW5zaWduZWQgaW50IGNwdSA9IHNjaGVkX3VuaXRfY3B1KG5ldy0+dW5pdCk7Cisg
ICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSBuZXctPnVuaXQ7CiAgICAgc3RydWN0IGNzY2hl
ZF91bml0ICogY29uc3QgY3VyID0gQ1NDSEVEX1VOSVQoY3Vycl9vbl9jcHUoY3B1KSk7CiAgICAg
c3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYgPSBDU0NIRURfUFJJVihwZXJfY3B1KHNjaGVkdWxl
ciwgY3B1KSk7CiAgICAgY3B1bWFza190IG1hc2ssIGlkbGVfbWFzaywgKm9ubGluZTsKQEAgLTM2
NiwxNiArMzY2LDE2IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBfX3J1bnFfdGlja2xlKHN0cnVjdCBj
c2NoZWRfdW5pdCAqbmV3KQogICAgIGlkbGVyc19lbXB0eSA9IGNwdW1hc2tfZW1wdHkoJmlkbGVf
bWFzayk7CiAKICAgICAvKgotICAgICAqIEV4Y2x1c2l2ZSBwaW5uaW5nIGlzIHdoZW4gYSB2Y3B1
IGhhcyBoYXJkLWFmZmluaXR5IHdpdGggb25seSBvbmUKLSAgICAgKiBjcHUsIGFuZCB0aGVyZSBp
cyBubyBvdGhlciB2Y3B1IHRoYXQgaGFzIGhhcmQtYWZmaW5pdHkgd2l0aCB0aGF0CisgICAgICog
RXhjbHVzaXZlIHBpbm5pbmcgaXMgd2hlbiBhIHVuaXQgaGFzIGhhcmQtYWZmaW5pdHkgd2l0aCBv
bmx5IG9uZQorICAgICAqIGNwdSwgYW5kIHRoZXJlIGlzIG5vIG90aGVyIHVuaXQgdGhhdCBoYXMg
aGFyZC1hZmZpbml0eSB3aXRoIHRoYXQKICAgICAgKiBzYW1lIGNwdS4gVGhpcyBpcyBpbmZyZXF1
ZW50LCBidXQgaWYgaXQgaGFwcGVucywgaXMgZm9yIGFjaGlldmluZwogICAgICAqIHRoZSBtb3N0
IHBvc3NpYmxlIGRldGVybWluaXNtLCBhbmQgbGVhc3QgcG9zc2libGUgb3ZlcmhlYWQgZm9yCi0g
ICAgICogdGhlIHZjcHVzIGluIHF1ZXN0aW9uLgorICAgICAqIHRoZSB1bml0cyBpbiBxdWVzdGlv
bi4KICAgICAgKgogICAgICAqIFRyeSB0byBpZGVudGlmeSB0aGUgdmFzdCBtYWpvcml0eSBvZiB0
aGVzZSBzaXR1YXRpb25zLCBhbmQgZGVhbAogICAgICAqIHdpdGggdGhlbSBxdWlja2x5LgogICAg
ICAqLwotICAgIGlmICggdW5saWtlbHkodGVzdF9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9QSU5ORUQs
ICZuZXctPmZsYWdzKSAmJgorICAgIGlmICggdW5saWtlbHkodGVzdF9iaXQoQ1NDSEVEX0ZMQUdf
VU5JVF9QSU5ORUQsICZuZXctPmZsYWdzKSAmJgogICAgICAgICAgICAgICAgICAgY3B1bWFza190
ZXN0X2NwdShjcHUsICZpZGxlX21hc2spKSApCiAgICAgewogICAgICAgICBBU1NFUlQoY3B1bWFz
a19jeWNsZShjcHUsIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5KSA9PSBjcHUpOwpAQCAtMzg2LDcg
KzM4Niw3IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBfX3J1bnFfdGlja2xlKHN0cnVjdCBjc2NoZWRf
dW5pdCAqbmV3KQogCiAgICAgLyoKICAgICAgKiBJZiB0aGUgcGNwdSBpcyBpZGxlLCBvciB0aGVy
ZSBhcmUgbm8gaWRsZXJzIGFuZCB0aGUgbmV3Ci0gICAgICogdmNwdSBpcyBhIGhpZ2hlciBwcmlv
cml0eSB0aGFuIHRoZSBvbGQgdmNwdSwgcnVuIGl0IGhlcmUuCisgICAgICogdW5pdCBpcyBhIGhp
Z2hlciBwcmlvcml0eSB0aGFuIHRoZSBvbGQgdW5pdCwgcnVuIGl0IGhlcmUuCiAgICAgICoKICAg
ICAgKiBJZiB0aGVyZSBhcmUgaWRsZSBjcHVzLCBmaXJzdCB0cnkgdG8gZmluZCBvbmUgc3VpdGFi
bGUgdG8gcnVuCiAgICAgICogbmV3LCBzbyB3ZSBjYW4gYXZvaWQgcHJlZW1wdGluZyBjdXIuICBJ
ZiB3ZSBjYW5ub3QgZmluZCBhCkBAIC00MDUsNyArNDA1LDcgQEAgc3RhdGljIGlubGluZSB2b2lk
IF9fcnVucV90aWNrbGUoc3RydWN0IGNzY2hlZF91bml0ICpuZXcpCiAgICAgZWxzZSBpZiAoICFp
ZGxlcnNfZW1wdHkgKQogICAgIHsKICAgICAgICAgLyoKLSAgICAgICAgICogU29mdCBhbmQgaGFy
ZCBhZmZpbml0eSBiYWxhbmNpbmcgbG9vcC4gRm9yIHZjcHVzIHdpdGhvdXQKKyAgICAgICAgICog
U29mdCBhbmQgaGFyZCBhZmZpbml0eSBiYWxhbmNpbmcgbG9vcC4gRm9yIHVuaXRzIHdpdGhvdXQK
ICAgICAgICAgICogYSB1c2VmdWwgc29mdCBhZmZpbml0eSwgY29uc2lkZXIgaGFyZCBhZmZpbml0
eSBvbmx5LgogICAgICAgICAgKi8KICAgICAgICAgZm9yX2VhY2hfYWZmaW5pdHlfYmFsYW5jZV9z
dGVwKCBiYWxhbmNlX3N0ZXAgKQpAQCAtNDQ4LDEwICs0NDgsMTAgQEAgc3RhdGljIGlubGluZSB2
b2lkIF9fcnVucV90aWNrbGUoc3RydWN0IGNzY2hlZF91bml0ICpuZXcpCiAgICAgICAgICAgICB7
CiAgICAgICAgICAgICAgICAgaWYgKCBjcHVtYXNrX2ludGVyc2VjdHModW5pdC0+Y3B1X2hhcmRf
YWZmaW5pdHksICZpZGxlX21hc2spICkKICAgICAgICAgICAgICAgICB7Ci0gICAgICAgICAgICAg
ICAgICAgIFNDSEVEX1ZDUFVfU1RBVF9DUkFOSyhjdXIsIGtpY2tlZF9hd2F5KTsKLSAgICAgICAg
ICAgICAgICAgICAgU0NIRURfVkNQVV9TVEFUX0NSQU5LKGN1ciwgbWlncmF0ZV9yKTsKKyAgICAg
ICAgICAgICAgICAgICAgU0NIRURfVU5JVF9TVEFUX0NSQU5LKGN1ciwga2lja2VkX2F3YXkpOwor
ICAgICAgICAgICAgICAgICAgICBTQ0hFRF9VTklUX1NUQVRfQ1JBTksoY3VyLCBtaWdyYXRlX3Ip
OwogICAgICAgICAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKG1pZ3JhdGVfa2lja2VkX2F3
YXkpOwotICAgICAgICAgICAgICAgICAgICBzZXRfYml0KF9WUEZfbWlncmF0aW5nLCAmY3VyLT52
Y3B1LT5wYXVzZV9mbGFncyk7CisgICAgICAgICAgICAgICAgICAgIHNjaGVkX3NldF9wYXVzZV9m
bGFnc19hdG9taWMoY3VyLT51bml0LCBfVlBGX21pZ3JhdGluZyk7CiAgICAgICAgICAgICAgICAg
fQogICAgICAgICAgICAgICAgIC8qIFRpY2tsZSBjcHUgYW55d2F5LCB0byBsZXQgbmV3IHByZWVt
cHQgY3VyLiAqLwogICAgICAgICAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksodGlja2xlZF9idXN5
X2NwdSk7CkBAIC02MDcsNyArNjA3LDcgQEAgaW5pdF9wZGF0YShzdHJ1Y3QgY3NjaGVkX3ByaXZh
dGUgKnBydiwgc3RydWN0IGNzY2hlZF9wY3B1ICpzcGMsIGludCBjcHUpCiAgICAgc3BjLT5pZGxl
X2JpYXMgPSBucl9jcHVfaWRzIC0gMTsKIAogICAgIC8qIFN0YXJ0IG9mZiBpZGxpbmcuLi4gKi8K
LSAgICBCVUdfT04oIWlzX2lkbGVfdmNwdShjdXJyX29uX2NwdShjcHUpLT52Y3B1X2xpc3QpKTsK
KyAgICBCVUdfT04oIWlzX2lkbGVfdW5pdChjdXJyX29uX2NwdShjcHUpKSk7CiAgICAgY3B1bWFz
a19zZXRfY3B1KGNwdSwgcHJ2LT5pZGxlcnMpOwogICAgIHNwYy0+bnJfcnVubmFibGUgPSAwOwog
fQpAQCAtNjMyLDkgKzYzMiw5IEBAIGNzY2hlZF9zd2l0Y2hfc2NoZWQoc3RydWN0IHNjaGVkdWxl
ciAqbmV3X29wcywgdW5zaWduZWQgaW50IGNwdSwKICAgICBzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUg
KnBydiA9IENTQ0hFRF9QUklWKG5ld19vcHMpOwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqc3Zj
ID0gdmRhdGE7CiAKLSAgICBBU1NFUlQoc3ZjICYmIGlzX2lkbGVfdmNwdShzdmMtPnZjcHUpKTsK
KyAgICBBU1NFUlQoc3ZjICYmIGlzX2lkbGVfdW5pdChzdmMtPnVuaXQpKTsKIAotICAgIGlkbGVf
dmNwdVtjcHVdLT5zY2hlZF91bml0LT5wcml2ID0gdmRhdGE7CisgICAgc2NoZWRfaWRsZV91bml0
KGNwdSktPnByaXYgPSB2ZGF0YTsKIAogICAgIC8qCiAgICAgICogV2UgYXJlIGhvbGRpbmcgdGhl
IHJ1bnF1ZXVlIGxvY2sgYWxyZWFkeSAoaXQncyBiZWVuIHRha2VuIGluCkBAIC02NTEsMzMgKzY1
MSwzMyBAQCBjc2NoZWRfc3dpdGNoX3NjaGVkKHN0cnVjdCBzY2hlZHVsZXIgKm5ld19vcHMsIHVu
c2lnbmVkIGludCBjcHUsCiAKICNpZm5kZWYgTkRFQlVHCiBzdGF0aWMgaW5saW5lIHZvaWQKLV9f
Y3NjaGVkX3ZjcHVfY2hlY2soc3RydWN0IHZjcHUgKnZjKQorX19jc2NoZWRfdW5pdF9jaGVjayhz
dHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIHsKLSAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQgKiBjb25z
dCBzdmMgPSBDU0NIRURfVU5JVCh2Yy0+c2NoZWRfdW5pdCk7CisgICAgc3RydWN0IGNzY2hlZF91
bml0ICogY29uc3Qgc3ZjID0gQ1NDSEVEX1VOSVQodW5pdCk7CiAgICAgc3RydWN0IGNzY2hlZF9k
b20gKiBjb25zdCBzZG9tID0gc3ZjLT5zZG9tOwogCi0gICAgQlVHX09OKCBzdmMtPnZjcHUgIT0g
dmMgKTsKLSAgICBCVUdfT04oIHNkb20gIT0gQ1NDSEVEX0RPTSh2Yy0+ZG9tYWluKSApOworICAg
IEJVR19PTiggc3ZjLT51bml0ICE9IHVuaXQgKTsKKyAgICBCVUdfT04oIHNkb20gIT0gQ1NDSEVE
X0RPTSh1bml0LT5kb21haW4pICk7CiAgICAgaWYgKCBzZG9tICkKICAgICB7Ci0gICAgICAgIEJV
R19PTiggaXNfaWRsZV92Y3B1KHZjKSApOwotICAgICAgICBCVUdfT04oIHNkb20tPmRvbSAhPSB2
Yy0+ZG9tYWluICk7CisgICAgICAgIEJVR19PTiggaXNfaWRsZV91bml0KHVuaXQpICk7CisgICAg
ICAgIEJVR19PTiggc2RvbS0+ZG9tICE9IHVuaXQtPmRvbWFpbiApOwogICAgIH0KICAgICBlbHNl
CiAgICAgewotICAgICAgICBCVUdfT04oICFpc19pZGxlX3ZjcHUodmMpICk7CisgICAgICAgIEJV
R19PTiggIWlzX2lkbGVfdW5pdCh1bml0KSApOwogICAgIH0KIAogICAgIFNDSEVEX1NUQVRfQ1JB
TksodW5pdF9jaGVjayk7CiB9Ci0jZGVmaW5lIENTQ0hFRF9WQ1BVX0NIRUNLKF92YykgIChfX2Nz
Y2hlZF92Y3B1X2NoZWNrKF92YykpCisjZGVmaW5lIENTQ0hFRF9VTklUX0NIRUNLKHVuaXQpICAo
X19jc2NoZWRfdW5pdF9jaGVjayh1bml0KSkKICNlbHNlCi0jZGVmaW5lIENTQ0hFRF9WQ1BVX0NI
RUNLKF92YykKKyNkZWZpbmUgQ1NDSEVEX1VOSVRfQ0hFQ0sodW5pdCkKICNlbmRpZgogCiAvKgot
ICogRGVsYXksIGluIG1pY3Jvc2Vjb25kcywgYmV0d2VlbiBtaWdyYXRpb25zIG9mIGEgVkNQVSBi
ZXR3ZWVuIFBDUFVzLgotICogVGhpcyBwcmV2ZW50cyByYXBpZCBmbHV0dGVyaW5nIG9mIGEgVkNQ
VSBiZXR3ZWVuIENQVXMsIGFuZCByZWR1Y2VzIHRoZQorICogRGVsYXksIGluIG1pY3Jvc2Vjb25k
cywgYmV0d2VlbiBtaWdyYXRpb25zIG9mIGEgVU5JVCBiZXR3ZWVuIFBDUFVzLgorICogVGhpcyBw
cmV2ZW50cyByYXBpZCBmbHV0dGVyaW5nIG9mIGEgVU5JVCBiZXR3ZWVuIENQVXMsIGFuZCByZWR1
Y2VzIHRoZQogICogaW1wbGljaXQgb3ZlcmhlYWRzIHN1Y2ggYXMgY2FjaGUtd2FybWluZy4gMW1z
ICgxMDAwKSBoYXMgYmVlbiBtZWFzdXJlZAogICogYXMgYSBnb29kIHZhbHVlLgogICovCkBAIC02
ODgsOCArNjg4LDggQEAgc3RhdGljIGlubGluZSBib29sCiBfX2NzY2hlZF92Y3B1X2lzX2NhY2hl
X2hvdChjb25zdCBzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBydiwKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIGNvbnN0IHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjKQogewotICAgIGJvb2wgaG90
ID0gcHJ2LT52Y3B1X21pZ3JfZGVsYXkgJiYKLSAgICAgICAgICAgICAgIChOT1coKSAtIHN2Yy0+
bGFzdF9zY2hlZF90aW1lKSA8IHBydi0+dmNwdV9taWdyX2RlbGF5OworICAgIGJvb2wgaG90ID0g
cHJ2LT51bml0X21pZ3JfZGVsYXkgJiYKKyAgICAgICAgICAgICAgIChOT1coKSAtIHN2Yy0+bGFz
dF9zY2hlZF90aW1lKSA8IHBydi0+dW5pdF9taWdyX2RlbGF5OwogCiAgICAgaWYgKCBob3QgKQog
ICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfaG90KTsKQEAgLTY5OCwzNyArNjk4LDM5IEBA
IF9fY3NjaGVkX3ZjcHVfaXNfY2FjaGVfaG90KGNvbnN0IHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAq
cHJ2LAogfQogCiBzdGF0aWMgaW5saW5lIGludAotX19jc2NoZWRfdmNwdV9pc19taWdyYXRlYWJs
ZShjb25zdCBzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBydiwgc3RydWN0IHZjcHUgKnZjLAorX19j
c2NoZWRfdW5pdF9pc19taWdyYXRlYWJsZShjb25zdCBzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUgKnBy
diwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQs
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBkZXN0X2NwdSwgY3B1bWFza190ICpt
YXNrKQogewotICAgIGNvbnN0IHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjID0gQ1NDSEVEX1VOSVQo
dmMtPnNjaGVkX3VuaXQpOworICAgIGNvbnN0IHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjID0gQ1ND
SEVEX1VOSVQodW5pdCk7CiAgICAgLyoKICAgICAgKiBEb24ndCBwaWNrIHVwIHdvcmsgdGhhdCdz
IGhvdCBvbiBwZWVyIFBDUFUsIG9yIHRoYXQgY2FuJ3QgKG9yCiAgICAgICogd291bGQgcHJlZmVy
IG5vdCB0bykgcnVuIG9uIGNwdS4KICAgICAgKgotICAgICAqIFRoZSBjYWxsZXIgaXMgc3VwcG9z
ZWQgdG8gaGF2ZSBhbHJlYWR5IGNoZWNrZWQgdGhhdCB2YyBpcyBhbHNvCisgICAgICogVGhlIGNh
bGxlciBpcyBzdXBwb3NlZCB0byBoYXZlIGFscmVhZHkgY2hlY2tlZCB0aGF0IHVuaXQgaXMgYWxz
bwogICAgICAqIG5vdCBydW5uaW5nLgogICAgICAqLwotICAgIEFTU0VSVCghdmMtPnNjaGVkX3Vu
aXQtPmlzX3J1bm5pbmcpOworICAgIEFTU0VSVCghdW5pdC0+aXNfcnVubmluZyk7CiAKICAgICBy
ZXR1cm4gIV9fY3NjaGVkX3ZjcHVfaXNfY2FjaGVfaG90KHBydiwgc3ZjKSAmJgogICAgICAgICAg
ICBjcHVtYXNrX3Rlc3RfY3B1KGRlc3RfY3B1LCBtYXNrKTsKIH0KIAogc3RhdGljIGludAotX2Nz
Y2hlZF9jcHVfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1ICp2
YywgYm9vbF90IGNvbW1pdCkKK19jc2NoZWRfY3B1X3BpY2soY29uc3Qgc3RydWN0IHNjaGVkdWxl
ciAqb3BzLCBjb25zdCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKKyAgICAgICAgICAgICAgICAg
Ym9vbF90IGNvbW1pdCkKIHsKLSAgICAvKiBXZSBtdXN0IGFsd2F5cyB1c2UgdmMtPnByb2Nzc29y
J3Mgc2NyYXRjaCBzcGFjZSAqLwotICAgIGNwdW1hc2tfdCAqY3B1cyA9IGNwdW1hc2tfc2NyYXRj
aF9jcHUodmMtPnByb2Nlc3Nvcik7CisgICAgaW50IGNwdSA9IHNjaGVkX3VuaXRfY3B1KHVuaXQp
OworICAgIC8qIFdlIG11c3QgYWx3YXlzIHVzZSBjcHUncyBzY3JhdGNoIHNwYWNlICovCisgICAg
Y3B1bWFza190ICpjcHVzID0gY3B1bWFza19zY3JhdGNoX2NwdShjcHUpOwogICAgIGNwdW1hc2tf
dCBpZGxlcnM7Ci0gICAgY3B1bWFza190ICpvbmxpbmUgPSBjcHVwb29sX2RvbWFpbl9jcHVtYXNr
KHZjLT5kb21haW4pOworICAgIGNwdW1hc2tfdCAqb25saW5lID0gY3B1cG9vbF9kb21haW5fY3B1
bWFzayh1bml0LT5kb21haW4pOwogICAgIHN0cnVjdCBjc2NoZWRfcGNwdSAqc3BjID0gTlVMTDsK
LSAgICBpbnQgY3B1ID0gdmMtPnByb2Nlc3NvcjsKICAgICBpbnQgYmFsYW5jZV9zdGVwOwogCiAg
ICAgZm9yX2VhY2hfYWZmaW5pdHlfYmFsYW5jZV9zdGVwKCBiYWxhbmNlX3N0ZXAgKQogICAgIHsK
LSAgICAgICAgYWZmaW5pdHlfYmFsYW5jZV9jcHVtYXNrKHZjLT5zY2hlZF91bml0LCBiYWxhbmNl
X3N0ZXAsIGNwdXMpOworICAgICAgICBhZmZpbml0eV9iYWxhbmNlX2NwdW1hc2sodW5pdCwgYmFs
YW5jZV9zdGVwLCBjcHVzKTsKICAgICAgICAgY3B1bWFza19hbmQoY3B1cywgb25saW5lLCBjcHVz
KTsKICAgICAgICAgLyoKICAgICAgICAgICogV2Ugd2FudCB0byBwaWNrIHVwIGEgcGNwdSBhbW9u
ZyB0aGUgb25lcyB0aGF0IGFyZSBvbmxpbmUgYW5kCkBAIC03NDcsMTIgKzc0OSwxMyBAQCBfY3Nj
aGVkX2NwdV9waWNrKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHZjcHUgKnZj
LCBib29sX3QgY29tbWl0KQogICAgICAgICAgKiBiYWxhbmNpbmcgc3RlcCBhbGwgdG9nZXRoZXIu
CiAgICAgICAgICAqLwogICAgICAgICBpZiAoIGJhbGFuY2Vfc3RlcCA9PSBCQUxBTkNFX1NPRlRf
QUZGSU5JVFkgJiYKLSAgICAgICAgICAgICAoIWhhc19zb2Z0X2FmZmluaXR5KHZjLT5zY2hlZF91
bml0KSB8fCBjcHVtYXNrX2VtcHR5KGNwdXMpKSApCisgICAgICAgICAgICAgKCFoYXNfc29mdF9h
ZmZpbml0eSh1bml0KSB8fCBjcHVtYXNrX2VtcHR5KGNwdXMpKSApCiAgICAgICAgICAgICBjb250
aW51ZTsKIAogICAgICAgICAvKiBJZiBwcmVzZW50LCBwcmVmZXIgdmMncyBjdXJyZW50IHByb2Nl
c3NvciAqLwotICAgICAgICBjcHUgPSBjcHVtYXNrX3Rlc3RfY3B1KHZjLT5wcm9jZXNzb3IsIGNw
dXMpCi0gICAgICAgICAgICAgICAgPyB2Yy0+cHJvY2Vzc29yIDogY3B1bWFza19jeWNsZSh2Yy0+
cHJvY2Vzc29yLCBjcHVzKTsKKyAgICAgICAgY3B1ID0gY3B1bWFza190ZXN0X2NwdShzY2hlZF91
bml0X2NwdSh1bml0KSwgY3B1cykKKyAgICAgICAgICAgICAgICA/IHNjaGVkX3VuaXRfY3B1KHVu
aXQpCisgICAgICAgICAgICAgICAgOiBjcHVtYXNrX2N5Y2xlKHNjaGVkX3VuaXRfY3B1KHVuaXQp
LCBjcHVzKTsKICAgICAgICAgQVNTRVJUKGNwdW1hc2tfdGVzdF9jcHUoY3B1LCBjcHVzKSk7CiAK
ICAgICAgICAgLyoKQEAgLTc2NCwxNSArNzY3LDE1IEBAIF9jc2NoZWRfY3B1X3BpY2soY29uc3Qg
c3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3QgdmNwdSAqdmMsIGJvb2xfdCBjb21taXQpCiAg
ICAgICAgICAqIFdlIGdpdmUgcHJlZmVyZW5jZSB0byB0aGUgaWRsZSBleGVjdXRpb24gdmVoaWNs
ZSB3aXRoIHRoZSBtb3N0CiAgICAgICAgICAqIGlkbGluZyBuZWlnaGJvdXJzIGluIGl0cyBncm91
cGluZy4gVGhpcyBkaXN0cmlidXRlcyB3b3JrIGFjcm9zcwogICAgICAgICAgKiBkaXN0aW5jdCBj
b3JlcyBmaXJzdCBhbmQgZ3VhcmFudGVlcyB3ZSBkb24ndCBkbyBzb21ldGhpbmcgc3R1cGlkCi0g
ICAgICAgICAqIGxpa2UgcnVuIHR3byBWQ1BVcyBvbiBjby1oeXBlcnRocmVhZHMgd2hpbGUgdGhl
cmUgYXJlIGlkbGUgY29yZXMKKyAgICAgICAgICogbGlrZSBydW4gdHdvIFVOSVRzIG9uIGNvLWh5
cGVydGhyZWFkcyB3aGlsZSB0aGVyZSBhcmUgaWRsZSBjb3JlcwogICAgICAgICAgKiBvciBzb2Nr
ZXRzLgogICAgICAgICAgKgogICAgICAgICAgKiBOb3RpY2UgdGhhdCwgd2hlbiBjb21wdXRpbmcg
dGhlICJpZGxlbmVzcyIgb2YgY3B1LCB3ZSBtYXkgd2FudCB0bwotICAgICAgICAgKiBkaXNjb3Vu
dCB2Yy4gVGhhdCBpcywgaWZmIHZjIGlzIHRoZSBjdXJyZW50bHkgcnVubmluZyBhbmQgdGhlIG9u
bHkKLSAgICAgICAgICogcnVubmFibGUgdmNwdSBvbiBjcHUsIHdlIGFkZCBjcHUgdG8gdGhlIGlk
bGVycy4KKyAgICAgICAgICogZGlzY291bnQgdW5pdC4gVGhhdCBpcywgaWZmIHVuaXQgaXMgdGhl
IGN1cnJlbnRseSBydW5uaW5nIGFuZCB0aGUKKyAgICAgICAgICogb25seSBydW5uYWJsZSB1bml0
IG9uIGNwdSwgd2UgYWRkIGNwdSB0byB0aGUgaWRsZXJzLgogICAgICAgICAgKi8KICAgICAgICAg
Y3B1bWFza19hbmQoJmlkbGVycywgJmNwdV9vbmxpbmVfbWFwLCBDU0NIRURfUFJJVihvcHMpLT5p
ZGxlcnMpOwotICAgICAgICBpZiAoIHZjLT5wcm9jZXNzb3IgPT0gY3B1ICYmIGlzX3J1bnFfaWRs
ZShjcHUpICkKKyAgICAgICAgaWYgKCBzY2hlZF91bml0X2NwdSh1bml0KSA9PSBjcHUgJiYgaXNf
cnVucV9pZGxlKGNwdSkgKQogICAgICAgICAgICAgX19jcHVtYXNrX3NldF9jcHUoY3B1LCAmaWRs
ZXJzKTsKICAgICAgICAgY3B1bWFza19hbmQoY3B1cywgJmlkbGVycywgY3B1cyk7CiAKQEAgLTc4
Miw3ICs3ODUsNyBAQCBfY3NjaGVkX2NwdV9waWNrKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9w
cywgc3RydWN0IHZjcHUgKnZjLCBib29sX3QgY29tbWl0KQogICAgICAgICAgKiBDUFUsIGFzIHdl
IGp1c3QgJiYtZWQgaXQgd2l0aCBpZGxlcnMpLiBJbiBmYWN0LCBpZiB3ZSBhcmUgb24gU01ULCBh
bmQKICAgICAgICAgICogY3B1IHBvaW50cyB0byBhIGJ1c3kgdGhyZWFkIHdpdGggYW4gaWRsZSBz
aWJsaW5nLCBib3RoIHRoZSB0aHJlYWRzCiAgICAgICAgICAqIHdpbGwgYmUgY29uc2lkZXJlZCB0
aGUgc2FtZSwgZnJvbSB0aGUgImlkbGVuZXNzIiBjYWxjdWxhdGlvbiBwb2ludAotICAgICAgICAg
KiBvZiB2aWV3IiwgcHJldmVudGluZyB2Y3B1IGZyb20gYmVpbmcgbW92ZWQgdG8gdGhlIHRocmVh
ZCB0aGF0IGlzCisgICAgICAgICAqIG9mIHZpZXciLCBwcmV2ZW50aW5nIHVuaXQgZnJvbSBiZWlu
ZyBtb3ZlZCB0byB0aGUgdGhyZWFkIHRoYXQgaXMKICAgICAgICAgICogYWN0dWFsbHkgaWRsZS4K
ICAgICAgICAgICoKICAgICAgICAgICogTm90aWNlIHRoYXQgY3B1bWFza190ZXN0X2NwdSgpIGlz
IHF1aWNrZXIgdGhhbiBjcHVtYXNrX2VtcHR5KCksIHNvCkBAIC04NDgsNyArODUxLDggQEAgX2Nz
Y2hlZF9jcHVfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0cnVjdCB2Y3B1ICp2
YywgYm9vbF90IGNvbW1pdCkKICAgICBpZiAoIGNvbW1pdCAmJiBzcGMgKQogICAgICAgIHNwYy0+
aWRsZV9iaWFzID0gY3B1OwogCi0gICAgVFJBQ0VfM0QoVFJDX0NTQ0hFRF9QSUNLRURfQ1BVLCB2
Yy0+ZG9tYWluLT5kb21haW5faWQsIHZjLT52Y3B1X2lkLCBjcHUpOworICAgIFRSQUNFXzNEKFRS
Q19DU0NIRURfUElDS0VEX0NQVSwgdW5pdC0+ZG9tYWluLT5kb21haW5faWQsIHVuaXQtPnVuaXRf
aWQsCisgICAgICAgICAgICAgY3B1KTsKIAogICAgIHJldHVybiBjcHU7CiB9CkBAIC04NTYsNyAr
ODYwLDYgQEAgX2NzY2hlZF9jcHVfcGljayhjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0
cnVjdCB2Y3B1ICp2YywgYm9vbF90IGNvbW1pdCkKIHN0YXRpYyBzdHJ1Y3Qgc2NoZWRfcmVzb3Vy
Y2UgKgogY3NjaGVkX3Jlc19waWNrKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgY29uc3Qg
c3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAgc3RydWN0IHZjcHUgKnZjID0gdW5pdC0+
dmNwdV9saXN0OwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqc3ZjID0gQ1NDSEVEX1VOSVQodW5p
dCk7CiAKICAgICAvKgpAQCAtODY2LDI2ICs4NjksMjYgQEAgY3NjaGVkX3Jlc19waWNrKGNvbnN0
IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAg
ICAgICogY3NjaGVkX3VuaXRfd2FrZSgpIChzdGlsbCBjYWxsZWQgZnJvbSB2Y3B1X21pZ3JhdGUo
KSkgd2Ugd29uJ3QKICAgICAgKiBnZXQgYm9vc3RlZCwgd2hpY2ggd2UgZG9uJ3QgZGVzZXJ2ZSBh
cyB3ZSBhcmUgIm9ubHkiIG1pZ3JhdGluZy4KICAgICAgKi8KLSAgICBzZXRfYml0KENTQ0hFRF9G
TEFHX1ZDUFVfTUlHUkFUSU5HLCAmc3ZjLT5mbGFncyk7Ci0gICAgcmV0dXJuIGdldF9zY2hlZF9y
ZXMoX2NzY2hlZF9jcHVfcGljayhvcHMsIHZjLCAxKSk7CisgICAgc2V0X2JpdChDU0NIRURfRkxB
R19VTklUX01JR1JBVElORywgJnN2Yy0+ZmxhZ3MpOworICAgIHJldHVybiBnZXRfc2NoZWRfcmVz
KF9jc2NoZWRfY3B1X3BpY2sob3BzLCB1bml0LCAxKSk7CiB9CiAKIHN0YXRpYyBpbmxpbmUgdm9p
ZAotX19jc2NoZWRfdmNwdV9hY2N0X3N0YXJ0KHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCBz
dHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKK19fY3NjaGVkX3VuaXRfYWNjdF9zdGFydChzdHJ1Y3Qg
Y3NjaGVkX3ByaXZhdGUgKnBydiwgc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiB7CiAgICAgc3Ry
dWN0IGNzY2hlZF9kb20gKiBjb25zdCBzZG9tID0gc3ZjLT5zZG9tOwogICAgIHVuc2lnbmVkIGxv
bmcgZmxhZ3M7CiAKICAgICBzcGluX2xvY2tfaXJxc2F2ZSgmcHJ2LT5sb2NrLCBmbGFncyk7CiAK
LSAgICBpZiAoIGxpc3RfZW1wdHkoJnN2Yy0+YWN0aXZlX3ZjcHVfZWxlbSkgKQorICAgIGlmICgg
bGlzdF9lbXB0eSgmc3ZjLT5hY3RpdmVfdW5pdF9lbGVtKSApCiAgICAgewotICAgICAgICBTQ0hF
RF9WQ1BVX1NUQVRfQ1JBTksoc3ZjLCBzdGF0ZV9hY3RpdmUpOworICAgICAgICBTQ0hFRF9VTklU
X1NUQVRfQ1JBTksoc3ZjLCBzdGF0ZV9hY3RpdmUpOwogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5L
KGFjY3RfdW5pdF9hY3RpdmUpOwogCi0gICAgICAgIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50Kys7
Ci0gICAgICAgIGxpc3RfYWRkKCZzdmMtPmFjdGl2ZV92Y3B1X2VsZW0sICZzZG9tLT5hY3RpdmVf
dmNwdSk7Ci0gICAgICAgIC8qIE1ha2Ugd2VpZ2h0IHBlci12Y3B1ICovCisgICAgICAgIHNkb20t
PmFjdGl2ZV91bml0X2NvdW50Kys7CisgICAgICAgIGxpc3RfYWRkKCZzdmMtPmFjdGl2ZV91bml0
X2VsZW0sICZzZG9tLT5hY3RpdmVfdW5pdCk7CisgICAgICAgIC8qIE1ha2Ugd2VpZ2h0IHBlci11
bml0ICovCiAgICAgICAgIHBydi0+d2VpZ2h0ICs9IHNkb20tPndlaWdodDsKICAgICAgICAgaWYg
KCBsaXN0X2VtcHR5KCZzZG9tLT5hY3RpdmVfc2RvbV9lbGVtKSApCiAgICAgICAgIHsKQEAgLTg5
NCw1NiArODk3LDU2IEBAIF9fY3NjaGVkX3ZjcHVfYWNjdF9zdGFydChzdHJ1Y3QgY3NjaGVkX3By
aXZhdGUgKnBydiwgc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiAgICAgfQogCiAgICAgVFJBQ0Vf
M0QoVFJDX0NTQ0hFRF9BQ0NPVU5UX1NUQVJULCBzZG9tLT5kb20tPmRvbWFpbl9pZCwKLSAgICAg
ICAgICAgICBzdmMtPnZjcHUtPnZjcHVfaWQsIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50KTsKKyAg
ICAgICAgICAgICBzdmMtPnVuaXQtPnVuaXRfaWQsIHNkb20tPmFjdGl2ZV91bml0X2NvdW50KTsK
IAogICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnBydi0+bG9jaywgZmxhZ3MpOwogfQogCiBz
dGF0aWMgaW5saW5lIHZvaWQKLV9fY3NjaGVkX3ZjcHVfYWNjdF9zdG9wX2xvY2tlZChzdHJ1Y3Qg
Y3NjaGVkX3ByaXZhdGUgKnBydiwKK19fY3NjaGVkX3VuaXRfYWNjdF9zdG9wX2xvY2tlZChzdHJ1
Y3QgY3NjaGVkX3ByaXZhdGUgKnBydiwKICAgICBzdHJ1Y3QgY3NjaGVkX3VuaXQgKnN2YykKIHsK
ICAgICBzdHJ1Y3QgY3NjaGVkX2RvbSAqIGNvbnN0IHNkb20gPSBzdmMtPnNkb207CiAKLSAgICBC
VUdfT04oIGxpc3RfZW1wdHkoJnN2Yy0+YWN0aXZlX3ZjcHVfZWxlbSkgKTsKKyAgICBCVUdfT04o
IGxpc3RfZW1wdHkoJnN2Yy0+YWN0aXZlX3VuaXRfZWxlbSkgKTsKIAotICAgIFNDSEVEX1ZDUFVf
U1RBVF9DUkFOSyhzdmMsIHN0YXRlX2lkbGUpOworICAgIFNDSEVEX1VOSVRfU1RBVF9DUkFOSyhz
dmMsIHN0YXRlX2lkbGUpOwogICAgIFNDSEVEX1NUQVRfQ1JBTksoYWNjdF91bml0X2lkbGUpOwog
CiAgICAgQlVHX09OKCBwcnYtPndlaWdodCA8IHNkb20tPndlaWdodCApOwotICAgIHNkb20tPmFj
dGl2ZV92Y3B1X2NvdW50LS07Ci0gICAgbGlzdF9kZWxfaW5pdCgmc3ZjLT5hY3RpdmVfdmNwdV9l
bGVtKTsKKyAgICBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudC0tOworICAgIGxpc3RfZGVsX2luaXQo
JnN2Yy0+YWN0aXZlX3VuaXRfZWxlbSk7CiAgICAgcHJ2LT53ZWlnaHQgLT0gc2RvbS0+d2VpZ2h0
OwotICAgIGlmICggbGlzdF9lbXB0eSgmc2RvbS0+YWN0aXZlX3ZjcHUpICkKKyAgICBpZiAoIGxp
c3RfZW1wdHkoJnNkb20tPmFjdGl2ZV91bml0KSApCiAgICAgewogICAgICAgICBsaXN0X2RlbF9p
bml0KCZzZG9tLT5hY3RpdmVfc2RvbV9lbGVtKTsKICAgICB9CiAKICAgICBUUkFDRV8zRChUUkNf
Q1NDSEVEX0FDQ09VTlRfU1RPUCwgc2RvbS0+ZG9tLT5kb21haW5faWQsCi0gICAgICAgICAgICAg
c3ZjLT52Y3B1LT52Y3B1X2lkLCBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudCk7CisgICAgICAgICAg
ICAgc3ZjLT51bml0LT51bml0X2lkLCBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCk7CiB9CiAKIHN0
YXRpYyB2b2lkCi1jc2NoZWRfdmNwdV9hY2N0KHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCB1
bnNpZ25lZCBpbnQgY3B1KQorY3NjaGVkX3VuaXRfYWNjdChzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUg
KnBydiwgdW5zaWduZWQgaW50IGNwdSkKIHsKICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqY3VycnVu
aXQgPSBjdXJyZW50LT5zY2hlZF91bml0OwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqIGNvbnN0
IHN2YyA9IENTQ0hFRF9VTklUKGN1cnJ1bml0KTsKICAgICBjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVy
ICpvcHMgPSBwZXJfY3B1KHNjaGVkdWxlciwgY3B1KTsKIAotICAgIEFTU0VSVCggY3VycmVudC0+
cHJvY2Vzc29yID09IGNwdSApOworICAgIEFTU0VSVCggc2NoZWRfdW5pdF9jcHUoY3VycnVuaXQp
ID09IGNwdSApOwogICAgIEFTU0VSVCggc3ZjLT5zZG9tICE9IE5VTEwgKTsKLSAgICBBU1NFUlQo
ICFpc19pZGxlX3ZjcHUoc3ZjLT52Y3B1KSApOworICAgIEFTU0VSVCggIWlzX2lkbGVfdW5pdChz
dmMtPnVuaXQpICk7CiAKICAgICAvKgotICAgICAqIElmIHRoaXMgVkNQVSdzIHByaW9yaXR5IHdh
cyBib29zdGVkIHdoZW4gaXQgbGFzdCBhd29rZSwgcmVzZXQgaXQuCi0gICAgICogSWYgdGhlIFZD
UFUgaXMgZm91bmQgaGVyZSwgdGhlbiBpdCdzIGNvbnN1bWluZyBhIG5vbi1uZWdsaWdlYWJsZQor
ICAgICAqIElmIHRoaXMgVU5JVCdzIHByaW9yaXR5IHdhcyBib29zdGVkIHdoZW4gaXQgbGFzdCBh
d29rZSwgcmVzZXQgaXQuCisgICAgICogSWYgdGhlIFVOSVQgaXMgZm91bmQgaGVyZSwgdGhlbiBp
dCdzIGNvbnN1bWluZyBhIG5vbi1uZWdsaWdlYWJsZQogICAgICAqIGFtb3VudCBvZiBDUFUgcmVz
b3VyY2VzIGFuZCBzaG91bGQgbm8gbG9uZ2VyIGJlIGJvb3N0ZWQuCiAgICAgICovCiAgICAgaWYg
KCBzdmMtPnByaSA9PSBDU0NIRURfUFJJX1RTX0JPT1NUICkKICAgICB7CiAgICAgICAgIHN2Yy0+
cHJpID0gQ1NDSEVEX1BSSV9UU19VTkRFUjsKICAgICAgICAgVFJBQ0VfMkQoVFJDX0NTQ0hFRF9C
T09TVF9FTkQsIHN2Yy0+c2RvbS0+ZG9tLT5kb21haW5faWQsCi0gICAgICAgICAgICAgICAgIHN2
Yy0+dmNwdS0+dmNwdV9pZCk7CisgICAgICAgICAgICAgICAgIHN2Yy0+dW5pdC0+dW5pdF9pZCk7
CiAgICAgfQogCiAgICAgLyoKQEAgLTk1MiwxMiArOTU1LDEyIEBAIGNzY2hlZF92Y3B1X2FjY3Qo
c3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYsIHVuc2lnbmVkIGludCBjcHUpCiAgICAgYnVybl9j
cmVkaXRzKHN2YywgTk9XKCkpOwogCiAgICAgLyoKLSAgICAgKiBQdXQgdGhpcyBWQ1BVIGFuZCBk
b21haW4gYmFjayBvbiB0aGUgYWN0aXZlIGxpc3QgaWYgaXQgd2FzCisgICAgICogUHV0IHRoaXMg
VU5JVCBhbmQgZG9tYWluIGJhY2sgb24gdGhlIGFjdGl2ZSBsaXN0IGlmIGl0IHdhcwogICAgICAq
IGlkbGluZy4KICAgICAgKi8KLSAgICBpZiAoIGxpc3RfZW1wdHkoJnN2Yy0+YWN0aXZlX3ZjcHVf
ZWxlbSkgKQorICAgIGlmICggbGlzdF9lbXB0eSgmc3ZjLT5hY3RpdmVfdW5pdF9lbGVtKSApCiAg
ICAgewotICAgICAgICBfX2NzY2hlZF92Y3B1X2FjY3Rfc3RhcnQocHJ2LCBzdmMpOworICAgICAg
ICBfX2NzY2hlZF91bml0X2FjY3Rfc3RhcnQocHJ2LCBzdmMpOwogICAgIH0KICAgICBlbHNlCiAg
ICAgewpAQCAtOTcwLDE1ICs5NzMsMTUgQEAgY3NjaGVkX3ZjcHVfYWNjdChzdHJ1Y3QgY3NjaGVk
X3ByaXZhdGUgKnBydiwgdW5zaWduZWQgaW50IGNwdSkKICAgICAgICAgICogbWlncmF0aW5nIGl0
IHRvIHJ1biBlbHNld2hlcmUgKHNlZSBtdWx0aS1jb3JlIGFuZCBtdWx0aS10aHJlYWQKICAgICAg
ICAgICogc3VwcG9ydCBpbiBjc2NoZWRfcmVzX3BpY2soKSkuCiAgICAgICAgICAqLwotICAgICAg
ICBuZXdfY3B1ID0gX2NzY2hlZF9jcHVfcGljayhvcHMsIGN1cnJlbnQsIDApOworICAgICAgICBu
ZXdfY3B1ID0gX2NzY2hlZF9jcHVfcGljayhvcHMsIGN1cnJ1bml0LCAwKTsKIAogICAgICAgICB1
bml0X3NjaGVkdWxlX3VubG9ja19pcnFyZXN0b3JlKGxvY2ssIGZsYWdzLCBjdXJydW5pdCk7CiAK
ICAgICAgICAgaWYgKCBuZXdfY3B1ICE9IGNwdSApCiAgICAgICAgIHsKLSAgICAgICAgICAgIFND
SEVEX1ZDUFVfU1RBVF9DUkFOSyhzdmMsIG1pZ3JhdGVfcik7CisgICAgICAgICAgICBTQ0hFRF9V
TklUX1NUQVRfQ1JBTksoc3ZjLCBtaWdyYXRlX3IpOwogICAgICAgICAgICAgU0NIRURfU1RBVF9D
UkFOSyhtaWdyYXRlX3J1bm5pbmcpOwotICAgICAgICAgICAgc2V0X2JpdChfVlBGX21pZ3JhdGlu
ZywgJmN1cnJlbnQtPnBhdXNlX2ZsYWdzKTsKKyAgICAgICAgICAgIHNjaGVkX3NldF9wYXVzZV9m
bGFnc19hdG9taWMoY3VycnVuaXQsIF9WUEZfbWlncmF0aW5nKTsKICAgICAgICAgICAgIC8qCiAg
ICAgICAgICAgICAgKiBBcyB3ZSBhcmUgYWJvdXQgdG8gdGlja2xlIGNwdSwgd2Ugc2hvdWxkIGNs
ZWFyIGl0cyBiaXQgaW4KICAgICAgICAgICAgICAqIGlkbGVycy4gQnV0LCBpZiB3ZSBhcmUgaGVy
ZSwgaXQgbWVhbnMgdGhlcmUgaXMgc29tZW9uZSBydW5uaW5nCkBAIC05OTUsMjEgKzk5OCwyMCBA
QCBzdGF0aWMgdm9pZCAqCiBjc2NoZWRfYWxsb2NfdmRhdGEoY29uc3Qgc3RydWN0IHNjaGVkdWxl
ciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKICAgICAgICAgICAgICAgICAgICB2b2lk
ICpkZCkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqdmMgPSB1bml0LT52Y3B1X2xpc3Q7CiAgICAgc3Ry
dWN0IGNzY2hlZF91bml0ICpzdmM7CiAKLSAgICAvKiBBbGxvY2F0ZSBwZXItVkNQVSBpbmZvICov
CisgICAgLyogQWxsb2NhdGUgcGVyLVVOSVQgaW5mbyAqLwogICAgIHN2YyA9IHh6YWxsb2Moc3Ry
dWN0IGNzY2hlZF91bml0KTsKICAgICBpZiAoIHN2YyA9PSBOVUxMICkKICAgICAgICAgcmV0dXJu
IE5VTEw7CiAKICAgICBJTklUX0xJU1RfSEVBRCgmc3ZjLT5ydW5xX2VsZW0pOwotICAgIElOSVRf
TElTVF9IRUFEKCZzdmMtPmFjdGl2ZV92Y3B1X2VsZW0pOworICAgIElOSVRfTElTVF9IRUFEKCZz
dmMtPmFjdGl2ZV91bml0X2VsZW0pOwogICAgIHN2Yy0+c2RvbSA9IGRkOwotICAgIHN2Yy0+dmNw
dSA9IHZjOwotICAgIHN2Yy0+cHJpID0gaXNfaWRsZV9kb21haW4odmMtPmRvbWFpbikgPworICAg
IHN2Yy0+dW5pdCA9IHVuaXQ7CisgICAgc3ZjLT5wcmkgPSBpc19pZGxlX3VuaXQodW5pdCkgPwog
ICAgICAgICBDU0NIRURfUFJJX0lETEUgOiBDU0NIRURfUFJJX1RTX1VOREVSOwotICAgIFNDSEVE
X1ZDUFVfU1RBVFNfUkVTRVQoc3ZjKTsKKyAgICBTQ0hFRF9VTklUX1NUQVRTX1JFU0VUKHN2Yyk7
CiAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0X2FsbG9jKTsKICAgICByZXR1cm4gc3ZjOwogfQpA
QCAtMTAxNywyNCArMTAxOSwyMSBAQCBjc2NoZWRfYWxsb2NfdmRhdGEoY29uc3Qgc3RydWN0IHNj
aGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKIHN0YXRpYyB2b2lkCiBjc2No
ZWRfdW5pdF9pbnNlcnQoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRf
dW5pdCAqdW5pdCkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqdmMgPSB1bml0LT52Y3B1X2xpc3Q7CiAg
ICAgc3RydWN0IGNzY2hlZF91bml0ICpzdmMgPSB1bml0LT5wcml2OwogICAgIHNwaW5sb2NrX3Qg
KmxvY2s7CiAKLSAgICBCVUdfT04oIGlzX2lkbGVfdmNwdSh2YykgKTsKKyAgICBCVUdfT04oIGlz
X2lkbGVfdW5pdCh1bml0KSApOwogCiAgICAgLyogY3NjaGVkX3Jlc19waWNrKCkgbG9va3MgaW4g
dmMtPnByb2Nlc3NvcidzIHJ1bnEsIHNvIHdlIG5lZWQgdGhlIGxvY2suICovCiAgICAgbG9jayA9
IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5pdCk7CiAKLSAgICB1bml0LT5yZXMgPSBjc2NoZWRf
cmVzX3BpY2sob3BzLCB1bml0KTsKLSAgICB2Yy0+cHJvY2Vzc29yID0gdW5pdC0+cmVzLT5tYXN0
ZXJfY3B1OworICAgIHNjaGVkX3NldF9yZXModW5pdCwgY3NjaGVkX3Jlc19waWNrKG9wcywgdW5p
dCkpOwogCiAgICAgc3Bpbl91bmxvY2tfaXJxKGxvY2spOwogCiAgICAgbG9jayA9IHVuaXRfc2No
ZWR1bGVfbG9ja19pcnEodW5pdCk7CiAKLSAgICBpZiAoICFfX3ZjcHVfb25fcnVucShzdmMpICYm
IHZjcHVfcnVubmFibGUodmMpICYmCi0gICAgICAgICAhdmMtPnNjaGVkX3VuaXQtPmlzX3J1bm5p
bmcgKQorICAgIGlmICggIV9fdW5pdF9vbl9ydW5xKHN2YykgJiYgdW5pdF9ydW5uYWJsZSh1bml0
KSAmJiAhdW5pdC0+aXNfcnVubmluZyApCiAgICAgICAgIHJ1bnFfaW5zZXJ0KHN2Yyk7CiAKICAg
ICB1bml0X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgdW5pdCk7CkBAIC0xMDYxLDE4ICsxMDYw
LDE4IEBAIGNzY2hlZF91bml0X3JlbW92ZShjb25zdCBzdHJ1Y3Qgc2NoZWR1bGVyICpvcHMsIHN0
cnVjdCBzY2hlZF91bml0ICp1bml0KQogCiAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0X3JlbW92
ZSk7CiAKLSAgICBBU1NFUlQoIV9fdmNwdV9vbl9ydW5xKHN2YykpOworICAgIEFTU0VSVCghX191
bml0X29uX3J1bnEoc3ZjKSk7CiAKLSAgICBpZiAoIHRlc3RfYW5kX2NsZWFyX2JpdChDU0NIRURf
RkxBR19WQ1BVX1BBUktFRCwgJnN2Yy0+ZmxhZ3MpICkKKyAgICBpZiAoIHRlc3RfYW5kX2NsZWFy
X2JpdChDU0NIRURfRkxBR19VTklUX1BBUktFRCwgJnN2Yy0+ZmxhZ3MpICkKICAgICB7CiAgICAg
ICAgIFNDSEVEX1NUQVRfQ1JBTksodW5pdF91bnBhcmspOwotICAgICAgICB2Y3B1X3VucGF1c2Uo
c3ZjLT52Y3B1KTsKKyAgICAgICAgdmNwdV91bnBhdXNlKHN2Yy0+dW5pdC0+dmNwdV9saXN0KTsK
ICAgICB9CiAKICAgICBzcGluX2xvY2tfaXJxKCZwcnYtPmxvY2spOwogCi0gICAgaWYgKCAhbGlz
dF9lbXB0eSgmc3ZjLT5hY3RpdmVfdmNwdV9lbGVtKSApCi0gICAgICAgIF9fY3NjaGVkX3ZjcHVf
YWNjdF9zdG9wX2xvY2tlZChwcnYsIHN2Yyk7CisgICAgaWYgKCAhbGlzdF9lbXB0eSgmc3ZjLT5h
Y3RpdmVfdW5pdF9lbGVtKSApCisgICAgICAgIF9fY3NjaGVkX3VuaXRfYWNjdF9zdG9wX2xvY2tl
ZChwcnYsIHN2Yyk7CiAKICAgICBzcGluX3VubG9ja19pcnEoJnBydi0+bG9jayk7CiAKQEAgLTEw
ODIsODYgKzEwODEsODUgQEAgY3NjaGVkX3VuaXRfcmVtb3ZlKGNvbnN0IHN0cnVjdCBzY2hlZHVs
ZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiBzdGF0aWMgdm9pZAogY3NjaGVkX3Vu
aXRfc2xlZXAoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1Y3Qgc2NoZWRfdW5pdCAq
dW5pdCkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqdmMgPSB1bml0LT52Y3B1X2xpc3Q7CiAgICAgc3Ry
dWN0IGNzY2hlZF91bml0ICogY29uc3Qgc3ZjID0gQ1NDSEVEX1VOSVQodW5pdCk7Ci0gICAgdW5z
aWduZWQgaW50IGNwdSA9IHZjLT5wcm9jZXNzb3I7CisgICAgdW5zaWduZWQgaW50IGNwdSA9IHNj
aGVkX3VuaXRfY3B1KHVuaXQpOwogCiAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0X3NsZWVwKTsK
IAotICAgIEJVR19PTiggaXNfaWRsZV92Y3B1KHZjKSApOworICAgIEJVR19PTiggaXNfaWRsZV91
bml0KHVuaXQpICk7CiAKICAgICBpZiAoIGN1cnJfb25fY3B1KGNwdSkgPT0gdW5pdCApCiAgICAg
ewogICAgICAgICAvKgogICAgICAgICAgKiBXZSBhcmUgYWJvdXQgdG8gdGlja2xlIGNwdSwgc28g
d2Ugc2hvdWxkIGNsZWFyIGl0cyBiaXQgaW4gaWRsZXJzLgotICAgICAgICAgKiBCdXQsIHdlIGFy
ZSBoZXJlIGJlY2F1c2UgdmMgaXMgZ29pbmcgdG8gc2xlZXAgd2hpbGUgcnVubmluZyBvbiBjcHUs
CisgICAgICAgICAqIEJ1dCwgd2UgYXJlIGhlcmUgYmVjYXVzZSB1bml0IGlzIGdvaW5nIHRvIHNs
ZWVwIHdoaWxlIHJ1bm5pbmcgb24gY3B1LAogICAgICAgICAgKiBzbyB0aGUgYml0IG11c3QgYmUg
emVybyBhbHJlYWR5LgogICAgICAgICAgKi8KICAgICAgICAgQVNTRVJUKCFjcHVtYXNrX3Rlc3Rf
Y3B1KGNwdSwgQ1NDSEVEX1BSSVYocGVyX2NwdShzY2hlZHVsZXIsIGNwdSkpLT5pZGxlcnMpKTsK
ICAgICAgICAgY3B1X3JhaXNlX3NvZnRpcnEoY3B1LCBTQ0hFRFVMRV9TT0ZUSVJRKTsKICAgICB9
Ci0gICAgZWxzZSBpZiAoIF9fdmNwdV9vbl9ydW5xKHN2YykgKQorICAgIGVsc2UgaWYgKCBfX3Vu
aXRfb25fcnVucShzdmMpICkKICAgICAgICAgcnVucV9yZW1vdmUoc3ZjKTsKIH0KIAogc3RhdGlj
IHZvaWQKIGNzY2hlZF91bml0X3dha2UoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBzdHJ1
Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqdmMgPSB1bml0LT52Y3B1
X2xpc3Q7CiAgICAgc3RydWN0IGNzY2hlZF91bml0ICogY29uc3Qgc3ZjID0gQ1NDSEVEX1VOSVQo
dW5pdCk7CiAgICAgYm9vbF90IG1pZ3JhdGluZzsKIAotICAgIEJVR19PTiggaXNfaWRsZV92Y3B1
KHZjKSApOworICAgIEJVR19PTiggaXNfaWRsZV91bml0KHVuaXQpICk7CiAKLSAgICBpZiAoIHVu
bGlrZWx5KGN1cnJfb25fY3B1KHZjLT5wcm9jZXNzb3IpID09IHVuaXQpICkKKyAgICBpZiAoIHVu
bGlrZWx5KGN1cnJfb25fY3B1KHNjaGVkX3VuaXRfY3B1KHVuaXQpKSA9PSB1bml0KSApCiAgICAg
ewogICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfd2FrZV9ydW5uaW5nKTsKICAgICAgICAg
cmV0dXJuOwogICAgIH0KLSAgICBpZiAoIHVubGlrZWx5KF9fdmNwdV9vbl9ydW5xKHN2YykpICkK
KyAgICBpZiAoIHVubGlrZWx5KF9fdW5pdF9vbl9ydW5xKHN2YykpICkKICAgICB7CiAgICAgICAg
IFNDSEVEX1NUQVRfQ1JBTksodW5pdF93YWtlX29ucnVucSk7CiAgICAgICAgIHJldHVybjsKICAg
ICB9CiAKLSAgICBpZiAoIGxpa2VseSh2Y3B1X3J1bm5hYmxlKHZjKSkgKQorICAgIGlmICggbGlr
ZWx5KHVuaXRfcnVubmFibGUodW5pdCkpICkKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0
X3dha2VfcnVubmFibGUpOwogICAgIGVsc2UKICAgICAgICAgU0NIRURfU1RBVF9DUkFOSyh1bml0
X3dha2Vfbm90X3J1bm5hYmxlKTsKIAogICAgIC8qCi0gICAgICogV2UgdGVtcG9yYXJseSBib29z
dCB0aGUgcHJpb3JpdHkgb2YgYXdha2luZyBWQ1BVcyEKKyAgICAgKiBXZSB0ZW1wb3JhcmlseSBi
b29zdCB0aGUgcHJpb3JpdHkgb2YgYXdha2luZyBVTklUcyEKICAgICAgKgotICAgICAqIElmIHRo
aXMgVkNQVSBjb25zdW1lcyBhIG5vbiBuZWdsaWdlYWJsZSBhbW91bnQgb2YgQ1BVLCBpdAorICAg
ICAqIElmIHRoaXMgVU5JVCBjb25zdW1lcyBhIG5vbiBuZWdsaWdpYmxlIGFtb3VudCBvZiBDUFUs
IGl0CiAgICAgICogd2lsbCBldmVudHVhbGx5IGZpbmQgaXRzZWxmIGluIHRoZSBjcmVkaXQgYWNj
b3VudGluZyBjb2RlCiAgICAgICogcGF0aCB3aGVyZSBpdHMgcHJpb3JpdHkgd2lsbCBiZSByZXNl
dCB0byBub3JtYWwuCiAgICAgICoKLSAgICAgKiBJZiBvbiB0aGUgb3RoZXIgaGFuZCB0aGUgVkNQ
VSBjb25zdW1lcyBsaXR0bGUgQ1BVIGFuZCBpcworICAgICAqIElmIG9uIHRoZSBvdGhlciBoYW5k
IHRoZSBVTklUIGNvbnN1bWVzIGxpdHRsZSBDUFUgYW5kIGlzCiAgICAgICogYmxvY2tpbmcgYW5k
IGF3b2tlbiBhIGxvdCAoZG9pbmcgSS9PIGZvciBleGFtcGxlKSwgaXRzCiAgICAgICogcHJpb3Jp
dHkgd2lsbCByZW1haW4gYm9vc3RlZCwgb3B0aW1pemluZyBpdCdzIHdha2UtdG8tcnVuCiAgICAg
ICogbGF0ZW5jaWVzLgogICAgICAqCi0gICAgICogVGhpcyBhbGxvd3Mgd2FrZS10by1ydW4gbGF0
ZW5jeSBzZW5zaXRpdmUgVkNQVXMgdG8gcHJlZW1wdAotICAgICAqIG1vcmUgQ1BVIHJlc291cmNl
IGludGVuc2l2ZSBWQ1BVcyB3aXRob3V0IGltcGFjdGluZyBvdmVyYWxsIAorICAgICAqIFRoaXMg
YWxsb3dzIHdha2UtdG8tcnVuIGxhdGVuY3kgc2Vuc2l0aXZlIFVOSVRzIHRvIHByZWVtcHQKKyAg
ICAgKiBtb3JlIENQVSByZXNvdXJjZSBpbnRlbnNpdmUgVU5JVHMgd2l0aG91dCBpbXBhY3Rpbmcg
b3ZlcmFsbAogICAgICAqIHN5c3RlbSBmYWlybmVzcy4KICAgICAgKgogICAgICAqIFRoZXJlIGFy
ZSB0d28gY2FzZXMsIHdoZW4gd2UgZG9uJ3Qgd2FudCB0byBib29zdDoKLSAgICAgKiAgLSBWQ1BV
cyB0aGF0IGFyZSB3YWtpbmcgdXAgYWZ0ZXIgYSBtaWdyYXRpb24sIHJhdGhlciB0aGFuCisgICAg
ICogIC0gVU5JVHMgdGhhdCBhcmUgd2FraW5nIHVwIGFmdGVyIGEgbWlncmF0aW9uLCByYXRoZXIg
dGhhbgogICAgICAqICAgIGFmdGVyIGhhdmluZyBibG9jazsKLSAgICAgKiAgLSBWQ1BVcyBvZiBj
YXBwZWQgZG9tYWlucyB1bnBhdXNpbmcgYWZ0ZXIgZWFybmluZyBjcmVkaXRzCisgICAgICogIC0g
VU5JVHMgb2YgY2FwcGVkIGRvbWFpbnMgdW5wYXVzaW5nIGFmdGVyIGVhcm5pbmcgY3JlZGl0cwog
ICAgICAqICAgIHRoZXkgaGFkIG92ZXJzcGVudC4KICAgICAgKi8KLSAgICBtaWdyYXRpbmcgPSB0
ZXN0X2FuZF9jbGVhcl9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9NSUdSQVRJTkcsICZzdmMtPmZsYWdz
KTsKKyAgICBtaWdyYXRpbmcgPSB0ZXN0X2FuZF9jbGVhcl9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9N
SUdSQVRJTkcsICZzdmMtPmZsYWdzKTsKIAogICAgIGlmICggIW1pZ3JhdGluZyAmJiBzdmMtPnBy
aSA9PSBDU0NIRURfUFJJX1RTX1VOREVSICYmCi0gICAgICAgICAhdGVzdF9iaXQoQ1NDSEVEX0ZM
QUdfVkNQVV9QQVJLRUQsICZzdmMtPmZsYWdzKSApCisgICAgICAgICAhdGVzdF9iaXQoQ1NDSEVE
X0ZMQUdfVU5JVF9QQVJLRUQsICZzdmMtPmZsYWdzKSApCiAgICAgewotICAgICAgICBUUkFDRV8y
RChUUkNfQ1NDSEVEX0JPT1NUX1NUQVJULCB2Yy0+ZG9tYWluLT5kb21haW5faWQsIHZjLT52Y3B1
X2lkKTsKKyAgICAgICAgVFJBQ0VfMkQoVFJDX0NTQ0hFRF9CT09TVF9TVEFSVCwgdW5pdC0+ZG9t
YWluLT5kb21haW5faWQsCisgICAgICAgICAgICAgICAgIHVuaXQtPnVuaXRfaWQpOwogICAgICAg
ICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfYm9vc3QpOwogICAgICAgICBzdmMtPnByaSA9IENTQ0hF
RF9QUklfVFNfQk9PU1Q7CiAgICAgfQogCi0gICAgLyogUHV0IHRoZSBWQ1BVIG9uIHRoZSBydW5x
IGFuZCB0aWNrbGUgQ1BVcyAqLworICAgIC8qIFB1dCB0aGUgVU5JVCBvbiB0aGUgcnVucSBhbmQg
dGlja2xlIENQVXMgKi8KICAgICBydW5xX2luc2VydChzdmMpOwogICAgIF9fcnVucV90aWNrbGUo
c3ZjKTsKIH0KQEAgLTExNzIsNyArMTE3MCw3IEBAIGNzY2hlZF91bml0X3lpZWxkKGNvbnN0IHN0
cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiAgICAgc3RydWN0
IGNzY2hlZF91bml0ICogY29uc3Qgc3ZjID0gQ1NDSEVEX1VOSVQodW5pdCk7CiAKICAgICAvKiBM
ZXQgdGhlIHNjaGVkdWxlciBrbm93IHRoYXQgdGhpcyB2Y3B1IGlzIHRyeWluZyB0byB5aWVsZCAq
LwotICAgIHNldF9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9ZSUVMRCwgJnN2Yy0+ZmxhZ3MpOworICAg
IHNldF9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9ZSUVMRCwgJnN2Yy0+ZmxhZ3MpOwogfQogCiBzdGF0
aWMgaW50CkBAIC0xMjAxLDggKzExOTksOCBAQCBjc2NoZWRfZG9tX2NudGwoCiAgICAgICAgIHsK
ICAgICAgICAgICAgIGlmICggIWxpc3RfZW1wdHkoJnNkb20tPmFjdGl2ZV9zZG9tX2VsZW0pICkK
ICAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAgICBwcnYtPndlaWdodCAtPSBzZG9tLT53ZWln
aHQgKiBzZG9tLT5hY3RpdmVfdmNwdV9jb3VudDsKLSAgICAgICAgICAgICAgICBwcnYtPndlaWdo
dCArPSBvcC0+dS5jcmVkaXQud2VpZ2h0ICogc2RvbS0+YWN0aXZlX3ZjcHVfY291bnQ7CisgICAg
ICAgICAgICAgICAgcHJ2LT53ZWlnaHQgLT0gc2RvbS0+d2VpZ2h0ICogc2RvbS0+YWN0aXZlX3Vu
aXRfY291bnQ7CisgICAgICAgICAgICAgICAgcHJ2LT53ZWlnaHQgKz0gb3AtPnUuY3JlZGl0Lndl
aWdodCAqIHNkb20tPmFjdGl2ZV91bml0X2NvdW50OwogICAgICAgICAgICAgfQogICAgICAgICAg
ICAgc2RvbS0+d2VpZ2h0ID0gb3AtPnUuY3JlZGl0LndlaWdodDsKICAgICAgICAgfQpAQCAtMTIz
MSw5ICsxMjI5LDkgQEAgY3NjaGVkX2FmZl9jbnRsKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9w
cywgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCiAKICAgICAvKiBBcmUgd2UgYmVjb21pbmcgZXhj
bHVzaXZlbHkgcGlubmVkPyAqLwogICAgIGlmICggY3B1bWFza193ZWlnaHQoaGFyZCkgPT0gMSAp
Ci0gICAgICAgIHNldF9iaXQoQ1NDSEVEX0ZMQUdfVkNQVV9QSU5ORUQsICZzdmMtPmZsYWdzKTsK
KyAgICAgICAgc2V0X2JpdChDU0NIRURfRkxBR19VTklUX1BJTk5FRCwgJnN2Yy0+ZmxhZ3MpOwog
ICAgIGVsc2UKLSAgICAgICAgY2xlYXJfYml0KENTQ0hFRF9GTEFHX1ZDUFVfUElOTkVELCAmc3Zj
LT5mbGFncyk7CisgICAgICAgIGNsZWFyX2JpdChDU0NIRURfRkxBR19VTklUX1BJTk5FRCwgJnN2
Yy0+ZmxhZ3MpOwogfQogCiBzdGF0aWMgaW5saW5lIHZvaWQKQEAgLTEyNzYsMTQgKzEyNzQsMTQg
QEAgY3NjaGVkX3N5c19jbnRsKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywKICAgICAgICAg
ZWxzZSBpZiAoIHBydi0+cmF0ZWxpbWl0ICYmICFwYXJhbXMtPnJhdGVsaW1pdF91cyApCiAgICAg
ICAgICAgICBwcmludGsoWEVOTE9HX0lORk8gIkRpc2FibGluZyBjb250ZXh0IHN3aXRjaCByYXRl
IGxpbWl0aW5nXG4iKTsKICAgICAgICAgcHJ2LT5yYXRlbGltaXQgPSBNSUNST1NFQ1MocGFyYW1z
LT5yYXRlbGltaXRfdXMpOwotICAgICAgICBwcnYtPnZjcHVfbWlncl9kZWxheSA9IE1JQ1JPU0VD
UyhwYXJhbXMtPnZjcHVfbWlncl9kZWxheV91cyk7CisgICAgICAgIHBydi0+dW5pdF9taWdyX2Rl
bGF5ID0gTUlDUk9TRUNTKHBhcmFtcy0+dmNwdV9taWdyX2RlbGF5X3VzKTsKICAgICAgICAgc3Bp
bl91bmxvY2tfaXJxcmVzdG9yZSgmcHJ2LT5sb2NrLCBmbGFncyk7CiAKICAgICAgICAgLyogRkFM
TFRIUlUgKi8KICAgICBjYXNlIFhFTl9TWVNDVExfU0NIRURPUF9nZXRpbmZvOgogICAgICAgICBw
YXJhbXMtPnRzbGljZV9tcyA9IHBydi0+dHNsaWNlIC8gTUlMTElTRUNTKDEpOwogICAgICAgICBw
YXJhbXMtPnJhdGVsaW1pdF91cyA9IHBydi0+cmF0ZWxpbWl0IC8gTUlDUk9TRUNTKDEpOwotICAg
ICAgICBwYXJhbXMtPnZjcHVfbWlncl9kZWxheV91cyA9IHBydi0+dmNwdV9taWdyX2RlbGF5IC8g
TUlDUk9TRUNTKDEpOworICAgICAgICBwYXJhbXMtPnZjcHVfbWlncl9kZWxheV91cyA9IHBydi0+
dW5pdF9taWdyX2RlbGF5IC8gTUlDUk9TRUNTKDEpOwogICAgICAgICByYyA9IDA7CiAgICAgICAg
IGJyZWFrOwogICAgIH0KQEAgLTEzMDEsNyArMTI5OSw3IEBAIGNzY2hlZF9hbGxvY19kb21kYXRh
KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgc3RydWN0IGRvbWFpbiAqZG9tKQogICAgICAg
ICByZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKIAogICAgIC8qIEluaXRpYWxpemUgY3JlZGl0IGFu
ZCB3ZWlnaHQgKi8KLSAgICBJTklUX0xJU1RfSEVBRCgmc2RvbS0+YWN0aXZlX3ZjcHUpOworICAg
IElOSVRfTElTVF9IRUFEKCZzZG9tLT5hY3RpdmVfdW5pdCk7CiAgICAgSU5JVF9MSVNUX0hFQUQo
JnNkb20tPmFjdGl2ZV9zZG9tX2VsZW0pOwogICAgIHNkb20tPmRvbSA9IGRvbTsKICAgICBzZG9t
LT53ZWlnaHQgPSBDU0NIRURfREVGQVVMVF9XRUlHSFQ7CkBAIC0xMzE4LDcgKzEzMTYsNyBAQCBj
c2NoZWRfZnJlZV9kb21kYXRhKGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9wcywgdm9pZCAqZGF0
YSkKIC8qCiAgKiBUaGlzIGlzIGEgTyhuKSBvcHRpbWl6ZWQgc29ydCBvZiB0aGUgcnVucS4KICAq
Ci0gKiBUaW1lLXNoYXJlIFZDUFVzIGNhbiBvbmx5IGJlIG9uZSBvZiB0d28gcHJpb3JpdGllcywg
VU5ERVIgb3IgT1ZFUi4gV2Ugd2FsaworICogVGltZS1zaGFyZSBVTklUcyBjYW4gb25seSBiZSBv
bmUgb2YgdHdvIHByaW9yaXRpZXMsIFVOREVSIG9yIE9WRVIuIFdlIHdhbGsKICAqIHRocm91Z2gg
dGhlIHJ1bnEgYW5kIG1vdmUgdXAgYW55IFVOREVScyB0aGF0IGFyZSBwcmVjZWRlZCBieSBPVkVS
Uy4gV2UKICAqIHJlbWVtYmVyIHRoZSBsYXN0IFVOREVSIHRvIG1ha2UgdGhlIG1vdmUgdXAgb3Bl
cmF0aW9uIE8oMSkuCiAgKi8KQEAgLTEzNzEsNyArMTM2OSw3IEBAIGNzY2hlZF9hY2N0KHZvaWQq
IGR1bW15KQogewogICAgIHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2ID0gZHVtbXk7CiAgICAg
dW5zaWduZWQgbG9uZyBmbGFnczsKLSAgICBzdHJ1Y3QgbGlzdF9oZWFkICppdGVyX3ZjcHUsICpu
ZXh0X3ZjcHU7CisgICAgc3RydWN0IGxpc3RfaGVhZCAqaXRlcl91bml0LCAqbmV4dF91bml0Owog
ICAgIHN0cnVjdCBsaXN0X2hlYWQgKml0ZXJfc2RvbSwgKm5leHRfc2RvbTsKICAgICBzdHJ1Y3Qg
Y3NjaGVkX3VuaXQgKnN2YzsKICAgICBzdHJ1Y3QgY3NjaGVkX2RvbSAqc2RvbTsKQEAgLTE0MTgs
MjYgKzE0MTYsMjYgQEAgY3NjaGVkX2FjY3Qodm9pZCogZHVtbXkpCiAgICAgICAgIHNkb20gPSBs
aXN0X2VudHJ5KGl0ZXJfc2RvbSwgc3RydWN0IGNzY2hlZF9kb20sIGFjdGl2ZV9zZG9tX2VsZW0p
OwogCiAgICAgICAgIEJVR19PTiggaXNfaWRsZV9kb21haW4oc2RvbS0+ZG9tKSApOwotICAgICAg
ICBCVUdfT04oIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50ID09IDAgKTsKKyAgICAgICAgQlVHX09O
KCBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCA9PSAwICk7CiAgICAgICAgIEJVR19PTiggc2RvbS0+
d2VpZ2h0ID09IDAgKTsKLSAgICAgICAgQlVHX09OKCAoc2RvbS0+d2VpZ2h0ICogc2RvbS0+YWN0
aXZlX3ZjcHVfY291bnQpID4gd2VpZ2h0X2xlZnQgKTsKKyAgICAgICAgQlVHX09OKCAoc2RvbS0+
d2VpZ2h0ICogc2RvbS0+YWN0aXZlX3VuaXRfY291bnQpID4gd2VpZ2h0X2xlZnQgKTsKIAotICAg
ICAgICB3ZWlnaHRfbGVmdCAtPSAoIHNkb20tPndlaWdodCAqIHNkb20tPmFjdGl2ZV92Y3B1X2Nv
dW50ICk7CisgICAgICAgIHdlaWdodF9sZWZ0IC09ICggc2RvbS0+d2VpZ2h0ICogc2RvbS0+YWN0
aXZlX3VuaXRfY291bnQgKTsKIAogICAgICAgICAvKgogICAgICAgICAgKiBBIGRvbWFpbidzIGZh
aXIgc2hhcmUgaXMgY29tcHV0ZWQgdXNpbmcgaXRzIHdlaWdodCBpbiBjb21wZXRpdGlvbgogICAg
ICAgICAgKiB3aXRoIHRoYXQgb2YgYWxsIG90aGVyIGFjdGl2ZSBkb21haW5zLgogICAgICAgICAg
KgotICAgICAgICAgKiBBdCBtb3N0LCBhIGRvbWFpbiBjYW4gdXNlIGNyZWRpdHMgdG8gcnVuIGFs
bCBpdHMgYWN0aXZlIFZDUFVzCisgICAgICAgICAqIEF0IG1vc3QsIGEgZG9tYWluIGNhbiB1c2Ug
Y3JlZGl0cyB0byBydW4gYWxsIGl0cyBhY3RpdmUgVU5JVHMKICAgICAgICAgICogZm9yIG9uZSBm
dWxsIGFjY291bnRpbmcgcGVyaW9kLiBXZSBhbGxvdyBhIGRvbWFpbiB0byBlYXJuIG1vcmUKICAg
ICAgICAgICogb25seSB3aGVuIHRoZSBzeXN0ZW0td2lkZSBjcmVkaXQgYmFsYW5jZSBpcyBuZWdh
dGl2ZS4KICAgICAgICAgICovCi0gICAgICAgIGNyZWRpdF9wZWFrID0gc2RvbS0+YWN0aXZlX3Zj
cHVfY291bnQgKiBwcnYtPmNyZWRpdHNfcGVyX3RzbGljZTsKKyAgICAgICAgY3JlZGl0X3BlYWsg
PSBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCAqIHBydi0+Y3JlZGl0c19wZXJfdHNsaWNlOwogICAg
ICAgICBpZiAoIHBydi0+Y3JlZGl0X2JhbGFuY2UgPCAwICkKICAgICAgICAgewogICAgICAgICAg
ICAgY3JlZGl0X3BlYWsgKz0gKCAoIC1wcnYtPmNyZWRpdF9iYWxhbmNlCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgKiBzZG9tLT53ZWlnaHQKLSAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAqIHNkb20tPmFjdGl2ZV92Y3B1X2NvdW50KSArCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgKiBzZG9tLT5hY3RpdmVfdW5pdF9jb3VudCkgKwogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAod2VpZ2h0X3RvdGFsIC0gMSkKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICkgLyB3ZWlnaHRfdG90YWw7CiAgICAgICAgIH0KQEAgLTE0NDgsMTQgKzE0NDYsMTQgQEAg
Y3NjaGVkX2FjY3Qodm9pZCogZHVtbXkpCiAgICAgICAgICAgICBpZiAoIGNyZWRpdF9jYXAgPCBj
cmVkaXRfcGVhayApCiAgICAgICAgICAgICAgICAgY3JlZGl0X3BlYWsgPSBjcmVkaXRfY2FwOwog
Ci0gICAgICAgICAgICAvKiBGSVhNRSAtLSBzZXQgY2FwIHBlci12Y3B1IGFzIHdlbGwuLi4/ICov
Ci0gICAgICAgICAgICBjcmVkaXRfY2FwID0gKCBjcmVkaXRfY2FwICsgKCBzZG9tLT5hY3RpdmVf
dmNwdV9jb3VudCAtIDEgKQotICAgICAgICAgICAgICAgICAgICAgICAgICkgLyBzZG9tLT5hY3Rp
dmVfdmNwdV9jb3VudDsKKyAgICAgICAgICAgIC8qIEZJWE1FIC0tIHNldCBjYXAgcGVyLXVuaXQg
YXMgd2VsbC4uLj8gKi8KKyAgICAgICAgICAgIGNyZWRpdF9jYXAgPSAoIGNyZWRpdF9jYXAgKyAo
IHNkb20tPmFjdGl2ZV91bml0X2NvdW50IC0gMSApCisgICAgICAgICAgICAgICAgICAgICAgICAg
KSAvIHNkb20tPmFjdGl2ZV91bml0X2NvdW50OwogICAgICAgICB9CiAKICAgICAgICAgY3JlZGl0
X2ZhaXIgPSAoICggY3JlZGl0X3RvdGFsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICogc2Rv
bS0+d2VpZ2h0Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICogc2RvbS0+YWN0aXZlX3ZjcHVf
Y291bnQgKQorICAgICAgICAgICAgICAgICAgICAgICAgICAqIHNkb20tPmFjdGl2ZV91bml0X2Nv
dW50ICkKICAgICAgICAgICAgICAgICAgICAgICAgICsgKHdlaWdodF90b3RhbCAtIDEpCiAgICAg
ICAgICAgICAgICAgICAgICAgKSAvIHdlaWdodF90b3RhbDsKIApAQCAtMTQ4OSwxNCArMTQ4Nywx
NCBAQCBjc2NoZWRfYWNjdCh2b2lkKiBkdW1teSkKICAgICAgICAgICAgIGNyZWRpdF9mYWlyID0g
Y3JlZGl0X3BlYWs7CiAgICAgICAgIH0KIAotICAgICAgICAvKiBDb21wdXRlIGZhaXIgc2hhcmUg
cGVyIFZDUFUgKi8KLSAgICAgICAgY3JlZGl0X2ZhaXIgPSAoIGNyZWRpdF9mYWlyICsgKCBzZG9t
LT5hY3RpdmVfdmNwdV9jb3VudCAtIDEgKQotICAgICAgICAgICAgICAgICAgICAgICkgLyBzZG9t
LT5hY3RpdmVfdmNwdV9jb3VudDsKKyAgICAgICAgLyogQ29tcHV0ZSBmYWlyIHNoYXJlIHBlciBV
TklUICovCisgICAgICAgIGNyZWRpdF9mYWlyID0gKCBjcmVkaXRfZmFpciArICggc2RvbS0+YWN0
aXZlX3VuaXRfY291bnQgLSAxICkKKyAgICAgICAgICAgICAgICAgICAgICApIC8gc2RvbS0+YWN0
aXZlX3VuaXRfY291bnQ7CiAKIAotICAgICAgICBsaXN0X2Zvcl9lYWNoX3NhZmUoIGl0ZXJfdmNw
dSwgbmV4dF92Y3B1LCAmc2RvbS0+YWN0aXZlX3ZjcHUgKQorICAgICAgICBsaXN0X2Zvcl9lYWNo
X3NhZmUoIGl0ZXJfdW5pdCwgbmV4dF91bml0LCAmc2RvbS0+YWN0aXZlX3VuaXQgKQogICAgICAg
ICB7Ci0gICAgICAgICAgICBzdmMgPSBsaXN0X2VudHJ5KGl0ZXJfdmNwdSwgc3RydWN0IGNzY2hl
ZF91bml0LCBhY3RpdmVfdmNwdV9lbGVtKTsKKyAgICAgICAgICAgIHN2YyA9IGxpc3RfZW50cnko
aXRlcl91bml0LCBzdHJ1Y3QgY3NjaGVkX3VuaXQsIGFjdGl2ZV91bml0X2VsZW0pOwogICAgICAg
ICAgICAgQlVHX09OKCBzZG9tICE9IHN2Yy0+c2RvbSApOwogCiAgICAgICAgICAgICAvKiBJbmNy
ZW1lbnQgY3JlZGl0ICovCkBAIC0xNTA0LDIwICsxNTAyLDIwIEBAIGNzY2hlZF9hY2N0KHZvaWQq
IGR1bW15KQogICAgICAgICAgICAgY3JlZGl0ID0gYXRvbWljX3JlYWQoJnN2Yy0+Y3JlZGl0KTsK
IAogICAgICAgICAgICAgLyoKLSAgICAgICAgICAgICAqIFJlY29tcHV0ZSBwcmlvcml0eSBvciwg
aWYgVkNQVSBpcyBpZGxpbmcsIHJlbW92ZSBpdCBmcm9tCisgICAgICAgICAgICAgKiBSZWNvbXB1
dGUgcHJpb3JpdHkgb3IsIGlmIFVOSVQgaXMgaWRsaW5nLCByZW1vdmUgaXQgZnJvbQogICAgICAg
ICAgICAgICogdGhlIGFjdGl2ZSBsaXN0LgogICAgICAgICAgICAgICovCiAgICAgICAgICAgICBp
ZiAoIGNyZWRpdCA8IDAgKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIHN2Yy0+cHJp
ID0gQ1NDSEVEX1BSSV9UU19PVkVSOwogCi0gICAgICAgICAgICAgICAgLyogUGFyayBydW5uaW5n
IFZDUFVzIG9mIGNhcHBlZC1vdXQgZG9tYWlucyAqLworICAgICAgICAgICAgICAgIC8qIFBhcmsg
cnVubmluZyBVTklUcyBvZiBjYXBwZWQtb3V0IGRvbWFpbnMgKi8KICAgICAgICAgICAgICAgICBp
ZiAoIHNkb20tPmNhcCAhPSAwVSAmJgogICAgICAgICAgICAgICAgICAgICAgY3JlZGl0IDwgLWNy
ZWRpdF9jYXAgJiYKLSAgICAgICAgICAgICAgICAgICAgICF0ZXN0X2FuZF9zZXRfYml0KENTQ0hF
RF9GTEFHX1ZDUFVfUEFSS0VELCAmc3ZjLT5mbGFncykgKQorICAgICAgICAgICAgICAgICAgICAg
IXRlc3RfYW5kX3NldF9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9QQVJLRUQsICZzdmMtPmZsYWdzKSAp
CiAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NSQU5L
KHVuaXRfcGFyayk7Ci0gICAgICAgICAgICAgICAgICAgIHZjcHVfcGF1c2Vfbm9zeW5jKHN2Yy0+
dmNwdSk7CisgICAgICAgICAgICAgICAgICAgIHZjcHVfcGF1c2Vfbm9zeW5jKHN2Yy0+dW5pdC0+
dmNwdV9saXN0KTsKICAgICAgICAgICAgICAgICB9CiAKICAgICAgICAgICAgICAgICAvKiBMb3dl
ciBib3VuZCBvbiBjcmVkaXRzICovCkBAIC0xNTMzLDIyICsxNTMxLDIyIEBAIGNzY2hlZF9hY2N0
KHZvaWQqIGR1bW15KQogICAgICAgICAgICAgICAgIHN2Yy0+cHJpID0gQ1NDSEVEX1BSSV9UU19V
TkRFUjsKIAogICAgICAgICAgICAgICAgIC8qIFVucGFyayBhbnkgY2FwcGVkIGRvbWFpbnMgd2hv
c2UgY3JlZGl0cyBnbyBwb3NpdGl2ZSAqLwotICAgICAgICAgICAgICAgIGlmICggdGVzdF9iaXQo
Q1NDSEVEX0ZMQUdfVkNQVV9QQVJLRUQsICZzdmMtPmZsYWdzKSApCisgICAgICAgICAgICAgICAg
aWYgKCB0ZXN0X2JpdChDU0NIRURfRkxBR19VTklUX1BBUktFRCwgJnN2Yy0+ZmxhZ3MpICkKICAg
ICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAg
ICAgICAqIEl0J3MgaW1wb3J0YW50IHRvIHVuc2V0IHRoZSBmbGFnIEFGVEVSIHRoZSB1bnBhdXNl
KCkKLSAgICAgICAgICAgICAgICAgICAgICogY2FsbCB0byBtYWtlIHN1cmUgdGhlIFZDUFUncyBw
cmlvcml0eSBpcyBub3QgYm9vc3RlZAorICAgICAgICAgICAgICAgICAgICAgKiBjYWxsIHRvIG1h
a2Ugc3VyZSB0aGUgVU5JVCdzIHByaW9yaXR5IGlzIG5vdCBib29zdGVkCiAgICAgICAgICAgICAg
ICAgICAgICAqIGlmIGl0IGlzIHdva2VuIHVwIGhlcmUuCiAgICAgICAgICAgICAgICAgICAgICAq
LwogICAgICAgICAgICAgICAgICAgICBTQ0hFRF9TVEFUX0NSQU5LKHVuaXRfdW5wYXJrKTsKLSAg
ICAgICAgICAgICAgICAgICAgdmNwdV91bnBhdXNlKHN2Yy0+dmNwdSk7Ci0gICAgICAgICAgICAg
ICAgICAgIGNsZWFyX2JpdChDU0NIRURfRkxBR19WQ1BVX1BBUktFRCwgJnN2Yy0+ZmxhZ3MpOwor
ICAgICAgICAgICAgICAgICAgICB2Y3B1X3VucGF1c2Uoc3ZjLT51bml0LT52Y3B1X2xpc3QpOwor
ICAgICAgICAgICAgICAgICAgICBjbGVhcl9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9QQVJLRUQsICZz
dmMtPmZsYWdzKTsKICAgICAgICAgICAgICAgICB9CiAKLSAgICAgICAgICAgICAgICAvKiBVcHBl
ciBib3VuZCBvbiBjcmVkaXRzIG1lYW5zIFZDUFUgc3RvcHMgZWFybmluZyAqLworICAgICAgICAg
ICAgICAgIC8qIFVwcGVyIGJvdW5kIG9uIGNyZWRpdHMgbWVhbnMgVU5JVCBzdG9wcyBlYXJuaW5n
ICovCiAgICAgICAgICAgICAgICAgaWYgKCBjcmVkaXQgPiBwcnYtPmNyZWRpdHNfcGVyX3RzbGlj
ZSApCiAgICAgICAgICAgICAgICAgewotICAgICAgICAgICAgICAgICAgICBfX2NzY2hlZF92Y3B1
X2FjY3Rfc3RvcF9sb2NrZWQocHJ2LCBzdmMpOworICAgICAgICAgICAgICAgICAgICBfX2NzY2hl
ZF91bml0X2FjY3Rfc3RvcF9sb2NrZWQocHJ2LCBzdmMpOwogICAgICAgICAgICAgICAgICAgICAv
KiBEaXZpZGUgY3JlZGl0cyBpbiBoYWxmLCBzbyB0aGF0IHdoZW4gaXQgc3RhcnRzCiAgICAgICAg
ICAgICAgICAgICAgICAqIGFjY291bnRpbmcgYWdhaW4sIGl0IHN0YXJ0cyBhIGxpdHRsZSBiaXQg
ImFoZWFkIiAqLwogICAgICAgICAgICAgICAgICAgICBjcmVkaXQgLz0gMjsKQEAgLTE1NTYsOCAr
MTU1NCw4IEBAIGNzY2hlZF9hY2N0KHZvaWQqIGR1bW15KQogICAgICAgICAgICAgICAgIH0KICAg
ICAgICAgICAgIH0KIAotICAgICAgICAgICAgU0NIRURfVkNQVV9TVEFUX1NFVChzdmMsIGNyZWRp
dF9sYXN0LCBjcmVkaXQpOwotICAgICAgICAgICAgU0NIRURfVkNQVV9TVEFUX1NFVChzdmMsIGNy
ZWRpdF9pbmNyLCBjcmVkaXRfZmFpcik7CisgICAgICAgICAgICBTQ0hFRF9VTklUX1NUQVRfU0VU
KHN2YywgY3JlZGl0X2xhc3QsIGNyZWRpdCk7CisgICAgICAgICAgICBTQ0hFRF9VTklUX1NUQVRf
U0VUKHN2YywgY3JlZGl0X2luY3IsIGNyZWRpdF9mYWlyKTsKICAgICAgICAgICAgIGNyZWRpdF9i
YWxhbmNlICs9IGNyZWRpdDsKICAgICAgICAgfQogICAgIH0KQEAgLTE1ODMsMTAgKzE1ODEsMTAg
QEAgY3NjaGVkX3RpY2sodm9pZCAqX2NwdSkKICAgICBzcGMtPnRpY2srKzsKIAogICAgIC8qCi0g
ICAgICogQWNjb3VudGluZyBmb3IgcnVubmluZyBWQ1BVCisgICAgICogQWNjb3VudGluZyBmb3Ig
cnVubmluZyBVTklUCiAgICAgICovCi0gICAgaWYgKCAhaXNfaWRsZV92Y3B1KGN1cnJlbnQpICkK
LSAgICAgICAgY3NjaGVkX3ZjcHVfYWNjdChwcnYsIGNwdSk7CisgICAgaWYgKCAhaXNfaWRsZV91
bml0KGN1cnJlbnQtPnNjaGVkX3VuaXQpICkKKyAgICAgICAgY3NjaGVkX3VuaXRfYWNjdChwcnYs
IGNwdSk7CiAKICAgICAvKgogICAgICAqIENoZWNrIGlmIHJ1bnEgbmVlZHMgdG8gYmUgc29ydGVk
CkBAIC0xNjA3LDcgKzE2MDUsNyBAQCBjc2NoZWRfcnVucV9zdGVhbChpbnQgcGVlcl9jcHUsIGlu
dCBjcHUsIGludCBwcmksIGludCBiYWxhbmNlX3N0ZXApCiAgICAgY29uc3Qgc3RydWN0IGNzY2hl
ZF9wY3B1ICogY29uc3QgcGVlcl9wY3B1ID0gQ1NDSEVEX1BDUFUocGVlcl9jcHUpOwogICAgIHN0
cnVjdCBjc2NoZWRfdW5pdCAqc3BlZXI7CiAgICAgc3RydWN0IGxpc3RfaGVhZCAqaXRlcjsKLSAg
ICBzdHJ1Y3QgdmNwdSAqdmM7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAKICAgICBB
U1NFUlQocGVlcl9wY3B1ICE9IE5VTEwpOwogCkBAIC0xNjE1LDcgKzE2MTMsNyBAQCBjc2NoZWRf
cnVucV9zdGVhbChpbnQgcGVlcl9jcHUsIGludCBjcHUsIGludCBwcmksIGludCBiYWxhbmNlX3N0
ZXApCiAgICAgICogRG9uJ3Qgc3RlYWwgZnJvbSBhbiBpZGxlIENQVSdzIHJ1bnEgYmVjYXVzZSBp
dCdzIGFib3V0IHRvCiAgICAgICogcGljayB1cCB3b3JrIGZyb20gaXQgaXRzZWxmLgogICAgICAq
LwotICAgIGlmICggdW5saWtlbHkoaXNfaWRsZV92Y3B1KGN1cnJfb25fY3B1KHBlZXJfY3B1KS0+
dmNwdV9saXN0KSkgKQorICAgIGlmICggdW5saWtlbHkoaXNfaWRsZV91bml0KGN1cnJfb25fY3B1
KHBlZXJfY3B1KSkpICkKICAgICAgICAgZ290byBvdXQ7CiAKICAgICBsaXN0X2Zvcl9lYWNoKCBp
dGVyLCAmcGVlcl9wY3B1LT5ydW5xICkKQEAgLTE2MjMsNDYgKzE2MjEsNDQgQEAgY3NjaGVkX3J1
bnFfc3RlYWwoaW50IHBlZXJfY3B1LCBpbnQgY3B1LCBpbnQgcHJpLCBpbnQgYmFsYW5jZV9zdGVw
KQogICAgICAgICBzcGVlciA9IF9fcnVucV9lbGVtKGl0ZXIpOwogCiAgICAgICAgIC8qCi0gICAg
ICAgICAqIElmIG5leHQgYXZhaWxhYmxlIFZDUFUgaGVyZSBpcyBub3Qgb2Ygc3RyaWN0bHkgaGln
aGVyCisgICAgICAgICAqIElmIG5leHQgYXZhaWxhYmxlIFVOSVQgaGVyZSBpcyBub3Qgb2Ygc3Ry
aWN0bHkgaGlnaGVyCiAgICAgICAgICAqIHByaW9yaXR5IHRoYW4gb3VycywgdGhpcyBQQ1BVIGlz
IHVzZWxlc3MgdG8gdXMuCiAgICAgICAgICAqLwogICAgICAgICBpZiAoIHNwZWVyLT5wcmkgPD0g
cHJpICkKICAgICAgICAgICAgIGJyZWFrOwogCi0gICAgICAgIC8qIElzIHRoaXMgVkNQVSBydW5u
YWJsZSBvbiBvdXIgUENQVT8gKi8KLSAgICAgICAgdmMgPSBzcGVlci0+dmNwdTsKLSAgICAgICAg
QlVHX09OKCBpc19pZGxlX3ZjcHUodmMpICk7CisgICAgICAgIC8qIElzIHRoaXMgVU5JVCBydW5u
YWJsZSBvbiBvdXIgUENQVT8gKi8KKyAgICAgICAgdW5pdCA9IHNwZWVyLT51bml0OworICAgICAg
ICBCVUdfT04oIGlzX2lkbGVfdW5pdCh1bml0KSApOwogCiAgICAgICAgIC8qCi0gICAgICAgICAq
IElmIHRoZSB2Y3B1IGlzIHN0aWxsIGluIHBlZXJfY3B1J3Mgc2NoZWR1bGluZyB0YWlsLCBvciBp
ZiBpdAorICAgICAgICAgKiBJZiB0aGUgdW5pdCBpcyBzdGlsbCBpbiBwZWVyX2NwdSdzIHNjaGVk
dWxpbmcgdGFpbCwgb3IgaWYgaXQKICAgICAgICAgICogaGFzIG5vIHVzZWZ1bCBzb2Z0IGFmZmlu
aXR5LCBza2lwIGl0LgogICAgICAgICAgKgogICAgICAgICAgKiBJbiBmYWN0LCB3aGF0IHdlIHdh
bnQgaXMgdG8gY2hlY2sgaWYgd2UgaGF2ZSBhbnkgInNvZnQtYWZmaW5lCiAgICAgICAgICAqIHdv
cmsiIHRvIHN0ZWFsLCBiZWZvcmUgc3RhcnRpbmcgdG8gbG9vayBhdCAiaGFyZC1hZmZpbmUgd29y
ayIuCiAgICAgICAgICAqCi0gICAgICAgICAqIE5vdGljZSB0aGF0LCBpZiBub3QgZXZlbiBvbmUg
dkNQVSBvbiB0aGlzIHJ1bnEgaGFzIGEgdXNlZnVsCisgICAgICAgICAqIE5vdGljZSB0aGF0LCBp
ZiBub3QgZXZlbiBvbmUgdW5pdCBvbiB0aGlzIHJ1bnEgaGFzIGEgdXNlZnVsCiAgICAgICAgICAq
IHNvZnQgYWZmaW5pdHksIHdlIGNvdWxkIGhhdmUgYXZvaWQgY29uc2lkZXJpbmcgdGhpcyBydW5x
IGZvcgogICAgICAgICAgKiBhIHNvZnQgYmFsYW5jaW5nIHN0ZXAgaW4gdGhlIGZpcnN0IHBsYWNl
LiBUaGlzLCBmb3IgaW5zdGFuY2UsCiAgICAgICAgICAqIGNhbiBiZSBpbXBsZW1lbnRlZCBieSB0
YWtpbmcgbm90ZSBvZiBvbiB3aGF0IHJ1bnEgdGhlcmUgYXJlCi0gICAgICAgICAqIHZDUFVzIHdp
dGggdXNlZnVsIHNvZnQgYWZmaW5pdGllcyBpbiBzb21lIHNvcnQgb2YgYml0bWFwCisgICAgICAg
ICAqIHVuaXRzIHdpdGggdXNlZnVsIHNvZnQgYWZmaW5pdGllcyBpbiBzb21lIHNvcnQgb2YgYml0
bWFwCiAgICAgICAgICAqIG9yIGNvdW50ZXIuCiAgICAgICAgICAqLwotICAgICAgICBpZiAoIHZj
LT5zY2hlZF91bml0LT5pc19ydW5uaW5nIHx8Ci0gICAgICAgICAgICAgKGJhbGFuY2Vfc3RlcCA9
PSBCQUxBTkNFX1NPRlRfQUZGSU5JVFkgJiYKLSAgICAgICAgICAgICAgIWhhc19zb2Z0X2FmZmlu
aXR5KHZjLT5zY2hlZF91bml0KSkgKQorICAgICAgICBpZiAoIHVuaXQtPmlzX3J1bm5pbmcgfHwg
KGJhbGFuY2Vfc3RlcCA9PSBCQUxBTkNFX1NPRlRfQUZGSU5JVFkgJiYKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAhaGFzX3NvZnRfYWZmaW5pdHkodW5pdCkpICkKICAgICAgICAg
ICAgIGNvbnRpbnVlOwogCi0gICAgICAgIGFmZmluaXR5X2JhbGFuY2VfY3B1bWFzayh2Yy0+c2No
ZWRfdW5pdCwgYmFsYW5jZV9zdGVwLCBjcHVtYXNrX3NjcmF0Y2gpOwotICAgICAgICBpZiAoIF9f
Y3NjaGVkX3ZjcHVfaXNfbWlncmF0ZWFibGUocHJ2LCB2YywgY3B1LCBjcHVtYXNrX3NjcmF0Y2gp
ICkKKyAgICAgICAgYWZmaW5pdHlfYmFsYW5jZV9jcHVtYXNrKHVuaXQsIGJhbGFuY2Vfc3RlcCwg
Y3B1bWFza19zY3JhdGNoKTsKKyAgICAgICAgaWYgKCBfX2NzY2hlZF91bml0X2lzX21pZ3JhdGVh
YmxlKHBydiwgdW5pdCwgY3B1LCBjcHVtYXNrX3NjcmF0Y2gpICkKICAgICAgICAgewogICAgICAg
ICAgICAgLyogV2UgZ290IGEgY2FuZGlkYXRlLiBHcmFiIGl0ISAqLwotICAgICAgICAgICAgVFJB
Q0VfM0QoVFJDX0NTQ0hFRF9TVE9MRU5fVkNQVSwgcGVlcl9jcHUsCi0gICAgICAgICAgICAgICAg
ICAgICB2Yy0+ZG9tYWluLT5kb21haW5faWQsIHZjLT52Y3B1X2lkKTsKLSAgICAgICAgICAgIFND
SEVEX1ZDUFVfU1RBVF9DUkFOSyhzcGVlciwgbWlncmF0ZV9xKTsKKyAgICAgICAgICAgIFRSQUNF
XzNEKFRSQ19DU0NIRURfU1RPTEVOX1VOSVQsIHBlZXJfY3B1LAorICAgICAgICAgICAgICAgICAg
ICAgdW5pdC0+ZG9tYWluLT5kb21haW5faWQsIHVuaXQtPnVuaXRfaWQpOworICAgICAgICAgICAg
U0NIRURfVU5JVF9TVEFUX0NSQU5LKHNwZWVyLCBtaWdyYXRlX3EpOwogICAgICAgICAgICAgU0NI
RURfU1RBVF9DUkFOSyhtaWdyYXRlX3F1ZXVlZCk7Ci0gICAgICAgICAgICBXQVJOX09OKHZjLT5p
c191cmdlbnQpOwogICAgICAgICAgICAgcnVucV9yZW1vdmUoc3BlZXIpOwotICAgICAgICAgICAg
c2NoZWRfc2V0X3Jlcyh2Yy0+c2NoZWRfdW5pdCwgZ2V0X3NjaGVkX3JlcyhjcHUpKTsKKyAgICAg
ICAgICAgIHNjaGVkX3NldF9yZXModW5pdCwgZ2V0X3NjaGVkX3JlcyhjcHUpKTsKICAgICAgICAg
ICAgIC8qCiAgICAgICAgICAgICAgKiBzcGVlciB3aWxsIHN0YXJ0IGV4ZWN1dGluZyBkaXJlY3Rs
eSBvbiBjcHUsIHdpdGhvdXQgaGF2aW5nIHRvCiAgICAgICAgICAgICAgKiBnbyB0aHJvdWdoIHJ1
bnFfaW5zZXJ0KCkuIFNvIHdlIG11c3QgdXBkYXRlIHRoZSBydW5uYWJsZSBjb3VudApAQCAtMTY4
OCw3ICsxNjg0LDcgQEAgY3NjaGVkX2xvYWRfYmFsYW5jZShzdHJ1Y3QgY3NjaGVkX3ByaXZhdGUg
KnBydiwgaW50IGNwdSwKICAgICBpbnQgcGVlcl9jcHUsIGZpcnN0X2NwdSwgcGVlcl9ub2RlLCBi
c3RlcDsKICAgICBpbnQgbm9kZSA9IGNwdV90b19ub2RlKGNwdSk7CiAKLSAgICBCVUdfT04oIGNw
dSAhPSBzbmV4dC0+dmNwdS0+cHJvY2Vzc29yICk7CisgICAgQlVHX09OKCBjcHUgIT0gc2NoZWRf
dW5pdF9jcHUoc25leHQtPnVuaXQpICk7CiAgICAgb25saW5lID0gY3B1cG9vbF9vbmxpbmVfY3B1
bWFzayhjKTsKIAogICAgIC8qCkBAIC0xNzE3LDcgKzE3MTMsNyBAQCBjc2NoZWRfbG9hZF9iYWxh
bmNlKHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2LCBpbnQgY3B1LAogICAgICAgICAvKgogICAg
ICAgICAgKiBXZSBwZWVrIGF0IHRoZSBub24taWRsaW5nIENQVXMgaW4gYSBub2RlLXdpc2UgZmFz
aGlvbi4gSW4gZmFjdCwKICAgICAgICAgICogaXQgaXMgbW9yZSBsaWtlbHkgdGhhdCB3ZSBmaW5k
IHNvbWUgYWZmaW5lIHdvcmsgb24gb3VyIHNhbWUKLSAgICAgICAgICogbm9kZSwgbm90IHRvIG1l
bnRpb24gdGhhdCBtaWdyYXRpbmcgdmNwdXMgd2l0aGluIHRoZSBzYW1lIG5vZGUKKyAgICAgICAg
ICogbm9kZSwgbm90IHRvIG1lbnRpb24gdGhhdCBtaWdyYXRpbmcgdW5pdHMgd2l0aGluIHRoZSBz
YW1lIG5vZGUKICAgICAgICAgICogY291bGQgd2VsbCBleHBlY3RlZCB0byBiZSBjaGVhcGVyIHRo
YW4gYWNyb3NzLW5vZGVzIChtZW1vcnkKICAgICAgICAgICogc3RheXMgbG9jYWwsIHRoZXJlIG1p
Z2h0IGJlIHNvbWUgbm9kZS13aWRlIGNhY2hlW3NdLCBldGMuKS4KICAgICAgICAgICovCkBAIC0x
NzM4LDcgKzE3MzQsNyBAQCBjc2NoZWRfbG9hZF9iYWxhbmNlKHN0cnVjdCBjc2NoZWRfcHJpdmF0
ZSAqcHJ2LCBpbnQgY3B1LAogICAgICAgICAgICAgICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAKICAg
ICAgICAgICAgICAgICAvKgotICAgICAgICAgICAgICAgICAqIElmIHRoZXJlIGlzIG9ubHkgb25l
IHJ1bm5hYmxlIHZDUFUgb24gcGVlcl9jcHUsIGl0IG1lYW5zCisgICAgICAgICAgICAgICAgICog
SWYgdGhlcmUgaXMgb25seSBvbmUgcnVubmFibGUgdW5pdCBvbiBwZWVyX2NwdSwgaXQgbWVhbnMK
ICAgICAgICAgICAgICAgICAgKiB0aGVyZSdzIG5vIG9uZSB0byBiZSBzdG9sZW4gaW4gaXRzIHJ1
bnF1ZXVlLCBzbyBza2lwIGl0LgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAg
ICogQ2hlY2tpbmcgdGhpcyB3aXRob3V0IGhvbGRpbmcgdGhlIGxvY2sgaXMgcmFjeS4uLiBCdXQg
dGhhdCdzCkBAIC0xNzUxLDEzICsxNzQ3LDEzIEBAIGNzY2hlZF9sb2FkX2JhbGFuY2Uoc3RydWN0
IGNzY2hlZF9wcml2YXRlICpwcnYsIGludCBjcHUsCiAgICAgICAgICAgICAgICAgICogICBBbmQg
d2UgY2FuIGF2b2lkIHRoYXQgYnkgcmUtY2hlY2tpbmcgbnJfcnVubmFibGUgYWZ0ZXIKICAgICAg
ICAgICAgICAgICAgKiAgIGhhdmluZyBncmFiYmVkIHRoZSBsb2NrLCBpZiB3ZSB3YW50OwogICAg
ICAgICAgICAgICAgICAqIC0gaWYgd2UgcmFjZSB3aXRoIGluY19ucl9ydW5uYWJsZSgpLCB3ZSBz
a2lwIGEgcENQVSB0aGF0IG1heQotICAgICAgICAgICAgICAgICAqICAgaGF2ZSBydW5uYWJsZSB2
Q1BVcyBpbiBpdHMgcnVucXVldWUsIGJ1dCB0aGF0J3Mgbm90IGEKKyAgICAgICAgICAgICAgICAg
KiAgIGhhdmUgcnVubmFibGUgdW5pdHMgaW4gaXRzIHJ1bnF1ZXVlLCBidXQgdGhhdCdzIG5vdCBh
CiAgICAgICAgICAgICAgICAgICogICBwcm9ibGVtIGJlY2F1c2U6CiAgICAgICAgICAgICAgICAg
ICogICArIGlmIHJhY2luZyB3aXRoIGNzY2hlZF91bml0X2luc2VydCgpIG9yIGNzY2hlZF91bml0
X3dha2UoKSwKLSAgICAgICAgICAgICAgICAgKiAgICAgX19ydW5xX3RpY2tsZSgpIHdpbGwgYmUg
Y2FsbGVkIGFmdGVyd29yZHMsIHNvIHRoZSB2Q1BVCisgICAgICAgICAgICAgICAgICogICAgIF9f
cnVucV90aWNrbGUoKSB3aWxsIGJlIGNhbGxlZCBhZnRlcndvcmRzLCBzbyB0aGUgdW5pdAogICAg
ICAgICAgICAgICAgICAqICAgICB3b24ndCBnZXQgc3R1Y2sgaW4gdGhlIHJ1bnF1ZXVlIGZvciB0
b28gbG9uZzsKLSAgICAgICAgICAgICAgICAgKiAgICsgaWYgcmFjaW5nIHdpdGggY3NjaGVkX3J1
bnFfc3RlYWwoKSwgaXQgbWF5IGJlIHRoYXQgYQotICAgICAgICAgICAgICAgICAqICAgICB2Q1BV
IHRoYXQgd2UgY291bGQgaGF2ZSBwaWNrZWQgdXAsIHN0YXlzIGluIGEgcnVucXVldWUKKyAgICAg
ICAgICAgICAgICAgKiAgICsgaWYgcmFjaW5nIHdpdGggY3NjaGVkX3J1bnFfc3RlYWwoKSwgaXQg
bWF5IGJlIHRoYXQgYW4KKyAgICAgICAgICAgICAgICAgKiAgICAgdW5pdCB0aGF0IHdlIGNvdWxk
IGhhdmUgcGlja2VkIHVwLCBzdGF5cyBpbiBhIHJ1bnF1ZXVlCiAgICAgICAgICAgICAgICAgICog
ICAgIHVudGlsIHNvbWVvbmUgZWxzZSB0cmllcyB0byBzdGVhbCBpdCBhZ2Fpbi4gQnV0IHRoaXMg
aXMKICAgICAgICAgICAgICAgICAgKiAgICAgbm8gd29yc2UgdGhhbiB3aGF0IGNhbiBoYXBwZW4g
YWxyZWFkeSAod2l0aG91dCB0aGlzCiAgICAgICAgICAgICAgICAgICogICAgIG9wdGltaXphdGlv
biksIGl0IHRoZSBwQ1BVIHdvdWxkIHNjaGVkdWxlIHJpZ2h0IGFmdGVyIHdlCkBAIC0xNzkyLDcg
KzE3ODgsNyBAQCBjc2NoZWRfbG9hZF9iYWxhbmNlKHN0cnVjdCBjc2NoZWRfcHJpdmF0ZSAqcHJ2
LCBpbnQgY3B1LAogICAgICAgICAgICAgICAgICAgICBjc2NoZWRfcnVucV9zdGVhbChwZWVyX2Nw
dSwgY3B1LCBzbmV4dC0+cHJpLCBic3RlcCkgOiBOVUxMOwogICAgICAgICAgICAgICAgIHBjcHVf
c2NoZWR1bGVfdW5sb2NrKGxvY2ssIHBlZXJfY3B1KTsKIAotICAgICAgICAgICAgICAgIC8qIEFz
IHNvb24gYXMgb25lIHZjcHUgaXMgZm91bmQsIGJhbGFuY2luZyBlbmRzICovCisgICAgICAgICAg
ICAgICAgLyogQXMgc29vbiBhcyBvbmUgdW5pdCBpcyBmb3VuZCwgYmFsYW5jaW5nIGVuZHMgKi8K
ICAgICAgICAgICAgICAgICBpZiAoIHNwZWVyICE9IE5VTEwgKQogICAgICAgICAgICAgICAgIHsK
ICAgICAgICAgICAgICAgICAgICAgKnN0b2xlbiA9IDE7CkBAIC0xODMxLDE0ICsxODI3LDE1IEBA
IGNzY2hlZF9zY2hlZHVsZSgKIHsKICAgICBjb25zdCBpbnQgY3B1ID0gc21wX3Byb2Nlc3Nvcl9p
ZCgpOwogICAgIHN0cnVjdCBsaXN0X2hlYWQgKiBjb25zdCBydW5xID0gUlVOUShjcHUpOwotICAg
IHN0cnVjdCBjc2NoZWRfdW5pdCAqIGNvbnN0IHNjdXJyID0gQ1NDSEVEX1VOSVQoY3VycmVudC0+
c2NoZWRfdW5pdCk7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSBjdXJyZW50LT5zY2hl
ZF91bml0OworICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqIGNvbnN0IHNjdXJyID0gQ1NDSEVEX1VO
SVQodW5pdCk7CiAgICAgc3RydWN0IGNzY2hlZF9wcml2YXRlICpwcnYgPSBDU0NIRURfUFJJVihv
cHMpOwogICAgIHN0cnVjdCBjc2NoZWRfdW5pdCAqc25leHQ7CiAgICAgc3RydWN0IHRhc2tfc2xp
Y2UgcmV0OwogICAgIHNfdGltZV90IHJ1bnRpbWUsIHRzbGljZTsKIAogICAgIFNDSEVEX1NUQVRf
Q1JBTksoc2NoZWR1bGUpOwotICAgIENTQ0hFRF9WQ1BVX0NIRUNLKGN1cnJlbnQpOworICAgIENT
Q0hFRF9VTklUX0NIRUNLKHVuaXQpOwogCiAgICAgLyoKICAgICAgKiBIZXJlIGluIENyZWRpdDEg
Y29kZSwgd2UgdXN1YWxseSBqdXN0IGNhbGwgVFJBQ0VfbkQoKSBoZWxwZXJzLCBhbmQKQEAgLTE4
NTIsMzEgKzE4NDksMzEgQEAgY3NjaGVkX3NjaGVkdWxlKAogICAgICAgICB9IGQ7CiAgICAgICAg
IGQuY3B1ID0gY3B1OwogICAgICAgICBkLnRhc2tsZXQgPSB0YXNrbGV0X3dvcmtfc2NoZWR1bGVk
OwotICAgICAgICBkLmlkbGUgPSBpc19pZGxlX3ZjcHUoY3VycmVudCk7CisgICAgICAgIGQuaWRs
ZSA9IGlzX2lkbGVfdW5pdCh1bml0KTsKICAgICAgICAgX190cmFjZV92YXIoVFJDX0NTQ0hFRF9T
Q0hFRFVMRSwgMSwgc2l6ZW9mKGQpLAogICAgICAgICAgICAgICAgICAgICAodW5zaWduZWQgY2hh
ciAqKSZkKTsKICAgICB9CiAKLSAgICBydW50aW1lID0gbm93IC0gY3VycmVudC0+c2NoZWRfdW5p
dC0+c3RhdGVfZW50cnlfdGltZTsKKyAgICBydW50aW1lID0gbm93IC0gdW5pdC0+c3RhdGVfZW50
cnlfdGltZTsKICAgICBpZiAoIHJ1bnRpbWUgPCAwICkgLyogRG9lcyB0aGlzIGV2ZXIgaGFwcGVu
PyAqLwogICAgICAgICBydW50aW1lID0gMDsKIAotICAgIGlmICggIWlzX2lkbGVfdmNwdShzY3Vy
ci0+dmNwdSkgKQorICAgIGlmICggIWlzX2lkbGVfdW5pdCh1bml0KSApCiAgICAgewotICAgICAg
ICAvKiBVcGRhdGUgY3JlZGl0cyBvZiBhIG5vbi1pZGxlIFZDUFUuICovCisgICAgICAgIC8qIFVw
ZGF0ZSBjcmVkaXRzIG9mIGEgbm9uLWlkbGUgVU5JVC4gKi8KICAgICAgICAgYnVybl9jcmVkaXRz
KHNjdXJyLCBub3cpOwogICAgICAgICBzY3Vyci0+c3RhcnRfdGltZSAtPSBub3c7CiAgICAgICAg
IHNjdXJyLT5sYXN0X3NjaGVkX3RpbWUgPSBub3c7CiAgICAgfQogICAgIGVsc2UKICAgICB7Ci0g
ICAgICAgIC8qIFJlLWluc3RhdGUgYSBib29zdGVkIGlkbGUgVkNQVSBhcyBub3JtYWwtaWRsZS4g
Ki8KKyAgICAgICAgLyogUmUtaW5zdGF0ZSBhIGJvb3N0ZWQgaWRsZSBVTklUIGFzIG5vcm1hbC1p
ZGxlLiAqLwogICAgICAgICBzY3Vyci0+cHJpID0gQ1NDSEVEX1BSSV9JRExFOwogICAgIH0KIAog
ICAgIC8qIENob2ljZXMsIGNob2ljZXM6Ci0gICAgICogLSBJZiB3ZSBoYXZlIGEgdGFza2xldCwg
d2UgbmVlZCB0byBydW4gdGhlIGlkbGUgdmNwdSBubyBtYXR0ZXIgd2hhdC4KLSAgICAgKiAtIElm
IHNjaGVkIHJhdGUgbGltaXRpbmcgaXMgaW4gZWZmZWN0LCBhbmQgdGhlIGN1cnJlbnQgdmNwdSBo
YXMKKyAgICAgKiAtIElmIHdlIGhhdmUgYSB0YXNrbGV0LCB3ZSBuZWVkIHRvIHJ1biB0aGUgaWRs
ZSB1bml0IG5vIG1hdHRlciB3aGF0LgorICAgICAqIC0gSWYgc2NoZWQgcmF0ZSBsaW1pdGluZyBp
cyBpbiBlZmZlY3QsIGFuZCB0aGUgY3VycmVudCB1bml0IGhhcwogICAgICAqICAgcnVuIGZvciBs
ZXNzIHRoYW4gdGhhdCBhbW91bnQgb2YgdGltZSwgY29udGludWUgdGhlIGN1cnJlbnQgb25lLAog
ICAgICAqICAgYnV0IHdpdGggYSBzaG9ydGVyIHRpbWVzbGljZSBhbmQgcmV0dXJuIGl0IGltbWVk
aWF0ZWx5CiAgICAgICogLSBPdGhlcndpc2UsIGNob3NlIHRoZSBvbmUgd2l0aCB0aGUgaGlnaGVz
dCBwcmlvcml0eSAod2hpY2ggbWF5CkBAIC0xODk0LDExICsxODkxLDExIEBAIGNzY2hlZF9zY2hl
ZHVsZSgKICAgICAgKiBJbiBmYWN0LCBpdCBtYXkgYmUgdGhlIGNhc2UgdGhhdCBzY3VyciBpcyBh
Ym91dCB0byBzcGluLCBhbmQgdGhlcmUncwogICAgICAqIG5vIHBvaW50IGZvcmNpbmcgaXQgdG8g
ZG8gc28gdW50aWwgcmF0ZSBsaW1pdGluZyBleHBpcmVzLgogICAgICAqLwotICAgIGlmICggIXRl
c3RfYml0KENTQ0hFRF9GTEFHX1ZDUFVfWUlFTEQsICZzY3Vyci0+ZmxhZ3MpCisgICAgaWYgKCAh
dGVzdF9iaXQoQ1NDSEVEX0ZMQUdfVU5JVF9ZSUVMRCwgJnNjdXJyLT5mbGFncykKICAgICAgICAg
ICYmICF0YXNrbGV0X3dvcmtfc2NoZWR1bGVkCiAgICAgICAgICAmJiBwcnYtPnJhdGVsaW1pdAot
ICAgICAgICAgJiYgdmNwdV9ydW5uYWJsZShjdXJyZW50KQotICAgICAgICAgJiYgIWlzX2lkbGVf
dmNwdShjdXJyZW50KQorICAgICAgICAgJiYgdW5pdF9ydW5uYWJsZSh1bml0KQorICAgICAgICAg
JiYgIWlzX2lkbGVfdW5pdCh1bml0KQogICAgICAgICAgJiYgcnVudGltZSA8IHBydi0+cmF0ZWxp
bWl0ICkKICAgICB7CiAgICAgICAgIHNuZXh0ID0gc2N1cnI7CkBAIC0xOTE2LDExICsxOTEzLDEx
IEBAIGNzY2hlZF9zY2hlZHVsZSgKICAgICAgICAgaWYgKCB1bmxpa2VseSh0Yl9pbml0X2RvbmUp
ICkKICAgICAgICAgewogICAgICAgICAgICAgc3RydWN0IHsKLSAgICAgICAgICAgICAgICB1bnNp
Z25lZCB2Y3B1OjE2LCBkb206MTY7CisgICAgICAgICAgICAgICAgdW5zaWduZWQgdW5pdDoxNiwg
ZG9tOjE2OwogICAgICAgICAgICAgICAgIHVuc2lnbmVkIHJ1bnRpbWU7CiAgICAgICAgICAgICB9
IGQ7Ci0gICAgICAgICAgICBkLmRvbSA9IHNjdXJyLT52Y3B1LT5kb21haW4tPmRvbWFpbl9pZDsK
LSAgICAgICAgICAgIGQudmNwdSA9IHNjdXJyLT52Y3B1LT52Y3B1X2lkOworICAgICAgICAgICAg
ZC5kb20gPSB1bml0LT5kb21haW4tPmRvbWFpbl9pZDsKKyAgICAgICAgICAgIGQudW5pdCA9IHVu
aXQtPnVuaXRfaWQ7CiAgICAgICAgICAgICBkLnJ1bnRpbWUgPSBydW50aW1lOwogICAgICAgICAg
ICAgX190cmFjZV92YXIoVFJDX0NTQ0hFRF9SQVRFTElNSVQsIDEsIHNpemVvZihkKSwKICAgICAg
ICAgICAgICAgICAgICAgICAgICh1bnNpZ25lZCBjaGFyICopJmQpOwpAQCAtMTkzMiwxMyArMTky
OSwxMyBAQCBjc2NoZWRfc2NoZWR1bGUoCiAgICAgdHNsaWNlID0gcHJ2LT50c2xpY2U7CiAKICAg
ICAvKgotICAgICAqIFNlbGVjdCBuZXh0IHJ1bm5hYmxlIGxvY2FsIFZDUFUgKGllIHRvcCBvZiBs
b2NhbCBydW5xKQorICAgICAqIFNlbGVjdCBuZXh0IHJ1bm5hYmxlIGxvY2FsIFVOSVQgKGllIHRv
cCBvZiBsb2NhbCBydW5xKQogICAgICAqLwotICAgIGlmICggdmNwdV9ydW5uYWJsZShjdXJyZW50
KSApCisgICAgaWYgKCB1bml0X3J1bm5hYmxlKHVuaXQpICkKICAgICAgICAgX19ydW5xX2luc2Vy
dChzY3Vycik7CiAgICAgZWxzZQogICAgIHsKLSAgICAgICAgQlVHX09OKCBpc19pZGxlX3ZjcHUo
Y3VycmVudCkgfHwgbGlzdF9lbXB0eShydW5xKSApOworICAgICAgICBCVUdfT04oIGlzX2lkbGVf
dW5pdCh1bml0KSB8fCBsaXN0X2VtcHR5KHJ1bnEpICk7CiAgICAgICAgIC8qIEN1cnJlbnQgaGFz
IGJsb2NrZWQuIFVwZGF0ZSB0aGUgcnVubmFibGUgY291bnRlciBmb3IgdGhpcyBjcHUuICovCiAg
ICAgICAgIGRlY19ucl9ydW5uYWJsZShjcHUpOwogICAgIH0KQEAgLTE5NDYsMjMgKzE5NDMsMjMg
QEAgY3NjaGVkX3NjaGVkdWxlKAogICAgIHNuZXh0ID0gX19ydW5xX2VsZW0ocnVucS0+bmV4dCk7
CiAgICAgcmV0Lm1pZ3JhdGVkID0gMDsKIAotICAgIC8qIFRhc2tsZXQgd29yayAod2hpY2ggcnVu
cyBpbiBpZGxlIFZDUFUgY29udGV4dCkgb3ZlcnJpZGVzIGFsbCBlbHNlLiAqLworICAgIC8qIFRh
c2tsZXQgd29yayAod2hpY2ggcnVucyBpbiBpZGxlIFVOSVQgY29udGV4dCkgb3ZlcnJpZGVzIGFs
bCBlbHNlLiAqLwogICAgIGlmICggdGFza2xldF93b3JrX3NjaGVkdWxlZCApCiAgICAgewogICAg
ICAgICBUUkFDRV8wRChUUkNfQ1NDSEVEX1NDSEVEX1RBU0tMRVQpOwotICAgICAgICBzbmV4dCA9
IENTQ0hFRF9VTklUKGlkbGVfdmNwdVtjcHVdLT5zY2hlZF91bml0KTsKKyAgICAgICAgc25leHQg
PSBDU0NIRURfVU5JVChzY2hlZF9pZGxlX3VuaXQoY3B1KSk7CiAgICAgICAgIHNuZXh0LT5wcmkg
PSBDU0NIRURfUFJJX1RTX0JPT1NUOwogICAgIH0KIAogICAgIC8qCiAgICAgICogQ2xlYXIgWUlF
TEQgZmxhZyBiZWZvcmUgc2NoZWR1bGluZyBvdXQKICAgICAgKi8KLSAgICBjbGVhcl9iaXQoQ1ND
SEVEX0ZMQUdfVkNQVV9ZSUVMRCwgJnNjdXJyLT5mbGFncyk7CisgICAgY2xlYXJfYml0KENTQ0hF
RF9GTEFHX1VOSVRfWUlFTEQsICZzY3Vyci0+ZmxhZ3MpOwogCiAgICAgLyoKICAgICAgKiBTTVAg
TG9hZCBiYWxhbmNlOgogICAgICAqCi0gICAgICogSWYgdGhlIG5leHQgaGlnaGVzdCBwcmlvcml0
eSBsb2NhbCBydW5uYWJsZSBWQ1BVIGhhcyBhbHJlYWR5IGVhdGVuCisgICAgICogSWYgdGhlIG5l
eHQgaGlnaGVzdCBwcmlvcml0eSBsb2NhbCBydW5uYWJsZSBVTklUIGhhcyBhbHJlYWR5IGVhdGVu
CiAgICAgICogdGhyb3VnaCBpdHMgY3JlZGl0cywgbG9vayBvbiBvdGhlciBQQ1BVcyB0byBzZWUg
aWYgd2UgaGF2ZSBtb3JlCiAgICAgICogdXJnZW50IHdvcmsuLi4gSWYgbm90LCBjc2NoZWRfbG9h
ZF9iYWxhbmNlKCkgd2lsbCByZXR1cm4gc25leHQsIGJ1dAogICAgICAqIGFscmVhZHkgcmVtb3Zl
ZCBmcm9tIHRoZSBydW5xLgpAQCAtMTk4NiwzMiArMTk4MywzMiBAQCBjc2NoZWRfc2NoZWR1bGUo
CiAgICAgICAgIGNwdW1hc2tfY2xlYXJfY3B1KGNwdSwgcHJ2LT5pZGxlcnMpOwogICAgIH0KIAot
ICAgIGlmICggIWlzX2lkbGVfdmNwdShzbmV4dC0+dmNwdSkgKQorICAgIGlmICggIWlzX2lkbGVf
dW5pdChzbmV4dC0+dW5pdCkgKQogICAgICAgICBzbmV4dC0+c3RhcnRfdGltZSArPSBub3c7CiAK
IG91dDoKICAgICAvKgogICAgICAqIFJldHVybiB0YXNrIHRvIHJ1biBuZXh0Li4uCiAgICAgICov
Ci0gICAgcmV0LnRpbWUgPSAoaXNfaWRsZV92Y3B1KHNuZXh0LT52Y3B1KSA/CisgICAgcmV0LnRp
bWUgPSAoaXNfaWRsZV91bml0KHNuZXh0LT51bml0KSA/CiAgICAgICAgICAgICAgICAgLTEgOiB0
c2xpY2UpOwotICAgIHJldC50YXNrID0gc25leHQtPnZjcHUtPnNjaGVkX3VuaXQ7CisgICAgcmV0
LnRhc2sgPSBzbmV4dC0+dW5pdDsKIAotICAgIENTQ0hFRF9WQ1BVX0NIRUNLKHJldC50YXNrLT52
Y3B1X2xpc3QpOworICAgIENTQ0hFRF9VTklUX0NIRUNLKHJldC50YXNrKTsKICAgICByZXR1cm4g
cmV0OwogfQogCiBzdGF0aWMgdm9pZAotY3NjaGVkX2R1bXBfdmNwdShzdHJ1Y3QgY3NjaGVkX3Vu
aXQgKnN2YykKK2NzY2hlZF9kdW1wX3VuaXQoc3RydWN0IGNzY2hlZF91bml0ICpzdmMpCiB7CiAg
ICAgc3RydWN0IGNzY2hlZF9kb20gKiBjb25zdCBzZG9tID0gc3ZjLT5zZG9tOwogCiAgICAgcHJp
bnRrKCJbJWkuJWldIHByaT0laSBmbGFncz0leCBjcHU9JWkiLAotICAgICAgICAgICAgc3ZjLT52
Y3B1LT5kb21haW4tPmRvbWFpbl9pZCwKLSAgICAgICAgICAgIHN2Yy0+dmNwdS0+dmNwdV9pZCwK
KyAgICAgICAgICAgIHN2Yy0+dW5pdC0+ZG9tYWluLT5kb21haW5faWQsCisgICAgICAgICAgICBz
dmMtPnVuaXQtPnVuaXRfaWQsCiAgICAgICAgICAgICBzdmMtPnByaSwKICAgICAgICAgICAgIHN2
Yy0+ZmxhZ3MsCi0gICAgICAgICAgICBzdmMtPnZjcHUtPnByb2Nlc3Nvcik7CisgICAgICAgICAg
ICBzY2hlZF91bml0X2NwdShzdmMtPnVuaXQpKTsKIAogICAgIGlmICggc2RvbSApCiAgICAgewpA
QCAtMjA0NSw3ICsyMDQyLDcgQEAgY3NjaGVkX2R1bXBfcGNwdShjb25zdCBzdHJ1Y3Qgc2NoZWR1
bGVyICpvcHMsIGludCBjcHUpCiAKICAgICAvKgogICAgICAqIFdlIG5lZWQgYm90aCBsb2NrczoK
LSAgICAgKiAtIGNzY2hlZF9kdW1wX3ZjcHUoKSB3YW50cyB0byBhY2Nlc3MgZG9tYWlucycgc2No
ZWR1bGluZworICAgICAqIC0gY3NjaGVkX2R1bXBfdW5pdCgpIHdhbnRzIHRvIGFjY2VzcyBkb21h
aW5zJyBzY2hlZHVsaW5nCiAgICAgICogICBwYXJhbWV0ZXJzLCB3aGljaCBhcmUgcHJvdGVjdGVk
IGJ5IHRoZSBwcml2YXRlIHNjaGVkdWxlciBsb2NrOwogICAgICAqIC0gd2Ugc2NhbiB0aHJvdWdo
IHRoZSBydW5xdWV1ZSwgc28gd2UgbmVlZCB0aGUgcHJvcGVyIHJ1bnF1ZXVlCiAgICAgICogICBs
b2NrICh0aGUgb25lIG9mIHRoZSBydW5xdWV1ZSBvZiB0aGlzIGNwdSkuCkBAIC0yMDYxLDEyICsy
MDU4LDEyIEBAIGNzY2hlZF9kdW1wX3BjcHUoY29uc3Qgc3RydWN0IHNjaGVkdWxlciAqb3BzLCBp
bnQgY3B1KQogICAgICAgICAgICBDUFVNQVNLX1BSKHBlcl9jcHUoY3B1X3NpYmxpbmdfbWFzaywg
Y3B1KSksCiAgICAgICAgICAgIENQVU1BU0tfUFIocGVyX2NwdShjcHVfY29yZV9tYXNrLCBjcHUp
KSk7CiAKLSAgICAvKiBjdXJyZW50IFZDUFUgKG5vdGhpbmcgdG8gc2F5IGlmIHRoYXQncyB0aGUg
aWRsZSB2Y3B1KS4gKi8KKyAgICAvKiBjdXJyZW50IFVOSVQgKG5vdGhpbmcgdG8gc2F5IGlmIHRo
YXQncyB0aGUgaWRsZSB1bml0KS4gKi8KICAgICBzdmMgPSBDU0NIRURfVU5JVChjdXJyX29uX2Nw
dShjcHUpKTsKLSAgICBpZiAoIHN2YyAmJiAhaXNfaWRsZV92Y3B1KHN2Yy0+dmNwdSkgKQorICAg
IGlmICggc3ZjICYmICFpc19pZGxlX3VuaXQoc3ZjLT51bml0KSApCiAgICAgewogICAgICAgICBw
cmludGsoIlx0cnVuOiAiKTsKLSAgICAgICAgY3NjaGVkX2R1bXBfdmNwdShzdmMpOworICAgICAg
ICBjc2NoZWRfZHVtcF91bml0KHN2Yyk7CiAgICAgfQogCiAgICAgbG9vcCA9IDA7CkBAIC0yMDc2
LDcgKzIwNzMsNyBAQCBjc2NoZWRfZHVtcF9wY3B1KGNvbnN0IHN0cnVjdCBzY2hlZHVsZXIgKm9w
cywgaW50IGNwdSkKICAgICAgICAgaWYgKCBzdmMgKQogICAgICAgICB7CiAgICAgICAgICAgICBw
cmludGsoIlx0JTNkOiAiLCArK2xvb3ApOwotICAgICAgICAgICAgY3NjaGVkX2R1bXBfdmNwdShz
dmMpOworICAgICAgICAgICAgY3NjaGVkX2R1bXBfdW5pdChzdmMpOwogICAgICAgICB9CiAgICAg
fQogCkBAIC0yMTE4LDI5ICsyMTE1LDI5IEBAIGNzY2hlZF9kdW1wKGNvbnN0IHN0cnVjdCBzY2hl
ZHVsZXIgKm9wcykKICAgICAgICAgICAgcHJ2LT5yYXRlbGltaXQgLyBNSUNST1NFQ1MoMSksCiAg
ICAgICAgICAgIENTQ0hFRF9DUkVESVRTX1BFUl9NU0VDLAogICAgICAgICAgICBwcnYtPnRpY2tz
X3Blcl90c2xpY2UsCi0gICAgICAgICAgIHBydi0+dmNwdV9taWdyX2RlbGF5LyBNSUNST1NFQ1Mo
MSkpOworICAgICAgICAgICBwcnYtPnVuaXRfbWlncl9kZWxheS8gTUlDUk9TRUNTKDEpKTsKIAog
ICAgIHByaW50aygiaWRsZXJzOiAlKnBiXG4iLCBDUFVNQVNLX1BSKHBydi0+aWRsZXJzKSk7CiAK
LSAgICBwcmludGsoImFjdGl2ZSB2Y3B1czpcbiIpOworICAgIHByaW50aygiYWN0aXZlIHVuaXRz
OlxuIik7CiAgICAgbG9vcCA9IDA7CiAgICAgbGlzdF9mb3JfZWFjaCggaXRlcl9zZG9tLCAmcHJ2
LT5hY3RpdmVfc2RvbSApCiAgICAgewogICAgICAgICBzdHJ1Y3QgY3NjaGVkX2RvbSAqc2RvbTsK
ICAgICAgICAgc2RvbSA9IGxpc3RfZW50cnkoaXRlcl9zZG9tLCBzdHJ1Y3QgY3NjaGVkX2RvbSwg
YWN0aXZlX3Nkb21fZWxlbSk7CiAKLSAgICAgICAgbGlzdF9mb3JfZWFjaCggaXRlcl9zdmMsICZz
ZG9tLT5hY3RpdmVfdmNwdSApCisgICAgICAgIGxpc3RfZm9yX2VhY2goIGl0ZXJfc3ZjLCAmc2Rv
bS0+YWN0aXZlX3VuaXQgKQogICAgICAgICB7CiAgICAgICAgICAgICBzdHJ1Y3QgY3NjaGVkX3Vu
aXQgKnN2YzsKICAgICAgICAgICAgIHNwaW5sb2NrX3QgKmxvY2s7CiAKLSAgICAgICAgICAgIHN2
YyA9IGxpc3RfZW50cnkoaXRlcl9zdmMsIHN0cnVjdCBjc2NoZWRfdW5pdCwgYWN0aXZlX3ZjcHVf
ZWxlbSk7Ci0gICAgICAgICAgICBsb2NrID0gdW5pdF9zY2hlZHVsZV9sb2NrKHN2Yy0+dmNwdS0+
c2NoZWRfdW5pdCk7CisgICAgICAgICAgICBzdmMgPSBsaXN0X2VudHJ5KGl0ZXJfc3ZjLCBzdHJ1
Y3QgY3NjaGVkX3VuaXQsIGFjdGl2ZV91bml0X2VsZW0pOworICAgICAgICAgICAgbG9jayA9IHVu
aXRfc2NoZWR1bGVfbG9jayhzdmMtPnVuaXQpOwogCiAgICAgICAgICAgICBwcmludGsoIlx0JTNk
OiAiLCArK2xvb3ApOwotICAgICAgICAgICAgY3NjaGVkX2R1bXBfdmNwdShzdmMpOworICAgICAg
ICAgICAgY3NjaGVkX2R1bXBfdW5pdChzdmMpOwogCi0gICAgICAgICAgICB1bml0X3NjaGVkdWxl
X3VubG9jayhsb2NrLCBzdmMtPnZjcHUtPnNjaGVkX3VuaXQpOworICAgICAgICAgICAgdW5pdF9z
Y2hlZHVsZV91bmxvY2sobG9jaywgc3ZjLT51bml0KTsKICAgICAgICAgfQogICAgIH0KIApAQCAt
MjIxNCw3ICsyMjExLDcgQEAgY3NjaGVkX2luaXQoc3RydWN0IHNjaGVkdWxlciAqb3BzKQogICAg
IGVsc2UKICAgICAgICAgcHJ2LT5yYXRlbGltaXQgPSBNSUNST1NFQ1Moc2NoZWRfcmF0ZWxpbWl0
X3VzKTsKIAotICAgIHBydi0+dmNwdV9taWdyX2RlbGF5ID0gTUlDUk9TRUNTKHZjcHVfbWlncmF0
aW9uX2RlbGF5X3VzKTsKKyAgICBwcnYtPnVuaXRfbWlncl9kZWxheSA9IE1JQ1JPU0VDUyh2Y3B1
X21pZ3JhdGlvbl9kZWxheV91cyk7CiAKICAgICByZXR1cm4gMDsKIH0KLS0gCjIuMTYuNAoKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBt
YWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMu
eGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

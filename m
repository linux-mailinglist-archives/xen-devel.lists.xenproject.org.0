Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 8722C14A9E3
	for <lists+xen-devel@lfdr.de>; Mon, 27 Jan 2020 19:37:08 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iw9DM-00021A-EY; Mon, 27 Jan 2020 18:34:24 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=5jYl=3Q=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1iw9DL-00020X-AU
 for xen-devel@lists.xenproject.org; Mon, 27 Jan 2020 18:34:23 +0000
X-Inumbo-ID: a09ec900-4133-11ea-8594-12813bfff9fa
Received: from mga07.intel.com (unknown [134.134.136.100])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id a09ec900-4133-11ea-8594-12813bfff9fa;
 Mon, 27 Jan 2020 18:34:18 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 27 Jan 2020 10:06:50 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.70,370,1574150400"; d="scan'208";a="231562410"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.254.183.124])
 by orsmga006.jf.intel.com with ESMTP; 27 Jan 2020 10:06:50 -0800
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Mon, 27 Jan 2020 10:06:37 -0800
Message-Id: <698834461d0fd7ba7a6edb25a568aff8777beb48.1580148227.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1580148227.git.tamas.lengyel@intel.com>
References: <cover.1580148227.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PATCH v6 9/9] xen/tools: VM forking toolstack side
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Tamas K Lengyel <tamas.lengyel@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QWRkIG5lY2Vzc2FyeSBiaXRzIHRvIGltcGxlbWVudCAieGwgZm9yay12bSIgY29tbWFuZHMuIFRo
ZSBjb21tYW5kIGFsbG93cyB0aGUKdXNlciB0byBzcGVjaWZ5IGhvdyB0byBsYXVuY2ggdGhlIGRl
dmljZSBtb2RlbCBhbGxvd2luZyBmb3IgYSBsYXRlLWxhdW5jaCBtb2RlbAppbiB3aGljaCB0aGUg
dXNlciBjYW4gZXhlY3V0ZSB0aGUgZm9yayB3aXRob3V0IHRoZSBkZXZpY2UgbW9kZWwgYW5kIGRl
Y2lkZSB0bwpvbmx5IGxhdGVyIGxhdW5jaCBpdC4KClNpZ25lZC1vZmYtYnk6IFRhbWFzIEsgTGVu
Z3llbCA8dGFtYXMubGVuZ3llbEBpbnRlbC5jb20+Ci0tLQogZG9jcy9tYW4veGwuMS5wb2QuaW4g
ICAgICAgICAgfCAgMzYgKysrKysrCiB0b29scy9saWJ4Yy9pbmNsdWRlL3hlbmN0cmwuaCB8ICAx
MyArKwogdG9vbHMvbGlieGMveGNfbWVtc2hyLmMgICAgICAgfCAgMjIgKysrKwogdG9vbHMvbGli
eGwvbGlieGwuaCAgICAgICAgICAgfCAgIDcgKwogdG9vbHMvbGlieGwvbGlieGxfY3JlYXRlLmMg
ICAgfCAyMzcgKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLQogdG9vbHMvbGlieGwv
bGlieGxfZG0uYyAgICAgICAgfCAgIDIgKy0KIHRvb2xzL2xpYnhsL2xpYnhsX2RvbS5jICAgICAg
IHwgIDQzICsrKysrLQogdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaCAgfCAgIDEgKwogdG9v
bHMvbGlieGwvbGlieGxfdHlwZXMuaWRsICAgfCAgIDEgKwogdG9vbHMveGwveGwuaCAgICAgICAg
ICAgICAgICAgfCAgIDUgKwogdG9vbHMveGwveGxfY21kdGFibGUuYyAgICAgICAgfCAgMTIgKysK
IHRvb2xzL3hsL3hsX3NhdmVyZXN0b3JlLmMgICAgIHwgIDk1ICsrKysrKysrKysrKysrCiB0b29s
cy94bC94bF92bWNvbnRyb2wuYyAgICAgICB8ICAgOCArKwogMTMgZmlsZXMgY2hhbmdlZCwgMzk4
IGluc2VydGlvbnMoKyksIDg0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RvY3MvbWFuL3hs
LjEucG9kLmluIGIvZG9jcy9tYW4veGwuMS5wb2QuaW4KaW5kZXggZDRiNWU4ZTM2Mi4uMjJjYzQx
NDliMCAxMDA2NDQKLS0tIGEvZG9jcy9tYW4veGwuMS5wb2QuaW4KKysrIGIvZG9jcy9tYW4veGwu
MS5wb2QuaW4KQEAgLTY5NCw2ICs2OTQsNDIgQEAgTGVhdmUgdGhlIGRvbWFpbiBwYXVzZWQgYWZ0
ZXIgY3JlYXRpbmcgdGhlIHNuYXBzaG90LgogCiA9YmFjawogCis9aXRlbSBCPGZvcmstdm0+IFtJ
PE9QVElPTlM+XSBJPGRvbWFpbi1pZD4KKworQ3JlYXRlIGEgZm9yayBvZiBhIHJ1bm5pbmcgVk0u
IFRoZSBkb21haW4gd2lsbCBiZSBwYXVzZWQgYWZ0ZXIgdGhlIG9wZXJhdGlvbgorYW5kIG5lZWRz
IHRvIHJlbWFpbiBwYXVzZWQgd2hpbGUgZm9ya3Mgb2YgaXQgZXhpc3QuCisKK0I8T1BUSU9OUz4K
KworPW92ZXIgNAorCis9aXRlbSBCPC1wPgorCitMZWF2ZSB0aGUgZm9yayBwYXVzZWQgYWZ0ZXIg
Y3JlYXRpbmcgaXQuCisKKz1pdGVtIEI8LS1sYXVuY2gtZG0+CisKK1NwZWNpZnkgd2hldGhlciB0
aGUgZGV2aWNlIG1vZGVsIChRRU1VKSBzaG91bGQgYmUgbGF1bmNoZWQgZm9yIHRoZSBmb3JrLiBM
YXRlCitsYXVuY2ggYWxsb3dzIHRvIHN0YXJ0IHRoZSBkZXZpY2UgbW9kZWwgZm9yIGFuIGFscmVh
ZHkgcnVubmluZyBmb3JrLgorCis9aXRlbSBCPC1DPgorCitUaGUgY29uZmlnIGZpbGUgdG8gdXNl
IHdoZW4gbGF1bmNoaW5nIHRoZSBkZXZpY2UgbW9kZWwuIEN1cnJlbnRseSByZXF1aXJlZCB3aGVu
CitsYXVuY2hpbmcgdGhlIGRldmljZSBtb2RlbC4KKworPWl0ZW0gQjwtUT4KKworVGhlIHFlbXUg
c2F2ZSBmaWxlIHRvIHVzZSB3aGVuIGxhdW5jaGluZyB0aGUgZGV2aWNlIG1vZGVsLiAgQ3VycmVu
dGx5IHJlcXVpcmVkCit3aGVuIGxhdW5jaGluZyB0aGUgZGV2aWNlIG1vZGVsLgorCis9aXRlbSBC
PC0tZm9yay1yZXNldD4KKworUGVyZm9ybSBhIHJlc2V0IG9wZXJhdGlvbiBvZiBhbiBhbHJlYWR5
IHJ1bm5pbmcgZm9yay4gTm90ZSB0aGF0IHJlc2V0dGluZyBtYXkKK2JlIGxlc3MgcGVyZm9ybWFu
dCB0aGVuIGNyZWF0aW5nIGEgbmV3IGZvcmsgZGVwZW5kaW5nIG9uIGhvdyBtdWNoIG1lbW9yeSB0
aGUKK2ZvcmsgaGFzIGRlZHVwbGljYXRlZCBkdXJpbmcgaXRzIHJ1bnRpbWUuCisKKz1iYWNrCisK
ID1pdGVtIEI8c2hhcmluZz4gW0k8ZG9tYWluLWlkPl0KIAogRGlzcGxheSB0aGUgbnVtYmVyIG9m
IHNoYXJlZCBwYWdlcyBmb3IgYSBzcGVjaWZpZWQgZG9tYWluLiBJZiBubyBkb21haW4gaXMKZGlm
ZiAtLWdpdCBhL3Rvb2xzL2xpYnhjL2luY2x1ZGUveGVuY3RybC5oIGIvdG9vbHMvbGlieGMvaW5j
bHVkZS94ZW5jdHJsLmgKaW5kZXggY2M0ZWIxZTNkMy4uNmY2NTg4OGRkMCAxMDA2NDQKLS0tIGEv
dG9vbHMvbGlieGMvaW5jbHVkZS94ZW5jdHJsLmgKKysrIGIvdG9vbHMvbGlieGMvaW5jbHVkZS94
ZW5jdHJsLmgKQEAgLTIyMjUsNiArMjIyNSwxOSBAQCBpbnQgeGNfbWVtc2hyX3JhbmdlX3NoYXJl
KHhjX2ludGVyZmFjZSAqeGNoLAogICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50NjRfdCBm
aXJzdF9nZm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ2NF90IGxhc3RfZ2ZuKTsK
IAoraW50IHhjX21lbXNocl9mb3JrKHhjX2ludGVyZmFjZSAqeGNoLAorICAgICAgICAgICAgICAg
ICAgIHVpbnQzMl90IHNvdXJjZV9kb21haW4sCisgICAgICAgICAgICAgICAgICAgdWludDMyX3Qg
Y2xpZW50X2RvbWFpbik7CisKKy8qCisgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIG9ubHkgaW50
ZW5kZWQgdG8gYmUgdXNlZCBvbiBzaG9ydC1saXZlZCBmb3JrcyB0aGF0CisgKiBoYXZlbid0IHll
dCBhcXVpcmVkIGEgbG90IG9mIG1lbW9yeS4gSW4gY2FzZSB0aGUgZm9yayBoYXMgYSBsb3Qgb2Yg
bWVtb3J5CisgKiBpdCBpcyBsaWtlbHkgbW9yZSBwZXJmb3JtYW50IHRvIGNyZWF0ZSBhIG5ldyBm
b3JrIHdpdGggeGNfbWVtc2hyX2ZvcmsuCisgKgorICogV2l0aCBWTXMgdGhhdCBoYXZlIGEgbG90
IG9mIG1lbW9yeSB0aGlzIGNhbGwgbWF5IGJsb2NrIGZvciBhIGxvbmcgdGltZS4KKyAqLworaW50
IHhjX21lbXNocl9mb3JrX3Jlc2V0KHhjX2ludGVyZmFjZSAqeGNoLCB1aW50MzJfdCBmb3JrZWRf
ZG9tYWluKTsKKwogLyogRGVidWcgY2FsbHM6IHJldHVybiB0aGUgbnVtYmVyIG9mIHBhZ2VzIHJl
ZmVyZW5jaW5nIHRoZSBzaGFyZWQgZnJhbWUgYmFja2luZwogICogdGhlIGlucHV0IGFyZ3VtZW50
LiBTaG91bGQgYmUgb25lIG9yIGdyZWF0ZXIuCiAgKgpkaWZmIC0tZ2l0IGEvdG9vbHMvbGlieGMv
eGNfbWVtc2hyLmMgYi90b29scy9saWJ4Yy94Y19tZW1zaHIuYwppbmRleCA5N2UyZTZhOGQ5Li5k
MGU0ZWUyMjViIDEwMDY0NAotLS0gYS90b29scy9saWJ4Yy94Y19tZW1zaHIuYworKysgYi90b29s
cy9saWJ4Yy94Y19tZW1zaHIuYwpAQCAtMjM5LDYgKzIzOSwyOCBAQCBpbnQgeGNfbWVtc2hyX2Rl
YnVnX2dyZWYoeGNfaW50ZXJmYWNlICp4Y2gsCiAgICAgcmV0dXJuIHhjX21lbXNocl9tZW1vcCh4
Y2gsIGRvbWlkLCAmbXNvKTsKIH0KIAoraW50IHhjX21lbXNocl9mb3JrKHhjX2ludGVyZmFjZSAq
eGNoLCB1aW50MzJfdCBwZG9taWQsIHVpbnQzMl90IGRvbWlkKQoreworICAgIHhlbl9tZW1fc2hh
cmluZ19vcF90IG1zbzsKKworICAgIG1lbXNldCgmbXNvLCAwLCBzaXplb2YobXNvKSk7CisKKyAg
ICBtc28ub3AgPSBYRU5NRU1fc2hhcmluZ19vcF9mb3JrOworICAgIG1zby51LmZvcmsucGFyZW50
X2RvbWFpbiA9IHBkb21pZDsKKworICAgIHJldHVybiB4Y19tZW1zaHJfbWVtb3AoeGNoLCBkb21p
ZCwgJm1zbyk7Cit9CisKK2ludCB4Y19tZW1zaHJfZm9ya19yZXNldCh4Y19pbnRlcmZhY2UgKnhj
aCwgdWludDMyX3QgZG9taWQpCit7CisgICAgeGVuX21lbV9zaGFyaW5nX29wX3QgbXNvOworCisg
ICAgbWVtc2V0KCZtc28sIDAsIHNpemVvZihtc28pKTsKKyAgICBtc28ub3AgPSBYRU5NRU1fc2hh
cmluZ19vcF9mb3JrX3Jlc2V0OworCisgICAgcmV0dXJuIHhjX21lbXNocl9tZW1vcCh4Y2gsIGRv
bWlkLCAmbXNvKTsKK30KKwogaW50IHhjX21lbXNocl9hdWRpdCh4Y19pbnRlcmZhY2UgKnhjaCkK
IHsKICAgICB4ZW5fbWVtX3NoYXJpbmdfb3BfdCBtc287CmRpZmYgLS1naXQgYS90b29scy9saWJ4
bC9saWJ4bC5oIGIvdG9vbHMvbGlieGwvbGlieGwuaAppbmRleCA1NGFiYjlkYjFmLi43NWNiMDcw
NTg3IDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bC5oCisrKyBiL3Rvb2xzL2xpYnhsL2xp
YnhsLmgKQEAgLTE1MzYsNiArMTUzNiwxMyBAQCBpbnQgbGlieGxfZG9tYWluX2NyZWF0ZV9uZXco
bGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpYnhsX2FzeW5jb3BfaG93ICphb19ob3csCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlieGxfYXN5bmNwcm9ncmVzc19ob3cgKmFv
cF9jb25zb2xlX2hvdykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMSUJYTF9FWFRFUk5B
TF9DQUxMRVJTX09OTFk7CitpbnQgbGlieGxfZG9tYWluX2Zvcmtfdm0obGlieGxfY3R4ICpjdHgs
IHVpbnQzMl90IHBkb21pZCwgdWludDMyX3QgKmRvbWlkKQorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBMSUJYTF9FWFRFUk5BTF9DQUxMRVJTX09OTFk7CitpbnQgbGlieGxfZG9tYWluX2Zv
cmtfbGF1bmNoX2RtKGxpYnhsX2N0eCAqY3R4LCBsaWJ4bF9kb21haW5fY29uZmlnICpkX2NvbmZp
ZywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgZG9taWQsCisgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpYnhsX2FzeW5jcHJvZ3Jlc3NfaG93
ICphb3BfY29uc29sZV9ob3cpCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExJQlhM
X0VYVEVSTkFMX0NBTExFUlNfT05MWTsKK2ludCBsaWJ4bF9kb21haW5fZm9ya19yZXNldChsaWJ4
bF9jdHggKmN0eCwgdWludDMyX3QgZG9taWQpOwogaW50IGxpYnhsX2RvbWFpbl9jcmVhdGVfcmVz
dG9yZShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcsCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90ICpkb21pZCwgaW50IHJlc3RvcmVf
ZmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBzZW5kX2JhY2tfZmQsCmRp
ZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9jcmVhdGUuYyBiL3Rvb2xzL2xpYnhsL2xpYnhs
X2NyZWF0ZS5jCmluZGV4IDMyZDQ1ZGNlZjAuLmUwZDIxOTU5NmMgMTAwNjQ0Ci0tLSBhL3Rvb2xz
L2xpYnhsL2xpYnhsX2NyZWF0ZS5jCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2NyZWF0ZS5jCkBA
IC01MzYsMTIgKzUzNiwxMiBAQCBvdXQ6CiAgICAgcmV0dXJuIHJldDsKIH0KIAotaW50IGxpYnhs
X19kb21haW5fbWFrZShsaWJ4bF9fZ2MgKmdjLCBsaWJ4bF9kb21haW5fY29uZmlnICpkX2NvbmZp
ZywKLSAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfX2RvbWFpbl9idWlsZF9zdGF0ZSAqc3Rh
dGUsCi0gICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90ICpkb21pZCkKK3N0YXRpYyBpbnQg
bGlieGxfX2RvbWFpbl9tYWtlX3hzX2VudHJpZXMobGlieGxfX2djICpnYywgbGlieGxfZG9tYWlu
X2NvbmZpZyAqZF9jb25maWcsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGxpYnhsX19kb21haW5fYnVpbGRfc3RhdGUgKnN0YXRlLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICB1aW50MzJfdCBkb21pZCkKIHsKICAgICBsaWJ4bF9jdHgg
KmN0eCA9IGxpYnhsX19nY19vd25lcihnYyk7Ci0gICAgaW50IHJldCwgcmMsIG5iX3ZtOworICAg
IGludCByYywgbmJfdm07CiAgICAgY29uc3QgY2hhciAqZG9tX3R5cGU7CiAgICAgY2hhciAqdXVp
ZF9zdHJpbmc7CiAgICAgY2hhciAqZG9tX3BhdGgsICp2bV9wYXRoLCAqbGlieGxfcGF0aDsKQEAg
LTU1Myw3ICs1NTMsNiBAQCBpbnQgbGlieGxfX2RvbWFpbl9tYWtlKGxpYnhsX19nYyAqZ2MsIGxp
YnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogCiAgICAgLyogY29udmVuaWVuY2UgYWxpYXNl
cyAqLwogICAgIGxpYnhsX2RvbWFpbl9jcmVhdGVfaW5mbyAqaW5mbyA9ICZkX2NvbmZpZy0+Y19p
bmZvOwotICAgIGxpYnhsX2RvbWFpbl9idWlsZF9pbmZvICpiX2luZm8gPSAmZF9jb25maWctPmJf
aW5mbzsKIAogICAgIHV1aWRfc3RyaW5nID0gbGlieGxfX3V1aWQyc3RyaW5nKGdjLCBpbmZvLT51
dWlkKTsKICAgICBpZiAoIXV1aWRfc3RyaW5nKSB7CkBAIC01NjEsNjQgKzU2MCw3IEBAIGludCBs
aWJ4bF9fZG9tYWluX21ha2UobGlieGxfX2djICpnYywgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9j
b25maWcsCiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0KIAotICAgIC8qIFZhbGlkIGRvbWlkIGhl
cmUgbWVhbnMgd2UncmUgc29mdCByZXNldHRpbmcuICovCi0gICAgaWYgKCFsaWJ4bF9kb21pZF92
YWxpZF9ndWVzdCgqZG9taWQpKSB7Ci0gICAgICAgIHN0cnVjdCB4ZW5fZG9tY3RsX2NyZWF0ZWRv
bWFpbiBjcmVhdGUgPSB7Ci0gICAgICAgICAgICAuc3NpZHJlZiA9IGluZm8tPnNzaWRyZWYsCi0g
ICAgICAgICAgICAubWF4X3ZjcHVzID0gYl9pbmZvLT5tYXhfdmNwdXMsCi0gICAgICAgICAgICAu
bWF4X2V2dGNobl9wb3J0ID0gYl9pbmZvLT5ldmVudF9jaGFubmVscywKLSAgICAgICAgICAgIC5t
YXhfZ3JhbnRfZnJhbWVzID0gYl9pbmZvLT5tYXhfZ3JhbnRfZnJhbWVzLAotICAgICAgICAgICAg
Lm1heF9tYXB0cmFja19mcmFtZXMgPSBiX2luZm8tPm1heF9tYXB0cmFja19mcmFtZXMsCi0gICAg
ICAgIH07Ci0KLSAgICAgICAgaWYgKGluZm8tPnR5cGUgIT0gTElCWExfRE9NQUlOX1RZUEVfUFYp
IHsKLSAgICAgICAgICAgIGNyZWF0ZS5mbGFncyB8PSBYRU5fRE9NQ1RMX0NERl9odm07Ci0gICAg
ICAgICAgICBjcmVhdGUuZmxhZ3MgfD0KLSAgICAgICAgICAgICAgICBsaWJ4bF9kZWZib29sX3Zh
bChpbmZvLT5oYXApID8gWEVOX0RPTUNUTF9DREZfaGFwIDogMDsKLSAgICAgICAgICAgIGNyZWF0
ZS5mbGFncyB8PQotICAgICAgICAgICAgICAgIGxpYnhsX2RlZmJvb2xfdmFsKGluZm8tPm9vcykg
PyAwIDogWEVOX0RPTUNUTF9DREZfb29zX29mZjsKLSAgICAgICAgfQotCi0gICAgICAgIGFzc2Vy
dChpbmZvLT5wYXNzdGhyb3VnaCAhPSBMSUJYTF9QQVNTVEhST1VHSF9ERUZBVUxUKTsKLSAgICAg
ICAgTE9HKERFVEFJTCwgInBhc3N0aHJvdWdoOiAlcyIsCi0gICAgICAgICAgICBsaWJ4bF9wYXNz
dGhyb3VnaF90b19zdHJpbmcoaW5mby0+cGFzc3Rocm91Z2gpKTsKLQotICAgICAgICBpZiAoaW5m
by0+cGFzc3Rocm91Z2ggIT0gTElCWExfUEFTU1RIUk9VR0hfRElTQUJMRUQpCi0gICAgICAgICAg
ICBjcmVhdGUuZmxhZ3MgfD0gWEVOX0RPTUNUTF9DREZfaW9tbXU7Ci0KLSAgICAgICAgaWYgKGlu
Zm8tPnBhc3N0aHJvdWdoID09IExJQlhMX1BBU1NUSFJPVUdIX1NZTkNfUFQpCi0gICAgICAgICAg
ICBjcmVhdGUuaW9tbXVfb3B0cyB8PSBYRU5fRE9NQ1RMX0lPTU1VX25vX3NoYXJlcHQ7Ci0KLSAg
ICAgICAgLyogVWx0aW1hdGVseSwgaGFuZGxlIGlzIGFuIGFycmF5IG9mIDE2IHVpbnQ4X3QsIHNh
bWUgYXMgdXVpZCAqLwotICAgICAgICBsaWJ4bF91dWlkX2NvcHkoY3R4LCAobGlieGxfdXVpZCAq
KSZjcmVhdGUuaGFuZGxlLCAmaW5mby0+dXVpZCk7Ci0KLSAgICAgICAgcmV0ID0gbGlieGxfX2Fy
Y2hfZG9tYWluX3ByZXBhcmVfY29uZmlnKGdjLCBkX2NvbmZpZywgJmNyZWF0ZSk7Ci0gICAgICAg
IGlmIChyZXQgPCAwKSB7Ci0gICAgICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlkLCAiZmFpbCB0
byBnZXQgZG9tYWluIGNvbmZpZyIpOwotICAgICAgICAgICAgcmMgPSBFUlJPUl9GQUlMOwotICAg
ICAgICAgICAgZ290byBvdXQ7Ci0gICAgICAgIH0KLQotICAgICAgICByZXQgPSB4Y19kb21haW5f
Y3JlYXRlKGN0eC0+eGNoLCBkb21pZCwgJmNyZWF0ZSk7Ci0gICAgICAgIGlmIChyZXQgPCAwKSB7
Ci0gICAgICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlkLCAiZG9tYWluIGNyZWF0aW9uIGZhaWwi
KTsKLSAgICAgICAgICAgIHJjID0gRVJST1JfRkFJTDsKLSAgICAgICAgICAgIGdvdG8gb3V0Owot
ICAgICAgICB9Ci0KLSAgICAgICAgcmMgPSBsaWJ4bF9fYXJjaF9kb21haW5fc2F2ZV9jb25maWco
Z2MsIGRfY29uZmlnLCBzdGF0ZSwgJmNyZWF0ZSk7Ci0gICAgICAgIGlmIChyYyA8IDApCi0gICAg
ICAgICAgICBnb3RvIG91dDsKLSAgICB9Ci0KLSAgICByZXQgPSB4Y19jcHVwb29sX21vdmVkb21h
aW4oY3R4LT54Y2gsIGluZm8tPnBvb2xpZCwgKmRvbWlkKTsKLSAgICBpZiAocmV0IDwgMCkgewot
ICAgICAgICBMT0dFRChFUlJPUiwgKmRvbWlkLCAiZG9tYWluIG1vdmUgZmFpbCIpOwotICAgICAg
ICByYyA9IEVSUk9SX0ZBSUw7Ci0gICAgICAgIGdvdG8gb3V0OwotICAgIH0KLQotICAgIGRvbV9w
YXRoID0gbGlieGxfX3hzX2dldF9kb21wYXRoKGdjLCAqZG9taWQpOworICAgIGRvbV9wYXRoID0g
bGlieGxfX3hzX2dldF9kb21wYXRoKGdjLCBkb21pZCk7CiAgICAgaWYgKCFkb21fcGF0aCkgewog
ICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CiAgICAgICAgIGdvdG8gb3V0OwpAQCAtNjI2LDEyICs1
NjgsMTIgQEAgaW50IGxpYnhsX19kb21haW5fbWFrZShsaWJ4bF9fZ2MgKmdjLCBsaWJ4bF9kb21h
aW5fY29uZmlnICpkX2NvbmZpZywKIAogICAgIHZtX3BhdGggPSBHQ1NQUklOVEYoIi92bS8lcyIs
IHV1aWRfc3RyaW5nKTsKICAgICBpZiAoIXZtX3BhdGgpIHsKLSAgICAgICAgTE9HRChFUlJPUiwg
KmRvbWlkLCAiY2Fubm90IGFsbG9jYXRlIGNyZWF0ZSBwYXRocyIpOworICAgICAgICBMT0dEKEVS
Uk9SLCBkb21pZCwgImNhbm5vdCBhbGxvY2F0ZSBjcmVhdGUgcGF0aHMiKTsKICAgICAgICAgcmMg
PSBFUlJPUl9GQUlMOwogICAgICAgICBnb3RvIG91dDsKICAgICB9CiAKLSAgICBsaWJ4bF9wYXRo
ID0gbGlieGxfX3hzX2xpYnhsX3BhdGgoZ2MsICpkb21pZCk7CisgICAgbGlieGxfcGF0aCA9IGxp
YnhsX194c19saWJ4bF9wYXRoKGdjLCBkb21pZCk7CiAgICAgaWYgKCFsaWJ4bF9wYXRoKSB7CiAg
ICAgICAgIHJjID0gRVJST1JfRkFJTDsKICAgICAgICAgZ290byBvdXQ7CkBAIC02NDIsMTAgKzU4
NCwxMCBAQCBpbnQgbGlieGxfX2RvbWFpbl9tYWtlKGxpYnhsX19nYyAqZ2MsIGxpYnhsX2RvbWFp
bl9jb25maWcgKmRfY29uZmlnLAogCiAgICAgcm9wZXJtWzBdLmlkID0gMDsKICAgICByb3Blcm1b
MF0ucGVybXMgPSBYU19QRVJNX05PTkU7Ci0gICAgcm9wZXJtWzFdLmlkID0gKmRvbWlkOworICAg
IHJvcGVybVsxXS5pZCA9IGRvbWlkOwogICAgIHJvcGVybVsxXS5wZXJtcyA9IFhTX1BFUk1fUkVB
RDsKIAotICAgIHJ3cGVybVswXS5pZCA9ICpkb21pZDsKKyAgICByd3Blcm1bMF0uaWQgPSBkb21p
ZDsKICAgICByd3Blcm1bMF0ucGVybXMgPSBYU19QRVJNX05PTkU7CiAKIHJldHJ5X3RyYW5zYWN0
aW9uOgpAQCAtNjYzLDcgKzYwNSw3IEBAIHJldHJ5X3RyYW5zYWN0aW9uOgogICAgICAgICAgICAg
ICAgICAgICBub3Blcm0sIEFSUkFZX1NJWkUobm9wZXJtKSk7CiAKICAgICB4c193cml0ZShjdHgt
PnhzaCwgdCwgR0NTUFJJTlRGKCIlcy92bSIsIGRvbV9wYXRoKSwgdm1fcGF0aCwgc3RybGVuKHZt
X3BhdGgpKTsKLSAgICByYyA9IGxpYnhsX19kb21haW5fcmVuYW1lKGdjLCAqZG9taWQsIDAsIGlu
Zm8tPm5hbWUsIHQpOworICAgIHJjID0gbGlieGxfX2RvbWFpbl9yZW5hbWUoZ2MsIGRvbWlkLCAw
LCBpbmZvLT5uYW1lLCB0KTsKICAgICBpZiAocmMpCiAgICAgICAgIGdvdG8gb3V0OwogCkBAIC03
NDAsNyArNjgyLDcgQEAgcmV0cnlfdHJhbnNhY3Rpb246CiAKICAgICB2bV9saXN0ID0gbGlieGxf
bGlzdF92bShjdHgsICZuYl92bSk7CiAgICAgaWYgKCF2bV9saXN0KSB7Ci0gICAgICAgIExPR0Qo
RVJST1IsICpkb21pZCwgImNhbm5vdCBnZXQgbnVtYmVyIG9mIHJ1bm5pbmcgZ3Vlc3RzIik7Cisg
ICAgICAgIExPR0QoRVJST1IsIGRvbWlkLCAiY2Fubm90IGdldCBudW1iZXIgb2YgcnVubmluZyBn
dWVzdHMiKTsKICAgICAgICAgcmMgPSBFUlJPUl9GQUlMOwogICAgICAgICBnb3RvIG91dDsKICAg
ICB9CkBAIC03NjQsNyArNzA2LDcgQEAgcmV0cnlfdHJhbnNhY3Rpb246CiAgICAgICAgICAgICB0
ID0gMDsKICAgICAgICAgICAgIGdvdG8gcmV0cnlfdHJhbnNhY3Rpb247CiAgICAgICAgIH0KLSAg
ICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImRvbWFpbiBjcmVhdGlvbiAiInhlbnN0b3JlIHRy
YW5zYWN0aW9uIGNvbW1pdCBmYWlsZWQiKTsKKyAgICAgICAgTE9HRUQoRVJST1IsIGRvbWlkLCAi
ZG9tYWluIGNyZWF0aW9uICIieGVuc3RvcmUgdHJhbnNhY3Rpb24gY29tbWl0IGZhaWxlZCIpOwog
ICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CiAgICAgICAgIGdvdG8gb3V0OwogICAgIH0KQEAgLTc3
Niw2ICs3MTgsODAgQEAgcmV0cnlfdHJhbnNhY3Rpb246CiAgICAgcmV0dXJuIHJjOwogfQogCitp
bnQgbGlieGxfX2RvbWFpbl9tYWtlKGxpYnhsX19nYyAqZ2MsIGxpYnhsX2RvbWFpbl9jb25maWcg
KmRfY29uZmlnLAorICAgICAgICAgICAgICAgICAgICAgICBsaWJ4bF9fZG9tYWluX2J1aWxkX3N0
YXRlICpzdGF0ZSwKKyAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3QgKmRvbWlkKQorewor
ICAgIGxpYnhsX2N0eCAqY3R4ID0gbGlieGxfX2djX293bmVyKGdjKTsKKyAgICBpbnQgcmV0LCBy
YzsKKworICAgIC8qIGNvbnZlbmllbmNlIGFsaWFzZXMgKi8KKyAgICBsaWJ4bF9kb21haW5fY3Jl
YXRlX2luZm8gKmluZm8gPSAmZF9jb25maWctPmNfaW5mbzsKKyAgICBsaWJ4bF9kb21haW5fYnVp
bGRfaW5mbyAqYl9pbmZvID0gJmRfY29uZmlnLT5iX2luZm87CisKKyAgICAvKiBWYWxpZCBkb21p
ZCBoZXJlIG1lYW5zIHdlJ3JlIHNvZnQgcmVzZXR0aW5nLiAqLworICAgIGlmICghbGlieGxfZG9t
aWRfdmFsaWRfZ3Vlc3QoKmRvbWlkKSkgeworICAgICAgICBzdHJ1Y3QgeGVuX2RvbWN0bF9jcmVh
dGVkb21haW4gY3JlYXRlID0geworICAgICAgICAgICAgLnNzaWRyZWYgPSBpbmZvLT5zc2lkcmVm
LAorICAgICAgICAgICAgLm1heF92Y3B1cyA9IGJfaW5mby0+bWF4X3ZjcHVzLAorICAgICAgICAg
ICAgLm1heF9ldnRjaG5fcG9ydCA9IGJfaW5mby0+ZXZlbnRfY2hhbm5lbHMsCisgICAgICAgICAg
ICAubWF4X2dyYW50X2ZyYW1lcyA9IGJfaW5mby0+bWF4X2dyYW50X2ZyYW1lcywKKyAgICAgICAg
ICAgIC5tYXhfbWFwdHJhY2tfZnJhbWVzID0gYl9pbmZvLT5tYXhfbWFwdHJhY2tfZnJhbWVzLAor
ICAgICAgICB9OworCisgICAgICAgIGlmIChpbmZvLT50eXBlICE9IExJQlhMX0RPTUFJTl9UWVBF
X1BWKSB7CisgICAgICAgICAgICBjcmVhdGUuZmxhZ3MgfD0gWEVOX0RPTUNUTF9DREZfaHZtOwor
ICAgICAgICAgICAgY3JlYXRlLmZsYWdzIHw9CisgICAgICAgICAgICAgICAgbGlieGxfZGVmYm9v
bF92YWwoaW5mby0+aGFwKSA/IFhFTl9ET01DVExfQ0RGX2hhcCA6IDA7CisgICAgICAgICAgICBj
cmVhdGUuZmxhZ3MgfD0KKyAgICAgICAgICAgICAgICBsaWJ4bF9kZWZib29sX3ZhbChpbmZvLT5v
b3MpID8gMCA6IFhFTl9ET01DVExfQ0RGX29vc19vZmY7CisgICAgICAgIH0KKworICAgICAgICBh
c3NlcnQoaW5mby0+cGFzc3Rocm91Z2ggIT0gTElCWExfUEFTU1RIUk9VR0hfREVGQVVMVCk7Cisg
ICAgICAgIExPRyhERVRBSUwsICJwYXNzdGhyb3VnaDogJXMiLAorICAgICAgICAgICAgbGlieGxf
cGFzc3Rocm91Z2hfdG9fc3RyaW5nKGluZm8tPnBhc3N0aHJvdWdoKSk7CisKKyAgICAgICAgaWYg
KGluZm8tPnBhc3N0aHJvdWdoICE9IExJQlhMX1BBU1NUSFJPVUdIX0RJU0FCTEVEKQorICAgICAg
ICAgICAgY3JlYXRlLmZsYWdzIHw9IFhFTl9ET01DVExfQ0RGX2lvbW11OworCisgICAgICAgIGlm
IChpbmZvLT5wYXNzdGhyb3VnaCA9PSBMSUJYTF9QQVNTVEhST1VHSF9TWU5DX1BUKQorICAgICAg
ICAgICAgY3JlYXRlLmlvbW11X29wdHMgfD0gWEVOX0RPTUNUTF9JT01NVV9ub19zaGFyZXB0Owor
CisgICAgICAgIC8qIFVsdGltYXRlbHksIGhhbmRsZSBpcyBhbiBhcnJheSBvZiAxNiB1aW50OF90
LCBzYW1lIGFzIHV1aWQgKi8KKyAgICAgICAgbGlieGxfdXVpZF9jb3B5KGN0eCwgKGxpYnhsX3V1
aWQgKikmY3JlYXRlLmhhbmRsZSwgJmluZm8tPnV1aWQpOworCisgICAgICAgIHJldCA9IGxpYnhs
X19hcmNoX2RvbWFpbl9wcmVwYXJlX2NvbmZpZyhnYywgZF9jb25maWcsICZjcmVhdGUpOworICAg
ICAgICBpZiAocmV0IDwgMCkgeworICAgICAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImZh
aWwgdG8gZ2V0IGRvbWFpbiBjb25maWciKTsKKyAgICAgICAgICAgIHJjID0gRVJST1JfRkFJTDsK
KyAgICAgICAgICAgIGdvdG8gb3V0OworICAgICAgICB9CisKKyAgICAgICAgcmV0ID0geGNfZG9t
YWluX2NyZWF0ZShjdHgtPnhjaCwgZG9taWQsICZjcmVhdGUpOworICAgICAgICBpZiAocmV0IDwg
MCkgeworICAgICAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImRvbWFpbiBjcmVhdGlvbiBm
YWlsIik7CisgICAgICAgICAgICByYyA9IEVSUk9SX0ZBSUw7CisgICAgICAgICAgICBnb3RvIG91
dDsKKyAgICAgICAgfQorCisgICAgICAgIHJjID0gbGlieGxfX2FyY2hfZG9tYWluX3NhdmVfY29u
ZmlnKGdjLCBkX2NvbmZpZywgc3RhdGUsICZjcmVhdGUpOworICAgICAgICBpZiAocmMgPCAwKQor
ICAgICAgICAgICAgZ290byBvdXQ7CisgICAgfQorCisgICAgcmV0ID0geGNfY3B1cG9vbF9tb3Zl
ZG9tYWluKGN0eC0+eGNoLCBpbmZvLT5wb29saWQsICpkb21pZCk7CisgICAgaWYgKHJldCA8IDAp
IHsKKyAgICAgICAgTE9HRUQoRVJST1IsICpkb21pZCwgImRvbWFpbiBtb3ZlIGZhaWwiKTsKKyAg
ICAgICAgcmMgPSBFUlJPUl9GQUlMOworICAgICAgICBnb3RvIG91dDsKKyAgICB9CisKKyAgICBy
YyA9IGxpYnhsX19kb21haW5fbWFrZV94c19lbnRyaWVzKGdjLCBkX2NvbmZpZywgc3RhdGUsICpk
b21pZCk7CisKK291dDoKKyAgICByZXR1cm4gcmM7Cit9CisKIHN0YXRpYyBpbnQgc3RvcmVfbGli
eGxfZW50cnkobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGxpYnhsX2RvbWFpbl9idWlsZF9pbmZvICpiX2luZm8pCiB7CkBAIC0xMDk3
LDE1ICsxMTEzLDMxIEBAIHN0YXRpYyB2b2lkIGluaXRpYXRlX2RvbWFpbl9jcmVhdGUobGlieGxf
X2VnYyAqZWdjLAogICAgIHJldCA9IGxpYnhsX19kb21haW5fY29uZmlnX3NldGRlZmF1bHQoZ2Ms
ZF9jb25maWcsZG9taWQpOwogICAgIGlmIChyZXQpIGdvdG8gZXJyb3Jfb3V0OwogCi0gICAgcmV0
ID0gbGlieGxfX2RvbWFpbl9tYWtlKGdjLCBkX2NvbmZpZywgJmRjcy0+YnVpbGRfc3RhdGUsICZk
b21pZCk7Ci0gICAgaWYgKHJldCkgewotICAgICAgICBMT0dEKEVSUk9SLCBkb21pZCwgImNhbm5v
dCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOworICAgIGlmICggIWRfY29uZmlnLT5kbV9yZXN0b3Jl
X2ZpbGUgKQorICAgIHsKKyAgICAgICAgcmV0ID0gbGlieGxfX2RvbWFpbl9tYWtlKGdjLCBkX2Nv
bmZpZywgJmRjcy0+YnVpbGRfc3RhdGUsICZkb21pZCk7CiAgICAgICAgIGRjcy0+Z3Vlc3RfZG9t
aWQgPSBkb21pZDsKKworICAgICAgICBpZiAocmV0KSB7CisgICAgICAgICAgICBMT0dEKEVSUk9S
LCBkb21pZCwgImNhbm5vdCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOworICAgICAgICAgICAgcmV0
ID0gRVJST1JfRkFJTDsKKyAgICAgICAgICAgIGdvdG8gZXJyb3Jfb3V0OworICAgICAgICB9Cisg
ICAgfSBlbHNlIGlmICggZGNzLT5ndWVzdF9kb21pZCAhPSBJTlZBTElEX0RPTUlEICkgeworICAg
ICAgICBkb21pZCA9IGRjcy0+Z3Vlc3RfZG9taWQ7CisKKyAgICAgICAgcmV0ID0gbGlieGxfX2Rv
bWFpbl9tYWtlX3hzX2VudHJpZXMoZ2MsIGRfY29uZmlnLCAmZGNzLT5idWlsZF9zdGF0ZSwgZG9t
aWQpOworICAgICAgICBpZiAocmV0KSB7CisgICAgICAgICAgICBMT0dEKEVSUk9SLCBkb21pZCwg
ImNhbm5vdCBtYWtlIGRvbWFpbjogJWQiLCByZXQpOworICAgICAgICAgICAgcmV0ID0gRVJST1Jf
RkFJTDsKKyAgICAgICAgICAgIGdvdG8gZXJyb3Jfb3V0OworICAgICAgICB9CisgICAgfSBlbHNl
IHsKKyAgICAgICAgTE9HRChFUlJPUiwgZG9taWQsICJjYW5ub3QgbWFrZSBkb21haW4iKTsKICAg
ICAgICAgcmV0ID0gRVJST1JfRkFJTDsKICAgICAgICAgZ290byBlcnJvcl9vdXQ7CiAgICAgfQog
Ci0gICAgZGNzLT5ndWVzdF9kb21pZCA9IGRvbWlkOwogICAgIGRjcy0+c2Rzcy5kbS5ndWVzdF9k
b21pZCA9IDA7IC8qIG1lYW5zIHdlIGhhdmVuJ3Qgc3Bhd25lZCAqLwogCiAgICAgLyogcG9zdC00
LjEzIHRvZG86IG1vdmUgdGhlc2UgbmV4dCBiaXRzIG9mIGRlZmF1bHRpbmcgdG8KQEAgLTExNDEs
NyArMTE3Myw3IEBAIHN0YXRpYyB2b2lkIGluaXRpYXRlX2RvbWFpbl9jcmVhdGUobGlieGxfX2Vn
YyAqZWdjLAogICAgIGlmIChyZXQpCiAgICAgICAgIGdvdG8gZXJyb3Jfb3V0OwogCi0gICAgaWYg
KHJlc3RvcmVfZmQgPj0gMCB8fCBkY3MtPmRvbWlkX3NvZnRfcmVzZXQgIT0gSU5WQUxJRF9ET01J
RCkgeworICAgIGlmIChyZXN0b3JlX2ZkID49IDAgfHwgZGNzLT5kb21pZF9zb2Z0X3Jlc2V0ICE9
IElOVkFMSURfRE9NSUQgfHwgZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSkgewogICAgICAgICBM
T0dEKERFQlVHLCBkb21pZCwgInJlc3RvcmluZywgbm90IHJ1bm5pbmcgYm9vdGxvYWRlciIpOwog
ICAgICAgICBkb21jcmVhdGVfYm9vdGxvYWRlcl9kb25lKGVnYywgJmRjcy0+YmwsIDApOwogICAg
IH0gZWxzZSAgewpAQCAtMTIxNyw3ICsxMjQ5LDE2IEBAIHN0YXRpYyB2b2lkIGRvbWNyZWF0ZV9i
b290bG9hZGVyX2RvbmUobGlieGxfX2VnYyAqZWdjLAogICAgIGRjcy0+c2Rzcy5kbS5jYWxsYmFj
ayA9IGRvbWNyZWF0ZV9kZXZtb2RlbF9zdGFydGVkOwogICAgIGRjcy0+c2Rzcy5jYWxsYmFjayA9
IGRvbWNyZWF0ZV9kZXZtb2RlbF9zdGFydGVkOwogCi0gICAgaWYgKHJlc3RvcmVfZmQgPCAwICYm
IGRjcy0+ZG9taWRfc29mdF9yZXNldCA9PSBJTlZBTElEX0RPTUlEKSB7CisgICAgaWYgKHJlc3Rv
cmVfZmQgPCAwICYmIGRjcy0+ZG9taWRfc29mdF9yZXNldCA9PSBJTlZBTElEX0RPTUlEICYmICFk
X2NvbmZpZy0+ZG1fcmVzdG9yZV9maWxlKSB7CisgICAgICAgIHJjID0gbGlieGxfX2RvbWFpbl9i
dWlsZChnYywgZF9jb25maWcsIGRvbWlkLCBzdGF0ZSk7CisgICAgICAgIGRvbWNyZWF0ZV9yZWJ1
aWxkX2RvbmUoZWdjLCBkY3MsIHJjKTsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAgIGlm
ICggZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSApIHsKKyAgICAgICAgZGNzLT5zcnMuZGNzID0g
ZGNzOworICAgICAgICBkY3MtPnNycy5hbyA9IGFvOworICAgICAgICBzdGF0ZS0+Zm9ya2VkX3Zt
ID0gdHJ1ZTsKICAgICAgICAgcmMgPSBsaWJ4bF9fZG9tYWluX2J1aWxkKGdjLCBkX2NvbmZpZywg
ZG9taWQsIHN0YXRlKTsKICAgICAgICAgZG9tY3JlYXRlX3JlYnVpbGRfZG9uZShlZ2MsIGRjcywg
cmMpOwogICAgICAgICByZXR1cm47CkBAIC0xNDE1LDYgKzE0NTYsNyBAQCBzdGF0aWMgdm9pZCBk
b21jcmVhdGVfcmVidWlsZF9kb25lKGxpYnhsX19lZ2MgKmVnYywKICAgICAvKiBjb252ZW5pZW5j
ZSBhbGlhc2VzICovCiAgICAgY29uc3QgdWludDMyX3QgZG9taWQgPSBkY3MtPmd1ZXN0X2RvbWlk
OwogICAgIGxpYnhsX2RvbWFpbl9jb25maWcgKmNvbnN0IGRfY29uZmlnID0gZGNzLT5ndWVzdF9j
b25maWc7CisgICAgbGlieGxfX2RvbWFpbl9idWlsZF9zdGF0ZSAqY29uc3Qgc3RhdGUgPSAmZGNz
LT5idWlsZF9zdGF0ZTsKIAogICAgIGlmIChyZXQpIHsKICAgICAgICAgTE9HRChFUlJPUiwgZG9t
aWQsICJjYW5ub3QgKHJlLSlidWlsZCBkb21haW46ICVkIiwgcmV0KTsKQEAgLTE0MjIsNiArMTQ2
NCw5IEBAIHN0YXRpYyB2b2lkIGRvbWNyZWF0ZV9yZWJ1aWxkX2RvbmUobGlieGxfX2VnYyAqZWdj
LAogICAgICAgICBnb3RvIGVycm9yX291dDsKICAgICB9CiAKKyAgICBpZiAoIGRfY29uZmlnLT5k
bV9yZXN0b3JlX2ZpbGUgKQorICAgICAgICBzdGF0ZS0+c2F2ZWRfc3RhdGUgPSBHQ1NQUklOVEYo
IiVzIiwgZF9jb25maWctPmRtX3Jlc3RvcmVfZmlsZSk7CisKICAgICBzdG9yZV9saWJ4bF9lbnRy
eShnYywgZG9taWQsICZkX2NvbmZpZy0+Yl9pbmZvKTsKIAogICAgIGxpYnhsX19tdWx0aWRldl9i
ZWdpbihhbywgJmRjcy0+bXVsdGlkZXYpOwpAQCAtMTgyMywxMCArMTg2OCwxMyBAQCBzdGF0aWMg
aW50IGRvX2RvbWFpbl9jcmVhdGUobGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25maWcg
KmRfY29uZmlnLAogICAgIEdDTkVXKGNkY3MpOwogICAgIGNkY3MtPmRjcy5hbyA9IGFvOwogICAg
IGNkY3MtPmRjcy5ndWVzdF9jb25maWcgPSBkX2NvbmZpZzsKKyAgICBjZGNzLT5kY3MuZ3Vlc3Rf
ZG9taWQgPSAqZG9taWQ7CisKICAgICBsaWJ4bF9kb21haW5fY29uZmlnX2luaXQoJmNkY3MtPmRj
cy5ndWVzdF9jb25maWdfc2F2ZWQpOwogICAgIGxpYnhsX2RvbWFpbl9jb25maWdfY29weShjdHgs
ICZjZGNzLT5kY3MuZ3Vlc3RfY29uZmlnX3NhdmVkLCBkX2NvbmZpZyk7CiAgICAgY2Rjcy0+ZGNz
LnJlc3RvcmVfZmQgPSBjZGNzLT5kY3MubGlieGNfZmQgPSByZXN0b3JlX2ZkOwogICAgIGNkY3Mt
PmRjcy5zZW5kX2JhY2tfZmQgPSBzZW5kX2JhY2tfZmQ7CisKICAgICBpZiAocmVzdG9yZV9mZCA+
IC0xKSB7CiAgICAgICAgIGNkY3MtPmRjcy5yZXN0b3JlX3BhcmFtcyA9ICpwYXJhbXM7CiAgICAg
ICAgIHJjID0gbGlieGxfX2ZkX2ZsYWdzX21vZGlmeV9zYXZlKGdjLCBjZGNzLT5kY3MucmVzdG9y
ZV9mZCwKQEAgLTIwNjksNiArMjExNyw0MyBAQCBpbnQgbGlieGxfZG9tYWluX2NyZWF0ZV9uZXco
bGlieGxfY3R4ICpjdHgsIGxpYnhsX2RvbWFpbl9jb25maWcgKmRfY29uZmlnLAogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIGFvX2hvdywgYW9wX2NvbnNvbGVfaG93KTsKIH0KIAoraW50IGxp
YnhsX2RvbWFpbl9mb3JrX3ZtKGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBwZG9taWQsIHVpbnQz
Ml90ICpkb21pZCkKK3sKKyAgICBpbnQgcmM7CisgICAgc3RydWN0IHhlbl9kb21jdGxfY3JlYXRl
ZG9tYWluIGNyZWF0ZSA9IHswfTsKKyAgICBjcmVhdGUuZmxhZ3MgfD0gWEVOX0RPTUNUTF9DREZf
aHZtOworICAgIGNyZWF0ZS5mbGFncyB8PSBYRU5fRE9NQ1RMX0NERl9oYXA7CisgICAgY3JlYXRl
LmZsYWdzIHw9IFhFTl9ET01DVExfQ0RGX29vc19vZmY7CisgICAgY3JlYXRlLmFyY2guZW11bGF0
aW9uX2ZsYWdzID0gKFhFTl9YODZfRU1VX0FMTCAmIH5YRU5fWDg2X0VNVV9WUENJKTsKKworICAg
IGNyZWF0ZS5zc2lkcmVmID0gU0VDSU5JVFNJRF9ET01VOworICAgIGNyZWF0ZS5tYXhfdmNwdXMg
PSAxOyAvLyBwbGFjZWhvbGRlciwgd2lsbCBiZSBjbG9uZWQgZnJvbSBwZG9taWQKKyAgICBjcmVh
dGUubWF4X2V2dGNobl9wb3J0ID0gMTAyMzsKKyAgICBjcmVhdGUubWF4X2dyYW50X2ZyYW1lcyA9
IExJQlhMX01BWF9HUkFOVF9GUkFNRVNfREVGQVVMVDsKKyAgICBjcmVhdGUubWF4X21hcHRyYWNr
X2ZyYW1lcyA9IExJQlhMX01BWF9NQVBUUkFDS19GUkFNRVNfREVGQVVMVDsKKworICAgIGlmICgg
KHJjID0geGNfZG9tYWluX2NyZWF0ZShjdHgtPnhjaCwgZG9taWQsICZjcmVhdGUpKSApCisgICAg
ICAgIHJldHVybiByYzsKKworICAgIGlmICggKHJjID0geGNfbWVtc2hyX2ZvcmsoY3R4LT54Y2gs
IHBkb21pZCwgKmRvbWlkKSkgKQorICAgICAgICB4Y19kb21haW5fZGVzdHJveShjdHgtPnhjaCwg
KmRvbWlkKTsKKworICAgIHJldHVybiByYzsKK30KKworaW50IGxpYnhsX2RvbWFpbl9mb3JrX2xh
dW5jaF9kbShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25maWcsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90IGRvbWlkLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWJ4bF9hc3luY3Byb2dyZXNzX2hvdyAqYW9w
X2NvbnNvbGVfaG93KQoreworICAgIHVuc2V0X2Rpc2tfY29sb19yZXN0b3JlKGRfY29uZmlnKTsK
KyAgICByZXR1cm4gZG9fZG9tYWluX2NyZWF0ZShjdHgsIGRfY29uZmlnLCAmZG9taWQsIC0xLCAt
MSwgMCwgMCwgYW9wX2NvbnNvbGVfaG93KTsKK30KKworaW50IGxpYnhsX2RvbWFpbl9mb3JrX3Jl
c2V0KGxpYnhsX2N0eCAqY3R4LCB1aW50MzJfdCBkb21pZCkKK3sKKyAgICByZXR1cm4geGNfbWVt
c2hyX2ZvcmtfcmVzZXQoY3R4LT54Y2gsIGRvbWlkKTsKK30KKwogaW50IGxpYnhsX2RvbWFpbl9j
cmVhdGVfcmVzdG9yZShsaWJ4bF9jdHggKmN0eCwgbGlieGxfZG9tYWluX2NvbmZpZyAqZF9jb25m
aWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQzMl90ICpkb21pZCwgaW50
IHJlc3RvcmVfZmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBzZW5kX2Jh
Y2tfZmQsCmRpZmYgLS1naXQgYS90b29scy9saWJ4bC9saWJ4bF9kbS5jIGIvdG9vbHMvbGlieGwv
bGlieGxfZG0uYwppbmRleCBlOTJlNDEyYzFiLi45ZDk2N2UxZDMyIDEwMDY0NAotLS0gYS90b29s
cy9saWJ4bC9saWJ4bF9kbS5jCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX2RtLmMKQEAgLTI3ODcs
NyArMjc4Nyw3IEBAIHN0YXRpYyB2b2lkIGRldmljZV9tb2RlbF9zcGF3bl9vdXRjb21lKGxpYnhs
X19lZ2MgKmVnYywKIAogICAgIGxpYnhsX19kb21haW5fYnVpbGRfc3RhdGUgKnN0YXRlID0gZG1z
cy0+YnVpbGRfc3RhdGU7CiAKLSAgICBpZiAoc3RhdGUtPnNhdmVkX3N0YXRlKSB7CisgICAgaWYg
KHN0YXRlLT5zYXZlZF9zdGF0ZSAmJiAhc3RhdGUtPmZvcmtlZF92bSkgewogICAgICAgICByZXQy
ID0gdW5saW5rKHN0YXRlLT5zYXZlZF9zdGF0ZSk7CiAgICAgICAgIGlmIChyZXQyKSB7CiAgICAg
ICAgICAgICBMT0dFRChFUlJPUiwgZG1zcy0+Z3Vlc3RfZG9taWQsICIlczogZmFpbGVkIHRvIHJl
bW92ZSBkZXZpY2UtbW9kZWwgc3RhdGUgJXMiLApkaWZmIC0tZ2l0IGEvdG9vbHMvbGlieGwvbGli
eGxfZG9tLmMgYi90b29scy9saWJ4bC9saWJ4bF9kb20uYwppbmRleCA1NzNjNjM2OTJiLi5jODY3
Yzg2ZDMyIDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9kb20uYworKysgYi90b29scy9s
aWJ4bC9saWJ4bF9kb20uYwpAQCAtMjQ5LDkgKzI0OSwxMiBAQCBpbnQgbGlieGxfX2J1aWxkX3By
ZShsaWJ4bF9fZ2MgKmdjLCB1aW50MzJfdCBkb21pZCwKICAgICBsaWJ4bF9kb21haW5fYnVpbGRf
aW5mbyAqY29uc3QgaW5mbyA9ICZkX2NvbmZpZy0+Yl9pbmZvOwogICAgIGxpYnhsX2N0eCAqY3R4
ID0gbGlieGxfX2djX293bmVyKGdjKTsKICAgICBjaGFyICp4c19kb21pZCwgKmNvbl9kb21pZDsK
LSAgICBpbnQgcmM7CisgICAgaW50IHJjID0gMDsKICAgICB1aW50NjRfdCBzaXplOwogCisgICAg
aWYgKCBzdGF0ZS0+Zm9ya2VkX3ZtICkKKyAgICAgICAgZ290byBza2lwX2Zvcms7CisKICAgICBp
ZiAoeGNfZG9tYWluX21heF92Y3B1cyhjdHgtPnhjaCwgZG9taWQsIGluZm8tPm1heF92Y3B1cykg
IT0gMCkgewogICAgICAgICBMT0coRVJST1IsICJDb3VsZG4ndCBzZXQgbWF4IHZjcHUgY291bnQi
KTsKICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUw7CkBAIC0zNjIsNyArMzY1LDYgQEAgaW50IGxp
YnhsX19idWlsZF9wcmUobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgICAgIH0K
ICAgICB9CiAKLQogICAgIHJjID0gbGlieGxfX2FyY2hfZXh0cmFfbWVtb3J5KGdjLCBpbmZvLCAm
c2l6ZSk7CiAgICAgaWYgKHJjIDwgMCkgewogICAgICAgICBMT0dFKEVSUk9SLCAiQ291bGRuJ3Qg
Z2V0IGFyY2ggZXh0cmEgY29uc3RhbnQgbWVtb3J5IHNpemUiKTsKQEAgLTM3NCw2ICszNzYsMTEg
QEAgaW50IGxpYnhsX19idWlsZF9wcmUobGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAg
ICAgICAgIHJldHVybiBFUlJPUl9GQUlMOwogICAgIH0KIAorICAgIHJjID0gbGlieGxfX2FyY2hf
ZG9tYWluX2NyZWF0ZShnYywgZF9jb25maWcsIGRvbWlkKTsKKyAgICBpZiAoIHJjICkKKyAgICAg
ICAgZ290byBvdXQ7CisKK3NraXBfZm9yazoKICAgICB4c19kb21pZCA9IHhzX3JlYWQoY3R4LT54
c2gsIFhCVF9OVUxMLCAiL3Rvb2wveGVuc3RvcmVkL2RvbWlkIiwgTlVMTCk7CiAgICAgc3RhdGUt
PnN0b3JlX2RvbWlkID0geHNfZG9taWQgPyBhdG9pKHhzX2RvbWlkKSA6IDA7CiAgICAgZnJlZSh4
c19kb21pZCk7CkBAIC0zODUsOCArMzkyLDcgQEAgaW50IGxpYnhsX19idWlsZF9wcmUobGlieGxf
X2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgc3RhdGUtPnN0b3JlX3BvcnQgPSB4Y19ldnRj
aG5fYWxsb2NfdW5ib3VuZChjdHgtPnhjaCwgZG9taWQsIHN0YXRlLT5zdG9yZV9kb21pZCk7CiAg
ICAgc3RhdGUtPmNvbnNvbGVfcG9ydCA9IHhjX2V2dGNobl9hbGxvY191bmJvdW5kKGN0eC0+eGNo
LCBkb21pZCwgc3RhdGUtPmNvbnNvbGVfZG9taWQpOwogCi0gICAgcmMgPSBsaWJ4bF9fYXJjaF9k
b21haW5fY3JlYXRlKGdjLCBkX2NvbmZpZywgZG9taWQpOwotCitvdXQ6CiAgICAgcmV0dXJuIHJj
OwogfQogCkBAIC00NDQsNiArNDUwLDkgQEAgaW50IGxpYnhsX19idWlsZF9wb3N0KGxpYnhsX19n
YyAqZ2MsIHVpbnQzMl90IGRvbWlkLAogICAgIGNoYXIgKiplbnRzOwogICAgIGludCBpLCByYzsK
IAorICAgIGlmICggc3RhdGUtPmZvcmtlZF92bSApCisgICAgICAgIGdvdG8gc2tpcF9mb3JrOwor
CiAgICAgaWYgKGluZm8tPm51bV92bnVtYV9ub2RlcyAmJiAhaW5mby0+bnVtX3ZjcHVfc29mdF9h
ZmZpbml0eSkgewogICAgICAgICByYyA9IHNldF92bnVtYV9hZmZpbml0eShnYywgZG9taWQsIGlu
Zm8pOwogICAgICAgICBpZiAocmMpCkBAIC00NjgsNiArNDc3LDcgQEAgaW50IGxpYnhsX19idWls
ZF9wb3N0KGxpYnhsX19nYyAqZ2MsIHVpbnQzMl90IGRvbWlkLAogICAgICAgICB9CiAgICAgfQog
Citza2lwX2Zvcms6CiAgICAgZW50cyA9IGxpYnhsX19jYWxsb2MoZ2MsIDEyICsgKGluZm8tPm1h
eF92Y3B1cyAqIDIpICsgMiwgc2l6ZW9mKGNoYXIgKikpOwogICAgIGVudHNbMF0gPSAibWVtb3J5
L3N0YXRpYy1tYXgiOwogICAgIGVudHNbMV0gPSBHQ1NQUklOVEYoIiUiUFJJZDY0LCBpbmZvLT5t
YXhfbWVta2IpOwpAQCAtNzMwLDE0ICs3NDAsMTYgQEAgc3RhdGljIGludCBodm1fYnVpbGRfc2V0
X3BhcmFtcyh4Y19pbnRlcmZhY2UgKmhhbmRsZSwgdWludDMyX3QgZG9taWQsCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGxpYnhsX2RvbWFpbl9idWlsZF9pbmZvICppbmZvLAogICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgc3RvcmVfZXZ0Y2huLCB1bnNpZ25lZCBs
b25nICpzdG9yZV9tZm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBjb25z
b2xlX2V2dGNobiwgdW5zaWduZWQgbG9uZyAqY29uc29sZV9tZm4sCi0gICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGRvbWlkX3Qgc3RvcmVfZG9taWQsIGRvbWlkX3QgY29uc29sZV9kb21p
ZCkKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9taWRfdCBzdG9yZV9kb21pZCwg
ZG9taWRfdCBjb25zb2xlX2RvbWlkLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBi
b29sIGZvcmtlZF92bSkKIHsKICAgICBzdHJ1Y3QgaHZtX2luZm9fdGFibGUgKnZhX2h2bTsKICAg
ICB1aW50OF90ICp2YV9tYXAsIHN1bTsKICAgICB1aW50NjRfdCBzdHJfbWZuLCBjb25zX21mbjsK
ICAgICBpbnQgaTsKIAotICAgIGlmIChpbmZvLT50eXBlID09IExJQlhMX0RPTUFJTl9UWVBFX0hW
TSkgeworICAgIGlmICggaW5mby0+dHlwZSA9PSBMSUJYTF9ET01BSU5fVFlQRV9IVk0gJiYgIWZv
cmtlZF92bSApCisgICAgewogICAgICAgICB2YV9tYXAgPSB4Y19tYXBfZm9yZWlnbl9yYW5nZSho
YW5kbGUsIGRvbWlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBYQ19Q
QUdFX1NJWkUsIFBST1RfUkVBRCB8IFBST1RfV1JJVEUsCiAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIEhWTV9JTkZPX1BGTik7CkBAIC0xMDUzLDYgKzEwNjUsMjMgQEAgaW50
IGxpYnhsX19idWlsZF9odm0obGlieGxfX2djICpnYywgdWludDMyX3QgZG9taWQsCiAgICAgc3Ry
dWN0IHhjX2RvbV9pbWFnZSAqZG9tID0gTlVMTDsKICAgICBib29sIGRldmljZV9tb2RlbCA9IGlu
Zm8tPnR5cGUgPT0gTElCWExfRE9NQUlOX1RZUEVfSFZNID8gdHJ1ZSA6IGZhbHNlOwogCisgICAg
aWYgKCBzdGF0ZS0+Zm9ya2VkX3ZtICkKKyAgICB7CisgICAgICAgIHJjID0gaHZtX2J1aWxkX3Nl
dF9wYXJhbXMoY3R4LT54Y2gsIGRvbWlkLCBpbmZvLCBzdGF0ZS0+c3RvcmVfcG9ydCwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmc3RhdGUtPnN0b3JlX21mbiwgc3RhdGUtPmNv
bnNvbGVfcG9ydCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmc3RhdGUtPmNv
bnNvbGVfbWZuLCBzdGF0ZS0+c3RvcmVfZG9taWQsCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgc3RhdGUtPmNvbnNvbGVfZG9taWQsIHN0YXRlLT5mb3JrZWRfdm0pOworCisgICAg
ICAgIGlmICggcmMgKQorICAgICAgICAgICAgcmV0dXJuIHJjOworCisgICAgICAgIHJldHVybiB4
Y19kb21fZ250dGFiX3NlZWQoY3R4LT54Y2gsIGRvbWlkLCB0cnVlLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIHN0YXRlLT5jb25zb2xlX21mbiwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBzdGF0ZS0+c3RvcmVfbWZuLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIHN0YXRlLT5jb25zb2xlX2RvbWlkLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIHN0YXRlLT5zdG9yZV9kb21pZCk7CisgICAgfQorCiAgICAgeGNfZG9tX2xv
Z2luaXQoY3R4LT54Y2gpOwogCiAgICAgLyoKQEAgLTExNzcsNyArMTIwNiw3IEBAIGludCBsaWJ4
bF9fYnVpbGRfaHZtKGxpYnhsX19nYyAqZ2MsIHVpbnQzMl90IGRvbWlkLAogICAgIHJjID0gaHZt
X2J1aWxkX3NldF9wYXJhbXMoY3R4LT54Y2gsIGRvbWlkLCBpbmZvLCBzdGF0ZS0+c3RvcmVfcG9y
dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmc3RhdGUtPnN0b3JlX21mbiwgc3Rh
dGUtPmNvbnNvbGVfcG9ydCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmc3RhdGUt
PmNvbnNvbGVfbWZuLCBzdGF0ZS0+c3RvcmVfZG9taWQsCi0gICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgc3RhdGUtPmNvbnNvbGVfZG9taWQpOworICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHN0YXRlLT5jb25zb2xlX2RvbWlkLCBmYWxzZSk7CiAgICAgaWYgKHJjICE9IDApIHsK
ICAgICAgICAgTE9HKEVSUk9SLCAiaHZtIGJ1aWxkIHNldCBwYXJhbXMgZmFpbGVkIik7CiAgICAg
ICAgIGdvdG8gb3V0OwpkaWZmIC0tZ2l0IGEvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaCBi
L3Rvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmgKaW5kZXggMjU1NWFhNDU3NS4uN2MxZmQ3MmVm
YiAxMDA2NDQKLS0tIGEvdG9vbHMvbGlieGwvbGlieGxfaW50ZXJuYWwuaAorKysgYi90b29scy9s
aWJ4bC9saWJ4bF9pbnRlcm5hbC5oCkBAIC0xMzc1LDYgKzEzNzUsNyBAQCB0eXBlZGVmIHN0cnVj
dCB7CiAKICAgICBjaGFyICpzYXZlZF9zdGF0ZTsKICAgICBpbnQgZG1fbW9uaXRvcl9mZDsKKyAg
ICBib29sIGZvcmtlZF92bTsKIAogICAgIGxpYnhsX19maWxlX3JlZmVyZW5jZSBwdl9rZXJuZWw7
CiAgICAgbGlieGxfX2ZpbGVfcmVmZXJlbmNlIHB2X3JhbWRpc2s7CmRpZmYgLS1naXQgYS90b29s
cy9saWJ4bC9saWJ4bF90eXBlcy5pZGwgYi90b29scy9saWJ4bC9saWJ4bF90eXBlcy5pZGwKaW5k
ZXggNzkyMTk1MGY2YS4uN2M0YzQwNTdhOSAxMDA2NDQKLS0tIGEvdG9vbHMvbGlieGwvbGlieGxf
dHlwZXMuaWRsCisrKyBiL3Rvb2xzL2xpYnhsL2xpYnhsX3R5cGVzLmlkbApAQCAtOTU2LDYgKzk1
Niw3IEBAIGxpYnhsX2RvbWFpbl9jb25maWcgPSBTdHJ1Y3QoImRvbWFpbl9jb25maWciLCBbCiAg
ICAgKCJvbl93YXRjaGRvZyIsIGxpYnhsX2FjdGlvbl9vbl9zaHV0ZG93biksCiAgICAgKCJvbl9j
cmFzaCIsIGxpYnhsX2FjdGlvbl9vbl9zaHV0ZG93biksCiAgICAgKCJvbl9zb2Z0X3Jlc2V0Iiwg
bGlieGxfYWN0aW9uX29uX3NodXRkb3duKSwKKyAgICAoImRtX3Jlc3RvcmVfZmlsZSIsIHN0cmlu
Zywgeydjb25zdCc6IFRydWV9KSwKICAgICBdLCBkaXI9RElSX0lOKQogCiBsaWJ4bF9kaXNraW5m
byA9IFN0cnVjdCgiZGlza2luZm8iLCBbCmRpZmYgLS1naXQgYS90b29scy94bC94bC5oIGIvdG9v
bHMveGwveGwuaAppbmRleCA2MGJkYWQ4ZmZiLi45YmRhZDY1MjZlIDEwMDY0NAotLS0gYS90b29s
cy94bC94bC5oCisrKyBiL3Rvb2xzL3hsL3hsLmgKQEAgLTMxLDYgKzMxLDcgQEAgc3RydWN0IGNt
ZF9zcGVjIHsKIH07CiAKIHN0cnVjdCBkb21haW5fY3JlYXRlIHsKKyAgICB1aW50MzJfdCBkZG9t
aWQ7IC8qIGZvcmsgbGF1bmNoIGRtIGZvciB0aGlzIGRvbWlkICovCiAgICAgaW50IGRlYnVnOwog
ICAgIGludCBkYWVtb25pemU7CiAgICAgaW50IG1vbml0b3I7IC8qIGhhbmRsZSBndWVzdCByZWJv
b3RzIGV0YyAqLwpAQCAtNDUsNiArNDYsNyBAQCBzdHJ1Y3QgZG9tYWluX2NyZWF0ZSB7CiAgICAg
Y29uc3QgY2hhciAqY29uZmlnX2ZpbGU7CiAgICAgY2hhciAqZXh0cmFfY29uZmlnOyAvKiBleHRy
YSBjb25maWcgc3RyaW5nICovCiAgICAgY29uc3QgY2hhciAqcmVzdG9yZV9maWxlOworICAgIGNv
bnN0IGNoYXIgKmRtX3Jlc3RvcmVfZmlsZTsKICAgICBjaGFyICpjb2xvX3Byb3h5X3NjcmlwdDsK
ICAgICBib29sIHVzZXJzcGFjZV9jb2xvX3Byb3h5OwogICAgIGludCBtaWdyYXRlX2ZkOyAvKiAt
MSBtZWFucyBub25lICovCkBAIC0xMjcsNiArMTI5LDkgQEAgaW50IG1haW5fcGNpYXNzaWduYWJs
ZV9yZW1vdmUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KTsKIGludCBtYWluX3BjaWFzc2lnbmFibGVf
bGlzdChpbnQgYXJnYywgY2hhciAqKmFyZ3YpOwogI2lmbmRlZiBMSUJYTF9IQVZFX05PX1NVU1BF
TkRfUkVTVU1FCiBpbnQgbWFpbl9yZXN0b3JlKGludCBhcmdjLCBjaGFyICoqYXJndik7CitpbnQg
bWFpbl9mb3JrX3ZtKGludCBhcmdjLCBjaGFyICoqYXJndik7CitpbnQgbWFpbl9mb3JrX2xhdW5j
aF9kbShpbnQgYXJnYywgY2hhciAqKmFyZ3YpOworaW50IG1haW5fZm9ya19yZXNldChpbnQgYXJn
YywgY2hhciAqKmFyZ3YpOwogaW50IG1haW5fbWlncmF0ZV9yZWNlaXZlKGludCBhcmdjLCBjaGFy
ICoqYXJndik7CiBpbnQgbWFpbl9zYXZlKGludCBhcmdjLCBjaGFyICoqYXJndik7CiBpbnQgbWFp
bl9taWdyYXRlKGludCBhcmdjLCBjaGFyICoqYXJndik7CmRpZmYgLS1naXQgYS90b29scy94bC94
bF9jbWR0YWJsZS5jIGIvdG9vbHMveGwveGxfY21kdGFibGUuYwppbmRleCAzYjMwMmIyZjIwLi4z
YTVkMzcxMDU3IDEwMDY0NAotLS0gYS90b29scy94bC94bF9jbWR0YWJsZS5jCisrKyBiL3Rvb2xz
L3hsL3hsX2NtZHRhYmxlLmMKQEAgLTE4NSw2ICsxODUsMTggQEAgc3RydWN0IGNtZF9zcGVjIGNt
ZF90YWJsZVtdID0gewogICAgICAgIlJlc3RvcmUgYSBkb21haW4gZnJvbSBhIHNhdmVkIHN0YXRl
IiwKICAgICAgICItIGZvciBpbnRlcm5hbCB1c2Ugb25seSIsCiAgICAgfSwKKyAgICB7ICJmb3Jr
LXZtIiwKKyAgICAgICZtYWluX2Zvcmtfdm0sIDAsIDEsCisgICAgICAiRm9yayBhIGRvbWFpbiBm
cm9tIHRoZSBydW5uaW5nIHBhcmVudCBkb21pZCIsCisgICAgICAiW29wdGlvbnNdIDxEb21pZD4i
LAorICAgICAgIi1oICAgICAgICAgICAgICAgICAgICAgICAgICAgUHJpbnQgdGhpcyBoZWxwLlxu
IgorICAgICAgIi1DIDxjb25maWc+ICAgICAgICAgICAgICAgICAgVXNlIGNvbmZpZyBmaWxlIGZv
ciBWTSBmb3JrLlxuIgorICAgICAgIi1RIDxxZW11LXNhdmUtZmlsZT4gICAgICAgICAgVXNlIHFl
bXUgc2F2ZSBmaWxlIGZvciBWTSBmb3JrLlxuIgorICAgICAgIi0tbGF1bmNoLWRtIDx5ZXN8bm98
bGF0ZT4gICAgTGF1bmNoIGRldmljZSBtb2RlbCAoUUVNVSkgZm9yIFZNIGZvcmsuXG4iCisgICAg
ICAiLS1mb3JrLXJlc2V0ICAgICAgICAgICAgICAgICBSZXNldCBWTSBmb3JrLlxuIgorICAgICAg
Ii1wICAgICAgICAgICAgICAgICAgICAgICAgICAgRG8gbm90IHVucGF1c2UgZm9yayBWTSBhZnRl
ciBvcGVyYXRpb24uXG4iCisgICAgICAiLWQgICAgICAgICAgICAgICAgICAgICAgICAgICBFbmFi
bGUgZGVidWcgbWVzc2FnZXMuXG4iCisgICAgfSwKICNlbmRpZgogICAgIHsgImR1bXAtY29yZSIs
CiAgICAgICAmbWFpbl9kdW1wX2NvcmUsIDAsIDEsCmRpZmYgLS1naXQgYS90b29scy94bC94bF9z
YXZlcmVzdG9yZS5jIGIvdG9vbHMveGwveGxfc2F2ZXJlc3RvcmUuYwppbmRleCA5YmUwMzNmZTY1
Li4yNWMyMGQyZjFiIDEwMDY0NAotLS0gYS90b29scy94bC94bF9zYXZlcmVzdG9yZS5jCisrKyBi
L3Rvb2xzL3hsL3hsX3NhdmVyZXN0b3JlLmMKQEAgLTIyOSw2ICsyMjksMTAxIEBAIGludCBtYWlu
X3Jlc3RvcmUoaW50IGFyZ2MsIGNoYXIgKiphcmd2KQogICAgIHJldHVybiBFWElUX1NVQ0NFU1M7
CiB9CiAKK2ludCBtYWluX2Zvcmtfdm0oaW50IGFyZ2MsIGNoYXIgKiphcmd2KQoreworICAgIGlu
dCByYywgZGVidWcgPSAwOworICAgIHVpbnQzMl90IGRvbWlkX2luID0gSU5WQUxJRF9ET01JRCwg
ZG9taWRfb3V0ID0gSU5WQUxJRF9ET01JRDsKKyAgICBpbnQgbGF1bmNoX2RtID0gMTsKKyAgICBi
b29sIHJlc2V0ID0gMDsKKyAgICBib29sIHBhdXNlID0gMDsKKyAgICBjb25zdCBjaGFyICpjb25m
aWdfZmlsZSA9IE5VTEw7CisgICAgY29uc3QgY2hhciAqZG1fcmVzdG9yZV9maWxlID0gTlVMTDsK
KworICAgIGludCBvcHQ7CisgICAgc3RhdGljIHN0cnVjdCBvcHRpb24gb3B0c1tdID0geworICAg
ICAgICB7ImxhdW5jaC1kbSIsIDEsIDAsICdsJ30sCisgICAgICAgIHsiZm9yay1yZXNldCIsIDAs
IDAsICdyJ30sCisgICAgICAgIENPTU1PTl9MT05HX09QVFMKKyAgICB9OworCisgICAgU1dJVENI
X0ZPUkVBQ0hfT1BUKG9wdCwgInBoZEM6UTpsOnJOOkQ6QjpWOiIsIG9wdHMsICJmb3JrLXZtIiwg
MSkgeworICAgIGNhc2UgJ2QnOgorICAgICAgICBkZWJ1ZyA9IDE7CisgICAgICAgIGJyZWFrOwor
ICAgIGNhc2UgJ3AnOgorICAgICAgICBwYXVzZSA9IDE7CisgICAgICAgIGJyZWFrOworICAgIGNh
c2UgJ0MnOgorICAgICAgICBjb25maWdfZmlsZSA9IG9wdGFyZzsKKyAgICAgICAgYnJlYWs7Cisg
ICAgY2FzZSAnUSc6CisgICAgICAgIGRtX3Jlc3RvcmVfZmlsZSA9IG9wdGFyZzsKKyAgICAgICAg
YnJlYWs7CisgICAgY2FzZSAnbCc6CisgICAgICAgIGlmICggIXN0cmNtcChvcHRhcmcsICJubyIp
ICkKKyAgICAgICAgICAgIGxhdW5jaF9kbSA9IDA7CisgICAgICAgIGlmICggIXN0cmNtcChvcHRh
cmcsICJ5ZXMiKSApCisgICAgICAgICAgICBsYXVuY2hfZG0gPSAxOworICAgICAgICBpZiAoICFz
dHJjbXAob3B0YXJnLCAibGF0ZSIpICkKKyAgICAgICAgICAgIGxhdW5jaF9kbSA9IDI7CisgICAg
ICAgIGJyZWFrOworICAgIGNhc2UgJ3InOgorICAgICAgICByZXNldCA9IDE7CisgICAgICAgIGJy
ZWFrOworICAgIGNhc2UgJ04nOiAvKiBmYWxsLXRocm91Z2ggKi8KKyAgICBjYXNlICdEJzogLyog
ZmFsbC10aHJvdWdoICovCisgICAgY2FzZSAnQic6IC8qIGZhbGwtdGhyb3VnaCAqLworICAgIGNh
c2UgJ1YnOgorICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIlVuaW1wbGVtZW50ZWQgb3B0aW9uKHMp
XG4iKTsKKyAgICAgICAgcmV0dXJuIEVYSVRfRkFJTFVSRTsKKyAgICB9CisKKyAgICBpZiAoYXJn
Yy1vcHRpbmQgPT0gMSkgeworICAgICAgICBkb21pZF9pbiA9IGF0b2koYXJndltvcHRpbmRdKTsK
KyAgICB9IGVsc2UgeworICAgICAgICBoZWxwKCJmb3JrLXZtIik7CisgICAgICAgIHJldHVybiBF
WElUX0ZBSUxVUkU7CisgICAgfQorCisgICAgaWYgKGxhdW5jaF9kbSAmJiAoIWNvbmZpZ19maWxl
IHx8ICFkbV9yZXN0b3JlX2ZpbGUpKSB7CisgICAgICAgIGZwcmludGYoc3RkZXJyLCAiQ3VycmVu
dGx5IHlvdSBtdXN0IHByb3ZpZGUgYm90aCAtQyBhbmQgLVEgb3B0aW9uc1xuIik7CisgICAgICAg
IHJldHVybiBFWElUX0ZBSUxVUkU7CisgICAgfQorCisgICAgaWYgKHJlc2V0KSB7CisgICAgICAg
IGRvbWlkX291dCA9IGRvbWlkX2luOworICAgICAgICBpZiAobGlieGxfZG9tYWluX2ZvcmtfcmVz
ZXQoY3R4LCBkb21pZF9pbikgPT0gRVhJVF9GQUlMVVJFKQorICAgICAgICAgICAgcmV0dXJuIEVY
SVRfRkFJTFVSRTsKKyAgICB9CisKKyAgICBpZiAobGF1bmNoX2RtID09IDIgfHwgcmVzZXQpIHsK
KyAgICAgICAgZG9taWRfb3V0ID0gZG9taWRfaW47CisgICAgICAgIHJjID0gRVhJVF9TVUNDRVNT
OworICAgIH0gZWxzZQorICAgICAgICByYyA9IGxpYnhsX2RvbWFpbl9mb3JrX3ZtKGN0eCwgZG9t
aWRfaW4sICZkb21pZF9vdXQpOworCisgICAgaWYgKHJjID09IEVYSVRfU1VDQ0VTUyAmJiBsYXVu
Y2hfZG0pIHsKKyAgICAgICAgc3RydWN0IGRvbWFpbl9jcmVhdGUgZG9tX2luZm87CisgICAgICAg
IG1lbXNldCgmZG9tX2luZm8sIDAsIHNpemVvZihkb21faW5mbykpOworICAgICAgICBkb21faW5m
by5kZG9taWQgPSBkb21pZF9vdXQ7CisgICAgICAgIGRvbV9pbmZvLmRtX3Jlc3RvcmVfZmlsZSA9
IGRtX3Jlc3RvcmVfZmlsZTsKKyAgICAgICAgZG9tX2luZm8uZGVidWcgPSBkZWJ1ZzsKKyAgICAg
ICAgZG9tX2luZm8ucGF1c2VkID0gcGF1c2U7CisgICAgICAgIGRvbV9pbmZvLmNvbmZpZ19maWxl
ID0gY29uZmlnX2ZpbGU7CisgICAgICAgIGRvbV9pbmZvLm1pZ3JhdGVfZmQgPSAtMTsKKyAgICAg
ICAgZG9tX2luZm8uc2VuZF9iYWNrX2ZkID0gLTE7CisgICAgICAgIHJjID0gY3JlYXRlX2RvbWFp
bigmZG9tX2luZm8pIDwgMCA/IEVYSVRfRkFJTFVSRSA6IEVYSVRfU1VDQ0VTUzsKKyAgICB9CisK
KyAgICBpZiAocmMgPT0gRVhJVF9TVUNDRVNTICYmICFwYXVzZSkKKyAgICAgICAgcmMgPSBsaWJ4
bF9kb21haW5fdW5wYXVzZShjdHgsIGRvbWlkX291dCwgTlVMTCk7CisKKyAgICBpZiAocmMgPT0g
RVhJVF9TVUNDRVNTKQorICAgICAgICBmcHJpbnRmKHN0ZGVyciwgImZvcmstdm0gY29tbWFuZCBz
dWNjZXNzZnVsbHkgcmV0dXJuZWQgZG9taWQ6ICV1XG4iLCBkb21pZF9vdXQpOworCisgICAgcmV0
dXJuIHJjOworfQorCiBpbnQgbWFpbl9zYXZlKGludCBhcmdjLCBjaGFyICoqYXJndikKIHsKICAg
ICB1aW50MzJfdCBkb21pZDsKZGlmZiAtLWdpdCBhL3Rvb2xzL3hsL3hsX3ZtY29udHJvbC5jIGIv
dG9vbHMveGwveGxfdm1jb250cm9sLmMKaW5kZXggZTUyMGIxZGE3OS4uZDljYjE5YzU5OSAxMDA2
NDQKLS0tIGEvdG9vbHMveGwveGxfdm1jb250cm9sLmMKKysrIGIvdG9vbHMveGwveGxfdm1jb250
cm9sLmMKQEAgLTY0NSw2ICs2NDUsNyBAQCBpbnQgY3JlYXRlX2RvbWFpbihzdHJ1Y3QgZG9tYWlu
X2NyZWF0ZSAqZG9tX2luZm8pCiAKICAgICBsaWJ4bF9kb21haW5fY29uZmlnIGRfY29uZmlnOwog
CisgICAgdWludDMyX3QgZGRvbWlkID0gZG9tX2luZm8tPmRkb21pZDsgLy8gbGF1bmNoIGRtIGZv
ciB0aGlzIGRvbWFpbiBpZmYgc2V0CiAgICAgaW50IGRlYnVnID0gZG9tX2luZm8tPmRlYnVnOwog
ICAgIGludCBkYWVtb25pemUgPSBkb21faW5mby0+ZGFlbW9uaXplOwogICAgIGludCBtb25pdG9y
ID0gZG9tX2luZm8tPm1vbml0b3I7CkBAIC02NTUsNiArNjU2LDcgQEAgaW50IGNyZWF0ZV9kb21h
aW4oc3RydWN0IGRvbWFpbl9jcmVhdGUgKmRvbV9pbmZvKQogICAgIGNvbnN0IGNoYXIgKnJlc3Rv
cmVfZmlsZSA9IGRvbV9pbmZvLT5yZXN0b3JlX2ZpbGU7CiAgICAgY29uc3QgY2hhciAqY29uZmln
X3NvdXJjZSA9IE5VTEw7CiAgICAgY29uc3QgY2hhciAqcmVzdG9yZV9zb3VyY2UgPSBOVUxMOwor
ICAgIGNvbnN0IGNoYXIgKmRtX3Jlc3RvcmVfZmlsZSA9IGRvbV9pbmZvLT5kbV9yZXN0b3JlX2Zp
bGU7CiAgICAgaW50IG1pZ3JhdGVfZmQgPSBkb21faW5mby0+bWlncmF0ZV9mZDsKICAgICBib29s
IGNvbmZpZ19pbl9qc29uOwogCkBAIC05MjMsNiArOTI1LDEyIEBAIHN0YXJ0OgogICAgICAgICAg
KiByZXN0b3JlL21pZ3JhdGUtcmVjZWl2ZSBpdCBhZ2Fpbi4KICAgICAgICAgICovCiAgICAgICAg
IHJlc3RvcmluZyA9IDA7CisgICAgfSBlbHNlIGlmICggZGRvbWlkICkgeworICAgICAgICBkX2Nv
bmZpZy5kbV9yZXN0b3JlX2ZpbGUgPSBkbV9yZXN0b3JlX2ZpbGU7CisgICAgICAgIHJldCA9IGxp
YnhsX2RvbWFpbl9mb3JrX2xhdW5jaF9kbShjdHgsICZkX2NvbmZpZywgZGRvbWlkLAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0b2Nvbm5lY3RfY29uc29sZV9o
b3cpOworICAgICAgICBkb21pZCA9IGRkb21pZDsKKyAgICAgICAgZGRvbWlkID0gSU5WQUxJRF9E
T01JRDsKICAgICB9IGVsc2UgaWYgKGRvbWlkX3NvZnRfcmVzZXQgIT0gSU5WQUxJRF9ET01JRCkg
ewogICAgICAgICAvKiBEbyBzb2Z0IHJlc2V0LiAqLwogICAgICAgICByZXQgPSBsaWJ4bF9kb21h
aW5fc29mdF9yZXNldChjdHgsICZkX2NvbmZpZywgZG9taWRfc29mdF9yZXNldCwKLS0gCjIuMjAu
MQoKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1k
ZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8v
bGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 58127BFF9C
	for <lists+xen-devel@lfdr.de>; Fri, 27 Sep 2019 09:04:28 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDkGX-0004OV-KG; Fri, 27 Sep 2019 07:02:09 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Rbpq=XW=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iDkGV-0004MJ-SR
 for xen-devel@lists.xenproject.org; Fri, 27 Sep 2019 07:02:07 +0000
X-Inumbo-ID: 93a549f8-e0f4-11e9-bf31-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 93a549f8-e0f4-11e9-bf31-bc764e2007e4;
 Fri, 27 Sep 2019 07:01:07 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 3673AB005;
 Fri, 27 Sep 2019 07:01:04 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 27 Sep 2019 09:00:36 +0200
Message-Id: <20190927070050.12405-33-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190927070050.12405-1-jgross@suse.com>
References: <20190927070050.12405-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v4 32/46] xen/sched: support allocating multiple
 vcpus into one sched unit
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2l0aCBhIHNjaGVkdWxpbmcgZ3JhbnVsYXJpdHkgZ3JlYXRlciB0aGFuIDEgbXVsdGlwbGUgdmNw
dXMgc2hhcmUgdGhlCnNhbWUgc3RydWN0IHNjaGVkX3VuaXQuIFN1cHBvcnQgdGhhdC4KClNldHRp
bmcgdGhlIGluaXRpYWwgcHJvY2Vzc29yIG11c3QgYmUgZG9uZSBjYXJlZnVsbHk6IHdlIGNhbid0
IHVzZQpzY2hlZF9zZXRfcmVzKCkgYXMgdGhhdCByZWxpZXMgb24gZm9yX2VhY2hfc2NoZWRfdW5p
dF92Y3B1KCkgd2hpY2ggaW4KdHVybiBuZWVkcyB0aGUgdmNwdSBhbHJlYWR5IGFzIGEgbWVtYmVy
IG9mIHRoZSBkb21haW4ncyB2Y3B1IGxpbmtlZApsaXN0LCB3aGljaCBpc24ndCB0aGUgY2FzZS4K
ClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tClY0Ogot
IG1lcmdlIHBhdGNoIDM2IG9mIFYzIGludG8gdGhpcyBvbmUgKEphbiBCZXVsaWNoKQotIGFkZCBz
b21lIGNvbW1lbnRzIChKYW4gQmV1bGljaCkKLSB1c2UgdW5pdF9pZCBpbnN0ZWFkIG9mIHZjcHVf
bGlzdC0+dmNwdV9pZCAoSmFuIEJldWxpY2gpCi0tLQogeGVuL2NvbW1vbi9zY2hlZHVsZS5jIHwg
OTcgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tCiAx
IGZpbGUgY2hhbmdlZCwgNzYgaW5zZXJ0aW9ucygrKSwgMjEgZGVsZXRpb25zKC0pCgpkaWZmIC0t
Z2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCmluZGV4
IGFlNWM4MDdjNmEuLmIxMWExYzI1MzggMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2NoZWR1bGUu
YworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTM0Nyw3ICszNDcsNyBAQCBzdGF0aWMg
dm9pZCBzY2hlZF9zcGluX3VubG9ja19kb3VibGUoc3BpbmxvY2tfdCAqbG9jazEsIHNwaW5sb2Nr
X3QgKmxvY2syLAogICAgIHNwaW5fdW5sb2NrX2lycXJlc3RvcmUobG9jazEsIGZsYWdzKTsKIH0K
IAotc3RhdGljIHZvaWQgc2NoZWRfZnJlZV91bml0KHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQor
c3RhdGljIHZvaWQgc2NoZWRfZnJlZV91bml0X21lbShzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkK
IHsKICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqcHJldl91bml0OwogICAgIHN0cnVjdCBkb21haW4g
KmQgPSB1bml0LT5kb21haW47CkBAIC0zNjYsOCArMzY2LDYgQEAgc3RhdGljIHZvaWQgc2NoZWRf
ZnJlZV91bml0KHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQogICAgICAgICB9CiAgICAgfQogCi0g
ICAgdW5pdC0+dmNwdV9saXN0LT5zY2hlZF91bml0ID0gTlVMTDsKLQogICAgIGZyZWVfY3B1bWFz
a192YXIodW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHkpOwogICAgIGZyZWVfY3B1bWFza192YXIodW5p
dC0+Y3B1X2hhcmRfYWZmaW5pdHlfc2F2ZWQpOwogICAgIGZyZWVfY3B1bWFza192YXIodW5pdC0+
Y3B1X3NvZnRfYWZmaW5pdHkpOwpAQCAtMzc1LDE4ICszNzMsNjUgQEAgc3RhdGljIHZvaWQgc2No
ZWRfZnJlZV91bml0KHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQogICAgIHhmcmVlKHVuaXQpOwog
fQogCitzdGF0aWMgdm9pZCBzY2hlZF9mcmVlX3VuaXQoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQs
IHN0cnVjdCB2Y3B1ICp2KQoreworICAgIHN0cnVjdCB2Y3B1ICp2dW5pdDsKKyAgICB1bnNpZ25l
ZCBpbnQgY250ID0gMDsKKworICAgIC8qIERvbid0IGNvdW50IHRvIGJlIHJlbGVhc2VkIHZjcHUs
IG1pZ2h0IGJlIG5vdCBpbiB2Y3B1IGxpc3QgeWV0LiAqLworICAgIGZvcl9lYWNoX3NjaGVkX3Vu
aXRfdmNwdSAoIHVuaXQsIHZ1bml0ICkKKyAgICAgICAgaWYgKCB2dW5pdCAhPSB2ICkKKyAgICAg
ICAgICAgIGNudCsrOworCisgICAgdi0+c2NoZWRfdW5pdCA9IE5VTEw7CisgICAgdW5pdC0+cnVu
c3RhdGVfY250W3YtPnJ1bnN0YXRlLnN0YXRlXS0tOworCisgICAgaWYgKCB1bml0LT52Y3B1X2xp
c3QgPT0gdiApCisgICAgICAgIHVuaXQtPnZjcHVfbGlzdCA9IHYtPm5leHRfaW5fbGlzdDsKKwor
ICAgIGlmICggIWNudCApCisgICAgICAgIHNjaGVkX2ZyZWVfdW5pdF9tZW0odW5pdCk7Cit9CisK
K3N0YXRpYyB2b2lkIHNjaGVkX3VuaXRfYWRkX3ZjcHUoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQs
IHN0cnVjdCB2Y3B1ICp2KQoreworICAgIHYtPnNjaGVkX3VuaXQgPSB1bml0OworCisgICAgLyog
QWxsIGJ1dCBpZGxlIHZjcHVzIGFyZSBhbGxvY2F0ZWQgd2l0aCBzZXF1ZW50aWFsIHZjcHVfaWQu
ICovCisgICAgaWYgKCAhdW5pdC0+dmNwdV9saXN0IHx8IHVuaXQtPnZjcHVfbGlzdC0+dmNwdV9p
ZCA+IHYtPnZjcHVfaWQgKQorICAgIHsKKyAgICAgICAgdW5pdC0+dmNwdV9saXN0ID0gdjsKKyAg
ICAgICAgLyoKKyAgICAgICAgICogdW5pdF9pZCBpcyBhbHdheXMgdGhlIHNhbWUgYXMgbG93ZXN0
IHZjcHVfaWQgb2YgdW5pdC4KKyAgICAgICAgICogVGhpcyBpcyB1c2VkIGZvciBzdG9wcGluZyBm
b3JfZWFjaF9zY2hlZF91bml0X3ZjcHUoKSBsb29wIGFuZCBpbgorICAgICAgICAgKiBvcmRlciB0
byBzdXBwb3J0IGNwdXBvb2xzIHdpdGggZGlmZmVyZW50IGdyYW51bGFyaXRpZXMuCisgICAgICAg
ICAqLworICAgICAgICB1bml0LT51bml0X2lkID0gdi0+dmNwdV9pZDsKKyAgICB9CisgICAgdW5p
dC0+cnVuc3RhdGVfY250W3YtPnJ1bnN0YXRlLnN0YXRlXSsrOworfQorCiBzdGF0aWMgc3RydWN0
IHNjaGVkX3VuaXQgKnNjaGVkX2FsbG9jX3VuaXQoc3RydWN0IHZjcHUgKnYpCiB7CiAgICAgc3Ry
dWN0IHNjaGVkX3VuaXQgKnVuaXQsICoqcHJldl91bml0OwogICAgIHN0cnVjdCBkb21haW4gKmQg
PSB2LT5kb21haW47CiAKKyAgICBmb3JfZWFjaF9zY2hlZF91bml0ICggZCwgdW5pdCApCisgICAg
ICAgIGlmICggdW5pdC0+dW5pdF9pZCAvIHNjaGVkX2dyYW51bGFyaXR5ID09CisgICAgICAgICAg
ICAgdi0+dmNwdV9pZCAvIHNjaGVkX2dyYW51bGFyaXR5ICkKKyAgICAgICAgICAgIGJyZWFrOwor
CisgICAgaWYgKCB1bml0ICkKKyAgICB7CisgICAgICAgIHNjaGVkX3VuaXRfYWRkX3ZjcHUodW5p
dCwgdik7CisgICAgICAgIHJldHVybiB1bml0OworICAgIH0KKwogICAgIGlmICggKHVuaXQgPSB4
emFsbG9jKHN0cnVjdCBzY2hlZF91bml0KSkgPT0gTlVMTCApCiAgICAgICAgIHJldHVybiBOVUxM
OwogCi0gICAgdW5pdC0+dmNwdV9saXN0ID0gdjsKLSAgICB1bml0LT51bml0X2lkID0gdi0+dmNw
dV9pZDsKICAgICB1bml0LT5kb21haW4gPSBkOwotICAgIHVuaXQtPnJ1bnN0YXRlX2NudFt2LT5y
dW5zdGF0ZS5zdGF0ZV0rKzsKKyAgICBzY2hlZF91bml0X2FkZF92Y3B1KHVuaXQsIHYpOwogCiAg
ICAgZm9yICggcHJldl91bml0ID0gJmQtPnNjaGVkX3VuaXRfbGlzdDsgKnByZXZfdW5pdDsKICAg
ICAgICAgICBwcmV2X3VuaXQgPSAmKCpwcmV2X3VuaXQpLT5uZXh0X2luX2xpc3QgKQpAQCAtNDAy
LDEyICs0NDcsMTAgQEAgc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9hbGxvY191bml0
KHN0cnVjdCB2Y3B1ICp2KQogICAgICAgICAgIXphbGxvY19jcHVtYXNrX3ZhcigmdW5pdC0+Y3B1
X3NvZnRfYWZmaW5pdHkpICkKICAgICAgICAgZ290byBmYWlsOwogCi0gICAgdi0+c2NoZWRfdW5p
dCA9IHVuaXQ7Ci0KICAgICByZXR1cm4gdW5pdDsKIAogIGZhaWw6Ci0gICAgc2NoZWRfZnJlZV91
bml0KHVuaXQpOworICAgIHNjaGVkX2ZyZWVfdW5pdCh1bml0LCB2KTsKICAgICByZXR1cm4gTlVM
TDsKIH0KIApAQCAtNDU3LDIxICs1MDAsMjYgQEAgaW50IHNjaGVkX2luaXRfdmNwdShzdHJ1Y3Qg
dmNwdSAqdikKICAgICBlbHNlCiAgICAgICAgIHByb2Nlc3NvciA9IHNjaGVkX3NlbGVjdF9pbml0
aWFsX2NwdSh2KTsKIAotICAgIHNjaGVkX3NldF9yZXModW5pdCwgZ2V0X3NjaGVkX3Jlcyhwcm9j
ZXNzb3IpKTsKLQogICAgIC8qIEluaXRpYWxpc2UgdGhlIHBlci12Y3B1IHRpbWVycy4gKi8KICAg
ICBzcGluX2xvY2tfaW5pdCgmdi0+cGVyaW9kaWNfdGltZXJfbG9jayk7Ci0gICAgaW5pdF90aW1l
cigmdi0+cGVyaW9kaWNfdGltZXIsIHZjcHVfcGVyaW9kaWNfdGltZXJfZm4sCi0gICAgICAgICAg
ICAgICB2LCB2LT5wcm9jZXNzb3IpOwotICAgIGluaXRfdGltZXIoJnYtPnNpbmdsZXNob3RfdGlt
ZXIsIHZjcHVfc2luZ2xlc2hvdF90aW1lcl9mbiwKLSAgICAgICAgICAgICAgIHYsIHYtPnByb2Nl
c3Nvcik7Ci0gICAgaW5pdF90aW1lcigmdi0+cG9sbF90aW1lciwgcG9sbF90aW1lcl9mbiwKLSAg
ICAgICAgICAgICAgIHYsIHYtPnByb2Nlc3Nvcik7CisgICAgaW5pdF90aW1lcigmdi0+cGVyaW9k
aWNfdGltZXIsIHZjcHVfcGVyaW9kaWNfdGltZXJfZm4sIHYsIHByb2Nlc3Nvcik7CisgICAgaW5p
dF90aW1lcigmdi0+c2luZ2xlc2hvdF90aW1lciwgdmNwdV9zaW5nbGVzaG90X3RpbWVyX2ZuLCB2
LCBwcm9jZXNzb3IpOworICAgIGluaXRfdGltZXIoJnYtPnBvbGxfdGltZXIsIHBvbGxfdGltZXJf
Zm4sIHYsIHByb2Nlc3Nvcik7CisKKyAgICAvKiBJZiB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgdmNw
dSBvZiB0aGUgdW5pdCB3ZSBhcmUgZG9uZS4gKi8KKyAgICBpZiAoIHVuaXQtPnByaXYgIT0gTlVM
TCApCisgICAgeworICAgICAgICB2LT5wcm9jZXNzb3IgPSBwcm9jZXNzb3I7CisgICAgICAgIHJl
dHVybiAwOworICAgIH0KKworICAgIC8qIFRoZSBmaXJzdCB2Y3B1IG9mIGFuIHVuaXQgY2FuIGJl
IHNldCB2aWEgc2NoZWRfc2V0X3JlcygpLiAqLworICAgIHNjaGVkX3NldF9yZXModW5pdCwgZ2V0
X3NjaGVkX3Jlcyhwcm9jZXNzb3IpKTsKIAogICAgIHVuaXQtPnByaXYgPSBzY2hlZF9hbGxvY191
ZGF0YShkb21fc2NoZWR1bGVyKGQpLCB1bml0LCBkLT5zY2hlZF9wcml2KTsKICAgICBpZiAoIHVu
aXQtPnByaXYgPT0gTlVMTCApCiAgICAgewotICAgICAgICBzY2hlZF9mcmVlX3VuaXQodW5pdCk7
CisgICAgICAgIHNjaGVkX2ZyZWVfdW5pdCh1bml0LCB2KTsKICAgICAgICAgcmV0dXJuIDE7CiAg
ICAgfQogCkBAIC02MzEsOSArNjc5LDE2IEBAIHZvaWQgc2NoZWRfZGVzdHJveV92Y3B1KHN0cnVj
dCB2Y3B1ICp2KQogICAgIGtpbGxfdGltZXIoJnYtPnBvbGxfdGltZXIpOwogICAgIGlmICggdGVz
dF9hbmRfY2xlYXJfYm9vbCh2LT5pc191cmdlbnQpICkKICAgICAgICAgYXRvbWljX2RlYygmcGVy
X2NwdShzY2hlZF91cmdlbnRfY291bnQsIHYtPnByb2Nlc3NvcikpOwotICAgIHNjaGVkX3JlbW92
ZV91bml0KHZjcHVfc2NoZWR1bGVyKHYpLCB1bml0KTsKLSAgICBzY2hlZF9mcmVlX3VkYXRhKHZj
cHVfc2NoZWR1bGVyKHYpLCB1bml0LT5wcml2KTsKLSAgICBzY2hlZF9mcmVlX3VuaXQodW5pdCk7
CisgICAgLyoKKyAgICAgKiBWY3B1cyBhcmUgYmVpbmcgZGVzdHJveWVkIHRvcC1kb3duLiBTbyBi
ZWluZyB0aGUgZmlyc3QgdmNwdSBvZiBhbiB1bml0CisgICAgICogaXMgdGhlIHNhbWUgYXMgYmVp
bmcgdGhlIG9ubHkgb25lLgorICAgICAqLworICAgIGlmICggdW5pdC0+dmNwdV9saXN0ID09IHYg
KQorICAgIHsKKyAgICAgICAgc2NoZWRfcmVtb3ZlX3VuaXQodmNwdV9zY2hlZHVsZXIodiksIHVu
aXQpOworICAgICAgICBzY2hlZF9mcmVlX3VkYXRhKHZjcHVfc2NoZWR1bGVyKHYpLCB1bml0LT5w
cml2KTsKKyAgICAgICAgc2NoZWRfZnJlZV91bml0KHVuaXQsIHYpOworICAgIH0KIH0KIAogaW50
IHNjaGVkX2luaXRfZG9tYWluKHN0cnVjdCBkb21haW4gKmQsIGludCBwb29saWQpCi0tIAoyLjE2
LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4t
ZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczov
L2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

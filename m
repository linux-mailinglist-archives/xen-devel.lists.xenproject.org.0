Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 7EB40BFF8F
	for <lists+xen-devel@lfdr.de>; Fri, 27 Sep 2019 09:03:51 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iDkG0-0003XX-LA; Fri, 27 Sep 2019 07:01:36 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Rbpq=XW=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iDkFz-0003WJ-3r
 for xen-devel@lists.xenproject.org; Fri, 27 Sep 2019 07:01:35 +0000
X-Inumbo-ID: 91f76eba-e0f4-11e9-966c-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by localhost (Halon) with ESMTPS
 id 91f76eba-e0f4-11e9-966c-12813bfff9fa;
 Fri, 27 Sep 2019 07:01:04 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 2391DB177;
 Fri, 27 Sep 2019 07:01:01 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri, 27 Sep 2019 09:00:26 +0200
Message-Id: <20190927070050.12405-23-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190927070050.12405-1-jgross@suse.com>
References: <20190927070050.12405-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v4 22/46] xen/sched: switch schedule() from
 vcpus to sched_units
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

VXNlIHNjaGVkX3VuaXRzIGluc3RlYWQgb2YgdmNwdXMgaW4gc2NoZWR1bGUoKS4gVGhpcyBpbmNs
dWRlcyB0aGUKaW50cm9kdWN0aW9uIG9mIHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hhbmdlKCkgYXMg
YSByZXBsYWNlbWVudCBvZgp2Y3B1X3J1bnN0YXRlX2NoYW5nZSgpIGluIHNjaGVkdWxlKCkuCgpT
aWduZWQtb2ZmLWJ5OiBKdWVyZ2VuIEdyb3NzIDxqZ3Jvc3NAc3VzZS5jb20+ClJldmlld2VkLWJ5
OiBEYXJpbyBGYWdnaW9saSA8ZGZhZ2dpb2xpQHN1c2UuY29tPgotLS0KTm90ZSB0aGF0IHNjaGVk
X3VuaXRfcnVuc3RhdGVfY2hhbmdlKCkgd2lsbCBiZSBzdWJzdW1lZCBieSBhbm90aGVyCnJld29y
ayBpbiBhIGxhdGVyIHBhdGNoLgoKVjQ6Ci0gbG9vcCBvdmVyIHZjcHVzIGluIHNjaGVkX3VuaXRf
cnVuc3RhdGVfY2hhbmdlKCkgKEphbiBCZXVsaWNoKQotLS0KIHhlbi9jb21tb24vc2NoZWR1bGUu
YyB8IDczICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0t
LQogMSBmaWxlIGNoYW5nZWQsIDQzIGluc2VydGlvbnMoKyksIDMwIGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWR1bGUuYyBiL3hlbi9jb21tb24vc2NoZWR1bGUuYwpp
bmRleCAyNmNlMDRiZmQ4Li5jZTA3YjJjZjk5IDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVk
dWxlLmMKKysrIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCkBAIC0yNTgsNiArMjU4LDIzIEBAIHN0
YXRpYyBpbmxpbmUgdm9pZCB2Y3B1X3J1bnN0YXRlX2NoYW5nZSgKICAgICB2LT5ydW5zdGF0ZS5z
dGF0ZSA9IG5ld19zdGF0ZTsKIH0KIAorc3RhdGljIGlubGluZSB2b2lkIHNjaGVkX3VuaXRfcnVu
c3RhdGVfY2hhbmdlKHN0cnVjdCBzY2hlZF91bml0ICp1bml0LAorICAgIGJvb2wgcnVubmluZywg
c190aW1lX3QgbmV3X2VudHJ5X3RpbWUpCit7CisgICAgc3RydWN0IHZjcHUgKnY7CisKKyAgICBm
b3JfZWFjaF9zY2hlZF91bml0X3ZjcHUgKCB1bml0LCB2ICkKKyAgICB7CisgICAgICAgIGlmICgg
cnVubmluZyApCisgICAgICAgICAgICB2Y3B1X3J1bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9y
dW5uaW5nLCBuZXdfZW50cnlfdGltZSk7CisgICAgICAgIGVsc2UKKyAgICAgICAgICAgIHZjcHVf
cnVuc3RhdGVfY2hhbmdlKHYsCisgICAgICAgICAgICAgICAgKCh2LT5wYXVzZV9mbGFncyAmIFZQ
Rl9ibG9ja2VkKSA/IFJVTlNUQVRFX2Jsb2NrZWQgOgorICAgICAgICAgICAgICAgICAodmNwdV9y
dW5uYWJsZSh2KSA/IFJVTlNUQVRFX3J1bm5hYmxlIDogUlVOU1RBVEVfb2ZmbGluZSkpLAorICAg
ICAgICAgICAgICAgIG5ld19lbnRyeV90aW1lKTsKKyAgICB9Cit9CisKIHZvaWQgdmNwdV9ydW5z
dGF0ZV9nZXQoc3RydWN0IHZjcHUgKnYsIHN0cnVjdCB2Y3B1X3J1bnN0YXRlX2luZm8gKnJ1bnN0
YXRlKQogewogICAgIHNwaW5sb2NrX3QgKmxvY2sgPSBsaWtlbHkodiA9PSBjdXJyZW50KQpAQCAt
MTYyOSw3ICsxNjQ2LDcgQEAgdm9pZCB2Y3B1X3NldF9wZXJpb2RpY190aW1lcihzdHJ1Y3QgdmNw
dSAqdiwgc190aW1lX3QgdmFsdWUpCiAgKi8KIHN0YXRpYyB2b2lkIHNjaGVkdWxlKHZvaWQpCiB7
Ci0gICAgc3RydWN0IHZjcHUgICAgICAgICAgKnByZXYgPSBjdXJyZW50LCAqbmV4dCA9IE5VTEw7
CisgICAgc3RydWN0IHNjaGVkX3VuaXQgICAgKnByZXYgPSBjdXJyZW50LT5zY2hlZF91bml0LCAq
bmV4dCA9IE5VTEw7CiAgICAgc190aW1lX3QgICAgICAgICAgICAgIG5vdzsKICAgICBzdHJ1Y3Qg
c2NoZWR1bGVyICAgICAqc2NoZWQ7CiAgICAgdW5zaWduZWQgbG9uZyAgICAgICAgKnRhc2tsZXRf
d29yayA9ICZ0aGlzX2NwdSh0YXNrbGV0X3dvcmtfdG9fZG8pOwpAQCAtMTY3Myw5ICsxNjkwLDkg
QEAgc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKICAgICBzY2hlZCA9IHRoaXNfY3B1KHNjaGVk
dWxlcik7CiAgICAgbmV4dF9zbGljZSA9IHNjaGVkLT5kb19zY2hlZHVsZShzY2hlZCwgbm93LCB0
YXNrbGV0X3dvcmtfc2NoZWR1bGVkKTsKIAotICAgIG5leHQgPSBuZXh0X3NsaWNlLnRhc2stPnZj
cHVfbGlzdDsKKyAgICBuZXh0ID0gbmV4dF9zbGljZS50YXNrOwogCi0gICAgc2QtPmN1cnIgPSBu
ZXh0LT5zY2hlZF91bml0OworICAgIHNkLT5jdXJyID0gbmV4dDsKIAogICAgIGlmICggbmV4dF9z
bGljZS50aW1lID49IDAgKSAvKiAtdmUgbWVhbnMgbm8gbGltaXQgKi8KICAgICAgICAgc2V0X3Rp
bWVyKCZzZC0+c190aW1lciwgbm93ICsgbmV4dF9zbGljZS50aW1lKTsKQEAgLTE2ODQsNTkgKzE3
MDEsNTUgQEAgc3RhdGljIHZvaWQgc2NoZWR1bGUodm9pZCkKICAgICB7CiAgICAgICAgIHBjcHVf
c2NoZWR1bGVfdW5sb2NrX2lycShsb2NrLCBjcHUpOwogICAgICAgICBUUkFDRV80RChUUkNfU0NI
RURfU1dJVENIX0lORkNPTlQsCi0gICAgICAgICAgICAgICAgIG5leHQtPmRvbWFpbi0+ZG9tYWlu
X2lkLCBuZXh0LT52Y3B1X2lkLAotICAgICAgICAgICAgICAgICBub3cgLSBwcmV2LT5ydW5zdGF0
ZS5zdGF0ZV9lbnRyeV90aW1lLAorICAgICAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRvbWFp
bl9pZCwgbmV4dC0+dW5pdF9pZCwKKyAgICAgICAgICAgICAgICAgbm93IC0gcHJldi0+c3RhdGVf
ZW50cnlfdGltZSwKICAgICAgICAgICAgICAgICAgbmV4dF9zbGljZS50aW1lKTsKLSAgICAgICAg
dHJhY2VfY29udGludWVfcnVubmluZyhuZXh0KTsKLSAgICAgICAgcmV0dXJuIGNvbnRpbnVlX3J1
bm5pbmcocHJldik7CisgICAgICAgIHRyYWNlX2NvbnRpbnVlX3J1bm5pbmcobmV4dC0+dmNwdV9s
aXN0KTsKKyAgICAgICAgcmV0dXJuIGNvbnRpbnVlX3J1bm5pbmcocHJldi0+dmNwdV9saXN0KTsK
ICAgICB9CiAKICAgICBUUkFDRV8zRChUUkNfU0NIRURfU1dJVENIX0lORlBSRVYsCi0gICAgICAg
ICAgICAgcHJldi0+ZG9tYWluLT5kb21haW5faWQsIHByZXYtPnZjcHVfaWQsCi0gICAgICAgICAg
ICAgbm93IC0gcHJldi0+cnVuc3RhdGUuc3RhdGVfZW50cnlfdGltZSk7CisgICAgICAgICAgICAg
cHJldi0+ZG9tYWluLT5kb21haW5faWQsIHByZXYtPnVuaXRfaWQsCisgICAgICAgICAgICAgbm93
IC0gcHJldi0+c3RhdGVfZW50cnlfdGltZSk7CiAgICAgVFJBQ0VfNEQoVFJDX1NDSEVEX1NXSVRD
SF9JTkZORVhULAotICAgICAgICAgICAgIG5leHQtPmRvbWFpbi0+ZG9tYWluX2lkLCBuZXh0LT52
Y3B1X2lkLAotICAgICAgICAgICAgIChuZXh0LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9y
dW5uYWJsZSkgPwotICAgICAgICAgICAgIChub3cgLSBuZXh0LT5ydW5zdGF0ZS5zdGF0ZV9lbnRy
eV90aW1lKSA6IDAsCisgICAgICAgICAgICAgbmV4dC0+ZG9tYWluLT5kb21haW5faWQsIG5leHQt
PnVuaXRfaWQsCisgICAgICAgICAgICAgKG5leHQtPnZjcHVfbGlzdC0+cnVuc3RhdGUuc3RhdGUg
PT0gUlVOU1RBVEVfcnVubmFibGUpID8KKyAgICAgICAgICAgICAobm93IC0gbmV4dC0+c3RhdGVf
ZW50cnlfdGltZSkgOiAwLAogICAgICAgICAgICAgIG5leHRfc2xpY2UudGltZSk7CiAKLSAgICBB
U1NFUlQocHJldi0+cnVuc3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmluZyk7CisgICAgQVNT
RVJUKHByZXYtPnZjcHVfbGlzdC0+cnVuc3RhdGUuc3RhdGUgPT0gUlVOU1RBVEVfcnVubmluZyk7
CiAKICAgICBUUkFDRV80RChUUkNfU0NIRURfU1dJVENILAotICAgICAgICAgICAgIHByZXYtPmRv
bWFpbi0+ZG9tYWluX2lkLCBwcmV2LT52Y3B1X2lkLAotICAgICAgICAgICAgIG5leHQtPmRvbWFp
bi0+ZG9tYWluX2lkLCBuZXh0LT52Y3B1X2lkKTsKKyAgICAgICAgICAgICBwcmV2LT5kb21haW4t
PmRvbWFpbl9pZCwgcHJldi0+dW5pdF9pZCwKKyAgICAgICAgICAgICBuZXh0LT5kb21haW4tPmRv
bWFpbl9pZCwgbmV4dC0+dW5pdF9pZCk7CiAKLSAgICB2Y3B1X3J1bnN0YXRlX2NoYW5nZSgKLSAg
ICAgICAgcHJldiwKLSAgICAgICAgKChwcmV2LT5wYXVzZV9mbGFncyAmIFZQRl9ibG9ja2VkKSA/
IFJVTlNUQVRFX2Jsb2NrZWQgOgotICAgICAgICAgKHZjcHVfcnVubmFibGUocHJldikgPyBSVU5T
VEFURV9ydW5uYWJsZSA6IFJVTlNUQVRFX29mZmxpbmUpKSwKLSAgICAgICAgbm93KTsKKyAgICBz
Y2hlZF91bml0X3J1bnN0YXRlX2NoYW5nZShwcmV2LCBmYWxzZSwgbm93KTsKIAotICAgIEFTU0VS
VChuZXh0LT5ydW5zdGF0ZS5zdGF0ZSAhPSBSVU5TVEFURV9ydW5uaW5nKTsKLSAgICB2Y3B1X3J1
bnN0YXRlX2NoYW5nZShuZXh0LCBSVU5TVEFURV9ydW5uaW5nLCBub3cpOworICAgIEFTU0VSVChu
ZXh0LT52Y3B1X2xpc3QtPnJ1bnN0YXRlLnN0YXRlICE9IFJVTlNUQVRFX3J1bm5pbmcpOworICAg
IHNjaGVkX3VuaXRfcnVuc3RhdGVfY2hhbmdlKG5leHQsIHRydWUsIG5vdyk7CiAKICAgICAvKgog
ICAgICAqIE5CLiBEb24ndCBhZGQgYW55IHRyYWNlIHJlY29yZHMgZnJvbSBoZXJlIHVudGlsIHRo
ZSBhY3R1YWwgY29udGV4dAogICAgICAqIHN3aXRjaCwgZWxzZSBsb3N0X3JlY29yZHMgcmVzdW1l
IHdpbGwgbm90IHdvcmsgcHJvcGVybHkuCiAgICAgICovCiAKLSAgICBBU1NFUlQoIW5leHQtPnNj
aGVkX3VuaXQtPmlzX3J1bm5pbmcpOwotICAgIG5leHQtPmlzX3J1bm5pbmcgPSAxOwotICAgIG5l
eHQtPnNjaGVkX3VuaXQtPmlzX3J1bm5pbmcgPSB0cnVlOwotICAgIG5leHQtPnNjaGVkX3VuaXQt
PnN0YXRlX2VudHJ5X3RpbWUgPSBub3c7CisgICAgQVNTRVJUKCFuZXh0LT5pc19ydW5uaW5nKTsK
KyAgICBuZXh0LT52Y3B1X2xpc3QtPmlzX3J1bm5pbmcgPSAxOworICAgIG5leHQtPmlzX3J1bm5p
bmcgPSB0cnVlOworICAgIG5leHQtPnN0YXRlX2VudHJ5X3RpbWUgPSBub3c7CiAKICAgICBwY3B1
X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKIAogICAgIFNDSEVEX1NUQVRfQ1JBTkso
c2NoZWRfY3R4KTsKIAotICAgIHN0b3BfdGltZXIoJnByZXYtPnBlcmlvZGljX3RpbWVyKTsKKyAg
ICBzdG9wX3RpbWVyKCZwcmV2LT52Y3B1X2xpc3QtPnBlcmlvZGljX3RpbWVyKTsKIAogICAgIGlm
ICggbmV4dF9zbGljZS5taWdyYXRlZCApCi0gICAgICAgIHNjaGVkX21vdmVfaXJxcyhuZXh0KTsK
KyAgICAgICAgc2NoZWRfbW92ZV9pcnFzKG5leHQtPnZjcHVfbGlzdCk7CiAKLSAgICB2Y3B1X3Bl
cmlvZGljX3RpbWVyX3dvcmsobmV4dCk7CisgICAgdmNwdV9wZXJpb2RpY190aW1lcl93b3JrKG5l
eHQtPnZjcHVfbGlzdCk7CiAKLSAgICBjb250ZXh0X3N3aXRjaChwcmV2LCBuZXh0KTsKKyAgICBj
b250ZXh0X3N3aXRjaChwcmV2LT52Y3B1X2xpc3QsIG5leHQtPnZjcHVfbGlzdCk7CiB9CiAKIHZv
aWQgY29udGV4dF9zYXZlZChzdHJ1Y3QgdmNwdSAqcHJldikKLS0gCjIuMTYuNAoKCl9fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5n
IGxpc3QKWGVuLWRldmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJv
amVjdC5vcmcvbWFpbG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 7DAF6F1C4B
	for <lists+xen-devel@lfdr.de>; Wed,  6 Nov 2019 18:20:42 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iSOwv-0006nk-66; Wed, 06 Nov 2019 17:18:29 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=Hgn/=Y6=suse.cz=vbabka@srs-us1.protection.inumbo.net>)
 id 1iSOwu-0006nf-6B
 for xen-devel@lists.xenproject.org; Wed, 06 Nov 2019 17:18:28 +0000
X-Inumbo-ID: 7160868e-00b9-11ea-a1af-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 7160868e-00b9-11ea-a1af-12813bfff9fa;
 Wed, 06 Nov 2019 17:18:26 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 39AE2B186;
 Wed,  6 Nov 2019 17:18:25 +0000 (UTC)
To: Ben Hutchings <ben@decadent.org.uk>, stable@vger.kernel.org
References: <20190802160614.8089-1-vbabka@suse.cz>
 <d3bb280b405d6acf0bc4176d63639201ff62853f.camel@decadent.org.uk>
From: Vlastimil Babka <vbabka@suse.cz>
Message-ID: <9c130fa4-e52d-f8bd-c450-42341c7ab441@suse.cz>
Date: Wed, 6 Nov 2019 18:18:23 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101
 Thunderbird/68.2.0
MIME-Version: 1.0
In-Reply-To: <d3bb280b405d6acf0bc4176d63639201ff62853f.camel@decadent.org.uk>
Content-Language: en-US
Subject: Re: [Xen-devel] [PATCH STABLE 4.9] x86, mm,
 gup: prevent get_page() race with munmap in paravirt guest
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Ben Hutchings <ben.hutchings@codethink.co.uk>,
 Dave Hansen <dave.hansen@linux.intel.com>, Jann Horn <jannh@google.com>,
 Peter Zijlstra <peterz@infradead.org>, x86@kernel.org,
 linux-kernel@vger.kernel.org, linux-mm@kvack.org,
 Ajay Kaher <akaher@vmware.com>, Ingo Molnar <mingo@redhat.com>,
 Borislav Petkov <bp@alien8.de>, Andy Lutomirski <luto@kernel.org>,
 xen-devel@lists.xenproject.org, Thomas Gleixner <tglx@linutronix.de>,
 Linus Torvalds <torvalds@linux-foundation.org>,
 Vitaly Kuznetsov <vkuznets@redhat.com>,
 "Kirill A . Shutemov" <kirill.shutemov@linux.intel.com>,
 Oscar Salvador <osalvador@suse.de>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

T24gOS8xOS8xOSA4OjI2IFBNLCBCZW4gSHV0Y2hpbmdzIHdyb3RlOgo+IE9uIE1vbiwgMjAxOS0w
OC0xOSBhdCAxODo1OCArMDEwMCwgVmxhc3RpbWlsIEJhYmthIHdyb3RlOgo+IFsuLi5dCj4+IEhp
LCBJJ20gc2VuZGluZyB0aGlzIHN0YWJsZS1vbmx5IHBhdGNoIGZvciBjb25zaWRlcmF0aW9uIGJl
Y2F1c2UgaXQncyBwcm9iYWJseQo+PiB1bnJlYWxpc3RpYyB0byBiYWNrcG9ydCB0aGUgNC4xMyBz
d2l0Y2ggdG8gZ2VuZXJpYyBHVVAuIEkgY2FuIGxvb2sgYXQgNC40IGFuZAo+PiAzLjE2IGlmIGFj
Y2VwdGVkLiBUaGUgUkNVIHBhZ2UgdGFibGUgZnJlZWluZyBjb3VsZCBiZSBhbHNvIGNvbnNpZGVy
ZWQuCj4gCj4gSSB3b3VsZCBiZSBpbnRlcmVzdGVkIGluIGJhY2twb3J0cyBmb3IgMy4xNiBhbmQg
NC40Lgo+IAo+PiBOb3RlIHRoZSBwYXRjaCBhbHNvIGluY2x1ZGVzIHBhZ2UgcmVmY291bnQgcHJv
dGVjdGlvbi4gSSBmb3VuZCBvdXQgdGhhdAo+PiA4ZmRlMTJjYTc5YWYgKCJtbTogcHJldmVudCBn
ZXRfdXNlcl9wYWdlcygpIGZyb20gb3ZlcmZsb3dpbmcgcGFnZSByZWZjb3VudCIpCj4+IGJhY2tw
b3J0IHRvIDQuOSBtaXNzZWQgdGhlIGFyY2gtc3BlY2lmaWMgZ3VwIGltcGxlbWVudGF0aW9uczoK
Pj4gaHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGttbC82NjUwMzIzZi1kYmM5LWYwNjktMDAwYi1m
NmIwZjk0MWEwNjVAc3VzZS5jei8KPiBbLi4uXQo+IAo+IEkgc3VwcG9zZSB0aGF0IHN0aWxsIG5l
ZWRzIHRvIGJlIGFkZHJlc3NlZCBmb3IgNC45LCByaWdodD8KCkhlcmUncyB3aGF0IGlzIEFGQUlL
IG1pc3NpbmcgZm9yIDQuOSBmb3IgeDg2IGFuZCBzMzkwLgoKLS0tLTg8LS0tLQpGcm9tIGQ5ODFi
YmY3NzBjYTQxZTk5OTExNWNmM2IwZjI3ZGRlNTc0NzlkZjAgTW9uIFNlcCAxNyAwMDowMDowMCAy
MDAxCkZyb206IFZsYXN0aW1pbCBCYWJrYSA8dmJhYmthQHN1c2UuY3o+CkRhdGU6IFdlZCwgNiBO
b3YgMjAxOSAxNjozMjo1NyArMDEwMApTdWJqZWN0OiBbUEFUQ0ggU1RBQkxFIDQuOV0gbW0sIGd1
cDogYWRkIG1pc3NpbmcgcmVmY291bnQgb3ZlcmZsb3cgY2hlY2tzIG9uIHg4NiBhbmQgczM5MAoK
VGhlIG1haW5saW5lIGNvbW1pdCA4ZmRlMTJjYTc5YWYgKCJtbTogcHJldmVudCBnZXRfdXNlcl9w
YWdlcygpIGZyb20Kb3ZlcmZsb3dpbmcgcGFnZSByZWZjb3VudCIpIHdhcyBiYWNrcG9ydGVkIHRv
IDQuOS55IHN0YWJsZSBhcyBjb21taXQKMmVkNzY4Y2ZkODk1LiBUaGUgYmFja3BvcnQgaG93ZXZl
ciBtaXNzZWQgdGhhdCBpbiA0LjksIHRoZXJlIGFyZSBzZXZlcmFsCmFyY2gtc3BlY2lmaWMgZ3Vw
LmMgdmVyc2lvbnMgd2l0aCBmYXN0IGd1cCBpbXBsZW1lbnRhdGlvbnMsIHNvIHRoZXNlIGRvIG5v
dApwcmV2ZW50IHJlZmNvdW50IG92ZXJmbG93LgoKVGhpcyBpcyBwYXJ0aWFsbHkgZml4ZWQgZm9y
IHg4NiBpbiBzdGFibGUtb25seSBjb21taXQgZDczYWY3OTc0MmU3ICgieDg2LCBtbSwKZ3VwOiBw
cmV2ZW50IGdldF9wYWdlKCkgcmFjZSB3aXRoIG11bm1hcCBpbiBwYXJhdmlydCBndWVzdCIpLiBU
aGlzIHN0YWJsZS1vbmx5CmNvbW1pdCBhZGRzIG1pc3NpbmcgcGFydHMgdG8geDg2IHZlcnNpb24s
IGFzIHdlbGwgYXMgczM5MCB2ZXJzaW9uLCBib3RoIHRha2VuCmZyb20gdGhlIFNVU0UgU0xFUy9v
cGVuU1VTRSA0LjEyLWJhc2VkIGtlcm5lbHMuCgpUaGUgcmVtYWluaW5nIGFyY2hpdGVjdHVyZXMg
d2l0aCBvd24gZ3VwLmMgYXJlIHNwYXJjLCBtaXBzLCBzaC4gSXQncyB1bmxpa2VseQp0aGUga25v
d24gb3ZlcmZsb3cgc2NlbmFyaW8gYmFzZWQgb24gRlVTRSwgd2hpY2ggbmVlZHMgMTQwR0Igb2Yg
UkFNLCBpcyBhCnByb2JsZW0gZm9yIHRob3NlIGFyY2hpdGVjdHVyZXMsIGFuZCBJIGRvbid0IGZl
ZWwgY29uZmlkZW50IGVub3VnaCB0byBwYXRjaAp0aGVtLgoKU2lnbmVkLW9mZi1ieTogVmxhc3Rp
bWlsIEJhYmthIDx2YmFia2FAc3VzZS5jej4KLS0tCiBhcmNoL3MzOTAvbW0vZ3VwLmMgfCAgOSAr
KysrKystLS0KIGFyY2gveDg2L21tL2d1cC5jICB8IDEwICsrKysrKysrLS0KIDIgZmlsZXMgY2hh
bmdlZCwgMTQgaW5zZXJ0aW9ucygrKSwgNSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9hcmNo
L3MzOTAvbW0vZ3VwLmMgYi9hcmNoL3MzOTAvbW0vZ3VwLmMKaW5kZXggOTdmYzQ0OWE3NDcwLi4z
M2E5NDAzODlhNmQgMTAwNjQ0Ci0tLSBhL2FyY2gvczM5MC9tbS9ndXAuYworKysgYi9hcmNoL3Mz
OTAvbW0vZ3VwLmMKQEAgLTM4LDcgKzM4LDggQEAgc3RhdGljIGlubGluZSBpbnQgZ3VwX3B0ZV9y
YW5nZShwbWRfdCAqcG1kcCwgcG1kX3QgcG1kLCB1bnNpZ25lZCBsb25nIGFkZHIsCiAJCVZNX0JV
R19PTighcGZuX3ZhbGlkKHB0ZV9wZm4ocHRlKSkpOwogCQlwYWdlID0gcHRlX3BhZ2UocHRlKTsK
IAkJaGVhZCA9IGNvbXBvdW5kX2hlYWQocGFnZSk7Ci0JCWlmICghcGFnZV9jYWNoZV9nZXRfc3Bl
Y3VsYXRpdmUoaGVhZCkpCisJCWlmICh1bmxpa2VseShXQVJOX09OX09OQ0UocGFnZV9yZWZfY291
bnQoaGVhZCkgPCAwKQorCQkgICAgfHwgIXBhZ2VfY2FjaGVfZ2V0X3NwZWN1bGF0aXZlKGhlYWQp
KSkKIAkJCXJldHVybiAwOwogCQlpZiAodW5saWtlbHkocHRlX3ZhbChwdGUpICE9IHB0ZV92YWwo
KnB0ZXApKSkgewogCQkJcHV0X3BhZ2UoaGVhZCk7CkBAIC03Niw3ICs3Nyw4IEBAIHN0YXRpYyBp
bmxpbmUgaW50IGd1cF9odWdlX3BtZChwbWRfdCAqcG1kcCwgcG1kX3QgcG1kLCB1bnNpZ25lZCBs
b25nIGFkZHIsCiAJCXJlZnMrKzsKIAl9IHdoaWxlIChhZGRyICs9IFBBR0VfU0laRSwgYWRkciAh
PSBlbmQpOwogCi0JaWYgKCFwYWdlX2NhY2hlX2FkZF9zcGVjdWxhdGl2ZShoZWFkLCByZWZzKSkg
eworCWlmICh1bmxpa2VseShXQVJOX09OX09OQ0UocGFnZV9yZWZfY291bnQoaGVhZCkgPCAwKQor
CSAgICB8fCAhcGFnZV9jYWNoZV9hZGRfc3BlY3VsYXRpdmUoaGVhZCwgcmVmcykpKSB7CiAJCSpu
ciAtPSByZWZzOwogCQlyZXR1cm4gMDsKIAl9CkBAIC0xNTAsNyArMTUyLDggQEAgc3RhdGljIGlu
dCBndXBfaHVnZV9wdWQocHVkX3QgKnB1ZHAsIHB1ZF90IHB1ZCwgdW5zaWduZWQgbG9uZyBhZGRy
LAogCQlyZWZzKys7CiAJfSB3aGlsZSAoYWRkciArPSBQQUdFX1NJWkUsIGFkZHIgIT0gZW5kKTsK
IAotCWlmICghcGFnZV9jYWNoZV9hZGRfc3BlY3VsYXRpdmUoaGVhZCwgcmVmcykpIHsKKwlpZiAo
dW5saWtlbHkoV0FSTl9PTl9PTkNFKHBhZ2VfcmVmX2NvdW50KGhlYWQpIDwgMCkKKwkgICAgfHwg
IXBhZ2VfY2FjaGVfYWRkX3NwZWN1bGF0aXZlKGhlYWQsIHJlZnMpKSkgewogCQkqbnIgLT0gcmVm
czsKIAkJcmV0dXJuIDA7CiAJfQpkaWZmIC0tZ2l0IGEvYXJjaC94ODYvbW0vZ3VwLmMgYi9hcmNo
L3g4Ni9tbS9ndXAuYwppbmRleCBkN2RiNDViZGZiM2IuLjU1MWZjN2ZlYTA0NiAxMDA2NDQKLS0t
IGEvYXJjaC94ODYvbW0vZ3VwLmMKKysrIGIvYXJjaC94ODYvbW0vZ3VwLmMKQEAgLTIwMiwxMCAr
MjAyLDEyIEBAIHN0YXRpYyBpbnQgX19ndXBfZGV2aWNlX2h1Z2VfcG1kKHBtZF90IHBtZCwgdW5z
aWduZWQgbG9uZyBhZGRyLAogCQkJdW5kb19kZXZfcGFnZW1hcChuciwgbnJfc3RhcnQsIHBhZ2Vz
KTsKIAkJCXJldHVybiAwOwogCQl9CisJCWlmICh1bmxpa2VseSghdHJ5X2dldF9wYWdlKHBhZ2Up
KSkgeworCQkJcHV0X2Rldl9wYWdlbWFwKHBnbWFwKTsKKwkJCXJldHVybiAwOworCQl9CiAJCVNl
dFBhZ2VSZWZlcmVuY2VkKHBhZ2UpOwogCQlwYWdlc1sqbnJdID0gcGFnZTsKLQkJZ2V0X3BhZ2Uo
cGFnZSk7Ci0JCXB1dF9kZXZfcGFnZW1hcChwZ21hcCk7CiAJCSgqbnIpKys7CiAJCXBmbisrOwog
CX0gd2hpbGUgKGFkZHIgKz0gUEFHRV9TSVpFLCBhZGRyICE9IGVuZCk7CkBAIC0yMzAsNiArMjMy
LDggQEAgc3RhdGljIG5vaW5saW5lIGludCBndXBfaHVnZV9wbWQocG1kX3QgcG1kLCB1bnNpZ25l
ZCBsb25nIGFkZHIsCiAKIAlyZWZzID0gMDsKIAloZWFkID0gcG1kX3BhZ2UocG1kKTsKKwlpZiAo
V0FSTl9PTl9PTkNFKHBhZ2VfcmVmX2NvdW50KGhlYWQpIDw9IDApKQorCQlyZXR1cm4gMDsKIAlw
YWdlID0gaGVhZCArICgoYWRkciAmIH5QTURfTUFTSykgPj4gUEFHRV9TSElGVCk7CiAJZG8gewog
CQlWTV9CVUdfT05fUEFHRShjb21wb3VuZF9oZWFkKHBhZ2UpICE9IGhlYWQsIHBhZ2UpOwpAQCAt
Mjg5LDYgKzI5Myw4IEBAIHN0YXRpYyBub2lubGluZSBpbnQgZ3VwX2h1Z2VfcHVkKHB1ZF90IHB1
ZCwgdW5zaWduZWQgbG9uZyBhZGRyLAogCiAJcmVmcyA9IDA7CiAJaGVhZCA9IHB1ZF9wYWdlKHB1
ZCk7CisJaWYgKFdBUk5fT05fT05DRShwYWdlX3JlZl9jb3VudChoZWFkKSA8PSAwKSkKKwkJcmV0
dXJuIDA7CiAJcGFnZSA9IGhlYWQgKyAoKGFkZHIgJiB+UFVEX01BU0spID4+IFBBR0VfU0hJRlQp
OwogCWRvIHsKIAkJVk1fQlVHX09OX1BBR0UoY29tcG91bmRfaGVhZChwYWdlKSAhPSBoZWFkLCBw
YWdlKTsKLS0gCjIuMjMuMAoKCgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJv
amVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hl
bi1kZXZlbA==

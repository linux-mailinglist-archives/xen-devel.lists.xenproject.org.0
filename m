Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id BF8C666973
	for <lists+xen-devel@lfdr.de>; Fri, 12 Jul 2019 10:57:10 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hlrIW-0007DV-UX; Fri, 12 Jul 2019 08:52:56 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=BMMu=VJ=amazon.de=prvs=0898c1a4e=nmanthey@srs-us1.protection.inumbo.net>)
 id 1hlrIW-0007DP-AP
 for xen-devel@lists.xenproject.org; Fri, 12 Jul 2019 08:52:56 +0000
X-Inumbo-ID: 700ee43a-a482-11e9-8980-bc764e045a96
Received: from smtp-fw-4101.amazon.com (unknown [72.21.198.25])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 700ee43a-a482-11e9-8980-bc764e045a96;
 Fri, 12 Jul 2019 08:52:54 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=amazon.de; i=@amazon.de; q=dns/txt; s=amazon201209;
 t=1562921574; x=1594457574;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version;
 bh=AkmU3c4Db/mum6sKJmB+AsAy1PT0qgJ1WAcHMAFPhhM=;
 b=q2PVq+up9mBwAShaJqXAOF46BWaU0IKYs/+owI/9ijRuOK+V+T8tgqHk
 yVhIvByW6sw+rHTaScO7t919bpglJSxxQk+gfZ1a/dA/TJ52kEf8DiJGD
 RhI3wcZw671tp2aVaZfEEdiZrciCZZqhX+K5iTv4MPUbo5CO/dxfAEkss E=;
X-IronPort-AV: E=Sophos;i="5.62,481,1554768000"; d="scan'208";a="774282084"
Received: from iad6-co-svc-p1-lb1-vlan3.amazon.com (HELO
 email-inbound-relay-2a-e7be2041.us-west-2.amazon.com) ([10.124.125.6])
 by smtp-border-fw-out-4101.iad4.amazon.com with ESMTP;
 12 Jul 2019 08:52:52 +0000
Received: from EX13MTAUEB001.ant.amazon.com
 (pdx4-ws-svc-p6-lb7-vlan2.pdx.amazon.com [10.170.41.162])
 by email-inbound-relay-2a-e7be2041.us-west-2.amazon.com (Postfix) with ESMTPS
 id 2549AA2434; Fri, 12 Jul 2019 08:52:51 +0000 (UTC)
Received: from EX13D08UEB004.ant.amazon.com (10.43.60.142) by
 EX13MTAUEB001.ant.amazon.com (10.43.60.129) with Microsoft SMTP Server (TLS)
 id 15.0.1367.3; Fri, 12 Jul 2019 08:52:29 +0000
Received: from EX13MTAUEA001.ant.amazon.com (10.43.61.82) by
 EX13D08UEB004.ant.amazon.com (10.43.60.142) with Microsoft SMTP Server (TLS)
 id 15.0.1367.3; Fri, 12 Jul 2019 08:52:29 +0000
Received: from uc1a35a69ae4659.ant.amazon.com (10.28.85.50) by
 mail-relay.amazon.com (10.43.61.243) with Microsoft SMTP Server id
 15.0.1367.3 via Frontend Transport; Fri, 12 Jul 2019 08:52:27 +0000
From: Norbert Manthey <nmanthey@amazon.de>
To: <xen-devel@lists.xenproject.org>
Date: Fri, 12 Jul 2019 10:51:41 +0200
Message-ID: <1562921502-20137-2-git-send-email-nmanthey@amazon.de>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <1562921502-20137-1-git-send-email-nmanthey@amazon.de>
References: <1562921502-20137-1-git-send-email-nmanthey@amazon.de>
MIME-Version: 1.0
Precedence: Bulk
Subject: [Xen-devel] [PATCH L1TF MDS GT v3 1/2] common/grant_table: harden
 bound accesses
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wei.liu2@citrix.com>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Ian
 Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Martin Pohlack <mpohlack@amazon.de>, Pawel Wieczorkiewicz <wipawel@amazon.de>,
 Julien Grall <julien.grall@arm.com>, David Woodhouse <dwmw@amazon.co.uk>,
 Jan Beulich <jbeulich@suse.com>, Martin Mazein <amazein@amazon.de>,
 Bjoern Doebel <doebel@amazon.de>, Norbert Manthey <nmanthey@amazon.de>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

R3Vlc3RzIGNhbiBpc3N1ZSBncmFudCB0YWJsZSBvcGVyYXRpb25zIGFuZCBwcm92aWRlIGd1ZXN0
IGNvbnRyb2xsZWQKZGF0YSB0byB0aGVtLiBUaGlzIGRhdGEgaXMgdXNlZCBhcyBpbmRleCBmb3Ig
bWVtb3J5IGxvYWRzIGFmdGVyIGJvdW5kCmNoZWNrcyBoYXZlIGJlZW4gZG9uZS4gVG8gYXZvaWQg
c3BlY3VsYXRpdmUgb3V0LW9mLWJvdW5kIGFjY2Vzc2VzLCB3ZQp1c2UgdGhlIGFycmF5X2luZGV4
X25vc3BlYyBtYWNybyB3aGVyZSBhcHBsaWNhYmxlLCBvciB0aGUgbWFjcm8KYmxvY2tfc3BlY3Vs
YXRpb24uIE5vdGUsIHRoZSBibG9ja19zcGVjdWxhdGlvbiBtYWNybyBpcyB1c2VkIG9uIGFsbApw
YXRoIGluIHNoYXJlZF9lbnRyeV9oZWFkZXIgYW5kIG5yX2dyYW50X2VudHJpZXMuIFRoaXMgd2F5
LCBhZnRlciBhCmNhbGwgdG8gc3VjaCBhIGZ1bmN0aW9uLCBhbGwgYm91bmQgY2hlY2tzIHRoYXQg
aGFwcGVuZWQgYmVmb3JlIGJlY29tZQphcmNoaXRlY3R1cmFsIHZpc2libGUsIHNvIHRoYXQgbm8g
YWRkaXRpb25hbCBwcm90ZWN0aW9uIGlzIHJlcXVpcmVkCmZvciBjb3JyZXNwb25kaW5nIGFycmF5
IGFjY2Vzc2VzLiBBcyB0aGUgd2F5IHdlIGludHJvZHVjZSBhbiBsZmVuY2UKaW5zdHJ1Y3Rpb24g
bWlnaHQgYWxsb3cgdGhlIGNvbXBpbGVyIHRvIHJlbG9hZCBjZXJ0YWluIHZhbHVlcyBmcm9tCm1l
bW9yeSBtdWx0aXBsZSB0aW1lcywgd2UgdHJ5IHRvIGF2b2lkIHNwZWN1bGF0aXZlbHkgY29udGlu
dWluZwpleGVjdXRpb24gd2l0aCBzdGFsZSByZWdpc3RlciBkYXRhIGJ5IG1vdmluZyByZWxldmFu
dCBkYXRhIGludG8KZnVuY3Rpb24gbG9jYWwgdmFyaWFibGVzLgoKU3BlY3VsYXRpdmUgZXhlY3V0
aW9uIGlzIG5vdCBibG9ja2VkIGluIGNhc2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcKcHJvcGVydGll
cyBpcyB0cnVlOgogLSBwYXRoIGNhbm5vdCBiZSB0cmlnZ2VyZWQgYnkgdGhlIGd1ZXN0CiAtIHBh
dGggZG9lcyBub3QgcmV0dXJuIHRvIHRoZSBndWVzdAogLSBwYXRoIGRvZXMgbm90IHJlc3VsdCBp
biBhbiBvdXQtb2YtYm91bmQgYWNjZXNzCiAtIHBhdGggY2Fubm90IGJlIGV4ZWN1dGVkIHJlcGVh
dGVkbHkKT25seSB0aGUgY29tYmluYXRpb24gb2YgdGhlIGFib3ZlIHByb3BlcnRpZXMgYWxsb3dz
IHRvIGFjdHVhbGx5IGxlYWsKY29udGludW91cyBjaHVua3Mgb2YgbWVtb3J5LiBUaGVyZWZvcmUs
IHdlIG9ubHkgYWRkIHRoZSBwZW5hbHR5IG9mCnByb3RlY3RpdmUgbWVjaGFuaXNtcyBpbiBjYXNl
IGEgcG90ZW50aWFsIHNwZWN1bGF0aXZlIG91dC1vZi1ib3VuZAphY2Nlc3MgbWF0Y2hlcyBhbGwg
dGhlIGFib3ZlIHByb3BlcnRpZXMuCgpUaGlzIGNvbW1pdCBhZGRyZXNzZXMgb25seSBvdXQtb2Yt
Ym91bmQgYWNjZXNzZXMgd2hvc2UgaW5kZXggaXMKZGlyZWN0bHkgY29udHJvbGxlZCBieSB0aGUg
Z3Vlc3QsIGFuZCB0aGUgaW5kZXggaXMgY2hlY2tlZCBiZWZvcmUuClBvdGVudGlhbCBvdXQtb2Yt
Ym91bmQgYWNjZXNzZXMgdGhhdCBhcmUgY2F1c2VkIGJ5IHNwZWN1bGF0aXZlbHkKZXZhbHVhdGlu
ZyB0aGUgdmVyc2lvbiBvZiB0aGUgY3VycmVudCB0YWJsZSBhcmUgbm90IGFkZHJlc3NlZCBpbiB0
aGlzCmNvbW1pdC4gSGVuY2UsIHNwZWN1bGF0aXZlIG91dC1vZi1ib3VuZCBhY2Nlc3NlcyBtaWdo
dCBzdGlsbCBiZQpwb3NzaWJsZSwgZm9yIGV4YW1wbGUgaW4gZ250dGFiX2dldF9zdGF0dXNfZnJh
bWVfbWZuLCB3aGVuIGNhbGxpbmcKZ250dGFiX2dyb3dfdGFibGUsIHRoZSBhc3NlcnRpb24gdGhh
dCB0aGUgZ3JhbnQgdGFibGUgdmVyc2lvbiBlcXVhbHMKdHdvIG1pZ2h0IG5vdCBob2xkIHVuZGVy
IHNwZWN1bGF0aW9uLgoKVGhpcyBpcyBwYXJ0IG9mIHRoZSBzcGVjdWxhdGl2ZSBoYXJkZW5pbmcg
ZWZmb3J0LgoKU2lnbmVkLW9mZi1ieTogTm9yYmVydCBNYW50aGV5IDxubWFudGhleUBhbWF6b24u
ZGU+Ci0tLQoKTm90ZXM6CiAgdjM6ICBEcm9wIGxvY2FsIHZhcmlhYmxlIGZvciBmdW5jdGlvbiBs
b2NhbCBnb3Agc3RydWN0dXJlLgogICAgICAgV3JhcCB0b28gbG9uZyBsaW5lcwoKIHhlbi9jb21t
b24vZ3JhbnRfdGFibGUuYyB8IDcyICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKyst
LS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDUxIGluc2VydGlvbnMoKyksIDIxIGRlbGV0
aW9ucygtKQoKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vZ3JhbnRfdGFibGUuYyBiL3hlbi9jb21t
b24vZ3JhbnRfdGFibGUuYwotLS0gYS94ZW4vY29tbW9uL2dyYW50X3RhYmxlLmMKKysrIGIveGVu
L2NvbW1vbi9ncmFudF90YWJsZS5jCkBAIC05MTIsNiArOTEyLDcgQEAgbWFwX2dyYW50X3JlZigK
IHsKICAgICBzdHJ1Y3QgZG9tYWluICpsZCwgKnJkLCAqb3duZXIgPSBOVUxMOwogICAgIHN0cnVj
dCBncmFudF90YWJsZSAqbGd0LCAqcmd0OworICAgIGdyYW50X3JlZl90IHJlZjsKICAgICBzdHJ1
Y3QgdmNwdSAgICpsZWQ7CiAgICAgZ3JhbnRfaGFuZGxlX3QgaGFuZGxlOwogICAgIG1mbl90IG1m
bjsKQEAgLTk3NSwxMyArOTc2LDE1IEBAIG1hcF9ncmFudF9yZWYoCiAgICAgZ3JhbnRfcmVhZF9s
b2NrKHJndCk7CiAKICAgICAvKiBCb3VuZHMgY2hlY2sgb24gdGhlIGdyYW50IHJlZiAqLwotICAg
IGlmICggdW5saWtlbHkob3AtPnJlZiA+PSBucl9ncmFudF9lbnRyaWVzKHJndCkpKQorICAgIHJl
ZiA9IG9wLT5yZWY7CisgICAgaWYgKCB1bmxpa2VseShyZWYgPj0gbnJfZ3JhbnRfZW50cmllcyhy
Z3QpKSkKICAgICAgICAgUElOX0ZBSUwodW5sb2NrX291dCwgR05UU1RfYmFkX2dudHJlZiwgIkJh
ZCByZWYgJSN4IGZvciBkJWRcbiIsCi0gICAgICAgICAgICAgICAgIG9wLT5yZWYsIHJndC0+ZG9t
YWluLT5kb21haW5faWQpOworICAgICAgICAgICAgICAgICByZWYsIHJndC0+ZG9tYWluLT5kb21h
aW5faWQpOwogCi0gICAgYWN0ID0gYWN0aXZlX2VudHJ5X2FjcXVpcmUocmd0LCBvcC0+cmVmKTsK
LSAgICBzaGFoID0gc2hhcmVkX2VudHJ5X2hlYWRlcihyZ3QsIG9wLT5yZWYpOwotICAgIHN0YXR1
cyA9IHJndC0+Z3RfdmVyc2lvbiA9PSAxID8gJnNoYWgtPmZsYWdzIDogJnN0YXR1c19lbnRyeShy
Z3QsIG9wLT5yZWYpOworICAgIC8qIFRoaXMgY2FsbCBhbHNvIGVuc3VyZXMgdGhlIGFib3ZlIGNo
ZWNrIGNhbm5vdCBiZSBwYXNzZWQgc3BlY3VsYXRpdmVseSAqLworICAgIHNoYWggPSBzaGFyZWRf
ZW50cnlfaGVhZGVyKHJndCwgcmVmKTsKKyAgICBzdGF0dXMgPSByZ3QtPmd0X3ZlcnNpb24gPT0g
MSA/ICZzaGFoLT5mbGFncyA6ICZzdGF0dXNfZW50cnkocmd0LCByZWYpOworICAgIGFjdCA9IGFj
dGl2ZV9lbnRyeV9hY3F1aXJlKHJndCwgcmVmKTsKIAogICAgIC8qIElmIGFscmVhZHkgcGlubmVk
LCBjaGVjayB0aGUgYWN0aXZlIGRvbWlkIGFuZCBhdm9pZCByZWZjbnQgb3ZlcmZsb3cuICovCiAg
ICAgaWYgKCBhY3QtPnBpbiAmJgpAQCAtMTAwNCw4ICsxMDA3LDggQEAgbWFwX2dyYW50X3JlZigK
ICAgICAgICAgaWYgKCAhYWN0LT5waW4gKQogICAgICAgICB7CiAgICAgICAgICAgICB1bnNpZ25l
ZCBsb25nIGdmbiA9IHJndC0+Z3RfdmVyc2lvbiA9PSAxID8KLSAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgc2hhcmVkX2VudHJ5X3YxKHJndCwgb3AtPnJlZikuZnJhbWUgOgotICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZWRfZW50cnlfdjIocmd0LCBvcC0+cmVmKS5m
dWxsX3BhZ2UuZnJhbWU7CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlZF9l
bnRyeV92MShyZ3QsIHJlZikuZnJhbWUgOgorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBzaGFyZWRfZW50cnlfdjIocmd0LCByZWYpLmZ1bGxfcGFnZS5mcmFtZTsKIAogICAgICAgICAg
ICAgcmMgPSBnZXRfcGFnZWRfZnJhbWUoZ2ZuLCAmbWZuLCAmcGcsCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBvcC0+ZmxhZ3MgJiBHTlRNQVBfcmVhZG9ubHksIHJkKTsKQEAgLTEw
MTgsNyArMTAyMSw3IEBAIG1hcF9ncmFudF9yZWYoCiAgICAgICAgICAgICBhY3QtPmxlbmd0aCA9
IFBBR0VfU0laRTsKICAgICAgICAgICAgIGFjdC0+aXNfc3ViX3BhZ2UgPSBmYWxzZTsKICAgICAg
ICAgICAgIGFjdC0+dHJhbnNfZG9tYWluID0gcmQ7Ci0gICAgICAgICAgICBhY3QtPnRyYW5zX2dy
ZWYgPSBvcC0+cmVmOworICAgICAgICAgICAgYWN0LT50cmFuc19ncmVmID0gcmVmOwogICAgICAg
ICB9CiAgICAgfQogCkBAIC0xMjY2LDYgKzEyNjksNyBAQCB1bm1hcF9jb21tb24oCiAgICAgZG9t
aWRfdCAgICAgICAgICBkb207CiAgICAgc3RydWN0IGRvbWFpbiAgICpsZCwgKnJkOwogICAgIHN0
cnVjdCBncmFudF90YWJsZSAqbGd0LCAqcmd0OworICAgIGdyYW50X3JlZl90IHJlZjsKICAgICBz
dHJ1Y3QgYWN0aXZlX2dyYW50X2VudHJ5ICphY3Q7CiAgICAgczE2ICAgICAgICAgICAgICByYyA9
IDA7CiAgICAgc3RydWN0IGdyYW50X21hcHBpbmcgKm1hcDsKQEAgLTEzMTksNiArMTMyMyw3IEBA
IHVubWFwX2NvbW1vbigKIAogICAgIG9wLT5yZCA9IHJkOwogICAgIG9wLT5yZWYgPSBtYXAtPnJl
ZjsKKyAgICByZWYgPSBtYXAtPnJlZjsKIAogICAgIC8qCiAgICAgICogV2UgY2FuJ3QgYXNzdW1l
IHRoZXJlIHdhcyBubyByYWNpbmcgdW5tYXAgZm9yIHRoaXMgbWFwdHJhY2sgZW50cnksCkBAIC0x
MzI4LDcgKzEzMzMsNyBAQCB1bm1hcF9jb21tb24oCiAgICAgICogaW52YWxpZCBsb2NrLgogICAg
ICAqLwogICAgIHNtcF9ybWIoKTsKLSAgICBpZiAoIHVubGlrZWx5KG9wLT5yZWYgPj0gbnJfZ3Jh
bnRfZW50cmllcyhyZ3QpKSApCisgICAgaWYgKCB1bmxpa2VseShyZWYgPj0gbnJfZ3JhbnRfZW50
cmllcyhyZ3QpKSApCiAgICAgewogICAgICAgICBnZHByaW50ayhYRU5MT0dfV0FSTklORywgIlVu
c3RhYmxlIGQlZCBoYW5kbGUgJSN4XG4iLAogICAgICAgICAgICAgICAgICByZ3QtPmRvbWFpbi0+
ZG9tYWluX2lkLCBvcC0+aGFuZGxlKTsKQEAgLTEzMzcsNyArMTM0MiwxMCBAQCB1bm1hcF9jb21t
b24oCiAgICAgICAgIGdvdG8gdW5sb2NrX291dDsKICAgICB9CiAKLSAgICBhY3QgPSBhY3RpdmVf
ZW50cnlfYWNxdWlyZShyZ3QsIG9wLT5yZWYpOworICAgIC8qIE1ha2Ugc3VyZSB0aGUgYWJvdmUg
Ym91bmQgY2hlY2sgY2Fubm90IGJlIGJ5cGFzc2VkIHNwZWN1bGF0aXZlbHkgKi8KKyAgICBibG9j
a19zcGVjdWxhdGlvbigpOworCisgICAgYWN0ID0gYWN0aXZlX2VudHJ5X2FjcXVpcmUocmd0LCBy
ZWYpOwogCiAgICAgLyoKICAgICAgKiBOb3RlIHRoYXQgd2UgKGFiKXVzZSB0aGUgYWN0aXZlIGVu
dHJ5IGxvY2sgaGVyZSB0byBwcm90ZWN0IGFnYWluc3QKQEAgLTEzNTAsNyArMTM1OCw3IEBAIHVu
bWFwX2NvbW1vbigKICAgICBmbGFncyA9IHJlYWRfYXRvbWljKCZtYXAtPmZsYWdzKTsKICAgICBz
bXBfcm1iKCk7CiAgICAgaWYgKCB1bmxpa2VseSghZmxhZ3MpIHx8IHVubGlrZWx5KG1hcC0+ZG9t
aWQgIT0gZG9tKSB8fAotICAgICAgICAgdW5saWtlbHkobWFwLT5yZWYgIT0gb3AtPnJlZikgKQor
ICAgICAgICAgdW5saWtlbHkobWFwLT5yZWYgIT0gcmVmKSApCiAgICAgewogICAgICAgICBnZHBy
aW50ayhYRU5MT0dfV0FSTklORywgIlVuc3RhYmxlIGhhbmRsZSAlI3hcbiIsIG9wLT5oYW5kbGUp
OwogICAgICAgICByYyA9IEdOVFNUX2JhZF9oYW5kbGU7CkBAIC0xNDM0LDcgKzE0NDIsNyBAQCB1
bm1hcF9jb21tb25fY29tcGxldGUoc3RydWN0IGdudHRhYl91bm1hcF9jb21tb24gKm9wKQogICAg
IHN0cnVjdCBwYWdlX2luZm8gKnBnOwogICAgIHVpbnQxNl90ICpzdGF0dXM7CiAKLSAgICBpZiAo
ICFvcC0+ZG9uZSApCisgICAgaWYgKCBldmFsdWF0ZV9ub3NwZWMoIW9wLT5kb25lKSApCiAgICAg
ewogICAgICAgICAvKiB1bm1hcF9jb21tb24oKSBkaWRuJ3QgZG8gYW55dGhpbmcgLSBub3RoaW5n
IHRvIGNvbXBsZXRlLiAqLwogICAgICAgICByZXR1cm47CkBAIC0yMDQyLDYgKzIwNTAsNyBAQCBn
bnR0YWJfcHJlcGFyZV9mb3JfdHJhbnNmZXIoCiAgICAgICAgIGdvdG8gZmFpbDsKICAgICB9CiAK
KyAgICAvKiBUaGlzIGNhbGwgYWxzbyBlbnN1cmVzIHRoZSBhYm92ZSBjaGVjayBjYW5ub3QgYmUg
cGFzc2VkIHNwZWN1bGF0aXZlbHkgKi8KICAgICByYXdfc2hhaCA9ICh1aW50MzJfdCAqKXNoYXJl
ZF9lbnRyeV9oZWFkZXIocmd0LCByZWYpOwogICAgIHNjb21iby5yYXcgPSBBQ0NFU1NfT05DRSgq
cmF3X3NoYWgpOwogCkBAIC0yMjM4LDcgKzIyNDcsMTIgQEAgZ250dGFiX3RyYW5zZmVyKAogICAg
ICAgICBzcGluX3VubG9jaygmZS0+cGFnZV9hbGxvY19sb2NrKTsKICAgICAgICAgb2theSA9IGdu
dHRhYl9wcmVwYXJlX2Zvcl90cmFuc2ZlcihlLCBkLCBnb3AucmVmKTsKIAotICAgICAgICBpZiAo
IHVubGlrZWx5KCFva2F5IHx8IGFzc2lnbl9wYWdlcyhlLCBwYWdlLCAwLCBNRU1GX25vX3JlZmNv
dW50KSkgKQorICAgICAgICAvKgorICAgICAgICAgKiBNYWtlIHN1cmUgdGhlIHJlZmVyZW5jZSBi
b3VuZCBjaGVjayBpbiBnbnR0YWJfcHJlcGFyZV9mb3JfdHJhbnNmZXIKKyAgICAgICAgICogaXMg
cmVzcGVjdGVkIGFuZCBzcGVjdWxhdGl2ZSBleGVjdXRpb24gaXMgYmxvY2tlZCBhY2NvcmRpbmds
eQorICAgICAgICAgKi8KKyAgICAgICAgaWYgKCB1bmxpa2VseSghZXZhbHVhdGVfbm9zcGVjKG9r
YXkpKSB8fAorICAgICAgICAgICAgdW5saWtlbHkoYXNzaWduX3BhZ2VzKGUsIHBhZ2UsIDAsIE1F
TUZfbm9fcmVmY291bnQpKSApCiAgICAgICAgIHsKICAgICAgICAgICAgIGJvb2wgZHJvcF9kb21f
cmVmOwogCkBAIC0yNDI2LDggKzI0NDAsMTAgQEAgYWNxdWlyZV9ncmFudF9mb3JfY29weSgKICAg
ICAgICAgUElOX0ZBSUwoZ3RfdW5sb2NrX291dCwgR05UU1RfYmFkX2dudHJlZiwKICAgICAgICAg
ICAgICAgICAgIkJhZCBncmFudCByZWZlcmVuY2UgJSN4XG4iLCBncmVmKTsKIAotICAgIGFjdCA9
IGFjdGl2ZV9lbnRyeV9hY3F1aXJlKHJndCwgZ3JlZik7CisgICAgLyogVGhpcyBjYWxsIGFsc28g
ZW5zdXJlcyB0aGUgYWJvdmUgY2hlY2sgY2Fubm90IGJlIHBhc3NlZCBzcGVjdWxhdGl2ZWx5ICov
CiAgICAgc2hhaCA9IHNoYXJlZF9lbnRyeV9oZWFkZXIocmd0LCBncmVmKTsKKyAgICBhY3QgPSBh
Y3RpdmVfZW50cnlfYWNxdWlyZShyZ3QsIGdyZWYpOworCiAgICAgaWYgKCByZ3QtPmd0X3ZlcnNp
b24gPT0gMSApCiAgICAgewogICAgICAgICBzaGEyID0gTlVMTDsKQEAgLTI4NDMsNiArMjg1OSw5
IEBAIHN0YXRpYyBpbnQgZ250dGFiX2NvcHlfYnVmKGNvbnN0IHN0cnVjdCBnbnR0YWJfY29weSAq
b3AsCiAgICAgICAgICAgICAgICAgIG9wLT5kZXN0Lm9mZnNldCwgZGVzdC0+cHRyLm9mZnNldCwK
ICAgICAgICAgICAgICAgICAgb3AtPmxlbiwgZGVzdC0+bGVuKTsKIAorICAgIC8qIE1ha2Ugc3Vy
ZSB0aGUgYWJvdmUgY2hlY2tzIGFyZSBub3QgYnlwYXNzZWQgc3BlY3VsYXRpdmVseSAqLworICAg
IGJsb2NrX3NwZWN1bGF0aW9uKCk7CisKICAgICBtZW1jcHkoZGVzdC0+dmlydCArIG9wLT5kZXN0
Lm9mZnNldCwgc3JjLT52aXJ0ICsgb3AtPnNvdXJjZS5vZmZzZXQsCiAgICAgICAgICAgIG9wLT5s
ZW4pOwogICAgIGdudHRhYl9tYXJrX2RpcnR5KGRlc3QtPmRvbWFpbiwgZGVzdC0+bWZuKTsKQEAg
LTI5NjIsNyArMjk4MSw3IEBAIGdudHRhYl9zZXRfdmVyc2lvbihYRU5fR1VFU1RfSEFORExFX1BB
UkFNKGdudHRhYl9zZXRfdmVyc2lvbl90KSB1b3ApCiAgICAgc3RydWN0IGdyYW50X3RhYmxlICpn
dCA9IGN1cnJkLT5ncmFudF90YWJsZTsKICAgICBncmFudF9lbnRyeV92MV90IHJlc2VydmVkX2Vu
dHJpZXNbR05UVEFCX05SX1JFU0VSVkVEX0VOVFJJRVNdOwogICAgIGludCByZXM7Ci0gICAgdW5z
aWduZWQgaW50IGk7CisgICAgdW5zaWduZWQgaW50IGksIG5yX2VudHM7CiAKICAgICBpZiAoIGNv
cHlfZnJvbV9ndWVzdCgmb3AsIHVvcCwgMSkgKQogICAgICAgICByZXR1cm4gLUVGQVVMVDsKQEAg
LTI5ODYsNyArMzAwNSw4IEBAIGdudHRhYl9zZXRfdmVyc2lvbihYRU5fR1VFU1RfSEFORExFX1BB
UkFNKGdudHRhYl9zZXRfdmVyc2lvbl90KSB1b3ApCiAgICAgICogYXJlIGFsbG93ZWQgdG8gYmUg
aW4gdXNlICh4ZW5zdG9yZS94ZW5jb25zb2xlIGtlZXBzIHRoZW0gbWFwcGVkKS4KICAgICAgKiAo
WW91IG5lZWQgdG8gY2hhbmdlIHRoZSB2ZXJzaW9uIG51bWJlciBmb3IgZS5nLiBrZXhlYy4pCiAg
ICAgICovCi0gICAgZm9yICggaSA9IEdOVFRBQl9OUl9SRVNFUlZFRF9FTlRSSUVTOyBpIDwgbnJf
Z3JhbnRfZW50cmllcyhndCk7IGkrKyApCisgICAgbnJfZW50cyA9IG5yX2dyYW50X2VudHJpZXMo
Z3QpOworICAgIGZvciAoIGkgPSBHTlRUQUJfTlJfUkVTRVJWRURfRU5UUklFUzsgaSA8IG5yX2Vu
dHM7IGkrKyApCiAgICAgewogICAgICAgICBpZiAoIHJlYWRfYXRvbWljKCZfYWN0aXZlX2VudHJ5
KGd0LCBpKS5waW4pICE9IDAgKQogICAgICAgICB7CkBAIC0zMjI4LDYgKzMyNDgsOSBAQCBzd2Fw
X2dyYW50X3JlZihncmFudF9yZWZfdCByZWZfYSwgZ3JhbnRfcmVmX3QgcmVmX2IpCiAgICAgaWYg
KCB1bmxpa2VseShyZWZfYiA+PSBucl9ncmFudF9lbnRyaWVzKGQtPmdyYW50X3RhYmxlKSkpCiAg
ICAgICAgIFBJTl9GQUlMKG91dCwgR05UU1RfYmFkX2dudHJlZiwgIkJhZCByZWYtYiAlI3hcbiIs
IHJlZl9iKTsKIAorICAgIC8qIE1ha2Ugc3VyZSB0aGUgYWJvdmUgY2hlY2tzIGFyZSBub3QgYnlw
YXNzZWQgc3BlY3VsYXRpdmVseSAqLworICAgIGJsb2NrX3NwZWN1bGF0aW9uKCk7CisKICAgICAv
KiBTd2FwcGluZyB0aGUgc2FtZSByZWYgaXMgYSBuby1vcC4gKi8KICAgICBpZiAoIHJlZl9hID09
IHJlZl9iICkKICAgICAgICAgZ290byBvdXQ7CkBAIC0zNjk3LDEzICszNzIwLDE0IEBAIHZvaWQg
Z3JhbnRfdGFibGVfd2Fybl9hY3RpdmVfZ3JhbnRzKHN0cnVjdCBkb21haW4gKmQpCiAgICAgc3Ry
dWN0IGdyYW50X3RhYmxlICpndCA9IGQtPmdyYW50X3RhYmxlOwogICAgIHN0cnVjdCBhY3RpdmVf
Z3JhbnRfZW50cnkgKmFjdDsKICAgICBncmFudF9yZWZfdCByZWY7Ci0gICAgdW5zaWduZWQgaW50
IG5yX2FjdGl2ZSA9IDA7CisgICAgdW5zaWduZWQgaW50IG5yX2FjdGl2ZSA9IDAsIG5yX2VudHM7
CiAKICNkZWZpbmUgV0FSTl9HUkFOVF9NQVggMTAKIAogICAgIGdyYW50X3JlYWRfbG9jayhndCk7
CiAKLSAgICBmb3IgKCByZWYgPSAwOyByZWYgIT0gbnJfZ3JhbnRfZW50cmllcyhndCk7IHJlZisr
ICkKKyAgICBucl9lbnRzID0gbnJfZ3JhbnRfZW50cmllcyhndCk7CisgICAgZm9yICggcmVmID0g
MDsgcmVmICE9IG5yX2VudHM7IHJlZisrICkKICAgICB7CiAgICAgICAgIGFjdCA9IGFjdGl2ZV9l
bnRyeV9hY3F1aXJlKGd0LCByZWYpOwogICAgICAgICBpZiAoICFhY3QtPnBpbiApCkBAIC0zODUz
LDcgKzM4NzcsOSBAQCBzdGF0aWMgaW50IGdudHRhYl9nZXRfc3RhdHVzX2ZyYW1lX21mbihzdHJ1
Y3QgZG9tYWluICpkLAogICAgICAgICAgICAgcmV0dXJuIC1FSU5WQUw7CiAgICAgfQogCi0gICAg
Km1mbiA9IF9tZm4odmlydF90b19tZm4oZ3QtPnN0YXR1c1tpZHhdKSk7CisgICAgLyogTWFrZSBz
dXJlIGlkeCBpcyBib3VuZGVkIHdydCBucl9zdGF0dXNfZnJhbWVzICovCisgICAgKm1mbiA9IF9t
Zm4odmlydF90b19tZm4oCisgICAgICAgICAgICAgICAgZ3QtPnN0YXR1c1thcnJheV9pbmRleF9u
b3NwZWMoaWR4LCBucl9zdGF0dXNfZnJhbWVzKGd0KSldKSk7CiAgICAgcmV0dXJuIDA7CiB9CiAK
QEAgLTM4ODIsNyArMzkwOCw5IEBAIHN0YXRpYyBpbnQgZ250dGFiX2dldF9zaGFyZWRfZnJhbWVf
bWZuKHN0cnVjdCBkb21haW4gKmQsCiAgICAgICAgICAgICByZXR1cm4gLUVJTlZBTDsKICAgICB9
CiAKLSAgICAqbWZuID0gX21mbih2aXJ0X3RvX21mbihndC0+c2hhcmVkX3Jhd1tpZHhdKSk7Cisg
ICAgLyogTWFrZSBzdXJlIGlkeCBpcyBib3VuZGVkIHdydCBucl9zdGF0dXNfZnJhbWVzICovCisg
ICAgKm1mbiA9IF9tZm4odmlydF90b19tZm4oCisgICAgICAgICAgICAgICAgZ3QtPnNoYXJlZF9y
YXdbYXJyYXlfaW5kZXhfbm9zcGVjKGlkeCwgbnJfZ3JhbnRfZnJhbWVzKGd0KSldKSk7CiAgICAg
cmV0dXJuIDA7CiB9CiAKQEAgLTM5NTIsNiArMzk4MCw3IEBAIHN0YXRpYyB2b2lkIGdudHRhYl91
c2FnZV9wcmludChzdHJ1Y3QgZG9tYWluICpyZCkKICAgICBpbnQgZmlyc3QgPSAxOwogICAgIGdy
YW50X3JlZl90IHJlZjsKICAgICBzdHJ1Y3QgZ3JhbnRfdGFibGUgKmd0ID0gcmQtPmdyYW50X3Rh
YmxlOworICAgIHVuc2lnbmVkIGludCBucl9lbnRzOwogCiAgICAgcHJpbnRrKCIgICAgICAtLS0t
LS0tLSBhY3RpdmUgLS0tLS0tLS0gICAgICAgLS0tLS0tLS0gc2hhcmVkIC0tLS0tLS0tXG4iKTsK
ICAgICBwcmludGsoIltyZWZdIGxvY2FsZG9tIG1mbiAgICAgIHBpbiAgICAgICAgICBsb2NhbGRv
bSBnbWZuICAgICBmbGFnc1xuIik7CkBAIC0zOTY0LDcgKzM5OTMsOCBAQCBzdGF0aWMgdm9pZCBn
bnR0YWJfdXNhZ2VfcHJpbnQoc3RydWN0IGRvbWFpbiAqcmQpCiAgICAgICAgICAgIG5yX2dyYW50
X2ZyYW1lcyhndCksIGd0LT5tYXhfZ3JhbnRfZnJhbWVzLAogICAgICAgICAgICBucl9tYXB0cmFj
a19mcmFtZXMoZ3QpLCBndC0+bWF4X21hcHRyYWNrX2ZyYW1lcyk7CiAKLSAgICBmb3IgKCByZWYg
PSAwOyByZWYgIT0gbnJfZ3JhbnRfZW50cmllcyhndCk7IHJlZisrICkKKyAgICBucl9lbnRzID0g
bnJfZ3JhbnRfZW50cmllcyhndCk7CisgICAgZm9yICggcmVmID0gMDsgcmVmICE9IG5yX2VudHM7
IHJlZisrICkKICAgICB7CiAgICAgICAgIHN0cnVjdCBhY3RpdmVfZ3JhbnRfZW50cnkgKmFjdDsK
ICAgICAgICAgc3RydWN0IGdyYW50X2VudHJ5X2hlYWRlciAqc2hhOwotLSAKMi43LjQKCgoKCkFt
YXpvbiBEZXZlbG9wbWVudCBDZW50ZXIgR2VybWFueSBHbWJICktyYXVzZW5zdHIuIDM4CjEwMTE3
IEJlcmxpbgpHZXNjaGFlZnRzZnVlaHJ1bmc6IENocmlzdGlhbiBTY2hsYWVnZXIsIFJhbGYgSGVy
YnJpY2gKRWluZ2V0cmFnZW4gYW0gQW10c2dlcmljaHQgQ2hhcmxvdHRlbmJ1cmcgdW50ZXIgSFJC
IDE0OTE3MyBCClNpdHo6IEJlcmxpbgpVc3QtSUQ6IERFIDI4OSAyMzcgODc5CgoKCgpfX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGlu
ZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnBy
b2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 950F587D74
	for <lists+xen-devel@lfdr.de>; Fri,  9 Aug 2019 17:02:13 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hw6Lu-0006Qn-SP; Fri, 09 Aug 2019 14:58:46 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=yG4W=WF=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hw6Ls-0006PQ-EC
 for xen-devel@lists.xenproject.org; Fri, 09 Aug 2019 14:58:44 +0000
X-Inumbo-ID: 2d96e871-bab6-11e9-8980-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 2d96e871-bab6-11e9-8980-bc764e045a96;
 Fri, 09 Aug 2019 14:58:43 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 505B3B066;
 Fri,  9 Aug 2019 14:58:41 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri,  9 Aug 2019 16:57:55 +0200
Message-Id: <20190809145833.1020-11-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190809145833.1020-1-jgross@suse.com>
References: <20190809145833.1020-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v2 10/48] xen/sched: add scheduler helpers
 hiding vcpu
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QWRkIHRoZSBmb2xsb3dpbmcgaGVscGVycyB1c2luZyBhIHNjaGVkX3VuaXQgYXMgaW5wdXQgaW5z
dGVhZCBvZiBhCnZjcHU6CgotIGlzX2lkbGVfdW5pdCgpIHNpbWlsYXIgdG8gaXNfaWRsZV92Y3B1
KCkKLSBpc191bml0X29ubGluZSgpIHNpbWlsYXIgdG8gaXNfdmNwdV9vbmxpbmUoKQotIHVuaXRf
cnVubmFibGUoKSBsaWtlIHZjcHVfcnVubmFibGUoKQotIHNjaGVkX3NldF9yZXMoKSB0byBzZXQg
dGhlIGN1cnJlbnQgcHJvY2Vzc29yIG9mIGFuIHVuaXQKLSBzY2hlZF91bml0X2NwdSgpIHRvIGdl
dCB0aGUgY3VycmVudCBwcm9jZXNzb3Igb2YgYW4gdW5pdAotIHNjaGVkX3tzZXR8Y2xlYXJ9X3Bh
dXNlX2ZsYWdzW19hdG9taWNdKCkgdG8gbW9kaWZ5IHBhdXNlX2ZsYWdzIG9mIHRoZQogIGFzc29j
aWF0ZWQgdmNwdShzKQotIHNjaGVkX2lkbGVfdW5pdCgpIHRvIGdldCB0aGUgc2NoZWRfdW5pdCBw
b2ludGVyIG9mIHRoZSBpZGxlIHZjcHUgb2YgYQogIHNwZWNpZmljIHBoeXNpY2FsIGNwdQoKU2ln
bmVkLW9mZi1ieTogSnVlcmdlbiBHcm9zcyA8amdyb3NzQHN1c2UuY29tPgotLS0KIHhlbi9jb21t
b24vc2NoZWRfY3JlZGl0LmMgIHwgIDMgKy0tCiB4ZW4vY29tbW9uL3NjaGVkdWxlLmMgICAgICB8
IDIxICsrKysrKysrLS0tLS0tLS0KIHhlbi9pbmNsdWRlL3hlbi9zY2hlZC1pZi5oIHwgNjEgKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLQogMyBmaWxlcyBjaGFu
Z2VkLCA2OCBpbnNlcnRpb25zKCspLCAxNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4v
Y29tbW9uL3NjaGVkX2NyZWRpdC5jIGIveGVuL2NvbW1vbi9zY2hlZF9jcmVkaXQuYwppbmRleCAy
MjQzOGE1MGUyLi5iZGI5N2FjZDg4IDEwMDY0NAotLS0gYS94ZW4vY29tbW9uL3NjaGVkX2NyZWRp
dC5jCisrKyBiL3hlbi9jb21tb24vc2NoZWRfY3JlZGl0LmMKQEAgLTE2NjAsOCArMTY2MCw3IEBA
IGNzY2hlZF9ydW5xX3N0ZWFsKGludCBwZWVyX2NwdSwgaW50IGNwdSwgaW50IHByaSwgaW50IGJh
bGFuY2Vfc3RlcCkKICAgICAgICAgICAgIFNDSEVEX1NUQVRfQ1JBTksobWlncmF0ZV9xdWV1ZWQp
OwogICAgICAgICAgICAgV0FSTl9PTih2Yy0+aXNfdXJnZW50KTsKICAgICAgICAgICAgIHJ1bnFf
cmVtb3ZlKHNwZWVyKTsKLSAgICAgICAgICAgIHZjLT5wcm9jZXNzb3IgPSBjcHU7Ci0gICAgICAg
ICAgICB2Yy0+c2NoZWRfdW5pdC0+cmVzID0gZ2V0X3NjaGVkX3JlcyhjcHUpOworICAgICAgICAg
ICAgc2NoZWRfc2V0X3Jlcyh2Yy0+c2NoZWRfdW5pdCwgZ2V0X3NjaGVkX3JlcyhjcHUpKTsKICAg
ICAgICAgICAgIC8qCiAgICAgICAgICAgICAgKiBzcGVlciB3aWxsIHN0YXJ0IGV4ZWN1dGluZyBk
aXJlY3RseSBvbiBjcHUsIHdpdGhvdXQgaGF2aW5nIHRvCiAgICAgICAgICAgICAgKiBnbyB0aHJv
dWdoIHJ1bnFfaW5zZXJ0KCkuIFNvIHdlIG11c3QgdXBkYXRlIHRoZSBydW5uYWJsZSBjb3VudApk
aWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5j
CmluZGV4IDk4YWZiYjQzNWYuLmQxYTExMDNlNGEgMTAwNjQ0Ci0tLSBhL3hlbi9jb21tb24vc2No
ZWR1bGUuYworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTgxLDcgKzgxLDcgQEAgc3Rh
dGljIHNwaW5sb2NrX3QgKgogc2NoZWRfaWRsZV9zd2l0Y2hfc2NoZWQoc3RydWN0IHNjaGVkdWxl
ciAqbmV3X29wcywgdW5zaWduZWQgaW50IGNwdSwKICAgICAgICAgICAgICAgICAgICAgICAgIHZv
aWQgKnBkYXRhLCB2b2lkICp2ZGF0YSkKIHsKLSAgICBpZGxlX3ZjcHVbY3B1XS0+c2NoZWRfdW5p
dC0+cHJpdiA9IE5VTEw7CisgICAgc2NoZWRfaWRsZV91bml0KGNwdSktPnByaXYgPSBOVUxMOwog
CiAgICAgcmV0dXJuICZzY2hlZF9mcmVlX2NwdV9sb2NrOwogfQpAQCAtMzczLDEyICszNzMsMTEg
QEAgaW50IHNjaGVkX2luaXRfdmNwdShzdHJ1Y3QgdmNwdSAqdiwgdW5zaWduZWQgaW50IHByb2Nl
c3NvcikKICAgICBzdHJ1Y3QgZG9tYWluICpkID0gdi0+ZG9tYWluOwogICAgIHN0cnVjdCBzY2hl
ZF91bml0ICp1bml0OwogCi0gICAgdi0+cHJvY2Vzc29yID0gcHJvY2Vzc29yOwotCiAgICAgaWYg
KCAodW5pdCA9IHNjaGVkX2FsbG9jX3VuaXQodikpID09IE5VTEwgKQogICAgICAgICByZXR1cm4g
MTsKIAotICAgIHVuaXQtPnJlcyA9IGdldF9zY2hlZF9yZXMocHJvY2Vzc29yKTsKKyAgICBzY2hl
ZF9zZXRfcmVzKHVuaXQsIGdldF9zY2hlZF9yZXMocHJvY2Vzc29yKSk7CisKICAgICAvKiBJbml0
aWFsaXNlIHRoZSBwZXItdmNwdSB0aW1lcnMuICovCiAgICAgaW5pdF90aW1lcigmdi0+cGVyaW9k
aWNfdGltZXIsIHZjcHVfcGVyaW9kaWNfdGltZXJfZm4sCiAgICAgICAgICAgICAgICB2LCB2LT5w
cm9jZXNzb3IpOwpAQCAtNDkyLDggKzQ5MSw3IEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1
Y3QgZG9tYWluICpkLCBzdHJ1Y3QgY3B1cG9vbCAqYykKIAogICAgICAgICBzY2hlZF9zZXRfYWZm
aW5pdHkodiwgJmNwdW1hc2tfYWxsLCAmY3B1bWFza19hbGwpOwogCi0gICAgICAgIHYtPnByb2Nl
c3NvciA9IG5ld19wOwotICAgICAgICB2LT5zY2hlZF91bml0LT5yZXMgPSBnZXRfc2NoZWRfcmVz
KG5ld19wKTsKKyAgICAgICAgc2NoZWRfc2V0X3Jlcyh2LT5zY2hlZF91bml0LCBnZXRfc2NoZWRf
cmVzKG5ld19wKSk7CiAgICAgICAgIC8qCiAgICAgICAgICAqIFdpdGggdi0+cHJvY2Vzc29yIG1v
ZGlmaWVkIHdlIG11c3Qgbm90CiAgICAgICAgICAqIC0gbWFrZSBhbnkgZnVydGhlciBjaGFuZ2Vz
IGFzc3VtaW5nIHdlIGhvbGQgdGhlIHNjaGVkdWxlciBsb2NrLApAQCAtODMxLDggKzgyOSw5IEBA
IHZvaWQgcmVzdG9yZV92Y3B1X2FmZmluaXR5KHN0cnVjdCBkb21haW4gKmQpCiAgICAgICAgIHNw
aW5sb2NrX3QgKmxvY2s7CiAgICAgICAgIHVuc2lnbmVkIGludCBvbGRfY3B1ID0gdi0+cHJvY2Vz
c29yOwogICAgICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCA9IHYtPnNjaGVkX3VuaXQ7Cisg
ICAgICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqcmVzOwogCi0gICAgICAgIEFTU0VSVCghdmNw
dV9ydW5uYWJsZSh2KSk7CisgICAgICAgIEFTU0VSVCghdW5pdF9ydW5uYWJsZSh1bml0KSk7CiAK
ICAgICAgICAgLyoKICAgICAgICAgICogUmUtYXNzaWduIHRoZSBpbml0aWFsIHByb2Nlc3NvciBh
cyBhZnRlciByZXN1bWUgd2UgaGF2ZSBubwpAQCAtODY1LDE1ICs4NjQsMTUgQEAgdm9pZCByZXN0
b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAgICAgIH0KICAgICAg
ICAgfQogCi0gICAgICAgIHYtPnByb2Nlc3NvciA9IGNwdW1hc2tfYW55KGNwdW1hc2tfc2NyYXRj
aF9jcHUoY3B1KSk7Ci0gICAgICAgIHVuaXQtPnJlcyA9IGdldF9zY2hlZF9yZXModi0+cHJvY2Vz
c29yKTsKKyAgICAgICAgcmVzID0gZ2V0X3NjaGVkX3JlcyhjcHVtYXNrX2FueShjcHVtYXNrX3Nj
cmF0Y2hfY3B1KGNwdSkpKTsKKyAgICAgICAgc2NoZWRfc2V0X3Jlcyh1bml0LCByZXMpOwogCiAg
ICAgICAgIHNwaW5fdW5sb2NrX2lycShsb2NrKTsKIAogICAgICAgICAvKiB2LT5wcm9jZXNzb3Ig
bWlnaHQgaGF2ZSBjaGFuZ2VkLCBzbyByZWFjcXVpcmUgdGhlIGxvY2suICovCiAgICAgICAgIGxv
Y2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHVuaXQpOwotICAgICAgICB1bml0LT5yZXMgPSBz
Y2hlZF9waWNrX3Jlc291cmNlKHZjcHVfc2NoZWR1bGVyKHYpLCB1bml0KTsKLSAgICAgICAgdi0+
cHJvY2Vzc29yID0gdW5pdC0+cmVzLT5wcm9jZXNzb3I7CisgICAgICAgIHJlcyA9IHNjaGVkX3Bp
Y2tfcmVzb3VyY2UodmNwdV9zY2hlZHVsZXIodiksIHVuaXQpOworICAgICAgICBzY2hlZF9zZXRf
cmVzKHVuaXQsIHJlcyk7CiAgICAgICAgIHNwaW5fdW5sb2NrX2lycShsb2NrKTsKIAogICAgICAg
ICBpZiAoIG9sZF9jcHUgIT0gdi0+cHJvY2Vzc29yICkKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRl
L3hlbi9zY2hlZC1pZi5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKaW5kZXggNjg0NGZk
N2JjNy4uZDUwM2ZkMmRlYyAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgK
KysrIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKQEAgLTU5LDYgKzU5LDYyIEBAIHN0YXRp
YyBpbmxpbmUgdm9pZCBzZXRfc2NoZWRfcmVzKHVuc2lnbmVkIGludCBjcHUsIHN0cnVjdCBzY2hl
ZF9yZXNvdXJjZSAqcmVzKQogICAgIHBlcl9jcHUoc2NoZWRfcmVzLCBjcHUpID0gcmVzOwogfQog
CitzdGF0aWMgaW5saW5lIGJvb2wgaXNfaWRsZV91bml0KGNvbnN0IHN0cnVjdCBzY2hlZF91bml0
ICp1bml0KQoreworICAgIHJldHVybiBpc19pZGxlX3ZjcHUodW5pdC0+dmNwdV9saXN0KTsKK30K
Kworc3RhdGljIGlubGluZSBib29sIGlzX3VuaXRfb25saW5lKGNvbnN0IHN0cnVjdCBzY2hlZF91
bml0ICp1bml0KQoreworICAgIHJldHVybiBpc192Y3B1X29ubGluZSh1bml0LT52Y3B1X2xpc3Qp
OworfQorCitzdGF0aWMgaW5saW5lIGJvb2wgdW5pdF9ydW5uYWJsZShjb25zdCBzdHJ1Y3Qgc2No
ZWRfdW5pdCAqdW5pdCkKK3sKKyAgICByZXR1cm4gdmNwdV9ydW5uYWJsZSh1bml0LT52Y3B1X2xp
c3QpOworfQorCitzdGF0aWMgaW5saW5lIHZvaWQgc2NoZWRfc2V0X3JlcyhzdHJ1Y3Qgc2NoZWRf
dW5pdCAqdW5pdCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBzY2hl
ZF9yZXNvdXJjZSAqcmVzKQoreworICAgIHVuaXQtPnZjcHVfbGlzdC0+cHJvY2Vzc29yID0gcmVz
LT5wcm9jZXNzb3I7CisgICAgdW5pdC0+cmVzID0gcmVzOworfQorCitzdGF0aWMgaW5saW5lIHVu
c2lnbmVkIGludCBzY2hlZF91bml0X2NwdShzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCkKK3sKKyAg
ICByZXR1cm4gdW5pdC0+cmVzLT5wcm9jZXNzb3I7Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9pZCBz
Y2hlZF9zZXRfcGF1c2VfZmxhZ3Moc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBiaXQpCit7CisgICAg
X19zZXRfYml0KGJpdCwgJnVuaXQtPnZjcHVfbGlzdC0+cGF1c2VfZmxhZ3MpOworfQorCitzdGF0
aWMgaW5saW5lIHZvaWQgc2NoZWRfY2xlYXJfcGF1c2VfZmxhZ3Moc3RydWN0IHNjaGVkX3VuaXQg
KnVuaXQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWdu
ZWQgaW50IGJpdCkKK3sKKyAgICBfX2NsZWFyX2JpdChiaXQsICZ1bml0LT52Y3B1X2xpc3QtPnBh
dXNlX2ZsYWdzKTsKK30KKworc3RhdGljIGlubGluZSB2b2lkIHNjaGVkX3NldF9wYXVzZV9mbGFn
c19hdG9taWMoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgYml0KQoreworICAgIHNldF9i
aXQoYml0LCAmdW5pdC0+dmNwdV9saXN0LT5wYXVzZV9mbGFncyk7Cit9CisKK3N0YXRpYyBpbmxp
bmUgdm9pZCBzY2hlZF9jbGVhcl9wYXVzZV9mbGFnc19hdG9taWMoc3RydWN0IHNjaGVkX3VuaXQg
KnVuaXQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IHVuc2lnbmVkIGludCBiaXQpCit7CisgICAgY2xlYXJfYml0KGJpdCwgJnVuaXQtPnZjcHVfbGlz
dC0+cGF1c2VfZmxhZ3MpOworfQorCitzdGF0aWMgaW5saW5lIHN0cnVjdCBzY2hlZF91bml0ICpz
Y2hlZF9pZGxlX3VuaXQodW5zaWduZWQgaW50IGNwdSkKK3sKKyAgICByZXR1cm4gaWRsZV92Y3B1
W2NwdV0tPnNjaGVkX3VuaXQ7Cit9CisKIC8qCiAgKiBTY3JhdGNoIHNwYWNlLCBmb3IgYXZvaWRp
bmcgaGF2aW5nIHRvbyBtYW55IGNwdW1hc2tfdCBvbiB0aGUgc3RhY2suCiAgKiBXaXRoaW4gZWFj
aCBzY2hlZHVsZXIsIHdoZW4gdXNpbmcgdGhlIHNjcmF0Y2ggbWFzayBvZiBvbmUgcENQVToKQEAg
LTM0NSwxMCArNDAxLDcgQEAgc3RhdGljIGlubGluZSB2b2lkIHNjaGVkX21pZ3JhdGUoY29uc3Qg
c3RydWN0IHNjaGVkdWxlciAqcywKICAgICBpZiAoIHMtPm1pZ3JhdGUgKQogICAgICAgICBzLT5t
aWdyYXRlKHMsIHVuaXQsIGNwdSk7CiAgICAgZWxzZQotICAgIHsKLSAgICAgICAgdW5pdC0+dmNw
dV9saXN0LT5wcm9jZXNzb3IgPSBjcHU7Ci0gICAgICAgIHVuaXQtPnJlcyA9IGdldF9zY2hlZF9y
ZXMoY3B1KTsKLSAgICB9CisgICAgICAgIHNjaGVkX3NldF9yZXModW5pdCwgZ2V0X3NjaGVkX3Jl
cyhjcHUpKTsKIH0KIAogc3RhdGljIGlubGluZSBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNjaGVk
X3BpY2tfcmVzb3VyY2UoCi0tIAoyLjE2LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fXwpYZW4tZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0
cy54ZW5wcm9qZWN0Lm9yZwpodHRwczovL2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlz
dGluZm8veGVuLWRldmVs

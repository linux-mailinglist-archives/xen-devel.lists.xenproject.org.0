Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 602D0BE1B9
	for <lists+xen-devel@lfdr.de>; Wed, 25 Sep 2019 17:52:48 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iD9Xv-0000pB-Qp; Wed, 25 Sep 2019 15:49:39 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=mFb1=XU=intel.com=tamas.lengyel@srs-us1.protection.inumbo.net>)
 id 1iD9Xt-0000oE-VZ
 for xen-devel@lists.xenproject.org; Wed, 25 Sep 2019 15:49:38 +0000
X-Inumbo-ID: 113e1fba-dfac-11e9-9637-12813bfff9fa
Received: from mga12.intel.com (unknown [192.55.52.136])
 by localhost (Halon) with ESMTPS
 id 113e1fba-dfac-11e9-9637-12813bfff9fa;
 Wed, 25 Sep 2019 15:49:32 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by fmsmga106.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 25 Sep 2019 08:49:30 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,548,1559545200"; d="scan'208";a="193812639"
Received: from tlengyel-mobl2.amr.corp.intel.com (HELO localhost.localdomain)
 ([10.252.129.153])
 by orsmga006.jf.intel.com with ESMTP; 25 Sep 2019 08:49:29 -0700
From: Tamas K Lengyel <tamas.lengyel@intel.com>
To: xen-devel@lists.xenproject.org
Date: Wed, 25 Sep 2019 08:48:42 -0700
Message-Id: <e1fec257377046cf442842e27dff9bafc1f2bb27.1569425745.git.tamas.lengyel@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <cover.1569425745.git.tamas.lengyel@intel.com>
References: <cover.1569425745.git.tamas.lengyel@intel.com>
MIME-Version: 1.0
Subject: [Xen-devel] [RFC PATCH for-next 04/18] x86/mem_sharing: cleanup
 code in various locations
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Tamas K Lengyel <tamas@tklengyel.com>,
 Tamas K Lengyel <tamas.lengyel@intel.com>, Wei Liu <wl@xen.org>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>, Jan Beulich <jbeulich@suse.com>,
 =?UTF-8?q?Roger=20Pau=20Monn=C3=A9?= <roger.pau@citrix.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

Tm8gZnVuY3Rpb25hbCBjaGFuZ2VzLgoKU2lnbmVkLW9mZi1ieTogVGFtYXMgSyBMZW5neWVsIDx0
YW1hcy5sZW5neWVsQGludGVsLmNvbT4KLS0tCiB4ZW4vYXJjaC94ODYvaHZtL2h2bS5jICAgICAg
ICAgICAgfCAgMTEgKy0KIHhlbi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmluZy5jICAgICB8IDM0MiAr
KysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0KIHhlbi9hcmNoL3g4Ni9tbS9wMm0uYyAgICAg
ICAgICAgICB8ICAxNyArLQogeGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oIHwgIDQ5
ICsrKy0tCiA0IGZpbGVzIGNoYW5nZWQsIDIzNSBpbnNlcnRpb25zKCspLCAxODQgZGVsZXRpb25z
KC0pCgpkaWZmIC0tZ2l0IGEveGVuL2FyY2gveDg2L2h2bS9odm0uYyBiL3hlbi9hcmNoL3g4Ni9o
dm0vaHZtLmMKaW5kZXggNjY3YzgzMGRiNS4uZDcxZDJhZDVkNyAxMDA2NDQKLS0tIGEveGVuL2Fy
Y2gveDg2L2h2bS9odm0uYworKysgYi94ZW4vYXJjaC94ODYvaHZtL2h2bS5jCkBAIC0xODc5LDEy
ICsxODc5LDExIEBAIGludCBodm1faGFwX25lc3RlZF9wYWdlX2ZhdWx0KHBhZGRyX3QgZ3BhLCB1
bnNpZ25lZCBsb25nIGdsYSwKICAgICBpZiAoIG5wZmVjLndyaXRlX2FjY2VzcyAmJiAocDJtdCA9
PSBwMm1fcmFtX3NoYXJlZCkgKQogICAgIHsKICAgICAgICAgQVNTRVJUKHAybV9pc19ob3N0cDJt
KHAybSkpOwotICAgICAgICBzaGFyaW5nX2Vub21lbSA9IAotICAgICAgICAgICAgKG1lbV9zaGFy
aW5nX3Vuc2hhcmVfcGFnZShjdXJyZCwgZ2ZuLCAwKSA8IDApOworICAgICAgICBzaGFyaW5nX2Vu
b21lbSA9IG1lbV9zaGFyaW5nX3Vuc2hhcmVfcGFnZShjdXJyZCwgZ2ZuLCAwKTsKICAgICAgICAg
cmMgPSAxOwogICAgICAgICBnb3RvIG91dF9wdXRfZ2ZuOwogICAgIH0KLSAKKwogICAgIC8qIFNw
dXJpb3VzIGZhdWx0PyBQb0QgYW5kIGxvZy1kaXJ0eSBhbHNvIHRha2UgdGhpcyBwYXRoLiAqLwog
ICAgIGlmICggcDJtX2lzX3JhbShwMm10KSApCiAgICAgewpAQCAtMTkzMCw5ICsxOTI5LDExIEBA
IGludCBodm1faGFwX25lc3RlZF9wYWdlX2ZhdWx0KHBhZGRyX3QgZ3BhLCB1bnNpZ25lZCBsb25n
IGdsYSwKICAgICAgICAgX19wdXRfZ2ZuKHAybSwgZ2ZuKTsKICAgICBfX3B1dF9nZm4oaG9zdHAy
bSwgZ2ZuKTsKICBvdXQ6Ci0gICAgLyogQWxsIG9mIHRoZXNlIGFyZSBkZWxheWVkIHVudGlsIHdl
IGV4aXQsIHNpbmNlIHdlIG1pZ2h0IAorICAgIC8qCisgICAgICogQWxsIG9mIHRoZXNlIGFyZSBk
ZWxheWVkIHVudGlsIHdlIGV4aXQsIHNpbmNlIHdlIG1pZ2h0CiAgICAgICogc2xlZXAgb24gZXZl
bnQgcmluZyB3YWl0IHF1ZXVlcywgYW5kIHdlIG11c3Qgbm90IGhvbGQKLSAgICAgKiBsb2NrcyBp
biBzdWNoIGNpcmN1bXN0YW5jZSAqLworICAgICAqIGxvY2tzIGluIHN1Y2ggY2lyY3Vtc3RhbmNl
LgorICAgICAqLwogICAgIGlmICggcGFnZWQgKQogICAgICAgICBwMm1fbWVtX3BhZ2luZ19wb3B1
bGF0ZShjdXJyZCwgZ2ZuKTsKICAgICBpZiAoIHNoYXJpbmdfZW5vbWVtICkKZGlmZiAtLWdpdCBh
L3hlbi9hcmNoL3g4Ni9tbS9tZW1fc2hhcmluZy5jIGIveGVuL2FyY2gveDg2L21tL21lbV9zaGFy
aW5nLmMKaW5kZXggYTVmZTg5ZTMzOS4uOGFkNmNmMzg1MCAxMDA2NDQKLS0tIGEveGVuL2FyY2gv
eDg2L21tL21lbV9zaGFyaW5nLmMKKysrIGIveGVuL2FyY2gveDg2L21tL21lbV9zaGFyaW5nLmMK
QEAgLTU5LDggKzU5LDEwIEBAIHN0YXRpYyBERUZJTkVfUEVSX0NQVShwZ19sb2NrX2RhdGFfdCwg
X19wbGQpOwogI2RlZmluZSBSTUFQX1VTRVNfSEFTSFRBQihwYWdlKSBcCiAgICAgICAgICgocGFn
ZSktPnNoYXJpbmctPmhhc2hfdGFibGUuZmxhZyA9PSBOVUxMKQogI2RlZmluZSBSTUFQX0hFQVZZ
X1NIQVJFRF9QQUdFICAgUk1BUF9IQVNIVEFCX1NJWkUKLS8qIEEgYml0IG9mIGh5c3RlcmVzaXMu
IFdlIGRvbid0IHdhbnQgdG8gYmUgbXV0YXRpbmcgYmV0d2VlbiBsaXN0IGFuZCBoYXNoCi0gKiB0
YWJsZSBjb25zdGFudGx5LiAqLworLyoKKyAqIEEgYml0IG9mIGh5c3RlcmVzaXMuIFdlIGRvbid0
IHdhbnQgdG8gYmUgbXV0YXRpbmcgYmV0d2VlbiBsaXN0IGFuZCBoYXNoCisgKiB0YWJsZSBjb25z
dGFudGx5LgorICovCiAjZGVmaW5lIFJNQVBfTElHSFRfU0hBUkVEX1BBR0UgICAoUk1BUF9IRUFW
WV9TSEFSRURfUEFHRSA+PiAyKQogCiAjaWYgTUVNX1NIQVJJTkdfQVVESVQKQEAgLTg4LDcgKzkw
LDcgQEAgc3RhdGljIGlubGluZSB2b2lkIHBhZ2Vfc2hhcmluZ19kaXNwb3NlKHN0cnVjdCBwYWdl
X2luZm8gKnBhZ2UpCiB7CiAgICAgLyogVW5saWtlbHkgZ2l2ZW4gb3VyIHRocmVzaG9sZHMsIGJ1
dCB3ZSBzaG91bGQgYmUgY2FyZWZ1bC4gKi8KICAgICBpZiAoIHVubGlrZWx5KFJNQVBfVVNFU19I
QVNIVEFCKHBhZ2UpKSApCi0gICAgICAgIGZyZWVfeGVuaGVhcF9wYWdlcyhwYWdlLT5zaGFyaW5n
LT5oYXNoX3RhYmxlLmJ1Y2tldCwgCisgICAgICAgIGZyZWVfeGVuaGVhcF9wYWdlcyhwYWdlLT5z
aGFyaW5nLT5oYXNoX3RhYmxlLmJ1Y2tldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBS
TUFQX0hBU0hUQUJfT1JERVIpOwogCiAgICAgc3Bpbl9sb2NrKCZzaHJfYXVkaXRfbG9jayk7CkBA
IC0xMDUsNyArMTA3LDcgQEAgc3RhdGljIGlubGluZSB2b2lkIHBhZ2Vfc2hhcmluZ19kaXNwb3Nl
KHN0cnVjdCBwYWdlX2luZm8gKnBhZ2UpCiB7CiAgICAgLyogVW5saWtlbHkgZ2l2ZW4gb3VyIHRo
cmVzaG9sZHMsIGJ1dCB3ZSBzaG91bGQgYmUgY2FyZWZ1bC4gKi8KICAgICBpZiAoIHVubGlrZWx5
KFJNQVBfVVNFU19IQVNIVEFCKHBhZ2UpKSApCi0gICAgICAgIGZyZWVfeGVuaGVhcF9wYWdlcyhw
YWdlLT5zaGFyaW5nLT5oYXNoX3RhYmxlLmJ1Y2tldCwgCisgICAgICAgIGZyZWVfeGVuaGVhcF9w
YWdlcyhwYWdlLT5zaGFyaW5nLT5oYXNoX3RhYmxlLmJ1Y2tldCwKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBSTUFQX0hBU0hUQUJfT1JERVIpOwogICAgIHhmcmVlKHBhZ2UtPnNoYXJpbmcp
OwogfQpAQCAtMTIyLDggKzEyNCw4IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBwYWdlX3NoYXJpbmdf
ZGlzcG9zZShzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlKQogICogTmVzdGluZyBtYXkgaGFwcGVuIHdo
ZW4gc2hhcmluZyAoYW5kIGxvY2tpbmcpIHR3byBwYWdlcy4KICAqIERlYWRsb2NrIGlzIGF2b2lk
ZWQgYnkgbG9ja2luZyBwYWdlcyBpbiBpbmNyZWFzaW5nIG9yZGVyLgogICogQWxsIG1lbW9yeSBz
aGFyaW5nIGNvZGUgcGF0aHMgdGFrZSB0aGUgcDJtIGxvY2sgb2YgdGhlIGFmZmVjdGVkIGdmbiBi
ZWZvcmUKLSAqIHRha2luZyB0aGUgbG9jayBmb3IgdGhlIHVuZGVybHlpbmcgcGFnZS4gV2UgZW5m
b3JjZSBvcmRlcmluZyBiZXR3ZWVuIHBhZ2VfbG9jawotICogYW5kIHAybV9sb2NrIHVzaW5nIGFu
IG1tLWxvY2tzLmggY29uc3RydWN0LgorICogdGFraW5nIHRoZSBsb2NrIGZvciB0aGUgdW5kZXJs
eWluZyBwYWdlLiBXZSBlbmZvcmNlIG9yZGVyaW5nIGJldHdlZW4KKyAqIHBhZ2VfbG9jayBhbmQg
cDJtX2xvY2sgdXNpbmcgYW4gbW0tbG9ja3MuaCBjb25zdHJ1Y3QuCiAgKgogICogVE9ETzogSW52
ZXN0aWdhdGUgaWYgUEdUX3ZhbGlkYXRlZCBpcyBuZWNlc3NhcnkuCiAgKi8KQEAgLTE2OCw3ICsx
NzAsNyBAQCBzdGF0aWMgaW5saW5lIGJvb2wgbWVtX3NoYXJpbmdfcGFnZV9sb2NrKHN0cnVjdCBw
YWdlX2luZm8gKnBnKQogICAgIGlmICggcmMgKQogICAgIHsKICAgICAgICAgcHJlZW1wdF9kaXNh
YmxlKCk7Ci0gICAgICAgIHBhZ2Vfc2hhcmluZ19tbV9wb3N0X2xvY2soJnBsZC0+bW1fdW5sb2Nr
X2xldmVsLCAKKyAgICAgICAgcGFnZV9zaGFyaW5nX21tX3Bvc3RfbG9jaygmcGxkLT5tbV91bmxv
Y2tfbGV2ZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJnBsZC0+cmVjdXJz
ZV9jb3VudCk7CiAgICAgfQogICAgIHJldHVybiByYzsKQEAgLTE3OCw3ICsxODAsNyBAQCBzdGF0
aWMgaW5saW5lIHZvaWQgbWVtX3NoYXJpbmdfcGFnZV91bmxvY2soc3RydWN0IHBhZ2VfaW5mbyAq
cGcpCiB7CiAgICAgcGdfbG9ja19kYXRhX3QgKnBsZCA9ICYodGhpc19jcHUoX19wbGQpKTsKIAot
ICAgIHBhZ2Vfc2hhcmluZ19tbV91bmxvY2socGxkLT5tbV91bmxvY2tfbGV2ZWwsIAorICAgIHBh
Z2Vfc2hhcmluZ19tbV91bmxvY2socGxkLT5tbV91bmxvY2tfbGV2ZWwsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAmcGxkLT5yZWN1cnNlX2NvdW50KTsKICAgICBwcmVlbXB0X2VuYWJsZSgp
OwogICAgIF9wYWdlX3VubG9jayhwZyk7CkBAIC0xODYsNyArMTg4LDcgQEAgc3RhdGljIGlubGlu
ZSB2b2lkIG1lbV9zaGFyaW5nX3BhZ2VfdW5sb2NrKHN0cnVjdCBwYWdlX2luZm8gKnBnKQogCiBz
dGF0aWMgaW5saW5lIHNocl9oYW5kbGVfdCBnZXRfbmV4dF9oYW5kbGUodm9pZCkKIHsKLSAgICAv
KiBHZXQgdGhlIG5leHQgaGFuZGxlIGdldF9wYWdlIHN0eWxlICovIAorICAgIC8qIEdldCB0aGUg
bmV4dCBoYW5kbGUgZ2V0X3BhZ2Ugc3R5bGUgKi8KICAgICB1aW50NjRfdCB4LCB5ID0gbmV4dF9o
YW5kbGU7CiAgICAgZG8gewogICAgICAgICB4ID0geTsKQEAgLTE5OCwyNCArMjAwLDI2IEBAIHN0
YXRpYyBpbmxpbmUgc2hyX2hhbmRsZV90IGdldF9uZXh0X2hhbmRsZSh2b2lkKQogI2RlZmluZSBt
ZW1fc2hhcmluZ19lbmFibGVkKGQpIFwKICAgICAoaXNfaHZtX2RvbWFpbihkKSAmJiAoZCktPmFy
Y2guaHZtLm1lbV9zaGFyaW5nX2VuYWJsZWQpCiAKLXN0YXRpYyBhdG9taWNfdCBucl9zYXZlZF9t
Zm5zICAgPSBBVE9NSUNfSU5JVCgwKTsgCitzdGF0aWMgYXRvbWljX3QgbnJfc2F2ZWRfbWZucyAg
ID0gQVRPTUlDX0lOSVQoMCk7CiBzdGF0aWMgYXRvbWljX3QgbnJfc2hhcmVkX21mbnMgID0gQVRP
TUlDX0lOSVQoMCk7CiAKLS8qKiBSZXZlcnNlIG1hcCAqKi8KLS8qIEV2ZXJ5IHNoYXJlZCBmcmFt
ZSBrZWVwcyBhIHJldmVyc2UgbWFwIChybWFwKSBvZiA8ZG9tYWluLCBnZm4+IHR1cGxlcyB0aGF0
CisvKgorICogUmV2ZXJzZSBtYXAKKyAqCisgKiBFdmVyeSBzaGFyZWQgZnJhbWUga2VlcHMgYSBy
ZXZlcnNlIG1hcCAocm1hcCkgb2YgPGRvbWFpbiwgZ2ZuPiB0dXBsZXMgdGhhdAogICogdGhpcyBz
aGFyZWQgZnJhbWUgYmFja3MuIEZvciBwYWdlcyB3aXRoIGEgbG93IGRlZ3JlZSBvZiBzaGFyaW5n
LCBhIE8obikKICAqIHNlYXJjaCBsaW5rZWQgbGlzdCBpcyBnb29kIGVub3VnaC4gRm9yIHBhZ2Vz
IHdpdGggaGlnaGVyIGRlZ3JlZSBvZiBzaGFyaW5nLAotICogd2UgdXNlIGEgaGFzaCB0YWJsZSBp
bnN0ZWFkLiAqLworICogd2UgdXNlIGEgaGFzaCB0YWJsZSBpbnN0ZWFkLgorICovCiAKIHR5cGVk
ZWYgc3RydWN0IGdmbl9pbmZvCiB7CiAgICAgdW5zaWduZWQgbG9uZyBnZm47Ci0gICAgZG9taWRf
dCBkb21haW47IAorICAgIGRvbWlkX3QgZG9tYWluOwogICAgIHN0cnVjdCBsaXN0X2hlYWQgbGlz
dDsKIH0gZ2ZuX2luZm9fdDsKIAotc3RhdGljIGlubGluZSB2b2lkCi1ybWFwX2luaXQoc3RydWN0
IHBhZ2VfaW5mbyAqcGFnZSkKK3N0YXRpYyBpbmxpbmUgdm9pZCBybWFwX2luaXQoc3RydWN0IHBh
Z2VfaW5mbyAqcGFnZSkKIHsKICAgICAvKiBXZSBhbHdheXMgc3RhcnQgb2ZmIGFzIGEgZG91Ymx5
IGxpbmtlZCBsaXN0LiAqLwogICAgIElOSVRfTElTVF9IRUFEKCZwYWdlLT5zaGFyaW5nLT5nZm5z
KTsKQEAgLTIyNSwxMCArMjI5LDExIEBAIHJtYXBfaW5pdChzdHJ1Y3QgcGFnZV9pbmZvICpwYWdl
KQogI2RlZmluZSBIQVNIKGRvbWFpbiwgZ2ZuKSAgICAgICBcCiAgICAgKCgoZ2ZuKSArIChkb21h
aW4pKSAlIFJNQVBfSEFTSFRBQl9TSVpFKQogCi0vKiBDb252ZXJzaW9ucy4gVHVuZWQgYnkgdGhl
IHRocmVzaG9sZHMuIFNob3VsZCBvbmx5IGhhcHBlbiB0d2ljZSAKLSAqIChvbmNlIGVhY2gpIGR1
cmluZyB0aGUgbGlmZXRpbWUgb2YgYSBzaGFyZWQgcGFnZSAqLwotc3RhdGljIGlubGluZSBpbnQK
LXJtYXBfbGlzdF90b19oYXNoX3RhYmxlKHN0cnVjdCBwYWdlX2luZm8gKnBhZ2UpCisvKgorICog
Q29udmVyc2lvbnMuIFR1bmVkIGJ5IHRoZSB0aHJlc2hvbGRzLiBTaG91bGQgb25seSBoYXBwZW4g
dHdpY2UKKyAqIChvbmNlIGVhY2gpIGR1cmluZyB0aGUgbGlmZXRpbWUgb2YgYSBzaGFyZWQgcGFn
ZS4KKyAqLworc3RhdGljIGlubGluZSBpbnQgcm1hcF9saXN0X3RvX2hhc2hfdGFibGUoc3RydWN0
IHBhZ2VfaW5mbyAqcGFnZSkKIHsKICAgICB1bnNpZ25lZCBpbnQgaTsKICAgICBzdHJ1Y3QgbGlz
dF9oZWFkICpwb3MsICp0bXAsICpiID0KQEAgLTI1NCw4ICsyNTksNyBAQCBybWFwX2xpc3RfdG9f
aGFzaF90YWJsZShzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlKQogICAgIHJldHVybiAwOwogfQogCi1z
dGF0aWMgaW5saW5lIHZvaWQKLXJtYXBfaGFzaF90YWJsZV90b19saXN0KHN0cnVjdCBwYWdlX2lu
Zm8gKnBhZ2UpCitzdGF0aWMgaW5saW5lIHZvaWQgcm1hcF9oYXNoX3RhYmxlX3RvX2xpc3Qoc3Ry
dWN0IHBhZ2VfaW5mbyAqcGFnZSkKIHsKICAgICB1bnNpZ25lZCBpbnQgaTsKICAgICBzdHJ1Y3Qg
bGlzdF9oZWFkICpidWNrZXQgPSBwYWdlLT5zaGFyaW5nLT5oYXNoX3RhYmxlLmJ1Y2tldDsKQEAg
LTI3Niw4ICsyODAsNyBAQCBybWFwX2hhc2hfdGFibGVfdG9fbGlzdChzdHJ1Y3QgcGFnZV9pbmZv
ICpwYWdlKQogfQogCiAvKiBHZW5lcmljIGFjY2Vzc29ycyB0byB0aGUgcm1hcCAqLwotc3RhdGlj
IGlubGluZSB1bnNpZ25lZCBsb25nCi1ybWFwX2NvdW50KHN0cnVjdCBwYWdlX2luZm8gKnBnKQor
c3RhdGljIGlubGluZSB1bnNpZ25lZCBsb25nIHJtYXBfY291bnQoc3RydWN0IHBhZ2VfaW5mbyAq
cGcpCiB7CiAgICAgdW5zaWduZWQgbG9uZyBjb3VudDsKICAgICB1bnNpZ25lZCBsb25nIHQgPSBy
ZWFkX2F0b21pYygmcGctPnUuaW51c2UudHlwZV9pbmZvKTsKQEAgLTI4NywxMSArMjkwLDEzIEBA
IHJtYXBfY291bnQoc3RydWN0IHBhZ2VfaW5mbyAqcGcpCiAgICAgcmV0dXJuIGNvdW50OwogfQog
Ci0vKiBUaGUgcGFnZSB0eXBlIGNvdW50IGlzIGFsd2F5cyBkZWNyZWFzZWQgYWZ0ZXIgcmVtb3Zp
bmcgZnJvbSB0aGUgcm1hcC4KLSAqIFVzZSBhIGNvbnZlcnQgZmxhZyB0byBhdm9pZCBtdXRhdGlu
ZyB0aGUgcm1hcCBpZiBpbiB0aGUgbWlkZGxlIG9mIGFuIAotICogaXRlcmF0b3IsIG9yIGlmIHRo
ZSBwYWdlIHdpbGwgYmUgc29vbiBkZXN0cm95ZWQgYW55d2F5cy4gKi8KLXN0YXRpYyBpbmxpbmUg
dm9pZAotcm1hcF9kZWwoZ2ZuX2luZm9fdCAqZ2ZuX2luZm8sIHN0cnVjdCBwYWdlX2luZm8gKnBh
Z2UsIGludCBjb252ZXJ0KQorLyoKKyAqIFRoZSBwYWdlIHR5cGUgY291bnQgaXMgYWx3YXlzIGRl
Y3JlYXNlZCBhZnRlciByZW1vdmluZyBmcm9tIHRoZSBybWFwLgorICogVXNlIGEgY29udmVydCBm
bGFnIHRvIGF2b2lkIG11dGF0aW5nIHRoZSBybWFwIGlmIGluIHRoZSBtaWRkbGUgb2YgYW4KKyAq
IGl0ZXJhdG9yLCBvciBpZiB0aGUgcGFnZSB3aWxsIGJlIHNvb24gZGVzdHJveWVkIGFueXdheXMu
CisgKi8KK3N0YXRpYyBpbmxpbmUKK3ZvaWQgcm1hcF9kZWwoZ2ZuX2luZm9fdCAqZ2ZuX2luZm8s
IHN0cnVjdCBwYWdlX2luZm8gKnBhZ2UsIGludCBjb252ZXJ0KQogewogICAgIGlmICggUk1BUF9V
U0VTX0hBU0hUQUIocGFnZSkgJiYgY29udmVydCAmJgogICAgICAgICAgKHJtYXBfY291bnQocGFn
ZSkgPD0gUk1BUF9MSUdIVF9TSEFSRURfUEFHRSkgKQpAQCAtMzAyLDggKzMwNyw3IEBAIHJtYXBf
ZGVsKGdmbl9pbmZvX3QgKmdmbl9pbmZvLCBzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlLCBpbnQgY29u
dmVydCkKIH0KIAogLyogVGhlIHBhZ2UgdHlwZSBjb3VudCBpcyBhbHdheXMgaW5jcmVhc2VkIGJl
Zm9yZSBhZGRpbmcgdG8gdGhlIHJtYXAuICovCi1zdGF0aWMgaW5saW5lIHZvaWQKLXJtYXBfYWRk
KGdmbl9pbmZvX3QgKmdmbl9pbmZvLCBzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlKQorc3RhdGljIGlu
bGluZSB2b2lkIHJtYXBfYWRkKGdmbl9pbmZvX3QgKmdmbl9pbmZvLCBzdHJ1Y3QgcGFnZV9pbmZv
ICpwYWdlKQogewogICAgIHN0cnVjdCBsaXN0X2hlYWQgKmhlYWQ7CiAKQEAgLTMxNCw3ICszMTgs
NyBAQCBybWFwX2FkZChnZm5faW5mb190ICpnZm5faW5mbywgc3RydWN0IHBhZ2VfaW5mbyAqcGFn
ZSkKICAgICAgICAgKHZvaWQpcm1hcF9saXN0X3RvX2hhc2hfdGFibGUocGFnZSk7CiAKICAgICBo
ZWFkID0gKFJNQVBfVVNFU19IQVNIVEFCKHBhZ2UpKSA/Ci0gICAgICAgIHBhZ2UtPnNoYXJpbmct
Pmhhc2hfdGFibGUuYnVja2V0ICsgCisgICAgICAgIHBhZ2UtPnNoYXJpbmctPmhhc2hfdGFibGUu
YnVja2V0ICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBIQVNIKGdmbl9pbmZvLT5kb21h
aW4sIGdmbl9pbmZvLT5nZm4pIDoKICAgICAgICAgJnBhZ2UtPnNoYXJpbmctPmdmbnM7CiAKQEAg
LTMyMiw5ICszMjYsOSBAQCBybWFwX2FkZChnZm5faW5mb190ICpnZm5faW5mbywgc3RydWN0IHBh
Z2VfaW5mbyAqcGFnZSkKICAgICBsaXN0X2FkZCgmZ2ZuX2luZm8tPmxpc3QsIGhlYWQpOwogfQog
Ci1zdGF0aWMgaW5saW5lIGdmbl9pbmZvX3QgKgotcm1hcF9yZXRyaWV2ZSh1aW50MTZfdCBkb21h
aW5faWQsIHVuc2lnbmVkIGxvbmcgZ2ZuLCAKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICBz
dHJ1Y3QgcGFnZV9pbmZvICpwYWdlKQorc3RhdGljIGlubGluZQorZ2ZuX2luZm9fdCAqcm1hcF9y
ZXRyaWV2ZSh1aW50MTZfdCBkb21haW5faWQsIHVuc2lnbmVkIGxvbmcgZ2ZuLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICBzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlKQogewogICAgIGdmbl9pbmZv
X3QgKmdmbl9pbmZvOwogICAgIHN0cnVjdCBsaXN0X2hlYWQgKmxlLCAqaGVhZDsKQEAgLTM2NCwx
OCArMzY4LDE4IEBAIHN0cnVjdCBybWFwX2l0ZXJhdG9yIHsKICAgICB1bnNpZ25lZCBpbnQgYnVj
a2V0OwogfTsKIAotc3RhdGljIGlubGluZSB2b2lkCi1ybWFwX3NlZWRfaXRlcmF0b3Ioc3RydWN0
IHBhZ2VfaW5mbyAqcGFnZSwgc3RydWN0IHJtYXBfaXRlcmF0b3IgKnJpKQorc3RhdGljIGlubGlu
ZQordm9pZCBybWFwX3NlZWRfaXRlcmF0b3Ioc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSwgc3RydWN0
IHJtYXBfaXRlcmF0b3IgKnJpKQogewogICAgIHJpLT5jdXJyID0gKFJNQVBfVVNFU19IQVNIVEFC
KHBhZ2UpKSA/CiAgICAgICAgICAgICAgICAgcGFnZS0+c2hhcmluZy0+aGFzaF90YWJsZS5idWNr
ZXQgOgogICAgICAgICAgICAgICAgICZwYWdlLT5zaGFyaW5nLT5nZm5zOwotICAgIHJpLT5uZXh0
ID0gcmktPmN1cnItPm5leHQ7IAorICAgIHJpLT5uZXh0ID0gcmktPmN1cnItPm5leHQ7CiAgICAg
cmktPmJ1Y2tldCA9IDA7CiB9CiAKLXN0YXRpYyBpbmxpbmUgZ2ZuX2luZm9fdCAqCi1ybWFwX2l0
ZXJhdGUoc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSwgc3RydWN0IHJtYXBfaXRlcmF0b3IgKnJpKQor
c3RhdGljIGlubGluZQorZ2ZuX2luZm9fdCAqcm1hcF9pdGVyYXRlKHN0cnVjdCBwYWdlX2luZm8g
KnBhZ2UsIHN0cnVjdCBybWFwX2l0ZXJhdG9yICpyaSkKIHsKICAgICBzdHJ1Y3QgbGlzdF9oZWFk
ICpoZWFkID0gKFJNQVBfVVNFU19IQVNIVEFCKHBhZ2UpKSA/CiAgICAgICAgICAgICAgICAgcGFn
ZS0+c2hhcmluZy0+aGFzaF90YWJsZS5idWNrZXQgKyByaS0+YnVja2V0IDoKQEAgLTQwNSwxNCAr
NDA5LDE0IEBAIHJldHJ5OgogICAgIHJldHVybiBsaXN0X2VudHJ5KHJpLT5jdXJyLCBnZm5faW5m
b190LCBsaXN0KTsKIH0KIAotc3RhdGljIGlubGluZSBnZm5faW5mb190ICptZW1fc2hhcmluZ19n
Zm5fYWxsb2Moc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSwKLSAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBkb21haW4gKmQsCi0gICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBsb25nIGdmbikKK3N0
YXRpYyBpbmxpbmUKK2dmbl9pbmZvX3QgKm1lbV9zaGFyaW5nX2dmbl9hbGxvYyhzdHJ1Y3QgcGFn
ZV9pbmZvICpwYWdlLCBzdHJ1Y3QgZG9tYWluICpkLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHVuc2lnbmVkIGxvbmcgZ2ZuKQogewogICAgIGdmbl9pbmZvX3QgKmdmbl9pbmZv
ID0geG1hbGxvYyhnZm5faW5mb190KTsKIAogICAgIGlmICggZ2ZuX2luZm8gPT0gTlVMTCApCi0g
ICAgICAgIHJldHVybiBOVUxMOyAKKyAgICAgICAgcmV0dXJuIE5VTEw7CiAKICAgICBnZm5faW5m
by0+Z2ZuID0gZ2ZuOwogICAgIGdmbl9pbmZvLT5kb21haW4gPSBkLT5kb21haW5faWQ7CkBAIC00
MjUsOSArNDI5LDkgQEAgc3RhdGljIGlubGluZSBnZm5faW5mb190ICptZW1fc2hhcmluZ19nZm5f
YWxsb2Moc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSwKICAgICByZXR1cm4gZ2ZuX2luZm87CiB9CiAK
LXN0YXRpYyBpbmxpbmUgdm9pZCBtZW1fc2hhcmluZ19nZm5fZGVzdHJveShzdHJ1Y3QgcGFnZV9p
bmZvICpwYWdlLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0
cnVjdCBkb21haW4gKmQsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgZ2ZuX2luZm9fdCAqZ2ZuX2luZm8pCitzdGF0aWMgaW5saW5lCit2b2lkIG1lbV9zaGFyaW5n
X2dmbl9kZXN0cm95KHN0cnVjdCBwYWdlX2luZm8gKnBhZ2UsIHN0cnVjdCBkb21haW4gKmQsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdmbl9pbmZvX3QgKmdmbl9pbmZvKQogewogICAg
IC8qIERlY3JlbWVudCB0aGUgbnVtYmVyIG9mIHBhZ2VzLiAqLwogICAgIGF0b21pY19kZWMoJmQt
PnNocl9wYWdlcyk7CkBAIC00MzcsMjUgKzQ0MSwyOSBAQCBzdGF0aWMgaW5saW5lIHZvaWQgbWVt
X3NoYXJpbmdfZ2ZuX2Rlc3Ryb3koc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSwKICAgICB4ZnJlZShn
Zm5faW5mbyk7CiB9CiAKLXN0YXRpYyBzdHJ1Y3QgcGFnZV9pbmZvKiBtZW1fc2hhcmluZ19sb29r
dXAodW5zaWduZWQgbG9uZyBtZm4pCitzdGF0aWMgaW5saW5lIHN0cnVjdCBwYWdlX2luZm8qIG1l
bV9zaGFyaW5nX2xvb2t1cCh1bnNpZ25lZCBsb25nIG1mbikKIHsKLSAgICBpZiAoIG1mbl92YWxp
ZChfbWZuKG1mbikpICkKLSAgICB7Ci0gICAgICAgIHN0cnVjdCBwYWdlX2luZm8qIHBhZ2UgPSBt
Zm5fdG9fcGFnZShfbWZuKG1mbikpOwotICAgICAgICBpZiAoIHBhZ2VfZ2V0X293bmVyKHBhZ2Up
ID09IGRvbV9jb3cgKQotICAgICAgICB7Ci0gICAgICAgICAgICAvKiBDb3VudCBoYXMgdG8gYmUg
YXQgbGVhc3QgdHdvLCBiZWNhdXNlIHdlJ3JlIGNhbGxlZAotICAgICAgICAgICAgICogd2l0aCB0
aGUgbWZuIGxvY2tlZCAoMSkgYW5kIHRoaXMgaXMgc3VwcG9zZWQgdG8gYmUgCi0gICAgICAgICAg
ICAgKiBhIHNoYXJlZCBwYWdlICgxKS4gKi8KLSAgICAgICAgICAgIHVuc2lnbmVkIGxvbmcgdCA9
IHJlYWRfYXRvbWljKCZwYWdlLT51LmludXNlLnR5cGVfaW5mbyk7Ci0gICAgICAgICAgICBBU1NF
UlQoKHQgJiBQR1RfdHlwZV9tYXNrKSA9PSBQR1Rfc2hhcmVkX3BhZ2UpOwotICAgICAgICAgICAg
QVNTRVJUKCh0ICYgUEdUX2NvdW50X21hc2spID49IDIpOwotICAgICAgICAgICAgQVNTRVJUKFNI
QVJFRF9NMlAoZ2V0X2dwZm5fZnJvbV9tZm4obWZuKSkpOwotICAgICAgICAgICAgcmV0dXJuIHBh
Z2U7Ci0gICAgICAgIH0KLSAgICB9CisgICAgc3RydWN0IHBhZ2VfaW5mbyogcGFnZTsKKyAgICB1
bnNpZ25lZCBsb25nIHQ7CiAKLSAgICByZXR1cm4gTlVMTDsKKyAgICBpZiAoICFtZm5fdmFsaWQo
X21mbihtZm4pKSApCisgICAgICAgIHJldHVybiBOVUxMOworCisgICAgcGFnZSA9IG1mbl90b19w
YWdlKF9tZm4obWZuKSk7CisgICAgaWYgKCBwYWdlX2dldF9vd25lcihwYWdlKSAhPSBkb21fY293
ICkKKyAgICAgICAgcmV0dXJuIE5VTEw7CisKKyAgICAvKgorICAgICAqIENvdW50IGhhcyB0byBi
ZSBhdCBsZWFzdCB0d28sIGJlY2F1c2Ugd2UncmUgY2FsbGVkCisgICAgICogd2l0aCB0aGUgbWZu
IGxvY2tlZCAoMSkgYW5kIHRoaXMgaXMgc3VwcG9zZWQgdG8gYmUKKyAgICAgKiBhIHNoYXJlZCBw
YWdlICgxKS4KKyAgICAgKi8KKyAgICB0ID0gcmVhZF9hdG9taWMoJnBhZ2UtPnUuaW51c2UudHlw
ZV9pbmZvKTsKKyAgICBBU1NFUlQoKHQgJiBQR1RfdHlwZV9tYXNrKSA9PSBQR1Rfc2hhcmVkX3Bh
Z2UpOworICAgIEFTU0VSVCgodCAmIFBHVF9jb3VudF9tYXNrKSA+PSAyKTsKKyAgICBBU1NFUlQo
U0hBUkVEX00yUChnZXRfZ3Bmbl9mcm9tX21mbihtZm4pKSk7CisKKyAgICByZXR1cm4gcGFnZTsK
IH0KIAogc3RhdGljIGludCBhdWRpdCh2b2lkKQpAQCAtNDkyLDcgKzUwMCw3IEBAIHN0YXRpYyBp
bnQgYXVkaXQodm9pZCkKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgIH0KIAotICAgICAg
ICAvKiBDaGVjayBpZiB0aGUgTUZOIGhhcyBjb3JyZWN0IHR5cGUsIG93bmVyIGFuZCBoYW5kbGUu
ICovIAorICAgICAgICAvKiBDaGVjayBpZiB0aGUgTUZOIGhhcyBjb3JyZWN0IHR5cGUsIG93bmVy
IGFuZCBoYW5kbGUuICovCiAgICAgICAgIGlmICggKHBnLT51LmludXNlLnR5cGVfaW5mbyAmIFBH
VF90eXBlX21hc2spICE9IFBHVF9zaGFyZWRfcGFnZSApCiAgICAgICAgIHsKICAgICAgICAgICAg
TUVNX1NIQVJJTkdfREVCVUcoIm1mbiAlbHggaW4gYXVkaXQgbGlzdCwgYnV0IG5vdCBQR1Rfc2hh
cmVkX3BhZ2UgKCVseCkhXG4iLApAQCAtNTQ1LDcgKzU1Myw3IEBAIHN0YXRpYyBpbnQgYXVkaXQo
dm9pZCkKICAgICAgICAgICAgICAgICBlcnJvcnMrKzsKICAgICAgICAgICAgICAgICBjb250aW51
ZTsKICAgICAgICAgICAgIH0KLSAgICAgICAgICAgIG9fbWZuID0gZ2V0X2dmbl9xdWVyeV91bmxv
Y2tlZChkLCBnLT5nZm4sICZ0KTsgCisgICAgICAgICAgICBvX21mbiA9IGdldF9nZm5fcXVlcnlf
dW5sb2NrZWQoZCwgZy0+Z2ZuLCAmdCk7CiAgICAgICAgICAgICBpZiAoICFtZm5fZXEob19tZm4s
IG1mbikgKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIE1FTV9TSEFSSU5HX0RFQlVH
KCJJbmNvcnJlY3QgUDJNIGZvciBkPSVodSwgUEZOPSVseC4iCkBAIC01NjgsNyArNTc2LDcgQEAg
c3RhdGljIGludCBhdWRpdCh2b2lkKQogICAgICAgICB7CiAgICAgICAgICAgICBNRU1fU0hBUklO
R19ERUJVRygiTWlzbWF0Y2hlZCBjb3VudHMgZm9yIE1GTj0lbHguIgogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIm5yX2dmbnMgaW4gbGlzdCAlbHUsIGluIHR5cGVfaW5mbyAlbHhcbiIs
Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZm5feChtZm4pLCBucl9nZm5zLCAKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1mbl94KG1mbiksIG5yX2dmbnMsCiAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAocGctPnUuaW51c2UudHlwZV9pbmZvICYgUEdUX2NvdW50
X21hc2spKTsKICAgICAgICAgICAgIGVycm9ycysrOwogICAgICAgICB9CkBAIC02MDMsNyArNjEx
LDcgQEAgaW50IG1lbV9zaGFyaW5nX25vdGlmeV9lbm9tZW0oc3RydWN0IGRvbWFpbiAqZCwgdW5z
aWduZWQgbG9uZyBnZm4sCiAgICAgICAgIC51Lm1lbV9zaGFyaW5nLnAybXQgPSBwMm1fcmFtX3No
YXJlZAogICAgIH07CiAKLSAgICBpZiAoIChyYyA9IF9fdm1fZXZlbnRfY2xhaW1fc2xvdChkLCAK
KyAgICBpZiAoIChyYyA9IF9fdm1fZXZlbnRfY2xhaW1fc2xvdChkLAogICAgICAgICAgICAgICAg
ICAgICAgICAgZC0+dm1fZXZlbnRfc2hhcmUsIGFsbG93X3NsZWVwKSkgPCAwICkKICAgICAgICAg
cmV0dXJuIHJjOwogCkBAIC02MjksOSArNjM3LDkgQEAgdW5zaWduZWQgaW50IG1lbV9zaGFyaW5n
X2dldF9ucl9zaGFyZWRfbWZucyh2b2lkKQogfQogCiAvKiBGdW5jdGlvbnMgdGhhdCBjaGFuZ2Ug
YSBwYWdlJ3MgdHlwZSBhbmQgb3duZXJzaGlwICovCi1zdGF0aWMgaW50IHBhZ2VfbWFrZV9zaGFy
YWJsZShzdHJ1Y3QgZG9tYWluICpkLCAKLSAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHBh
Z2VfaW5mbyAqcGFnZSwgCi0gICAgICAgICAgICAgICAgICAgICAgIGludCBleHBlY3RlZF9yZWZj
bnQpCitzdGF0aWMgaW50IHBhZ2VfbWFrZV9zaGFyYWJsZShzdHJ1Y3QgZG9tYWluICpkLAorICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIGludCBleHBlY3RlZF9yZWZjbnQpCiB7CiAgICAgYm9v
bF90IGRyb3BfZG9tX3JlZjsKIApAQCAtNjU4LDggKzY2NiwxMCBAQCBzdGF0aWMgaW50IHBhZ2Vf
bWFrZV9zaGFyYWJsZShzdHJ1Y3QgZG9tYWluICpkLAogICAgICAgICByZXR1cm4gLUVFWElTVDsK
ICAgICB9CiAKLSAgICAvKiBDaGVjayBpZiB0aGUgcmVmIGNvdW50IGlzIDIuIFRoZSBmaXJzdCBm
cm9tIFBHQ19hbGxvY2F0ZWQsIGFuZAotICAgICAqIHRoZSBzZWNvbmQgZnJvbSBnZXRfcGFnZV9h
bmRfdHlwZSBhdCB0aGUgdG9wIG9mIHRoaXMgZnVuY3Rpb24gKi8KKyAgICAvKgorICAgICAqIENo
ZWNrIGlmIHRoZSByZWYgY291bnQgaXMgMi4gVGhlIGZpcnN0IGZyb20gUEdDX2FsbG9jYXRlZCwg
YW5kCisgICAgICogdGhlIHNlY29uZCBmcm9tIGdldF9wYWdlX2FuZF90eXBlIGF0IHRoZSB0b3Ag
b2YgdGhpcyBmdW5jdGlvbi4KKyAgICAgKi8KICAgICBpZiAoIHBhZ2UtPmNvdW50X2luZm8gIT0g
KFBHQ19hbGxvY2F0ZWQgfCAoMiArIGV4cGVjdGVkX3JlZmNudCkpICkKICAgICB7CiAgICAgICAg
IHNwaW5fdW5sb2NrKCZkLT5wYWdlX2FsbG9jX2xvY2spOwpAQCAtNjc1LDYgKzY4NSw3IEBAIHN0
YXRpYyBpbnQgcGFnZV9tYWtlX3NoYXJhYmxlKHN0cnVjdCBkb21haW4gKmQsCiAKICAgICBpZiAo
IGRyb3BfZG9tX3JlZiApCiAgICAgICAgIHB1dF9kb21haW4oZCk7CisKICAgICByZXR1cm4gMDsK
IH0KIApAQCAtNjg0LDcgKzY5NSw3IEBAIHN0YXRpYyBpbnQgcGFnZV9tYWtlX3ByaXZhdGUoc3Ry
dWN0IGRvbWFpbiAqZCwgc3RydWN0IHBhZ2VfaW5mbyAqcGFnZSkKIAogICAgIGlmICggIWdldF9w
YWdlKHBhZ2UsIGRvbV9jb3cpICkKICAgICAgICAgcmV0dXJuIC1FSU5WQUw7Ci0gICAgCisKICAg
ICBzcGluX2xvY2soJmQtPnBhZ2VfYWxsb2NfbG9jayk7CiAKICAgICBpZiAoIGQtPmlzX2R5aW5n
ICkKQEAgLTcyNywxMCArNzM4LDEzIEBAIHN0YXRpYyBpbmxpbmUgc3RydWN0IHBhZ2VfaW5mbyAq
X19ncmFiX3NoYXJlZF9wYWdlKG1mbl90IG1mbikKIAogICAgIGlmICggIW1mbl92YWxpZChtZm4p
ICkKICAgICAgICAgcmV0dXJuIE5VTEw7CisKICAgICBwZyA9IG1mbl90b19wYWdlKG1mbik7CiAK
LSAgICAvKiBJZiB0aGUgcGFnZSBpcyBub3QgdmFsaWRhdGVkIHdlIGNhbid0IGxvY2sgaXQsIGFu
ZCBpZiBpdCdzICAKLSAgICAgKiBub3QgdmFsaWRhdGVkIGl0J3Mgb2J2aW91c2x5IG5vdCBzaGFy
ZWQuICovCisgICAgLyoKKyAgICAgKiBJZiB0aGUgcGFnZSBpcyBub3QgdmFsaWRhdGVkIHdlIGNh
bid0IGxvY2sgaXQsIGFuZCBpZiBpdCdzCisgICAgICogbm90IHZhbGlkYXRlZCBpdCdzIG9idmlv
dXNseSBub3Qgc2hhcmVkLgorICAgICAqLwogICAgIGlmICggIW1lbV9zaGFyaW5nX3BhZ2VfbG9j
ayhwZykgKQogICAgICAgICByZXR1cm4gTlVMTDsKIApAQCAtNzU0LDEwICs3NjgsMTAgQEAgc3Rh
dGljIGludCBkZWJ1Z19tZm4obWZuX3QgbWZuKQogICAgICAgICByZXR1cm4gLUVJTlZBTDsKICAg
ICB9CiAKLSAgICBNRU1fU0hBUklOR19ERUJVRyggCisgICAgTUVNX1NIQVJJTkdfREVCVUcoCiAg
ICAgICAgICAgICAiRGVidWcgcGFnZTogTUZOPSVseCBpcyBjaT0lbHgsIHRpPSVseCwgb3duZXJf
aWQ9JWRcbiIsCi0gICAgICAgICAgICBtZm5feChwYWdlX3RvX21mbihwYWdlKSksIAotICAgICAg
ICAgICAgcGFnZS0+Y291bnRfaW5mbywgCisgICAgICAgICAgICBtZm5feChwYWdlX3RvX21mbihw
YWdlKSksCisgICAgICAgICAgICBwYWdlLT5jb3VudF9pbmZvLAogICAgICAgICAgICAgcGFnZS0+
dS5pbnVzZS50eXBlX2luZm8sCiAgICAgICAgICAgICBwYWdlX2dldF9vd25lcihwYWdlKS0+ZG9t
YWluX2lkKTsKIApAQCAtNzc1LDcgKzc4OSw3IEBAIHN0YXRpYyBpbnQgZGVidWdfZ2ZuKHN0cnVj
dCBkb21haW4gKmQsIGdmbl90IGdmbikKIAogICAgIG1mbiA9IGdldF9nZm5fcXVlcnkoZCwgZ2Zu
X3goZ2ZuKSwgJnAybXQpOwogCi0gICAgTUVNX1NIQVJJTkdfREVCVUcoIkRlYnVnIGZvciBkb20l
ZCwgZ2ZuPSUiIFBSSV9nZm4gIlxuIiwgCisgICAgTUVNX1NIQVJJTkdfREVCVUcoIkRlYnVnIGZv
ciBkb20lZCwgZ2ZuPSUiIFBSSV9nZm4gIlxuIiwKICAgICAgICAgICAgICAgICAgICAgICBkLT5k
b21haW5faWQsIGdmbl94KGdmbikpOwogICAgIG51bV9yZWZzID0gZGVidWdfbWZuKG1mbik7CiAg
ICAgcHV0X2dmbihkLCBnZm5feChnZm4pKTsKQEAgLTc5Niw5ICs4MTAsOSBAQCBzdGF0aWMgaW50
IGRlYnVnX2dyZWYoc3RydWN0IGRvbWFpbiAqZCwgZ3JhbnRfcmVmX3QgcmVmKQogICAgICAgICAg
ICAgICAgICAgICAgICAgICBkLT5kb21haW5faWQsIHJlZiwgcmMpOwogICAgICAgICByZXR1cm4g
cmM7CiAgICAgfQotICAgIAorCiAgICAgTUVNX1NIQVJJTkdfREVCVUcoCi0gICAgICAgICAgICAi
PT0+IEdyYW50IFtkb209JWQscmVmPSVkXSwgc3RhdHVzPSV4LiAiLCAKKyAgICAgICAgICAgICI9
PT4gR3JhbnQgW2RvbT0lZCxyZWY9JWRdLCBzdGF0dXM9JXguICIsCiAgICAgICAgICAgICBkLT5k
b21haW5faWQsIHJlZiwgc3RhdHVzKTsKIAogICAgIHJldHVybiBkZWJ1Z19nZm4oZCwgZ2ZuKTsK
QEAgLTgyNCwxNSArODM4LDEyIEBAIHN0YXRpYyBpbnQgbm9taW5hdGVfcGFnZShzdHJ1Y3QgZG9t
YWluICpkLCBnZm5fdCBnZm4sCiAgICAgICAgIGdvdG8gb3V0OwogCiAgICAgLyogUmV0dXJuIHRo
ZSBoYW5kbGUgaWYgdGhlIHBhZ2UgaXMgYWxyZWFkeSBzaGFyZWQgKi8KLSAgICBpZiAoIHAybV9p
c19zaGFyZWQocDJtdCkgKSB7CisgICAgaWYgKCBwMm1faXNfc2hhcmVkKHAybXQpICkKKyAgICB7
CiAgICAgICAgIHN0cnVjdCBwYWdlX2luZm8gKnBnID0gX19ncmFiX3NoYXJlZF9wYWdlKG1mbik7
CiAgICAgICAgIGlmICggIXBnICkKLSAgICAgICAgewotICAgICAgICAgICAgZ3ByaW50ayhYRU5M
T0dfRVJSLAotICAgICAgICAgICAgICAgICAgICAiU2hhcmVkIHAybSBlbnRyeSBnZm4gJSIgUFJJ
X2dmbiAiLCBidXQgY291bGQgbm90IGdyYWIgbWZuICUiIFBSSV9tZm4gIiBkb20lZFxuIiwKLSAg
ICAgICAgICAgICAgICAgICAgZ2ZuX3goZ2ZuKSwgbWZuX3gobWZuKSwgZC0+ZG9tYWluX2lkKTsK
ICAgICAgICAgICAgIEJVRygpOwotICAgICAgICB9CisKICAgICAgICAgKnBoYW5kbGUgPSBwZy0+
c2hhcmluZy0+aGFuZGxlOwogICAgICAgICByZXQgPSAwOwogICAgICAgICBtZW1fc2hhcmluZ19w
YWdlX3VubG9jayhwZyk7CkBAIC04NDMsNyArODU0LDYgQEAgc3RhdGljIGludCBub21pbmF0ZV9w
YWdlKHN0cnVjdCBkb21haW4gKmQsIGdmbl90IGdmbiwKICAgICBpZiAoICFwMm1faXNfc2hhcmFi
bGUocDJtdCkgKQogICAgICAgICBnb3RvIG91dDsKIAotI2lmZGVmIENPTkZJR19IVk0KICAgICAv
KiBDaGVjayBpZiB0aGVyZSBhcmUgbWVtX2FjY2Vzcy9yZW1hcHBlZCBhbHRwMm0gZW50cmllcyBm
b3IgdGhpcyBwYWdlICovCiAgICAgaWYgKCBhbHRwMm1fYWN0aXZlKGQpICkKICAgICB7CkBAIC04
NzIsNDIgKzg4Miw0MiBAQCBzdGF0aWMgaW50IG5vbWluYXRlX3BhZ2Uoc3RydWN0IGRvbWFpbiAq
ZCwgZ2ZuX3QgZ2ZuLAogCiAgICAgICAgIGFsdHAybV9saXN0X3VubG9jayhkKTsKICAgICB9Ci0j
ZW5kaWYKIAogICAgIC8qIFRyeSB0byBjb252ZXJ0IHRoZSBtZm4gdG8gdGhlIHNoYXJhYmxlIHR5
cGUgKi8KICAgICBwYWdlID0gbWZuX3RvX3BhZ2UobWZuKTsKLSAgICByZXQgPSBwYWdlX21ha2Vf
c2hhcmFibGUoZCwgcGFnZSwgZXhwZWN0ZWRfcmVmY250KTsgCi0gICAgaWYgKCByZXQgKSAKKyAg
ICByZXQgPSBwYWdlX21ha2Vfc2hhcmFibGUoZCwgcGFnZSwgZXhwZWN0ZWRfcmVmY250KTsKKyAg
ICBpZiAoIHJldCApCiAgICAgICAgIGdvdG8gb3V0OwogCi0gICAgLyogTm93IHRoYXQgdGhlIHBh
Z2UgaXMgdmFsaWRhdGVkLCB3ZSBjYW4gbG9jayBpdC4gVGhlcmUgaXMgbm8gCi0gICAgICogcmFj
ZSBiZWNhdXNlIHdlJ3JlIGhvbGRpbmcgdGhlIHAybSBlbnRyeSwgc28gbm8gb25lIGVsc2UgCi0g
ICAgICogY291bGQgYmUgbm9taW5hdGluZyB0aGlzIGdmbiAqLworICAgIC8qCisgICAgICogTm93
IHRoYXQgdGhlIHBhZ2UgaXMgdmFsaWRhdGVkLCB3ZSBjYW4gbG9jayBpdC4gVGhlcmUgaXMgbm8K
KyAgICAgKiByYWNlIGJlY2F1c2Ugd2UncmUgaG9sZGluZyB0aGUgcDJtIGVudHJ5LCBzbyBubyBv
bmUgZWxzZQorICAgICAqIGNvdWxkIGJlIG5vbWluYXRpbmcgdGhpcyBnZm4uCisgICAgICovCiAg
ICAgcmV0ID0gLUVOT0VOVDsKICAgICBpZiAoICFtZW1fc2hhcmluZ19wYWdlX2xvY2socGFnZSkg
KQogICAgICAgICBnb3RvIG91dDsKIAogICAgIC8qIEluaXRpYWxpemUgdGhlIHNoYXJlZCBzdGF0
ZSAqLwogICAgIHJldCA9IC1FTk9NRU07Ci0gICAgaWYgKCAocGFnZS0+c2hhcmluZyA9IAotICAg
ICAgICAgICAgeG1hbGxvYyhzdHJ1Y3QgcGFnZV9zaGFyaW5nX2luZm8pKSA9PSBOVUxMICkKKyAg
ICBpZiAoICEocGFnZS0+c2hhcmluZyA9IHhtYWxsb2Moc3RydWN0IHBhZ2Vfc2hhcmluZ19pbmZv
KSkgKQogICAgIHsKICAgICAgICAgLyogTWFraW5nIGEgcGFnZSBwcml2YXRlIGF0b21pY2FsbHkg
dW5sb2NrcyBpdCAqLwotICAgICAgICBCVUdfT04ocGFnZV9tYWtlX3ByaXZhdGUoZCwgcGFnZSkg
IT0gMCk7CisgICAgICAgIEJVR19PTihwYWdlX21ha2VfcHJpdmF0ZShkLCBwYWdlKSk7CiAgICAg
ICAgIGdvdG8gb3V0OwogICAgIH0KICAgICBwYWdlLT5zaGFyaW5nLT5wZyA9IHBhZ2U7CiAgICAg
cm1hcF9pbml0KHBhZ2UpOwogCiAgICAgLyogQ3JlYXRlIHRoZSBoYW5kbGUgKi8KLSAgICBwYWdl
LT5zaGFyaW5nLT5oYW5kbGUgPSBnZXRfbmV4dF9oYW5kbGUoKTsgIAorICAgIHBhZ2UtPnNoYXJp
bmctPmhhbmRsZSA9IGdldF9uZXh0X2hhbmRsZSgpOwogCiAgICAgLyogQ3JlYXRlIHRoZSBsb2Nh
bCBnZm4gaW5mbyAqLwotICAgIGlmICggbWVtX3NoYXJpbmdfZ2ZuX2FsbG9jKHBhZ2UsIGQsIGdm
bl94KGdmbikpID09IE5VTEwgKQorICAgIGlmICggIW1lbV9zaGFyaW5nX2dmbl9hbGxvYyhwYWdl
LCBkLCBnZm5feChnZm4pKSApCiAgICAgewogICAgICAgICB4ZnJlZShwYWdlLT5zaGFyaW5nKTsK
ICAgICAgICAgcGFnZS0+c2hhcmluZyA9IE5VTEw7Ci0gICAgICAgIEJVR19PTihwYWdlX21ha2Vf
cHJpdmF0ZShkLCBwYWdlKSAhPSAwKTsKKyAgICAgICAgQlVHX09OKHBhZ2VfbWFrZV9wcml2YXRl
KGQsIHBhZ2UpKTsKICAgICAgICAgZ290byBvdXQ7CiAgICAgfQogCkBAIC05NDYsMTUgKzk1Niwx
OSBAQCBzdGF0aWMgaW50IHNoYXJlX3BhZ2VzKHN0cnVjdCBkb21haW4gKnNkLCBnZm5fdCBzZ2Zu
LCBzaHJfaGFuZGxlX3Qgc2gsCiAgICAgZ2V0X3R3b19nZm5zKHNkLCBzZ2ZuLCAmc21mbl90eXBl
LCBOVUxMLCAmc21mbiwKICAgICAgICAgICAgICAgICAgY2QsIGNnZm4sICZjbWZuX3R5cGUsIE5V
TEwsICZjbWZuLCAwLCAmdGcpOwogCi0gICAgLyogVGhpcyB0cmlja3kgYnVzaW5lc3MgaXMgdG8g
YXZvaWQgdHdvIGNhbGxlcnMgZGVhZGxvY2tpbmcgaWYgCi0gICAgICogZ3JhYmJpbmcgcGFnZXMg
aW4gb3Bwb3NpdGUgY2xpZW50L3NvdXJjZSBvcmRlciAqLworICAgIC8qCisgICAgICogVGhpcyB0
cmlja3kgYnVzaW5lc3MgaXMgdG8gYXZvaWQgdHdvIGNhbGxlcnMgZGVhZGxvY2tpbmcgaWYKKyAg
ICAgKiBncmFiYmluZyBwYWdlcyBpbiBvcHBvc2l0ZSBjbGllbnQvc291cmNlIG9yZGVyLgorICAg
ICAqLwogICAgIGlmICggbWZuX2VxKHNtZm4sIGNtZm4pICkKICAgICB7Ci0gICAgICAgIC8qIFRo
ZSBwYWdlcyBhcmUgYWxyZWFkeSB0aGUgc2FtZS4gIFdlIGNvdWxkIHJldHVybiBzb21lCisgICAg
ICAgIC8qCisgICAgICAgICAqIFRoZSBwYWdlcyBhcmUgYWxyZWFkeSB0aGUgc2FtZS4gIFdlIGNv
dWxkIHJldHVybiBzb21lCiAgICAgICAgICAqIGtpbmQgb2YgZXJyb3IgaGVyZSwgYnV0IG5vIG1h
dHRlciBob3cgeW91IGxvb2sgYXQgaXQsCiAgICAgICAgICAqIHRoZSBwYWdlcyBhcmUgYWxyZWFk
eSAnc2hhcmVkJy4gIEl0IHBvc3NpYmx5IHJlcHJlc2VudHMKICAgICAgICAgICogYSBiaWcgcHJv
YmxlbSBzb21ld2hlcmUgZWxzZSwgYnV0IGFzIGZhciBhcyBzaGFyaW5nIGlzCi0gICAgICAgICAq
IGNvbmNlcm5lZDogZ3JlYXQgc3VjY2VzcyEgKi8KKyAgICAgICAgICogY29uY2VybmVkOiBncmVh
dCBzdWNjZXNzIQorICAgICAgICAgKi8KICAgICAgICAgcmV0ID0gMDsKICAgICAgICAgZ290byBl
cnJfb3V0OwogICAgIH0KQEAgLTEwMTAsMTEgKzEwMjQsMTUgQEAgc3RhdGljIGludCBzaGFyZV9w
YWdlcyhzdHJ1Y3QgZG9tYWluICpzZCwgZ2ZuX3Qgc2dmbiwgc2hyX2hhbmRsZV90IHNoLAogICAg
IHJtYXBfc2VlZF9pdGVyYXRvcihjcGFnZSwgJnJpKTsKICAgICB3aGlsZSAoIChnZm4gPSBybWFw
X2l0ZXJhdGUoY3BhZ2UsICZyaSkpICE9IE5VTEwpCiAgICAgewotICAgICAgICAvKiBHZXQgdGhl
IHNvdXJjZSBwYWdlIGFuZCB0eXBlLCB0aGlzIHNob3VsZCBuZXZlciBmYWlsOiAKLSAgICAgICAg
ICogd2UgYXJlIHVuZGVyIHNociBsb2NrLCBhbmQgZ290IGEgc3VjY2Vzc2Z1bCBsb29rdXAgKi8K
KyAgICAgICAgLyoKKyAgICAgICAgICogR2V0IHRoZSBzb3VyY2UgcGFnZSBhbmQgdHlwZSwgdGhp
cyBzaG91bGQgbmV2ZXIgZmFpbDoKKyAgICAgICAgICogd2UgYXJlIHVuZGVyIHNociBsb2NrLCBh
bmQgZ290IGEgc3VjY2Vzc2Z1bCBsb29rdXAuCisgICAgICAgICAqLwogICAgICAgICBCVUdfT04o
IWdldF9wYWdlX2FuZF90eXBlKHNwYWdlLCBkb21fY293LCBQR1Rfc2hhcmVkX3BhZ2UpKTsKLSAg
ICAgICAgLyogTW92ZSB0aGUgZ2ZuX2luZm8gZnJvbSBjbGllbnQgbGlzdCB0byBzb3VyY2UgbGlz
dC4KLSAgICAgICAgICogRG9uJ3QgY2hhbmdlIHRoZSB0eXBlIG9mIHJtYXAgZm9yIHRoZSBjbGll
bnQgcGFnZS4gKi8KKyAgICAgICAgLyoKKyAgICAgICAgICogTW92ZSB0aGUgZ2ZuX2luZm8gZnJv
bSBjbGllbnQgbGlzdCB0byBzb3VyY2UgbGlzdC4KKyAgICAgICAgICogRG9uJ3QgY2hhbmdlIHRo
ZSB0eXBlIG9mIHJtYXAgZm9yIHRoZSBjbGllbnQgcGFnZS4KKyAgICAgICAgICovCiAgICAgICAg
IHJtYXBfZGVsKGdmbiwgY3BhZ2UsIDApOwogICAgICAgICBybWFwX2FkZChnZm4sIHNwYWdlKTsK
ICAgICAgICAgcHV0X2NvdW50Kys7CkBAIC0xMDQzLDE0ICsxMDYxLDE0IEBAIHN0YXRpYyBpbnQg
c2hhcmVfcGFnZXMoc3RydWN0IGRvbWFpbiAqc2QsIGdmbl90IHNnZm4sIHNocl9oYW5kbGVfdCBz
aCwKICAgICBhdG9taWNfZGVjKCZucl9zaGFyZWRfbWZucyk7CiAgICAgYXRvbWljX2luYygmbnJf
c2F2ZWRfbWZucyk7CiAgICAgcmV0ID0gMDsKLSAgICAKKwogZXJyX291dDoKICAgICBwdXRfdHdv
X2dmbnMoJnRnKTsKICAgICByZXR1cm4gcmV0OwogfQogCiBpbnQgbWVtX3NoYXJpbmdfYWRkX3Rv
X3BoeXNtYXAoc3RydWN0IGRvbWFpbiAqc2QsIHVuc2lnbmVkIGxvbmcgc2dmbiwgc2hyX2hhbmRs
ZV90IHNoLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBkb21haW4gKmNkLCB1
bnNpZ25lZCBsb25nIGNnZm4pIAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVj
dCBkb21haW4gKmNkLCB1bnNpZ25lZCBsb25nIGNnZm4pCiB7CiAgICAgc3RydWN0IHBhZ2VfaW5m
byAqc3BhZ2U7CiAgICAgaW50IHJldCA9IC1FSU5WQUw7CkBAIC0xMDY5LDE1ICsxMDg3LDE4IEBA
IGludCBtZW1fc2hhcmluZ19hZGRfdG9fcGh5c21hcChzdHJ1Y3QgZG9tYWluICpzZCwgdW5zaWdu
ZWQgbG9uZyBzZ2ZuLCBzaHJfaGFuZGxlCiAgICAgc3BhZ2UgPSBfX2dyYWJfc2hhcmVkX3BhZ2Uo
c21mbik7CiAgICAgaWYgKCBzcGFnZSA9PSBOVUxMICkKICAgICAgICAgZ290byBlcnJfb3V0Owor
CiAgICAgQVNTRVJUKHNtZm5fdHlwZSA9PSBwMm1fcmFtX3NoYXJlZCk7CiAKICAgICAvKiBDaGVj
ayB0aGF0IHRoZSBoYW5kbGVzIG1hdGNoICovCiAgICAgaWYgKCBzcGFnZS0+c2hhcmluZy0+aGFu
ZGxlICE9IHNoICkKICAgICAgICAgZ290byBlcnJfdW5sb2NrOwogCi0gICAgLyogTWFrZSBzdXJl
IHRoZSB0YXJnZXQgcGFnZSBpcyBhIGhvbGUgaW4gdGhlIHBoeXNtYXAuIFRoZXNlIGFyZSB0eXBp
Y2FsbHkKKyAgICAvKgorICAgICAqIE1ha2Ugc3VyZSB0aGUgdGFyZ2V0IHBhZ2UgaXMgYSBob2xl
IGluIHRoZSBwaHlzbWFwLiBUaGVzZSBhcmUgdHlwaWNhbGx5CiAgICAgICogcDJtX21taW9fZG0s
IGJ1dCBhbHNvIGFjY2VwdCBwMm1faW52YWxpZCBhbmQgcGFnZWQgb3V0IHBhZ2VzLiBTZWUgdGhl
Ci0gICAgICogZGVmaW5pdGlvbiBvZiBwMm1faXNfaG9sZSBpbiBwMm0uaC4gKi8KKyAgICAgKiBk
ZWZpbml0aW9uIG9mIHAybV9pc19ob2xlIGluIHAybS5oLgorICAgICAqLwogICAgIGlmICggIXAy
bV9pc19ob2xlKGNtZm5fdHlwZSkgKQogICAgIHsKICAgICAgICAgcmV0ID0gWEVOTUVNX1NIQVJJ
TkdfT1BfQ19IQU5ETEVfSU5WQUxJRDsKQEAgLTEwODYsNyArMTEwNyw3IEBAIGludCBtZW1fc2hh
cmluZ19hZGRfdG9fcGh5c21hcChzdHJ1Y3QgZG9tYWluICpzZCwgdW5zaWduZWQgbG9uZyBzZ2Zu
LCBzaHJfaGFuZGxlCiAKICAgICAvKiBUaGlzIGlzIHNpbXBsZXIgdGhhbiByZWd1bGFyIHNoYXJp
bmcgKi8KICAgICBCVUdfT04oIWdldF9wYWdlX2FuZF90eXBlKHNwYWdlLCBkb21fY293LCBQR1Rf
c2hhcmVkX3BhZ2UpKTsKLSAgICBpZiAoIChnZm5faW5mbyA9IG1lbV9zaGFyaW5nX2dmbl9hbGxv
YyhzcGFnZSwgY2QsIGNnZm4pKSA9PSBOVUxMICkKKyAgICBpZiAoICEoZ2ZuX2luZm8gPSBtZW1f
c2hhcmluZ19nZm5fYWxsb2Moc3BhZ2UsIGNkLCBjZ2ZuKSkgKQogICAgIHsKICAgICAgICAgcHV0
X3BhZ2VfYW5kX3R5cGUoc3BhZ2UpOwogICAgICAgICByZXQgPSAtRU5PTUVNOwpAQCAtMTEwMiwx
MSArMTEyMywxNyBAQCBpbnQgbWVtX3NoYXJpbmdfYWRkX3RvX3BoeXNtYXAoc3RydWN0IGRvbWFp
biAqc2QsIHVuc2lnbmVkIGxvbmcgc2dmbiwgc2hyX2hhbmRsZQogICAgICAgICBtZW1fc2hhcmlu
Z19nZm5fZGVzdHJveShzcGFnZSwgY2QsIGdmbl9pbmZvKTsKICAgICAgICAgcHV0X3BhZ2VfYW5k
X3R5cGUoc3BhZ2UpOwogICAgIH0gZWxzZSB7Ci0gICAgICAgIC8qIFRoZXJlIGlzIGEgY2hhbmNl
IHdlJ3JlIHBsdWdnaW5nIGEgaG9sZSB3aGVyZSBhIHBhZ2VkIG91dCBwYWdlIHdhcyAqLworICAg
ICAgICAvKgorICAgICAgICAgKiBUaGVyZSBpcyBhIGNoYW5jZSB3ZSdyZSBwbHVnZ2luZyBhIGhv
bGUgd2hlcmUgYSBwYWdlZCBvdXQKKyAgICAgICAgICogcGFnZSB3YXMuCisgICAgICAgICAqLwog
ICAgICAgICBpZiAoIHAybV9pc19wYWdpbmcoY21mbl90eXBlKSAmJiAoY21mbl90eXBlICE9IHAy
bV9yYW1fcGFnaW5nX291dCkgKQogICAgICAgICB7CiAgICAgICAgICAgICBhdG9taWNfZGVjKCZj
ZC0+cGFnZWRfcGFnZXMpOwotICAgICAgICAgICAgLyogRnVydGhlciwgdGhlcmUgaXMgYSBjaGFu
Y2UgdGhpcyB3YXMgYSB2YWxpZCBwYWdlLiBEb24ndCBsZWFrIGl0LiAqLworICAgICAgICAgICAg
LyoKKyAgICAgICAgICAgICAqIEZ1cnRoZXIsIHRoZXJlIGlzIGEgY2hhbmNlIHRoaXMgd2FzIGEg
dmFsaWQgcGFnZS4KKyAgICAgICAgICAgICAqIERvbid0IGxlYWsgaXQuCisgICAgICAgICAgICAg
Ki8KICAgICAgICAgICAgIGlmICggbWZuX3ZhbGlkKGNtZm4pICkKICAgICAgICAgICAgIHsKICAg
ICAgICAgICAgICAgICBzdHJ1Y3QgcGFnZV9pbmZvICpjcGFnZSA9IG1mbl90b19wYWdlKGNtZm4p
OwpAQCAtMTEzMywxMyArMTE2MCwxNCBAQCBlcnJfb3V0OgogfQogCiAKLS8qIEEgbm90ZSBvbiB0
aGUgcmF0aW9uYWxlIGZvciB1bnNoYXJlIGVycm9yIGhhbmRsaW5nOgorLyoKKyAqIEEgbm90ZSBv
biB0aGUgcmF0aW9uYWxlIGZvciB1bnNoYXJlIGVycm9yIGhhbmRsaW5nOgogICogIDEuIFVuc2hh
cmUgY2FuIG9ubHkgZmFpbCB3aXRoIEVOT01FTS4gQW55IG90aGVyIGVycm9yIGNvbmRpdGlvbnMg
QlVHX09OKCkncwogICogIDIuIFdlIG5vdGlmeSBhIHBvdGVudGlhbCBkb20wIGhlbHBlciB0aHJv
dWdoIGEgdm1fZXZlbnQgcmluZy4gQnV0IHdlCi0gKiAgICAgYWxsb3cgdGhlIG5vdGlmaWNhdGlv
biB0byBub3QgZ28gdG8gc2xlZXAuIElmIHRoZSBldmVudCByaW5nIGlzIGZ1bGwgCisgKiAgICAg
YWxsb3cgdGhlIG5vdGlmaWNhdGlvbiB0byBub3QgZ28gdG8gc2xlZXAuIElmIHRoZSBldmVudCBy
aW5nIGlzIGZ1bGwKICAqICAgICBvZiBFTk9NRU0gd2FybmluZ3MsIHRoZW4gaXQncyBvbiB0aGUg
YmFsbC4KICAqICAzLiBXZSBjYW5ub3QgZ28gdG8gc2xlZXAgdW50aWwgdGhlIHVuc2hhcmUgaXMg
cmVzb2x2ZWQsIGJlY2F1c2Ugd2UgbWlnaHQKLSAqICAgICBiZSBidXJpZWQgZGVlcCBpbnRvIGxv
Y2tzIChlLmcuIHNvbWV0aGluZyAtPiBjb3B5X3RvX3VzZXIgLT4gX19odm1fY29weSkgCisgKiAg
ICAgYmUgYnVyaWVkIGRlZXAgaW50byBsb2NrcyAoZS5nLiBzb21ldGhpbmcgLT4gY29weV90b191
c2VyIC0+IF9faHZtX2NvcHkpCiAgKiAgNC4gU28sIHdlIG1ha2Ugc3VyZSB3ZToKICAqICAgICA0
LjEuIHJldHVybiBhbiBlcnJvcgogICogICAgIDQuMi4gZG8gbm90IGNvcnJ1cHQgc2hhcmVkIG1l
bW9yeQpAQCAtMTE0NywxOSArMTE3NSwyMCBAQCBlcnJfb3V0OgogICogICAgIDQuNC4gbGV0IHRo
ZSBndWVzdCBkZWFsIHdpdGggaXQgaWYgdGhlIGVycm9yIHByb3BhZ2F0aW9uIHdpbGwgcmVhY2gg
aXQKICAqLwogaW50IF9fbWVtX3NoYXJpbmdfdW5zaGFyZV9wYWdlKHN0cnVjdCBkb21haW4gKmQs
Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGxvbmcgZ2ZuLCAKLSAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdWludDE2X3QgZmxhZ3MpCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdW5zaWduZWQgbG9uZyBnZm4sCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgdWludDE2X3QgZmxhZ3MpCiB7CiAgICAgcDJtX3R5cGVfdCBwMm10OwogICAgIG1m
bl90IG1mbjsKICAgICBzdHJ1Y3QgcGFnZV9pbmZvICpwYWdlLCAqb2xkX3BhZ2U7CiAgICAgaW50
IGxhc3RfZ2ZuOwogICAgIGdmbl9pbmZvX3QgKmdmbl9pbmZvID0gTlVMTDsKLSAgIAorCiAgICAg
bWZuID0gZ2V0X2dmbihkLCBnZm4sICZwMm10KTsKLSAgICAKKwogICAgIC8qIEhhcyBzb21lb25l
IGFscmVhZHkgdW5zaGFyZWQgaXQ/ICovCi0gICAgaWYgKCAhcDJtX2lzX3NoYXJlZChwMm10KSAp
IHsKKyAgICBpZiAoICFwMm1faXNfc2hhcmVkKHAybXQpICkKKyAgICB7CiAgICAgICAgIHB1dF9n
Zm4oZCwgZ2ZuKTsKICAgICAgICAgcmV0dXJuIDA7CiAgICAgfQpAQCAtMTE2NywyNiArMTE5Niwz
MCBAQCBpbnQgX19tZW1fc2hhcmluZ191bnNoYXJlX3BhZ2Uoc3RydWN0IGRvbWFpbiAqZCwKICAg
ICBwYWdlID0gX19ncmFiX3NoYXJlZF9wYWdlKG1mbik7CiAgICAgaWYgKCBwYWdlID09IE5VTEwg
KQogICAgIHsKLSAgICAgICAgZ2RwcmludGsoWEVOTE9HX0VSUiwgIkRvbWFpbiBwMm0gaXMgc2hh
cmVkLCBidXQgcGFnZSBpcyBub3Q6ICIKLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IiVseFxuIiwgZ2ZuKTsKKyAgICAgICAgZ2RwcmludGsoWEVOTE9HX0VSUiwgIkRvbWFpbiBwMm0g
aXMgc2hhcmVkLCBidXQgcGFnZSBpcyBub3Q6ICVseFxuIiwKKyAgICAgICAgICAgICAgICAgZ2Zu
KTsKICAgICAgICAgQlVHKCk7CiAgICAgfQogCiAgICAgZ2ZuX2luZm8gPSBybWFwX3JldHJpZXZl
KGQtPmRvbWFpbl9pZCwgZ2ZuLCBwYWdlKTsKICAgICBpZiAoIHVubGlrZWx5KGdmbl9pbmZvID09
IE5VTEwpICkKICAgICB7Ci0gICAgICAgIGdkcHJpbnRrKFhFTkxPR19FUlIsICJDb3VsZCBub3Qg
ZmluZCBnZm5faW5mbyBmb3Igc2hhcmVkIGdmbjogIgotICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAiJWx4XG4iLCBnZm4pOworICAgICAgICBnZHByaW50ayhYRU5MT0dfRVJSLCAiQ291
bGQgbm90IGZpbmQgZ2ZuX2luZm8gZm9yIHNoYXJlZCBnZm46ICVseFxuIiwKKyAgICAgICAgICAg
ICAgICAgZ2ZuKTsKICAgICAgICAgQlVHKCk7CiAgICAgfQogCi0gICAgLyogRG8gdGhlIGFjY291
bnRpbmcgZmlyc3QuIElmIGFueXRoaW5nIGZhaWxzIGJlbG93LCB3ZSBoYXZlIGJpZ2dlcgotICAg
ICAqIGJpZ2dlciBmaXNoIHRvIGZyeS4gRmlyc3QsIHJlbW92ZSB0aGUgZ2ZuIGZyb20gdGhlIGxp
c3QuICovIAorICAgIC8qCisgICAgICogRG8gdGhlIGFjY291bnRpbmcgZmlyc3QuIElmIGFueXRo
aW5nIGZhaWxzIGJlbG93LCB3ZSBoYXZlIGJpZ2dlcgorICAgICAqIGJpZ2dlciBmaXNoIHRvIGZy
eS4gRmlyc3QsIHJlbW92ZSB0aGUgZ2ZuIGZyb20gdGhlIGxpc3QuCisgICAgICovCiAgICAgbGFz
dF9nZm4gPSBybWFwX2hhc19vbmVfZW50cnkocGFnZSk7CiAgICAgaWYgKCBsYXN0X2dmbiApCiAg
ICAgewotICAgICAgICAvKiBDbGVhbiB1cCBzaGFyZWQgc3RhdGUuIEdldCByaWQgb2YgdGhlIDxk
b21pZCwgZ2ZuPiB0dXBsZQotICAgICAgICAgKiBiZWZvcmUgZGVzdHJveWluZyB0aGUgcm1hcC4g
Ki8KKyAgICAgICAgLyoKKyAgICAgICAgICogQ2xlYW4gdXAgc2hhcmVkIHN0YXRlLiBHZXQgcmlk
IG9mIHRoZSA8ZG9taWQsIGdmbj4gdHVwbGUKKyAgICAgICAgICogYmVmb3JlIGRlc3Ryb3lpbmcg
dGhlIHJtYXAuCisgICAgICAgICAqLwogICAgICAgICBtZW1fc2hhcmluZ19nZm5fZGVzdHJveShw
YWdlLCBkLCBnZm5faW5mbyk7CiAgICAgICAgIHBhZ2Vfc2hhcmluZ19kaXNwb3NlKHBhZ2UpOwog
ICAgICAgICBwYWdlLT5zaGFyaW5nID0gTlVMTDsKQEAgLTExOTUsOCArMTIyOCwxMCBAQCBpbnQg
X19tZW1fc2hhcmluZ191bnNoYXJlX3BhZ2Uoc3RydWN0IGRvbWFpbiAqZCwKICAgICBlbHNlCiAg
ICAgICAgIGF0b21pY19kZWMoJm5yX3NhdmVkX21mbnMpOwogCi0gICAgLyogSWYgdGhlIEdGTiBp
cyBnZXR0aW5nIGRlc3Ryb3llZCBkcm9wIHRoZSByZWZlcmVuY2VzIHRvIE1GTiAKLSAgICAgKiAo
cG9zc2libHkgZnJlZWluZyB0aGUgcGFnZSksIGFuZCBleGl0IGVhcmx5ICovCisgICAgLyoKKyAg
ICAgKiBJZiB0aGUgR0ZOIGlzIGdldHRpbmcgZGVzdHJveWVkIGRyb3AgdGhlIHJlZmVyZW5jZXMg
dG8gTUZOCisgICAgICogKHBvc3NpYmx5IGZyZWVpbmcgdGhlIHBhZ2UpLCBhbmQgZXhpdCBlYXJs
eS4KKyAgICAgKi8KICAgICBpZiAoIGZsYWdzICYgTUVNX1NIQVJJTkdfREVTVFJPWV9HRk4gKQog
ICAgIHsKICAgICAgICAgaWYgKCAhbGFzdF9nZm4gKQpAQCAtMTIxMiw3ICsxMjQ3LDcgQEAgaW50
IF9fbWVtX3NoYXJpbmdfdW5zaGFyZV9wYWdlKHN0cnVjdCBkb21haW4gKmQsCiAKICAgICAgICAg
cmV0dXJuIDA7CiAgICAgfQotIAorCiAgICAgaWYgKCBsYXN0X2dmbiApCiAgICAgewogICAgICAg
ICAvKiBNYWtpbmcgYSBwYWdlIHByaXZhdGUgYXRvbWljYWxseSB1bmxvY2tzIGl0ICovCkBAIC0x
MjIyLDE0ICsxMjU3LDE2IEBAIGludCBfX21lbV9zaGFyaW5nX3Vuc2hhcmVfcGFnZShzdHJ1Y3Qg
ZG9tYWluICpkLAogCiAgICAgb2xkX3BhZ2UgPSBwYWdlOwogICAgIHBhZ2UgPSBhbGxvY19kb21o
ZWFwX3BhZ2UoZCwgMCk7Ci0gICAgaWYgKCAhcGFnZSApIAorICAgIGlmICggIXBhZ2UgKQogICAg
IHsKICAgICAgICAgLyogVW5kbyBkZWMgb2YgbnJfc2F2ZWRfbWZucywgYXMgdGhlIHJldHJ5IHdp
bGwgZGVjcmVhc2UgYWdhaW4uICovCiAgICAgICAgIGF0b21pY19pbmMoJm5yX3NhdmVkX21mbnMp
OwogICAgICAgICBtZW1fc2hhcmluZ19wYWdlX3VubG9jayhvbGRfcGFnZSk7CiAgICAgICAgIHB1
dF9nZm4oZCwgZ2ZuKTsKLSAgICAgICAgLyogQ2FsbGVyIGlzIHJlc3BvbnNpYmxlIGZvciBwbGFj
aW5nIGFuIGV2ZW50Ci0gICAgICAgICAqIGluIHRoZSByaW5nICovCisgICAgICAgIC8qCisgICAg
ICAgICAqIENhbGxlciBpcyByZXNwb25zaWJsZSBmb3IgcGxhY2luZyBhbiBldmVudAorICAgICAg
ICAgKiBpbiB0aGUgcmluZy4KKyAgICAgICAgICovCiAgICAgICAgIHJldHVybiAtRU5PTUVNOwog
ICAgIH0KIApAQCAtMTI0MCwxMSArMTI3NywxMSBAQCBpbnQgX19tZW1fc2hhcmluZ191bnNoYXJl
X3BhZ2Uoc3RydWN0IGRvbWFpbiAqZCwKICAgICBtZW1fc2hhcmluZ19wYWdlX3VubG9jayhvbGRf
cGFnZSk7CiAgICAgcHV0X3BhZ2VfYW5kX3R5cGUob2xkX3BhZ2UpOwogCi1wcml2YXRlX3BhZ2Vf
Zm91bmQ6ICAgIAorcHJpdmF0ZV9wYWdlX2ZvdW5kOgogICAgIGlmICggcDJtX2NoYW5nZV90eXBl
X29uZShkLCBnZm4sIHAybV9yYW1fc2hhcmVkLCBwMm1fcmFtX3J3KSApCiAgICAgewotICAgICAg
ICBnZHByaW50ayhYRU5MT0dfRVJSLCAiQ291bGQgbm90IGNoYW5nZSBwMm0gdHlwZSBkICVodSBn
Zm4gJWx4LlxuIiwgCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGQtPmRvbWFpbl9p
ZCwgZ2ZuKTsKKyAgICAgICAgZ2RwcmludGsoWEVOTE9HX0VSUiwgIkNvdWxkIG5vdCBjaGFuZ2Ug
cDJtIHR5cGUgZCAlaHUgZ2ZuICVseC5cbiIsCisgICAgICAgICAgICAgICAgIGQtPmRvbWFpbl9p
ZCwgZ2ZuKTsKICAgICAgICAgQlVHKCk7CiAgICAgfQogCkBAIC0xMjc3LDIwICsxMzE0LDIzIEBA
IGludCByZWxpbnF1aXNoX3NoYXJlZF9wYWdlcyhzdHJ1Y3QgZG9tYWluICpkKQogICAgICAgICBt
Zm5fdCBtZm47CiAgICAgICAgIGludCBzZXRfcmM7CiAKLSAgICAgICAgaWYgKCBhdG9taWNfcmVh
ZCgmZC0+c2hyX3BhZ2VzKSA9PSAwICkKKyAgICAgICAgaWYgKCAhYXRvbWljX3JlYWQoJmQtPnNo
cl9wYWdlcykgKQogICAgICAgICAgICAgYnJlYWs7CisKICAgICAgICAgbWZuID0gcDJtLT5nZXRf
ZW50cnkocDJtLCBfZ2ZuKGdmbiksICZ0LCAmYSwgMCwgTlVMTCwgTlVMTCk7Ci0gICAgICAgIGlm
ICggbWZuX3ZhbGlkKG1mbikgJiYgKHQgPT0gcDJtX3JhbV9zaGFyZWQpICkKKyAgICAgICAgaWYg
KCBtZm5fdmFsaWQobWZuKSAmJiB0ID09IHAybV9yYW1fc2hhcmVkICkKICAgICAgICAgewogICAg
ICAgICAgICAgLyogRG9lcyBub3QgZmFpbCB3aXRoIEVOT01FTSBnaXZlbiB0aGUgREVTVFJPWSBm
bGFnICovCi0gICAgICAgICAgICBCVUdfT04oX19tZW1fc2hhcmluZ191bnNoYXJlX3BhZ2UoZCwg
Z2ZuLCAKLSAgICAgICAgICAgICAgICAgICAgTUVNX1NIQVJJTkdfREVTVFJPWV9HRk4pKTsKLSAg
ICAgICAgICAgIC8qIENsZWFyIG91dCB0aGUgcDJtIGVudHJ5IHNvIG5vIG9uZSBlbHNlIG1heSB0
cnkgdG8KKyAgICAgICAgICAgIEJVR19PTihfX21lbV9zaGFyaW5nX3Vuc2hhcmVfcGFnZShkLCBn
Zm4sCisgICAgICAgICAgICAgICAgICAgTUVNX1NIQVJJTkdfREVTVFJPWV9HRk4pKTsKKyAgICAg
ICAgICAgIC8qCisgICAgICAgICAgICAgKiBDbGVhciBvdXQgdGhlIHAybSBlbnRyeSBzbyBubyBv
bmUgZWxzZSBtYXkgdHJ5IHRvCiAgICAgICAgICAgICAgKiB1bnNoYXJlLiAgTXVzdCBzdWNjZWVk
OiB3ZSBqdXN0IHJlYWQgdGhlIG9sZCBlbnRyeSBhbmQKLSAgICAgICAgICAgICAqIHdlIGhvbGQg
dGhlIHAybSBsb2NrLiAqLworICAgICAgICAgICAgICogd2UgaG9sZCB0aGUgcDJtIGxvY2suCisg
ICAgICAgICAgICAgKi8KICAgICAgICAgICAgIHNldF9yYyA9IHAybS0+c2V0X2VudHJ5KHAybSwg
X2dmbihnZm4pLCBfbWZuKDApLCBQQUdFX09SREVSXzRLLAogICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgcDJtX2ludmFsaWQsIHAybV9hY2Nlc3Nfcnd4LCAtMSk7Ci0gICAgICAg
ICAgICBBU1NFUlQoc2V0X3JjID09IDApOworICAgICAgICAgICAgQVNTRVJUKCFzZXRfcmMpOwog
ICAgICAgICAgICAgY291bnQgKz0gMHgxMDsKICAgICAgICAgfQogICAgICAgICBlbHNlCkBAIC0x
NDU0LDcgKzE0OTQsNyBAQCBpbnQgbWVtX3NoYXJpbmdfbWVtb3AoWEVOX0dVRVNUX0hBTkRMRV9Q
QVJBTSh4ZW5fbWVtX3NoYXJpbmdfb3BfdCkgYXJnKQogCiAgICAgICAgICAgICBpZiAoIFhFTk1F
TV9TSEFSSU5HX09QX0ZJRUxEX0lTX0dSRUYobXNvLnUuc2hhcmUuc291cmNlX2dmbikgKQogICAg
ICAgICAgICAgewotICAgICAgICAgICAgICAgIGdyYW50X3JlZl90IGdyZWYgPSAoZ3JhbnRfcmVm
X3QpIAorICAgICAgICAgICAgICAgIGdyYW50X3JlZl90IGdyZWYgPSAoZ3JhbnRfcmVmX3QpCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoWEVOTUVNX1NIQVJJTkdfT1BfRklF
TERfR0VUX0dSRUYoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNv
LnUuc2hhcmUuc291cmNlX2dmbikpOwogICAgICAgICAgICAgICAgIHJjID0gbWVtX3NoYXJpbmdf
Z3JlZl90b19nZm4oZC0+Z3JhbnRfdGFibGUsIGdyZWYsICZzZ2ZuLApAQCAtMTQ3MCw3ICsxNTEw
LDcgQEAgaW50IG1lbV9zaGFyaW5nX21lbW9wKFhFTl9HVUVTVF9IQU5ETEVfUEFSQU0oeGVuX21l
bV9zaGFyaW5nX29wX3QpIGFyZykKIAogICAgICAgICAgICAgaWYgKCBYRU5NRU1fU0hBUklOR19P
UF9GSUVMRF9JU19HUkVGKG1zby51LnNoYXJlLmNsaWVudF9nZm4pICkKICAgICAgICAgICAgIHsK
LSAgICAgICAgICAgICAgICBncmFudF9yZWZfdCBncmVmID0gKGdyYW50X3JlZl90KSAKKyAgICAg
ICAgICAgICAgICBncmFudF9yZWZfdCBncmVmID0gKGdyYW50X3JlZl90KQogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgKFhFTk1FTV9TSEFSSU5HX09QX0ZJRUxEX0dFVF9HUkVG
KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zby51LnNoYXJlLmNs
aWVudF9nZm4pKTsKICAgICAgICAgICAgICAgICByYyA9IG1lbV9zaGFyaW5nX2dyZWZfdG9fZ2Zu
KGNkLT5ncmFudF90YWJsZSwgZ3JlZiwgJmNnZm4sCkBAIC0xNTM0LDcgKzE1NzQsNyBAQCBpbnQg
bWVtX3NoYXJpbmdfbWVtb3AoWEVOX0dVRVNUX0hBTkRMRV9QQVJBTSh4ZW5fbWVtX3NoYXJpbmdf
b3BfdCkgYXJnKQogICAgICAgICAgICAgc2ggICAgICA9IG1zby51LnNoYXJlLnNvdXJjZV9oYW5k
bGU7CiAgICAgICAgICAgICBjZ2ZuICAgID0gbXNvLnUuc2hhcmUuY2xpZW50X2dmbjsKIAotICAg
ICAgICAgICAgcmMgPSBtZW1fc2hhcmluZ19hZGRfdG9fcGh5c21hcChkLCBzZ2ZuLCBzaCwgY2Qs
IGNnZm4pOyAKKyAgICAgICAgICAgIHJjID0gbWVtX3NoYXJpbmdfYWRkX3RvX3BoeXNtYXAoZCwg
c2dmbiwgc2gsIGNkLCBjZ2ZuKTsKIAogICAgICAgICAgICAgcmN1X3VubG9ja19kb21haW4oY2Qp
OwogICAgICAgICB9CmRpZmYgLS1naXQgYS94ZW4vYXJjaC94ODYvbW0vcDJtLmMgYi94ZW4vYXJj
aC94ODYvbW0vcDJtLmMKaW5kZXggOGE1MjI5ZWUyMS4uNzE0MTU4ZDJhNiAxMDA2NDQKLS0tIGEv
eGVuL2FyY2gveDg2L21tL3AybS5jCisrKyBiL3hlbi9hcmNoL3g4Ni9tbS9wMm0uYwpAQCAtNTA2
LDggKzUwNiwxMCBAQCBtZm5fdCBfX2dldF9nZm5fdHlwZV9hY2Nlc3Moc3RydWN0IHAybV9kb21h
aW4gKnAybSwgdW5zaWduZWQgbG9uZyBnZm5fbCwKICAgICBpZiAoIChxICYgUDJNX1VOU0hBUkUp
ICYmIHAybV9pc19zaGFyZWQoKnQpICkKICAgICB7CiAgICAgICAgIEFTU0VSVChwMm1faXNfaG9z
dHAybShwMm0pKTsKLSAgICAgICAgLyogVHJ5IHRvIHVuc2hhcmUuIElmIHdlIGZhaWwsIGNvbW11
bmljYXRlIEVOT01FTSB3aXRob3V0Ci0gICAgICAgICAqIHNsZWVwaW5nLiAqLworICAgICAgICAv
KgorICAgICAgICAgKiBUcnkgdG8gdW5zaGFyZS4gSWYgd2UgZmFpbCwgY29tbXVuaWNhdGUgRU5P
TUVNIHdpdGhvdXQKKyAgICAgICAgICogc2xlZXBpbmcuCisgICAgICAgICAqLwogICAgICAgICBp
ZiAoIG1lbV9zaGFyaW5nX3Vuc2hhcmVfcGFnZShwMm0tPmRvbWFpbiwgZ2ZuX2wsIDApIDwgMCAp
CiAgICAgICAgICAgICBtZW1fc2hhcmluZ19ub3RpZnlfZW5vbWVtKHAybS0+ZG9tYWluLCBnZm5f
bCwgZmFsc2UpOwogICAgICAgICBtZm4gPSBwMm0tPmdldF9lbnRyeShwMm0sIGdmbiwgdCwgYSwg
cSwgcGFnZV9vcmRlciwgTlVMTCk7CkBAIC04ODcsMTUgKzg4OSwxNSBAQCBndWVzdF9waHlzbWFw
X2FkZF9lbnRyeShzdHJ1Y3QgZG9tYWluICpkLCBnZm5fdCBnZm4sIG1mbl90IG1mbiwKICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICZhLCAwLCBOVUxMLCBOVUxMKTsKICAgICAgICAgaWYg
KCBwMm1faXNfc2hhcmVkKG90KSApCiAgICAgICAgIHsKLSAgICAgICAgICAgIC8qIERvIGFuIHVu
c2hhcmUgdG8gY2xlYW5seSB0YWtlIGNhcmUgb2YgYWxsIGNvcm5lciAKLSAgICAgICAgICAgICAq
IGNhc2VzLiAqLworICAgICAgICAgICAgLyogRG8gYW4gdW5zaGFyZSB0byBjbGVhbmx5IHRha2Ug
Y2FyZSBvZiBhbGwgY29ybmVyIGNhc2VzLiAqLwogICAgICAgICAgICAgaW50IHJjOwogICAgICAg
ICAgICAgcmMgPSBtZW1fc2hhcmluZ191bnNoYXJlX3BhZ2UocDJtLT5kb21haW4sCiAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZm5feChnZm5fYWRkKGdmbiwgaSkp
LCAwKTsKICAgICAgICAgICAgIGlmICggcmMgKQogICAgICAgICAgICAgewogICAgICAgICAgICAg
ICAgIHAybV91bmxvY2socDJtKTsKLSAgICAgICAgICAgICAgICAvKiBOT1RFOiBTaG91bGQgYSBn
dWVzdCBkb21haW4gYnJpbmcgdGhpcyB1cG9uIGl0c2VsZiwKKyAgICAgICAgICAgICAgICAvKgor
ICAgICAgICAgICAgICAgICAqIE5PVEU6IFNob3VsZCBhIGd1ZXN0IGRvbWFpbiBicmluZyB0aGlz
IHVwb24gaXRzZWxmLAogICAgICAgICAgICAgICAgICAqIHRoZXJlIGlzIG5vdCBhIHdob2xlIGxv
dCB3ZSBjYW4gZG8uIFdlIGFyZSBidXJpZWQKICAgICAgICAgICAgICAgICAgKiBkZWVwIGluIGxv
Y2tzIGZyb20gbW9zdCBjb2RlIHBhdGhzIGJ5IG5vdy4gU28sIGZhaWwKICAgICAgICAgICAgICAg
ICAgKiB0aGUgY2FsbCBhbmQgZG9uJ3QgdHJ5IHRvIHNsZWVwIG9uIGEgd2FpdCBxdWV1ZQpAQCAt
OTA0LDggKzkwNiw5IEBAIGd1ZXN0X3BoeXNtYXBfYWRkX2VudHJ5KHN0cnVjdCBkb21haW4gKmQs
IGdmbl90IGdmbiwgbWZuX3QgbWZuLAogICAgICAgICAgICAgICAgICAqIEhvd2V2ZXIsIGFsbCBj
dXJyZW50IChjaGFuZ2VzZXQgMzQzMmFiY2Y5MzgwKSBjb2RlCiAgICAgICAgICAgICAgICAgICog
cGF0aHMgYXZvaWQgdGhpcyB1bnNhdm91cnkgc2l0dWF0aW9uLiBGb3Igbm93LgogICAgICAgICAg
ICAgICAgICAqCi0gICAgICAgICAgICAgICAgICogRm9yZWlnbiBkb21haW5zIGFyZSBva2F5IHRv
IHBsYWNlIGFuIGV2ZW50IGFzIHRoZXkgCi0gICAgICAgICAgICAgICAgICogd29uJ3QgZ28gdG8g
c2xlZXAuICovCisgICAgICAgICAgICAgICAgICogRm9yZWlnbiBkb21haW5zIGFyZSBva2F5IHRv
IHBsYWNlIGFuIGV2ZW50IGFzIHRoZXkKKyAgICAgICAgICAgICAgICAgKiB3b24ndCBnbyB0byBz
bGVlcC4KKyAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAodm9pZCltZW1fc2hh
cmluZ19ub3RpZnlfZW5vbWVtKHAybS0+ZG9tYWluLAogICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgZ2ZuX3goZ2ZuX2FkZChnZm4sIGkpKSwgZmFsc2UpOwog
ICAgICAgICAgICAgICAgIHJldHVybiByYzsKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL2FzbS14
ODYvbWVtX3NoYXJpbmcuaCBiL3hlbi9pbmNsdWRlL2FzbS14ODYvbWVtX3NoYXJpbmcuaAppbmRl
eCBkYjIyNDY4NzQ0Li4xMjgwODMwYTg1IDEwMDY0NAotLS0gYS94ZW4vaW5jbHVkZS9hc20teDg2
L21lbV9zaGFyaW5nLmgKKysrIGIveGVuL2luY2x1ZGUvYXNtLXg4Ni9tZW1fc2hhcmluZy5oCkBA
IC0zMywxMiArMzMsMTQgQEAKICNkZWZpbmUgTUVNX1NIQVJJTkdfQVVESVQgMAogI2VuZGlmCiAK
LXR5cGVkZWYgdWludDY0X3Qgc2hyX2hhbmRsZV90OyAKK3R5cGVkZWYgdWludDY0X3Qgc2hyX2hh
bmRsZV90OwogCiB0eXBlZGVmIHN0cnVjdCBybWFwX2hhc2h0YWIgewogICAgIHN0cnVjdCBsaXN0
X2hlYWQgKmJ1Y2tldDsKLSAgICAvKiBPdmVybGFwcyB3aXRoIHByZXYgcG9pbnRlciBvZiBsaXN0
X2hlYWQgaW4gdW5pb24gYmVsb3cuCi0gICAgICogVW5saWtlIHRoZSBwcmV2IHBvaW50ZXIsIHRo
aXMgY2FuIGJlIE5VTEwuICovCisgICAgLyoKKyAgICAgKiBPdmVybGFwcyB3aXRoIHByZXYgcG9p
bnRlciBvZiBsaXN0X2hlYWQgaW4gdW5pb24gYmVsb3cuCisgICAgICogVW5saWtlIHRoZSBwcmV2
IHBvaW50ZXIsIHRoaXMgY2FuIGJlIE5VTEwuCisgICAgICovCiAgICAgdm9pZCAqZmxhZzsKIH0g
cm1hcF9oYXNodGFiX3Q7CiAKQEAgLTU3LDM0ICs1OSwzNCBAQCBzdHJ1Y3QgcGFnZV9zaGFyaW5n
X2luZm8KICAgICB9OwogfTsKIAotI2RlZmluZSBzaGFyaW5nX3N1cHBvcnRlZChfZCkgXAotICAg
IChpc19odm1fZG9tYWluKF9kKSAmJiBwYWdpbmdfbW9kZV9oYXAoX2QpKSAKLQogdW5zaWduZWQg
aW50IG1lbV9zaGFyaW5nX2dldF9ucl9zYXZlZF9tZm5zKHZvaWQpOwogdW5zaWduZWQgaW50IG1l
bV9zaGFyaW5nX2dldF9ucl9zaGFyZWRfbWZucyh2b2lkKTsKIAogI2RlZmluZSBNRU1fU0hBUklO
R19ERVNUUk9ZX0dGTiAgICAgICAoMTw8MSkKIC8qIE9ubHkgZmFpbHMgd2l0aCAtRU5PTUVNLiBF
bmZvcmNlIGl0IHdpdGggYSBCVUdfT04gd3JhcHBlci4gKi8KIGludCBfX21lbV9zaGFyaW5nX3Vu
c2hhcmVfcGFnZShzdHJ1Y3QgZG9tYWluICpkLAotICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICB1bnNpZ25lZCBsb25nIGdmbiwgCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQx
Nl90IGZsYWdzKTsKLXN0YXRpYyBpbmxpbmUgaW50IG1lbV9zaGFyaW5nX3Vuc2hhcmVfcGFnZShz
dHJ1Y3QgZG9tYWluICpkLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHVuc2lnbmVkIGxvbmcgZ2ZuLAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHVpbnQxNl90IGZsYWdzKQorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IHVuc2lnbmVkIGxvbmcgZ2ZuLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQx
Nl90IGZsYWdzKTsKKworc3RhdGljIGlubGluZQoraW50IG1lbV9zaGFyaW5nX3Vuc2hhcmVfcGFn
ZShzdHJ1Y3QgZG9tYWluICpkLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25l
ZCBsb25nIGdmbiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDE2X3QgZmxhZ3Mp
CiB7CiAgICAgaW50IHJjID0gX19tZW1fc2hhcmluZ191bnNoYXJlX3BhZ2UoZCwgZ2ZuLCBmbGFn
cyk7CiAgICAgQlVHX09OKCByYyAmJiAocmMgIT0gLUVOT01FTSkgKTsKICAgICByZXR1cm4gcmM7
CiB9CiAKLS8qIElmIGNhbGxlZCBieSBhIGZvcmVpZ24gZG9tYWluLCBwb3NzaWJsZSBlcnJvcnMg
YXJlCisvKgorICogSWYgY2FsbGVkIGJ5IGEgZm9yZWlnbiBkb21haW4sIHBvc3NpYmxlIGVycm9y
cyBhcmUKICAqICAgLUVCVVNZIC0+IHJpbmcgZnVsbAogICogICAtRU5PU1lTIC0+IG5vIHJpbmcg
dG8gYmVnaW4gd2l0aAogICogYW5kIHRoZSBmb3JlaWduIG1hcHBlciBpcyByZXNwb25zaWJsZSBm
b3IgcmV0cnlpbmcuCiAgKgotICogSWYgY2FsbGVkIGJ5IHRoZSBndWVzdCB2Y3B1IGl0c2VsZiBh
bmQgYWxsb3dfc2xlZXAgaXMgc2V0LCBtYXkgCi0gKiBzbGVlcCBvbiBhIHdhaXQgcXVldWUsIHNv
IHRoZSBjYWxsZXIgaXMgcmVzcG9uc2libGUgZm9yIG5vdCAKLSAqIGhvbGRpbmcgbG9ja3Mgb24g
ZW50cnkuIEl0IG1heSBvbmx5IGZhaWwgd2l0aCBFTk9TWVMgCisgKiBJZiBjYWxsZWQgYnkgdGhl
IGd1ZXN0IHZjcHUgaXRzZWxmIGFuZCBhbGxvd19zbGVlcCBpcyBzZXQsIG1heQorICogc2xlZXAg
b24gYSB3YWl0IHF1ZXVlLCBzbyB0aGUgY2FsbGVyIGlzIHJlc3BvbnNpYmxlIGZvciBub3QKKyAq
IGhvbGRpbmcgbG9ja3Mgb24gZW50cnkuIEl0IG1heSBvbmx5IGZhaWwgd2l0aCBFTk9TWVMKICAq
CiAgKiBJZiBjYWxsZWQgYnkgdGhlIGd1ZXN0IHZjcHUgaXRzZWxmIGFuZCBhbGxvd19zbGVlcCBp
cyBub3Qgc2V0LAogICogdGhlbiBpdCdzIHRoZSBzYW1lIGFzIGEgZm9yZWlnbiBkb21haW4uCkBA
IC05MiwxMCArOTQsMTEgQEAgc3RhdGljIGlubGluZSBpbnQgbWVtX3NoYXJpbmdfdW5zaGFyZV9w
YWdlKHN0cnVjdCBkb21haW4gKmQsCiBpbnQgbWVtX3NoYXJpbmdfbm90aWZ5X2Vub21lbShzdHJ1
Y3QgZG9tYWluICpkLCB1bnNpZ25lZCBsb25nIGdmbiwKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIGJvb2wgYWxsb3dfc2xlZXApOwogaW50IG1lbV9zaGFyaW5nX21lbW9wKFhFTl9HVUVT
VF9IQU5ETEVfUEFSQU0oeGVuX21lbV9zaGFyaW5nX29wX3QpIGFyZyk7Ci1pbnQgbWVtX3NoYXJp
bmdfZG9tY3RsKHN0cnVjdCBkb21haW4gKmQsIAoraW50IG1lbV9zaGFyaW5nX2RvbWN0bChzdHJ1
Y3QgZG9tYWluICpkLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJ1Y3QgeGVuX2RvbWN0bF9t
ZW1fc2hhcmluZ19vcCAqbWVjKTsKIAotLyogU2NhbnMgdGhlIHAybSBhbmQgcmVsaW5xdWlzaGVz
IGFueSBzaGFyZWQgcGFnZXMsIGRlc3Ryb3lpbmcgCisvKgorICogU2NhbnMgdGhlIHAybSBhbmQg
cmVsaW5xdWlzaGVzIGFueSBzaGFyZWQgcGFnZXMsIGRlc3Ryb3lpbmcKICAqIHRob3NlIGZvciB3
aGljaCB0aGlzIGRvbWFpbiBob2xkcyB0aGUgZmluYWwgcmVmZXJlbmNlLgogICogUHJlZW1wdGli
bGUuCiAgKi8KQEAgLTEwNywxOCArMTEwLDIyIEBAIHN0YXRpYyBpbmxpbmUgdW5zaWduZWQgaW50
IG1lbV9zaGFyaW5nX2dldF9ucl9zYXZlZF9tZm5zKHZvaWQpCiB7CiAgICAgcmV0dXJuIDA7CiB9
CisKIHN0YXRpYyBpbmxpbmUgdW5zaWduZWQgaW50IG1lbV9zaGFyaW5nX2dldF9ucl9zaGFyZWRf
bWZucyh2b2lkKQogewogICAgIHJldHVybiAwOwogfQotc3RhdGljIGlubGluZSBpbnQgbWVtX3No
YXJpbmdfdW5zaGFyZV9wYWdlKHN0cnVjdCBkb21haW4gKmQsCi0gICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgbG9uZyBnZm4sCi0gICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDE2X3QgZmxhZ3MpCisKK3N0YXRpYyBp
bmxpbmUKK2ludCBtZW1fc2hhcmluZ191bnNoYXJlX3BhZ2Uoc3RydWN0IGRvbWFpbiAqZCwgdW5z
aWduZWQgbG9uZyBnZm4sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQxNl90IGZs
YWdzKQogewogICAgIEFTU0VSVF9VTlJFQUNIQUJMRSgpOwogICAgIHJldHVybiAtRU9QTk9UU1VQ
UDsKIH0KLXN0YXRpYyBpbmxpbmUgaW50IG1lbV9zaGFyaW5nX25vdGlmeV9lbm9tZW0oc3RydWN0
IGRvbWFpbiAqZCwgdW5zaWduZWQgbG9uZyBnZm4sCisKK3N0YXRpYyBpbmxpbmUKK2ludCBtZW1f
c2hhcmluZ19ub3RpZnlfZW5vbWVtKHN0cnVjdCBkb21haW4gKmQsIHVuc2lnbmVkIGxvbmcgZ2Zu
LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9vbCBhbGxvd19zbGVlcCkKIHsKICAg
ICBBU1NFUlRfVU5SRUFDSEFCTEUoKTsKLS0gCjIuMjAuMQoKCl9fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRl
dmVsQGxpc3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFp
bG1hbi9saXN0aW5mby94ZW4tZGV2ZWw=

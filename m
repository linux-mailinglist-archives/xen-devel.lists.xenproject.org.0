Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 4517E135885
	for <lists+xen-devel@lfdr.de>; Thu,  9 Jan 2020 12:52:40 +0100 (CET)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1ipWIt-0000J2-Tc; Thu, 09 Jan 2020 11:48:43 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=kEnv=26=amazon.co.uk=prvs=2706230f4=pdurrant@srs-us1.protection.inumbo.net>)
 id 1ipWIs-0000IT-1L
 for xen-devel@lists.xenproject.org; Thu, 09 Jan 2020 11:48:42 +0000
X-Inumbo-ID: f864fda6-32d5-11ea-b9a8-12813bfff9fa
Received: from smtp-fw-9102.amazon.com (unknown [207.171.184.29])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id f864fda6-32d5-11ea-b9a8-12813bfff9fa;
 Thu, 09 Jan 2020 11:48:37 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=amazon.com; i=@amazon.com; q=dns/txt; s=amazon201209;
 t=1578570518; x=1610106518;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=B2i9pGs24DU8NIGtFWxC8KYSG+io8j9E8ByIwdA5SvM=;
 b=udddu2ktQK3nmoaKJdsy2blMRki+mwS2izna0o4p4YRfwvm0D8XUj4z0
 XvY742EVUPGKtXYABECQMr57Va+3M7kSKRKyB4a3Vlh1X8wh1zYEQz/PE
 nVEz9PBns8uQy2I8M3m7Lo1lKsFPRDN6uSqeFOFKC3Vzo068aHKgglJO/ I=;
IronPort-SDR: Fbr72Vkd458rciRq8boljZMAVqCabHwn2rD6fgpS58qemL/yORYmQ6ikL3oek4r+nwoewkZR24
 +2ADYILEQi/A==
X-IronPort-AV: E=Sophos;i="5.69,413,1571702400"; d="scan'208";a="17662319"
Received: from sea32-co-svc-lb4-vlan3.sea.corp.amazon.com (HELO
 email-inbound-relay-2c-87a10be6.us-west-2.amazon.com) ([10.47.23.38])
 by smtp-border-fw-out-9102.sea19.amazon.com with ESMTP;
 09 Jan 2020 11:48:33 +0000
Received: from EX13MTAUEA002.ant.amazon.com
 (pdx4-ws-svc-p6-lb7-vlan2.pdx.amazon.com [10.170.41.162])
 by email-inbound-relay-2c-87a10be6.us-west-2.amazon.com (Postfix) with ESMTPS
 id 700A4A31F3; Thu,  9 Jan 2020 11:48:32 +0000 (UTC)
Received: from EX13D32EUC001.ant.amazon.com (10.43.164.159) by
 EX13MTAUEA002.ant.amazon.com (10.43.61.77) with Microsoft SMTP Server (TLS)
 id 15.0.1236.3; Thu, 9 Jan 2020 11:48:31 +0000
Received: from EX13MTAUWC001.ant.amazon.com (10.43.162.135) by
 EX13D32EUC001.ant.amazon.com (10.43.164.159) with Microsoft SMTP Server (TLS)
 id 15.0.1367.3; Thu, 9 Jan 2020 11:48:29 +0000
Received: from u2f063a87eabd5f.cbg10.amazon.com (10.125.106.135) by
 mail-relay.amazon.com (10.43.162.232) with Microsoft SMTP Server id
 15.0.1367.3 via Frontend Transport; Thu, 9 Jan 2020 11:48:27 +0000
From: Paul Durrant <pdurrant@amazon.com>
To: <xen-devel@lists.xenproject.org>
Date: Thu, 9 Jan 2020 11:48:13 +0000
Message-ID: <20200109114816.2293-4-pdurrant@amazon.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20200109114816.2293-1-pdurrant@amazon.com>
References: <20200109114816.2293-1-pdurrant@amazon.com>
MIME-Version: 1.0
Precedence: Bulk
Subject: [Xen-devel] [PATCH v2 3/6] libxl: add infrastructure to track and
 query 'retired' domids
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>,
 Paul Durrant <pdurrant@amazon.com>, Ian Jackson <ian.jackson@eu.citrix.com>,
 Wei Liu <wl@xen.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

QSBkb21pZCBpcyBjb25zaWRlcmVkIHJldGlyZWQgaWYgdGhlIGRvbWFpbiBpdCByZXByZXNlbnRz
IHdhcyBkZXN0cm95ZWQKbGVzcyB0aGFuIGEgc3BlY2lmaWVkIG51bWJlciBvZiBzZWNvbmRzIGFn
by4gVGhlIG51bWJlciBjYW4gYmUgc2V0IHVzaW5nCnRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBM
SUJYTF9ET01JRF9NQVhfUkVUSVJFTUVOVC4gSWYgdGhlIHZhcmlhYmxlIGRvZXMKbm90IGV4aXN0
IHRoZW4gYSBkZWZhdWx0IHZhbHVlIG9mIDYwcyBpcyB1c2VkLgoKV2hlbmV2ZXIgYSBkb21haW4g
aXMgZGVzdHJveWVkLCBhIHRpbWUtc3RhbXBlZCByZWNvcmQgd2lsbCBiZSB3cml0dGVuIGludG8K
YSBoaXN0b3J5IGZpbGUgKC92YXIvcnVuL3hlbi9kb21pZC1oaXN0b3J5KS4gVG8gYXZvaWQgdGhl
IGhpc3RvcnkgZmlsZQpncm93aW5nIHRvbyBsYXJnZSwgYW55IHJlY29yZHMgd2l0aCB0aW1lLXN0
YW1wcyB0aGF0IGluZGljYXRlIHRoYXQgdGhlCmRvbWlkIGhhcyBleGNlZWRlZCBtYXhpbXVtIHJl
dGlyZW1lbnQgd2lsbCBhbHNvIGJlIHB1cmdlZC4KCkEgbmV3IHV0aWxpdHkgZnVuY3Rpb24sIGxp
YnhsX19pc19yZXRpcmVkX2RvbWlkKCksIGhhcyBiZWVuIGFkZGVkLiBUaGlzCmZ1bmN0aW9uIHJl
YWRzIHRoZSBzYW1lIGhpc3RvcnkgZmlsZSBjaGVja2luZyB3aGV0aGVyIGEgc3BlY2lmaWVkIGRv
bWlkCmhhcyBhIHJlY29yZCB0aGF0IGRvZXMgbm90IGV4Y2VlZCBtYXhpbXVtIHJldGlyZW1lbnQu
IFNpbmNlIHRoaXMgdXRpbGl0eQpmdW5jdGlvbiBkb2VzIG5vdCB3cml0ZSB0byB0aGUgZmlsZSwg
bm8gcmVjb3JkcyBhcmUgYWN0dWFsbHkgcHVyZ2VkIGJ5IGl0LgoKTk9URTogU2luY2UgdGhlIGhp
c3RvcnkgZmlsZSBpcyBob3N0ZWQgYnkgYSB0bXBmcyBmaWxlIHN5c3RlbSwgaXQgaXMKICAgICAg
YXV0b21hdGljYWxseSBwdXJnZWQgb24gYm9vdCB0aHVzIGFsbG93aW5nIHNhZmUgdXNlIG9mCiAg
ICAgIENMT0NLX01PTk9UT05JQyBhcyBhIHRpbWUgc291cmNlLgoKU2lnbmVkLW9mZi1ieTogUGF1
bCBEdXJyYW50IDxwZHVycmFudEBhbWF6b24uY29tPgotLS0KQ2M6IElhbiBKYWNrc29uIDxpYW4u
amFja3NvbkBldS5jaXRyaXguY29tPgpDYzogV2VpIExpdSA8d2xAeGVuLm9yZz4KQ2M6IEFudGhv
bnkgUEVSQVJEIDxhbnRob255LnBlcmFyZEBjaXRyaXguY29tPgoKdjI6CiAtIE5ldyBpbiB2Mgot
LS0KIHRvb2xzL2xpYnhsL2xpYnhsX2RvbWFpbi5jICAgfCAxMzIgKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysKIHRvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmggfCAgMTAgKysr
CiAyIGZpbGVzIGNoYW5nZWQsIDE0MiBpbnNlcnRpb25zKCspCgpkaWZmIC0tZ2l0IGEvdG9vbHMv
bGlieGwvbGlieGxfZG9tYWluLmMgYi90b29scy9saWJ4bC9saWJ4bF9kb21haW4uYwppbmRleCA1
NzE0NTAxNzc4Li43ZjI1NWYxODRjIDEwMDY0NAotLS0gYS90b29scy9saWJ4bC9saWJ4bF9kb21h
aW4uYworKysgYi90b29scy9saWJ4bC9saWJ4bF9kb21haW4uYwpAQCAtMTI2OCw2ICsxMjY4LDEz
NyBAQCBzdGF0aWMgdm9pZCBkbV9kZXN0cm95X2NiKGxpYnhsX19lZ2MgKmVnYywKICAgICBsaWJ4
bF9fZGV2aWNlc19kZXN0cm95KGVnYywgJmRpcy0+ZHJzKTsKIH0KIAorc3RhdGljIHVuc2lnbmVk
IGludCBsaWJ4bF9fZ2V0X21heF9yZXRpcmVtZW50KHZvaWQpCit7CisgICAgY29uc3QgY2hhciAq
ZW52X21heF9yZXRpcmVtZW50ID0gZ2V0ZW52KCJMSUJYTF9ET01JRF9NQVhfUkVUSVJFTUVOVCIp
OworCisgICAgcmV0dXJuIGVudl9tYXhfcmV0aXJlbWVudCA/IHN0cnRvbChlbnZfbWF4X3JldGly
ZW1lbnQsIE5VTEwsIDApIDoKKyAgICAgICAgTElCWExfRE9NSURfTUFYX1JFVElSRU1FTlQ7Cit9
CisKK3N0YXRpYyBpbnQgbGlieGxfX29wZW5fZG9taWRfaGlzdG9yeShsaWJ4bF9fZ2MgKmdjKQor
eworICAgIGNvbnN0IGNoYXIgKm5hbWU7CisgICAgaW50IGZkOworICAgIGludCByZXQ7CisKKyAg
ICBuYW1lID0gR0NTUFJJTlRGKCIlcy9kb21pZC1oaXN0b3J5IiwgbGlieGxfX3J1bl9kaXJfcGF0
aCgpKTsKKworICAgIGZkID0gb3BlbihuYW1lLCBPX1JEV1J8T19DUkVBVCwgMDY0NCk7CisgICAg
aWYgKGZkIDwgMCkgeworICAgICAgICBMT0dFKEVSUk9SLCAidW5leHBlY3RlZCBlcnJvciB3aGls
ZSB0cnlpbmcgb3BlbiAlcywgZXJybm89JWQiLAorICAgICAgICAgICAgIG5hbWUsIGVycm5vKTsK
KyAgICAgICAgZ290byBmYWlsOworICAgIH0KKworICAgIGZvciAoOzspIHsKKyAgICAgICAgcmV0
ID0gZmxvY2soZmQsIExPQ0tfRVgpOworICAgICAgICBpZiAoIXJldCkKKyAgICAgICAgICAgIGJy
ZWFrOworICAgICAgICBpZiAoZXJybm8gIT0gRUlOVFIpIHsKKyAgICAgICAgICAgIC8qIEFsbCBv
dGhlciBlcnJubzogRUJBREYsIEVJTlZBTCwgRU5PTENLLCBFV09VTERCTE9DSyAqLworICAgICAg
ICAgICAgTE9HRShFUlJPUiwKKyAgICAgICAgICAgICAgICAgInVuZXhwZWN0ZWQgZXJyb3Igd2hp
bGUgdHJ5aW5nIHRvIGxvY2sgJXMsIGZkPSVkLCBlcnJubz0lZCIsCisgICAgICAgICAgICAgICAg
IG5hbWUsIGZkLCBlcnJubyk7CisgICAgICAgICAgICBnb3RvIGZhaWw7CisgICAgICAgIH0KKyAg
ICB9CisKKyAgICByZXR1cm4gZmQ7CisKK2ZhaWw6CisgICAgaWYgKGZkID49IDApCisgICAgICAg
IGNsb3NlKGZkKTsKKworICAgIHJldHVybiAtMTsKK30KKworLyogV3JpdGUgYSBkb21pZCByZXRp
cmVtZW50IHJlY29yZCAqLworc3RhdGljIHZvaWQgbGlieGxfX3JldGlyZV9kb21pZChsaWJ4bF9f
Z2MgKmdjLCB1aW50MzJfdCBkb21pZCkKK3sKKyAgICBsb25nIG1heF9yZXRpcmVtZW50ID0gbGli
eGxfX2dldF9tYXhfcmV0aXJlbWVudCgpOworICAgIGludCBmZDsKKyAgICBGSUxFICpmOworICAg
IGxvbmcgcm9mZiwgd29mZjsKKyAgICBjaGFyIGxpbmVbNjRdOworICAgIHN0cnVjdCB0aW1lc3Bl
YyB0czsKKworICAgIGZkID0gbGlieGxfX29wZW5fZG9taWRfaGlzdG9yeShnYyk7CisgICAgaWYg
KGZkIDwgMCkKKyAgICAgICAgcmV0dXJuOworCisgICAgY2xvY2tfZ2V0dGltZShDTE9DS19NT05P
VE9OSUMsICZ0cyk7CisKKyAgICAvKiBQdXJnZSBvbGQgcmV0aXJlbWVudCByZWNvcmRzICovCisK
KyAgICBmID0gZmRvcGVuKGZkLCAicisiKTsKKyAgICB3b2ZmID0gZnRlbGwoZik7CisKKyAgICB3
aGlsZSAoZmdldHMobGluZSwgc2l6ZW9mKGxpbmUpLCBmKSkgeworICAgICAgICB1bnNpZ25lZCBs
b25nIHNlYzsKKyAgICAgICAgdW5zaWduZWQgaW50IGlnbm9yZWQ7CisKKyAgICAgICAgcm9mZiA9
IGZ0ZWxsKGYpOworCisgICAgICAgIGlmIChzc2NhbmYobGluZSwgIiVsdSAldSIsICZzZWMsICZp
Z25vcmVkKSAhPSAyKQorICAgICAgICAgICAgY29udGludWU7IC8qIFB1cmdlIG1hbGZvcm1lZCBs
aW5lcyAqLworCisgICAgICAgIGlmICh0cy50dl9zZWMgLSBzZWMgPiBtYXhfcmV0aXJlbWVudCkK
KyAgICAgICAgICAgIGNvbnRpbnVlOworCisgICAgICAgIGZzZWVrKGYsIHdvZmYsIFNFRUtfU0VU
KTsKKyAgICAgICAgZnB1dHMobGluZSwgZik7CisgICAgICAgIHdvZmYgPSBmdGVsbChmKTsKKwor
ICAgICAgICBmc2VlayhmLCByb2ZmLCBTRUVLX1NFVCk7CisgICAgfQorCisgICAgZnNlZWsoZiwg
d29mZiwgU0VFS19TRVQpOworICAgIGZwcmludGYoZiwgIiVsdSAldVxuIiwgdHMudHZfc2VjLCBk
b21pZCk7CisgICAgd29mZiA9IGZ0ZWxsKGYpOworICAgIGZmbHVzaChmKTsKKworICAgIGZ0cnVu
Y2F0ZShmZCwgd29mZik7IC8qIG1heSBub3cgYmUgZmV3ZXIgcmVjb3JkcyAqLworCisgICAgY2xv
c2UoZmQpOworfQorCitib29sIGxpYnhsX19pc19yZXRpcmVkX2RvbWlkKGxpYnhsX19nYyAqZ2Ms
IHVpbnQzMl90IGRvbWlkKQoreworICAgIGxvbmcgbWF4X3JldGlyZW1lbnQgPSBsaWJ4bF9fZ2V0
X21heF9yZXRpcmVtZW50KCk7CisgICAgYm9vbCByZXRpcmVkID0gZmFsc2U7CisgICAgaW50IGZk
OworICAgIEZJTEUgKmY7CisgICAgY2hhciBsaW5lWzY0XTsKKyAgICBzdHJ1Y3QgdGltZXNwZWMg
dHM7CisKKyAgICBmZCA9IGxpYnhsX19vcGVuX2RvbWlkX2hpc3RvcnkoZ2MpOworICAgIGlmIChm
ZCA8IDApCisgICAgICAgIHJldHVybiBmYWxzZTsKKworICAgIGNsb2NrX2dldHRpbWUoQ0xPQ0tf
TU9OT1RPTklDLCAmdHMpOworCisgICAgZiA9IGZkb3BlbihmZCwgInIiKTsKKworICAgIHdoaWxl
IChmZ2V0cyhsaW5lLCBzaXplb2YobGluZSksIGYpKSB7CisgICAgICAgIHVuc2lnbmVkIGxvbmcg
c2VjOworICAgICAgICB1bnNpZ25lZCBpbnQgY2hlY2s7CisKKyAgICAgICAgaWYgKHNzY2FuZihs
aW5lLCAiJWx1ICV1IiwgJnNlYywgJmNoZWNrKSAhPSAyKQorICAgICAgICAgICAgY29udGludWU7
CisKKyAgICAgICAgaWYgKGNoZWNrID09IGRvbWlkICYmCisgICAgICAgICAgICB0cy50dl9zZWMg
LSBzZWMgPD0gbWF4X3JldGlyZW1lbnQpIHsKKyAgICAgICAgICAgIHJldGlyZWQgPSB0cnVlOwor
ICAgICAgICAgICAgYnJlYWs7CisgICAgICAgIH0KKyAgICB9CisKKyAgICBjbG9zZShmZCk7CisK
KyAgICByZXR1cm4gcmV0aXJlZDsKK30KKwogc3RhdGljIHZvaWQgZGV2aWNlc19kZXN0cm95X2Ni
KGxpYnhsX19lZ2MgKmVnYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWJ4bF9f
ZGV2aWNlc19yZW1vdmVfc3RhdGUgKmRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBpbnQgcmMpCkBAIC0xMzMxLDYgKzE0NjIsNyBAQCBzdGF0aWMgdm9pZCBkZXZpY2VzX2Rlc3Ry
b3lfY2IobGlieGxfX2VnYyAqZWdjLAogICAgICAgICBpZiAoIWN0eC0+eGNoKSBnb3RvIGJhZGNo
aWxkOwogCiAgICAgICAgIGlmICghZGlzLT5zb2Z0X3Jlc2V0KSB7CisgICAgICAgICAgICBsaWJ4
bF9fcmV0aXJlX2RvbWlkKGdjLCBkb21pZCk7CiAgICAgICAgICAgICByYyA9IHhjX2RvbWFpbl9k
ZXN0cm95KGN0eC0+eGNoLCBkb21pZCk7CiAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICBy
YyA9IHhjX2RvbWFpbl9wYXVzZShjdHgtPnhjaCwgZG9taWQpOwpkaWZmIC0tZ2l0IGEvdG9vbHMv
bGlieGwvbGlieGxfaW50ZXJuYWwuaCBiL3Rvb2xzL2xpYnhsL2xpYnhsX2ludGVybmFsLmgKaW5k
ZXggY2IyMzQ5MGM1OS4uZmNhYzhhOTNjNSAxMDA2NDQKLS0tIGEvdG9vbHMvbGlieGwvbGlieGxf
aW50ZXJuYWwuaAorKysgYi90b29scy9saWJ4bC9saWJ4bF9pbnRlcm5hbC5oCkBAIC00NzcwLDYg
KzQ3NzAsMTYgQEAgX2hpZGRlbiBpbnQgbGlieGxfX2RvbWFpbl9wdmNvbnRyb2wobGlieGxfX2Vn
YyAqZWdjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlieGxfX3hzd2Fp
dF9zdGF0ZSAqcHZjb250cm9sLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ZG9taWRfdCBkb21pZCwgY29uc3QgY2hhciAqY21kKTsKIAorLyoKKyAqIE1heGltdW0gbnVtYmVy
IG9mIHNlY29uZHMgYSBkb21pZCByZW1haW5zIGluIHJldGlyZW1lbnQgYWZ0ZXIgZG9tYWluCisg
KiBkZXN0cnVjdGlvbi4gVGhpcyBjYW4gYmUgb3ZlcmlkZGVuIGJ5IHRoZSBlbnZpcm9ubWVudCB2
YXJpYWJsZSBvZiB0aGUKKyAqIHNhbWUgbmFtZS4KKyAqLworI2RlZmluZSBMSUJYTF9ET01JRF9N
QVhfUkVUSVJFTUVOVCA2MAorCisvKiBDaGVjayB3aGV0aGVyIGEgZG9taWQgaXMgaW4gcmV0aXJl
bWVudCAqLworYm9vbCBsaWJ4bF9faXNfcmV0aXJlZF9kb21pZChsaWJ4bF9fZ2MgKmdjLCB1aW50
MzJfdCBkb21pZCk7CisKICNlbmRpZgogCiAvKgotLSAKMi4yMC4xCgoKX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApY
ZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

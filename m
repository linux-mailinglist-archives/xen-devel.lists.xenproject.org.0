Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 89A6B2C47F
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:36:51 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZQg-0005qj-Lw; Tue, 28 May 2019 10:34:02 +0000
Received: from us1-rack-dfw2.inumbo.com ([104.130.134.6])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZQD-0004qk-Ao
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:33:33 +0000
X-Inumbo-ID: 0a037686-8134-11e9-8980-bc764e045a96
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-dfw2.inumbo.com (Halon) with ESMTPS
 id 0a037686-8134-11e9-8980-bc764e045a96;
 Tue, 28 May 2019 10:33:32 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 7BA16B0A5;
 Tue, 28 May 2019 10:33:31 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:33:11 +0200
Message-Id: <20190528103313.1343-59-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 58/60] xen/sched: support differing granularity
 in schedule_cpu_[add/rm]()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2l0aCBjb3JlIHNjaGVkdWxpbmcgYWN0aXZlIHNjaGVkdWxlX2NwdV9bYWRkL3JtXSgpIGhhcyB0
byBjb3BlIHdpdGgKZGlmZmVyZW50IHNjaGVkdWxpbmcgZ3JhbnVsYXJpdHk6IGEgY3B1IG5vdCBp
biBhbnkgY3B1cG9vbCBpcyBzdWJqZWN0CnRvIGdyYW51bGFyaXR5IDEgKGNwdSBzY2hlZHVsaW5n
KSwgd2hpbGUgYSBjcHUgaW4gYSBjcHVwb29sIG1pZ2h0IGJlCmluIGEgc2NoZWR1bGluZyByZXNv
dXJjZSB3aXRoIG1vcmUgdGhhbiBvbmUgY3B1LgoKSGFuZGxlIHRoYXQgYnkgaGF2aW5nIGFycmF5
cyBvZiBvbGQvbmV3IHBkYXRhIGFuZCB2ZGF0YSBhbmQgbG9vcCBvdmVyCnRob3NlIHdoZXJlIGFw
cHJvcHJpYXRlLgoKQWRkaXRpb25hbGx5IHRoZSBzY2hlZHVsaW5nIHJlc291cmNlKHMpIG11c3Qg
ZWl0aGVyIGJlIG1lcmdlZCBvcgpzcGxpdC4KClNpZ25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3Mg
PGpncm9zc0BzdXNlLmNvbT4KLS0tCiB4ZW4vY29tbW9uL2NwdXBvb2wuYyAgfCAgMTggKystLQog
eGVuL2NvbW1vbi9zY2hlZHVsZS5jIHwgMjI4ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKystLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDIwNSBpbnNlcnRpb25zKCsp
LCA0MSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL2NwdXBvb2wuYyBiL3hl
bi9jb21tb24vY3B1cG9vbC5jCmluZGV4IDFjNzcyMjU1MmMuLmVjODExMjQxODIgMTAwNjQ0Ci0t
LSBhL3hlbi9jb21tb24vY3B1cG9vbC5jCisrKyBiL3hlbi9jb21tb24vY3B1cG9vbC5jCkBAIC01
MzUsNiArNTM1LDcgQEAgc3RhdGljIHZvaWQgY3B1cG9vbF9jcHVfcmVtb3ZlKHVuc2lnbmVkIGlu
dCBjcHUpCiAgICAgICAgIHJldCA9IGNwdXBvb2xfdW5hc3NpZ25fY3B1X2VwaWxvZ3VlKGNwdXBv
b2wwKTsKICAgICAgICAgQlVHX09OKHJldCk7CiAgICAgfQorICAgIGNwdW1hc2tfY2xlYXJfY3B1
KGNwdSwgJmNwdXBvb2xfZnJlZV9jcHVzKTsKIH0KIAogLyoKQEAgLTU4NCwyMCArNTg1LDE5IEBA
IHN0YXRpYyB2b2lkIGNwdXBvb2xfY3B1X3JlbW92ZV9mb3JjZWQodW5zaWduZWQgaW50IGNwdSkK
ICAgICBzdHJ1Y3QgY3B1cG9vbCAqKmM7CiAgICAgaW50IHJldDsKIAotICAgIGlmICggY3B1bWFz
a190ZXN0X2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1cykgKQotICAgICAgICBjcHVtYXNrX2Ns
ZWFyX2NwdShjcHUsICZjcHVwb29sX2ZyZWVfY3B1cyk7Ci0gICAgZWxzZQorICAgIGZvcl9lYWNo
X2NwdXBvb2wgKCBjICkKICAgICB7Ci0gICAgICAgIGZvcl9lYWNoX2NwdXBvb2woYykKKyAgICAg
ICAgaWYgKCBjcHVtYXNrX3Rlc3RfY3B1KGNwdSwgKCpjKS0+Y3B1X3ZhbGlkKSApCiAgICAgICAg
IHsKLSAgICAgICAgICAgIGlmICggY3B1bWFza190ZXN0X2NwdShjcHUsICgqYyktPmNwdV92YWxp
ZCkgKQotICAgICAgICAgICAgewotICAgICAgICAgICAgICAgIHJldCA9IGNwdXBvb2xfdW5hc3Np
Z25fY3B1KCpjLCBjcHUpOwotICAgICAgICAgICAgICAgIEJVR19PTihyZXQpOwotICAgICAgICAg
ICAgfQorICAgICAgICAgICAgcmV0ID0gY3B1cG9vbF91bmFzc2lnbl9jcHVfcHJvbG9ndWUoKmMs
IGNwdSk7CisgICAgICAgICAgICBCVUdfT04ocmV0KTsKKyAgICAgICAgICAgIHJldCA9IGNwdXBv
b2xfdW5hc3NpZ25fY3B1X2VwaWxvZ3VlKCpjKTsKKyAgICAgICAgICAgIEJVR19PTihyZXQpOwog
ICAgICAgICB9CiAgICAgfQogCisgICAgY3B1bWFza19jbGVhcl9jcHUoY3B1LCAmY3B1cG9vbF9m
cmVlX2NwdXMpOworCiAgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogICAg
IHNjaGVkX3JtX2NwdShjcHUpOwogICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxv
Y2spOwpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2NvbW1vbi9zY2hl
ZHVsZS5jCmluZGV4IDZmNjg4NmQ1YzMuLmI0ZTY1ZTgxYjAgMTAwNjQ0Ci0tLSBhL3hlbi9jb21t
b24vc2NoZWR1bGUuYworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTQwMiwyNiArNDAy
LDMwIEBAIHN0YXRpYyB2b2lkIHNjaGVkX3VuaXRfYWRkX3ZjcHUoc3RydWN0IHNjaGVkX3VuaXQg
KnVuaXQsIHN0cnVjdCB2Y3B1ICp2KQogICAgIHVuaXQtPnJ1bnN0YXRlX2NudFt2LT5ydW5zdGF0
ZS5zdGF0ZV0rKzsKIH0KIAotc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9hbGxvY191
bml0KHN0cnVjdCB2Y3B1ICp2KQorc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9hbGxv
Y191bml0X21lbSh2b2lkKQogewotICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0LCAqKnByZXZf
dW5pdDsKLSAgICBzdHJ1Y3QgZG9tYWluICpkID0gdi0+ZG9tYWluOwotICAgIHVuc2lnbmVkIGlu
dCBncmFuID0gZC0+Y3B1cG9vbCA/IGQtPmNwdXBvb2wtPmdyYW51bGFyaXR5IDogMTsKKyAgICBz
dHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdDsKIAotICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1
bml0ICkKLSAgICAgICAgaWYgKCB1bml0LT52Y3B1LT52Y3B1X2lkIC8gZ3JhbiA9PSB2LT52Y3B1
X2lkIC8gZ3JhbiApCi0gICAgICAgICAgICBicmVhazsKKyAgICB1bml0ID0geHphbGxvYyhzdHJ1
Y3Qgc2NoZWRfdW5pdCk7CisgICAgaWYgKCAhdW5pdCApCisgICAgICAgIHJldHVybiBOVUxMOwog
Ci0gICAgaWYgKCB1bml0ICkKKyAgICBpZiAoICF6YWxsb2NfY3B1bWFza192YXIoJnVuaXQtPmNw
dV9oYXJkX2FmZmluaXR5KSB8fAorICAgICAgICAgIXphbGxvY19jcHVtYXNrX3ZhcigmdW5pdC0+
Y3B1X2hhcmRfYWZmaW5pdHlfdG1wKSB8fAorICAgICAgICAgIXphbGxvY19jcHVtYXNrX3Zhcigm
dW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHlfc2F2ZWQpIHx8CisgICAgICAgICAhemFsbG9jX2NwdW1h
c2tfdmFyKCZ1bml0LT5jcHVfc29mdF9hZmZpbml0eSkgKQogICAgIHsKLSAgICAgICAgc2NoZWRf
dW5pdF9hZGRfdmNwdSh1bml0LCB2KTsKLSAgICAgICAgcmV0dXJuIHVuaXQ7CisgICAgICAgIHNj
aGVkX2ZyZWVfdW5pdF9tZW0odW5pdCk7CisgICAgICAgIHVuaXQgPSBOVUxMOwogICAgIH0KIAot
ICAgIGlmICggKHVuaXQgPSB4emFsbG9jKHN0cnVjdCBzY2hlZF91bml0KSkgPT0gTlVMTCApCi0g
ICAgICAgIHJldHVybiBOVUxMOworICAgIHJldHVybiB1bml0OworfQorCitzdGF0aWMgdm9pZCBz
Y2hlZF9kb21haW5faW5zZXJ0X3VuaXQoc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQsIHN0cnVjdCBk
b21haW4gKmQpCit7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKipwcmV2X3VuaXQ7CiAKLSAgICBz
Y2hlZF91bml0X2FkZF92Y3B1KHVuaXQsIHYpOwogICAgIHVuaXQtPmRvbWFpbiA9IGQ7CiAKICAg
ICBmb3IgKCBwcmV2X3VuaXQgPSAmZC0+c2NoZWRfdW5pdF9saXN0OyAqcHJldl91bml0OwpAQCAt
NDMyLDE4ICs0MzYsMzEgQEAgc3RhdGljIHN0cnVjdCBzY2hlZF91bml0ICpzY2hlZF9hbGxvY191
bml0KHN0cnVjdCB2Y3B1ICp2KQogCiAgICAgdW5pdC0+bmV4dF9pbl9saXN0ID0gKnByZXZfdW5p
dDsKICAgICAqcHJldl91bml0ID0gdW5pdDsKK30KIAotICAgIGlmICggIXphbGxvY19jcHVtYXNr
X3ZhcigmdW5pdC0+Y3B1X2hhcmRfYWZmaW5pdHkpIHx8Ci0gICAgICAgICAhemFsbG9jX2NwdW1h
c2tfdmFyKCZ1bml0LT5jcHVfaGFyZF9hZmZpbml0eV90bXApIHx8Ci0gICAgICAgICAhemFsbG9j
X2NwdW1hc2tfdmFyKCZ1bml0LT5jcHVfaGFyZF9hZmZpbml0eV9zYXZlZCkgfHwKLSAgICAgICAg
ICF6YWxsb2NfY3B1bWFza192YXIoJnVuaXQtPmNwdV9zb2Z0X2FmZmluaXR5KSApCi0gICAgICAg
IGdvdG8gZmFpbDsKK3N0YXRpYyBzdHJ1Y3Qgc2NoZWRfdW5pdCAqc2NoZWRfYWxsb2NfdW5pdChz
dHJ1Y3QgdmNwdSAqdikKK3sKKyAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdDsKKyAgICBzdHJ1
Y3QgZG9tYWluICpkID0gdi0+ZG9tYWluOworICAgIHVuc2lnbmVkIGludCBncmFuID0gZC0+Y3B1
cG9vbCA/IGQtPmNwdXBvb2wtPmdyYW51bGFyaXR5IDogMTsKIAotICAgIHJldHVybiB1bml0Owor
ICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkKKyAgICAgICAgaWYgKCB1bml0LT52
Y3B1LT52Y3B1X2lkIC8gZ3JhbiA9PSB2LT52Y3B1X2lkIC8gZ3JhbiApCisgICAgICAgICAgICBi
cmVhazsKIAotIGZhaWw6Ci0gICAgc2NoZWRfZnJlZV91bml0KHVuaXQsIHYpOwotICAgIHJldHVy
biBOVUxMOworICAgIGlmICggdW5pdCApCisgICAgeworICAgICAgICBzY2hlZF91bml0X2FkZF92
Y3B1KHVuaXQsIHYpOworICAgICAgICByZXR1cm4gdW5pdDsKKyAgICB9CisKKyAgICBpZiAoICh1
bml0ID0gc2NoZWRfYWxsb2NfdW5pdF9tZW0oKSkgPT0gTlVMTCApCisgICAgICAgIHJldHVybiBO
VUxMOworCisgICAgc2NoZWRfdW5pdF9hZGRfdmNwdSh1bml0LCB2KTsKKyAgICBzY2hlZF9kb21h
aW5faW5zZXJ0X3VuaXQodW5pdCwgZCk7CisKKyAgICByZXR1cm4gdW5pdDsKIH0KIAogc3RhdGlj
IHVuc2lnbmVkIGludCBzY2hlZF9zZWxlY3RfaW5pdGlhbF9jcHUoY29uc3Qgc3RydWN0IHZjcHUg
KnYpCkBAIC0yMjgxLDE4ICsyMjk4LDI4IEBAIHN0YXRpYyB2b2lkIHBvbGxfdGltZXJfZm4odm9p
ZCAqZGF0YSkKICAgICAgICAgdmNwdV91bmJsb2NrKHYpOwogfQogCi1zdGF0aWMgaW50IGNwdV9z
Y2hlZHVsZV91cCh1bnNpZ25lZCBpbnQgY3B1KQorc3RhdGljIHN0cnVjdCBzY2hlZF9yZXNvdXJj
ZSAqc2NoZWRfYWxsb2NfcmVzKHZvaWQpCiB7CiAgICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpz
ZDsKIAogICAgIHNkID0geHphbGxvYyhzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UpOwogICAgIGlmICgg
c2QgPT0gTlVMTCApCi0gICAgICAgIHJldHVybiAtRU5PTUVNOworICAgICAgICByZXR1cm4gTlVM
TDsKICAgICBpZiAoICF6YWxsb2NfY3B1bWFza192YXIoJnNkLT5jcHVzKSApCiAgICAgewogICAg
ICAgICB4ZnJlZShzZCk7Ci0gICAgICAgIHJldHVybiAtRU5PTUVNOworICAgICAgICByZXR1cm4g
TlVMTDsKICAgICB9CisgICAgcmV0dXJuIHNkOworfQorCitzdGF0aWMgaW50IGNwdV9zY2hlZHVs
ZV91cCh1bnNpZ25lZCBpbnQgY3B1KQoreworICAgIHN0cnVjdCBzY2hlZF9yZXNvdXJjZSAqc2Q7
CisKKyAgICBzZCA9IHNjaGVkX2FsbG9jX3JlcygpOworICAgIGlmICggc2QgPT0gTlVMTCApCisg
ICAgICAgIHJldHVybiAtRU5PTUVNOwogCiAgICAgc2QtPnByb2Nlc3NvciA9IGNwdTsKICAgICBj
cHVtYXNrX2NvcHkoc2QtPmNwdXMsIGNwdW1hc2tfb2YoY3B1KSk7CkBAIC0yMzQ1LDYgKzIzNzIs
OCBAQCBzdGF0aWMgdm9pZCBzY2hlZF9yZXNfZnJlZShzdHJ1Y3QgcmN1X2hlYWQgKmhlYWQpCiAg
ICAgc3RydWN0IHNjaGVkX3Jlc291cmNlICpzZCA9IGNvbnRhaW5lcl9vZihoZWFkLCBzdHJ1Y3Qg
c2NoZWRfcmVzb3VyY2UsIHJjdSk7CiAKICAgICBmcmVlX2NwdW1hc2tfdmFyKHNkLT5jcHVzKTsK
KyAgICBpZiAoIHNkLT5zY2hlZF91bml0X2lkbGUgKQorICAgICAgICBzY2hlZF9mcmVlX3VuaXRf
bWVtKHNkLT5zY2hlZF91bml0X2lkbGUpOwogICAgIHhmcmVlKHNkKTsKIH0KIApAQCAtMjM1OSw2
ICsyMzg4LDggQEAgc3RhdGljIHZvaWQgY3B1X3NjaGVkdWxlX2Rvd24odW5zaWduZWQgaW50IGNw
dSkKICAgICBraWxsX3RpbWVyKCZzZC0+c190aW1lcik7CiAKICAgICBzZXRfc2NoZWRfcmVzKGNw
dSwgTlVMTCk7CisgICAgLyogS2VlcCBpZGxlIHVuaXQuICovCisgICAgc2QtPnNjaGVkX3VuaXRf
aWRsZSA9IE5VTEw7CiAgICAgY2FsbF9yY3UoJnNkLT5yY3UsIHNjaGVkX3Jlc19mcmVlKTsKIAog
ICAgIHJjdV9yZWFkX3VubG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwpAQCAtMjQzOCw2ICsyNDY5
LDMwIEBAIHN0YXRpYyBzdHJ1Y3Qgbm90aWZpZXJfYmxvY2sgY3B1X3NjaGVkdWxlX25mYiA9IHsK
ICAgICAubm90aWZpZXJfY2FsbCA9IGNwdV9zY2hlZHVsZV9jYWxsYmFjawogfTsKIAorc3RhdGlj
IGNvbnN0IGNwdW1hc2tfdCAqc2NoZWRfZ2V0X29wdF9jcHVtYXNrKGVudW0gc2NoZWRfZ3JhbiBv
cHQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWdu
ZWQgaW50IGNwdSkKK3sKKyAgICBjb25zdCBjcHVtYXNrX3QgKm1hc2s7CisKKyAgICBzd2l0Y2gg
KCBvcHQgKQorICAgIHsKKyAgICBjYXNlIFNDSEVEX0dSQU5fY3B1OgorICAgICAgICBtYXNrID0g
Y3B1bWFza19vZihjcHUpOworICAgICAgICBicmVhazsKKyAgICBjYXNlIFNDSEVEX0dSQU5fY29y
ZToKKyAgICAgICAgbWFzayA9IHBlcl9jcHUoY3B1X3NpYmxpbmdfbWFzaywgY3B1KTsKKyAgICAg
ICAgYnJlYWs7CisgICAgY2FzZSBTQ0hFRF9HUkFOX3NvY2tldDoKKyAgICAgICAgbWFzayA9IHBl
cl9jcHUoY3B1X2NvcmVfbWFzaywgY3B1KTsKKyAgICAgICAgYnJlYWs7CisgICAgZGVmYXVsdDoK
KyAgICAgICAgQVNTRVJUX1VOUkVBQ0hBQkxFKCk7CisgICAgICAgIHJldHVybiBOVUxMOworICAg
IH0KKworICAgIHJldHVybiBtYXNrOworfQorCiAvKiBJbml0aWFsaXNlIHRoZSBkYXRhIHN0cnVj
dHVyZXMuICovCiB2b2lkIF9faW5pdCBzY2hlZHVsZXJfaW5pdCh2b2lkKQogewpAQCAtMjU5Niw2
ICsyNjUxLDQ2IEBAIGludCBzY2hlZHVsZV9jcHVfYWRkKHVuc2lnbmVkIGludCBjcHUsIHN0cnVj
dCBjcHVwb29sICpjKQogICAgICAqLwogICAgIG9sZF9sb2NrID0gcGNwdV9zY2hlZHVsZV9sb2Nr
X2lycXNhdmUoY3B1LCAmZmxhZ3MpOwogCisgICAgaWYgKCBjLT5ncmFudWxhcml0eSA+IDEgKQor
ICAgIHsKKyAgICAgICAgY29uc3QgY3B1bWFza190ICptYXNrOworICAgICAgICB1bnNpZ25lZCBp
bnQgY3B1X2l0ZXIsIGlkeCA9IDA7CisgICAgICAgIHN0cnVjdCBzY2hlZF91bml0ICpvbGRfdW5p
dCwgKm1hc3Rlcl91bml0OworICAgICAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkX29sZDsK
KworICAgICAgICAvKgorICAgICAgICAgKiBXZSBuZWVkIHRvIG1lcmdlIG11bHRpcGxlIGlkbGVf
dmNwdSB1bml0cyBhbmQgc2NoZWRfcmVzb3VyY2Ugc3RydWN0cworICAgICAgICAgKiBpbnRvIG9u
ZS4gQXMgdGhlIGZyZWUgY3B1cyBhbGwgc2hhcmUgdGhlIHNhbWUgbG9jayB3ZSBhcmUgZmluZSBk
b2luZworICAgICAgICAgKiB0aGF0IG5vdy4gVGhlIHdvcnN0IHdoaWNoIGNvdWxkIGhhcHBlbiB3
b3VsZCBiZSBzb21lb25lIHdhaXRpbmcgZm9yCisgICAgICAgICAqIHRoZSBsb2NrLCB0aHVzIGRl
cmVmZXJlbmNpbmcgc2NoZWRfcmVzLT5zY2hlZHVsZV9sb2NrLiBUaGlzIGlzIHRoZQorICAgICAg
ICAgKiByZWFzb24gd2UgYXJlIGZyZWVpbmcgc3RydWN0IHNjaGVkX3JlcyB2aWEgY2FsbF9yY3Uo
KSB0byBhdm9pZCB0aGUKKyAgICAgICAgICogbG9jayBwb2ludGVyIHN1ZGRlbmx5IGRpc2FwcGVh
cmluZy4KKyAgICAgICAgICovCisgICAgICAgIG1hc2sgPSBzY2hlZF9nZXRfb3B0X2NwdW1hc2so
Yy0+b3B0X2dyYW51bGFyaXR5LCBjcHUpOworICAgICAgICBtYXN0ZXJfdW5pdCA9IGlkbGVfdmNw
dVtjcHVdLT5zY2hlZF91bml0OworCisgICAgICAgIGZvcl9lYWNoX2NwdSAoIGNwdV9pdGVyLCBt
YXNrICkKKyAgICAgICAgeworICAgICAgICAgICAgaWYgKCBpZHggKQorICAgICAgICAgICAgICAg
IGNwdW1hc2tfY2xlYXJfY3B1KGNwdV9pdGVyLCBzY2hlZF9yZXNfbWFzayk7CisKKyAgICAgICAg
ICAgIHBlcl9jcHUoc2NoZWRfcmVzX2lkeCwgY3B1X2l0ZXIpID0gaWR4Kys7CisKKyAgICAgICAg
ICAgIGlmICggY3B1ID09IGNwdV9pdGVyICkKKyAgICAgICAgICAgICAgICBjb250aW51ZTsKKwor
ICAgICAgICAgICAgb2xkX3VuaXQgPSBpZGxlX3ZjcHVbY3B1X2l0ZXJdLT5zY2hlZF91bml0Owor
ICAgICAgICAgICAgc2Rfb2xkID0gZ2V0X3NjaGVkX3JlcyhjcHVfaXRlcik7CisgICAgICAgICAg
ICBraWxsX3RpbWVyKCZzZF9vbGQtPnNfdGltZXIpOworICAgICAgICAgICAgaWRsZV92Y3B1W2Nw
dV9pdGVyXS0+c2NoZWRfdW5pdCA9IG1hc3Rlcl91bml0OworICAgICAgICAgICAgbWFzdGVyX3Vu
aXQtPnJ1bnN0YXRlX2NudFtSVU5TVEFURV9ydW5uaW5nXSsrOworICAgICAgICAgICAgc2V0X3Nj
aGVkX3JlcyhjcHVfaXRlciwgc2QpOworICAgICAgICAgICAgY3B1bWFza19zZXRfY3B1KGNwdV9p
dGVyLCBzZC0+Y3B1cyk7CisKKyAgICAgICAgICAgIGNhbGxfcmN1KCZzZF9vbGQtPnJjdSwgc2No
ZWRfcmVzX2ZyZWUpOworICAgICAgICB9CisgICAgfQorCiAgICAgbmV3X2xvY2sgPSBzY2hlZF9z
d2l0Y2hfc2NoZWQobmV3X29wcywgY3B1LCBwcHJpdiwgdnByaXYpOwogCiAgICAgc2QtPnNjaGVk
dWxlciA9IG5ld19vcHM7CkBAIC0yNjMzLDMzICsyNzI4LDEwMCBAQCBvdXQ6CiAgKi8KIGludCBz
Y2hlZHVsZV9jcHVfcm0odW5zaWduZWQgaW50IGNwdSkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAqaWRs
ZTsKICAgICB2b2lkICpwcHJpdl9vbGQsICp2cHJpdl9vbGQ7Ci0gICAgc3RydWN0IHNjaGVkX3Jl
c291cmNlICpzZDsKKyAgICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnNkLCAqKnNkX25ldyA9IE5V
TEw7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAgICAgc3RydWN0IHNjaGVkdWxlciAq
b2xkX29wczsKICAgICBzcGlubG9ja190ICpvbGRfbG9jazsKICAgICB1bnNpZ25lZCBsb25nIGZs
YWdzOworICAgIGludCBpZHgsIHJldCA9IC1FTk9NRU07CisgICAgdW5zaWduZWQgaW50IGNwdV9p
dGVyOwogCiAgICAgcmN1X3JlYWRfbG9jaygmc2NoZWRfcmVzX3JjdWxvY2spOwogCiAgICAgc2Qg
PSBnZXRfc2NoZWRfcmVzKGNwdSk7CiAgICAgb2xkX29wcyA9IHNkLT5zY2hlZHVsZXI7CiAKKyAg
ICBpZiAoIHNkLT5ncmFudWxhcml0eSA+IDEgKQorICAgIHsKKyAgICAgICAgc2RfbmV3ID0geG1h
bGxvY19hcnJheShzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKiwgc2QtPmdyYW51bGFyaXR5IC0gMSk7
CisgICAgICAgIGlmICggIXNkX25ldyApCisgICAgICAgICAgICBnb3RvIG91dDsKKyAgICAgICAg
Zm9yICggaWR4ID0gMDsgaWR4IDwgc2QtPmdyYW51bGFyaXR5IC0gMTsgaWR4KysgKQorICAgICAg
ICB7CisgICAgICAgICAgICBzZF9uZXdbaWR4XSA9IHNjaGVkX2FsbG9jX3JlcygpOworICAgICAg
ICAgICAgaWYgKCBzZF9uZXdbaWR4XSApCisgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAg
c2RfbmV3W2lkeF0tPnNjaGVkX3VuaXRfaWRsZSA9IHNjaGVkX2FsbG9jX3VuaXRfbWVtKCk7Cisg
ICAgICAgICAgICAgICAgaWYgKCAhc2RfbmV3W2lkeF0tPnNjaGVkX3VuaXRfaWRsZSApCisgICAg
ICAgICAgICAgICAgeworICAgICAgICAgICAgICAgICAgICBzY2hlZF9yZXNfZnJlZSgmc2RfbmV3
W2lkeF0tPnJjdSk7CisgICAgICAgICAgICAgICAgICAgIHNkX25ld1tpZHhdID0gTlVMTDsKKyAg
ICAgICAgICAgICAgICB9CisgICAgICAgICAgICB9CisgICAgICAgICAgICBpZiAoICFzZF9uZXdb
aWR4XSApCisgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgZm9yICggaWR4LS07IGlkeCA+
PSAwOyBpZHgtLSApCisgICAgICAgICAgICAgICAgICAgIHNjaGVkX3Jlc19mcmVlKCZzZF9uZXdb
aWR4XS0+cmN1KTsKKyAgICAgICAgICAgICAgICBnb3RvIG91dDsKKyAgICAgICAgICAgIH0KKyAg
ICAgICAgICAgIHNkX25ld1tpZHhdLT5jdXJyID0gc2RfbmV3W2lkeF0tPnNjaGVkX3VuaXRfaWRs
ZTsKKyAgICAgICAgICAgIHNkX25ld1tpZHhdLT5zY2hlZHVsZXIgPSAmc2NoZWRfaWRsZV9vcHM7
CisgICAgICAgICAgICBzZF9uZXdbaWR4XS0+Z3JhbnVsYXJpdHkgPSAxOworCisgICAgICAgICAg
ICAvKiBXZSB3YW50IHRoZSBsb2NrIG5vdCB0byBjaGFuZ2Ugd2hlbiByZXBsYWNpbmcgdGhlIHJl
c291cmNlLiAqLworICAgICAgICAgICAgc2RfbmV3W2lkeF0tPnNjaGVkdWxlX2xvY2sgPSBzZC0+
c2NoZWR1bGVfbG9jazsKKyAgICAgICAgfQorICAgIH0KKworICAgIHJldCA9IDA7CiAgICAgQVNT
RVJUKHNkLT5jcHVwb29sICE9IE5VTEwpOwogICAgIEFTU0VSVChjcHVtYXNrX3Rlc3RfY3B1KGNw
dSwgJmNwdXBvb2xfZnJlZV9jcHVzKSk7CiAgICAgQVNTRVJUKCFjcHVtYXNrX3Rlc3RfY3B1KGNw
dSwgc2QtPmNwdXBvb2wtPmNwdV92YWxpZCkpOwogCi0gICAgaWRsZSA9IGlkbGVfdmNwdVtjcHVd
OwotCiAgICAgc2NoZWRfZG9fdGlja19zdXNwZW5kKG9sZF9vcHMsIGNwdSk7CiAKICAgICAvKiBT
ZWUgY29tbWVudCBpbiBzY2hlZHVsZV9jcHVfYWRkKCkgcmVnYXJkaW5nIGxvY2sgc3dpdGNoaW5n
LiAqLwogICAgIG9sZF9sb2NrID0gcGNwdV9zY2hlZHVsZV9sb2NrX2lycXNhdmUoY3B1LCAmZmxh
Z3MpOwogCi0gICAgdnByaXZfb2xkID0gaWRsZS0+c2NoZWRfdW5pdC0+cHJpdjsKKyAgICB2cHJp
dl9vbGQgPSBpZGxlX3ZjcHVbY3B1XS0+c2NoZWRfdW5pdC0+cHJpdjsKICAgICBwcHJpdl9vbGQg
PSBzZC0+c2NoZWRfcHJpdjsKIAotICAgIGlkbGUtPnNjaGVkX3VuaXQtPnByaXYgPSBOVUxMOwor
ICAgIGlkeCA9IDA7CisgICAgZm9yX2VhY2hfY3B1ICggY3B1X2l0ZXIsIHNkLT5jcHVzICkKKyAg
ICB7CisgICAgICAgIHBlcl9jcHUoc2NoZWRfcmVzX2lkeCwgY3B1X2l0ZXIpID0gMDsKKyAgICAg
ICAgaWYgKCBjcHVfaXRlciA9PSBjcHUgKQorICAgICAgICB7CisgICAgICAgICAgICBpZGxlX3Zj
cHVbY3B1X2l0ZXJdLT5zY2hlZF91bml0LT5wcml2ID0gTlVMTDsKKyAgICAgICAgfQorICAgICAg
ICBlbHNlCisgICAgICAgIHsKKyAgICAgICAgICAgIC8qIEluaXRpYWxpemUgdW5pdC4gKi8KKyAg
ICAgICAgICAgIHVuaXQgPSBzZF9uZXdbaWR4XS0+c2NoZWRfdW5pdF9pZGxlOworICAgICAgICAg
ICAgdW5pdC0+cmVzID0gc2RfbmV3W2lkeF07CisgICAgICAgICAgICB1bml0LT5pc19ydW5uaW5n
ID0gdHJ1ZTsKKyAgICAgICAgICAgIHNjaGVkX3VuaXRfYWRkX3ZjcHUodW5pdCwgaWRsZV92Y3B1
W2NwdV9pdGVyXSk7CisgICAgICAgICAgICBzY2hlZF9kb21haW5faW5zZXJ0X3VuaXQodW5pdCwg
aWRsZV92Y3B1W2NwdV9pdGVyXS0+ZG9tYWluKTsKKworICAgICAgICAgICAgLyogQWRqdXN0IGNw
dSBtYXNrcyBvZiByZXNvdXJjZXMgKG9sZCBhbmQgbmV3KS4gKi8KKyAgICAgICAgICAgIGNwdW1h
c2tfY2xlYXJfY3B1KGNwdV9pdGVyLCBzZC0+Y3B1cyk7CisgICAgICAgICAgICBjcHVtYXNrX3Nl
dF9jcHUoY3B1X2l0ZXIsIHNkX25ld1tpZHhdLT5jcHVzKTsKKworICAgICAgICAgICAgLyogSW5p
dCB0aW1lci4gKi8KKyAgICAgICAgICAgIGluaXRfdGltZXIoJnNkX25ld1tpZHhdLT5zX3RpbWVy
LCBzX3RpbWVyX2ZuLCBOVUxMLCBjcHVfaXRlcik7CisKKyAgICAgICAgICAgIC8qIExhc3QgcmVz
b3VyY2UgaW5pdGlhbGl6YXRpb25zIGFuZCBpbnNlcnQgcmVzb3VyY2UgcG9pbnRlci4gKi8KKyAg
ICAgICAgICAgIHNkX25ld1tpZHhdLT5wcm9jZXNzb3IgPSBjcHVfaXRlcjsKKyAgICAgICAgICAg
IHNldF9zY2hlZF9yZXMoY3B1X2l0ZXIsIHNkX25ld1tpZHhdKTsKKworICAgICAgICAgICAgLyog
TGFzdCBhY3Rpb246IHNldCB0aGUgbmV3IGxvY2sgcG9pbnRlci4gKi8KKyAgICAgICAgICAgIHNt
cF9tYigpOworICAgICAgICAgICAgc2RfbmV3W2lkeF0tPnNjaGVkdWxlX2xvY2sgPSAmc2NoZWRf
ZnJlZV9jcHVfbG9jazsKKworICAgICAgICAgICAgaWR4Kys7CisgICAgICAgIH0KKyAgICB9CiAg
ICAgc2QtPnNjaGVkdWxlciA9ICZzY2hlZF9pZGxlX29wczsKICAgICBzZC0+c2NoZWRfcHJpdiA9
IE5VTEw7CiAKQEAgLTI2NzcsOSArMjgzOSwxMSBAQCBpbnQgc2NoZWR1bGVfY3B1X3JtKHVuc2ln
bmVkIGludCBjcHUpCiAgICAgc2QtPmdyYW51bGFyaXR5ID0gMTsKICAgICBzZC0+Y3B1cG9vbCA9
IE5VTEw7CiAKK291dDoKICAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsK
KyAgICB4ZnJlZShzZF9uZXcpOwogCi0gICAgcmV0dXJuIDA7CisgICAgcmV0dXJuIHJldDsKIH0K
IAogc3RydWN0IHNjaGVkdWxlciAqc2NoZWR1bGVyX2dldF9kZWZhdWx0KHZvaWQpCi0tIAoyLjE2
LjQKCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpYZW4t
ZGV2ZWwgbWFpbGluZyBsaXN0Clhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0Lm9yZwpodHRwczov
L2xpc3RzLnhlbnByb2plY3Qub3JnL21haWxtYW4vbGlzdGluZm8veGVuLWRldmVs

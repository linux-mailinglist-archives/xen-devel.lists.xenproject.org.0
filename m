Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 742FDCB491
	for <lists+xen-devel@lfdr.de>; Fri,  4 Oct 2019 08:44:01 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iGHGG-0005xS-Mr; Fri, 04 Oct 2019 06:40:20 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=lyic=X5=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1iGHGF-0005wd-1G
 for xen-devel@lists.xenproject.org; Fri, 04 Oct 2019 06:40:19 +0000
X-Inumbo-ID: d17db1fc-e671-11e9-973f-12813bfff9fa
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id d17db1fc-e671-11e9-973f-12813bfff9fa;
 Fri, 04 Oct 2019 06:40:13 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id B7FFBB149;
 Fri,  4 Oct 2019 06:40:12 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Fri,  4 Oct 2019 08:40:10 +0200
Message-Id: <20191004064010.25646-1-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
Subject: [Xen-devel] [PATCH] xen/sched: fix locking in
 sched_tick_[suspend|resume]()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

c2NoZWRfdGlja19zdXNwZW5kKCkgYW5kIHNjaGVkX3RpY2tfcmVzdW1lKCkgc2hvdWxkIG5vdCBj
YWxsIHRoZQpzY2hlZHVsZXIgc3BlY2lmaWMgdGltZXIgaGFuZGxlcnMgaW4gY2FzZSB0aGUgY3B1
IHRoZXkgYXJlIHJ1bm5pbmcgb24KaXMganVzdCBiZWluZyBtb3ZlZCB0byBvciBmcm9tIGEgY3B1
cG9vbC4KClVzZSBhIG5ldyBwZXJjcHUgbG9jayBmb3IgdGhhdCBwdXJwb3NlLgoKUmVwb3J0ZWQt
Ynk6IFNlcmdleSBEeWFzbGkgPHNlcmdleS5keWFzbGlAY2l0cml4LmNvbT4KU2lnbmVkLW9mZi1i
eTogSnVlcmdlbiBHcm9zcyA8amdyb3NzQHN1c2UuY29tPgotLS0KVG8gYmUgYXBwbGllZCBvbiB0
b3Agb2YgbXkgY29yZSBzY2hlZHVsaW5nIHNlcmllcy4KLS0tCiB4ZW4vY29tbW9uL3NjaGVkdWxl
LmMgfCAyNyArKysrKysrKysrKysrKysrKysrKysrKysrKysKIDEgZmlsZSBjaGFuZ2VkLCAyNyBp
bnNlcnRpb25zKCspCgpkaWZmIC0tZ2l0IGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jIGIveGVuL2Nv
bW1vbi9zY2hlZHVsZS5jCmluZGV4IDIxN2ZjYjA5Y2UuLjc0NGY4Y2I1ZGIgMTAwNjQ0Ci0tLSBh
L3hlbi9jb21tb24vc2NoZWR1bGUuYworKysgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKQEAgLTY4
LDYgKzY4LDkgQEAgY3B1bWFza190IHNjaGVkX3Jlc19tYXNrOwogLyogQ29tbW9uIGxvY2sgZm9y
IGZyZWUgY3B1cy4gKi8KIHN0YXRpYyBERUZJTkVfU1BJTkxPQ0soc2NoZWRfZnJlZV9jcHVfbG9j
ayk7CiAKKy8qIExvY2sgZm9yIGd1YXJkaW5nIHBlci1zY2hlZHVsZXIgY2FsbHMgYWdhaW5zdCBz
Y2hlZHVsZXIgY2hhbmdlcyBvbiBhIGNwdS4gKi8KK3N0YXRpYyBERUZJTkVfUEVSX0NQVShzcGlu
bG9ja190LCBzY2hlZF9jcHVfbG9jayk7CisKIC8qIFZhcmlvdXMgdGltZXIgaGFuZGxlcnMuICov
CiBzdGF0aWMgdm9pZCBzX3RpbWVyX2ZuKHZvaWQgKnVudXNlZCk7CiBzdGF0aWMgdm9pZCB2Y3B1
X3BlcmlvZGljX3RpbWVyX2ZuKHZvaWQgKmRhdGEpOwpAQCAtMjQ3Miw2ICsyNDc1LDggQEAgc3Rh
dGljIGludCBjcHVfc2NoZWR1bGVfdXAodW5zaWduZWQgaW50IGNwdSkKICAgICBpZiAoIHNyID09
IE5VTEwgKQogICAgICAgICByZXR1cm4gLUVOT01FTTsKIAorICAgIHNwaW5fbG9ja19pbml0KCZw
ZXJfY3B1KHNjaGVkX2NwdV9sb2NrLCBjcHUpKTsKKwogICAgIHNyLT5tYXN0ZXJfY3B1ID0gY3B1
OwogICAgIGNwdW1hc2tfY29weShzci0+Y3B1cywgY3B1bWFza19vZihjcHUpKTsKICAgICBzZXRf
c2NoZWRfcmVzKGNwdSwgc3IpOwpAQCAtMjc2MywxMSArMjc2OCwxNCBAQCBpbnQgc2NoZWR1bGVf
Y3B1X2FkZCh1bnNpZ25lZCBpbnQgY3B1LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICBzdHJ1Y3Qg
c2NoZWR1bGVyICpuZXdfb3BzID0gYy0+c2NoZWQ7CiAgICAgc3RydWN0IHNjaGVkX3Jlc291cmNl
ICpzcjsKICAgICBzcGlubG9ja190ICpvbGRfbG9jaywgKm5ld19sb2NrOworICAgIHNwaW5sb2Nr
X3QgKmNwdV9sb2NrID0gJnBlcl9jcHUoc2NoZWRfY3B1X2xvY2ssIGNwdSk7CiAgICAgdW5zaWdu
ZWQgbG9uZyBmbGFnczsKICAgICBpbnQgcmV0ID0gMDsKIAogICAgIHJjdV9yZWFkX2xvY2soJnNj
aGVkX3Jlc19yY3Vsb2NrKTsKIAorICAgIHNwaW5fbG9jayhjcHVfbG9jayk7CisKICAgICBzciA9
IGdldF9zY2hlZF9yZXMoY3B1KTsKIAogICAgIEFTU0VSVChjcHVtYXNrX3Rlc3RfY3B1KGNwdSwg
JmNwdXBvb2xfZnJlZV9jcHVzKSk7CkBAIC0yODc5LDYgKzI4ODcsOCBAQCBpbnQgc2NoZWR1bGVf
Y3B1X2FkZCh1bnNpZ25lZCBpbnQgY3B1LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICBjcHVfcmFp
c2Vfc29mdGlycShjcHUsIFNDSEVEVUxFX1NPRlRJUlEpOwogCiBvdXQ6CisgICAgc3Bpbl91bmxv
Y2soY3B1X2xvY2spOworCiAgICAgcmN1X3JlYWRfdW5sb2NrKCZzY2hlZF9yZXNfcmN1bG9jayk7
CiAKICAgICByZXR1cm4gcmV0OwpAQCAtMjg5NywxMiArMjkwNywxNSBAQCBpbnQgc2NoZWR1bGVf
Y3B1X3JtKHVuc2lnbmVkIGludCBjcHUpCiAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAg
ICAgc3RydWN0IHNjaGVkdWxlciAqb2xkX29wczsKICAgICBzcGlubG9ja190ICpvbGRfbG9jazsK
KyAgICBzcGlubG9ja190ICpjcHVfbG9jayA9ICZwZXJfY3B1KHNjaGVkX2NwdV9sb2NrLCBjcHUp
OwogICAgIHVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAgICAgaW50IGlkeCwgcmV0ID0gLUVOT01FTTsK
ICAgICB1bnNpZ25lZCBpbnQgY3B1X2l0ZXI7CiAKICAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9y
ZXNfcmN1bG9jayk7CiAKKyAgICBzcGluX2xvY2soY3B1X2xvY2spOworCiAgICAgc3IgPSBnZXRf
c2NoZWRfcmVzKGNwdSk7CiAgICAgb2xkX29wcyA9IHNyLT5zY2hlZHVsZXI7CiAKQEAgLTMwMDQs
NiArMzAxNyw4IEBAIGludCBzY2hlZHVsZV9jcHVfcm0odW5zaWduZWQgaW50IGNwdSkKICAgICBz
ci0+Y3B1cG9vbCA9IE5VTEw7CiAKIG91dDoKKyAgICBzcGluX3VubG9jayhjcHVfbG9jayk7CisK
ICAgICByY3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKICAgICB4ZnJlZShzcl9u
ZXcpOwogCkBAIC0zMDg0LDExICszMDk5LDE3IEBAIHZvaWQgc2NoZWRfdGlja19zdXNwZW5kKHZv
aWQpCiB7CiAgICAgc3RydWN0IHNjaGVkdWxlciAqc2NoZWQ7CiAgICAgdW5zaWduZWQgaW50IGNw
dSA9IHNtcF9wcm9jZXNzb3JfaWQoKTsKKyAgICBzcGlubG9ja190ICpsb2NrID0gJnBlcl9jcHUo
c2NoZWRfY3B1X2xvY2ssIGNwdSk7CiAKICAgICByY3VfcmVhZF9sb2NrKCZzY2hlZF9yZXNfcmN1
bG9jayk7CiAKKyAgICBzcGluX2xvY2sobG9jayk7CisKICAgICBzY2hlZCA9IGdldF9zY2hlZF9y
ZXMoY3B1KS0+c2NoZWR1bGVyOwogICAgIHNjaGVkX2RvX3RpY2tfc3VzcGVuZChzY2hlZCwgY3B1
KTsKKworICAgIHNwaW5fdW5sb2NrKGxvY2spOworCiAgICAgcmN1X2lkbGVfZW50ZXIoY3B1KTsK
ICAgICByY3VfaWRsZV90aW1lcl9zdGFydCgpOwogCkBAIC0zMDk5LDE0ICszMTIwLDIwIEBAIHZv
aWQgc2NoZWRfdGlja19yZXN1bWUodm9pZCkKIHsKICAgICBzdHJ1Y3Qgc2NoZWR1bGVyICpzY2hl
ZDsKICAgICB1bnNpZ25lZCBpbnQgY3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOworICAgIHNwaW5s
b2NrX3QgKmxvY2sgPSAmcGVyX2NwdShzY2hlZF9jcHVfbG9jaywgY3B1KTsKIAogICAgIHJjdV9y
ZWFkX2xvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIAogICAgIHJjdV9pZGxlX3RpbWVyX3N0b3Ao
KTsKICAgICByY3VfaWRsZV9leGl0KGNwdSk7CisKKyAgICBzcGluX2xvY2sobG9jayk7CisKICAg
ICBzY2hlZCA9IGdldF9zY2hlZF9yZXMoY3B1KS0+c2NoZWR1bGVyOwogICAgIHNjaGVkX2RvX3Rp
Y2tfcmVzdW1lKHNjaGVkLCBjcHUpOwogCisgICAgc3Bpbl91bmxvY2sobG9jayk7CisKICAgICBy
Y3VfcmVhZF91bmxvY2soJnNjaGVkX3Jlc19yY3Vsb2NrKTsKIH0KIAotLSAKMi4xNi40CgoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1h
aWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54
ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hlbi1kZXZlbA==

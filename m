Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 2F051B2A93
	for <lists+xen-devel@lfdr.de>; Sat, 14 Sep 2019 10:55:29 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1i93o4-0007oX-QJ; Sat, 14 Sep 2019 08:53:24 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=rDpt=XJ=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1i93o2-0007mv-UT
 for xen-devel@lists.xenproject.org; Sat, 14 Sep 2019 08:53:22 +0000
X-Inumbo-ID: 0fd8876a-d6cd-11e9-b299-bc764e2007e4
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-rack-iad1.inumbo.com (Halon) with ESMTPS
 id 0fd8876a-d6cd-11e9-b299-bc764e2007e4;
 Sat, 14 Sep 2019 08:53:03 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 28289B66E;
 Sat, 14 Sep 2019 08:53:02 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Sat, 14 Sep 2019 10:52:28 +0200
Message-Id: <20190914085251.18816-25-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190914085251.18816-1-jgross@suse.com>
References: <20190914085251.18816-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH v3 24/47] xen: switch from for_each_vcpu() to
 for_each_sched_unit()
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <George.Dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Tim Deegan <tim@xen.org>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>,
 Dario Faggioli <dfaggioli@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

V2hlcmUgYXBwcm9wcmlhdGUgc3dpdGNoIGZyb20gZm9yX2VhY2hfdmNwdSgpIHRvIGZvcl9lYWNo
X3NjaGVkX3VuaXQoKQppbiBvcmRlciB0byBwcmVwYXJlIGNvcmUgc2NoZWR1bGluZy4KCkFzIGl0
IGlzIGJlbmVmaWNpYWwgb25jZSBoZXJlIGFuZCBmb3Igc3VyZSBpbiBmdXR1cmUgYWRkIGEKdW5p
dF9zY2hlZHVsZXIoKSBoZWxwZXIgYW5kIGxldCB2Y3B1X3NjaGVkdWxlcigpIHVzZSBpdC4KClNp
Z25lZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tClYyOgotIGhh
bmRsZSBhZmZpbml0eV9icm9rZW4gY29ycmVjdGx5IChKYW4gQmV1bGljaCkKLSBhZGQgdW5pdF9z
Y2hlZHVsZXIoKSAoSmFuIEJldWxpY2gpClYzOgotIGFkZCBjb25zdCAoSmFuIEJldWxpY2gpCi0g
YWRkIFRPRE9zIGZvciBtaXNzaW5nIG11bHRpcGxlIHZjcHUgcGVyIHVuaXQgc3VwcG9ydCAoSmFu
IEJldWxpY2gpCi0tLQogeGVuL2NvbW1vbi9kb21haW4uYyAgIHwgICA5ICsrLQogeGVuL2NvbW1v
bi9zY2hlZHVsZS5jIHwgMTU4ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0t
LS0tLS0tLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDEwMyBpbnNlcnRpb25zKCspLCA2NCBkZWxl
dGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29tbW9uL2RvbWFpbi5jIGIveGVuL2NvbW1vbi9k
b21haW4uYwppbmRleCBhM2UyM2YyZWU3Li43YTFiZTg1YmU5IDEwMDY0NAotLS0gYS94ZW4vY29t
bW9uL2RvbWFpbi5jCisrKyBiL3hlbi9jb21tb24vZG9tYWluLmMKQEAgLTU1NCw3ICs1NTQsNyBA
QCB2b2lkIGRvbWFpbl91cGRhdGVfbm9kZV9hZmZpbml0eShzdHJ1Y3QgZG9tYWluICpkKQogICAg
IGNwdW1hc2tfdmFyX3QgZG9tX2NwdW1hc2ssIGRvbV9jcHVtYXNrX3NvZnQ7CiAgICAgY3B1bWFz
a190ICpkb21fYWZmaW5pdHk7CiAgICAgY29uc3QgY3B1bWFza190ICpvbmxpbmU7Ci0gICAgc3Ry
dWN0IHZjcHUgKnY7CisgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQ7CiAgICAgdW5zaWduZWQg
aW50IGNwdTsKIAogICAgIC8qIERvIHdlIGhhdmUgdmNwdXMgYWxyZWFkeT8gSWYgbm90LCBubyBu
ZWVkIHRvIHVwZGF0ZSBub2RlLWFmZmluaXR5LiAqLwpAQCAtNTg3LDEyICs1ODcsMTEgQEAgdm9p
ZCBkb21haW5fdXBkYXRlX25vZGVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAg
ICogYW5kIHRoZSBmdWxsIG1hc2sgb2Ygd2hlcmUgaXQgd291bGQgcHJlZmVyIHRvIHJ1biAodGhl
IHVuaW9uIG9mCiAgICAgICAgICAqIHRoZSBzb2Z0IGFmZmluaXR5IG9mIGFsbCBpdHMgdmFyaW91
cyB2Y3B1cykuIExldCdzIGJ1aWxkIHRoZW0uCiAgICAgICAgICAqLwotICAgICAgICBmb3JfZWFj
aF92Y3B1ICggZCwgdiApCisgICAgICAgIGZvcl9lYWNoX3NjaGVkX3VuaXQgKCBkLCB1bml0ICkK
ICAgICAgICAgewotICAgICAgICAgICAgY3B1bWFza19vcihkb21fY3B1bWFzaywgZG9tX2NwdW1h
c2ssCi0gICAgICAgICAgICAgICAgICAgICAgIHYtPnNjaGVkX3VuaXQtPmNwdV9oYXJkX2FmZmlu
aXR5KTsKKyAgICAgICAgICAgIGNwdW1hc2tfb3IoZG9tX2NwdW1hc2ssIGRvbV9jcHVtYXNrLCB1
bml0LT5jcHVfaGFyZF9hZmZpbml0eSk7CiAgICAgICAgICAgICBjcHVtYXNrX29yKGRvbV9jcHVt
YXNrX3NvZnQsIGRvbV9jcHVtYXNrX3NvZnQsCi0gICAgICAgICAgICAgICAgICAgICAgIHYtPnNj
aGVkX3VuaXQtPmNwdV9zb2Z0X2FmZmluaXR5KTsKKyAgICAgICAgICAgICAgICAgICAgICAgdW5p
dC0+Y3B1X3NvZnRfYWZmaW5pdHkpOwogICAgICAgICB9CiAgICAgICAgIC8qIEZpbHRlciBvdXQg
bm9uLW9ubGluZSBjcHVzICovCiAgICAgICAgIGNwdW1hc2tfYW5kKGRvbV9jcHVtYXNrLCBkb21f
Y3B1bWFzaywgb25saW5lKTsKZGlmZiAtLWdpdCBhL3hlbi9jb21tb24vc2NoZWR1bGUuYyBiL3hl
bi9jb21tb24vc2NoZWR1bGUuYwppbmRleCA5YzQxYjJkZDRkLi43YjM3NDYxZGI5IDEwMDY0NAot
LS0gYS94ZW4vY29tbW9uL3NjaGVkdWxlLmMKKysrIGIveGVuL2NvbW1vbi9zY2hlZHVsZS5jCkBA
IC0xNTAsMjYgKzE1MCwzMiBAQCBzdGF0aWMgaW5saW5lIHN0cnVjdCBzY2hlZHVsZXIgKmRvbV9z
Y2hlZHVsZXIoY29uc3Qgc3RydWN0IGRvbWFpbiAqZCkKICAgICByZXR1cm4gJm9wczsKIH0KIAot
c3RhdGljIGlubGluZSBzdHJ1Y3Qgc2NoZWR1bGVyICp2Y3B1X3NjaGVkdWxlcihjb25zdCBzdHJ1
Y3QgdmNwdSAqdikKK3N0YXRpYyBpbmxpbmUgc3RydWN0IHNjaGVkdWxlciAqdW5pdF9zY2hlZHVs
ZXIoY29uc3Qgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQpCiB7Ci0gICAgc3RydWN0IGRvbWFpbiAq
ZCA9IHYtPmRvbWFpbjsKKyAgICBzdHJ1Y3QgZG9tYWluICpkID0gdW5pdC0+ZG9tYWluOwogCiAg
ICAgaWYgKCBsaWtlbHkoZC0+Y3B1cG9vbCAhPSBOVUxMKSApCiAgICAgICAgIHJldHVybiBkLT5j
cHVwb29sLT5zY2hlZDsKIAogICAgIC8qCi0gICAgICogSWYgZC0+Y3B1cG9vbCBpcyBOVUxMLCB0
aGlzIGlzIGEgdkNQVSBvZiB0aGUgaWRsZSBkb21haW4uIEFuZCB0aGlzCisgICAgICogSWYgZC0+
Y3B1cG9vbCBpcyBOVUxMLCB0aGlzIGlzIGEgdW5pdCBvZiB0aGUgaWRsZSBkb21haW4uIEFuZCB0
aGlzCiAgICAgICogY2FzZSBpcyBzcGVjaWFsIGJlY2F1c2UgdGhlIGlkbGUgZG9tYWluIGRvZXMg
bm90IHJlYWxseSBiZWxvbmcgdG8KICAgICAgKiBhIGNwdXBvb2wgYW5kLCBoZW5jZSwgZG9lc24n
dCByZWFsbHkgaGF2ZSBhIHNjaGVkdWxlcikuIEluIGZhY3QsIGl0cwotICAgICAqIHZDUFVzICht
YXkpIHJ1biBvbiBwQ1BVcyB3aGljaCBhcmUgaW4gZGlmZmVyZW50IHBvb2xzLCB3aXRoIGRpZmZl
cmVudAorICAgICAqIHVuaXRzIChtYXkpIHJ1biBvbiBwQ1BVcyB3aGljaCBhcmUgaW4gZGlmZmVy
ZW50IHBvb2xzLCB3aXRoIGRpZmZlcmVudAogICAgICAqIHNjaGVkdWxlcnMuCiAgICAgICoKICAg
ICAgKiBXaGF0IHdlIHdhbnQsIGluIHRoaXMgY2FzZSwgaXMgdGhlIHNjaGVkdWxlciBvZiB0aGUg
cENQVSB3aGVyZSB0aGlzCi0gICAgICogcGFydGljdWxhciBpZGxlIHZDUFUgaXMgcnVubmluZy4g
QW5kLCBzaW5jZSB2LT5wcm9jZXNzb3IgbmV2ZXIgY2hhbmdlcwotICAgICAqIGZvciBpZGxlIHZD
UFVzLCBpdCBpcyBzYWZlIHRvIHVzZSBpdCwgd2l0aCBubyBsb2NrcywgdG8gZmlndXJlIHRoYXQg
b3V0LgorICAgICAqIHBhcnRpY3VsYXIgaWRsZSB1bml0IGlzIHJ1bm5pbmcuIEFuZCwgc2luY2Ug
dW5pdC0+cmVzIG5ldmVyIGNoYW5nZXMKKyAgICAgKiBmb3IgaWRsZSB1bml0cywgaXQgaXMgc2Fm
ZSB0byB1c2UgaXQsIHdpdGggbm8gbG9ja3MsIHRvIGZpZ3VyZSB0aGF0IG91dC4KICAgICAgKi8K
KwogICAgIEFTU0VSVChpc19pZGxlX2RvbWFpbihkKSk7Ci0gICAgcmV0dXJuIHBlcl9jcHUoc2No
ZWR1bGVyLCB2LT5wcm9jZXNzb3IpOworICAgIHJldHVybiBwZXJfY3B1KHNjaGVkdWxlciwgdW5p
dC0+cmVzLT5tYXN0ZXJfY3B1KTsKK30KKworc3RhdGljIGlubGluZSBzdHJ1Y3Qgc2NoZWR1bGVy
ICp2Y3B1X3NjaGVkdWxlcihjb25zdCBzdHJ1Y3QgdmNwdSAqdikKK3sKKyAgICByZXR1cm4gdW5p
dF9zY2hlZHVsZXIodi0+c2NoZWRfdW5pdCk7CiB9CiAjZGVmaW5lIFZDUFUyT05MSU5FKF92KSBj
cHVwb29sX2RvbWFpbl9jcHVtYXNrKChfdiktPmRvbWFpbikKIApAQCAtNDkxLDEwICs0OTcsMTEg
QEAgc3RhdGljIHZvaWQgc2NoZWRfbW92ZV9pcnFzKHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQog
aW50IHNjaGVkX21vdmVfZG9tYWluKHN0cnVjdCBkb21haW4gKmQsIHN0cnVjdCBjcHVwb29sICpj
KQogewogICAgIHN0cnVjdCB2Y3B1ICp2OwotICAgIHVuc2lnbmVkIGludCBuZXdfcDsKLSAgICB2
b2lkICoqdmNwdV9wcml2OworICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0OworICAgIHVuc2ln
bmVkIGludCBuZXdfcCwgdW5pdF9pZHg7CisgICAgdm9pZCAqKnVuaXRfcHJpdjsKICAgICB2b2lk
ICpkb21kYXRhOwotICAgIHZvaWQgKnZjcHVkYXRhOworICAgIHZvaWQgKnVuaXRkYXRhOwogICAg
IHN0cnVjdCBzY2hlZHVsZXIgKm9sZF9vcHM7CiAgICAgdm9pZCAqb2xkX2RvbWRhdGE7CiAKQEAg
LTUwOCwyNSArNTE1LDI3IEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpk
LCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICBpZiAoIElTX0VSUihkb21kYXRhKSApCiAgICAgICAg
IHJldHVybiBQVFJfRVJSKGRvbWRhdGEpOwogCi0gICAgdmNwdV9wcml2ID0geHphbGxvY19hcnJh
eSh2b2lkICosIGQtPm1heF92Y3B1cyk7Ci0gICAgaWYgKCB2Y3B1X3ByaXYgPT0gTlVMTCApCisg
ICAgLyogVE9ETzogZml4IGFycmF5IHNpemUgd2l0aCBtdWx0aXBsZSB2Y3B1cyBwZXIgdW5pdC4g
Ki8KKyAgICB1bml0X3ByaXYgPSB4emFsbG9jX2FycmF5KHZvaWQgKiwgZC0+bWF4X3ZjcHVzKTsK
KyAgICBpZiAoIHVuaXRfcHJpdiA9PSBOVUxMICkKICAgICB7CiAgICAgICAgIHNjaGVkX2ZyZWVf
ZG9tZGF0YShjLT5zY2hlZCwgZG9tZGF0YSk7CiAgICAgICAgIHJldHVybiAtRU5PTUVNOwogICAg
IH0KIAotICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICB1bml0X2lkeCA9IDA7CisgICAg
Zm9yX2VhY2hfc2NoZWRfdW5pdCAoIGQsIHVuaXQgKQogICAgIHsKLSAgICAgICAgdmNwdV9wcml2
W3YtPnZjcHVfaWRdID0gc2NoZWRfYWxsb2NfdmRhdGEoYy0+c2NoZWQsIHYtPnNjaGVkX3VuaXQs
Ci0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbWRh
dGEpOwotICAgICAgICBpZiAoIHZjcHVfcHJpdlt2LT52Y3B1X2lkXSA9PSBOVUxMICkKKyAgICAg
ICAgdW5pdF9wcml2W3VuaXRfaWR4XSA9IHNjaGVkX2FsbG9jX3ZkYXRhKGMtPnNjaGVkLCB1bml0
LCBkb21kYXRhKTsKKyAgICAgICAgaWYgKCB1bml0X3ByaXZbdW5pdF9pZHhdID09IE5VTEwgKQog
ICAgICAgICB7Ci0gICAgICAgICAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCi0gICAgICAgICAg
ICAgICAgeGZyZWUodmNwdV9wcml2W3YtPnZjcHVfaWRdKTsKLSAgICAgICAgICAgIHhmcmVlKHZj
cHVfcHJpdik7CisgICAgICAgICAgICBmb3IgKCB1bml0X2lkeCA9IDA7IHVuaXRfcHJpdlt1bml0
X2lkeF07IHVuaXRfaWR4KysgKQorICAgICAgICAgICAgICAgIHNjaGVkX2ZyZWVfdmRhdGEoYy0+
c2NoZWQsIHVuaXRfcHJpdlt1bml0X2lkeF0pOworICAgICAgICAgICAgeGZyZWUodW5pdF9wcml2
KTsKICAgICAgICAgICAgIHNjaGVkX2ZyZWVfZG9tZGF0YShjLT5zY2hlZCwgZG9tZGF0YSk7CiAg
ICAgICAgICAgICByZXR1cm4gLUVOT01FTTsKICAgICAgICAgfQorICAgICAgICB1bml0X2lkeCsr
OwogICAgIH0KIAogICAgIGRvbWFpbl9wYXVzZShkKTsKQEAgLTUzNCwzMCArNTQzLDM2IEBAIGlu
dCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgY3B1cG9vbCAqYykK
ICAgICBvbGRfb3BzID0gZG9tX3NjaGVkdWxlcihkKTsKICAgICBvbGRfZG9tZGF0YSA9IGQtPnNj
aGVkX3ByaXY7CiAKLSAgICBmb3JfZWFjaF92Y3B1ICggZCwgdiApCisgICAgZm9yX2VhY2hfc2No
ZWRfdW5pdCAoIGQsIHVuaXQgKQogICAgIHsKLSAgICAgICAgc2NoZWRfcmVtb3ZlX3VuaXQob2xk
X29wcywgdi0+c2NoZWRfdW5pdCk7CisgICAgICAgIHNjaGVkX3JlbW92ZV91bml0KG9sZF9vcHMs
IHVuaXQpOwogICAgIH0KIAogICAgIGQtPmNwdXBvb2wgPSBjOwogICAgIGQtPnNjaGVkX3ByaXYg
PSBkb21kYXRhOwogCiAgICAgbmV3X3AgPSBjcHVtYXNrX2ZpcnN0KGMtPmNwdV92YWxpZCk7Ci0g
ICAgZm9yX2VhY2hfdmNwdSAoIGQsIHYgKQorICAgIHVuaXRfaWR4ID0gMDsKKyAgICBmb3JfZWFj
aF9zY2hlZF91bml0ICggZCwgdW5pdCApCiAgICAgewogICAgICAgICBzcGlubG9ja190ICpsb2Nr
OworICAgICAgICB1bnNpZ25lZCBpbnQgdW5pdF9wID0gbmV3X3A7CiAKLSAgICAgICAgdmNwdWRh
dGEgPSB2LT5zY2hlZF91bml0LT5wcml2OworICAgICAgICB1bml0ZGF0YSA9IHVuaXQtPnByaXY7
CiAKLSAgICAgICAgbWlncmF0ZV90aW1lcigmdi0+cGVyaW9kaWNfdGltZXIsIG5ld19wKTsKLSAg
ICAgICAgbWlncmF0ZV90aW1lcigmdi0+c2luZ2xlc2hvdF90aW1lciwgbmV3X3ApOwotICAgICAg
ICBtaWdyYXRlX3RpbWVyKCZ2LT5wb2xsX3RpbWVyLCBuZXdfcCk7CisgICAgICAgIGZvcl9lYWNo
X3NjaGVkX3VuaXRfdmNwdSAoIHVuaXQsIHYgKQorICAgICAgICB7CisgICAgICAgICAgICBtaWdy
YXRlX3RpbWVyKCZ2LT5wZXJpb2RpY190aW1lciwgbmV3X3ApOworICAgICAgICAgICAgbWlncmF0
ZV90aW1lcigmdi0+c2luZ2xlc2hvdF90aW1lciwgbmV3X3ApOworICAgICAgICAgICAgbWlncmF0
ZV90aW1lcigmdi0+cG9sbF90aW1lciwgbmV3X3ApOworICAgICAgICAgICAgbmV3X3AgPSBjcHVt
YXNrX2N5Y2xlKG5ld19wLCBjLT5jcHVfdmFsaWQpOworICAgICAgICB9CiAKLSAgICAgICAgbG9j
ayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodi0+c2NoZWRfdW5pdCk7CisgICAgICAgIGxvY2sg
PSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxKHVuaXQpOwogCi0gICAgICAgIHNjaGVkX3NldF9hZmZp
bml0eSh2LCAmY3B1bWFza19hbGwsICZjcHVtYXNrX2FsbCk7CisgICAgICAgIHNjaGVkX3NldF9h
ZmZpbml0eSh1bml0LT52Y3B1X2xpc3QsICZjcHVtYXNrX2FsbCwgJmNwdW1hc2tfYWxsKTsKIAot
ICAgICAgICBzY2hlZF9zZXRfcmVzKHYtPnNjaGVkX3VuaXQsIGdldF9zY2hlZF9yZXMobmV3X3Ap
KTsKKyAgICAgICAgc2NoZWRfc2V0X3Jlcyh1bml0LCBnZXRfc2NoZWRfcmVzKHVuaXRfcCkpOwog
ICAgICAgICAvKgogICAgICAgICAgKiBXaXRoIHYtPnByb2Nlc3NvciBtb2RpZmllZCB3ZSBtdXN0
IG5vdAogICAgICAgICAgKiAtIG1ha2UgYW55IGZ1cnRoZXIgY2hhbmdlcyBhc3N1bWluZyB3ZSBo
b2xkIHRoZSBzY2hlZHVsZXIgbG9jaywKQEAgLTU2NSwxNSArNTgwLDE1IEBAIGludCBzY2hlZF9t
b3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3QgY3B1cG9vbCAqYykKICAgICAgICAg
ICovCiAgICAgICAgIHNwaW5fdW5sb2NrX2lycShsb2NrKTsKIAotICAgICAgICB2LT5zY2hlZF91
bml0LT5wcml2ID0gdmNwdV9wcml2W3YtPnZjcHVfaWRdOworICAgICAgICB1bml0LT5wcml2ID0g
dW5pdF9wcml2W3VuaXRfaWR4XTsKICAgICAgICAgaWYgKCAhZC0+aXNfZHlpbmcgKQotICAgICAg
ICAgICAgc2NoZWRfbW92ZV9pcnFzKHYtPnNjaGVkX3VuaXQpOworICAgICAgICAgICAgc2NoZWRf
bW92ZV9pcnFzKHVuaXQpOwogCi0gICAgICAgIG5ld19wID0gY3B1bWFza19jeWNsZShuZXdfcCwg
Yy0+Y3B1X3ZhbGlkKTsKKyAgICAgICAgc2NoZWRfaW5zZXJ0X3VuaXQoYy0+c2NoZWQsIHVuaXQp
OwogCi0gICAgICAgIHNjaGVkX2luc2VydF91bml0KGMtPnNjaGVkLCB2LT5zY2hlZF91bml0KTsK
KyAgICAgICAgc2NoZWRfZnJlZV92ZGF0YShvbGRfb3BzLCB1bml0ZGF0YSk7CiAKLSAgICAgICAg
c2NoZWRfZnJlZV92ZGF0YShvbGRfb3BzLCB2Y3B1ZGF0YSk7CisgICAgICAgIHVuaXRfaWR4Kys7
CiAgICAgfQogCiAgICAgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmluaXR5KGQpOwpAQCAtNTgyLDcg
KzU5Nyw3IEBAIGludCBzY2hlZF9tb3ZlX2RvbWFpbihzdHJ1Y3QgZG9tYWluICpkLCBzdHJ1Y3Qg
Y3B1cG9vbCAqYykKIAogICAgIHNjaGVkX2ZyZWVfZG9tZGF0YShvbGRfb3BzLCBvbGRfZG9tZGF0
YSk7CiAKLSAgICB4ZnJlZSh2Y3B1X3ByaXYpOworICAgIHhmcmVlKHVuaXRfcHJpdik7CiAKICAg
ICByZXR1cm4gMDsKIH0KQEAgLTg2NiwxOCArODgxLDM2IEBAIHN0YXRpYyB2b2lkIHZjcHVfbWln
cmF0ZV9maW5pc2goc3RydWN0IHZjcHUgKnYpCiAgICAgdmNwdV93YWtlKHYpOwogfQogCitzdGF0
aWMgYm9vbCBzY2hlZF9jaGVja19hZmZpbml0eV9icm9rZW4oY29uc3Qgc3RydWN0IHNjaGVkX3Vu
aXQgKnVuaXQpCit7CisgICAgY29uc3Qgc3RydWN0IHZjcHUgKnY7CisKKyAgICBmb3JfZWFjaF9z
Y2hlZF91bml0X3ZjcHUgKCB1bml0LCB2ICkKKyAgICAgICAgaWYgKCB2LT5hZmZpbml0eV9icm9r
ZW4gKQorICAgICAgICAgICAgcmV0dXJuIHRydWU7CisKKyAgICByZXR1cm4gZmFsc2U7Cit9CisK
K3N0YXRpYyB2b2lkIHNjaGVkX3Jlc2V0X2FmZmluaXR5X2Jyb2tlbihzdHJ1Y3Qgc2NoZWRfdW5p
dCAqdW5pdCkKK3sKKyAgICBzdHJ1Y3QgdmNwdSAqdjsKKworICAgIGZvcl9lYWNoX3NjaGVkX3Vu
aXRfdmNwdSAoIHVuaXQsIHYgKQorICAgICAgICB2LT5hZmZpbml0eV9icm9rZW4gPSBmYWxzZTsK
K30KKwogdm9pZCByZXN0b3JlX3ZjcHVfYWZmaW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKIHsKICAg
ICB1bnNpZ25lZCBpbnQgY3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOwotICAgIHN0cnVjdCB2Y3B1
ICp2OworICAgIHN0cnVjdCBzY2hlZF91bml0ICp1bml0OwogCiAgICAgQVNTRVJUKHN5c3RlbV9z
dGF0ZSA9PSBTWVNfU1RBVEVfcmVzdW1lKTsKIAotICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkK
KyAgICBmb3JfZWFjaF9zY2hlZF91bml0ICggZCwgdW5pdCApCiAgICAgewogICAgICAgICBzcGlu
bG9ja190ICpsb2NrOwotICAgICAgICB1bnNpZ25lZCBpbnQgb2xkX2NwdSA9IHYtPnByb2Nlc3Nv
cjsKLSAgICAgICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSB2LT5zY2hlZF91bml0OworICAg
ICAgICB1bnNpZ25lZCBpbnQgb2xkX2NwdSA9IHNjaGVkX3VuaXRfY3B1KHVuaXQpOwogICAgICAg
ICBzdHJ1Y3Qgc2NoZWRfcmVzb3VyY2UgKnJlczsKIAogICAgICAgICBBU1NFUlQoIXVuaXRfcnVu
bmFibGUodW5pdCkpOwpAQCAtODk2LDE4ICs5MjksMjIgQEAgdm9pZCByZXN0b3JlX3ZjcHVfYWZm
aW5pdHkoc3RydWN0IGRvbWFpbiAqZCkKICAgICAgICAgICAgICAgICAgICAgY3B1cG9vbF9kb21h
aW5fY3B1bWFzayhkKSk7CiAgICAgICAgIGlmICggY3B1bWFza19lbXB0eShjcHVtYXNrX3NjcmF0
Y2hfY3B1KGNwdSkpICkKICAgICAgICAgewotICAgICAgICAgICAgaWYgKCB2LT5hZmZpbml0eV9i
cm9rZW4gKQorICAgICAgICAgICAgaWYgKCBzY2hlZF9jaGVja19hZmZpbml0eV9icm9rZW4odW5p
dCkgKQogICAgICAgICAgICAgewotICAgICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh2
LCB1bml0LT5jcHVfaGFyZF9hZmZpbml0eV9zYXZlZCwgTlVMTCk7Ci0gICAgICAgICAgICAgICAg
di0+YWZmaW5pdHlfYnJva2VuID0gMDsKKyAgICAgICAgICAgICAgICAvKiBBZmZpbml0eSBzZXR0
aW5ncyBvZiBvbmUgdmNwdSBhcmUgZm9yIHRoZSBjb21wbGV0ZSB1bml0LiAqLworICAgICAgICAg
ICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh1bml0LT52Y3B1X2xpc3QsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHVuaXQtPmNwdV9oYXJkX2FmZmluaXR5X3NhdmVkLCBOVUxM
KTsKKyAgICAgICAgICAgICAgICBzY2hlZF9yZXNldF9hZmZpbml0eV9icm9rZW4odW5pdCk7CiAg
ICAgICAgICAgICAgICAgY3B1bWFza19hbmQoY3B1bWFza19zY3JhdGNoX2NwdShjcHUpLCB1bml0
LT5jcHVfaGFyZF9hZmZpbml0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcHVwb29s
X2RvbWFpbl9jcHVtYXNrKGQpKTsKICAgICAgICAgICAgIH0KIAogICAgICAgICAgICAgaWYgKCBj
cHVtYXNrX2VtcHR5KGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSkgKQogICAgICAgICAgICAgewot
ICAgICAgICAgICAgICAgIHByaW50ayhYRU5MT0dfREVCVUcgIkJyZWFraW5nIGFmZmluaXR5IGZv
ciAlcHZcbiIsIHYpOwotICAgICAgICAgICAgICAgIHNjaGVkX3NldF9hZmZpbml0eSh2LCAmY3B1
bWFza19hbGwsIE5VTEwpOworICAgICAgICAgICAgICAgIC8qIEFmZmluaXR5IHNldHRpbmdzIG9m
IG9uZSB2Y3B1IGFyZSBmb3IgdGhlIGNvbXBsZXRlIHVuaXQuICovCisgICAgICAgICAgICAgICAg
cHJpbnRrKFhFTkxPR19ERUJVRyAiQnJlYWtpbmcgYWZmaW5pdHkgZm9yICVwdlxuIiwKKyAgICAg
ICAgICAgICAgICAgICAgICAgdW5pdC0+dmNwdV9saXN0KTsKKyAgICAgICAgICAgICAgICBzY2hl
ZF9zZXRfYWZmaW5pdHkodW5pdC0+dmNwdV9saXN0LCAmY3B1bWFza19hbGwsIE5VTEwpOwogICAg
ICAgICAgICAgICAgIGNwdW1hc2tfYW5kKGNwdW1hc2tfc2NyYXRjaF9jcHUoY3B1KSwgdW5pdC0+
Y3B1X2hhcmRfYWZmaW5pdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3B1cG9vbF9k
b21haW5fY3B1bWFzayhkKSk7CiAgICAgICAgICAgICB9CkBAIC05MjAsMTIgKzk1NywxMiBAQCB2
b2lkIHJlc3RvcmVfdmNwdV9hZmZpbml0eShzdHJ1Y3QgZG9tYWluICpkKQogCiAgICAgICAgIC8q
IHYtPnByb2Nlc3NvciBtaWdodCBoYXZlIGNoYW5nZWQsIHNvIHJlYWNxdWlyZSB0aGUgbG9jay4g
Ki8KICAgICAgICAgbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnEodW5pdCk7Ci0gICAgICAg
IHJlcyA9IHNjaGVkX3BpY2tfcmVzb3VyY2UodmNwdV9zY2hlZHVsZXIodiksIHVuaXQpOworICAg
ICAgICByZXMgPSBzY2hlZF9waWNrX3Jlc291cmNlKHVuaXRfc2NoZWR1bGVyKHVuaXQpLCB1bml0
KTsKICAgICAgICAgc2NoZWRfc2V0X3Jlcyh1bml0LCByZXMpOwogICAgICAgICBzcGluX3VubG9j
a19pcnEobG9jayk7CiAKLSAgICAgICAgaWYgKCBvbGRfY3B1ICE9IHYtPnByb2Nlc3NvciApCi0g
ICAgICAgICAgICBzY2hlZF9tb3ZlX2lycXModi0+c2NoZWRfdW5pdCk7CisgICAgICAgIGlmICgg
b2xkX2NwdSAhPSBzY2hlZF91bml0X2NwdSh1bml0KSApCisgICAgICAgICAgICBzY2hlZF9tb3Zl
X2lycXModW5pdCk7CiAgICAgfQogCiAgICAgZG9tYWluX3VwZGF0ZV9ub2RlX2FmZmluaXR5KGQp
OwpAQCAtOTM5LDcgKzk3Niw2IEBAIHZvaWQgcmVzdG9yZV92Y3B1X2FmZmluaXR5KHN0cnVjdCBk
b21haW4gKmQpCiBpbnQgY3B1X2Rpc2FibGVfc2NoZWR1bGVyKHVuc2lnbmVkIGludCBjcHUpCiB7
CiAgICAgc3RydWN0IGRvbWFpbiAqZDsKLSAgICBzdHJ1Y3QgdmNwdSAqdjsKICAgICBzdHJ1Y3Qg
Y3B1cG9vbCAqYzsKICAgICBjcHVtYXNrX3Qgb25saW5lX2FmZmluaXR5OwogICAgIGludCByZXQg
PSAwOwpAQCAtOTUwLDE3ICs5ODYsMTkgQEAgaW50IGNwdV9kaXNhYmxlX3NjaGVkdWxlcih1bnNp
Z25lZCBpbnQgY3B1KQogCiAgICAgZm9yX2VhY2hfZG9tYWluX2luX2NwdXBvb2wgKCBkLCBjICkK
ICAgICB7Ci0gICAgICAgIGZvcl9lYWNoX3ZjcHUgKCBkLCB2ICkKKyAgICAgICAgc3RydWN0IHNj
aGVkX3VuaXQgKnVuaXQ7CisKKyAgICAgICAgZm9yX2VhY2hfc2NoZWRfdW5pdCAoIGQsIHVuaXQg
KQogICAgICAgICB7CiAgICAgICAgICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwotICAgICAgICAg
ICAgc3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSB2LT5zY2hlZF91bml0OwogICAgICAgICAgICAg
c3BpbmxvY2tfdCAqbG9jayA9IHVuaXRfc2NoZWR1bGVfbG9ja19pcnFzYXZlKHVuaXQsICZmbGFn
cyk7CiAKICAgICAgICAgICAgIGNwdW1hc2tfYW5kKCZvbmxpbmVfYWZmaW5pdHksIHVuaXQtPmNw
dV9oYXJkX2FmZmluaXR5LCBjLT5jcHVfdmFsaWQpOwogICAgICAgICAgICAgaWYgKCBjcHVtYXNr
X2VtcHR5KCZvbmxpbmVfYWZmaW5pdHkpICYmCiAgICAgICAgICAgICAgICAgIGNwdW1hc2tfdGVz
dF9jcHUoY3B1LCB1bml0LT5jcHVfaGFyZF9hZmZpbml0eSkgKQogICAgICAgICAgICAgewotICAg
ICAgICAgICAgICAgIGlmICggdi0+YWZmaW5pdHlfYnJva2VuICkKKyAgICAgICAgICAgICAgICAv
KiBUT0RPOiBtdWx0aXBsZSB2Y3B1cyBwZXIgdW5pdC4gKi8KKyAgICAgICAgICAgICAgICBpZiAo
IHVuaXQtPnZjcHVfbGlzdC0+YWZmaW5pdHlfYnJva2VuICkKICAgICAgICAgICAgICAgICB7CiAg
ICAgICAgICAgICAgICAgICAgIC8qIFRoZSB2Y3B1IGlzIHRlbXBvcmFyaWx5IHBpbm5lZCwgY2Fu
J3QgbW92ZSBpdC4gKi8KICAgICAgICAgICAgICAgICAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2tf
aXJxcmVzdG9yZShsb2NrLCBmbGFncywgdW5pdCk7CkBAIC05NjgsMTQgKzEwMDYsMTUgQEAgaW50
IGNwdV9kaXNhYmxlX3NjaGVkdWxlcih1bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICAgICAgICAg
ICAgICBicmVhazsKICAgICAgICAgICAgICAgICB9CiAKLSAgICAgICAgICAgICAgICBwcmludGso
WEVOTE9HX0RFQlVHICJCcmVha2luZyBhZmZpbml0eSBmb3IgJXB2XG4iLCB2KTsKKyAgICAgICAg
ICAgICAgICBwcmludGsoWEVOTE9HX0RFQlVHICJCcmVha2luZyBhZmZpbml0eSBmb3IgJXB2XG4i
LAorICAgICAgICAgICAgICAgICAgICAgICB1bml0LT52Y3B1X2xpc3QpOwogCi0gICAgICAgICAg
ICAgICAgc2NoZWRfc2V0X2FmZmluaXR5KHYsICZjcHVtYXNrX2FsbCwgTlVMTCk7CisgICAgICAg
ICAgICAgICAgc2NoZWRfc2V0X2FmZmluaXR5KHVuaXQtPnZjcHVfbGlzdCwgJmNwdW1hc2tfYWxs
LCBOVUxMKTsKICAgICAgICAgICAgIH0KIAotICAgICAgICAgICAgaWYgKCB2LT5wcm9jZXNzb3Ig
IT0gY3B1ICkKKyAgICAgICAgICAgIGlmICggc2NoZWRfdW5pdF9jcHUodW5pdCkgIT0gc2NoZWRf
Z2V0X3Jlc291cmNlX2NwdShjcHUpICkKICAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAgICAv
KiBUaGUgdmNwdSBpcyBub3Qgb24gdGhpcyBjcHUsIHNvIHdlIGNhbiBtb3ZlIG9uLiAqLworICAg
ICAgICAgICAgICAgIC8qIFRoZSB1bml0IGlzIG5vdCBvbiB0aGlzIGNwdSwgc28gd2UgY2FuIG1v
dmUgb24uICovCiAgICAgICAgICAgICAgICAgdW5pdF9zY2hlZHVsZV91bmxvY2tfaXJxcmVzdG9y
ZShsb2NrLCBmbGFncywgdW5pdCk7CiAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAg
ICAgICB9CkBAIC05ODgsMTcgKzEwMjcsMTggQEAgaW50IGNwdV9kaXNhYmxlX3NjaGVkdWxlcih1
bnNpZ25lZCBpbnQgY3B1KQogICAgICAgICAgICAgICogICogdGhlIHNjaGVkdWxlciB3aWxsIGFs
d2F5cyBmaW5kIGEgc3VpdGFibGUgc29sdXRpb24sIG9yCiAgICAgICAgICAgICAgKiAgICB0aGlu
Z3Mgd291bGQgaGF2ZSBmYWlsZWQgYmVmb3JlIGdldHRpbmcgaW4gaGVyZS4KICAgICAgICAgICAg
ICAqLwotICAgICAgICAgICAgdmNwdV9taWdyYXRlX3N0YXJ0KHYpOworICAgICAgICAgICAgLyog
VE9ETzogbXVsdGlwbGUgdmNwdXMgcGVyIHVuaXQuICovCisgICAgICAgICAgICB2Y3B1X21pZ3Jh
dGVfc3RhcnQodW5pdC0+dmNwdV9saXN0KTsKICAgICAgICAgICAgIHVuaXRfc2NoZWR1bGVfdW5s
b2NrX2lycXJlc3RvcmUobG9jaywgZmxhZ3MsIHVuaXQpOwogCi0gICAgICAgICAgICB2Y3B1X21p
Z3JhdGVfZmluaXNoKHYpOworICAgICAgICAgICAgdmNwdV9taWdyYXRlX2ZpbmlzaCh1bml0LT52
Y3B1X2xpc3QpOwogCiAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICogVGhlIG9ubHkgY2F2
ZWF0LCBpbiB0aGlzIGNhc2UsIGlzIHRoYXQgaWYgYSB2Y3B1IGFjdGl2ZSBpbgogICAgICAgICAg
ICAgICogdGhlIGh5cGVydmlzb3IgaXNuJ3QgbWlncmF0YWJsZS4gSW4gdGhpcyBjYXNlLCB0aGUg
Y2FsbGVyCiAgICAgICAgICAgICAgKiBzaG91bGQgdHJ5IGFnYWluIGFmdGVyIHJlbGVhc2luZyBh
bmQgcmVhcXVpcmluZyBhbGwgbG9ja3MuCiAgICAgICAgICAgICAgKi8KLSAgICAgICAgICAgIGlm
ICggdi0+cHJvY2Vzc29yID09IGNwdSApCisgICAgICAgICAgICBpZiAoIHNjaGVkX3VuaXRfY3B1
KHVuaXQpID09IHNjaGVkX2dldF9yZXNvdXJjZV9jcHUoY3B1KSApCiAgICAgICAgICAgICAgICAg
cmV0ID0gLUVBR0FJTjsKICAgICAgICAgfQogICAgIH0KQEAgLTEwMDksOCArMTA0OSw4IEBAIGlu
dCBjcHVfZGlzYWJsZV9zY2hlZHVsZXIodW5zaWduZWQgaW50IGNwdSkKIHN0YXRpYyBpbnQgY3B1
X2Rpc2FibGVfc2NoZWR1bGVyX2NoZWNrKHVuc2lnbmVkIGludCBjcHUpCiB7CiAgICAgc3RydWN0
IGRvbWFpbiAqZDsKLSAgICBzdHJ1Y3QgdmNwdSAqdjsKICAgICBzdHJ1Y3QgY3B1cG9vbCAqYzsK
KyAgICBzdHJ1Y3QgdmNwdSAqdjsKIAogICAgIGMgPSBwZXJfY3B1KGNwdXBvb2wsIGNwdSk7CiAg
ICAgaWYgKCBjID09IE5VTEwgKQotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxA
bGlzdHMueGVucHJvamVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFu
L2xpc3RpbmZvL3hlbi1kZXZlbA==

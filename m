Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 404782C486
	for <lists+xen-devel@lfdr.de>; Tue, 28 May 2019 12:37:27 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1hVZRE-0006zX-4C; Tue, 28 May 2019 10:34:36 +0000
Received: from all-amaz-eas1.inumbo.com ([34.197.232.57]
 helo=us1-amaz-eas2.inumbo.com)
 by lists.xenproject.org with esmtp (Exim 4.89)
 (envelope-from <SRS0=31/0=T4=suse.com=jgross@srs-us1.protection.inumbo.net>)
 id 1hVZQH-00050d-Uc
 for xen-devel@lists.xenproject.org; Tue, 28 May 2019 10:33:37 +0000
X-Inumbo-ID: 081754e6-8134-11e9-95b2-776e31728be0
Received: from mx1.suse.de (unknown [195.135.220.15])
 by us1-amaz-eas2.inumbo.com (Halon) with ESMTPS
 id 081754e6-8134-11e9-95b2-776e31728be0;
 Tue, 28 May 2019 10:33:29 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 35317B034;
 Tue, 28 May 2019 10:33:28 +0000 (UTC)
From: Juergen Gross <jgross@suse.com>
To: xen-devel@lists.xenproject.org
Date: Tue, 28 May 2019 12:32:58 +0200
Message-Id: <20190528103313.1343-46-jgross@suse.com>
X-Mailer: git-send-email 2.16.4
In-Reply-To: <20190528103313.1343-1-jgross@suse.com>
References: <20190528103313.1343-1-jgross@suse.com>
Subject: [Xen-devel] [PATCH 45/60] xen/sched: make vcpu_wake() and
 vcpu_sleep() core scheduling aware
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Juergen Gross <jgross@suse.com>, Tim Deegan <tim@xen.org>,
 Stefano Stabellini <sstabellini@kernel.org>, Wei Liu <wl@xen.org>,
 Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>,
 George Dunlap <george.dunlap@eu.citrix.com>,
 Andrew Cooper <andrew.cooper3@citrix.com>,
 Ian Jackson <ian.jackson@eu.citrix.com>, Dario Faggioli <dfaggioli@suse.com>,
 Julien Grall <julien.grall@arm.com>, Jan Beulich <jbeulich@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

dmNwdV93YWtlKCkgYW5kIHZjcHVfc2xlZXAoKSBuZWVkIHRvIGJlIG1hZGUgY29yZSBzY2hlZHVs
aW5nIGF3YXJlOgp0aGV5IG1pZ2h0IG5lZWQgdG8gc3dpdGNoIGEgc2luZ2xlIHZjcHUgb2YgYW4g
YWxyZWFkeSBzY2hlZHVsZWQgdW5pdApiZXR3ZWVuIHJ1bm5pbmcgYW5kIG5vdCBydW5uaW5nLgoK
RXNwZWNpYWxseSB3aGVuIHZjcHVfc2xlZXAoKSBmb3IgYSB2Y3B1IGlzIGJlaW5nIGNhbGxlZCBi
eSBhIHZjcHUgb2YKdGhlIHNhbWUgc2NoZWR1bGluZyB1bml0IHNwZWNpYWwgY2FyZSBtdXN0IGJl
IHRha2VuIGluIG9yZGVyIHRvIGF2b2lkCmEgZGVhZGxvY2s6IHRoZSB2Y3B1IHRvIGJlIHB1dCBh
c2xlZXAgbXVzdCBiZSBmb3JjZWQgdGhyb3VnaCBhCmNvbnRleHQgc3dpdGNoIHdpdGhvdXQgZG9p
bmcgc28gZm9yIHRoZSBjYWxsaW5nIHZjcHUuIEZvciB0aGlzCnB1cnBvc2UgYWRkIGEgdmNwdSBm
bGFnIGhhbmRsZWQgaW4gc2NoZWRfc2xhdmUoKSBhbmQgaW4Kc2NoZWRfd2FpdF9yZW5kZXp2b3Vz
X2luKCkgYWxsb3dpbmcgYSB2Y3B1IG9mIHRoZSBjdXJyZW50bHkgcnVubmluZwp1bml0IHRvIHN3
aXRjaCBzdGF0ZSBhdCBhIGhpZ2hlciBwcmlvcml0eSB0aGFuIGEgbm9ybWFsIHNjaGVkdWxlCmV2
ZW50LgoKVXNlIHRoZSBzYW1lIG1lY2hhbmlzbSB3aGVuIHdha2luZyB1cCBhIHZjcHUgb2YgYSBj
dXJyZW50bHkgYWN0aXZlCnVuaXQuCgpXaGlsZSBhdCBpdCBtYWtlIHZjcHVfc2xlZXBfbm9zeW5j
X2xvY2tlZCgpIHN0YXRpYyBhcyBpdCBpcyB1c2VkIGluCnNjaGVkdWxlLmMgb25seS4KClNpZ25l
ZC1vZmYtYnk6IEp1ZXJnZW4gR3Jvc3MgPGpncm9zc0BzdXNlLmNvbT4KLS0tClJGQyBWMjogYWRk
IHZjcHVfc2xlZXAoKSBoYW5kbGluZyBhbmQgZm9yY2VfY29udGV4dF9zd2l0Y2ggZmxhZwotLS0K
IHhlbi9jb21tb24vc2NoZWR1bGUuYyAgICAgIHwgMTQ0ICsrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKystLS0tLQogeGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmggfCAgIDkg
KystCiB4ZW4vaW5jbHVkZS94ZW4vc2NoZWQuaCAgICB8ICAgMiArCiAzIGZpbGVzIGNoYW5nZWQs
IDEzNiBpbnNlcnRpb25zKCspLCAxOSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS94ZW4vY29t
bW9uL3NjaGVkdWxlLmMgYi94ZW4vY29tbW9uL3NjaGVkdWxlLmMKaW5kZXggZTAxMDNmZGIxZC4u
ZTE4OWNjN2MyYiAxMDA2NDQKLS0tIGEveGVuL2NvbW1vbi9zY2hlZHVsZS5jCisrKyBiL3hlbi9j
b21tb24vc2NoZWR1bGUuYwpAQCAtNzksMjEgKzc5LDIxIEBAIGV4dGVybiBjb25zdCBzdHJ1Y3Qg
c2NoZWR1bGVyICpfX3N0YXJ0X3NjaGVkdWxlcnNfYXJyYXlbXSwgKl9fZW5kX3NjaGVkdWxlcnNf
YXJyCiAKIHN0YXRpYyBzdHJ1Y3Qgc2NoZWR1bGVyIF9fcmVhZF9tb3N0bHkgb3BzOwogCi1zdGF0
aWMgaW5saW5lIHN0cnVjdCB2Y3B1ICpzY2hlZF91bml0MnZjcHVfY3B1KHN0cnVjdCBzY2hlZF91
bml0ICp1bml0LAotICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICB1bnNpZ25lZCBpbnQgY3B1KQorc3RhdGljIGlubGluZSBzdHJ1Y3QgdmNwdSAqdW5pdDJ2Y3B1
X2NwdShzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGNwdSkKIHsKICAgICB1bnNpZ25lZCBpbnQgaWR4
ID0gdW5pdC0+dW5pdF9pZCArIHBlcl9jcHUoc2NoZWRfcmVzX2lkeCwgY3B1KTsKICAgICBjb25z
dCBzdHJ1Y3QgZG9tYWluICpkID0gdW5pdC0+ZG9tYWluOwotICAgIHN0cnVjdCB2Y3B1ICp2Owog
Ci0gICAgaWYgKCBpZHggPCBkLT5tYXhfdmNwdXMgJiYgZC0+dmNwdVtpZHhdICkKLSAgICB7Ci0g
ICAgICAgIHYgPSBkLT52Y3B1W2lkeF07Ci0gICAgICAgIGlmICggdi0+bmV3X3N0YXRlID09IFJV
TlNUQVRFX3J1bm5pbmcgKQotICAgICAgICAgICAgcmV0dXJuIHY7Ci0gICAgfQorICAgIHJldHVy
biAoaWR4IDwgZC0+bWF4X3ZjcHVzICYmIGQtPnZjcHVbaWR4XSkgPyBkLT52Y3B1W2lkeF0gOiBO
VUxMOworfQogCi0gICAgcmV0dXJuIGlkbGVfdmNwdVtjcHVdOworc3RhdGljIGlubGluZSBzdHJ1
Y3QgdmNwdSAqc2NoZWRfdW5pdDJ2Y3B1X2NwdShzdHJ1Y3Qgc2NoZWRfdW5pdCAqdW5pdCwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50
IGNwdSkKK3sKKyAgICBzdHJ1Y3QgdmNwdSAqdiA9IHVuaXQydmNwdV9jcHUodW5pdCwgY3B1KTsK
KworICAgIHJldHVybiAodiAmJiB2LT5uZXdfc3RhdGUgPT0gUlVOU1RBVEVfcnVubmluZykgPyB2
IDogaWRsZV92Y3B1W2NwdV07CiB9CiAKIHN0YXRpYyBpbmxpbmUgc3RydWN0IHNjaGVkdWxlciAq
ZG9tX3NjaGVkdWxlcihjb25zdCBzdHJ1Y3QgZG9tYWluICpkKQpAQCAtNjU2LDggKzY1NiwxMCBA
QCB2b2lkIHNjaGVkX2Rlc3Ryb3lfZG9tYWluKHN0cnVjdCBkb21haW4gKmQpCiAgICAgfQogfQog
Ci12b2lkIHZjcHVfc2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKK3N0YXRpYyB2
b2lkIHZjcHVfc2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKIHsKKyAgICBzdHJ1
Y3Qgc2NoZWRfdW5pdCAqdW5pdCA9IHYtPnNjaGVkX3VuaXQ7CisKICAgICBBU1NFUlQoc3Bpbl9p
c19sb2NrZWQoZ2V0X3NjaGVkX3Jlcyh2LT5wcm9jZXNzb3IpLT5zY2hlZHVsZV9sb2NrKSk7CiAK
ICAgICBpZiAoIGxpa2VseSghdmNwdV9ydW5uYWJsZSh2KSkgKQpAQCAtNjY1LDcgKzY2NywxNCBA
QCB2b2lkIHZjcHVfc2xlZXBfbm9zeW5jX2xvY2tlZChzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAg
aWYgKCB2LT5ydW5zdGF0ZS5zdGF0ZSA9PSBSVU5TVEFURV9ydW5uYWJsZSApCiAgICAgICAgICAg
ICB2Y3B1X3J1bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9vZmZsaW5lLCBOT1coKSk7CiAKLSAg
ICAgICAgc2NoZWRfc2xlZXAodmNwdV9zY2hlZHVsZXIodiksIHYtPnNjaGVkX3VuaXQpOworICAg
ICAgICBpZiAoIGxpa2VseSghdW5pdF9ydW5uYWJsZSh1bml0KSkgKQorICAgICAgICAgICAgc2No
ZWRfc2xlZXAodmNwdV9zY2hlZHVsZXIodiksIHVuaXQpOworICAgICAgICBlbHNlIGlmICggdW5p
dF9ydW5uaW5nKHVuaXQpID4gMSAmJiB2LT5pc19ydW5uaW5nICYmCisgICAgICAgICAgICAgICAg
ICAhdi0+Zm9yY2VfY29udGV4dF9zd2l0Y2ggKQorICAgICAgICB7CisgICAgICAgICAgICB2LT5m
b3JjZV9jb250ZXh0X3N3aXRjaCA9IHRydWU7CisgICAgICAgICAgICBjcHVfcmFpc2Vfc29mdGly
cSh2LT5wcm9jZXNzb3IsIFNDSEVEX1NMQVZFX1NPRlRJUlEpOworICAgICAgICB9CiAgICAgfQog
fQogCkBAIC02OTcsMTYgKzcwNiwyMiBAQCB2b2lkIHZjcHVfd2FrZShzdHJ1Y3QgdmNwdSAqdikK
IHsKICAgICB1bnNpZ25lZCBsb25nIGZsYWdzOwogICAgIHNwaW5sb2NrX3QgKmxvY2s7CisgICAg
c3RydWN0IHNjaGVkX3VuaXQgKnVuaXQgPSB2LT5zY2hlZF91bml0OwogCiAgICAgVFJBQ0VfMkQo
VFJDX1NDSEVEX1dBS0UsIHYtPmRvbWFpbi0+ZG9tYWluX2lkLCB2LT52Y3B1X2lkKTsKIAotICAg
IGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxc2F2ZSh2LT5zY2hlZF91bml0LCAmZmxhZ3Mp
OworICAgIGxvY2sgPSB1bml0X3NjaGVkdWxlX2xvY2tfaXJxc2F2ZSh1bml0LCAmZmxhZ3MpOwog
CiAgICAgaWYgKCBsaWtlbHkodmNwdV9ydW5uYWJsZSh2KSkgKQogICAgIHsKICAgICAgICAgaWYg
KCB2LT5ydW5zdGF0ZS5zdGF0ZSA+PSBSVU5TVEFURV9ibG9ja2VkICkKICAgICAgICAgICAgIHZj
cHVfcnVuc3RhdGVfY2hhbmdlKHYsIFJVTlNUQVRFX3J1bm5hYmxlLCBOT1coKSk7Ci0gICAgICAg
IHNjaGVkX3dha2UodmNwdV9zY2hlZHVsZXIodiksIHYtPnNjaGVkX3VuaXQpOworICAgICAgICBz
Y2hlZF93YWtlKHZjcHVfc2NoZWR1bGVyKHYpLCB1bml0KTsKKyAgICAgICAgaWYgKCB1bml0LT5p
c19ydW5uaW5nICYmICF2LT5pc19ydW5uaW5nICYmICF2LT5mb3JjZV9jb250ZXh0X3N3aXRjaCAp
CisgICAgICAgIHsKKyAgICAgICAgICAgIHYtPmZvcmNlX2NvbnRleHRfc3dpdGNoID0gdHJ1ZTsK
KyAgICAgICAgICAgIGNwdV9yYWlzZV9zb2Z0aXJxKHYtPnByb2Nlc3NvciwgU0NIRURfU0xBVkVf
U09GVElSUSk7CisgICAgICAgIH0KICAgICB9CiAgICAgZWxzZSBpZiAoICEodi0+cGF1c2VfZmxh
Z3MgJiBWUEZfYmxvY2tlZCkgKQogICAgIHsKQEAgLTcxNCw3ICs3MjksNyBAQCB2b2lkIHZjcHVf
d2FrZShzdHJ1Y3QgdmNwdSAqdikKICAgICAgICAgICAgIHZjcHVfcnVuc3RhdGVfY2hhbmdlKHYs
IFJVTlNUQVRFX29mZmxpbmUsIE5PVygpKTsKICAgICB9CiAKLSAgICB1bml0X3NjaGVkdWxlX3Vu
bG9ja19pcnFyZXN0b3JlKGxvY2ssIGZsYWdzLCB2LT5zY2hlZF91bml0KTsKKyAgICB1bml0X3Nj
aGVkdWxlX3VubG9ja19pcnFyZXN0b3JlKGxvY2ssIGZsYWdzLCB1bml0KTsKIH0KIAogdm9pZCB2
Y3B1X3VuYmxvY2soc3RydWN0IHZjcHUgKnYpCkBAIC0xODU2LDYgKzE4NzEsNjEgQEAgc3RhdGlj
IHZvaWQgc2NoZWRfY29udGV4dF9zd2l0Y2goc3RydWN0IHZjcHUgKnZwcmV2LCBzdHJ1Y3QgdmNw
dSAqdm5leHQsCiAgICAgY29udGV4dF9zd2l0Y2godnByZXYsIHZuZXh0KTsKIH0KIAorLyoKKyAq
IEZvcmNlIGEgY29udGV4dCBzd2l0Y2ggb2YgYSBzaW5nbGUgdmNwdSBvZiBhbiB1bml0LgorICog
TWlnaHQgYmUgY2FsbGVkIGVpdGhlciBpZiBhIHZjcHUgb2YgYW4gYWxyZWFkeSBydW5uaW5nIHVu
aXQgaXMgd29rZW4gdXAKKyAqIG9yIGlmIGEgdmNwdSBvZiBhIHJ1bm5pbmcgdW5pdCBpcyBwdXQg
YXNsZWVwIHdpdGggb3RoZXIgdmNwdXMgb2YgdGhlIHNhbWUKKyAqIHVuaXQgc3RpbGwgcnVubmlu
Zy4KKyAqLworc3RhdGljIHN0cnVjdCB2Y3B1ICpzY2hlZF9mb3JjZV9jb250ZXh0X3N3aXRjaChz
dHJ1Y3QgdmNwdSAqdnByZXYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHN0cnVjdCB2Y3B1ICp2LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBpbnQgY3B1LCBzX3RpbWVfdCBub3cpCit7CisgICAgdi0+Zm9yY2Vf
Y29udGV4dF9zd2l0Y2ggPSBmYWxzZTsKKworICAgIGlmICggdmNwdV9ydW5uYWJsZSh2KSA9PSB2
LT5pc19ydW5uaW5nICkKKyAgICAgICAgcmV0dXJuIE5VTEw7CisKKyAgICBpZiAoIHZjcHVfcnVu
bmFibGUodikgKQorICAgIHsKKyAgICAgICAgaWYgKCBpc19pZGxlX3ZjcHUodnByZXYpICkKKyAg
ICAgICAgeworICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9jaGFuZ2UodnByZXYsIFJVTlNUQVRF
X3J1bm5hYmxlLCBub3cpOworICAgICAgICAgICAgdnByZXYtPnNjaGVkX3VuaXQgPSBnZXRfc2No
ZWRfcmVzKGNwdSktPnNjaGVkX3VuaXRfaWRsZTsKKyAgICAgICAgfQorICAgICAgICB2Y3B1X3J1
bnN0YXRlX2NoYW5nZSh2LCBSVU5TVEFURV9ydW5uaW5nLCBub3cpOworICAgIH0KKyAgICBlbHNl
CisgICAgeworICAgICAgICAvKiBNYWtlIHN1cmUgbm90IHRvIHN3aXRjaCBsYXN0IHZjcHUgb2Yg
YW4gdW5pdCBhd2F5LiAqLworICAgICAgICBpZiAoIHVuaXRfcnVubmluZyh2LT5zY2hlZF91bml0
KSA9PSAxICkKKyAgICAgICAgICAgIHJldHVybiBOVUxMOworCisgICAgICAgIHZjcHVfcnVuc3Rh
dGVfY2hhbmdlKHYsIHZjcHVfcnVuc3RhdGVfYmxvY2tlZCh2KSwgbm93KTsKKyAgICAgICAgdiA9
IHNjaGVkX3VuaXQydmNwdV9jcHUodnByZXYtPnNjaGVkX3VuaXQsIGNwdSk7CisgICAgICAgIGlm
ICggdiAhPSB2cHJldiApCisgICAgICAgIHsKKyAgICAgICAgICAgIGlmICggaXNfaWRsZV92Y3B1
KHZwcmV2KSApCisgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgdmNwdV9ydW5zdGF0ZV9j
aGFuZ2UodnByZXYsIFJVTlNUQVRFX3J1bm5hYmxlLCBub3cpOworICAgICAgICAgICAgICAgIHZw
cmV2LT5zY2hlZF91bml0ID0gZ2V0X3NjaGVkX3JlcyhjcHUpLT5zY2hlZF91bml0X2lkbGU7Cisg
ICAgICAgICAgICB9CisgICAgICAgICAgICBlbHNlCisgICAgICAgICAgICB7CisgICAgICAgICAg
ICAgICAgdi0+c2NoZWRfdW5pdCA9IHZwcmV2LT5zY2hlZF91bml0OworICAgICAgICAgICAgICAg
IHZjcHVfcnVuc3RhdGVfY2hhbmdlKHYsIFJVTlNUQVRFX3J1bm5pbmcsIG5vdyk7CisgICAgICAg
ICAgICB9CisgICAgICAgIH0KKyAgICB9CisKKyAgICB2LT5pc19ydW5uaW5nID0gMTsKKworICAg
IC8qIE1ha2Ugc3VyZSBub3QgdG8gbG9vc2UgYW5vdGhlciBzbGF2ZSBjYWxsLiAqLworICAgIHJh
aXNlX3NvZnRpcnEoU0NIRURfU0xBVkVfU09GVElSUSk7CisKKyAgICByZXR1cm4gdjsKK30KKwog
LyoKICAqIFJlbmRlenZvdXMgYmVmb3JlIHRha2luZyBhIHNjaGVkdWxpbmcgZGVjaXNpb24uCiAg
KiBDYWxsZWQgd2l0aCBzY2hlZHVsZSBsb2NrIGhlbGQsIHNvIGFsbCBhY2Nlc3NlcyB0byB0aGUg
cmVuZGV6dm91cyBjb3VudGVyCkBAIC0xODcxLDYgKzE5NDEsNyBAQCBzdGF0aWMgc3RydWN0IHNj
aGVkX3VuaXQgKnNjaGVkX3dhaXRfcmVuZGV6dm91c19pbihzdHJ1Y3Qgc2NoZWRfdW5pdCAqcHJl
diwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNf
dGltZV90IG5vdykKIHsKICAgICBzdHJ1Y3Qgc2NoZWRfdW5pdCAqbmV4dDsKKyAgICBzdHJ1Y3Qg
dmNwdSAqdjsKIAogICAgIGlmICggIS0tcHJldi0+cmVuZGV6dm91c19pbl9jbnQgKQogICAgIHsK
QEAgLTE4NzksOCArMTk1MCwyOCBAQCBzdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQgKnNjaGVkX3dh
aXRfcmVuZGV6dm91c19pbihzdHJ1Y3Qgc2NoZWRfdW5pdCAqcHJldiwKICAgICAgICAgcmV0dXJu
IG5leHQ7CiAgICAgfQogCisgICAgdiA9IHVuaXQydmNwdV9jcHUocHJldiwgY3B1KTsKICAgICB3
aGlsZSAoIHByZXYtPnJlbmRlenZvdXNfaW5fY250ICkKICAgICB7CisgICAgICAgIGlmICggdiAm
JiB2LT5mb3JjZV9jb250ZXh0X3N3aXRjaCApCisgICAgICAgIHsKKyAgICAgICAgICAgIHN0cnVj
dCB2Y3B1ICp2cHJldiA9IGN1cnJlbnQ7CisKKyAgICAgICAgICAgIHYgPSBzY2hlZF9mb3JjZV9j
b250ZXh0X3N3aXRjaCh2cHJldiwgdiwgY3B1LCBub3cpOworCisgICAgICAgICAgICBpZiAoIHYg
KQorICAgICAgICAgICAgeworICAgICAgICAgICAgICAgIC8qIFdlJ2xsIGNvbWUgYmFjayBhbm90
aGVyIHRpbWUsIHNvIGFkanVzdCByZW5kZXp2b3VzX2luX2NudC4gKi8KKyAgICAgICAgICAgICAg
ICBwcmV2LT5yZW5kZXp2b3VzX2luX2NudCsrOworCisgICAgICAgICAgICAgICAgcGNwdV9zY2hl
ZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CisKKyAgICAgICAgICAgICAgICBzY2hlZF9jb250
ZXh0X3N3aXRjaCh2cHJldiwgdiwgZmFsc2UsIG5vdyk7CisgICAgICAgICAgICB9CisKKyAgICAg
ICAgICAgIHYgPSB1bml0MnZjcHVfY3B1KHByZXYsIGNwdSk7CisgICAgICAgIH0KKwogICAgICAg
ICBwY3B1X3NjaGVkdWxlX3VubG9ja19pcnEobG9jaywgY3B1KTsKIAogICAgICAgICAvKiBDb21p
bmcgZnJvbSBpZGxlIG1pZ2h0IG5lZWQgdG8gZG8gdGFza2xldCB3b3JrLiAqLwpAQCAtMTg5Nywx
MCArMTk4OCwxMSBAQCBzdGF0aWMgc3RydWN0IHNjaGVkX3VuaXQgKnNjaGVkX3dhaXRfcmVuZGV6
dm91c19pbihzdHJ1Y3Qgc2NoZWRfdW5pdCAqcHJldiwKIAogc3RhdGljIHZvaWQgc2NoZWRfc2xh
dmUodm9pZCkKIHsKLSAgICBzdHJ1Y3QgdmNwdSAgICAgICAgICAqdnByZXYgPSBjdXJyZW50Owor
ICAgIHN0cnVjdCB2Y3B1ICAgICAgICAgICp2LCAqdnByZXYgPSBjdXJyZW50OwogICAgIHN0cnVj
dCBzY2hlZF91bml0ICAgICpwcmV2ID0gdnByZXYtPnNjaGVkX3VuaXQsICpuZXh0OwogICAgIHNf
dGltZV90ICAgICAgICAgICAgICBub3c7CiAgICAgc3BpbmxvY2tfdCAgICAgICAgICAgKmxvY2s7
CisgICAgYm9vbCAgICAgICAgICAgICAgICAgIGRvX3NvZnRpcnEgPSBmYWxzZTsKICAgICBpbnQg
Y3B1ID0gc21wX3Byb2Nlc3Nvcl9pZCgpOwogCiAgICAgQVNTRVJUX05PVF9JTl9BVE9NSUMoKTsK
QEAgLTE5MDksOSArMjAwMSwyOSBAQCBzdGF0aWMgdm9pZCBzY2hlZF9zbGF2ZSh2b2lkKQogCiAg
ICAgbm93ID0gTk9XKCk7CiAKKyAgICB2ID0gdW5pdDJ2Y3B1X2NwdShwcmV2LCBjcHUpOworICAg
IGlmICggdiAmJiB2LT5mb3JjZV9jb250ZXh0X3N3aXRjaCApCisgICAgeworICAgICAgICB2ID0g
c2NoZWRfZm9yY2VfY29udGV4dF9zd2l0Y2godnByZXYsIHYsIGNwdSwgbm93KTsKKworICAgICAg
ICBpZiAoIHYgKQorICAgICAgICB7CisgICAgICAgICAgICBwY3B1X3NjaGVkdWxlX3VubG9ja19p
cnEobG9jaywgY3B1KTsKKworICAgICAgICAgICAgc2NoZWRfY29udGV4dF9zd2l0Y2godnByZXYs
IHYsIGZhbHNlLCBub3cpOworICAgICAgICB9CisKKyAgICAgICAgZG9fc29mdGlycSA9IHRydWU7
CisgICAgfQorCiAgICAgaWYgKCAhcHJldi0+cmVuZGV6dm91c19pbl9jbnQgKQogICAgIHsKICAg
ICAgICAgcGNwdV9zY2hlZHVsZV91bmxvY2tfaXJxKGxvY2ssIGNwdSk7CisKKyAgICAgICAgLyog
Q2hlY2sgZm9yIGZhaWxlZCBmb3JjZWQgY29udGV4dCBzd2l0Y2guICovCisgICAgICAgIGlmICgg
ZG9fc29mdGlycSApCisgICAgICAgICAgICByYWlzZV9zb2Z0aXJxKFNDSEVEVUxFX1NPRlRJUlEp
OworCiAgICAgICAgIHJldHVybjsKICAgICB9CiAKZGlmZiAtLWdpdCBhL3hlbi9pbmNsdWRlL3hl
bi9zY2hlZC1pZi5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKaW5kZXggYTFhZWZhMmEy
NS4uZjU5NjJjYmNmYiAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKKysr
IGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLWlmLmgKQEAgLTg4LDYgKzg4LDExIEBAIHN0YXRpYyBp
bmxpbmUgYm9vbCB1bml0X3J1bm5hYmxlKGNvbnN0IHN0cnVjdCBzY2hlZF91bml0ICp1bml0KQog
ICAgIHJldHVybiBmYWxzZTsKIH0KIAorc3RhdGljIGlubGluZSBpbnQgdmNwdV9ydW5zdGF0ZV9i
bG9ja2VkKHN0cnVjdCB2Y3B1ICp2KQoreworICAgIHJldHVybiAodi0+cGF1c2VfZmxhZ3MgJiBW
UEZfYmxvY2tlZCkgPyBSVU5TVEFURV9ibG9ja2VkIDogUlVOU1RBVEVfb2ZmbGluZTsKK30KKwog
c3RhdGljIGlubGluZSBib29sIHVuaXRfcnVubmFibGVfc3RhdGUoY29uc3Qgc3RydWN0IHNjaGVk
X3VuaXQgKnVuaXQpCiB7CiAgICAgc3RydWN0IHZjcHUgKnY7CkBAIC0xMDAsOSArMTA1LDcgQEAg
c3RhdGljIGlubGluZSBib29sIHVuaXRfcnVubmFibGVfc3RhdGUoY29uc3Qgc3RydWN0IHNjaGVk
X3VuaXQgKnVuaXQpCiAgICAgewogICAgICAgICBydW5uYWJsZSA9IHZjcHVfcnVubmFibGUodik7
CiAKLSAgICAgICAgdi0+bmV3X3N0YXRlID0gcnVubmFibGUgPyBSVU5TVEFURV9ydW5uaW5nCi0g
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHYtPnBhdXNlX2ZsYWdzICYgVlBGX2Js
b2NrZWQpCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBSVU5TVEFURV9ibG9j
a2VkIDogUlVOU1RBVEVfb2ZmbGluZTsKKyAgICAgICAgdi0+bmV3X3N0YXRlID0gcnVubmFibGUg
PyBSVU5TVEFURV9ydW5uaW5nIDogdmNwdV9ydW5zdGF0ZV9ibG9ja2VkKHYpOwogCiAgICAgICAg
IGlmICggcnVubmFibGUgKQogICAgICAgICAgICAgcmV0ID0gdHJ1ZTsKZGlmZiAtLWdpdCBhL3hl
bi9pbmNsdWRlL3hlbi9zY2hlZC5oIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKaW5kZXggMDU4
MWM3ZDQ0Zi4uYjY0OTZmNTdmNiAxMDA2NDQKLS0tIGEveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgK
KysrIGIveGVuL2luY2x1ZGUveGVuL3NjaGVkLmgKQEAgLTE4Niw2ICsxODYsOCBAQCBzdHJ1Y3Qg
dmNwdQogICAgIGJvb2wgICAgICAgICAgICAgaXNfcnVubmluZzsKICAgICAvKiBWQ1BVIHNob3Vs
ZCB3YWtlIGZhc3QgKGRvIG5vdCBkZWVwIHNsZWVwIHRoZSBDUFUpLiAqLwogICAgIGJvb2wgICAg
ICAgICAgICAgaXNfdXJnZW50OworICAgIC8qIFZDUFUgbXVzdCBjb250ZXh0X3N3aXRjaCB3aXRo
b3V0IHNjaGVkdWxpbmcgdW5pdC4gKi8KKyAgICBib29sICAgICAgICAgICAgIGZvcmNlX2NvbnRl
eHRfc3dpdGNoOwogCiAjaWZkZWYgVkNQVV9UUkFQX0xBU1QKICNkZWZpbmUgVkNQVV9UUkFQX05P
TkUgICAgMAotLSAKMi4xNi40CgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KWGVuLWRldmVsIG1haWxpbmcgbGlzdApYZW4tZGV2ZWxAbGlzdHMueGVucHJv
amVjdC5vcmcKaHR0cHM6Ly9saXN0cy54ZW5wcm9qZWN0Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL3hl
bi1kZXZlbA==

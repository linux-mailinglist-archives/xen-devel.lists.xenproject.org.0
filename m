Return-Path: <xen-devel-bounces@lists.xenproject.org>
X-Original-To: lists+xen-devel@lfdr.de
Delivered-To: lists+xen-devel@lfdr.de
Received: from lists.xenproject.org (lists.xenproject.org [192.237.175.120])
	by mail.lfdr.de (Postfix) with ESMTPS id 31660BC6EF
	for <lists+xen-devel@lfdr.de>; Tue, 24 Sep 2019 13:34:56 +0200 (CEST)
Received: from localhost ([127.0.0.1] helo=lists.xenproject.org)
	by lists.xenproject.org with esmtp (Exim 4.89)
	(envelope-from <xen-devel-bounces@lists.xenproject.org>)
	id 1iCj2M-000747-6B; Tue, 24 Sep 2019 11:31:18 +0000
Received: from us1-rack-iad1.inumbo.com ([172.99.69.81])
 by lists.xenproject.org with esmtp (Exim 4.89) (envelope-from
 <SRS0=LhKX=XT=citrix.com=anthony.perard@srs-us1.protection.inumbo.net>)
 id 1iCj2K-00073d-8R
 for xen-devel@lists.xenproject.org; Tue, 24 Sep 2019 11:31:16 +0000
X-Inumbo-ID: d18e76d2-debe-11e9-ae5c-bc764e2007e4
Received: from esa2.hc3370-68.iphmx.com (unknown [216.71.145.153])
 by localhost (Halon) with ESMTPS
 id d18e76d2-debe-11e9-ae5c-bc764e2007e4;
 Tue, 24 Sep 2019 11:31:15 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=citrix.com; s=securemail; t=1569324676;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=lIR2elTbWvefWOC/atlkBJbCmXdX8fU6m/x2+m4hVs8=;
 b=RX8JrzSqlPC/WM/j32pdIJDZRv4PEOtLOTunZ+u4T8cMEsvPomiuC7iF
 WdXz+6cZHx4115C6Dx4XRP5w/EFG5niVZbmFkGA8pTU+2NXetsf9zPLNz
 slj8OmzJdTMm1ZcEgulOD7kCDKNf5on48Etm5l7PQbCZEkRJGaJHiJsXk 0=;
Authentication-Results: esa2.hc3370-68.iphmx.com;
 dkim=none (message not signed) header.i=none;
 spf=None smtp.pra=anthony.perard@citrix.com;
 spf=Pass smtp.mailfrom=anthony.perard@citrix.com;
 spf=None smtp.helo=postmaster@mail.citrix.com
Received-SPF: None (esa2.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 anthony.perard@citrix.com) identity=pra;
 client-ip=162.221.158.21; receiver=esa2.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible
Received-SPF: Pass (esa2.hc3370-68.iphmx.com: domain of
 anthony.perard@citrix.com designates 162.221.158.21 as
 permitted sender) identity=mailfrom;
 client-ip=162.221.158.21; receiver=esa2.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="anthony.perard@citrix.com";
 x-conformance=sidf_compatible; x-record-type="v=spf1";
 x-record-text="v=spf1 ip4:209.167.231.154 ip4:178.63.86.133
 ip4:195.66.111.40/30 ip4:85.115.9.32/28 ip4:199.102.83.4
 ip4:192.28.146.160 ip4:192.28.146.107 ip4:216.52.6.88
 ip4:216.52.6.188 ip4:162.221.158.21 ip4:162.221.156.83 ~all"
Received-SPF: None (esa2.hc3370-68.iphmx.com: no sender
 authenticity information available from domain of
 postmaster@mail.citrix.com) identity=helo;
 client-ip=162.221.158.21; receiver=esa2.hc3370-68.iphmx.com;
 envelope-from="anthony.perard@citrix.com";
 x-sender="postmaster@mail.citrix.com";
 x-conformance=sidf_compatible
IronPort-SDR: CUbIogbqBB/Yq4YHdMfJO8/LJ95sua+JzNipeshuo4hg944nYCGxylQdYlYcw3inZvmY+rLRIW
 5xMsHswU5AFfZKar2S1WfCskhwHXTI1qT6WupsGwe/AoN1eAaWTYgXVJvQMuWifv4c1Idm5rHU
 h+tGzReAVJa018Z98bSOtbWUOQyIXAQnlJvNtv07FFz3d4WhpQHU4W1r+hRauZzt7//mVqqOc1
 GqhCWyCkdK/61JipyJbgyAexOv/I+SmpR3LZlsyfSw7s6WzW8v3vePam3VdHA/nOVEluGc6PUL
 DY8=
X-SBRS: 2.7
X-MesageID: 5977598
X-Ironport-Server: esa2.hc3370-68.iphmx.com
X-Remote-IP: 162.221.158.21
X-Policy: $RELAYED
X-IronPort-AV: E=Sophos;i="5.64,543,1559534400"; 
   d="scan'208";a="5977598"
From: Anthony PERARD <anthony.perard@citrix.com>
To: <qemu-devel@nongnu.org>
Date: Tue, 24 Sep 2019 12:30:23 +0100
Message-ID: <20190924113026.255634-5-anthony.perard@citrix.com>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190924113026.255634-1-anthony.perard@citrix.com>
References: <20190924113026.255634-1-anthony.perard@citrix.com>
MIME-Version: 1.0
Subject: [Xen-devel] [PULL 4/7] xen: perform XenDevice clean-up in XenBus
 watch handler
X-BeenThere: xen-devel@lists.xenproject.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xenproject.org>
List-Unsubscribe: <https://lists.xenproject.org/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xenproject.org>
List-Help: <mailto:xen-devel-request@lists.xenproject.org?subject=help>
List-Subscribe: <https://lists.xenproject.org/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xenproject.org?subject=subscribe>
Cc: Anthony PERARD <anthony.perard@citrix.com>, xen-devel@lists.xenproject.org,
 Peter Maydell <peter.maydell@linaro.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: xen-devel-bounces@lists.xenproject.org
Sender: "Xen-devel" <xen-devel-bounces@lists.xenproject.org>

RnJvbTogUGF1bCBEdXJyYW50IDxwYXVsLmR1cnJhbnRAY2l0cml4LmNvbT4KCkNsZWFuaW5nIHVw
IG9mZmxpbmUgWGVuRGV2aWNlIG9iamVjdHMgZGlyZWN0bHkgaW4KeGVuX2RldmljZV9iYWNrZW5k
X2NoYW5nZWQoKSBpcyBkYW5nZXJvdXMgYXMgeGVuX2RldmljZV91bnJlYWxpemUoKSB3aWxsCm1v
ZGlmeSB0aGUgd2F0Y2ggbGlzdCB0aGF0IGlzIGJlaW5nIHdhbGtlZC4gRXZlbiB0aGUgUUxJU1Rf
Rk9SRUFDSF9TQUZFKCkKdXNlZCBpbiBub3RpZmllcl9saXN0X25vdGlmeSgpIGlzIGluc3VmZmlj
aWVudCBhcyAqdHdvKiBub3RpZmllcnMgKGZvcgp0aGUgZnJvbnRlbmQgYW5kIGJhY2tlbmQgd2F0
Y2hlcykgYXJlIHJlbW92ZWQsIHRodXMgcG90ZW50aWFsbHkgcmVuZGVyaW5nCnRoZSAnbmV4dCcg
cG9pbnRlciB1bnNhZmUuCgpUaGUgc29sdXRpb24gaXMgdG8gdXNlIHRoZSBYZW5CdXMgYmFja2Vu
ZF93YXRjaCBoYW5kbGVyIHRvIGRvIHRoZSBjbGVhbi11cAppbnN0ZWFkLCBhcyBpdCBpcyBpbnZv
a2VkIHdoaWxzdCB3YWxraW5nIGEgc2VwYXJhdGUgd2F0Y2ggbGlzdC4KClRoaXMgcGF0Y2ggdGhl
cmVmb3JlIGFkZHMgYSBuZXcgJ2luYWN0aXZlX2RldmljZXMnIGxpc3QgdG8gWGVuQnVzLCB0byB3
aGljaApvZmZsaW5lIGRldmljZXMgYXJlIGFkZGVkIGJ5IHhlbl9kZXZpY2VfYmFja2VuZF9jaGFu
Z2VkKCkuIFRoZSBYZW5CdXMKYmFja2VuZF93YXRjaCByZWdpc3RyYXRpb24gaXMgYWxzbyBjaGFu
Z2VkIHRvIG5vdCBvbmx5IGludm9rZQp4ZW5fYnVzX2VudW1lcmF0ZSgpIGJ1dCBhbHNvIGEgbmV3
IHhlbl9idXNfY2xlYW51cCgpIGZ1bmN0aW9uLCB3aGljaCB3aWxsCndhbGsgJ2luYWN0aXZlX2Rl
dmljZXMnIGFuZCBwZXJmb3JtIHRoZSBuZWNlc3NhcnkgYWN0aW9ucy4KRm9yIHNhZmV0eSBhbiBl
eHRyYSAnb25saW5lJyBjaGVjayBpcyBhbHNvIGFkZGVkIHRvIHhlbl9idXNfdHlwZV9lbnVtZXJh
dGUoKQp0byBtYWtlIHN1cmUgdGhhdCBubyBhdHRlbXB0IGlzIG1hZGUgdG8gY3JlYXRlIGEgbmV3
IFhlbkRldmljZSBvYmplY3QgZm9yIGEKYmFja2VuZCB0aGF0IGlzIG9mZmxpbmUuCgpOT1RFOiBU
aGlzIHBhdGNoIGFsc28gaW5jbHVkZXMgc29tZSBjb3NtZXRpYyBjaGFuZ2VzOgogICAgICAtIHN1
YnN0aXR1dGUgdGhlIGxvY2FsIHZhcmlhYmxlIG5hbWUgJ2JhY2tlbmRfc3RhdGUnCiAgICAgICAg
aW4geGVuX2J1c190eXBlX2VudW1lcmF0ZSgpIHdpdGggJ3N0YXRlJywgc2luY2UgdGhlcmUKICAg
ICAgICBpcyBubyBhbWJpZ3VpdHkgd2l0aCBhbnkgb3RoZXIgc3RhdGUgaW4gdGhhdCBjb250ZXh0
LgogICAgICAtIGNoYW5nZSB4ZW5fZGV2aWNlX3N0YXRlX2lzX2FjdGl2ZSgpIHRvCiAgICAgICAg
eGVuX2RldmljZV9mcm9udGVuZF9pc19hY3RpdmUoKSAoYW5kIHBhc3MgYSBYZW5EZXZpY2UgZGly
ZWN0bHkpCiAgICAgICAgc2luY2UgdGhlIHN0YXRlIHRlc3RzIGNvbnRhaW5lZCB0aGVyZWluIG9u
bHkgYXBwbHkgdG8gYSBmcm9udGVuZC4KICAgICAgLSB1c2UgJ3N0YXRlJyByYXRoZXIgdGhlbiAn
eGVuZGV2LT5iYWNrZW5kX3N0YXRlJyBpbgogICAgICAgIHhlbl9kZXZpY2VfYmFja2VuZF9jaGFu
Z2VkKCkgdG8gc2hvcnRlbiB0aGUgY29kZS4KClNpZ25lZC1vZmYtYnk6IFBhdWwgRHVycmFudCA8
cGF1bC5kdXJyYW50QGNpdHJpeC5jb20+ClJldmlld2VkLWJ5OiBBbnRob255IFBFUkFSRCA8YW50
aG9ueS5wZXJhcmRAY2l0cml4LmNvbT4KTWVzc2FnZS1JZDogPDIwMTkwOTEzMDgyMTU5LjMxMzM4
LTQtcGF1bC5kdXJyYW50QGNpdHJpeC5jb20+ClNpZ25lZC1vZmYtYnk6IEFudGhvbnkgUEVSQVJE
IDxhbnRob255LnBlcmFyZEBjaXRyaXguY29tPgotLS0KIGh3L3hlbi90cmFjZS1ldmVudHMgICAg
ICB8ICAyICsKIGh3L3hlbi94ZW4tYnVzLmMgICAgICAgICB8IDk0ICsrKysrKysrKysrKysrKysr
KysrKysrKysrKysrLS0tLS0tLS0tLS0KIGluY2x1ZGUvaHcveGVuL3hlbi1idXMuaCB8ICAzICsr
CiAzIGZpbGVzIGNoYW5nZWQsIDc0IGluc2VydGlvbnMoKyksIDI1IGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL2h3L3hlbi90cmFjZS1ldmVudHMgYi9ody94ZW4vdHJhY2UtZXZlbnRzCmluZGV4
IDgwY2UzZGFmYWQuLmU2ODg1YmM3NTEgMTAwNjQ0Ci0tLSBhL2h3L3hlbi90cmFjZS1ldmVudHMK
KysrIGIvaHcveGVuL3RyYWNlLWV2ZW50cwpAQCAtMTcsOCArMTcsMTAgQEAgeGVuX2RvbWlkX3Jl
c3RyaWN0KGludCBlcnIpICJlcnI6ICV1IgogeGVuX2J1c19yZWFsaXplKHZvaWQpICIiCiB4ZW5f
YnVzX3VucmVhbGl6ZSh2b2lkKSAiIgogeGVuX2J1c19lbnVtZXJhdGUodm9pZCkgIiIKK3hlbl9i
dXNfY2xlYW51cCh2b2lkKSAiIgogeGVuX2J1c190eXBlX2VudW1lcmF0ZShjb25zdCBjaGFyICp0
eXBlKSAidHlwZTogJXMiCiB4ZW5fYnVzX2JhY2tlbmRfY3JlYXRlKGNvbnN0IGNoYXIgKnR5cGUs
IGNvbnN0IGNoYXIgKnBhdGgpICJ0eXBlOiAlcyBwYXRoOiAlcyIKK3hlbl9idXNfZGV2aWNlX2Ns
ZWFudXAoY29uc3QgY2hhciAqdHlwZSwgY2hhciAqbmFtZSkgInR5cGU6ICVzIG5hbWU6ICVzIgog
eGVuX2J1c19hZGRfd2F0Y2goY29uc3QgY2hhciAqbm9kZSwgY29uc3QgY2hhciAqa2V5KSAibm9k
ZTogJXMga2V5OiAlcyIKIHhlbl9idXNfcmVtb3ZlX3dhdGNoKGNvbnN0IGNoYXIgKm5vZGUsIGNv
bnN0IGNoYXIgKmtleSkgIm5vZGU6ICVzIGtleTogJXMiCiB4ZW5fZGV2aWNlX3JlYWxpemUoY29u
c3QgY2hhciAqdHlwZSwgY2hhciAqbmFtZSkgInR5cGU6ICVzIG5hbWU6ICVzIgpkaWZmIC0tZ2l0
IGEvaHcveGVuL3hlbi1idXMuYyBiL2h3L3hlbi94ZW4tYnVzLmMKaW5kZXggODEwYTRlMmRmMy4u
NTVjMTU3MzkzZCAxMDA2NDQKLS0tIGEvaHcveGVuL3hlbi1idXMuYworKysgYi9ody94ZW4veGVu
LWJ1cy5jCkBAIC0zNDAsMTMgKzM0MCwxOCBAQCBzdGF0aWMgdm9pZCB4ZW5fYnVzX3R5cGVfZW51
bWVyYXRlKFhlbkJ1cyAqeGVuYnVzLCBjb25zdCBjaGFyICp0eXBlKQogICAgIGZvciAoaSA9IDA7
IGkgPCBuOyBpKyspIHsKICAgICAgICAgY2hhciAqYmFja2VuZF9wYXRoID0gZ19zdHJkdXBfcHJp
bnRmKCIlcy8lcyIsIGRvbWFpbl9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgYmFja2VuZFtpXSk7Ci0gICAgICAgIGVudW0geGVuYnVzX3N0YXRlIGJh
Y2tlbmRfc3RhdGU7CisgICAgICAgIGVudW0geGVuYnVzX3N0YXRlIHN0YXRlOworICAgICAgICB1
bnNpZ25lZCBpbnQgb25saW5lOwogCiAgICAgICAgIGlmICh4c19ub2RlX3NjYW5mKHhlbmJ1cy0+
eHNoLCBYQlRfTlVMTCwgYmFja2VuZF9wYXRoLCAic3RhdGUiLAotICAgICAgICAgICAgICAgICAg
ICAgICAgICBOVUxMLCAiJXUiLCAmYmFja2VuZF9zdGF0ZSkgIT0gMSkKLSAgICAgICAgICAgIGJh
Y2tlbmRfc3RhdGUgPSBYZW5idXNTdGF0ZVVua25vd247CisgICAgICAgICAgICAgICAgICAgICAg
ICAgIE5VTEwsICIldSIsICZzdGF0ZSkgIT0gMSkKKyAgICAgICAgICAgIHN0YXRlID0gWGVuYnVz
U3RhdGVVbmtub3duOwogCi0gICAgICAgIGlmIChiYWNrZW5kX3N0YXRlID09IFhlbmJ1c1N0YXRl
SW5pdGlhbGlzaW5nKSB7CisgICAgICAgIGlmICh4c19ub2RlX3NjYW5mKHhlbmJ1cy0+eHNoLCBY
QlRfTlVMTCwgYmFja2VuZF9wYXRoLCAib25saW5lIiwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgTlVMTCwgIiV1IiwgJm9ubGluZSkgIT0gMSkKKyAgICAgICAgICAgIG9ubGluZSA9IDA7CisK
KyAgICAgICAgaWYgKG9ubGluZSAmJiBzdGF0ZSA9PSBYZW5idXNTdGF0ZUluaXRpYWxpc2luZykg
ewogICAgICAgICAgICAgRXJyb3IgKmxvY2FsX2VyciA9IE5VTEw7CiAKICAgICAgICAgICAgIHhl
bl9idXNfYmFja2VuZF9jcmVhdGUoeGVuYnVzLCB0eXBlLCBiYWNrZW5kW2ldLCBiYWNrZW5kX3Bh
dGgsCkBAIC0zNjUsOSArMzcwLDggQEAgc3RhdGljIHZvaWQgeGVuX2J1c190eXBlX2VudW1lcmF0
ZShYZW5CdXMgKnhlbmJ1cywgY29uc3QgY2hhciAqdHlwZSkKICAgICBnX2ZyZWUoZG9tYWluX3Bh
dGgpOwogfQogCi1zdGF0aWMgdm9pZCB4ZW5fYnVzX2VudW1lcmF0ZSh2b2lkICpvcGFxdWUpCitz
dGF0aWMgdm9pZCB4ZW5fYnVzX2VudW1lcmF0ZShYZW5CdXMgKnhlbmJ1cykKIHsKLSAgICBYZW5C
dXMgKnhlbmJ1cyA9IG9wYXF1ZTsKICAgICBjaGFyICoqdHlwZTsKICAgICB1bnNpZ25lZCBpbnQg
aSwgbjsKIApAQCAtMzg1LDYgKzM4OSw0NSBAQCBzdGF0aWMgdm9pZCB4ZW5fYnVzX2VudW1lcmF0
ZSh2b2lkICpvcGFxdWUpCiAgICAgZnJlZSh0eXBlKTsKIH0KIAorc3RhdGljIHZvaWQgeGVuX2J1
c19kZXZpY2VfY2xlYW51cChYZW5EZXZpY2UgKnhlbmRldikKK3sKKyAgICBjb25zdCBjaGFyICp0
eXBlID0gb2JqZWN0X2dldF90eXBlbmFtZShPQkpFQ1QoeGVuZGV2KSk7CisgICAgRXJyb3IgKmxv
Y2FsX2VyciA9IE5VTEw7CisKKyAgICB0cmFjZV94ZW5fYnVzX2RldmljZV9jbGVhbnVwKHR5cGUs
IHhlbmRldi0+bmFtZSk7CisKKyAgICBnX2Fzc2VydCgheGVuZGV2LT5iYWNrZW5kX29ubGluZSk7
CisKKyAgICBpZiAoIXhlbl9iYWNrZW5kX3RyeV9kZXZpY2VfZGVzdHJveSh4ZW5kZXYsICZsb2Nh
bF9lcnIpKSB7CisgICAgICAgIG9iamVjdF91bnBhcmVudChPQkpFQ1QoeGVuZGV2KSk7CisgICAg
fQorCisgICAgaWYgKGxvY2FsX2VycikgeworICAgICAgICBlcnJvcl9yZXBvcnRfZXJyKGxvY2Fs
X2Vycik7CisgICAgfQorfQorCitzdGF0aWMgdm9pZCB4ZW5fYnVzX2NsZWFudXAoWGVuQnVzICp4
ZW5idXMpCit7CisgICAgWGVuRGV2aWNlICp4ZW5kZXYsICpuZXh0OworCisgICAgdHJhY2VfeGVu
X2J1c19jbGVhbnVwKCk7CisKKyAgICBRTElTVF9GT1JFQUNIX1NBRkUoeGVuZGV2LCAmeGVuYnVz
LT5pbmFjdGl2ZV9kZXZpY2VzLCBsaXN0LCBuZXh0KSB7CisgICAgICAgIGdfYXNzZXJ0KHhlbmRl
di0+aW5hY3RpdmUpOworICAgICAgICBRTElTVF9SRU1PVkUoeGVuZGV2LCBsaXN0KTsKKyAgICAg
ICAgeGVuX2J1c19kZXZpY2VfY2xlYW51cCh4ZW5kZXYpOworICAgIH0KK30KKworc3RhdGljIHZv
aWQgeGVuX2J1c19iYWNrZW5kX2NoYW5nZWQodm9pZCAqb3BhcXVlKQoreworICAgIFhlbkJ1cyAq
eGVuYnVzID0gb3BhcXVlOworCisgICAgeGVuX2J1c19lbnVtZXJhdGUoeGVuYnVzKTsKKyAgICB4
ZW5fYnVzX2NsZWFudXAoeGVuYnVzKTsKK30KKwogc3RhdGljIHZvaWQgeGVuX2J1c191bnJlYWxp
emUoQnVzU3RhdGUgKmJ1cywgRXJyb3IgKiplcnJwKQogewogICAgIFhlbkJ1cyAqeGVuYnVzID0g
WEVOX0JVUyhidXMpOwpAQCAtNDMzLDcgKzQ3Niw3IEBAIHN0YXRpYyB2b2lkIHhlbl9idXNfcmVh
bGl6ZShCdXNTdGF0ZSAqYnVzLCBFcnJvciAqKmVycnApCiAKICAgICB4ZW5idXMtPmJhY2tlbmRf
d2F0Y2ggPQogICAgICAgICB4ZW5fYnVzX2FkZF93YXRjaCh4ZW5idXMsICIiLCAvKiBkb21haW4g
cm9vdCBub2RlICovCi0gICAgICAgICAgICAgICAgICAgICAgICAgICJiYWNrZW5kIiwgeGVuX2J1
c19lbnVtZXJhdGUsICZsb2NhbF9lcnIpOworICAgICAgICAgICAgICAgICAgICAgICAgICAiYmFj
a2VuZCIsIHhlbl9idXNfYmFja2VuZF9jaGFuZ2VkLCAmbG9jYWxfZXJyKTsKICAgICBpZiAobG9j
YWxfZXJyKSB7CiAgICAgICAgIC8qIFRoaXMgbmVlZCBub3QgYmUgdHJlYXRlZCBhcyBhIGhhcmQg
ZXJyb3Igc28gZG9uJ3QgcHJvcGFnYXRlICovCiAgICAgICAgIGVycm9yX3JlcG9ydGZfZXJyKGxv
Y2FsX2VyciwKQEAgLTU1NSw5ICs1OTgsOSBAQCBzdGF0aWMgdm9pZCB4ZW5fZGV2aWNlX2JhY2tl
bmRfc2V0X29ubGluZShYZW5EZXZpY2UgKnhlbmRldiwgYm9vbCBvbmxpbmUpCiAgKiBUZWxsIGZy
b20gdGhlIHN0YXRlIHdoZXRoZXIgdGhlIGZyb250ZW5kIGlzIGxpa2VseSBhbGl2ZSwKICAqIGku
ZS4gaXQgd2lsbCByZWFjdCB0byBhIGNoYW5nZSBvZiBzdGF0ZSBvZiB0aGUgYmFja2VuZC4KICAq
Lwotc3RhdGljIGJvb2wgeGVuX2RldmljZV9zdGF0ZV9pc19hY3RpdmUoZW51bSB4ZW5idXNfc3Rh
dGUgc3RhdGUpCitzdGF0aWMgYm9vbCB4ZW5fZGV2aWNlX2Zyb250ZW5kX2lzX2FjdGl2ZShYZW5E
ZXZpY2UgKnhlbmRldikKIHsKLSAgICBzd2l0Y2ggKHN0YXRlKSB7CisgICAgc3dpdGNoICh4ZW5k
ZXYtPmZyb250ZW5kX3N0YXRlKSB7CiAgICAgY2FzZSBYZW5idXNTdGF0ZUluaXRXYWl0OgogICAg
IGNhc2UgWGVuYnVzU3RhdGVJbml0aWFsaXNlZDoKICAgICBjYXNlIFhlbmJ1c1N0YXRlQ29ubmVj
dGVkOgpAQCAtNTk0LDMwICs2MzcsMzEgQEAgc3RhdGljIHZvaWQgeGVuX2RldmljZV9iYWNrZW5k
X2NoYW5nZWQodm9pZCAqb3BhcXVlKQogICAgICAqIHN0YXRlIHRvIENsb3NpbmcsIGJ1dCB0aGVy
ZSBpcyBubyBhY3RpdmUgZnJvbnRlbmQgdGhlbiBzZXQgdGhlCiAgICAgICogYmFja2VuZCBzdGF0
ZSB0byBDbG9zZWQuCiAgICAgICovCi0gICAgaWYgKHhlbmRldi0+YmFja2VuZF9zdGF0ZSA9PSBY
ZW5idXNTdGF0ZUNsb3NpbmcgJiYKLSAgICAgICAgIXhlbl9kZXZpY2Vfc3RhdGVfaXNfYWN0aXZl
KHhlbmRldi0+ZnJvbnRlbmRfc3RhdGUpKSB7CisgICAgaWYgKHN0YXRlID09IFhlbmJ1c1N0YXRl
Q2xvc2luZyAmJgorICAgICAgICAheGVuX2RldmljZV9mcm9udGVuZF9pc19hY3RpdmUoeGVuZGV2
KSkgewogICAgICAgICB4ZW5fZGV2aWNlX2JhY2tlbmRfc2V0X3N0YXRlKHhlbmRldiwgWGVuYnVz
U3RhdGVDbG9zZWQpOwogICAgIH0KIAogICAgIC8qCiAgICAgICogSWYgYSBiYWNrZW5kIGlzIHN0
aWxsICdvbmxpbmUnIHRoZW4gd2Ugc2hvdWxkIGxlYXZlIGl0IGFsb25lIGJ1dCwKLSAgICAgKiBp
ZiBhIGJhY2tlbmQgaXMgbm90ICdvbmxpbmUnLCB0aGVuIHRoZSBkZXZpY2Ugc2hvdWxkIGJlIGRl
c3Ryb3llZAotICAgICAqIG9uY2UgdGhlIHN0YXRlIGlzIENsb3NlZC4KKyAgICAgKiBpZiBhIGJh
Y2tlbmQgaXMgbm90ICdvbmxpbmUnLCB0aGVuIHRoZSBkZXZpY2UgaXMgYSBjYW5kaWRhdGUKKyAg
ICAgKiBmb3IgZGVzdHJ1Y3Rpb24uIEhlbmNlIGFkZCBpdCB0byB0aGUgJ2luYWN0aXZlJyBsaXN0
IHRvIGJlIGNsZWFuZWQKKyAgICAgKiBieSB4ZW5fYnVzX2NsZWFudXAoKS4KICAgICAgKi8KLSAg
ICBpZiAoIXhlbmRldi0+YmFja2VuZF9vbmxpbmUgJiYKLSAgICAgICAgKHhlbmRldi0+YmFja2Vu
ZF9zdGF0ZSA9PSBYZW5idXNTdGF0ZUNsb3NlZCB8fAotICAgICAgICAgeGVuZGV2LT5iYWNrZW5k
X3N0YXRlID09IFhlbmJ1c1N0YXRlSW5pdGlhbGlzaW5nIHx8Ci0gICAgICAgICB4ZW5kZXYtPmJh
Y2tlbmRfc3RhdGUgPT0gWGVuYnVzU3RhdGVJbml0V2FpdCB8fAotICAgICAgICAgeGVuZGV2LT5i
YWNrZW5kX3N0YXRlID09IFhlbmJ1c1N0YXRlVW5rbm93bikpIHsKLSAgICAgICAgRXJyb3IgKmxv
Y2FsX2VyciA9IE5VTEw7CisgICAgaWYgKCFvbmxpbmUgJiYKKyAgICAgICAgKHN0YXRlID09IFhl
bmJ1c1N0YXRlQ2xvc2VkIHx8ICBzdGF0ZSA9PSBYZW5idXNTdGF0ZUluaXRpYWxpc2luZyB8fAor
ICAgICAgICAgc3RhdGUgPT0gWGVuYnVzU3RhdGVJbml0V2FpdCB8fCBzdGF0ZSA9PSBYZW5idXNT
dGF0ZVVua25vd24pICYmCisgICAgICAgICF4ZW5kZXYtPmluYWN0aXZlKSB7CisgICAgICAgIFhl
bkJ1cyAqeGVuYnVzID0gWEVOX0JVUyhxZGV2X2dldF9wYXJlbnRfYnVzKERFVklDRSh4ZW5kZXYp
KSk7CiAKLSAgICAgICAgaWYgKCF4ZW5fYmFja2VuZF90cnlfZGV2aWNlX2Rlc3Ryb3koeGVuZGV2
LCAmbG9jYWxfZXJyKSkgewotICAgICAgICAgICAgb2JqZWN0X3VucGFyZW50KE9CSkVDVCh4ZW5k
ZXYpKTsKLSAgICAgICAgfQorICAgICAgICB4ZW5kZXYtPmluYWN0aXZlID0gdHJ1ZTsKKyAgICAg
ICAgUUxJU1RfSU5TRVJUX0hFQUQoJnhlbmJ1cy0+aW5hY3RpdmVfZGV2aWNlcywgeGVuZGV2LCBs
aXN0KTsKIAotICAgICAgICBpZiAobG9jYWxfZXJyKSB7Ci0gICAgICAgICAgICBlcnJvcl9yZXBv
cnRfZXJyKGxvY2FsX2Vycik7Ci0gICAgICAgIH0KKyAgICAgICAgLyoKKyAgICAgICAgICogUmUt
d3JpdGUgdGhlIHN0YXRlIHRvIGNhdXNlIGEgWGVuQnVzIGJhY2tlbmRfd2F0Y2ggbm90aWZpY2F0
aW9uLAorICAgICAgICAgKiByZXN1bHRpbmcgaW4gYSBjYWxsIHRvIHhlbl9idXNfY2xlYW51cCgp
LgorICAgICAgICAgKi8KKyAgICAgICAgeGVuX2RldmljZV9iYWNrZW5kX3ByaW50Zih4ZW5kZXYs
ICJzdGF0ZSIsICIldSIsIHN0YXRlKTsKICAgICB9CiB9CiAKZGlmZiAtLWdpdCBhL2luY2x1ZGUv
aHcveGVuL3hlbi1idXMuaCBiL2luY2x1ZGUvaHcveGVuL3hlbi1idXMuaAppbmRleCAwZDE5ODE0
OGY2Li4zZDU1MzIyNThkIDEwMDY0NAotLS0gYS9pbmNsdWRlL2h3L3hlbi94ZW4tYnVzLmgKKysr
IGIvaW5jbHVkZS9ody94ZW4veGVuLWJ1cy5oCkBAIC0zMiw3ICszMiw5IEBAIHR5cGVkZWYgc3Ry
dWN0IFhlbkRldmljZSB7CiAgICAgWGVuV2F0Y2ggKmJhY2tlbmRfb25saW5lX3dhdGNoOwogICAg
IHhlbmdudHRhYl9oYW5kbGUgKnhndGg7CiAgICAgYm9vbCBmZWF0dXJlX2dyYW50X2NvcHk7Cisg
ICAgYm9vbCBpbmFjdGl2ZTsKICAgICBRTElTVF9IRUFEKCwgWGVuRXZlbnRDaGFubmVsKSBldmVu
dF9jaGFubmVsczsKKyAgICBRTElTVF9FTlRSWShYZW5EZXZpY2UpIGxpc3Q7CiB9IFhlbkRldmlj
ZTsKIAogdHlwZWRlZiBjaGFyICooKlhlbkRldmljZUdldE5hbWUpKFhlbkRldmljZSAqeGVuZGV2
LCBFcnJvciAqKmVycnApOwpAQCAtNjgsNiArNzAsNyBAQCB0eXBlZGVmIHN0cnVjdCBYZW5CdXMg
ewogICAgIHN0cnVjdCB4c19oYW5kbGUgKnhzaDsKICAgICBYZW5XYXRjaExpc3QgKndhdGNoX2xp
c3Q7CiAgICAgWGVuV2F0Y2ggKmJhY2tlbmRfd2F0Y2g7CisgICAgUUxJU1RfSEVBRCgsIFhlbkRl
dmljZSkgaW5hY3RpdmVfZGV2aWNlczsKIH0gWGVuQnVzOwogCiB0eXBlZGVmIHN0cnVjdCBYZW5C
dXNDbGFzcyB7Ci0tIApBbnRob255IFBFUkFSRAoKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fClhlbi1kZXZlbCBtYWlsaW5nIGxpc3QKWGVuLWRldmVsQGxp
c3RzLnhlbnByb2plY3Qub3JnCmh0dHBzOi8vbGlzdHMueGVucHJvamVjdC5vcmcvbWFpbG1hbi9s
aXN0aW5mby94ZW4tZGV2ZWw=
